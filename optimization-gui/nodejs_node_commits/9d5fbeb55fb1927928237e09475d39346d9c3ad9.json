{
    "author": "bmeck",
    "message": "policy: manifest with subresource integrity checks\n\nThis enables code loaded via the module system to be checked for\nintegrity to ensure the code loaded matches expectations.\n\nPR-URL: https://github.com/nodejs/node/pull/23834\nReviewed-By: Guy Bedford <guybedford@gmail.com>\nReviewed-By: Vladimir de Turckheim <vlad2t@hotmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "9d5fbeb55fb1927928237e09475d39346d9c3ad9",
    "files": [
        {
            "sha": "78994f428bba3c84d88e22dae46e811c72b17ac2",
            "filename": "doc/api/cli.md",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/doc%2Fapi%2Fcli.md",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/doc%2Fapi%2Fcli.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcli.md?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -90,6 +90,13 @@ added: v8.5.0\n \n Enable experimental ES module support and caching modules.\n \n+### `--experimental-policy`\n+<!-- YAML\n+added: TODO\n+-->\n+\n+Use the specified file as a security policy.\n+\n ### `--experimental-repl-await`\n <!-- YAML\n added: v10.0.0"
        },
        {
            "sha": "bb903ed0ee8c15beea7c54872f68f64632dc2311",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -1380,6 +1380,39 @@ An attempt was made to open an IPC communication channel with a synchronously\n forked Node.js process. See the documentation for the [`child_process`][] module\n for more information.\n \n+<a id=\"ERR_MANIFEST_ASSERT_INTEGRITY\"></a>\n+### ERR_MANIFEST_ASSERT_INTEGRITY\n+\n+An attempt was made to load a resource, but the resource did not match the\n+integrity defined by the policy manifest. See the documentation for [policy]\n+manifests for more information.\n+\n+<a id=\"ERR_MANIFEST_INTEGRITY_MISMATCH\"></a>\n+### ERR_MANIFEST_INTEGRITY_MISMATCH\n+\n+An attempt was made to load a policy manifest, but the manifest had multiple\n+entries for a resource which did not match each other. Update the manifest\n+entries to match in order to resolve this error. See the documentation for\n+[policy] manifests for more information.\n+\n+<a id=\"ERR_MANIFEST_PARSE_POLICY\"></a>\n+### ERR_MANIFEST_PARSE_POLICY\n+\n+An attempt was made to load a policy manifest, but the manifest was unable to\n+be parsed. See the documentation for [policy] manifests for more information.\n+\n+<a id=\"ERR_MANIFEST_TDZ\"></a>\n+### ERR_MANIFEST_TDZ\n+\n+An attempt was made to read from a policy manifest, but the manifest\n+initialization has not yet taken place. This is likely a bug in Node.js.\n+\n+<a id=\"ERR_MANIFEST_UNKNOWN_ONERROR\"></a>\n+### ERR_MANIFEST_UNKNOWN_ONERROR\n+\n+A policy manifest was loaded, but had an unknown value for its \"onerror\"\n+behavior. See the documentation for [policy] manifests for more information.\n+\n <a id=\"ERR_MEMORY_ALLOCATION_FAILED\"></a>\n ### ERR_MEMORY_ALLOCATION_FAILED\n \n@@ -1590,6 +1623,13 @@ An attempt was made to operate on an already closed socket.\n \n A call was made and the UDP subsystem was not running.\n \n+<a id=\"ERR_SRI_PARSE\"></a>\n+### ERR_SRI_PARSE\n+\n+A string was provided for a Subresource Integrity check, but was unable to be\n+parsed. Check the format of integrity attributes by looking at the\n+[Subresource Integrity specification][].\n+\n <a id=\"ERR_STREAM_CANNOT_PIPE\"></a>\n ### ERR_STREAM_CANNOT_PIPE\n \n@@ -2229,7 +2269,9 @@ such as `process.stdout.on('data')`.\n [domains]: domain.html\n [event emitter-based]: events.html#events_class_eventemitter\n [file descriptors]: https://en.wikipedia.org/wiki/File_descriptor\n+[policy]: policy.html\n [stream-based]: stream.html\n [syscall]: http://man7.org/linux/man-pages/man2/syscalls.2.html\n+[Subresource Integrity specification]: https://www.w3.org/TR/SRI/#the-integrity-attribute\n [try-catch]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/try...catch\n [vm]: vm.html"
        },
        {
            "sha": "a1bc34e81ffb5edb34481be37d18f9db1ee78d89",
            "filename": "doc/api/index.md",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/doc%2Fapi%2Findex.md",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/doc%2Fapi%2Findex.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Findex.md?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -39,6 +39,7 @@\n * [OS](os.html)\n * [Path](path.html)\n * [Performance Hooks](perf_hooks.html)\n+* [Policies](policy.html)\n * [Process](process.html)\n * [Punycode](punycode.html)\n * [Query Strings](querystring.html)"
        },
        {
            "sha": "ee8109efd651f008ed9d4bdb0949ac264b5e6969",
            "filename": "doc/api/policy.md",
            "status": "added",
            "additions": 104,
            "deletions": 0,
            "changes": 104,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/doc%2Fapi%2Fpolicy.md",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/doc%2Fapi%2Fpolicy.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fpolicy.md?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -0,0 +1,104 @@\n+# Policies\n+\n+<!--introduced_in=TODO-->\n+<!-- type=misc -->\n+\n+> Stability: 1 - Experimental\n+\n+<!-- name=policy -->\n+\n+Node.js contains experimental support for creating policies on loading code.\n+\n+Policies are a security feature intended to allow guarantees\n+about what code Node.js is able to load. The use of policies assumes\n+safe practices for the policy files such as ensuring that policy\n+files cannot be overwritten by the Node.js application by using\n+file permissions.\n+\n+A best practice would be to ensure that the policy manifest is read only for\n+the running Node.js application, and that the file cannot be changed\n+by the running Node.js application in any way. A typical setup would be to\n+create the policy file as a different user id than the one running Node.js\n+and granting read permissions to the user id running Node.js.\n+\n+## Enabling\n+\n+<!-- type=misc -->\n+\n+The `--experimental-policy` flag can be used to enable features for policies\n+when loading modules.\n+\n+Once this has been set, all modules must conform to a policy manifest file\n+passed to the flag:\n+\n+```sh\n+node --experimental-policy=policy.json app.js\n+```\n+\n+The policy manifest will be used to enforce constraints on code loaded by\n+Node.js.\n+\n+## Features\n+\n+### Error Behavior\n+\n+When a policy check fails, Node.js by default will throw an error.\n+It is possible to change the error behavior to one of a few possibilities\n+by defining an \"onerror\" field in a policy manifest. The following values are\n+available to change the behavior:\n+\n+* `\"exit\"` - will exit the process immediately.\n+    No cleanup code will be allowed to run.\n+* `\"log\"` - will log the error at the site of the failure.\n+* `\"throw\"` (default) - will throw a JS error at the site of the failure.\n+\n+```json\n+{\n+  \"onerror\": \"log\",\n+  \"resources\": {\n+    \"./app/checked.js\": {\n+      \"integrity\": \"sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0\"\n+    }\n+  }\n+}\n+```\n+\n+### Integrity Checks\n+\n+Policy files must use integrity checks with Subresource Integrity strings\n+compatible with the browser\n+[integrity attribute](https://www.w3.org/TR/SRI/#the-integrity-attribute)\n+associated with absolute URLs.\n+\n+When using `require()` all resources involved in loading are checked for\n+integrity if a policy manifest has been specified. If a resource does not match\n+the integrity listed in the manifest, an error will be thrown.\n+\n+An example policy file that would allow loading a file `checked.js`:\n+\n+```json\n+{\n+  \"resources\": {\n+    \"./app/checked.js\": {\n+      \"integrity\": \"sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0\"\n+    }\n+  }\n+}\n+```\n+\n+Each resource listed in the policy manifest can be of one the following\n+formats to determine its location:\n+\n+1. A [relative url string][] to a resource from the manifest such as `./resource.js`, `../resource.js`, or `/resource.js`.\n+2. A complete url string to a resource such as `file:///resource.js`.\n+\n+When loading resources the entire URL must match including search parameters\n+and hash fragment. `./a.js?b` will not be used when attempting to load\n+`./a.js` and vice versa.\n+\n+In order to generate integrity strings, a script such as\n+`printf \"sha384-$(cat checked.js | openssl dgst -sha384 -binary | base64)\"`\n+can be used.\n+\n+\n+[relative url string]: https://url.spec.whatwg.org/#relative-url-with-fragment-string"
        },
        {
            "sha": "426efc047becacd03727431831ad9f53a30db1e4",
            "filename": "doc/node.1",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/doc%2Fnode.1",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/doc%2Fnode.1",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fnode.1?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -86,6 +86,9 @@ Requires Node.js to be built with\n .It Fl -experimental-modules\n Enable experimental ES module support and caching modules.\n .\n+.It Fl -experimental-policy\n+Use the specified file as a security policy.\n+.\n .It Fl -experimental-repl-await\n Enable experimental top-level\n .Sy await"
        },
        {
            "sha": "21f642e4d1d53a3c5ea199aa468c485a58df82aa",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -175,6 +175,28 @@ function startup() {\n     mainThreadSetup.setupChildProcessIpcChannel();\n   }\n \n+  // TODO(joyeecheung): move this down further to get better snapshotting\n+  if (getOptionValue('[has_experimental_policy]')) {\n+    process.emitWarning('Policies are experimental.',\n+                        'ExperimentalWarning');\n+    const experimentalPolicy = getOptionValue('--experimental-policy');\n+    const { pathToFileURL, URL } = NativeModule.require('url');\n+    // URL here as it is slightly different parsing\n+    // no bare specifiers for now\n+    let manifestURL;\n+    if (NativeModule.require('path').isAbsolute(experimentalPolicy)) {\n+      manifestURL = new URL(`file:///${experimentalPolicy}`);\n+    } else {\n+      const cwdURL = pathToFileURL(process.cwd());\n+      cwdURL.pathname += '/';\n+      manifestURL = new URL(experimentalPolicy, cwdURL);\n+    }\n+    const fs = NativeModule.require('fs');\n+    const src = fs.readFileSync(manifestURL, 'utf8');\n+    NativeModule.require('internal/process/policy')\n+      .setup(src, manifestURL.href);\n+  }\n+\n   const browserGlobals = !process._noBrowserGlobals;\n   if (browserGlobals) {\n     setupGlobalTimeouts();"
        },
        {
            "sha": "45701c82523981aaa28fa01510c8c98cb03d6138",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -818,6 +818,28 @@ E('ERR_IPC_CHANNEL_CLOSED', 'Channel closed', Error);\n E('ERR_IPC_DISCONNECTED', 'IPC channel is already disconnected', Error);\n E('ERR_IPC_ONE_PIPE', 'Child process can have only one IPC pipe', Error);\n E('ERR_IPC_SYNC_FORK', 'IPC cannot be used with synchronous forks', Error);\n+E('ERR_MANIFEST_ASSERT_INTEGRITY',\n+  (moduleURL, realIntegrities) => {\n+    let msg = `The content of \"${\n+      moduleURL\n+    }\" does not match the expected integrity.`;\n+    if (realIntegrities.size) {\n+      const sri = [...realIntegrities.entries()].map(([alg, dgs]) => {\n+        return `${alg}-${dgs}`;\n+      }).join(' ');\n+      msg += ` Integrities found are: ${sri}`;\n+    } else {\n+      msg += ' The resource was not found in the policy.';\n+    }\n+    return msg;\n+  }, Error);\n+E('ERR_MANIFEST_INTEGRITY_MISMATCH',\n+  'Manifest resource %s has multiple entries but integrity lists do not match',\n+  SyntaxError);\n+E('ERR_MANIFEST_TDZ', 'Manifest initialization has not yet run', Error);\n+E('ERR_MANIFEST_UNKNOWN_ONERROR',\n+  'Manifest specified unknown error behavior \"%s\".',\n+  SyntaxError);\n E('ERR_METHOD_NOT_IMPLEMENTED', 'The %s method is not implemented', Error);\n E('ERR_MISSING_ARGS',\n   (...args) => {\n@@ -889,6 +911,9 @@ E('ERR_SOCKET_BUFFER_SIZE',\n E('ERR_SOCKET_CANNOT_SEND', 'Unable to send data', Error);\n E('ERR_SOCKET_CLOSED', 'Socket is closed', Error);\n E('ERR_SOCKET_DGRAM_NOT_RUNNING', 'Not running', Error);\n+E('ERR_SRI_PARSE',\n+  'Subresource Integrity string %s had an unexpected at %d',\n+  SyntaxError);\n E('ERR_STREAM_CANNOT_PIPE', 'Cannot pipe, not readable', Error);\n E('ERR_STREAM_DESTROYED', 'Cannot call %s after a stream was destroyed', Error);\n E('ERR_STREAM_NULL_VALUES', 'May not write null values to stream', TypeError);"
        },
        {
            "sha": "1dcf5ef6acdaf156a619f991fb931da3fe9f5f91",
            "filename": "lib/internal/modules/cjs/loader.js",
            "status": "modified",
            "additions": 32,
            "deletions": 5,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmodules%2Fcjs%2Floader.js?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -22,8 +22,8 @@\n 'use strict';\n \n const { NativeModule } = require('internal/bootstrap/loaders');\n-const util = require('util');\n const { pathToFileURL } = require('internal/url');\n+const util = require('util');\n const vm = require('vm');\n const assert = require('assert').ok;\n const fs = require('fs');\n@@ -45,6 +45,9 @@ const { getOptionValue } = require('internal/options');\n const preserveSymlinks = getOptionValue('--preserve-symlinks');\n const preserveSymlinksMain = getOptionValue('--preserve-symlinks-main');\n const experimentalModules = getOptionValue('--experimental-modules');\n+const manifest = getOptionValue('[has_experimental_policy]') ?\n+  require('internal/process/policy').manifest :\n+  null;\n \n const {\n   ERR_INVALID_ARG_VALUE,\n@@ -168,6 +171,11 @@ function readPackage(requestPath) {\n     return false;\n   }\n \n+  if (manifest) {\n+    const jsonURL = pathToFileURL(jsonPath);\n+    manifest.assertIntegrity(jsonURL, json);\n+  }\n+\n   try {\n     return packageMainCache[requestPath] = JSON.parse(json).main;\n   } catch (e) {\n@@ -676,6 +684,10 @@ function normalizeReferrerURL(referrer) {\n // the file.\n // Returns exception, if any.\n Module.prototype._compile = function(content, filename) {\n+  if (manifest) {\n+    const moduleURL = pathToFileURL(filename);\n+    manifest.assertIntegrity(moduleURL, content);\n+  }\n \n   content = stripShebang(content);\n \n@@ -715,11 +727,14 @@ Module.prototype._compile = function(content, filename) {\n   var depth = requireDepth;\n   if (depth === 0) stat.cache = new Map();\n   var result;\n+  var exports = this.exports;\n+  var thisValue = exports;\n+  var module = this;\n   if (inspectorWrapper) {\n-    result = inspectorWrapper(compiledWrapper, this.exports, this.exports,\n-                              require, this, filename, dirname);\n+    result = inspectorWrapper(compiledWrapper, thisValue, exports,\n+                              require, module, filename, dirname);\n   } else {\n-    result = compiledWrapper.call(this.exports, this.exports, require, this,\n+    result = compiledWrapper.call(thisValue, exports, require, module,\n                                   filename, dirname);\n   }\n   if (depth === 0) stat.cache = null;\n@@ -736,7 +751,13 @@ Module._extensions['.js'] = function(module, filename) {\n \n // Native extension for .json\n Module._extensions['.json'] = function(module, filename) {\n-  var content = fs.readFileSync(filename, 'utf8');\n+  const content = fs.readFileSync(filename, 'utf8');\n+\n+  if (manifest) {\n+    const moduleURL = pathToFileURL(filename);\n+    manifest.assertIntegrity(moduleURL, content);\n+  }\n+\n   try {\n     module.exports = JSON.parse(stripBOM(content));\n   } catch (err) {\n@@ -748,6 +769,12 @@ Module._extensions['.json'] = function(module, filename) {\n \n // Native extension for .node\n Module._extensions['.node'] = function(module, filename) {\n+  if (manifest) {\n+    const content = fs.readFileSync(filename);\n+    const moduleURL = pathToFileURL(filename);\n+    manifest.assertIntegrity(moduleURL, content);\n+  }\n+  // be aware this doesn't use `content`\n   return process.dlopen(module, path.toNamespacedPath(filename));\n };\n "
        },
        {
            "sha": "272abf2457ddc379fdaf38c5a613f9e4ccdf2152",
            "filename": "lib/internal/policy/manifest.js",
            "status": "added",
            "additions": 130,
            "deletions": 0,
            "changes": 130,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fpolicy%2Fmanifest.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fpolicy%2Fmanifest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fpolicy%2Fmanifest.js?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -0,0 +1,130 @@\n+'use strict';\n+const {\n+  ERR_MANIFEST_ASSERT_INTEGRITY,\n+  ERR_MANIFEST_INTEGRITY_MISMATCH,\n+  ERR_MANIFEST_UNKNOWN_ONERROR,\n+} = require('internal/errors').codes;\n+const debug = require('util').debuglog('policy');\n+const SRI = require('internal/policy/sri');\n+const { SafeWeakMap } = require('internal/safe_globals');\n+const crypto = require('crypto');\n+const { Buffer } = require('buffer');\n+const { URL } = require('url');\n+const { createHash, timingSafeEqual } = crypto;\n+const HashUpdate = Function.call.bind(crypto.Hash.prototype.update);\n+const HashDigest = Function.call.bind(crypto.Hash.prototype.digest);\n+const BufferEquals = Function.call.bind(Buffer.prototype.equals);\n+const BufferToString = Function.call.bind(Buffer.prototype.toString);\n+const RegExpTest = Function.call.bind(RegExp.prototype.test);\n+const { entries } = Object;\n+const kIntegrities = new SafeWeakMap();\n+const kReactions = new SafeWeakMap();\n+const kRelativeURLStringPattern = /^\\.{0,2}\\//;\n+const { shouldAbortOnUncaughtException } = internalBinding('config');\n+const { abort, exit, _rawDebug } = process;\n+function REACTION_THROW(error) {\n+  throw error;\n+}\n+function REACTION_EXIT(error) {\n+  REACTION_LOG(error);\n+  if (shouldAbortOnUncaughtException) {\n+    abort();\n+  }\n+  exit(1);\n+}\n+function REACTION_LOG(error) {\n+  _rawDebug(error.stack);\n+}\n+class Manifest {\n+  constructor(obj, manifestURL) {\n+    const integrities = {\n+      __proto__: null,\n+    };\n+    const reactions = {\n+      __proto__: null,\n+      integrity: REACTION_THROW,\n+    };\n+    if (obj.onerror) {\n+      const behavior = obj.onerror;\n+      if (behavior === 'throw') {\n+      } else if (behavior === 'exit') {\n+        reactions.integrity = REACTION_EXIT;\n+      } else if (behavior === 'log') {\n+        reactions.integrity = REACTION_LOG;\n+      } else {\n+        throw new ERR_MANIFEST_UNKNOWN_ONERROR(behavior);\n+      }\n+    }\n+    kReactions.set(this, Object.freeze(reactions));\n+    const manifestEntries = entries(obj.resources);\n+    for (var i = 0; i < manifestEntries.length; i++) {\n+      let url = manifestEntries[i][0];\n+      const integrity = manifestEntries[i][1].integrity;\n+      if (integrity != null) {\n+        debug(`Manifest contains integrity for url ${url}`);\n+        if (RegExpTest(kRelativeURLStringPattern, url)) {\n+          url = new URL(url, manifestURL).href;\n+        }\n+        const sri = Object.freeze(SRI.parse(integrity));\n+        if (url in integrities) {\n+          const old = integrities[url];\n+          let mismatch = false;\n+          if (old.length !== sri.length) {\n+            mismatch = true;\n+          } else {\n+            compare:\n+            for (var sriI = 0; sriI < sri.length; sriI++) {\n+              for (var oldI = 0; oldI < old.length; oldI++) {\n+                if (sri[sriI].algorithm === old[oldI].algorithm &&\n+                  BufferEquals(sri[sriI].value, old[oldI].value) &&\n+                  sri[sriI].options === old[oldI].options) {\n+                  continue compare;\n+                }\n+              }\n+              mismatch = true;\n+              break compare;\n+            }\n+          }\n+          if (mismatch) {\n+            throw new ERR_MANIFEST_INTEGRITY_MISMATCH(url);\n+          }\n+        }\n+        integrities[url] = sri;\n+      }\n+    }\n+    Object.freeze(integrities);\n+    kIntegrities.set(this, integrities);\n+    Object.freeze(this);\n+  }\n+  assertIntegrity(url, content) {\n+    debug(`Checking integrity of ${url}`);\n+    const integrities = kIntegrities.get(this);\n+    const realIntegrities = new Map();\n+    if (integrities && url in integrities) {\n+      const integrityEntries = integrities[url];\n+      // Avoid clobbered Symbol.iterator\n+      for (var i = 0; i < integrityEntries.length; i++) {\n+        const {\n+          algorithm,\n+          value: expected\n+        } = integrityEntries[i];\n+        const hash = createHash(algorithm);\n+        HashUpdate(hash, content);\n+        const digest = HashDigest(hash);\n+        if (digest.length === expected.length &&\n+          timingSafeEqual(digest, expected)) {\n+          return true;\n+        }\n+        realIntegrities.set(algorithm, BufferToString(digest, 'base64'));\n+      }\n+    }\n+    const error = new ERR_MANIFEST_ASSERT_INTEGRITY(url, realIntegrities);\n+    kReactions.get(this).integrity(error);\n+  }\n+}\n+// Lock everything down to avoid problems even if reference is leaked somehow\n+Object.setPrototypeOf(Manifest, null);\n+Object.setPrototypeOf(Manifest.prototype, null);\n+Object.freeze(Manifest);\n+Object.freeze(Manifest.prototype);\n+module.exports = Object.freeze({ Manifest });"
        },
        {
            "sha": "fff4e066b174518f05b9609a3e441b9d18cf1968",
            "filename": "lib/internal/policy/sri.js",
            "status": "added",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fpolicy%2Fsri.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fpolicy%2Fsri.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fpolicy%2Fsri.js?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -0,0 +1,68 @@\n+'use strict';\n+// Value of https://w3c.github.io/webappsec-subresource-integrity/#the-integrity-attribute\n+\n+// Returns [{algorithm, value (in base64 string), options,}]\n+const {\n+  ERR_SRI_PARSE\n+} = require('internal/errors').codes;\n+const kWSP = '[\\\\x20\\\\x09]';\n+const kVCHAR = '[\\\\x21-\\\\x7E]';\n+const kHASH_ALGO = 'sha256|sha384|sha512';\n+// Base64\n+const kHASH_VALUE = '[A-Za-z0-9+/]+[=]{0,2}';\n+const kHASH_EXPRESSION = `(${kHASH_ALGO})-(${kHASH_VALUE})`;\n+const kOPTION_EXPRESSION = `(${kVCHAR}*)`;\n+const kHASH_WITH_OPTIONS = `${kHASH_EXPRESSION}(?:[?](${kOPTION_EXPRESSION}))?`;\n+const kSRIPattern = new RegExp(`(${kWSP}*)(?:${kHASH_WITH_OPTIONS})`, 'g');\n+const { freeze } = Object;\n+Object.seal(kSRIPattern);\n+const kAllWSP = new RegExp(`^${kWSP}*$`);\n+Object.seal(kAllWSP);\n+const RegExpExec = Function.call.bind(RegExp.prototype.exec);\n+const RegExpTest = Function.call.bind(RegExp.prototype.test);\n+const StringSlice = Function.call.bind(String.prototype.slice);\n+const {\n+  Buffer: {\n+    from: BufferFrom\n+  }\n+} = require('buffer');\n+const { defineProperty } = Object;\n+const parse = (str) => {\n+  kSRIPattern.lastIndex = 0;\n+  let prevIndex = 0;\n+  let match = RegExpExec(kSRIPattern, str);\n+  const entries = [];\n+  while (match) {\n+    if (match.index !== prevIndex) {\n+      throw new ERR_SRI_PARSE(str, prevIndex);\n+    }\n+    if (entries.length > 0) {\n+      if (match[1] === '') {\n+        throw new ERR_SRI_PARSE(str, prevIndex);\n+      }\n+    }\n+    // Avoid setters being fired\n+    defineProperty(entries, entries.length, {\n+      enumerable: true,\n+      configurable: true,\n+      value: freeze({\n+        __proto__: null,\n+        algorithm: match[2],\n+        value: BufferFrom(match[3], 'base64'),\n+        options: match[4] === undefined ? null : match[4],\n+      })\n+    });\n+    prevIndex = prevIndex + match[0].length;\n+    match = RegExpExec(kSRIPattern, str);\n+  }\n+  if (prevIndex !== str.length) {\n+    if (!RegExpTest(kAllWSP, StringSlice(str, prevIndex))) {\n+      throw new ERR_SRI_PARSE(str, prevIndex);\n+    }\n+  }\n+  return entries;\n+};\n+\n+module.exports = {\n+  parse,\n+};"
        },
        {
            "sha": "f5ca4eeb07a3e0e09e44dbbe9aa59184502a90ca",
            "filename": "lib/internal/process/policy.js",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fprocess%2Fpolicy.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fprocess%2Fpolicy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fpolicy.js?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -0,0 +1,33 @@\n+'use strict';\n+\n+const {\n+  ERR_MANIFEST_TDZ,\n+} = require('internal/errors').codes;\n+const { Manifest } = require('internal/policy/manifest');\n+let manifest;\n+module.exports = Object.freeze({\n+  __proto__: null,\n+  setup(src, url) {\n+    if (src === null) {\n+      manifest = null;\n+      return;\n+    }\n+    const json = JSON.parse(src, (_, o) => {\n+      if (o && typeof o === 'object') {\n+        Reflect.setPrototypeOf(o, null);\n+        Object.freeze(o);\n+      }\n+      return o;\n+    });\n+    manifest = new Manifest(json, url);\n+  },\n+  get manifest() {\n+    if (typeof manifest === 'undefined') {\n+      throw new ERR_MANIFEST_TDZ();\n+    }\n+    return manifest;\n+  },\n+  assertIntegrity(moduleURL, content) {\n+    this.manifest.matchesIntegrity(moduleURL, content);\n+  }\n+});"
        },
        {
            "sha": "109409d535495d4a3879e2b55435960fa8745b33",
            "filename": "lib/internal/safe_globals.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fsafe_globals.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/lib%2Finternal%2Fsafe_globals.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fsafe_globals.js?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -20,5 +20,6 @@ const makeSafe = (unsafe, safe) => {\n };\n \n exports.SafeMap = makeSafe(Map, class SafeMap extends Map {});\n+exports.SafeWeakMap = makeSafe(WeakMap, class SafeWeakMap extends WeakMap {});\n exports.SafeSet = makeSafe(Set, class SafeSet extends Set {});\n exports.SafePromise = makeSafe(Promise, class SafePromise extends Promise {});"
        },
        {
            "sha": "30285031a45b6fe520ea62d0f5b14b9c78bde146",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -142,13 +142,16 @@\n       'lib/internal/safe_globals.js',\n       'lib/internal/net.js',\n       'lib/internal/options.js',\n+      'lib/internal/policy/sri.js',\n+      'lib/internal/policy/manifest.js',\n       'lib/internal/print_help.js',\n       'lib/internal/priority_queue.js',\n       'lib/internal/process/esm_loader.js',\n       'lib/internal/process/execution.js',\n       'lib/internal/process/main_thread_only.js',\n       'lib/internal/process/next_tick.js',\n       'lib/internal/process/per_thread.js',\n+      'lib/internal/process/policy.js',\n       'lib/internal/process/promises.js',\n       'lib/internal/process/stdio.js',\n       'lib/internal/process/warning.js',"
        },
        {
            "sha": "1f8d1db7ecc1cca6a780205696adcb875bebfa2a",
            "filename": "src/node_options.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/src%2Fnode_options.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/src%2Fnode_options.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.cc?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -101,6 +101,15 @@ EnvironmentOptionsParser::EnvironmentOptionsParser() {\n             \"experimental ES Module support and caching modules\",\n             &EnvironmentOptions::experimental_modules,\n             kAllowedInEnvironment);\n+  AddOption(\"[has_experimental_policy]\",\n+            \"\",\n+            &EnvironmentOptions::has_experimental_policy);\n+  AddOption(\"--experimental-policy\",\n+            \"use the specified file as a \"\n+            \"security policy\",\n+            &EnvironmentOptions::experimental_policy,\n+            kAllowedInEnvironment);\n+  Implies(\"--experimental-policy\", \"[has_experimental_policy]\");\n   AddOption(\"--experimental-repl-await\",\n             \"experimental await keyword support in REPL\",\n             &EnvironmentOptions::experimental_repl_await,"
        },
        {
            "sha": "ead69eb61a7ed789c04c86f24a97379296eb84cc",
            "filename": "src/node_options.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/src%2Fnode_options.h",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/src%2Fnode_options.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.h?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -94,6 +94,8 @@ class EnvironmentOptions : public Options {\n  public:\n   bool abort_on_uncaught_exception = false;\n   bool experimental_modules = false;\n+  std::string experimental_policy;\n+  bool has_experimental_policy;\n   bool experimental_repl_await = false;\n   bool experimental_vm_modules = false;\n   bool expose_internals = false;"
        },
        {
            "sha": "5c1ea4fc4eed648dec9109141ad3699a9b73fa2c",
            "filename": "test/parallel/test-policy-integrity.js",
            "status": "added",
            "additions": 297,
            "deletions": 0,
            "changes": 297,
            "blob_url": "https://github.com/nodejs/node/blob/9d5fbeb55fb1927928237e09475d39346d9c3ad9/test%2Fparallel%2Ftest-policy-integrity.js",
            "raw_url": "https://github.com/nodejs/node/raw/9d5fbeb55fb1927928237e09475d39346d9c3ad9/test%2Fparallel%2Ftest-policy-integrity.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-policy-integrity.js?ref=9d5fbeb55fb1927928237e09475d39346d9c3ad9",
            "patch": "@@ -0,0 +1,297 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const tmpdir = require('../common/tmpdir');\n+const assert = require('assert');\n+const { spawnSync } = require('child_process');\n+const crypto = require('crypto');\n+const fs = require('fs');\n+const path = require('path');\n+const { pathToFileURL } = require('url');\n+\n+tmpdir.refresh();\n+\n+function hash(algo, body) {\n+  const h = crypto.createHash(algo);\n+  h.update(body);\n+  return h.digest('base64');\n+}\n+\n+const policyFilepath = path.join(tmpdir.path, 'policy');\n+\n+const packageFilepath = path.join(tmpdir.path, 'package.json');\n+const packageURL = pathToFileURL(packageFilepath);\n+const packageBody = '{\"main\": \"dep.js\"}';\n+const policyToPackageRelativeURLString = `./${\n+  path.relative(path.dirname(policyFilepath), packageFilepath)\n+}`;\n+\n+const parentFilepath = path.join(tmpdir.path, 'parent.js');\n+const parentURL = pathToFileURL(parentFilepath);\n+const parentBody = 'require(\\'./dep.js\\')';\n+\n+const depFilepath = path.join(tmpdir.path, 'dep.js');\n+const depURL = pathToFileURL(depFilepath);\n+const depBody = '';\n+const policyToDepRelativeURLString = `./${\n+  path.relative(path.dirname(policyFilepath), depFilepath)\n+}`;\n+\n+fs.writeFileSync(parentFilepath, parentBody);\n+fs.writeFileSync(depFilepath, depBody);\n+\n+const tmpdirURL = pathToFileURL(tmpdir.path);\n+if (!tmpdirURL.pathname.endsWith('/')) {\n+  tmpdirURL.pathname += '/';\n+}\n+function test({\n+  shouldFail = false,\n+  entry,\n+  onerror,\n+  resources = {}\n+}) {\n+  const manifest = {\n+    onerror,\n+    resources: {}\n+  };\n+  for (const [url, { body, match }] of Object.entries(resources)) {\n+    manifest.resources[url] = {\n+      integrity: `sha256-${hash('sha256', match ? body : body + '\\n')}`\n+    };\n+    fs.writeFileSync(new URL(url, tmpdirURL.href), body);\n+  }\n+  fs.writeFileSync(policyFilepath, JSON.stringify(manifest, null, 2));\n+  const { status } = spawnSync(process.execPath, [\n+    '--experimental-policy', policyFilepath, entry\n+  ]);\n+  if (shouldFail) {\n+    assert.notStrictEqual(status, 0);\n+  } else {\n+    assert.strictEqual(status, 0);\n+  }\n+}\n+\n+const { status } = spawnSync(process.execPath, [\n+  '--experimental-policy', policyFilepath,\n+  '--experimental-policy', policyFilepath\n+], {\n+  stdio: 'pipe'\n+});\n+assert.notStrictEqual(status, 0, 'Should not allow multiple policies');\n+\n+test({\n+  shouldFail: true,\n+  entry: parentFilepath,\n+  resources: {\n+  }\n+});\n+test({\n+  shouldFail: false,\n+  entry: parentFilepath,\n+  onerror: 'log',\n+});\n+test({\n+  shouldFail: true,\n+  entry: parentFilepath,\n+  onerror: 'exit',\n+});\n+test({\n+  shouldFail: true,\n+  entry: parentFilepath,\n+  onerror: 'throw',\n+});\n+test({\n+  shouldFail: true,\n+  entry: parentFilepath,\n+  onerror: 'unknown-onerror-value',\n+});\n+test({\n+  shouldFail: true,\n+  entry: path.dirname(packageFilepath),\n+  resources: {\n+  }\n+});\n+test({\n+  shouldFail: true,\n+  entry: path.dirname(packageFilepath),\n+  resources: {\n+    [depURL]: {\n+      body: depBody,\n+      match: true,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: false,\n+  entry: path.dirname(packageFilepath),\n+  onerror: 'log',\n+  resources: {\n+    [packageURL]: {\n+      body: packageBody,\n+      match: false,\n+    },\n+    [depURL]: {\n+      body: depBody,\n+      match: true,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: true,\n+  entry: path.dirname(packageFilepath),\n+  resources: {\n+    [packageURL]: {\n+      body: packageBody,\n+      match: false,\n+    },\n+    [depURL]: {\n+      body: depBody,\n+      match: true,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: true,\n+  entry: path.dirname(packageFilepath),\n+  resources: {\n+    [packageURL]: {\n+      body: packageBody,\n+      match: true,\n+    },\n+    [depURL]: {\n+      body: depBody,\n+      match: false,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: false,\n+  entry: path.dirname(packageFilepath),\n+  resources: {\n+    [packageURL]: {\n+      body: packageBody,\n+      match: true,\n+    },\n+    [depURL]: {\n+      body: depBody,\n+      match: true,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: false,\n+  entry: parentFilepath,\n+  resources: {\n+    [parentURL]: {\n+      body: parentBody,\n+      match: true,\n+    },\n+    [depURL]: {\n+      body: depBody,\n+      match: true,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: true,\n+  entry: parentFilepath,\n+  resources: {\n+    [parentURL]: {\n+      body: parentBody,\n+      match: false,\n+    },\n+    [depURL]: {\n+      body: depBody,\n+      match: true,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: true,\n+  entry: parentFilepath,\n+  resources: {\n+    [parentURL]: {\n+      body: parentBody,\n+      match: true,\n+    },\n+    [depURL]: {\n+      body: depBody,\n+      match: false,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: true,\n+  entry: parentFilepath,\n+  resources: {\n+    [parentURL]: {\n+      body: parentBody,\n+      match: true,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: false,\n+  entry: depFilepath,\n+  resources: {\n+    [depURL]: {\n+      body: depBody,\n+      match: true,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: false,\n+  entry: depFilepath,\n+  resources: {\n+    [policyToDepRelativeURLString]: {\n+      body: depBody,\n+      match: true,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: true,\n+  entry: depFilepath,\n+  resources: {\n+    [policyToDepRelativeURLString]: {\n+      body: depBody,\n+      match: false,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: false,\n+  entry: depFilepath,\n+  resources: {\n+    [policyToDepRelativeURLString]: {\n+      body: depBody,\n+      match: true,\n+    },\n+    [depURL]: {\n+      body: depBody,\n+      match: true,\n+    }\n+  }\n+});\n+test({\n+  shouldFail: true,\n+  entry: depFilepath,\n+  resources: {\n+    [policyToPackageRelativeURLString]: {\n+      body: packageBody,\n+      match: true,\n+    },\n+    [packageURL]: {\n+      body: packageBody,\n+      match: true,\n+    },\n+    [depURL]: {\n+      body: depBody,\n+      match: false,\n+    }\n+  }\n+});"
        }
    ],
    "stats": {
        "total": 784,
        "additions": 779,
        "deletions": 5
    }
}