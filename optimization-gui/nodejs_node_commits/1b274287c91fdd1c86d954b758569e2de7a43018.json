{
    "author": "addaleax",
    "message": "test: add string-decoder fuzz test\n\nPR-URL: https://github.com/nodejs/node/pull/22709\nFixes: https://github.com/nodejs/node/issues/22626\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "1b274287c91fdd1c86d954b758569e2de7a43018",
    "files": [
        {
            "sha": "d8d018815911612bee5698f958644d963899a4c8",
            "filename": "test/parallel/test-string-decoder-fuzz.js",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/1b274287c91fdd1c86d954b758569e2de7a43018/test%2Fparallel%2Ftest-string-decoder-fuzz.js",
            "raw_url": "https://github.com/nodejs/node/raw/1b274287c91fdd1c86d954b758569e2de7a43018/test%2Fparallel%2Ftest-string-decoder-fuzz.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-string-decoder-fuzz.js?ref=1b274287c91fdd1c86d954b758569e2de7a43018",
            "patch": "@@ -0,0 +1,48 @@\n+'use strict';\n+require('../common');\n+const { StringDecoder } = require('string_decoder');\n+const util = require('util');\n+const assert = require('assert');\n+\n+// Tests that, for random sequences of bytes, our StringDecoder gives the\n+// same result as a direction conversion using Buffer.toString().\n+// In particular, it checks that StringDecoder aligns with V8â€™s own output.\n+\n+function rand(max) {\n+  return Math.floor(Math.random() * max);\n+}\n+\n+function randBuf(maxLen) {\n+  const buf = Buffer.allocUnsafe(rand(maxLen));\n+  for (let i = 0; i < buf.length; i++)\n+    buf[i] = rand(256);\n+  return buf;\n+}\n+\n+const encodings = [\n+  'utf16le', 'utf8', 'ascii', 'hex', 'base64', 'latin1'\n+];\n+\n+function runSingleFuzzTest() {\n+  const enc = encodings[rand(encodings.length)];\n+  const sd = new StringDecoder(enc);\n+  const bufs = [];\n+  const strings = [];\n+\n+  const N = rand(10);\n+  for (let i = 0; i < N; ++i) {\n+    const buf = randBuf(50);\n+    bufs.push(buf);\n+    strings.push(sd.write(buf));\n+  }\n+  strings.push(sd.end());\n+\n+  assert.strictEqual(strings.join(''), Buffer.concat(bufs).toString(enc),\n+                     `Mismatch:\\n${util.inspect(strings)}\\n` +\n+                     util.inspect(bufs.map((buf) => buf.toString('hex'))) +\n+                     `\\nfor encoding ${enc}`);\n+}\n+\n+const start = Date.now();\n+while (Date.now() - start < 100)\n+  runSingleFuzzTest();"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 48,
        "deletions": 0
    }
}