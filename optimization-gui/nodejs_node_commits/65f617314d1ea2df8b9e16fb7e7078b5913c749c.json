{
    "author": "TimothyGu",
    "message": "src: start annotating native code side effect\n\nPR-URL: https://github.com/nodejs/node/pull/21458\nRefs: https://github.com/nodejs/node/issues/20977\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "65f617314d1ea2df8b9e16fb7e7078b5913c749c",
    "files": [
        {
            "sha": "3cf1d434d3ca71950cbcf24478caafbf15df0c26",
            "filename": "src/cares_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fcares_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fcares_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcares_wrap.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -2107,8 +2107,8 @@ void Initialize(Local<Object> target,\n \n   env->SetMethod(target, \"getaddrinfo\", GetAddrInfo);\n   env->SetMethod(target, \"getnameinfo\", GetNameInfo);\n-  env->SetMethod(target, \"isIPv6\", IsIPv6);\n-  env->SetMethod(target, \"canonicalizeIP\", CanonicalizeIP);\n+  env->SetMethodNoSideEffect(target, \"isIPv6\", IsIPv6);\n+  env->SetMethodNoSideEffect(target, \"canonicalizeIP\", CanonicalizeIP);\n \n   env->SetMethod(target, \"strerror\", StrError);\n \n@@ -2165,7 +2165,7 @@ void Initialize(Local<Object> target,\n   env->SetProtoMethod(channel_wrap, \"querySoa\", Query<QuerySoaWrap>);\n   env->SetProtoMethod(channel_wrap, \"getHostByAddr\", Query<GetHostByAddrWrap>);\n \n-  env->SetProtoMethod(channel_wrap, \"getServers\", GetServers);\n+  env->SetProtoMethodNoSideEffect(channel_wrap, \"getServers\", GetServers);\n   env->SetProtoMethod(channel_wrap, \"setServers\", SetServers);\n   env->SetProtoMethod(channel_wrap, \"cancel\", Cancel);\n "
        },
        {
            "sha": "dc842582d1234289df768978532433be26458d38",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 65,
            "deletions": 5,
            "changes": 70,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -675,17 +675,41 @@ inline void Environment::ThrowUVException(int errorno,\n inline v8::Local<v8::FunctionTemplate>\n     Environment::NewFunctionTemplate(v8::FunctionCallback callback,\n                                      v8::Local<v8::Signature> signature,\n-                                     v8::ConstructorBehavior behavior) {\n+                                     v8::ConstructorBehavior behavior,\n+                                     v8::SideEffectType side_effect_type) {\n   v8::Local<v8::External> external = as_external();\n   return v8::FunctionTemplate::New(isolate(), callback, external,\n-                                   signature, 0, behavior);\n+                                   signature, 0, behavior, side_effect_type);\n }\n \n inline void Environment::SetMethod(v8::Local<v8::Object> that,\n                                    const char* name,\n                                    v8::FunctionCallback callback) {\n   v8::Local<v8::Function> function =\n-      NewFunctionTemplate(callback)->GetFunction();\n+      NewFunctionTemplate(callback,\n+                          v8::Local<v8::Signature>(),\n+                          // TODO(TimothyGu): Investigate if SetMethod is ever\n+                          // used for constructors.\n+                          v8::ConstructorBehavior::kAllow,\n+                          v8::SideEffectType::kHasSideEffect)->GetFunction();\n+  // kInternalized strings are created in the old space.\n+  const v8::NewStringType type = v8::NewStringType::kInternalized;\n+  v8::Local<v8::String> name_string =\n+      v8::String::NewFromUtf8(isolate(), name, type).ToLocalChecked();\n+  that->Set(name_string, function);\n+  function->SetName(name_string);  // NODE_SET_METHOD() compatibility.\n+}\n+\n+inline void Environment::SetMethodNoSideEffect(v8::Local<v8::Object> that,\n+                                               const char* name,\n+                                               v8::FunctionCallback callback) {\n+  v8::Local<v8::Function> function =\n+      NewFunctionTemplate(callback,\n+                          v8::Local<v8::Signature>(),\n+                          // TODO(TimothyGu): Investigate if SetMethod is ever\n+                          // used for constructors.\n+                          v8::ConstructorBehavior::kAllow,\n+                          v8::SideEffectType::kHasNoSideEffect)->GetFunction();\n   // kInternalized strings are created in the old space.\n   const v8::NewStringType type = v8::NewStringType::kInternalized;\n   v8::Local<v8::String> name_string =\n@@ -699,7 +723,24 @@ inline void Environment::SetProtoMethod(v8::Local<v8::FunctionTemplate> that,\n                                         v8::FunctionCallback callback) {\n   v8::Local<v8::Signature> signature = v8::Signature::New(isolate(), that);\n   v8::Local<v8::FunctionTemplate> t =\n-      NewFunctionTemplate(callback, signature, v8::ConstructorBehavior::kThrow);\n+      NewFunctionTemplate(callback, signature, v8::ConstructorBehavior::kThrow,\n+                          v8::SideEffectType::kHasSideEffect);\n+  // kInternalized strings are created in the old space.\n+  const v8::NewStringType type = v8::NewStringType::kInternalized;\n+  v8::Local<v8::String> name_string =\n+      v8::String::NewFromUtf8(isolate(), name, type).ToLocalChecked();\n+  that->PrototypeTemplate()->Set(name_string, t);\n+  t->SetClassName(name_string);  // NODE_SET_PROTOTYPE_METHOD() compatibility.\n+}\n+\n+inline void Environment::SetProtoMethodNoSideEffect(\n+    v8::Local<v8::FunctionTemplate> that,\n+    const char* name,\n+    v8::FunctionCallback callback) {\n+  v8::Local<v8::Signature> signature = v8::Signature::New(isolate(), that);\n+  v8::Local<v8::FunctionTemplate> t =\n+      NewFunctionTemplate(callback, signature, v8::ConstructorBehavior::kThrow,\n+                          v8::SideEffectType::kHasNoSideEffect);\n   // kInternalized strings are created in the old space.\n   const v8::NewStringType type = v8::NewStringType::kInternalized;\n   v8::Local<v8::String> name_string =\n@@ -711,7 +752,26 @@ inline void Environment::SetProtoMethod(v8::Local<v8::FunctionTemplate> that,\n inline void Environment::SetTemplateMethod(v8::Local<v8::FunctionTemplate> that,\n                                            const char* name,\n                                            v8::FunctionCallback callback) {\n-  v8::Local<v8::FunctionTemplate> t = NewFunctionTemplate(callback);\n+  v8::Local<v8::FunctionTemplate> t =\n+      NewFunctionTemplate(callback, v8::Local<v8::Signature>(),\n+                          v8::ConstructorBehavior::kAllow,\n+                          v8::SideEffectType::kHasSideEffect);\n+  // kInternalized strings are created in the old space.\n+  const v8::NewStringType type = v8::NewStringType::kInternalized;\n+  v8::Local<v8::String> name_string =\n+      v8::String::NewFromUtf8(isolate(), name, type).ToLocalChecked();\n+  that->Set(name_string, t);\n+  t->SetClassName(name_string);  // NODE_SET_METHOD() compatibility.\n+}\n+\n+inline void Environment::SetTemplateMethodNoSideEffect(\n+    v8::Local<v8::FunctionTemplate> that,\n+    const char* name,\n+    v8::FunctionCallback callback) {\n+  v8::Local<v8::FunctionTemplate> t =\n+      NewFunctionTemplate(callback, v8::Local<v8::Signature>(),\n+                          v8::ConstructorBehavior::kAllow,\n+                          v8::SideEffectType::kHasNoSideEffect);\n   // kInternalized strings are created in the old space.\n   const v8::NewStringType type = v8::NewStringType::kInternalized;\n   v8::Local<v8::String> name_string ="
        },
        {
            "sha": "5a2c9e968fd079ab1826b918993e31b6c7d1ea30",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -752,19 +752,34 @@ class Environment {\n                           v8::Local<v8::Signature> signature =\n                               v8::Local<v8::Signature>(),\n                           v8::ConstructorBehavior behavior =\n-                              v8::ConstructorBehavior::kAllow);\n+                              v8::ConstructorBehavior::kAllow,\n+                          v8::SideEffectType side_effect =\n+                              v8::SideEffectType::kHasSideEffect);\n \n   // Convenience methods for NewFunctionTemplate().\n   inline void SetMethod(v8::Local<v8::Object> that,\n                         const char* name,\n                         v8::FunctionCallback callback);\n+\n   inline void SetProtoMethod(v8::Local<v8::FunctionTemplate> that,\n                              const char* name,\n                              v8::FunctionCallback callback);\n   inline void SetTemplateMethod(v8::Local<v8::FunctionTemplate> that,\n                                 const char* name,\n                                 v8::FunctionCallback callback);\n \n+  // Safe variants denote the function has no side effects.\n+  inline void SetMethodNoSideEffect(v8::Local<v8::Object> that,\n+                                    const char* name,\n+                                    v8::FunctionCallback callback);\n+  inline void SetProtoMethodNoSideEffect(v8::Local<v8::FunctionTemplate> that,\n+                                         const char* name,\n+                                         v8::FunctionCallback callback);\n+  inline void SetTemplateMethodNoSideEffect(\n+      v8::Local<v8::FunctionTemplate> that,\n+      const char* name,\n+      v8::FunctionCallback callback);\n+\n   void BeforeExit(void (*cb)(void* arg), void* arg);\n   void RunBeforeExitCallbacks();\n   void AtExit(void (*cb)(void* arg), void* arg);"
        },
        {
            "sha": "96b064e495a01a84e2f4f64d984830281799ea10",
            "filename": "src/inspector_js_api.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Finspector_js_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Finspector_js_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_js_api.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -282,7 +282,7 @@ void Initialize(Local<Object> target, Local<Value> unused,\n   if (agent->IsWaitingForConnect())\n     env->SetMethod(target, \"callAndPauseOnStart\", CallAndPauseOnStart);\n   env->SetMethod(target, \"open\", Open);\n-  env->SetMethod(target, \"url\", Url);\n+  env->SetMethodNoSideEffect(target, \"url\", Url);\n \n   env->SetMethod(target, \"asyncTaskScheduled\", AsyncTaskScheduledWrapper);\n   env->SetMethod(target, \"asyncTaskCanceled\",\n@@ -293,7 +293,7 @@ void Initialize(Local<Object> target, Local<Value> unused,\n       InvokeAsyncTaskFnWithId<&Agent::AsyncTaskFinished>);\n \n   env->SetMethod(target, \"registerAsyncHook\", RegisterAsyncHookWrapper);\n-  env->SetMethod(target, \"isEnabled\", IsEnabled);\n+  env->SetMethodNoSideEffect(target, \"isEnabled\", IsEnabled);\n \n   auto conn_str = FIXED_ONE_BYTE_STRING(env->isolate(), \"Connection\");\n   Local<FunctionTemplate> tmpl ="
        },
        {
            "sha": "ab1950311ad631d626a4d1a13dd4a06c6404d946",
            "filename": "src/module_wrap.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fmodule_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fmodule_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -789,11 +789,11 @@ void ModuleWrap::Initialize(Local<Object> target,\n   env->SetProtoMethod(tpl, \"link\", Link);\n   env->SetProtoMethod(tpl, \"instantiate\", Instantiate);\n   env->SetProtoMethod(tpl, \"evaluate\", Evaluate);\n-  env->SetProtoMethod(tpl, \"namespace\", Namespace);\n-  env->SetProtoMethod(tpl, \"getStatus\", GetStatus);\n-  env->SetProtoMethod(tpl, \"getError\", GetError);\n-  env->SetProtoMethod(tpl, \"getStaticDependencySpecifiers\",\n-                      GetStaticDependencySpecifiers);\n+  env->SetProtoMethodNoSideEffect(tpl, \"namespace\", Namespace);\n+  env->SetProtoMethodNoSideEffect(tpl, \"getStatus\", GetStatus);\n+  env->SetProtoMethodNoSideEffect(tpl, \"getError\", GetError);\n+  env->SetProtoMethodNoSideEffect(tpl, \"getStaticDependencySpecifiers\",\n+                                  GetStaticDependencySpecifiers);\n \n   target->Set(FIXED_ONE_BYTE_STRING(isolate, \"ModuleWrap\"), tpl->GetFunction());\n   env->SetMethod(target, \"resolve\", Resolve);"
        },
        {
            "sha": "513e95f2eda7b03c4944213005c9d8a435af00c9",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -159,6 +159,7 @@ using v8::Promise;\n using v8::PropertyCallbackInfo;\n using v8::ScriptOrigin;\n using v8::SealHandleScope;\n+using v8::SideEffectType;\n using v8::String;\n using v8::TryCatch;\n using v8::Undefined;\n@@ -1947,7 +1948,10 @@ void SetupProcessObject(Environment* env,\n       title_string,\n       ProcessTitleGetter,\n       env->is_main_thread() ? ProcessTitleSetter : nullptr,\n-      env->as_external()).FromJust());\n+      env->as_external(),\n+      v8::DEFAULT,\n+      v8::None,\n+      SideEffectType::kHasNoSideEffect).FromJust());\n \n   // process.version\n   READONLY_PROPERTY(process,\n@@ -2257,17 +2261,17 @@ void SetupProcessObject(Environment* env,\n   env->SetMethod(process, \"_getActiveHandles\", GetActiveHandles);\n   env->SetMethod(process, \"_kill\", Kill);\n \n-  env->SetMethod(process, \"cwd\", Cwd);\n+  env->SetMethodNoSideEffect(process, \"cwd\", Cwd);\n   env->SetMethod(process, \"dlopen\", DLOpen);\n   env->SetMethod(process, \"reallyExit\", Exit);\n-  env->SetMethod(process, \"uptime\", Uptime);\n+  env->SetMethodNoSideEffect(process, \"uptime\", Uptime);\n \n #if defined(__POSIX__) && !defined(__ANDROID__) && !defined(__CloudABI__)\n-  env->SetMethod(process, \"getuid\", GetUid);\n-  env->SetMethod(process, \"geteuid\", GetEUid);\n-  env->SetMethod(process, \"getgid\", GetGid);\n-  env->SetMethod(process, \"getegid\", GetEGid);\n-  env->SetMethod(process, \"getgroups\", GetGroups);\n+  env->SetMethodNoSideEffect(process, \"getuid\", GetUid);\n+  env->SetMethodNoSideEffect(process, \"geteuid\", GetEUid);\n+  env->SetMethodNoSideEffect(process, \"getgid\", GetGid);\n+  env->SetMethodNoSideEffect(process, \"getegid\", GetEGid);\n+  env->SetMethodNoSideEffect(process, \"getgroups\", GetGroups);\n #endif  // __POSIX__ && !defined(__ANDROID__) && !defined(__CloudABI__)\n }\n "
        },
        {
            "sha": "9eb351b443a111403032e8f294b5acbe72c5707b",
            "filename": "src/node_buffer.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 14,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_buffer.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -1083,12 +1083,12 @@ void SetupBufferJS(const FunctionCallbackInfo<Value>& args) {\n   Local<Object> proto = args[0].As<Object>();\n   env->set_buffer_prototype_object(proto);\n \n-  env->SetMethod(proto, \"asciiSlice\", StringSlice<ASCII>);\n-  env->SetMethod(proto, \"base64Slice\", StringSlice<BASE64>);\n-  env->SetMethod(proto, \"latin1Slice\", StringSlice<LATIN1>);\n-  env->SetMethod(proto, \"hexSlice\", StringSlice<HEX>);\n-  env->SetMethod(proto, \"ucs2Slice\", StringSlice<UCS2>);\n-  env->SetMethod(proto, \"utf8Slice\", StringSlice<UTF8>);\n+  env->SetMethodNoSideEffect(proto, \"asciiSlice\", StringSlice<ASCII>);\n+  env->SetMethodNoSideEffect(proto, \"base64Slice\", StringSlice<BASE64>);\n+  env->SetMethodNoSideEffect(proto, \"latin1Slice\", StringSlice<LATIN1>);\n+  env->SetMethodNoSideEffect(proto, \"hexSlice\", StringSlice<HEX>);\n+  env->SetMethodNoSideEffect(proto, \"ucs2Slice\", StringSlice<UCS2>);\n+  env->SetMethodNoSideEffect(proto, \"utf8Slice\", StringSlice<UTF8>);\n \n   env->SetMethod(proto, \"asciiWrite\", StringWrite<ASCII>);\n   env->SetMethod(proto, \"base64Write\", StringWrite<BASE64>);\n@@ -1116,22 +1116,22 @@ void Initialize(Local<Object> target,\n   Environment* env = Environment::GetCurrent(context);\n \n   env->SetMethod(target, \"setupBufferJS\", SetupBufferJS);\n-  env->SetMethod(target, \"createFromString\", CreateFromString);\n+  env->SetMethodNoSideEffect(target, \"createFromString\", CreateFromString);\n \n-  env->SetMethod(target, \"byteLengthUtf8\", ByteLengthUtf8);\n+  env->SetMethodNoSideEffect(target, \"byteLengthUtf8\", ByteLengthUtf8);\n   env->SetMethod(target, \"copy\", Copy);\n-  env->SetMethod(target, \"compare\", Compare);\n-  env->SetMethod(target, \"compareOffset\", CompareOffset);\n+  env->SetMethodNoSideEffect(target, \"compare\", Compare);\n+  env->SetMethodNoSideEffect(target, \"compareOffset\", CompareOffset);\n   env->SetMethod(target, \"fill\", Fill);\n-  env->SetMethod(target, \"indexOfBuffer\", IndexOfBuffer);\n-  env->SetMethod(target, \"indexOfNumber\", IndexOfNumber);\n-  env->SetMethod(target, \"indexOfString\", IndexOfString);\n+  env->SetMethodNoSideEffect(target, \"indexOfBuffer\", IndexOfBuffer);\n+  env->SetMethodNoSideEffect(target, \"indexOfNumber\", IndexOfNumber);\n+  env->SetMethodNoSideEffect(target, \"indexOfString\", IndexOfString);\n \n   env->SetMethod(target, \"swap16\", Swap16);\n   env->SetMethod(target, \"swap32\", Swap32);\n   env->SetMethod(target, \"swap64\", Swap64);\n \n-  env->SetMethod(target, \"encodeUtf8String\", EncodeUtf8String);\n+  env->SetMethodNoSideEffect(target, \"encodeUtf8String\", EncodeUtf8String);\n \n   target->Set(env->context(),\n               FIXED_ONE_BYTE_STRING(env->isolate(), \"kMaxLength\"),"
        },
        {
            "sha": "818311eddeab62e2e08a595cb061cf467c60bb65",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 50,
            "deletions": 38,
            "changes": 88,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -62,6 +62,7 @@ namespace crypto {\n \n using v8::Array;\n using v8::Boolean;\n+using v8::ConstructorBehavior;\n using v8::Context;\n using v8::DontDelete;\n using v8::EscapableHandleScope;\n@@ -83,6 +84,7 @@ using v8::Null;\n using v8::Object;\n using v8::PropertyAttribute;\n using v8::ReadOnly;\n+using v8::SideEffectType;\n using v8::Signature;\n using v8::String;\n using v8::Uint32;\n@@ -345,12 +347,12 @@ void SecureContext::Initialize(Environment* env, Local<Object> target) {\n #ifndef OPENSSL_NO_ENGINE\n   env->SetProtoMethod(t, \"setClientCertEngine\", SetClientCertEngine);\n #endif  // !OPENSSL_NO_ENGINE\n-  env->SetProtoMethod(t, \"getTicketKeys\", GetTicketKeys);\n+  env->SetProtoMethodNoSideEffect(t, \"getTicketKeys\", GetTicketKeys);\n   env->SetProtoMethod(t, \"setTicketKeys\", SetTicketKeys);\n   env->SetProtoMethod(t, \"setFreeListLength\", SetFreeListLength);\n   env->SetProtoMethod(t, \"enableTicketKeyCallback\", EnableTicketKeyCallback);\n-  env->SetProtoMethod(t, \"getCertificate\", GetCertificate<true>);\n-  env->SetProtoMethod(t, \"getIssuer\", GetCertificate<false>);\n+  env->SetProtoMethodNoSideEffect(t, \"getCertificate\", GetCertificate<true>);\n+  env->SetProtoMethodNoSideEffect(t, \"getIssuer\", GetCertificate<false>);\n \n   t->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"kTicketKeyReturnIndex\"),\n          Integer::NewFromUnsigned(env->isolate(), kTicketKeyReturnIndex));\n@@ -1366,32 +1368,34 @@ template <class Base>\n void SSLWrap<Base>::AddMethods(Environment* env, Local<FunctionTemplate> t) {\n   HandleScope scope(env->isolate());\n \n-  env->SetProtoMethod(t, \"getPeerCertificate\", GetPeerCertificate);\n-  env->SetProtoMethod(t, \"getFinished\", GetFinished);\n-  env->SetProtoMethod(t, \"getPeerFinished\", GetPeerFinished);\n-  env->SetProtoMethod(t, \"getSession\", GetSession);\n+  env->SetProtoMethodNoSideEffect(t, \"getPeerCertificate\", GetPeerCertificate);\n+  env->SetProtoMethodNoSideEffect(t, \"getFinished\", GetFinished);\n+  env->SetProtoMethodNoSideEffect(t, \"getPeerFinished\", GetPeerFinished);\n+  env->SetProtoMethodNoSideEffect(t, \"getSession\", GetSession);\n   env->SetProtoMethod(t, \"setSession\", SetSession);\n   env->SetProtoMethod(t, \"loadSession\", LoadSession);\n-  env->SetProtoMethod(t, \"isSessionReused\", IsSessionReused);\n-  env->SetProtoMethod(t, \"isInitFinished\", IsInitFinished);\n-  env->SetProtoMethod(t, \"verifyError\", VerifyError);\n-  env->SetProtoMethod(t, \"getCurrentCipher\", GetCurrentCipher);\n+  env->SetProtoMethodNoSideEffect(t, \"isSessionReused\", IsSessionReused);\n+  env->SetProtoMethodNoSideEffect(t, \"isInitFinished\", IsInitFinished);\n+  env->SetProtoMethodNoSideEffect(t, \"verifyError\", VerifyError);\n+  env->SetProtoMethodNoSideEffect(t, \"getCurrentCipher\", GetCurrentCipher);\n   env->SetProtoMethod(t, \"endParser\", EndParser);\n   env->SetProtoMethod(t, \"certCbDone\", CertCbDone);\n   env->SetProtoMethod(t, \"renegotiate\", Renegotiate);\n   env->SetProtoMethod(t, \"shutdownSSL\", Shutdown);\n-  env->SetProtoMethod(t, \"getTLSTicket\", GetTLSTicket);\n+  env->SetProtoMethodNoSideEffect(t, \"getTLSTicket\", GetTLSTicket);\n   env->SetProtoMethod(t, \"newSessionDone\", NewSessionDone);\n   env->SetProtoMethod(t, \"setOCSPResponse\", SetOCSPResponse);\n   env->SetProtoMethod(t, \"requestOCSP\", RequestOCSP);\n-  env->SetProtoMethod(t, \"getEphemeralKeyInfo\", GetEphemeralKeyInfo);\n-  env->SetProtoMethod(t, \"getProtocol\", GetProtocol);\n+  env->SetProtoMethodNoSideEffect(t, \"getEphemeralKeyInfo\",\n+                                  GetEphemeralKeyInfo);\n+  env->SetProtoMethodNoSideEffect(t, \"getProtocol\", GetProtocol);\n \n #ifdef SSL_set_max_send_fragment\n   env->SetProtoMethod(t, \"setMaxSendFragment\", SetMaxSendFragment);\n #endif  // SSL_set_max_send_fragment\n \n-  env->SetProtoMethod(t, \"getALPNNegotiatedProtocol\", GetALPNNegotiatedProto);\n+  env->SetProtoMethodNoSideEffect(t, \"getALPNNegotiatedProtocol\",\n+                                  GetALPNNegotiatedProto);\n   env->SetProtoMethod(t, \"setALPNProtocols\", SetALPNProtocols);\n }\n \n@@ -2559,7 +2563,7 @@ void CipherBase::Initialize(Environment* env, Local<Object> target) {\n   env->SetProtoMethod(t, \"update\", Update);\n   env->SetProtoMethod(t, \"final\", Final);\n   env->SetProtoMethod(t, \"setAutoPadding\", SetAutoPadding);\n-  env->SetProtoMethod(t, \"getAuthTag\", GetAuthTag);\n+  env->SetProtoMethodNoSideEffect(t, \"getAuthTag\", GetAuthTag);\n   env->SetProtoMethod(t, \"setAuthTag\", SetAuthTag);\n   env->SetProtoMethod(t, \"setAAD\", SetAAD);\n \n@@ -3892,18 +3896,22 @@ void DiffieHellman::Initialize(Environment* env, Local<Object> target) {\n \n   env->SetProtoMethod(t, \"generateKeys\", GenerateKeys);\n   env->SetProtoMethod(t, \"computeSecret\", ComputeSecret);\n-  env->SetProtoMethod(t, \"getPrime\", GetPrime);\n-  env->SetProtoMethod(t, \"getGenerator\", GetGenerator);\n-  env->SetProtoMethod(t, \"getPublicKey\", GetPublicKey);\n-  env->SetProtoMethod(t, \"getPrivateKey\", GetPrivateKey);\n+  env->SetProtoMethodNoSideEffect(t, \"getPrime\", GetPrime);\n+  env->SetProtoMethodNoSideEffect(t, \"getGenerator\", GetGenerator);\n+  env->SetProtoMethodNoSideEffect(t, \"getPublicKey\", GetPublicKey);\n+  env->SetProtoMethodNoSideEffect(t, \"getPrivateKey\", GetPrivateKey);\n   env->SetProtoMethod(t, \"setPublicKey\", SetPublicKey);\n   env->SetProtoMethod(t, \"setPrivateKey\", SetPrivateKey);\n \n   Local<FunctionTemplate> verify_error_getter_templ =\n       FunctionTemplate::New(env->isolate(),\n                             DiffieHellman::VerifyErrorGetter,\n                             env->as_external(),\n-                            Signature::New(env->isolate(), t));\n+                            Signature::New(env->isolate(), t),\n+                            /* length */ 0,\n+                            // TODO(TimothyGu): should be deny\n+                            ConstructorBehavior::kAllow,\n+                            SideEffectType::kHasNoSideEffect);\n \n   t->InstanceTemplate()->SetAccessorProperty(\n       env->verify_error_string(),\n@@ -3919,16 +3927,20 @@ void DiffieHellman::Initialize(Environment* env, Local<Object> target) {\n \n   env->SetProtoMethod(t2, \"generateKeys\", GenerateKeys);\n   env->SetProtoMethod(t2, \"computeSecret\", ComputeSecret);\n-  env->SetProtoMethod(t2, \"getPrime\", GetPrime);\n-  env->SetProtoMethod(t2, \"getGenerator\", GetGenerator);\n-  env->SetProtoMethod(t2, \"getPublicKey\", GetPublicKey);\n-  env->SetProtoMethod(t2, \"getPrivateKey\", GetPrivateKey);\n+  env->SetProtoMethodNoSideEffect(t2, \"getPrime\", GetPrime);\n+  env->SetProtoMethodNoSideEffect(t2, \"getGenerator\", GetGenerator);\n+  env->SetProtoMethodNoSideEffect(t2, \"getPublicKey\", GetPublicKey);\n+  env->SetProtoMethodNoSideEffect(t2, \"getPrivateKey\", GetPrivateKey);\n \n   Local<FunctionTemplate> verify_error_getter_templ2 =\n       FunctionTemplate::New(env->isolate(),\n                             DiffieHellman::VerifyErrorGetter,\n                             env->as_external(),\n-                            Signature::New(env->isolate(), t2));\n+                            Signature::New(env->isolate(), t2),\n+                            /* length */ 0,\n+                            // TODO(TimothyGu): should be deny\n+                            ConstructorBehavior::kAllow,\n+                            SideEffectType::kHasNoSideEffect);\n \n   t2->InstanceTemplate()->SetAccessorProperty(\n       env->verify_error_string(),\n@@ -4280,8 +4292,8 @@ void ECDH::Initialize(Environment* env, Local<Object> target) {\n \n   env->SetProtoMethod(t, \"generateKeys\", GenerateKeys);\n   env->SetProtoMethod(t, \"computeSecret\", ComputeSecret);\n-  env->SetProtoMethod(t, \"getPublicKey\", GetPublicKey);\n-  env->SetProtoMethod(t, \"getPrivateKey\", GetPrivateKey);\n+  env->SetProtoMethodNoSideEffect(t, \"getPublicKey\", GetPublicKey);\n+  env->SetProtoMethodNoSideEffect(t, \"getPrivateKey\", GetPrivateKey);\n   env->SetProtoMethod(t, \"setPublicKey\", SetPublicKey);\n   env->SetProtoMethod(t, \"setPrivateKey\", SetPrivateKey);\n \n@@ -5172,27 +5184,27 @@ void Initialize(Local<Object> target,\n   Sign::Initialize(env, target);\n   Verify::Initialize(env, target);\n \n-  env->SetMethod(target, \"certVerifySpkac\", VerifySpkac);\n-  env->SetMethod(target, \"certExportPublicKey\", ExportPublicKey);\n-  env->SetMethod(target, \"certExportChallenge\", ExportChallenge);\n+  env->SetMethodNoSideEffect(target, \"certVerifySpkac\", VerifySpkac);\n+  env->SetMethodNoSideEffect(target, \"certExportPublicKey\", ExportPublicKey);\n+  env->SetMethodNoSideEffect(target, \"certExportChallenge\", ExportChallenge);\n \n-  env->SetMethod(target, \"ECDHConvertKey\", ConvertKey);\n+  env->SetMethodNoSideEffect(target, \"ECDHConvertKey\", ConvertKey);\n #ifndef OPENSSL_NO_ENGINE\n   env->SetMethod(target, \"setEngine\", SetEngine);\n #endif  // !OPENSSL_NO_ENGINE\n \n #ifdef NODE_FIPS_MODE\n-  env->SetMethod(target, \"getFipsCrypto\", GetFipsCrypto);\n+  env->SetMethodNoSideEffect(target, \"getFipsCrypto\", GetFipsCrypto);\n   env->SetMethod(target, \"setFipsCrypto\", SetFipsCrypto);\n #endif\n \n   env->SetMethod(target, \"pbkdf2\", PBKDF2);\n   env->SetMethod(target, \"randomBytes\", RandomBytes);\n-  env->SetMethod(target, \"timingSafeEqual\", TimingSafeEqual);\n-  env->SetMethod(target, \"getSSLCiphers\", GetSSLCiphers);\n-  env->SetMethod(target, \"getCiphers\", GetCiphers);\n-  env->SetMethod(target, \"getHashes\", GetHashes);\n-  env->SetMethod(target, \"getCurves\", GetCurves);\n+  env->SetMethodNoSideEffect(target, \"timingSafeEqual\", TimingSafeEqual);\n+  env->SetMethodNoSideEffect(target, \"getSSLCiphers\", GetSSLCiphers);\n+  env->SetMethodNoSideEffect(target, \"getCiphers\", GetCiphers);\n+  env->SetMethodNoSideEffect(target, \"getHashes\", GetHashes);\n+  env->SetMethodNoSideEffect(target, \"getCurves\", GetCurves);\n   env->SetMethod(target, \"publicEncrypt\",\n                  PublicKeyCipher::Cipher<PublicKeyCipher::kPublic,\n                                          EVP_PKEY_encrypt_init,"
        },
        {
            "sha": "4872491c9249899ce8b06686a8f016bc99d83239",
            "filename": "src/node_types.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_types.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_types.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_types.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -56,13 +56,13 @@ void InitializeTypes(Local<Object> target,\n                      Local<Context> context) {\n   Environment* env = Environment::GetCurrent(context);\n \n-#define V(type) env->SetMethod(target,     \\\n-                               \"is\" #type, \\\n-                               Is##type);\n+#define V(type) env->SetMethodNoSideEffect(target,     \\\n+                                           \"is\" #type, \\\n+                                           Is##type);\n   VALUE_METHOD_MAP(V)\n #undef V\n \n-  env->SetMethod(target, \"isAnyArrayBuffer\", IsAnyArrayBuffer);\n+  env->SetMethodNoSideEffect(target, \"isAnyArrayBuffer\", IsAnyArrayBuffer);\n }\n \n }  // anonymous namespace"
        },
        {
            "sha": "1cdb179ed254f5839ef08a9e22e25b40d0b2e572",
            "filename": "src/node_url.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_url.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_url.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_url.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -2334,10 +2334,10 @@ static void Initialize(Local<Object> target,\n                        void* priv) {\n   Environment* env = Environment::GetCurrent(context);\n   env->SetMethod(target, \"parse\", Parse);\n-  env->SetMethod(target, \"encodeAuth\", EncodeAuthSet);\n-  env->SetMethod(target, \"toUSVString\", ToUSVString);\n-  env->SetMethod(target, \"domainToASCII\", DomainToASCII);\n-  env->SetMethod(target, \"domainToUnicode\", DomainToUnicode);\n+  env->SetMethodNoSideEffect(target, \"encodeAuth\", EncodeAuthSet);\n+  env->SetMethodNoSideEffect(target, \"toUSVString\", ToUSVString);\n+  env->SetMethodNoSideEffect(target, \"domainToASCII\", DomainToASCII);\n+  env->SetMethodNoSideEffect(target, \"domainToUnicode\", DomainToUnicode);\n   env->SetMethod(target, \"setURLConstructor\", SetURLConstructor);\n \n #define XX(name, _) NODE_DEFINE_CONSTANT(target, name);"
        },
        {
            "sha": "724bb3603cfddd07301a53cffca566a3a52c23b2",
            "filename": "src/node_util.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_util.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -212,18 +212,19 @@ void Initialize(Local<Object> target,\n   V(kRejected);\n #undef V\n \n-  env->SetMethod(target, \"getHiddenValue\", GetHiddenValue);\n+  env->SetMethodNoSideEffect(target, \"getHiddenValue\", GetHiddenValue);\n   env->SetMethod(target, \"setHiddenValue\", SetHiddenValue);\n-  env->SetMethod(target, \"getPromiseDetails\", GetPromiseDetails);\n-  env->SetMethod(target, \"getProxyDetails\", GetProxyDetails);\n-  env->SetMethod(target, \"safeToString\", SafeToString);\n-  env->SetMethod(target, \"previewEntries\", PreviewEntries);\n+  env->SetMethodNoSideEffect(target, \"getPromiseDetails\", GetPromiseDetails);\n+  env->SetMethodNoSideEffect(target, \"getProxyDetails\", GetProxyDetails);\n+  env->SetMethodNoSideEffect(target, \"safeToString\", SafeToString);\n+  env->SetMethodNoSideEffect(target, \"previewEntries\", PreviewEntries);\n \n   env->SetMethod(target, \"startSigintWatchdog\", StartSigintWatchdog);\n   env->SetMethod(target, \"stopSigintWatchdog\", StopSigintWatchdog);\n-  env->SetMethod(target, \"watchdogHasPendingSigint\", WatchdogHasPendingSigint);\n+  env->SetMethodNoSideEffect(target, \"watchdogHasPendingSigint\",\n+                             WatchdogHasPendingSigint);\n \n-  env->SetMethod(target, \"createPromise\", CreatePromise);\n+  env->SetMethodNoSideEffect(target, \"createPromise\", CreatePromise);\n   env->SetMethod(target, \"promiseResolve\", PromiseResolve);\n   env->SetMethod(target, \"promiseReject\", PromiseReject);\n "
        },
        {
            "sha": "fb0a9fea1e5d27d1fdc566c911686c49a4fcb06d",
            "filename": "src/node_v8.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_v8.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fnode_v8.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_v8.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -122,7 +122,8 @@ void Initialize(Local<Object> target,\n                 Local<Context> context) {\n   Environment* env = Environment::GetCurrent(context);\n \n-  env->SetMethod(target, \"cachedDataVersionTag\", CachedDataVersionTag);\n+  env->SetMethodNoSideEffect(target, \"cachedDataVersionTag\",\n+                             CachedDataVersionTag);\n \n   env->SetMethod(target,\n                  \"updateHeapStatisticsArrayBuffer\","
        },
        {
            "sha": "bd451031737be1d735479efab9d501477bc3f2ed",
            "filename": "src/stream_base-inl.h",
            "status": "modified",
            "additions": 17,
            "deletions": 16,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fstream_base-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Fstream_base-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base-inl.h?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -277,29 +277,30 @@ void StreamBase::AddMethods(Environment* env,\n \n   Local<Signature> signature = Signature::New(env->isolate(), t);\n \n+  // TODO(TimothyGu): None of these should have ConstructorBehavior::kAllow.\n   Local<FunctionTemplate> get_fd_templ =\n-      FunctionTemplate::New(env->isolate(),\n-                            GetFD<Base>,\n-                            env->as_external(),\n-                            signature);\n+      env->NewFunctionTemplate(GetFD<Base>,\n+                               signature,\n+                               v8::ConstructorBehavior::kAllow,\n+                               v8::SideEffectType::kHasNoSideEffect);\n \n   Local<FunctionTemplate> get_external_templ =\n-      FunctionTemplate::New(env->isolate(),\n-                            GetExternal<Base>,\n-                            env->as_external(),\n-                            signature);\n+      env->NewFunctionTemplate(GetExternal<Base>,\n+                               signature,\n+                               v8::ConstructorBehavior::kAllow,\n+                               v8::SideEffectType::kHasNoSideEffect);\n \n   Local<FunctionTemplate> get_bytes_read_templ =\n-      FunctionTemplate::New(env->isolate(),\n-                            GetBytesRead<Base>,\n-                            env->as_external(),\n-                            signature);\n+      env->NewFunctionTemplate(GetBytesRead<Base>,\n+                               signature,\n+                               v8::ConstructorBehavior::kAllow,\n+                               v8::SideEffectType::kHasNoSideEffect);\n \n   Local<FunctionTemplate> get_bytes_written_templ =\n-      FunctionTemplate::New(env->isolate(),\n-                            GetBytesWritten<Base>,\n-                            env->as_external(),\n-                            signature);\n+      env->NewFunctionTemplate(GetBytesWritten<Base>,\n+                               signature,\n+                               v8::ConstructorBehavior::kAllow,\n+                               v8::SideEffectType::kHasNoSideEffect);\n \n   t->PrototypeTemplate()->SetAccessorProperty(env->fd_string(),\n                                               get_fd_templ,"
        },
        {
            "sha": "83b6e34d630e7311c8483e77359939e84105d3e8",
            "filename": "src/tty_wrap.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Ftty_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/65f617314d1ea2df8b9e16fb7e7078b5913c749c/src%2Ftty_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftty_wrap.cc?ref=65f617314d1ea2df8b9e16fb7e7078b5913c749c",
            "patch": "@@ -58,15 +58,15 @@ void TTYWrap::Initialize(Local<Object> target,\n   env->SetProtoMethod(t, \"close\", HandleWrap::Close);\n   env->SetProtoMethod(t, \"unref\", HandleWrap::Unref);\n   env->SetProtoMethod(t, \"ref\", HandleWrap::Ref);\n-  env->SetProtoMethod(t, \"hasRef\", HandleWrap::HasRef);\n+  env->SetProtoMethodNoSideEffect(t, \"hasRef\", HandleWrap::HasRef);\n \n   LibuvStreamWrap::AddMethods(env, t);\n \n-  env->SetProtoMethod(t, \"getWindowSize\", TTYWrap::GetWindowSize);\n+  env->SetProtoMethodNoSideEffect(t, \"getWindowSize\", TTYWrap::GetWindowSize);\n   env->SetProtoMethod(t, \"setRawMode\", SetRawMode);\n \n-  env->SetMethod(target, \"isTTY\", IsTTY);\n-  env->SetMethod(target, \"guessHandleType\", GuessHandleType);\n+  env->SetMethodNoSideEffect(target, \"isTTY\", IsTTY);\n+  env->SetMethodNoSideEffect(target, \"guessHandleType\", GuessHandleType);\n \n   target->Set(ttyString, t->GetFunction());\n   env->set_tty_constructor_template(t);"
        }
    ],
    "stats": {
        "total": 318,
        "additions": 206,
        "deletions": 112
    }
}