{
    "author": "TimothyGu",
    "message": "benchmark: port cluster/echo to worker\n\n    $ ./node benchmark/cluster/echo.js\n    cluster/echo.js n=100000 sendsPerBroadcast=1 payload=\"string\" workers=1: 33,647.30473442063\n    cluster/echo.js n=100000 sendsPerBroadcast=10 payload=\"string\" workers=1: 12,927.907405288383\n    cluster/echo.js n=100000 sendsPerBroadcast=1 payload=\"object\" workers=1: 28,496.37373941151\n    cluster/echo.js n=100000 sendsPerBroadcast=10 payload=\"object\" workers=1: 8,975.53747186485\n    $ ./node --experimental-worker benchmark/worker/echo.js\n    worker/echo.js n=100000 sendsPerBroadcast=1 payload=\"string\" workers=1: 88,044.32902365089\n    worker/echo.js n=100000 sendsPerBroadcast=10 payload=\"string\" workers=1: 39,873.33697018837\n    worker/echo.js n=100000 sendsPerBroadcast=1 payload=\"object\" workers=1: 64,451.29132425621\n    worker/echo.js n=100000 sendsPerBroadcast=10 payload=\"object\" workers=1: 22,325.635443739284\n\nRefs: https://github.com/ayojs/ayo/pull/115\nReviewed-By: Anna Henningsen <anna@addaleax.net>\n\nPR-URL: https://github.com/nodejs/node/pull/20876\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Shingo Inoue <leko.noor@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "6d59bfb4f823e30e291a6841410e324879f6486e",
    "files": [
        {
            "sha": "fac5551a66b0fd9cbb4082f4fff37b387131562f",
            "filename": "benchmark/fixtures/echo.worker.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/6d59bfb4f823e30e291a6841410e324879f6486e/benchmark%2Ffixtures%2Fecho.worker.js",
            "raw_url": "https://github.com/nodejs/node/raw/6d59bfb4f823e30e291a6841410e324879f6486e/benchmark%2Ffixtures%2Fecho.worker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Ffixtures%2Fecho.worker.js?ref=6d59bfb4f823e30e291a6841410e324879f6486e",
            "patch": "@@ -0,0 +1,7 @@\n+'use strict';\n+\n+const { parentPort } = require('worker');\n+\n+parentPort.on('message', (msg) => {\n+  parentPort.postMessage(msg);\n+});"
        },
        {
            "sha": "6ab471a0a8480e709b653215859e8e9768dfe48b",
            "filename": "benchmark/worker/echo.js",
            "status": "added",
            "additions": 73,
            "deletions": 0,
            "changes": 73,
            "blob_url": "https://github.com/nodejs/node/blob/6d59bfb4f823e30e291a6841410e324879f6486e/benchmark%2Fworker%2Fecho.js",
            "raw_url": "https://github.com/nodejs/node/raw/6d59bfb4f823e30e291a6841410e324879f6486e/benchmark%2Fworker%2Fecho.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fworker%2Fecho.js?ref=6d59bfb4f823e30e291a6841410e324879f6486e",
            "patch": "@@ -0,0 +1,73 @@\n+'use strict';\n+\n+const common = require('../common.js');\n+const path = require('path');\n+const bench = common.createBenchmark(main, {\n+  workers: [1],\n+  payload: ['string', 'object'],\n+  sendsPerBroadcast: [1, 10],\n+  n: [1e5]\n+}, { flags: ['--experimental-worker'] });\n+\n+const workerPath = path.resolve(__dirname, '..', 'fixtures', 'echo.worker.js');\n+\n+function main(conf) {\n+  const { Worker } = require('worker');\n+\n+  const n = +conf.n;\n+  const workers = +conf.workers;\n+  const sends = +conf.sendsPerBroadcast;\n+  const expectedPerBroadcast = sends * workers;\n+  var payload;\n+  var readies = 0;\n+  var broadcasts = 0;\n+  var msgCount = 0;\n+\n+  switch (conf.payload) {\n+    case 'string':\n+      payload = 'hello world!';\n+      break;\n+    case 'object':\n+      payload = { action: 'pewpewpew', powerLevel: 9001 };\n+      break;\n+    default:\n+      throw new Error('Unsupported payload type');\n+  }\n+\n+  const workerObjs = [];\n+\n+  for (var i = 0; i < workers; ++i) {\n+    const worker = new Worker(workerPath);\n+    workerObjs.push(worker);\n+    worker.on('online', onOnline);\n+    worker.on('message', onMessage);\n+  }\n+\n+  function onOnline() {\n+    if (++readies === workers) {\n+      bench.start();\n+      broadcast();\n+    }\n+  }\n+\n+  function broadcast() {\n+    if (broadcasts++ === n) {\n+      bench.end(n);\n+      for (const worker of workerObjs) {\n+        worker.unref();\n+      }\n+      return;\n+    }\n+    for (const worker of workerObjs) {\n+      for (var i = 0; i < sends; ++i)\n+        worker.postMessage(payload);\n+    }\n+  }\n+\n+  function onMessage() {\n+    if (++msgCount === expectedPerBroadcast) {\n+      msgCount = 0;\n+      broadcast();\n+    }\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 80,
        "deletions": 0
    }
}