{
    "author": "devsnek",
    "message": "src, lib: return promises from link\n\nReturns the promises created by link so that they can be awaited to get\nrid of race conditions while resolving and loading modules.\n\nPR-URL: https://github.com/nodejs/node/pull/18394\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "edbcf7c8442d96aabeb564ba1121dad2ff4321a0",
    "files": [
        {
            "sha": "db37765b20bd0c81484cf48199f0e5fdc18a8b24",
            "filename": "lib/internal/loader/ModuleJob.js",
            "status": "modified",
            "additions": 10,
            "deletions": 14,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/edbcf7c8442d96aabeb564ba1121dad2ff4321a0/lib%2Finternal%2Floader%2FModuleJob.js",
            "raw_url": "https://github.com/nodejs/node/raw/edbcf7c8442d96aabeb564ba1121dad2ff4321a0/lib%2Finternal%2Floader%2FModuleJob.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Floader%2FModuleJob.js?ref=edbcf7c8442d96aabeb564ba1121dad2ff4321a0",
            "patch": "@@ -6,9 +6,6 @@ const { decorateErrorStack } = require('internal/util');\n const assert = require('assert');\n const resolvedPromise = SafePromise.resolve();\n \n-const enableDebug = (process.env.NODE_DEBUG || '').match(/\\besm\\b/) ||\n-    process.features.debug;\n-\n /* A ModuleJob tracks the loading of a single Module, and the ModuleJobs of\n  * its dependencies, over time. */\n class ModuleJob {\n@@ -27,25 +24,24 @@ class ModuleJob {\n \n     // Wait for the ModuleWrap instance being linked with all dependencies.\n     const link = async () => {\n-      const dependencyJobs = [];\n       ({ module: this.module,\n          reflect: this.reflect } = await this.modulePromise);\n       if (inspectBrk) {\n         const initWrapper = process.binding('inspector').callAndPauseOnStart;\n         initWrapper(this.module.instantiate, this.module);\n       }\n       assert(this.module instanceof ModuleWrap);\n-      this.module.link(async (dependencySpecifier) => {\n-        const dependencyJobPromise =\n-            this.loader.getModuleJob(dependencySpecifier, url);\n-        dependencyJobs.push(dependencyJobPromise);\n-        const dependencyJob = await dependencyJobPromise;\n-        return (await dependencyJob.modulePromise).module;\n+\n+      const dependencyJobs = [];\n+      const promises = this.module.link(async (specifier) => {\n+        const jobPromise = this.loader.getModuleJob(specifier, url);\n+        dependencyJobs.push(jobPromise);\n+        return (await (await jobPromise).modulePromise).module;\n       });\n-      if (enableDebug) {\n-        // Make sure all dependencies are entered into the list synchronously.\n-        Object.freeze(dependencyJobs);\n-      }\n+\n+      if (promises !== undefined)\n+        await SafePromise.all(promises);\n+\n       return SafePromise.all(dependencyJobs);\n     };\n     // Promise for the list of all dependencyJobs."
        },
        {
            "sha": "daa7f9036a5abbc9f19c5fee0d2e62e7713f7331",
            "filename": "src/module_wrap.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/edbcf7c8442d96aabeb564ba1121dad2ff4321a0/src%2Fmodule_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/edbcf7c8442d96aabeb564ba1121dad2ff4321a0/src%2Fmodule_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.cc?ref=edbcf7c8442d96aabeb564ba1121dad2ff4321a0",
            "patch": "@@ -171,6 +171,9 @@ void ModuleWrap::Link(const FunctionCallbackInfo<Value>& args) {\n   Local<Context> mod_context = obj->context_.Get(isolate);\n   Local<Module> module = obj->module_.Get(isolate);\n \n+  Local<Array> promises = Array::New(isolate,\n+                                     module->GetModuleRequestsLength());\n+\n   // call the dependency resolve callbacks\n   for (int i = 0; i < module->GetModuleRequestsLength(); i++) {\n     Local<String> specifier = module->GetModuleRequest(i);\n@@ -193,9 +196,11 @@ void ModuleWrap::Link(const FunctionCallbackInfo<Value>& args) {\n     }\n     Local<Promise> resolve_promise = resolve_return_value.As<Promise>();\n     obj->resolve_cache_[specifier_std].Reset(env->isolate(), resolve_promise);\n+\n+    promises->Set(mod_context, specifier, resolve_promise).FromJust();\n   }\n \n-  args.GetReturnValue().Set(that);\n+  args.GetReturnValue().Set(promises);\n }\n \n void ModuleWrap::Instantiate(const FunctionCallbackInfo<Value>& args) {"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 16,
        "deletions": 15
    }
}