{
    "author": "BridgeAR",
    "message": "repl: tab auto complete big arrays\n\nDue to a new API it's possible to skip the indices. That allows to\nuse auto completion with big (typed) arrays.\n\nPR-URL: https://github.com/nodejs/node/pull/22408\nFixes: https://github.com/nodejs/node/issues/21446\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "68b07ded9ceb23cf411fa4843b01f533efb600b4",
    "files": [
        {
            "sha": "40afd9207e70f4f0060f162dd8aa6a810f50dc56",
            "filename": "lib/internal/util.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/68b07ded9ceb23cf411fa4843b01f533efb600b4/lib%2Finternal%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/68b07ded9ceb23cf411fa4843b01f533efb600b4/lib%2Finternal%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil.js?ref=68b07ded9ceb23cf411fa4843b01f533efb600b4",
            "patch": "@@ -366,7 +366,6 @@ function isInsideNodeModules() {\n   return false;\n }\n \n-\n module.exports = {\n   assertCrypto,\n   cachedResult,"
        },
        {
            "sha": "1cde5502ca87786988eae5864946cdc5cab2ea4b",
            "filename": "lib/internal/util/comparisons.js",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/68b07ded9ceb23cf411fa4843b01f533efb600b4/lib%2Finternal%2Futil%2Fcomparisons.js",
            "raw_url": "https://github.com/nodejs/node/raw/68b07ded9ceb23cf411fa4843b01f533efb600b4/lib%2Finternal%2Futil%2Fcomparisons.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil%2Fcomparisons.js?ref=68b07ded9ceb23cf411fa4843b01f533efb600b4",
            "patch": "@@ -10,7 +10,12 @@ const {\n   isRegExp,\n   isSet\n } = internalBinding('types');\n-const { getOwnNonIndexProperties } = process.binding('util');\n+const {\n+  getOwnNonIndexProperties,\n+  propertyFilter: {\n+    ONLY_ENUMERABLE\n+  }\n+} = process.binding('util');\n \n const ReflectApply = Reflect.apply;\n \n@@ -118,8 +123,9 @@ function strictDeepEqual(val1, val2, memos) {\n     if (val1.length !== val2.length) {\n       return false;\n     }\n-    const keys1 = getOwnNonIndexProperties(val1);\n-    if (keys1.length !== getOwnNonIndexProperties(val2).length) {\n+    const keys1 = getOwnNonIndexProperties(val1, ONLY_ENUMERABLE);\n+    const keys2 = getOwnNonIndexProperties(val2, ONLY_ENUMERABLE);\n+    if (keys1.length !== keys2.length) {\n       return false;\n     }\n     return keyCheck(val1, val2, kStrict, memos, kIsArray, keys1);\n@@ -150,8 +156,9 @@ function strictDeepEqual(val1, val2, memos) {\n     // Buffer.compare returns true, so val1.length === val2.length. If they both\n     // only contain numeric keys, we don't need to exam further than checking\n     // the symbols.\n-    const keys1 = getOwnNonIndexProperties(val1);\n-    if (keys1.length !== getOwnNonIndexProperties(val2).length) {\n+    const keys1 = getOwnNonIndexProperties(val1, ONLY_ENUMERABLE);\n+    const keys2 = getOwnNonIndexProperties(val2, ONLY_ENUMERABLE);\n+    if (keys1.length !== keys2.length) {\n       return false;\n     }\n     return keyCheck(val1, val2, kStrict, memos, kNoIterator, keys1);"
        },
        {
            "sha": "a0cf2c1dd086eadc5939eaaba52f5d57a3dacb6c",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 9,
            "deletions": 27,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/68b07ded9ceb23cf411fa4843b01f533efb600b4/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/68b07ded9ceb23cf411fa4843b01f533efb600b4/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=68b07ded9ceb23cf411fa4843b01f533efb600b4",
            "patch": "@@ -52,7 +52,6 @@ const {\n   isIdentifierChar\n } = require('internal/deps/acorn/dist/acorn');\n const internalUtil = require('internal/util');\n-const { isTypedArray } = require('internal/util/types');\n const util = require('util');\n const utilBinding = process.binding('util');\n const { inherits } = util;\n@@ -74,6 +73,13 @@ const {\n const { sendInspectorCommand } = require('internal/util/inspector');\n const { experimentalREPLAwait } = process.binding('config');\n const { isRecoverableError } = require('internal/repl/recoverable');\n+const {\n+  getOwnNonIndexProperties,\n+  propertyFilter: {\n+    ALL_PROPERTIES,\n+    SKIP_SYMBOLS\n+  }\n+} = process.binding('util');\n \n // Lazy-loaded.\n let processTopLevelAwait;\n@@ -927,34 +933,10 @@ function isIdentifier(str) {\n   return true;\n }\n \n-const ARRAY_LENGTH_THRESHOLD = 1e6;\n-\n-function mayBeLargeObject(obj) {\n-  if (Array.isArray(obj)) {\n-    return obj.length > ARRAY_LENGTH_THRESHOLD ? ['length'] : null;\n-  } else if (isTypedArray(obj)) {\n-    return obj.length > ARRAY_LENGTH_THRESHOLD ? [] : null;\n-  }\n-\n-  return null;\n-}\n-\n function filteredOwnPropertyNames(obj) {\n   if (!obj) return [];\n-  const fakeProperties = mayBeLargeObject(obj);\n-  if (fakeProperties !== null) {\n-    this.outputStream.write('\\r\\n');\n-    process.emitWarning(\n-      'The current array, Buffer or TypedArray has too many entries. ' +\n-      'Certain properties may be missing from completion output.',\n-      'REPLWarning',\n-      undefined,\n-      undefined,\n-      true);\n-\n-    return fakeProperties;\n-  }\n-  return Object.getOwnPropertyNames(obj).filter(isIdentifier);\n+  const filter = ALL_PROPERTIES | SKIP_SYMBOLS;\n+  return getOwnNonIndexProperties(obj, filter).filter(isIdentifier);\n }\n \n function getGlobalLexicalScopeNames(contextId) {"
        },
        {
            "sha": "5adecf4d9753c373cd44063320ef310e5c9d44c5",
            "filename": "src/node_util.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 6,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/68b07ded9ceb23cf411fa4843b01f533efb600b4/src%2Fnode_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/68b07ded9ceb23cf411fa4843b01f533efb600b4/src%2Fnode_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_util.cc?ref=68b07ded9ceb23cf411fa4843b01f533efb600b4",
            "patch": "@@ -4,34 +4,43 @@\n namespace node {\n namespace util {\n \n+using v8::ALL_PROPERTIES;\n using v8::Array;\n using v8::Context;\n using v8::FunctionCallbackInfo;\n using v8::Integer;\n using v8::Local;\n using v8::Object;\n+using v8::ONLY_CONFIGURABLE;\n+using v8::ONLY_ENUMERABLE;\n+using v8::ONLY_WRITABLE;\n using v8::Private;\n using v8::Promise;\n using v8::Proxy;\n+using v8::SKIP_STRINGS;\n+using v8::SKIP_SYMBOLS;\n using v8::String;\n+using v8::Uint32;\n using v8::Value;\n \n static void GetOwnNonIndexProperties(\n     const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   Local<Context> context = env->context();\n \n-  if (!args[0]->IsObject())\n-    return;\n+  CHECK(args[0]->IsObject());\n+  CHECK(args[1]->IsUint32());\n+\n+  Local<Object> object = args[0].As<Object>();\n \n-  v8::Local<v8::Object> object = args[0].As<v8::Object>();\n+  Local<Array> properties;\n \n-  // Return only non-enumerable properties by default.\n-  v8::Local<v8::Array> properties;\n+  v8::PropertyFilter filter =\n+    static_cast<v8::PropertyFilter>(args[1].As<Uint32>()->Value());\n \n   if (!object->GetPropertyNames(\n         context, v8::KeyCollectionMode::kOwnOnly,\n-        v8::ONLY_ENUMERABLE,\n+        filter,\n         v8::IndexFilter::kSkipIndices)\n           .ToLocal(&properties)) {\n     return;\n@@ -209,6 +218,17 @@ void Initialize(Local<Object> target,\n                              WatchdogHasPendingSigint);\n \n   env->SetMethod(target, \"safeGetenv\", SafeGetenv);\n+\n+  Local<Object> constants = Object::New(env->isolate());\n+  NODE_DEFINE_CONSTANT(constants, ALL_PROPERTIES);\n+  NODE_DEFINE_CONSTANT(constants, ONLY_WRITABLE);\n+  NODE_DEFINE_CONSTANT(constants, ONLY_ENUMERABLE);\n+  NODE_DEFINE_CONSTANT(constants, ONLY_CONFIGURABLE);\n+  NODE_DEFINE_CONSTANT(constants, SKIP_STRINGS);\n+  NODE_DEFINE_CONSTANT(constants, SKIP_SYMBOLS);\n+  target->Set(context,\n+              FIXED_ONE_BYTE_STRING(env->isolate(), \"propertyFilter\"),\n+              constants).FromJust();\n }\n \n }  // namespace util"
        },
        {
            "sha": "ca7d2054758d21e12653e9e97df040ff23caccaf",
            "filename": "test/parallel/test-repl-tab-complete.js",
            "status": "modified",
            "additions": 4,
            "deletions": 15,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/68b07ded9ceb23cf411fa4843b01f533efb600b4/test%2Fparallel%2Ftest-repl-tab-complete.js",
            "raw_url": "https://github.com/nodejs/node/raw/68b07ded9ceb23cf411fa4843b01f533efb600b4/test%2Fparallel%2Ftest-repl-tab-complete.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-tab-complete.js?ref=68b07ded9ceb23cf411fa4843b01f533efb600b4",
            "patch": "@@ -393,12 +393,6 @@ testMe.complete('obj.', common.mustCall((error, data) => {\n   assert(data[0].includes('obj.key'));\n }));\n \n-// tab completion for large buffer\n-const warningRegEx = new RegExp(\n-  '\\\\(node:\\\\d+\\\\) REPLWarning: The current array, Buffer or TypedArray has ' +\n-  'too many entries\\\\. Certain properties may be missing from completion ' +\n-  'output\\\\.');\n-\n [\n   Array,\n   Buffer,\n@@ -428,11 +422,7 @@ const warningRegEx = new RegExp(\n     putIn.run([`var ele = new ${type.name}(1e6 + 1); ele.biu = 1;`]);\n   }\n \n-  common.hijackStderr(common.mustCall((err) => {\n-    process.nextTick(() => {\n-      assert.ok(warningRegEx.test(err));\n-    });\n-  }));\n+  common.hijackStderr(common.mustNotCall());\n   testMe.complete('ele.', common.mustCall((err, data) => {\n     common.restoreStderr();\n     assert.ifError(err);\n@@ -443,13 +433,12 @@ const warningRegEx = new RegExp(\n         Buffer.alloc(0) :\n         new type(0));\n \n+    assert.strictEqual(data[0].includes('ele.biu'), true);\n+\n     data[0].forEach((key) => {\n-      if (!key) return;\n+      if (!key || key === 'ele.biu') return;\n       assert.notStrictEqual(ele[key.substr(4)], undefined);\n     });\n-\n-    // no `biu`\n-    assert.strictEqual(data.includes('ele.biu'), false);\n   }));\n });\n "
        }
    ],
    "stats": {
        "total": 105,
        "additions": 51,
        "deletions": 54
    }
}