{
    "author": "psmarshall",
    "message": "deps: cherry-pick b87d408 from upstream V8\n\nOriginal commit message:\n\n    [heap-profiler] Fix a use-after-free when snapshots are deleted\n\n    If a caller starts the sampling heap profiler and takes a snapshot,\n    and then deletes the snapshot before the sampling has completed, a\n    use-after-free will occur on the StringsStorage pointer.\n\n    The same issue applies for StartTrackingHeapObjects which shares the\n    same StringsStorage object.\n\n    Bug: v8:8373\n    Change-Id: I5d69d60d3f9465f9dd3b3bef107c204e0fda0643\n    Reviewed-on: https://chromium-review.googlesource.com/c/1301477\n    Commit-Queue: Peter Marshall <petermarshall@chromium.org>\n    Reviewed-by: Alexei Filippov <alph@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#57114}\n\nPR-URL: https://github.com/nodejs/node/pull/24272\nRefs:\nhttps://github.com/v8/v8/commit/b87d408f65b9ab49a4d199e850d2358995deaeb2\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "e36e9dde38caf3517890da2265e6dd9f127abe72",
    "files": [
        {
            "sha": "cd57005308e355dcb9f5c0932e6ba9d61140f30b",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/e36e9dde38caf3517890da2265e6dd9f127abe72/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/e36e9dde38caf3517890da2265e6dd9f127abe72/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=e36e9dde38caf3517890da2265e6dd9f127abe72",
            "patch": "@@ -38,7 +38,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.2',\n+    'v8_embedder_string': '-node.3',\n \n     ##### V8 defaults for Node.js #####\n "
        },
        {
            "sha": "58a8f3851f61ba68cc0222cf73e990f919aa8779",
            "filename": "deps/v8/src/profiler/heap-profiler.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/e36e9dde38caf3517890da2265e6dd9f127abe72/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e36e9dde38caf3517890da2265e6dd9f127abe72/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.cc?ref=e36e9dde38caf3517890da2265e6dd9f127abe72",
            "patch": "@@ -23,9 +23,14 @@ HeapProfiler::~HeapProfiler() = default;\n \n void HeapProfiler::DeleteAllSnapshots() {\n   snapshots_.clear();\n-  names_.reset(new StringsStorage());\n+  MaybeClearStringsStorage();\n }\n \n+void HeapProfiler::MaybeClearStringsStorage() {\n+  if (snapshots_.empty() && !sampling_heap_profiler_ && !allocation_tracker_) {\n+    names_.reset(new StringsStorage());\n+  }\n+}\n \n void HeapProfiler::RemoveSnapshot(HeapSnapshot* snapshot) {\n   snapshots_.erase(\n@@ -126,6 +131,7 @@ bool HeapProfiler::StartSamplingHeapProfiler(\n \n void HeapProfiler::StopSamplingHeapProfiler() {\n   sampling_heap_profiler_.reset();\n+  MaybeClearStringsStorage();\n }\n \n \n@@ -159,6 +165,7 @@ void HeapProfiler::StopHeapObjectsTracking() {\n   ids_->StopHeapObjectsTracking();\n   if (allocation_tracker_) {\n     allocation_tracker_.reset();\n+    MaybeClearStringsStorage();\n     heap()->RemoveHeapObjectAllocationTracker(this);\n   }\n }"
        },
        {
            "sha": "1e3527765ea1b98c027cdf69e45128f1b23f053e",
            "filename": "deps/v8/src/profiler/heap-profiler.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/e36e9dde38caf3517890da2265e6dd9f127abe72/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.h",
            "raw_url": "https://github.com/nodejs/node/raw/e36e9dde38caf3517890da2265e6dd9f127abe72/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.h?ref=e36e9dde38caf3517890da2265e6dd9f127abe72",
            "patch": "@@ -92,6 +92,8 @@ class HeapProfiler : public HeapObjectAllocationTracker {\n                     v8::PersistentValueVector<v8::Object>* objects);\n \n  private:\n+  void MaybeClearStringsStorage();\n+\n   Heap* heap() const;\n \n   // Mapping from HeapObject addresses to objects' uids."
        },
        {
            "sha": "f3c545fd83f2d874271e10187f7b69aa7456c16e",
            "filename": "deps/v8/test/cctest/test-heap-profiler.cc",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/e36e9dde38caf3517890da2265e6dd9f127abe72/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e36e9dde38caf3517890da2265e6dd9f127abe72/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc?ref=e36e9dde38caf3517890da2265e6dd9f127abe72",
            "patch": "@@ -3875,3 +3875,45 @@ TEST(WeakReference) {\n   const v8::HeapSnapshot* snapshot = heap_profiler->TakeHeapSnapshot();\n   CHECK(ValidateSnapshot(snapshot));\n }\n+\n+TEST(Bug8373_1) {\n+  LocalContext env;\n+  v8::HandleScope scope(env->GetIsolate());\n+  v8::HeapProfiler* heap_profiler = env->GetIsolate()->GetHeapProfiler();\n+\n+  heap_profiler->StartSamplingHeapProfiler(100);\n+\n+  heap_profiler->TakeHeapSnapshot();\n+  // Causes the StringsStorage to be deleted.\n+  heap_profiler->DeleteAllHeapSnapshots();\n+\n+  // Triggers an allocation sample that tries to use the StringsStorage.\n+  for (int i = 0; i < 2 * 1024; ++i) {\n+    CompileRun(\n+        \"new Array(64);\"\n+        \"new Uint8Array(16);\");\n+  }\n+\n+  heap_profiler->StopSamplingHeapProfiler();\n+}\n+\n+TEST(Bug8373_2) {\n+  LocalContext env;\n+  v8::HandleScope scope(env->GetIsolate());\n+  v8::HeapProfiler* heap_profiler = env->GetIsolate()->GetHeapProfiler();\n+\n+  heap_profiler->StartTrackingHeapObjects(true);\n+\n+  heap_profiler->TakeHeapSnapshot();\n+  // Causes the StringsStorage to be deleted.\n+  heap_profiler->DeleteAllHeapSnapshots();\n+\n+  // Triggers an allocations that try to use the StringsStorage.\n+  for (int i = 0; i < 2 * 1024; ++i) {\n+    CompileRun(\n+        \"new Array(64);\"\n+        \"new Uint8Array(16);\");\n+  }\n+\n+  heap_profiler->StopTrackingHeapObjects();\n+}"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 53,
        "deletions": 2
    }
}