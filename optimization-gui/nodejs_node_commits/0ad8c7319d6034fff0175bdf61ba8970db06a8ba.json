{
    "author": "jasnell",
    "message": "http2: add RFC 8441 extended connect protocol support\n\nPR-URL: https://github.com/nodejs/node/pull/23284\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "0ad8c7319d6034fff0175bdf61ba8970db06a8ba",
    "files": [
        {
            "sha": "e1e82c9dce34561f98ae980571c0fe762b8caad0",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 36,
            "deletions": 1,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=0ad8c7319d6034fff0175bdf61ba8970db06a8ba",
            "patch": "@@ -2278,7 +2278,7 @@ not work.\n For incoming headers:\n * The `:status` header is converted to `number`.\n * Duplicates of `:status`, `:method`, `:authority`, `:scheme`, `:path`,\n-`age`, `authorization`, `access-control-allow-credentials`,\n+`:protocol`, `age`, `authorization`, `access-control-allow-credentials`,\n `access-control-max-age`, `access-control-request-method`, `content-encoding`,\n `content-language`, `content-length`, `content-location`, `content-md5`,\n `content-range`, `content-type`, `date`, `dnt`, `etag`, `expires`, `from`,\n@@ -2335,6 +2335,10 @@ properties.\n * `maxHeaderListSize` {number} Specifies the maximum size (uncompressed octets)\n   of header list that will be accepted. The minimum allowed value is 0. The\n   maximum allowed value is 2<sup>32</sup>-1. **Default:** `65535`.\n+* `enableConnectProtocol`{boolean} Specifies `true` if the \"Extended Connect\n+  Protocol\" defined by [RFC 8441][] is to be enabled. This setting is only\n+  meaningful if sent by the server. Once the `enableConnectProtocol` setting\n+  has been enabled for a given `Http2Session`, it cannot be disabled.\n \n All additional properties on the settings object are ignored.\n \n@@ -2501,6 +2505,36 @@ req.on('end', () => {\n req.end('Jane');\n ```\n \n+### The Extended CONNECT Protocol\n+\n+[RFC 8441][] defines an \"Extended CONNECT Protocol\" extension to HTTP/2 that\n+may be used to bootstrap the use of an `Http2Stream` using the `CONNECT`\n+method as a tunnel for other communication protocols (such as WebSockets).\n+\n+The use of the Extended CONNECT Protocol is enabled by HTTP/2 servers by using\n+the `enableConnectProtocol` setting:\n+\n+```js\n+const http2 = require('http2');\n+const settings = { enableConnectProtocol: true };\n+const server = http2.createServer({ settings });\n+```\n+\n+Once the client receives the `SETTINGS` frame from the server indicating that\n+the extended CONNECT may be used, it may send `CONNECT` requests that use the\n+`':protocol'`  HTTP/2 pseudo-header:\n+\n+```js\n+const http2 = require('http2');\n+const client = http2.connect('http://localhost:8080');\n+client.on('remoteSettings', (settings) => {\n+  if (settings.enableConnectProtocol) {\n+    const req = client.request({ ':method': 'CONNECT', ':protocol': 'foo' });\n+    // ...\n+  }\n+});\n+```\n+\n ## Compatibility API\n \n The Compatibility API has the goal of providing a similar developer experience\n@@ -3361,6 +3395,7 @@ following additional properties:\n [Readable Stream]: stream.html#stream_class_stream_readable\n [RFC 7838]: https://tools.ietf.org/html/rfc7838\n [RFC 8336]: https://tools.ietf.org/html/rfc8336\n+[RFC 8441]: https://tools.ietf.org/html/rfc8441\n [Using `options.selectPadding()`]: #http2_using_options_selectpadding\n [`'checkContinue'`]: #http2_event_checkcontinue\n [`'request'`]: #http2_event_request"
        },
        {
            "sha": "b08008857ec062e46773652da3ab9eff4075b88d",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=0ad8c7319d6034fff0175bdf61ba8970db06a8ba",
            "patch": "@@ -190,6 +190,7 @@ const {\n   HTTP2_HEADER_DATE,\n   HTTP2_HEADER_METHOD,\n   HTTP2_HEADER_PATH,\n+  HTTP2_HEADER_PROTOCOL,\n   HTTP2_HEADER_SCHEME,\n   HTTP2_HEADER_STATUS,\n   HTTP2_HEADER_CONTENT_LENGTH,\n@@ -1450,7 +1451,7 @@ class ClientHttp2Session extends Http2Session {\n \n     const connect = headers[HTTP2_HEADER_METHOD] === HTTP2_METHOD_CONNECT;\n \n-    if (!connect) {\n+    if (!connect || headers[HTTP2_HEADER_PROTOCOL] !== undefined) {\n       if (headers[HTTP2_HEADER_AUTHORITY] === undefined)\n         headers[HTTP2_HEADER_AUTHORITY] = this[kAuthority];\n       if (headers[HTTP2_HEADER_SCHEME] === undefined)"
        },
        {
            "sha": "94dc1198ea1060c734d803986dfae0420199ce55",
            "filename": "lib/internal/http2/util.js",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/lib%2Finternal%2Fhttp2%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/lib%2Finternal%2Fhttp2%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Futil.js?ref=0ad8c7319d6034fff0175bdf61ba8970db06a8ba",
            "patch": "@@ -20,6 +20,7 @@ const {\n   HTTP2_HEADER_AUTHORITY,\n   HTTP2_HEADER_SCHEME,\n   HTTP2_HEADER_PATH,\n+  HTTP2_HEADER_PROTOCOL,\n   HTTP2_HEADER_ACCESS_CONTROL_ALLOW_CREDENTIALS,\n   HTTP2_HEADER_ACCESS_CONTROL_MAX_AGE,\n   HTTP2_HEADER_ACCESS_CONTROL_REQUEST_METHOD,\n@@ -78,7 +79,8 @@ const kValidPseudoHeaders = new Set([\n   HTTP2_HEADER_METHOD,\n   HTTP2_HEADER_AUTHORITY,\n   HTTP2_HEADER_SCHEME,\n-  HTTP2_HEADER_PATH\n+  HTTP2_HEADER_PATH,\n+  HTTP2_HEADER_PROTOCOL\n ]);\n \n // This set contains headers that are permitted to have only a single\n@@ -89,6 +91,7 @@ const kSingleValueHeaders = new Set([\n   HTTP2_HEADER_AUTHORITY,\n   HTTP2_HEADER_SCHEME,\n   HTTP2_HEADER_PATH,\n+  HTTP2_HEADER_PROTOCOL,\n   HTTP2_HEADER_ACCESS_CONTROL_ALLOW_CREDENTIALS,\n   HTTP2_HEADER_ACCESS_CONTROL_MAX_AGE,\n   HTTP2_HEADER_ACCESS_CONTROL_REQUEST_METHOD,\n@@ -155,7 +158,8 @@ const IDX_SETTINGS_INITIAL_WINDOW_SIZE = 2;\n const IDX_SETTINGS_MAX_FRAME_SIZE = 3;\n const IDX_SETTINGS_MAX_CONCURRENT_STREAMS = 4;\n const IDX_SETTINGS_MAX_HEADER_LIST_SIZE = 5;\n-const IDX_SETTINGS_FLAGS = 6;\n+const IDX_SETTINGS_ENABLE_CONNECT_PROTOCOL = 6;\n+const IDX_SETTINGS_FLAGS = 7;\n \n const IDX_SESSION_STATE_EFFECTIVE_LOCAL_WINDOW_SIZE = 0;\n const IDX_SESSION_STATE_EFFECTIVE_RECV_DATA_LENGTH = 1;\n@@ -277,6 +281,12 @@ function getDefaultSettings() {\n       settingsBuffer[IDX_SETTINGS_MAX_HEADER_LIST_SIZE];\n   }\n \n+  if ((flags & (1 << IDX_SETTINGS_ENABLE_CONNECT_PROTOCOL)) ===\n+      (1 << IDX_SETTINGS_ENABLE_CONNECT_PROTOCOL)) {\n+    holder.enableConnectProtocol =\n+      settingsBuffer[IDX_SETTINGS_ENABLE_CONNECT_PROTOCOL];\n+  }\n+\n   return holder;\n }\n \n@@ -294,7 +304,8 @@ function getSettings(session, remote) {\n     initialWindowSize: settingsBuffer[IDX_SETTINGS_INITIAL_WINDOW_SIZE],\n     maxFrameSize: settingsBuffer[IDX_SETTINGS_MAX_FRAME_SIZE],\n     maxConcurrentStreams: settingsBuffer[IDX_SETTINGS_MAX_CONCURRENT_STREAMS],\n-    maxHeaderListSize: settingsBuffer[IDX_SETTINGS_MAX_HEADER_LIST_SIZE]\n+    maxHeaderListSize: settingsBuffer[IDX_SETTINGS_MAX_HEADER_LIST_SIZE],\n+    enableConnectProtocol: settingsBuffer[IDX_SETTINGS_ENABLE_CONNECT_PROTOCOL]\n   };\n }\n \n@@ -329,6 +340,11 @@ function updateSettingsBuffer(settings) {\n     flags |= (1 << IDX_SETTINGS_ENABLE_PUSH);\n     settingsBuffer[IDX_SETTINGS_ENABLE_PUSH] = Number(settings.enablePush);\n   }\n+  if (typeof settings.enableConnectProtocol === 'boolean') {\n+    flags |= (1 << IDX_SETTINGS_ENABLE_CONNECT_PROTOCOL);\n+    settingsBuffer[IDX_SETTINGS_ENABLE_CONNECT_PROTOCOL] =\n+      Number(settings.enableConnectProtocol);\n+  }\n \n   settingsBuffer[IDX_SETTINGS_FLAGS] = flags;\n }"
        },
        {
            "sha": "2c339d7249562ecd883d341dfef6fe99d64bfd77",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=0ad8c7319d6034fff0175bdf61ba8970db06a8ba",
            "patch": "@@ -219,6 +219,7 @@ void Http2Session::Http2Settings::Init() {\n   GRABSETTING(INITIAL_WINDOW_SIZE, \"initial window size\");\n   GRABSETTING(MAX_HEADER_LIST_SIZE, \"max header list size\");\n   GRABSETTING(ENABLE_PUSH, \"enable push\");\n+  GRABSETTING(ENABLE_CONNECT_PROTOCOL, \"enable connect protocol\");\n \n #undef GRABSETTING\n \n@@ -287,6 +288,8 @@ void Http2Session::Http2Settings::Update(Environment* env,\n       fn(**session, NGHTTP2_SETTINGS_MAX_HEADER_LIST_SIZE);\n   buffer[IDX_SETTINGS_ENABLE_PUSH] =\n       fn(**session, NGHTTP2_SETTINGS_ENABLE_PUSH);\n+  buffer[IDX_SETTINGS_ENABLE_CONNECT_PROTOCOL] =\n+      fn(**session, NGHTTP2_SETTINGS_ENABLE_CONNECT_PROTOCOL);\n }\n \n // Initializes the shared TypedArray with the default settings values.\n@@ -3091,6 +3094,7 @@ void Initialize(Local<Object> target,\n   NODE_DEFINE_CONSTANT(constants, NGHTTP2_SETTINGS_INITIAL_WINDOW_SIZE);\n   NODE_DEFINE_CONSTANT(constants, NGHTTP2_SETTINGS_MAX_FRAME_SIZE);\n   NODE_DEFINE_CONSTANT(constants, NGHTTP2_SETTINGS_MAX_HEADER_LIST_SIZE);\n+  NODE_DEFINE_CONSTANT(constants, NGHTTP2_SETTINGS_ENABLE_CONNECT_PROTOCOL);\n \n   NODE_DEFINE_CONSTANT(constants, PADDING_STRATEGY_NONE);\n   NODE_DEFINE_CONSTANT(constants, PADDING_STRATEGY_ALIGNED);"
        },
        {
            "sha": "8ecca63aeb0c0e74909043b428b87ef3eb9b2e08",
            "filename": "src/node_http2.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/src%2Fnode_http2.h",
            "raw_url": "https://github.com/nodejs/node/raw/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/src%2Fnode_http2.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.h?ref=0ad8c7319d6034fff0175bdf61ba8970db06a8ba",
            "patch": "@@ -160,6 +160,7 @@ struct nghttp2_header : public MemoryRetainer {\n   V(AUTHORITY, \":authority\")                                                  \\\n   V(SCHEME, \":scheme\")                                                        \\\n   V(PATH, \":path\")                                                            \\\n+  V(PROTOCOL, \":protocol\")                                                    \\\n   V(ACCEPT_CHARSET, \"accept-charset\")                                         \\\n   V(ACCEPT_ENCODING, \"accept-encoding\")                                       \\\n   V(ACCEPT_LANGUAGE, \"accept-language\")                                       \\"
        },
        {
            "sha": "d21d0f9009607488c1f04633f2edfaf6b6e69f3d",
            "filename": "src/node_http2_state.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/src%2Fnode_http2_state.h",
            "raw_url": "https://github.com/nodejs/node/raw/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/src%2Fnode_http2_state.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2_state.h?ref=0ad8c7319d6034fff0175bdf61ba8970db06a8ba",
            "patch": "@@ -15,6 +15,7 @@ namespace http2 {\n     IDX_SETTINGS_MAX_FRAME_SIZE,\n     IDX_SETTINGS_MAX_CONCURRENT_STREAMS,\n     IDX_SETTINGS_MAX_HEADER_LIST_SIZE,\n+    IDX_SETTINGS_ENABLE_CONNECT_PROTOCOL,\n     IDX_SETTINGS_COUNT\n   };\n "
        },
        {
            "sha": "6991f98afd72d1f48a71f1b390c210594aaa1fd5",
            "filename": "test/parallel/test-http2-binding.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/test%2Fparallel%2Ftest-http2-binding.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/test%2Fparallel%2Ftest-http2-binding.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-binding.js?ref=0ad8c7319d6034fff0175bdf61ba8970db06a8ba",
            "patch": "@@ -99,6 +99,7 @@ const expectedHeaderNames = {\n   HTTP2_HEADER_AUTHORITY: ':authority',\n   HTTP2_HEADER_SCHEME: ':scheme',\n   HTTP2_HEADER_PATH: ':path',\n+  HTTP2_HEADER_PROTOCOL: ':protocol',\n   HTTP2_HEADER_DATE: 'date',\n   HTTP2_HEADER_ACCEPT_CHARSET: 'accept-charset',\n   HTTP2_HEADER_ACCEPT_ENCODING: 'accept-encoding',\n@@ -219,7 +220,8 @@ const expectedNGConstants = {\n   NGHTTP2_SETTINGS_MAX_CONCURRENT_STREAMS: 3,\n   NGHTTP2_SETTINGS_INITIAL_WINDOW_SIZE: 4,\n   NGHTTP2_SETTINGS_MAX_FRAME_SIZE: 5,\n-  NGHTTP2_SETTINGS_MAX_HEADER_LIST_SIZE: 6\n+  NGHTTP2_SETTINGS_MAX_HEADER_LIST_SIZE: 6,\n+  NGHTTP2_SETTINGS_ENABLE_CONNECT_PROTOCOL: 8\n };\n \n const defaultSettings = {"
        },
        {
            "sha": "f4d033efe65707718bc1fba1322b832751452242",
            "filename": "test/parallel/test-http2-connect-method-extended-cant-turn-off.js",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/test%2Fparallel%2Ftest-http2-connect-method-extended-cant-turn-off.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/test%2Fparallel%2Ftest-http2-connect-method-extended-cant-turn-off.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-connect-method-extended-cant-turn-off.js?ref=0ad8c7319d6034fff0175bdf61ba8970db06a8ba",
            "patch": "@@ -0,0 +1,30 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const assert = require('assert');\n+const http2 = require('http2');\n+\n+const settings = { enableConnectProtocol: true };\n+const server = http2.createServer({ settings });\n+server.on('stream', common.mustNotCall());\n+server.on('session', common.mustCall((session) => {\n+  // This will force the connection to close because once extended connect\n+  // is on, it cannot be turned off. The server is behaving badly.\n+  session.settings({ enableConnectProtocol: false });\n+}));\n+\n+server.listen(0, common.mustCall(() => {\n+  const client = http2.connect(`http://localhost:${server.address().port}`);\n+  client.on('remoteSettings', common.mustCall((settings) => {\n+    assert(settings.enableConnectProtocol);\n+    const req = client.request({\n+      ':method': 'CONNECT',\n+      ':protocol': 'foo'\n+    });\n+    req.on('error', common.mustCall(() => {\n+      server.close();\n+    }));\n+  }));\n+}));"
        },
        {
            "sha": "bb424c73f0a2ad7864207aa1f30e9fb75753ed77",
            "filename": "test/parallel/test-http2-connect-method-extended.js",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/test%2Fparallel%2Ftest-http2-connect-method-extended.js",
            "raw_url": "https://github.com/nodejs/node/raw/0ad8c7319d6034fff0175bdf61ba8970db06a8ba/test%2Fparallel%2Ftest-http2-connect-method-extended.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-connect-method-extended.js?ref=0ad8c7319d6034fff0175bdf61ba8970db06a8ba",
            "patch": "@@ -0,0 +1,39 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const assert = require('assert');\n+const http2 = require('http2');\n+\n+const settings = { enableConnectProtocol: true };\n+const server = http2.createServer({ settings });\n+server.on('stream', common.mustCall((stream, headers) => {\n+  assert.strictEqual(headers[':method'], 'CONNECT');\n+  assert.strictEqual(headers[':scheme'], 'http');\n+  assert.strictEqual(headers[':protocol'], 'foo');\n+  assert.strictEqual(headers[':authority'],\n+                     `localhost:${server.address().port}`);\n+  assert.strictEqual(headers[':path'], '/');\n+  stream.respond();\n+  stream.end('ok');\n+}));\n+\n+server.listen(0, common.mustCall(() => {\n+  const client = http2.connect(`http://localhost:${server.address().port}`);\n+  client.on('remoteSettings', common.mustCall((settings) => {\n+    assert(settings.enableConnectProtocol);\n+    const req = client.request({\n+      ':method': 'CONNECT',\n+      ':protocol': 'foo'\n+    });\n+    req.resume();\n+    req.on('end', common.mustCall());\n+    req.on('close', common.mustCall(() => {\n+      assert.strictEqual(req.rstCode, 0);\n+      server.close();\n+      client.close();\n+    }));\n+    req.end();\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 141,
        "additions": 135,
        "deletions": 6
    }
}