{
    "author": "ofrobots",
    "message": "test: fix warnings in addon tests\n\nThe legacy MakeCallback deprecation was resulting in compile time\nwarnings in adddon tests. Fix them.\n\nRef: https://github.com/nodejs/node/pull/18632\n\nPR-URL: https://github.com/nodejs/node/pull/18810\nRefs: https://github.com/nodejs/node/pull/18632\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "6ab288f3b817197631f23dd858b1b622d80dab27",
    "files": [
        {
            "sha": "d4b74ed831f512710f2fe001b4f1e45210292da6",
            "filename": "test/addons/async-hello-world/binding.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/6ab288f3b817197631f23dd858b1b622d80dab27/test%2Faddons%2Fasync-hello-world%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6ab288f3b817197631f23dd858b1b622d80dab27/test%2Faddons%2Fasync-hello-world%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fasync-hello-world%2Fbinding.cc?ref=6ab288f3b817197631f23dd858b1b622d80dab27",
            "patch": "@@ -15,6 +15,7 @@ struct async_req {\n   int output;\n   v8::Isolate* isolate;\n   v8::Persistent<v8::Function> callback;\n+  node::async_context context;\n };\n \n void DoAsync(uv_work_t* r) {\n@@ -47,14 +48,16 @@ void AfterAsync(uv_work_t* r) {\n \n   if (use_makecallback) {\n     v8::Local<v8::Value> ret =\n-        node::MakeCallback(isolate, global, callback, 2, argv);\n+        node::MakeCallback(isolate, global, callback, 2, argv, req->context)\n+            .ToLocalChecked();\n     // This should be changed to an empty handle.\n     assert(!ret.IsEmpty());\n   } else {\n     callback->Call(global, 2, argv);\n   }\n \n   // cleanup\n+  node::EmitAsyncDestroy(isolate, req->context);\n   req->callback.Reset();\n   delete req;\n \n@@ -73,6 +76,7 @@ void Method(const v8::FunctionCallbackInfo<v8::Value>& args) {\n   req->input = args[0]->IntegerValue();\n   req->output = 0;\n   req->isolate = isolate;\n+  req->context = node::EmitAsyncInit(isolate, v8::Object::New(isolate), \"test\");\n \n   v8::Local<v8::Function> callback = v8::Local<v8::Function>::Cast(args[1]);\n   req->callback.Reset(isolate, callback);"
        },
        {
            "sha": "3b69d2d5725a8f52d8ec5648de05c678084bfc41",
            "filename": "test/addons/callback-scope/binding.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/6ab288f3b817197631f23dd858b1b622d80dab27/test%2Faddons%2Fcallback-scope%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6ab288f3b817197631f23dd858b1b622d80dab27/test%2Faddons%2Fcallback-scope%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fcallback-scope%2Fbinding.cc?ref=6ab288f3b817197631f23dd858b1b622d80dab27",
            "patch": "@@ -36,7 +36,8 @@ static v8::Persistent<v8::Promise::Resolver> persistent;\n static void Callback(uv_work_t* req, int ignored) {\n   v8::Isolate* isolate = v8::Isolate::GetCurrent();\n   v8::HandleScope scope(isolate);\n-  node::CallbackScope callback_scope(isolate, v8::Object::New(isolate), {0, 0});\n+  node::CallbackScope callback_scope(isolate, v8::Object::New(isolate),\n+                                     node::async_context{0, 0});\n \n   v8::Local<v8::Promise::Resolver> local =\n       v8::Local<v8::Promise::Resolver>::New(isolate, persistent);"
        },
        {
            "sha": "3fe3212ee3c8f57006de79eda20f6f2680b98f41",
            "filename": "test/addons/make-callback-recurse/binding.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/6ab288f3b817197631f23dd858b1b622d80dab27/test%2Faddons%2Fmake-callback-recurse%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6ab288f3b817197631f23dd858b1b622d80dab27/test%2Faddons%2Fmake-callback-recurse%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fmake-callback-recurse%2Fbinding.cc?ref=6ab288f3b817197631f23dd858b1b622d80dab27",
            "patch": "@@ -19,7 +19,8 @@ void MakeCallback(const FunctionCallbackInfo<Value>& args) {\n   Local<Object> recv = args[0].As<Object>();\n   Local<Function> method = args[1].As<Function>();\n \n-  node::MakeCallback(isolate, recv, method, 0, nullptr);\n+  node::MakeCallback(isolate, recv, method, 0, nullptr,\n+                     node::async_context{0, 0});\n }\n \n void Initialize(Local<Object> exports) {"
        },
        {
            "sha": "86ed203b98d8d99a5d42c0e1d1e229274e1f47b9",
            "filename": "test/addons/make-callback/binding.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/6ab288f3b817197631f23dd858b1b622d80dab27/test%2Faddons%2Fmake-callback%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6ab288f3b817197631f23dd858b1b622d80dab27/test%2Faddons%2Fmake-callback%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fmake-callback%2Fbinding.cc?ref=6ab288f3b817197631f23dd858b1b622d80dab27",
            "patch": "@@ -19,11 +19,13 @@ void MakeCallback(const v8::FunctionCallbackInfo<v8::Value>& args) {\n   if (args[1]->IsFunction()) {\n     auto method = args[1].As<v8::Function>();\n     result =\n-        node::MakeCallback(isolate, recv, method, argv.size(), argv.data());\n+        node::MakeCallback(isolate, recv, method, argv.size(), argv.data(),\n+                           node::async_context{0, 0}).ToLocalChecked();\n   } else if (args[1]->IsString()) {\n     auto method = args[1].As<v8::String>();\n     result =\n-        node::MakeCallback(isolate, recv, method, argv.size(), argv.data());\n+        node::MakeCallback(isolate, recv, method, argv.size(), argv.data(),\n+                           node::async_context{0, 0}).ToLocalChecked();\n   } else {\n     assert(0 && \"unreachable\");\n   }"
        },
        {
            "sha": "3e716443540229655672f8637c88750cac6ace6b",
            "filename": "test/addons/repl-domain-abort/binding.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/6ab288f3b817197631f23dd858b1b622d80dab27/test%2Faddons%2Frepl-domain-abort%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6ab288f3b817197631f23dd858b1b622d80dab27/test%2Faddons%2Frepl-domain-abort%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Frepl-domain-abort%2Fbinding.cc?ref=6ab288f3b817197631f23dd858b1b622d80dab27",
            "patch": "@@ -36,11 +36,10 @@ void Method(const FunctionCallbackInfo<Value>& args) {\n     Boolean::New(isolate, true),\n     Boolean::New(isolate, false)\n   };\n-  Local<Value> ret = node::MakeCallback(isolate,\n-                                        isolate->GetCurrentContext()->Global(),\n-                                        args[0].As<Function>(),\n-                                        2,\n-                                        params);\n+  Local<Value> ret =\n+      node::MakeCallback(isolate, isolate->GetCurrentContext()->Global(),\n+                         args[0].As<Function>(), 2, params,\n+                         node::async_context{0, 0}).ToLocalChecked();\n   assert(ret->IsTrue());\n }\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 17,
        "deletions": 10
    }
}