{
    "author": "oyyd",
    "message": "lib: enable TypedArray and DataView for the v8 module\n\nThis commit allow passing `TypedArray` and `DataView` to:\n- v8.deserialize()\n- new v8.Deserializer()\n- v8.serializer.writeRawBytes()\n\nPR-URL: https://github.com/nodejs/node/pull/23953\nRefs: https://github.com/nodejs/node/issues/1826\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "56881b0d952312320ee6a27e40bd553152e11688",
    "files": [
        {
            "sha": "6ce474a9baea30c911d377fd8595d18881fab404",
            "filename": "doc/api/v8.md",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/56881b0d952312320ee6a27e40bd553152e11688/doc%2Fapi%2Fv8.md",
            "raw_url": "https://github.com/nodejs/node/raw/56881b0d952312320ee6a27e40bd553152e11688/doc%2Fapi%2Fv8.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fv8.md?ref=56881b0d952312320ee6a27e40bd553152e11688",
            "patch": "@@ -185,7 +185,7 @@ Uses a [`DefaultSerializer`][] to serialize `value` into a buffer.\n added: v8.0.0\n -->\n \n-* `buffer` {Buffer|Uint8Array} A buffer returned by [`serialize()`][].\n+* `buffer` {Buffer|TypedArray|DataView} A buffer returned by [`serialize()`][].\n \n Uses a [`DefaultDeserializer`][] with default options to read a JS value\n from a buffer.\n@@ -252,7 +252,7 @@ For use inside of a custom [`serializer._writeHostObject()`][].\n \n #### serializer.writeRawBytes(buffer)\n \n-* `buffer` {Buffer|Uint8Array}\n+* `buffer` {Buffer|TypedArray|DataView}\n \n Write raw bytes into the serializerâ€™s internal buffer. The deserializer\n will require a way to compute the length of the buffer.\n@@ -308,7 +308,7 @@ added: v8.0.0\n \n #### new Deserializer(buffer)\n \n-* `buffer` {Buffer|Uint8Array} A buffer returned by\n+* `buffer` {Buffer|TypedArray|DataView} A buffer returned by\n   [`serializer.releaseBuffer()`][].\n \n Creates a new `Deserializer` object."
        },
        {
            "sha": "0a410944458d99982e94a9449e8895a322db7f7c",
            "filename": "src/node_serdes.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/56881b0d952312320ee6a27e40bd553152e11688/src%2Fnode_serdes.cc",
            "raw_url": "https://github.com/nodejs/node/raw/56881b0d952312320ee6a27e40bd553152e11688/src%2Fnode_serdes.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_serdes.cc?ref=56881b0d952312320ee6a27e40bd553152e11688",
            "patch": "@@ -266,9 +266,9 @@ void SerializerContext::WriteRawBytes(const FunctionCallbackInfo<Value>& args) {\n   SerializerContext* ctx;\n   ASSIGN_OR_RETURN_UNWRAP(&ctx, args.Holder());\n \n-  if (!args[0]->IsUint8Array()) {\n+  if (!args[0]->IsArrayBufferView()) {\n     return node::THROW_ERR_INVALID_ARG_TYPE(\n-        ctx->env(), \"source must be a Uint8Array\");\n+        ctx->env(), \"source must be a TypedArray or a DataView\");\n   }\n \n   ctx->serializer_.WriteRawBytes(Buffer::Data(args[0]),\n@@ -317,9 +317,9 @@ MaybeLocal<Object> DeserializerContext::ReadHostObject(Isolate* isolate) {\n void DeserializerContext::New(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n-  if (!args[0]->IsUint8Array()) {\n+  if (!args[0]->IsArrayBufferView()) {\n     return node::THROW_ERR_INVALID_ARG_TYPE(\n-        env, \"buffer must be a Uint8Array\");\n+        env, \"buffer must be a TypedArray or a DataView\");\n   }\n \n   new DeserializerContext(env, args.This(), args[0]);"
        },
        {
            "sha": "c019674f4592e46ced5ce9a325535fd95a2636d2",
            "filename": "test/parallel/test-v8-serdes.js",
            "status": "modified",
            "additions": 84,
            "deletions": 0,
            "changes": 84,
            "blob_url": "https://github.com/nodejs/node/blob/56881b0d952312320ee6a27e40bd553152e11688/test%2Fparallel%2Ftest-v8-serdes.js",
            "raw_url": "https://github.com/nodejs/node/raw/56881b0d952312320ee6a27e40bd553152e11688/test%2Fparallel%2Ftest-v8-serdes.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-v8-serdes.js?ref=56881b0d952312320ee6a27e40bd553152e11688",
            "patch": "@@ -98,6 +98,47 @@ const deserializerTypeError =\n   assert.strictEqual(des.readValue().val, hostObject);\n }\n \n+// This test ensures that `v8.Serializer.writeRawBytes()` support\n+// `TypedArray` and `DataView`.\n+{\n+  const text = 'hostObjectTag';\n+  const data = Buffer.from(text);\n+  const arrayBufferViews = common.getArrayBufferViews(data);\n+\n+  // `buf` is one of `TypedArray` or `DataView`.\n+  function testWriteRawBytes(buf) {\n+    let writeHostObjectCalled = false;\n+    const ser = new v8.DefaultSerializer();\n+\n+    ser._writeHostObject = common.mustCall((object) => {\n+      writeHostObjectCalled = true;\n+      ser.writeUint32(buf.byteLength);\n+      ser.writeRawBytes(buf);\n+    });\n+\n+    ser.writeHeader();\n+    ser.writeValue({ val: hostObject });\n+\n+    const des = new v8.DefaultDeserializer(ser.releaseBuffer());\n+    des._readHostObject = common.mustCall(() => {\n+      assert.strictEqual(writeHostObjectCalled, true);\n+      const length = des.readUint32();\n+      const buf = des.readRawBytes(length);\n+      assert.strictEqual(buf.toString(), text);\n+\n+      return hostObject;\n+    });\n+\n+    des.readHeader();\n+\n+    assert.strictEqual(des.readValue().val, hostObject);\n+  }\n+\n+  arrayBufferViews.forEach((buf) => {\n+    testWriteRawBytes(buf);\n+  });\n+}\n+\n {\n   const ser = new v8.DefaultSerializer();\n   ser._writeHostObject = common.mustCall((object) => {\n@@ -146,3 +187,46 @@ const deserializerTypeError =\n   assert.throws(v8.Serializer, serializerTypeError);\n   assert.throws(v8.Deserializer, deserializerTypeError);\n }\n+\n+\n+// `v8.deserialize()` and `new v8.Deserializer()` should support both\n+// `TypedArray` and `DataView`.\n+{\n+  for (const obj of objects) {\n+    const buf = v8.serialize(obj);\n+\n+    for (const arrayBufferView of common.getArrayBufferViews(buf)) {\n+      assert.deepStrictEqual(v8.deserialize(arrayBufferView), obj);\n+    }\n+\n+    for (const arrayBufferView of common.getArrayBufferViews(buf)) {\n+      const deserializer = new v8.DefaultDeserializer(arrayBufferView);\n+      deserializer.readHeader();\n+      const value = deserializer.readValue();\n+      assert.deepStrictEqual(value, obj);\n+\n+      const serializer = new v8.DefaultSerializer();\n+      serializer.writeHeader();\n+      serializer.writeValue(value);\n+      assert.deepStrictEqual(buf, serializer.releaseBuffer());\n+    }\n+  }\n+}\n+\n+{\n+  const INVALID_SOURCE = 'INVALID_SOURCE_TYPE';\n+  const serializer = new v8.Serializer();\n+  serializer.writeHeader();\n+  assert.throws(\n+    () => serializer.writeRawBytes(INVALID_SOURCE),\n+    /^TypeError: source must be a TypedArray or a DataView$/,\n+  );\n+  assert.throws(\n+    () => v8.deserialize(INVALID_SOURCE),\n+    /^TypeError: buffer must be a TypedArray or a DataView$/,\n+  );\n+  assert.throws(\n+    () => new v8.Deserializer(INVALID_SOURCE),\n+    /^TypeError: buffer must be a TypedArray or a DataView$/,\n+  );\n+}"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 91,
        "deletions": 7
    }
}