{
    "author": "unknown",
    "message": "src: cover extra load-via-special-symbol scenario\n\nWe need to look for a special symbol even if the module self-registers\nwhen the module self-registers with the wrong version.\n\nPR-URL: https://github.com/nodejs/node/pull/20186\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "c1078c4a3bf1a1b2e83d4ca5965b8f9fba26b166",
    "files": [
        {
            "sha": "90defba40ba95e0a51c03424095444d8173954ca",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/c1078c4a3bf1a1b2e83d4ca5965b8f9fba26b166/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c1078c4a3bf1a1b2e83d4ca5965b8f9fba26b166/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=c1078c4a3bf1a1b2e83d4ca5965b8f9fba26b166",
            "patch": "@@ -2292,6 +2292,13 @@ static void DLOpen(const FunctionCallbackInfo<Value>& args) {\n \n   // -1 is used for N-API modules\n   if ((mp->nm_version != -1) && (mp->nm_version != NODE_MODULE_VERSION)) {\n+    // Even if the module did self-register, it may have done so with the wrong\n+    // version. We must only give up after having checked to see if it has an\n+    // appropriate initializer callback.\n+    if (auto callback = GetInitializerCallback(&dlib)) {\n+      callback(exports, module, context);\n+      return;\n+    }\n     char errmsg[1024];\n     snprintf(errmsg,\n              sizeof(errmsg),"
        },
        {
            "sha": "e267a3b2a7629af7041f604066be24a22a84e460",
            "filename": "test/addons/hello-world/binding.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/c1078c4a3bf1a1b2e83d4ca5965b8f9fba26b166/test%2Faddons%2Fhello-world%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c1078c4a3bf1a1b2e83d4ca5965b8f9fba26b166/test%2Faddons%2Fhello-world%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fhello-world%2Fbinding.cc?ref=c1078c4a3bf1a1b2e83d4ca5965b8f9fba26b166",
            "patch": "@@ -15,3 +15,20 @@ extern \"C\" NODE_MODULE_EXPORT void INITIALIZER(v8::Local<v8::Object> exports,\n                                                v8::Local<v8::Context> context) {\n   NODE_SET_METHOD(exports, \"hello\", Method);\n }\n+\n+static void FakeInit(v8::Local<v8::Object> exports,\n+                     v8::Local<v8::Value> module,\n+                     v8::Local<v8::Context> context) {\n+  auto isolate = context->GetIsolate();\n+  auto exception = v8::Exception::Error(v8::String::NewFromUtf8(isolate,\n+      \"FakeInit should never run!\", v8::NewStringType::kNormal)\n+          .ToLocalChecked());\n+  isolate->ThrowException(exception);\n+}\n+\n+// Define a Node.js module, but with the wrong version. Node.js should still be\n+// able to load this module, multiple times even, because it exposes the\n+// specially named initializer above.\n+#undef NODE_MODULE_VERSION\n+#define NODE_MODULE_VERSION 3\n+NODE_MODULE(NODE_GYP_MODULE_NAME, FakeInit)"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 24,
        "deletions": 0
    }
}