{
    "author": "sam-github",
    "message": "tls: add min/max protocol version options\n\nThe existing secureProtocol option only allows setting the allowed\nprotocol to a specific version, or setting it to \"all supported\nversions\". It also used obscure strings based on OpenSSL C API\nfunctions. Directly setting the min or max is easier to use and explain.\n\nPR-URL: https://github.com/nodejs/node/pull/24405\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Rod Vagg <rod@vagg.org>",
    "sha": "f512f5ea138fe86e47c0179d5733044daf6f4fe6",
    "files": [
        {
            "sha": "96ff284c0a4054a59514b73b8ed38953a039909a",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -1655,6 +1655,17 @@ recommended to use 2048 bits or larger for stronger security.\n A TLS/SSL handshake timed out. In this case, the server must also abort the\n connection.\n \n+<a id=\"ERR_TLS_INVALID_PROTOCOL_VERSION\"></a>\n+### ERR_TLS_INVALID_PROTOCOL_VERSION\n+\n+Valid TLS protocol versions are `'TLSv1'`, `'TLSv1.1'`, or `'TLSv1.2'`.\n+\n+<a id=\"ERR_TLS_PROTOCOL_VERSION_CONFLICT\"></a>\n+### ERR_TLS_PROTOCOL_VERSION_CONFLICT\n+\n+Attempting to set a TLS protocol `minVersion` or `maxVersion` conflicts with an\n+attempt to set the `secureProtocol` explicitly. Use one mechanism or the other.\n+\n <a id=\"ERR_TLS_RENEGOTIATE\"></a>\n ### ERR_TLS_RENEGOTIATE\n "
        },
        {
            "sha": "45d7fbfa2baa9f1f8cd36e65fc46a133f6268541",
            "filename": "doc/api/tls.md",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/doc%2Fapi%2Ftls.md",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/doc%2Fapi%2Ftls.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftls.md?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -1070,6 +1070,10 @@ changes:\n     pr-url: https://github.com/nodejs/node/pull/4099\n     description: The `ca` option can now be a single string containing multiple\n                  CA certificates.\n+  - version: REPLACEME\n+    pr-url: REPLACEME\n+    description: The `minVersion` and `maxVersion` can be used to restrict\n+                 the allowed TLS protocol versions.\n -->\n \n * `options` {Object}\n@@ -1130,6 +1134,16 @@ changes:\n     passphrase: <string>]}`. The object form can only occur in an array.\n     `object.passphrase` is optional. Encrypted keys will be decrypted with\n     `object.passphrase` if provided, or `options.passphrase` if it is not.\n+  * `maxVersion` {string} Optionally set the maximum TLS version to allow. One\n+    of `TLSv1.2'`, `'TLSv1.1'`, or `'TLSv1'`. Cannot be specified along with the\n+    `secureProtocol` option, use one or the other.  **Default:** `'TLSv1.2'`.\n+  * `minVersion` {string} Optionally set the minimum TLS version to allow. One\n+    of `TLSv1.2'`, `'TLSv1.1'`, or `'TLSv1'`. Cannot be specified along with the\n+    `secureProtocol` option, use one or the other.  It is not recommended to use\n+    less than TLSv1.2, but it may be required for interoperability.\n+    **Default:** `'TLSv1.2'`, unless changed using CLI options. Using\n+    `--tls-v1.0` changes the default to `'TLSv1'`. Using `--tls-v1.1` changes\n+    the default to `'TLSv1.1'`.\n   * `passphrase` {string} Shared passphrase used for a single private key and/or\n     a PFX.\n   * `pfx` {string|string[]|Buffer|Buffer[]|Object[]} PFX or PKCS12 encoded\n@@ -1150,10 +1164,7 @@ changes:\n     example, use `'TLSv1_1_method'` to force TLS version 1.1, or `'TLS_method'`\n     to allow any TLS protocol version. It is not recommended to use TLS versions\n     less than 1.2, but it may be required for interoperability.  **Default:**\n-    `'TLSv1_2_method'`, unless changed using CLI options. Using the `--tlsv1.0`\n-    CLI option is like `'TLS_method'` except protocols earlier than TLSv1.0 are\n-    not allowed, and using the `--tlsv1.1` CLI option is like `'TLS_method'`\n-    except that protocols earlier than TLSv1.1 are not allowed.\n+    none, see `minVersion`.\n   * `sessionIdContext` {string} Opaque identifier used by servers to ensure\n     session state is not shared between applications. Unused by clients.\n "
        },
        {
            "sha": "7ddb0d4757eb80e21c5cc5674be01460102f9d0a",
            "filename": "lib/_tls_common.js",
            "status": "modified",
            "additions": 32,
            "deletions": 7,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/lib%2F_tls_common.js",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/lib%2F_tls_common.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_tls_common.js?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -26,22 +26,46 @@ const { isArrayBufferView } = require('internal/util/types');\n const tls = require('tls');\n const {\n   ERR_CRYPTO_CUSTOM_ENGINE_NOT_SUPPORTED,\n-  ERR_INVALID_ARG_TYPE\n+  ERR_INVALID_ARG_TYPE,\n+  ERR_TLS_INVALID_PROTOCOL_VERSION,\n+  ERR_TLS_PROTOCOL_VERSION_CONFLICT,\n } = require('internal/errors').codes;\n-\n-const { SSL_OP_CIPHER_SERVER_PREFERENCE } = internalBinding('constants').crypto;\n+const {\n+  SSL_OP_CIPHER_SERVER_PREFERENCE,\n+  TLS1_VERSION,\n+  TLS1_1_VERSION,\n+  TLS1_2_VERSION,\n+} = internalBinding('constants').crypto;\n \n // Lazily loaded from internal/crypto/util.\n let toBuf = null;\n \n+function toV(which, v, def) {\n+  if (v == null) v = def;\n+  if (v === 'TLSv1') return TLS1_VERSION;\n+  if (v === 'TLSv1.1') return TLS1_1_VERSION;\n+  if (v === 'TLSv1.2') return TLS1_2_VERSION;\n+  throw new ERR_TLS_INVALID_PROTOCOL_VERSION(v, which);\n+}\n+\n const { SecureContext: NativeSecureContext } = internalBinding('crypto');\n-function SecureContext(secureProtocol, secureOptions) {\n+function SecureContext(secureProtocol, secureOptions, minVersion, maxVersion) {\n   if (!(this instanceof SecureContext)) {\n-    return new SecureContext(secureProtocol, secureOptions);\n+    return new SecureContext(secureProtocol, secureOptions, minVersion,\n+                             maxVersion);\n+  }\n+\n+  if (secureProtocol) {\n+    if (minVersion != null)\n+      throw new ERR_TLS_PROTOCOL_VERSION_CONFLICT(minVersion, secureProtocol);\n+    if (maxVersion != null)\n+      throw new ERR_TLS_PROTOCOL_VERSION_CONFLICT(maxVersion, secureProtocol);\n   }\n \n   this.context = new NativeSecureContext();\n-  this.context.init(secureProtocol);\n+  this.context.init(secureProtocol,\n+                    toV('minimum', minVersion, tls.DEFAULT_MIN_VERSION),\n+                    toV('maximum', maxVersion, tls.DEFAULT_MAX_VERSION));\n \n   if (secureOptions) this.context.setOptions(secureOptions);\n }\n@@ -66,7 +90,8 @@ exports.createSecureContext = function createSecureContext(options) {\n   if (options.honorCipherOrder)\n     secureOptions |= SSL_OP_CIPHER_SERVER_PREFERENCE;\n \n-  const c = new SecureContext(options.secureProtocol, secureOptions);\n+  const c = new SecureContext(options.secureProtocol, secureOptions,\n+                              options.minVersion, options.maxVersion);\n   var i;\n   var val;\n "
        },
        {
            "sha": "1d6ccbb8a9cbafa8364683c9a99834297a6ed5e5",
            "filename": "lib/_tls_wrap.js",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/lib%2F_tls_wrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/lib%2F_tls_wrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_tls_wrap.js?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -918,6 +918,16 @@ Server.prototype.setSecureContext = function(options) {\n   else\n     this.ca = undefined;\n \n+  if (options.minVersion)\n+    this.minVersion = options.minVersion;\n+  else\n+    this.minVersion = undefined;\n+\n+  if (options.maxVersion)\n+    this.maxVersion = options.maxVersion;\n+  else\n+    this.maxVersion = undefined;\n+\n   if (options.secureProtocol)\n     this.secureProtocol = options.secureProtocol;\n   else\n@@ -974,6 +984,8 @@ Server.prototype.setSecureContext = function(options) {\n     ciphers: this.ciphers,\n     ecdhCurve: this.ecdhCurve,\n     dhparam: this.dhparam,\n+    minVersion: this.minVersion,\n+    maxVersion: this.maxVersion,\n     secureProtocol: this.secureProtocol,\n     secureOptions: this.secureOptions,\n     honorCipherOrder: this.honorCipherOrder,\n@@ -1026,6 +1038,8 @@ Server.prototype.setOptions = util.deprecate(function(options) {\n   if (options.clientCertEngine)\n     this.clientCertEngine = options.clientCertEngine;\n   if (options.ca) this.ca = options.ca;\n+  if (options.minVersion) this.minVersion = options.minVersion;\n+  if (options.maxVersion) this.maxVersion = options.maxVersion;\n   if (options.secureProtocol) this.secureProtocol = options.secureProtocol;\n   if (options.crl) this.crl = options.crl;\n   if (options.ciphers) this.ciphers = options.ciphers;"
        },
        {
            "sha": "66e76c1f050935b7bab54b9a44ec655a6f9c1411",
            "filename": "lib/https.js",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/lib%2Fhttps.js",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/lib%2Fhttps.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fhttps.js?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -186,6 +186,14 @@ Agent.prototype.getName = function getName(options) {\n   if (options.servername && options.servername !== options.host)\n     name += options.servername;\n \n+  name += ':';\n+  if (options.minVersion)\n+    name += options.minVersion;\n+\n+  name += ':';\n+  if (options.maxVersion)\n+    name += options.maxVersion;\n+\n   name += ':';\n   if (options.secureProtocol)\n     name += options.secureProtocol;"
        },
        {
            "sha": "0ed23a943805a82ea01d6363641f314f672476a5",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -861,6 +861,10 @@ E('ERR_TLS_CERT_ALTNAME_INVALID',\n   'Hostname/IP does not match certificate\\'s altnames: %s', Error);\n E('ERR_TLS_DH_PARAM_SIZE', 'DH parameter size %s is less than 2048', Error);\n E('ERR_TLS_HANDSHAKE_TIMEOUT', 'TLS handshake timeout', Error);\n+E('ERR_TLS_INVALID_PROTOCOL_VERSION',\n+  '%j is not a valid %s TLS protocol version', TypeError);\n+E('ERR_TLS_PROTOCOL_VERSION_CONFLICT',\n+  'TLS protocol version %j conflicts with secureProtocol %j', TypeError);\n E('ERR_TLS_RENEGOTIATE', 'Attempt to renegotiate TLS session failed', Error);\n E('ERR_TLS_RENEGOTIATION_DISABLED',\n   'TLS session renegotiation disabled for this socket', Error);"
        },
        {
            "sha": "898e204c539de8e8308d01ef274037892c8f2c2c",
            "filename": "lib/tls.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/lib%2Ftls.js",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/lib%2Ftls.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftls.js?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -31,6 +31,7 @@ internalUtil.assertCrypto();\n const { isArrayBufferView } = require('internal/util/types');\n \n const net = require('net');\n+const { getOptionValue } = require('internal/options');\n const url = require('url');\n const binding = internalBinding('crypto');\n const { Buffer } = require('buffer');\n@@ -53,6 +54,15 @@ exports.DEFAULT_CIPHERS =\n \n exports.DEFAULT_ECDH_CURVE = 'auto';\n \n+exports.DEFAULT_MAX_VERSION = 'TLSv1.2';\n+\n+if (getOptionValue('--tls-v1.0'))\n+  exports.DEFAULT_MIN_VERSION = 'TLSv1';\n+else if (getOptionValue('--tls-v1.1'))\n+  exports.DEFAULT_MIN_VERSION = 'TLSv1.1';\n+else\n+  exports.DEFAULT_MIN_VERSION = 'TLSv1.2';\n+\n exports.getCiphers = internalUtil.cachedResult(\n   () => internalUtil.filterDuplicateStrings(binding.getSSLCiphers(), true)\n );"
        },
        {
            "sha": "7530d6d0a347801122417a5f4b3bf2a75f481b7a",
            "filename": "src/node_constants.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/src%2Fnode_constants.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/src%2Fnode_constants.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_constants.cc?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -1237,6 +1237,10 @@ void DefineCryptoConstants(Local<Object> target) {\n   NODE_DEFINE_STRING_CONSTANT(target,\n                               \"defaultCipherList\",\n                               per_process_opts->tls_cipher_list.c_str());\n+\n+  NODE_DEFINE_CONSTANT(target, TLS1_VERSION);\n+  NODE_DEFINE_CONSTANT(target, TLS1_1_VERSION);\n+  NODE_DEFINE_CONSTANT(target, TLS1_2_VERSION);\n #endif\n   NODE_DEFINE_CONSTANT(target, INT_MAX);\n }"
        },
        {
            "sha": "16d1951ff72eaa289ec6c0f38685e66aa594a536",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -405,14 +405,15 @@ void SecureContext::Init(const FunctionCallbackInfo<Value>& args) {\n   ASSIGN_OR_RETURN_UNWRAP(&sc, args.Holder());\n   Environment* env = sc->env();\n \n-  int min_version = TLS1_2_VERSION;\n-  int max_version = 0;\n-  const SSL_METHOD* method = TLS_method();\n+  CHECK_EQ(args.Length(), 3);\n+  CHECK(args[1]->IsInt32());\n+  CHECK(args[2]->IsInt32());\n \n-  if (env->options()->tls_v1_1) min_version = TLS1_1_VERSION;\n-  if (env->options()->tls_v1_0) min_version = TLS1_VERSION;\n+  int min_version = args[1].As<Int32>()->Value();\n+  int max_version = args[2].As<Int32>()->Value();\n+  const SSL_METHOD* method = TLS_method();\n \n-  if (args.Length() == 1 && args[0]->IsString()) {\n+  if (args[0]->IsString()) {\n     const node::Utf8Value sslmethod(env->isolate(), args[0]);\n \n     // Note that SSLv2 and SSLv3 are disallowed but SSLv23_method and friends\n@@ -509,6 +510,7 @@ void SecureContext::Init(const FunctionCallbackInfo<Value>& args) {\n \n   SSL_CTX_set_min_proto_version(sc->ctx_.get(), min_version);\n   SSL_CTX_set_max_proto_version(sc->ctx_.get(), max_version);\n+\n   // OpenSSL 1.1.0 changed the ticket key size, but the OpenSSL 1.0.x size was\n   // exposed in the public API. To retain compatibility, install a callback\n   // which restores the old algorithm."
        },
        {
            "sha": "303061adc3223e8793c93a266110e49e7a740700",
            "filename": "test/fixtures/tls-connect.js",
            "status": "modified",
            "additions": 43,
            "deletions": 26,
            "changes": 69,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/test%2Ffixtures%2Ftls-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/test%2Ffixtures%2Ftls-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Ftls-connect.js?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -46,28 +46,45 @@ exports.connect = function connect(options, callback) {\n   const client = {};\n   const pair = { server, client };\n \n-  tls.createServer(options.server, function(conn) {\n-    server.conn = conn;\n-    conn.pipe(conn);\n-    maybeCallback()\n-  }).listen(0, function() {\n-    server.server = this;\n+  try {\n+    tls.createServer(options.server, function(conn) {\n+      server.conn = conn;\n+      conn.pipe(conn);\n+      maybeCallback()\n+    }).listen(0, function() {\n+      server.server = this;\n \n-    const optClient = util._extend({\n-      port: this.address().port,\n-    }, options.client);\n+      const optClient = util._extend({\n+        port: this.address().port,\n+      }, options.client);\n \n-    tls.connect(optClient)\n-      .on('secureConnect', function() {\n-        client.conn = this;\n-        maybeCallback();\n-      })\n-      .on('error', function(err) {\n+      try {\n+        tls.connect(optClient)\n+          .on('secureConnect', function() {\n+            client.conn = this;\n+            maybeCallback();\n+          })\n+          .on('error', function(err) {\n+            client.err = err;\n+            client.conn = this;\n+            maybeCallback();\n+          });\n+      } catch (err) {\n         client.err = err;\n-        client.conn = this;\n-        maybeCallback();\n-      });\n-  });\n+        // The server won't get a connection, we are done.\n+        callback(err, pair, cleanup);\n+        callback = null;\n+      }\n+    }).on('tlsClientError', function(err, sock) {\n+      server.conn = sock;\n+      server.err = err;\n+      maybeCallback();\n+    });\n+  } catch (err) {\n+    // Invalid options can throw, report the error.\n+    pair.server.err = err;\n+    callback(err, pair, () => {});\n+  }\n \n   function maybeCallback() {\n     if (!callback)\n@@ -76,13 +93,13 @@ exports.connect = function connect(options, callback) {\n       const err = pair.client.err || pair.server.err;\n       callback(err, pair, cleanup);\n       callback = null;\n-\n-      function cleanup() {\n-        if (server.server)\n-          server.server.close();\n-        if (client.conn)\n-          client.conn.end();\n-      }\n     }\n   }\n+\n+  function cleanup() {\n+    if (server.server)\n+      server.server.close();\n+    if (client.conn)\n+      client.conn.end();\n+  }\n }"
        },
        {
            "sha": "5c95da549b20b55ac0b30540228a67cbbf6a2deb",
            "filename": "test/parallel/test-https-agent-getname.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/test%2Fparallel%2Ftest-https-agent-getname.js",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/test%2Fparallel%2Ftest-https-agent-getname.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-https-agent-getname.js?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -12,7 +12,7 @@ const agent = new https.Agent();\n // empty options\n assert.strictEqual(\n   agent.getName({}),\n-  'localhost:::::::::::::::::'\n+  'localhost:::::::::::::::::::'\n );\n \n // pass all options arguments\n@@ -40,5 +40,5 @@ const options = {\n assert.strictEqual(\n   agent.getName(options),\n   '0.0.0.0:443:192.168.1.1:ca:cert:dynamic:ciphers:key:pfx:false:localhost:' +\n-    'secureProtocol:c,r,l:false:ecdhCurve:dhparam:0:sessionIdContext'\n+    '::secureProtocol:c,r,l:false:ecdhCurve:dhparam:0:sessionIdContext'\n );"
        },
        {
            "sha": "f2f39ce60f662491a8080ab708d3298dd1cf5dc4",
            "filename": "test/parallel/test-tls-cli-min-version-1.0.js",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/test%2Fparallel%2Ftest-tls-cli-min-version-1.0.js",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/test%2Fparallel%2Ftest-tls-cli-min-version-1.0.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-cli-min-version-1.0.js?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -0,0 +1,15 @@\n+// Flags: --tls-v1.0 --tls-v1.1\n+'use strict';\n+const common = require('../common');\n+if (!common.hasCrypto) common.skip('missing crypto');\n+\n+// Check that `node --tls-v1.0` is supported, and overrides --tls-v1.1.\n+\n+const assert = require('assert');\n+const tls = require('tls');\n+\n+assert.strictEqual(tls.DEFAULT_MAX_VERSION, 'TLSv1.2');\n+assert.strictEqual(tls.DEFAULT_MIN_VERSION, 'TLSv1');\n+\n+// Check the min-max version protocol versions against these CLI settings.\n+require('./test-tls-min-max-version.js');"
        },
        {
            "sha": "404ee98ff326d92287b8ef63ce5606fb0ba0e119",
            "filename": "test/parallel/test-tls-cli-min-version-1.1.js",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/test%2Fparallel%2Ftest-tls-cli-min-version-1.1.js",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/test%2Fparallel%2Ftest-tls-cli-min-version-1.1.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-cli-min-version-1.1.js?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -0,0 +1,15 @@\n+// Flags: --tls-v1.1\n+'use strict';\n+const common = require('../common');\n+if (!common.hasCrypto) common.skip('missing crypto');\n+\n+// Check that node `--tls-v1.1` is supported.\n+\n+const assert = require('assert');\n+const tls = require('tls');\n+\n+assert.strictEqual(tls.DEFAULT_MAX_VERSION, 'TLSv1.2');\n+assert.strictEqual(tls.DEFAULT_MIN_VERSION, 'TLSv1.1');\n+\n+// Check the min-max version protocol versions against these CLI settings.\n+require('./test-tls-min-max-version.js');"
        },
        {
            "sha": "3a3dab33d566c6b0852276a7736cf1d707fda6a9",
            "filename": "test/parallel/test-tls-min-max-version.js",
            "status": "added",
            "additions": 146,
            "deletions": 0,
            "changes": 146,
            "blob_url": "https://github.com/nodejs/node/blob/f512f5ea138fe86e47c0179d5733044daf6f4fe6/test%2Fparallel%2Ftest-tls-min-max-version.js",
            "raw_url": "https://github.com/nodejs/node/raw/f512f5ea138fe86e47c0179d5733044daf6f4fe6/test%2Fparallel%2Ftest-tls-min-max-version.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-min-max-version.js?ref=f512f5ea138fe86e47c0179d5733044daf6f4fe6",
            "patch": "@@ -0,0 +1,146 @@\n+'use strict';\n+const common = require('../common');\n+const fixtures = require('../common/fixtures');\n+\n+// Check min/max protocol versions.\n+\n+const {\n+  assert, connect, keys, tls\n+} = require(fixtures.path('tls-connect'));\n+const DEFAULT_MIN_VERSION = tls.DEFAULT_MIN_VERSION;\n+\n+function test(cmin, cmax, cprot, smin, smax, sprot, expect) {\n+  connect({\n+    client: {\n+      checkServerIdentity: (servername, cert) => { },\n+      ca: `${keys.agent1.cert}\\n${keys.agent6.ca}`,\n+      minVersion: cmin,\n+      maxVersion: cmax,\n+      secureProtocol: cprot,\n+    },\n+    server: {\n+      cert: keys.agent6.cert,\n+      key: keys.agent6.key,\n+      minVersion: smin,\n+      maxVersion: smax,\n+      secureProtocol: sprot,\n+    },\n+  }, common.mustCall((err, pair, cleanup) => {\n+    if (expect && !expect.match(/^TLS/)) {\n+      assert(err.message.match(expect));\n+      return cleanup();\n+    }\n+\n+    if (expect) {\n+      assert.ifError(pair.server.err);\n+      assert.ifError(pair.client.err);\n+      assert(pair.server.conn);\n+      assert(pair.client.conn);\n+      assert.strictEqual(pair.client.conn.getProtocol(), expect);\n+      assert.strictEqual(pair.server.conn.getProtocol(), expect);\n+      return cleanup();\n+    }\n+\n+    assert(pair.server.err);\n+    assert(pair.client.err);\n+    return cleanup();\n+  }));\n+}\n+\n+const U = undefined;\n+\n+// Default protocol is TLSv1.2.\n+test(U, U, U, U, U, U, 'TLSv1.2');\n+\n+// Insecure or invalid protocols cannot be enabled.\n+test(U, U, U, U, U, 'SSLv2_method', 'SSLv2 methods disabled');\n+test(U, U, U, U, U, 'SSLv3_method', 'SSLv3 methods disabled');\n+test(U, U, 'SSLv2_method', U, U, U, 'SSLv2 methods disabled');\n+test(U, U, 'SSLv3_method', U, U, U, 'SSLv3 methods disabled');\n+test(U, U, 'hokey-pokey', U, U, U, 'Unknown method');\n+test(U, U, U, U, U, 'hokey-pokey', 'Unknown method');\n+\n+// Cannot use secureProtocol and min/max versions simultaneously.\n+test(U, U, U, U, 'TLSv1.2', 'TLS1_2_method', 'conflicts with secureProtocol');\n+test(U, U, U, 'TLSv1.2', U, 'TLS1_2_method', 'conflicts with secureProtocol');\n+test(U, 'TLSv1.2', 'TLS1_2_method', U, U, U, 'conflicts with secureProtocol');\n+test('TLSv1.2', U, 'TLS1_2_method', U, U, U, 'conflicts with secureProtocol');\n+\n+// TLS_method means \"any supported protocol\".\n+test(U, U, 'TLSv1_2_method', U, U, 'TLS_method', 'TLSv1.2');\n+test(U, U, 'TLSv1_1_method', U, U, 'TLS_method', 'TLSv1.1');\n+test(U, U, 'TLSv1_method', U, U, 'TLS_method', 'TLSv1');\n+test(U, U, 'TLS_method', U, U, 'TLSv1_2_method', 'TLSv1.2');\n+test(U, U, 'TLS_method', U, U, 'TLSv1_1_method', 'TLSv1.1');\n+test(U, U, 'TLS_method', U, U, 'TLSv1_method', 'TLSv1');\n+\n+// SSLv23 also means \"any supported protocol\" greater than the default\n+// minimum (which is configurable via command line).\n+test(U, U, 'TLSv1_2_method', U, U, 'SSLv23_method', 'TLSv1.2');\n+\n+if (DEFAULT_MIN_VERSION === 'TLSv1.2') {\n+  test(U, U, 'TLSv1_1_method', U, U, 'SSLv23_method', null);\n+  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method', null);\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_1_method', null);\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method', null);\n+}\n+\n+if (DEFAULT_MIN_VERSION === 'TLSv1.1') {\n+  test(U, U, 'TLSv1_1_method', U, U, 'SSLv23_method', 'TLSv1.1');\n+  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method', null);\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_1_method', 'TLSv1.1');\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method', null);\n+}\n+\n+if (DEFAULT_MIN_VERSION === 'TLSv1') {\n+  test(U, U, 'TLSv1_1_method', U, U, 'SSLv23_method', 'TLSv1.1');\n+  test(U, U, 'TLSv1_method', U, U, 'SSLv23_method', 'TLSv1');\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_1_method', 'TLSv1.1');\n+  test(U, U, 'SSLv23_method', U, U, 'TLSv1_method', 'TLSv1');\n+}\n+\n+// TLSv1 thru TLSv1.2 are only supported with explicit configuration with API or\n+// CLI (--tls-v1.0 and --tls-v1.1).\n+test(U, U, 'TLSv1_2_method', U, U, 'TLSv1_2_method', 'TLSv1.2');\n+test(U, U, 'TLSv1_1_method', U, U, 'TLSv1_1_method', 'TLSv1.1');\n+test(U, U, 'TLSv1_method', U, U, 'TLSv1_method', 'TLSv1');\n+\n+// The default default.\n+if (DEFAULT_MIN_VERSION === 'TLSv1.2') {\n+  test(U, U, 'TLSv1_1_method', U, U, U, null);\n+  test(U, U, 'TLSv1_method', U, U, U, null);\n+  test(U, U, U, U, U, 'TLSv1_1_method', null);\n+  test(U, U, U, U, U, 'TLSv1_method', null);\n+}\n+\n+// The default with --tls-v1.1.\n+if (DEFAULT_MIN_VERSION === 'TLSv1.1') {\n+  test(U, U, 'TLSv1_1_method', U, U, U, 'TLSv1.1');\n+  test(U, U, 'TLSv1_method', U, U, U, null);\n+  test(U, U, U, U, U, 'TLSv1_1_method', 'TLSv1.1');\n+  test(U, U, U, U, U, 'TLSv1_method', null);\n+}\n+\n+// The default with --tls-v1.0.\n+if (DEFAULT_MIN_VERSION === 'TLSv1') {\n+  test(U, U, 'TLSv1_1_method', U, U, U, 'TLSv1.1');\n+  test(U, U, 'TLSv1_method', U, U, U, 'TLSv1');\n+  test(U, U, U, U, U, 'TLSv1_1_method', 'TLSv1.1');\n+  test(U, U, U, U, U, 'TLSv1_method', 'TLSv1');\n+}\n+\n+// TLS min/max are respected when set with no secureProtocol.\n+test('TLSv1', 'TLSv1.2', U, U, U, 'TLSv1_method', 'TLSv1');\n+test('TLSv1', 'TLSv1.2', U, U, U, 'TLSv1_1_method', 'TLSv1.1');\n+test('TLSv1', 'TLSv1.2', U, U, U, 'TLSv1_2_method', 'TLSv1.2');\n+\n+test(U, U, 'TLSv1_method', 'TLSv1', 'TLSv1.2', U, 'TLSv1');\n+test(U, U, 'TLSv1_1_method', 'TLSv1', 'TLSv1.2', U, 'TLSv1.1');\n+test(U, U, 'TLSv1_2_method', 'TLSv1', 'TLSv1.2', U, 'TLSv1.2');\n+\n+test('TLSv1', 'TLSv1.1', U, 'TLSv1', 'TLSv1.2', U, 'TLSv1.1');\n+test('TLSv1', 'TLSv1.2', U, 'TLSv1', 'TLSv1.1', U, 'TLSv1.1');\n+test('TLSv1', 'TLSv1', U, 'TLSv1', 'TLSv1.1', U, 'TLSv1');\n+test('TLSv1', 'TLSv1.2', U, 'TLSv1', 'TLSv1', U, 'TLSv1');\n+test('TLSv1.1', 'TLSv1.1', U, 'TLSv1', 'TLSv1.2', U, 'TLSv1.1');\n+test('TLSv1', 'TLSv1.2', U, 'TLSv1.1', 'TLSv1.1', U, 'TLSv1.1');"
        }
    ],
    "stats": {
        "total": 372,
        "additions": 327,
        "deletions": 45
    }
}