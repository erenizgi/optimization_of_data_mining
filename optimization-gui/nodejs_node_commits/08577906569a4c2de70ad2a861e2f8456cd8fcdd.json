{
    "author": "mcollina",
    "message": "stream: prevent 'end' to be emitted after 'error'\n\nThis PR adds _readableState.errorEmitted and add the tracking of it.\n\nFixes: https://github.com/nodejs/node/issues/6083\n\nPR-URL: https://github.com/nodejs/node/pull/20104\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "08577906569a4c2de70ad2a861e2f8456cd8fcdd",
    "files": [
        {
            "sha": "31a8a11e4a067370bfab61463f2f5f350abe50bc",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -99,6 +99,9 @@ function ReadableState(options, stream, isDuplex) {\n   this.endEmitted = false;\n   this.reading = false;\n \n+  // Flipped if an 'error' is emitted.\n+  this.errorEmitted = false;\n+\n   // a flag to be able to tell if the event 'readable'/'data' is emitted\n   // immediately, or on a later tick.  We set this to true at first, because\n   // any actions that shouldn't happen until \"later\" should generally also\n@@ -1069,20 +1072,23 @@ function fromList(n, state) {\n function endReadable(stream) {\n   var state = stream._readableState;\n \n-  debug('endReadable', state.endEmitted);\n-  if (!state.endEmitted) {\n+  debug('endReadable', state.endEmitted, state.errorEmitted);\n+  if (!state.endEmitted && !state.errorEmitted) {\n     state.ended = true;\n     process.nextTick(endReadableNT, state, stream);\n   }\n }\n \n function endReadableNT(state, stream) {\n-  debug('endReadableNT', state.endEmitted, state.length);\n+  debug('endReadableNT', state.endEmitted, state.length, state.errorEmitted);\n \n   // Check that we didn't get one last unshift.\n   if (!state.endEmitted && state.length === 0) {\n-    state.endEmitted = true;\n     stream.readable = false;\n-    stream.emit('end');\n+\n+    if (!state.errorEmitted) {\n+      state.endEmitted = true;\n+      stream.emit('end');\n+    }\n   }\n }"
        },
        {
            "sha": "0891f85526f132bbd7f8e291171d4d0405c515fa",
            "filename": "lib/_stream_writable.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/lib%2F_stream_writable.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/lib%2F_stream_writable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_writable.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -424,12 +424,22 @@ function onwriteError(stream, state, sync, er, cb) {\n     // this can emit finish, and it will always happen\n     // after error\n     process.nextTick(finishMaybe, stream, state);\n+\n+    // needed for duplex, fixes https://github.com/nodejs/node/issues/6083\n+    if (stream._readableState) {\n+      stream._readableState.errorEmitted = true;\n+    }\n     stream._writableState.errorEmitted = true;\n     stream.emit('error', er);\n   } else {\n     // the caller expect this to happen before if\n     // it is async\n     cb(er);\n+\n+    // needed for duplex, fixes https://github.com/nodejs/node/issues/6083\n+    if (stream._readableState) {\n+      stream._readableState.errorEmitted = true;\n+    }\n     stream._writableState.errorEmitted = true;\n     stream.emit('error', er);\n     // this can emit finish, but finish must"
        },
        {
            "sha": "2ab614e1d597da0bab745e0f8d7aab1eea4096ce",
            "filename": "lib/internal/streams/destroy.js",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/lib%2Finternal%2Fstreams%2Fdestroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/lib%2Finternal%2Fstreams%2Fdestroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstreams%2Fdestroy.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -8,10 +8,14 @@ function destroy(err, cb) {\n     this._writableState.destroyed;\n \n   if (readableDestroyed || writableDestroyed) {\n+    const readableErrored = this._readableState &&\n+      this._readableState.errorEmitted;\n+    const writableErrored = this._writableState &&\n+      this._writableState.errorEmitted;\n+\n     if (cb) {\n       cb(err);\n-    } else if (err &&\n-               (!this._writableState || !this._writableState.errorEmitted)) {\n+    } else if (err && !readableErrored && !writableErrored) {\n       process.nextTick(emitErrorNT, this, err);\n     }\n     return this;\n@@ -32,6 +36,11 @@ function destroy(err, cb) {\n   this._destroy(err || null, (err) => {\n     if (!cb && err) {\n       process.nextTick(emitErrorAndCloseNT, this, err);\n+\n+      if (this._readableState) {\n+        this._readableState.errorEmitted = true;\n+      }\n+\n       if (this._writableState) {\n         this._writableState.errorEmitted = true;\n       }\n@@ -65,6 +74,7 @@ function undestroy() {\n     this._readableState.reading = false;\n     this._readableState.ended = false;\n     this._readableState.endEmitted = false;\n+    this._readableState.errorEmitted = false;\n   }\n \n   if (this._writableState) {"
        },
        {
            "sha": "09ca011c736c9601f324d47a73d20857de25c566",
            "filename": "test/parallel/test-http2-client-destroy.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-client-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-client-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-client-destroy.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -95,7 +95,6 @@ const Countdown = require('../common/countdown');\n     });\n \n     req.resume();\n-    req.on('end', common.mustCall());\n     req.on('close', common.mustCall(() => server.close()));\n   }));\n }"
        },
        {
            "sha": "f427bfb49073392893d8c9bb63c1527ca39184a7",
            "filename": "test/parallel/test-http2-client-onconnect-errors.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-client-onconnect-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-client-onconnect-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-client-onconnect-errors.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -101,7 +101,6 @@ function runTest(test) {\n     });\n   }\n \n-  req.on('end', common.mustCall());\n   req.on('close', common.mustCall(() => {\n     client.destroy();\n "
        },
        {
            "sha": "9e81015ec58d2843e0f19e5f4fb982adba346936",
            "filename": "test/parallel/test-http2-client-stream-destroy-before-connect.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-client-stream-destroy-before-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-client-stream-destroy-before-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-client-stream-destroy-before-connect.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -45,5 +45,4 @@ server.listen(0, common.mustCall(() => {\n \n   req.on('response', common.mustNotCall());\n   req.resume();\n-  req.on('end', common.mustCall());\n }));"
        },
        {
            "sha": "49822082979a01da557c79b2143a7a4bf00eaeca",
            "filename": "test/parallel/test-http2-compat-serverresponse-destroy.js",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-compat-serverresponse-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-compat-serverresponse-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-compat-serverresponse-destroy.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -63,7 +63,6 @@ server.listen(0, common.mustCall(() => {\n     req.on('close', common.mustCall(() => countdown.dec()));\n \n     req.resume();\n-    req.on('end', common.mustCall());\n   }\n \n   {\n@@ -78,6 +77,5 @@ server.listen(0, common.mustCall(() => {\n     req.on('close', common.mustCall(() => countdown.dec()));\n \n     req.resume();\n-    req.on('end', common.mustCall());\n   }\n }));"
        },
        {
            "sha": "2b576700aa4e001153d04b7846363e901bfff2e1",
            "filename": "test/parallel/test-http2-max-concurrent-streams.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-max-concurrent-streams.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-max-concurrent-streams.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-max-concurrent-streams.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -45,7 +45,6 @@ server.listen(0, common.mustCall(() => {\n     req.on('aborted', common.mustCall());\n     req.on('response', common.mustNotCall());\n     req.resume();\n-    req.on('end', common.mustCall());\n     req.on('close', common.mustCall(() => countdown.dec()));\n     req.on('error', common.expectsError({\n       code: 'ERR_HTTP2_STREAM_ERROR',"
        },
        {
            "sha": "0b7becef5f6f0a835750a3092f66cf9b04a950b7",
            "filename": "test/parallel/test-http2-misused-pseudoheaders.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-misused-pseudoheaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-misused-pseudoheaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-misused-pseudoheaders.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -41,7 +41,6 @@ server.listen(0, common.mustCall(() => {\n \n   req.on('response', common.mustCall());\n   req.resume();\n-  req.on('end', common.mustCall());\n   req.on('close', common.mustCall(() => {\n     server.close();\n     client.close();"
        },
        {
            "sha": "908f6ecd64fea13e8ba24ec64c71ac2f5f57f4e4",
            "filename": "test/parallel/test-http2-multi-content-length.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-multi-content-length.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-multi-content-length.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-multi-content-length.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -53,7 +53,6 @@ server.listen(0, common.mustCall(() => {\n     // header to be set for non-payload bearing requests...\n     const req = client.request({ 'content-length': 1 });\n     req.resume();\n-    req.on('end', common.mustCall());\n     req.on('close', common.mustCall(() => countdown.dec()));\n     req.on('error', common.expectsError({\n       code: 'ERR_HTTP2_STREAM_ERROR',"
        },
        {
            "sha": "28d1c0f057dd234b068f1d16d7e610aa0a271b91",
            "filename": "test/parallel/test-http2-respond-file-fd-invalid.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-respond-file-fd-invalid.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-respond-file-fd-invalid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-file-fd-invalid.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -40,7 +40,7 @@ server.listen(0, () => {\n   req.on('response', common.mustCall());\n   req.on('error', common.mustCall(errorCheck));\n   req.on('data', common.mustNotCall());\n-  req.on('end', common.mustCall(() => {\n+  req.on('close', common.mustCall(() => {\n     assert.strictEqual(req.rstCode, NGHTTP2_INTERNAL_ERROR);\n     client.close();\n     server.close();"
        },
        {
            "sha": "4adf678b681b094fd022fe3e562c57317f575290",
            "filename": "test/parallel/test-http2-respond-nghttperrors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-respond-nghttperrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-respond-nghttperrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-nghttperrors.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -87,7 +87,7 @@ function runTest(test) {\n   req.resume();\n   req.end();\n \n-  req.on('end', common.mustCall(() => {\n+  req.on('close', common.mustCall(() => {\n     client.close();\n \n     if (!tests.length) {"
        },
        {
            "sha": "7e7394d29305cc1d286c31db0095d8b287d06af8",
            "filename": "test/parallel/test-http2-respond-with-fd-errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-respond-with-fd-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-respond-with-fd-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-with-fd-errors.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -95,7 +95,7 @@ function runTest(test) {\n   req.resume();\n   req.end();\n \n-  req.on('end', common.mustCall(() => {\n+  req.on('close', common.mustCall(() => {\n     client.close();\n \n     if (!tests.length) {"
        },
        {
            "sha": "50b3a5572a58e69174eca5f503f53e672ddefeac",
            "filename": "test/parallel/test-http2-server-shutdown-before-respond.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-server-shutdown-before-respond.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-server-shutdown-before-respond.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-shutdown-before-respond.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -32,5 +32,5 @@ server.on('listening', common.mustCall(() => {\n   }));\n   req.resume();\n   req.on('data', common.mustNotCall());\n-  req.on('end', common.mustCall(() => server.close()));\n+  req.on('close', common.mustCall(() => server.close()));\n }));"
        },
        {
            "sha": "d631ef032b823b39600e05b93f32caa6bf166de4",
            "filename": "test/parallel/test-http2-server-socket-destroy.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-server-socket-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-http2-server-socket-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-socket-destroy.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -52,5 +52,4 @@ server.on('listening', common.mustCall(() => {\n \n   req.on('aborted', common.mustCall());\n   req.resume();\n-  req.on('end', common.mustCall());\n }));"
        },
        {
            "sha": "5a80ce5c3e49893a96554888bfe9e646f366b5cf",
            "filename": "test/parallel/test-stream-duplex-error-write.js",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-stream-duplex-error-write.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-stream-duplex-error-write.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-duplex-error-write.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -0,0 +1,24 @@\n+'use strict';\n+\n+const common = require('../common');\n+const { Duplex } = require('stream');\n+const { strictEqual } = require('assert');\n+\n+const duplex = new Duplex({\n+  write(chunk, enc, cb) {\n+    cb(new Error('kaboom'));\n+  },\n+  read() {\n+    this.push(null);\n+  }\n+});\n+\n+duplex.on('error', common.mustCall(function() {\n+  strictEqual(this._readableState.errorEmitted, true);\n+  strictEqual(this._writableState.errorEmitted, true);\n+}));\n+\n+duplex.on('end', common.mustNotCall());\n+\n+duplex.end('hello');\n+duplex.resume();"
        },
        {
            "sha": "eecee04294e6fe7b77a784ea1447c2815361758b",
            "filename": "test/parallel/test-stream-readable-destroy.js",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-stream-readable-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/08577906569a4c2de70ad2a861e2f8456cd8fcdd/test%2Fparallel%2Ftest-stream-readable-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-destroy.js?ref=08577906569a4c2de70ad2a861e2f8456cd8fcdd",
            "patch": "@@ -189,3 +189,18 @@ const { inherits } = require('util');\n   read.push('hi');\n   read.on('data', common.mustNotCall());\n }\n+\n+{\n+  // double error case\n+  const read = new Readable({\n+    read() {}\n+  });\n+\n+  read.on('close', common.mustCall());\n+  read.on('error', common.mustCall());\n+\n+  read.destroy(new Error('kaboom 1'));\n+  read.destroy(new Error('kaboom 2'));\n+  assert.strictEqual(read._readableState.errorEmitted, true);\n+  assert.strictEqual(read.destroyed, true);\n+}"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 76,
        "deletions": 20
    }
}