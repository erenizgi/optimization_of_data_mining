{
    "author": "addaleax",
    "message": "test: refactor test-tls-connect-memleak, move to parallel\n\nThis enables the test to run as part of the regular test suite.\n\nPR-URL: https://github.com/nodejs/node/pull/21794\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "9a34c5b8d57117ede5deb87c9798dbadbc030050",
    "files": [
        {
            "sha": "95f71acdc3b57b7e82e661d741838b2334f65c7f",
            "filename": "test/parallel/test-tls-connect-memleak.js",
            "status": "renamed",
            "additions": 23,
            "deletions": 23,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/9a34c5b8d57117ede5deb87c9798dbadbc030050/test%2Fparallel%2Ftest-tls-connect-memleak.js",
            "raw_url": "https://github.com/nodejs/node/raw/9a34c5b8d57117ede5deb87c9798dbadbc030050/test%2Fparallel%2Ftest-tls-connect-memleak.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-connect-memleak.js?ref=9a34c5b8d57117ede5deb87c9798dbadbc030050",
            "patch": "@@ -30,36 +30,36 @@ const assert = require('assert');\n const tls = require('tls');\n const fixtures = require('../common/fixtures');\n \n-assert.strictEqual(\n-  typeof global.gc,\n-  'function',\n-  `Type of global.gc is not a function. Type: ${typeof global.gc}.` +\n-    ' Run this test with --expose-gc'\n-);\n+// Test that the implicit listener for an 'connect' event on tls.Sockets is\n+// added using `once()`, i.e. can be gc'ed once that event has occurred.\n \n-tls.createServer({\n+const server = tls.createServer({\n   cert: fixtures.readSync('test_cert.pem'),\n   key: fixtures.readSync('test_key.pem')\n-}).listen(common.PORT);\n+}).listen(0);\n+\n+let collected = false;\n+const gcListener = { ongc() { collected = true; } };\n \n {\n-  // 2**26 == 64M entries\n-  const junk = new Array(2 ** 26).fill(0);\n+  const gcObject = {};\n+  common.onGC(gcObject, gcListener);\n \n-  const options = { rejectUnauthorized: false };\n-  tls.connect(common.PORT, '127.0.0.1', options, function() {\n-    assert.notStrictEqual(junk.length, 0);  // keep reference alive\n-    setTimeout(done, 10);\n-    global.gc();\n-  });\n+  const sock = tls.connect(\n+    server.address().port,\n+    { rejectUnauthorized: false },\n+    common.mustCall(() => {\n+      assert.strictEqual(gcObject, gcObject); // keep reference alive\n+      assert.strictEqual(collected, false);\n+      setImmediate(done, sock);\n+    }));\n }\n \n-function done() {\n-  const before = process.memoryUsage().rss;\n+function done(sock) {\n   global.gc();\n-  const after = process.memoryUsage().rss;\n-  const reclaimed = (before - after) / 1024;\n-  console.log('%d kB reclaimed', reclaimed);\n-  assert(reclaimed > 256 * 1024);  // it's more like 512M on x64\n-  process.exit();\n+  setImmediate(() => {\n+    assert.strictEqual(collected, true);\n+    sock.end();\n+    server.close();\n+  });\n }",
            "previous_filename": "test/pummel/test-tls-connect-memleak.js"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 23,
        "deletions": 23
    }
}