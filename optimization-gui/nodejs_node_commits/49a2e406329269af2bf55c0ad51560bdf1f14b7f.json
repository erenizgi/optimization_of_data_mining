{
    "author": "addaleax",
    "message": "src: move req_wrap_queue to base class of ReqWrap\n\nIntroduce a second base class for `ReqWrap` that does not\ndepend on a template parameter and move the `req_wrap_queue_`\nfield to it.\n\nThis addresses undefined behaviour that occurs when casting\nto `ReqWrap<uv_req_t>` in the `ReqWrap` constructor.\n\nRefs: https://github.com/nodejs/node/issues/26131\n\nPR-URL: https://github.com/nodejs/node/pull/26148\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "49a2e406329269af2bf55c0ad51560bdf1f14b7f",
    "files": [
        {
            "sha": "d882838ed01e14e3dbb6985f3e173aa5c0071489",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=49a2e406329269af2bf55c0ad51560bdf1f14b7f",
            "patch": "@@ -420,7 +420,7 @@ void Environment::RegisterHandleCleanups() {\n }\n \n void Environment::CleanupHandles() {\n-  for (ReqWrap<uv_req_t>* request : req_wrap_queue_)\n+  for (ReqWrapBase* request : req_wrap_queue_)\n     request->Cancel();\n \n   for (HandleWrap* handle : handle_wrap_queue_)"
        },
        {
            "sha": "56700630752fe180aae1c6174e450819c4b0ba02",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=49a2e406329269af2bf55c0ad51560bdf1f14b7f",
            "patch": "@@ -873,8 +873,7 @@ class Environment {\n #endif\n \n   typedef ListHead<HandleWrap, &HandleWrap::handle_wrap_queue_> HandleWrapQueue;\n-  typedef ListHead<ReqWrap<uv_req_t>, &ReqWrap<uv_req_t>::req_wrap_queue_>\n-          ReqWrapQueue;\n+  typedef ListHead<ReqWrapBase, &ReqWrapBase::req_wrap_queue_> ReqWrapQueue;\n \n   inline HandleWrapQueue* handle_wrap_queue() { return &handle_wrap_queue_; }\n   inline ReqWrapQueue* req_wrap_queue() { return &req_wrap_queue_; }"
        },
        {
            "sha": "05800f79b09eccf8c522eaf4d0812dab15207a8f",
            "filename": "src/node_postmortem_metadata.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Fnode_postmortem_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Fnode_postmortem_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_postmortem_metadata.cc?ref=49a2e406329269af2bf55c0ad51560bdf1f14b7f",
            "patch": "@@ -28,15 +28,14 @@\n   V(Environment_HandleWrapQueue, head_, ListNode_HandleWrap,                  \\\n     Environment::HandleWrapQueue::head_)                                      \\\n   V(ListNode_HandleWrap, next_, uintptr_t, ListNode<HandleWrap>::next_)       \\\n-  V(ReqWrap, req_wrap_queue_, ListNode_ReqWrapQueue,                          \\\n-    ReqWrap<uv_req_t>::req_wrap_queue_)                                       \\\n   V(Environment_ReqWrapQueue, head_, ListNode_ReqWrapQueue,                   \\\n     Environment::ReqWrapQueue::head_)                                         \\\n-  V(ListNode_ReqWrap, next_, uintptr_t, ListNode<ReqWrap<uv_req_t>>::next_)\n+  V(ListNode_ReqWrap, next_, uintptr_t, ListNode<ReqWrapBase>::next_)\n \n extern \"C\" {\n int nodedbg_const_ContextEmbedderIndex__kEnvironment__int;\n uintptr_t nodedbg_offset_ExternalString__data__uintptr_t;\n+uintptr_t nodedbg_offset_ReqWrap__req_wrap_queue___ListNode_ReqWrapQueue;\n \n #define V(Class, Member, Type, Accessor)                                      \\\n   NODE_EXTERN uintptr_t NODEDBG_OFFSET(Class, Member, Type);\n@@ -51,6 +50,9 @@ int GenDebugSymbols() {\n       ContextEmbedderIndex::kEnvironment;\n \n   nodedbg_offset_ExternalString__data__uintptr_t = NODE_OFF_EXTSTR_DATA;\n+  nodedbg_offset_ReqWrap__req_wrap_queue___ListNode_ReqWrapQueue =\n+      OffsetOf<ListNode<ReqWrapBase>, ReqWrap<uv_req_t>>(\n+          &ReqWrap<uv_req_t>::req_wrap_queue_);\n \n   #define V(Class, Member, Type, Accessor)                                    \\\n     NODEDBG_OFFSET(Class, Member, Type) = OffsetOf(&Accessor);"
        },
        {
            "sha": "ca8a4358053ff2b92873e5951991942c28620e62",
            "filename": "src/node_process_methods.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Fnode_process_methods.cc",
            "raw_url": "https://github.com/nodejs/node/raw/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Fnode_process_methods.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_process_methods.cc?ref=49a2e406329269af2bf55c0ad51560bdf1f14b7f",
            "patch": "@@ -252,7 +252,8 @@ static void GetActiveRequests(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   std::vector<Local<Value>> request_v;\n-  for (auto w : *env->req_wrap_queue()) {\n+  for (ReqWrapBase* req_wrap : *env->req_wrap_queue()) {\n+    AsyncWrap* w = req_wrap->GetAsyncWrap();\n     if (w->persistent().IsEmpty())\n       continue;\n     request_v.push_back(w->GetOwner());"
        },
        {
            "sha": "5fb965414838bb56ac6a9bab919a532f0fa21108",
            "filename": "src/req_wrap-inl.h",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Freq_wrap-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Freq_wrap-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Freq_wrap-inl.h?ref=49a2e406329269af2bf55c0ad51560bdf1f14b7f",
            "patch": "@@ -11,16 +11,16 @@\n \n namespace node {\n \n+ReqWrapBase::ReqWrapBase(Environment* env) {\n+  env->req_wrap_queue()->PushBack(this);\n+}\n+\n template <typename T>\n ReqWrap<T>::ReqWrap(Environment* env,\n                     v8::Local<v8::Object> object,\n                     AsyncWrap::ProviderType provider)\n-    : AsyncWrap(env, object, provider) {\n-\n-  // FIXME(bnoordhuis) The fact that a reinterpret_cast is needed is\n-  // arguably a good indicator that there should be more than one queue.\n-  env->req_wrap_queue()->PushBack(reinterpret_cast<ReqWrap<uv_req_t>*>(this));\n-\n+    : AsyncWrap(env, object, provider),\n+      ReqWrapBase(env) {\n   Reset();\n }\n \n@@ -51,6 +51,11 @@ void ReqWrap<T>::Cancel() {\n     uv_cancel(reinterpret_cast<uv_req_t*>(&req_));\n }\n \n+template <typename T>\n+AsyncWrap* ReqWrap<T>::GetAsyncWrap() {\n+  return this;\n+}\n+\n // Below is dark template magic designed to invoke libuv functions that\n // initialize uv_req_t instances in a unified fashion, to allow easier\n // tracking of active/inactive requests."
        },
        {
            "sha": "890eb6cb61848c964b94581763a7aaf17acceb06",
            "filename": "src/req_wrap.h",
            "status": "modified",
            "additions": 19,
            "deletions": 5,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Freq_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/49a2e406329269af2bf55c0ad51560bdf1f14b7f/src%2Freq_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Freq_wrap.h?ref=49a2e406329269af2bf55c0ad51560bdf1f14b7f",
            "patch": "@@ -10,8 +10,24 @@\n \n namespace node {\n \n+class ReqWrapBase {\n+ public:\n+  explicit inline ReqWrapBase(Environment* env);\n+\n+  virtual ~ReqWrapBase() {}\n+\n+  virtual void Cancel() = 0;\n+  virtual AsyncWrap* GetAsyncWrap() = 0;\n+\n+ private:\n+  friend int GenDebugSymbols();\n+  friend class Environment;\n+\n+  ListNode<ReqWrapBase> req_wrap_queue_;\n+};\n+\n template <typename T>\n-class ReqWrap : public AsyncWrap {\n+class ReqWrap : public AsyncWrap, public ReqWrapBase {\n  public:\n   inline ReqWrap(Environment* env,\n                  v8::Local<v8::Object> object,\n@@ -23,21 +39,19 @@ class ReqWrap : public AsyncWrap {\n   // Call this after a request has finished, if re-using this object is planned.\n   inline void Reset();\n   T* req() { return &req_; }\n-  inline void Cancel();\n+  inline void Cancel() final;\n+  inline AsyncWrap* GetAsyncWrap() override;\n \n   static ReqWrap* from_req(T* req);\n \n   template <typename LibuvFunction, typename... Args>\n   inline int Dispatch(LibuvFunction fn, Args... args);\n \n  private:\n-  friend class Environment;\n   friend int GenDebugSymbols();\n   template <typename ReqT, typename U>\n   friend struct MakeLibuvRequestCallback;\n \n-  ListNode<ReqWrap> req_wrap_queue_;\n-\n   typedef void (*callback_t)();\n   callback_t original_callback_ = nullptr;\n "
        }
    ],
    "stats": {
        "total": 57,
        "additions": 39,
        "deletions": 18
    }
}