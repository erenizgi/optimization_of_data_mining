{
    "author": "addaleax",
    "message": "lib: refactor policy code for readability\n\nSimplify a few particularly quirky bits of code, and add\nwhitespace for readability.\n\nPR-URL: https://github.com/nodejs/node/pull/25629\nReviewed-By: Denys Otrishko <shishugi@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Anto Aravinth <anto.aravinth.cse@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>",
    "sha": "0f5c14c43e5e79d40726ce6907caf2a76b510be2",
    "files": [
        {
            "sha": "d0d3431b546073b3af7cc0d702ace0655a312cf0",
            "filename": "lib/internal/policy/manifest.js",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/0f5c14c43e5e79d40726ce6907caf2a76b510be2/lib%2Finternal%2Fpolicy%2Fmanifest.js",
            "raw_url": "https://github.com/nodejs/node/raw/0f5c14c43e5e79d40726ce6907caf2a76b510be2/lib%2Finternal%2Fpolicy%2Fmanifest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fpolicy%2Fmanifest.js?ref=0f5c14c43e5e79d40726ce6907caf2a76b510be2",
            "patch": "@@ -22,19 +22,23 @@ const kReactions = new SafeWeakMap();\n const kRelativeURLStringPattern = /^\\.{0,2}\\//;\n const { shouldAbortOnUncaughtException } = internalBinding('config');\n const { abort, exit, _rawDebug } = process;\n+\n function REACTION_THROW(error) {\n   throw error;\n }\n+\n function REACTION_EXIT(error) {\n   REACTION_LOG(error);\n   if (shouldAbortOnUncaughtException) {\n     abort();\n   }\n   exit(1);\n }\n+\n function REACTION_LOG(error) {\n   _rawDebug(error.stack);\n }\n+\n class Manifest {\n   constructor(obj, manifestURL) {\n     const integrities = {\n@@ -44,6 +48,7 @@ class Manifest {\n       __proto__: null,\n       integrity: REACTION_THROW,\n     };\n+\n     if (obj.onerror) {\n       const behavior = obj.onerror;\n       if (behavior === 'throw') {\n@@ -55,8 +60,10 @@ class Manifest {\n         throw new ERR_MANIFEST_UNKNOWN_ONERROR(behavior);\n       }\n     }\n+\n     kReactions.set(this, Object.freeze(reactions));\n     const manifestEntries = entries(obj.resources);\n+\n     for (var i = 0; i < manifestEntries.length; i++) {\n       let url = manifestEntries[i][0];\n       const integrity = manifestEntries[i][1].integrity;\n@@ -65,10 +72,12 @@ class Manifest {\n         if (RegExpTest(kRelativeURLStringPattern, url)) {\n           url = new URL(url, manifestURL).href;\n         }\n+\n         const sri = Object.freeze(SRI.parse(integrity));\n         if (url in integrities) {\n           const old = integrities[url];\n           let mismatch = false;\n+\n           if (old.length !== sri.length) {\n             mismatch = true;\n           } else {\n@@ -85,6 +94,7 @@ class Manifest {\n               break compare;\n             }\n           }\n+\n           if (mismatch) {\n             throw new ERR_MANIFEST_INTEGRITY_MISMATCH(url);\n           }\n@@ -96,10 +106,12 @@ class Manifest {\n     kIntegrities.set(this, integrities);\n     Object.freeze(this);\n   }\n+\n   assertIntegrity(url, content) {\n     debug(`Checking integrity of ${url}`);\n     const integrities = kIntegrities.get(this);\n     const realIntegrities = new Map();\n+\n     if (integrities && url in integrities) {\n       const integrityEntries = integrities[url];\n       // Avoid clobbered Symbol.iterator\n@@ -122,6 +134,7 @@ class Manifest {\n     kReactions.get(this).integrity(error);\n   }\n }\n+\n // Lock everything down to avoid problems even if reference is leaked somehow\n Object.setPrototypeOf(Manifest, null);\n Object.setPrototypeOf(Manifest.prototype, null);"
        },
        {
            "sha": "1cdec8d739eb996640845d08537a40a96f670ff3",
            "filename": "lib/internal/policy/sri.js",
            "status": "modified",
            "additions": 10,
            "deletions": 12,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/0f5c14c43e5e79d40726ce6907caf2a76b510be2/lib%2Finternal%2Fpolicy%2Fsri.js",
            "raw_url": "https://github.com/nodejs/node/raw/0f5c14c43e5e79d40726ce6907caf2a76b510be2/lib%2Finternal%2Fpolicy%2Fsri.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fpolicy%2Fsri.js?ref=0f5c14c43e5e79d40726ce6907caf2a76b510be2",
            "patch": "@@ -18,29 +18,27 @@ const { freeze } = Object;\n Object.seal(kSRIPattern);\n const kAllWSP = new RegExp(`^${kWSP}*$`);\n Object.seal(kAllWSP);\n+\n const RegExpExec = Function.call.bind(RegExp.prototype.exec);\n const RegExpTest = Function.call.bind(RegExp.prototype.test);\n const StringSlice = Function.call.bind(String.prototype.slice);\n-const {\n-  Buffer: {\n-    from: BufferFrom\n-  }\n-} = require('buffer');\n+\n+const BufferFrom = require('buffer').Buffer.from;\n const { defineProperty } = Object;\n+\n const parse = (str) => {\n   kSRIPattern.lastIndex = 0;\n   let prevIndex = 0;\n-  let match = RegExpExec(kSRIPattern, str);\n+  let match;\n   const entries = [];\n-  while (match) {\n+  while (match = RegExpExec(kSRIPattern, str)) {\n     if (match.index !== prevIndex) {\n       throw new ERR_SRI_PARSE(str, prevIndex);\n     }\n-    if (entries.length > 0) {\n-      if (match[1] === '') {\n-        throw new ERR_SRI_PARSE(str, prevIndex);\n-      }\n+    if (entries.length > 0 && match[1] === '') {\n+      throw new ERR_SRI_PARSE(str, prevIndex);\n     }\n+\n     // Avoid setters being fired\n     defineProperty(entries, entries.length, {\n       enumerable: true,\n@@ -53,8 +51,8 @@ const parse = (str) => {\n       })\n     });\n     prevIndex = prevIndex + match[0].length;\n-    match = RegExpExec(kSRIPattern, str);\n   }\n+\n   if (prevIndex !== str.length) {\n     if (!RegExpTest(kAllWSP, StringSlice(str, prevIndex))) {\n       throw new ERR_SRI_PARSE(str, prevIndex);"
        },
        {
            "sha": "0b037d4ef53cf413b52bf928ee00f4c833e4b328",
            "filename": "lib/internal/process/policy.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/0f5c14c43e5e79d40726ce6907caf2a76b510be2/lib%2Finternal%2Fprocess%2Fpolicy.js",
            "raw_url": "https://github.com/nodejs/node/raw/0f5c14c43e5e79d40726ce6907caf2a76b510be2/lib%2Finternal%2Fprocess%2Fpolicy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fpolicy.js?ref=0f5c14c43e5e79d40726ce6907caf2a76b510be2",
            "patch": "@@ -5,13 +5,15 @@ const {\n } = require('internal/errors').codes;\n const { Manifest } = require('internal/policy/manifest');\n let manifest;\n+\n module.exports = Object.freeze({\n   __proto__: null,\n   setup(src, url) {\n     if (src === null) {\n       manifest = null;\n       return;\n     }\n+\n     const json = JSON.parse(src, (_, o) => {\n       if (o && typeof o === 'object') {\n         Reflect.setPrototypeOf(o, null);\n@@ -21,12 +23,14 @@ module.exports = Object.freeze({\n     });\n     manifest = new Manifest(json, url);\n   },\n+\n   get manifest() {\n     if (typeof manifest === 'undefined') {\n       throw new ERR_MANIFEST_TDZ();\n     }\n     return manifest;\n   },\n+\n   assertIntegrity(moduleURL, content) {\n     this.manifest.matchesIntegrity(moduleURL, content);\n   }"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 27,
        "deletions": 12
    }
}