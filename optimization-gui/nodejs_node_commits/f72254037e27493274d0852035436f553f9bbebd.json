{
    "author": "addaleax",
    "message": "src: handle errors while printing error objects\n\nHandle situations where accessing `.name` or `.stack` on an object\nfails.\n\nFixes: https://github.com/nodejs/node/issues/25718\n\nPR-URL: https://github.com/nodejs/node/pull/25834\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "f72254037e27493274d0852035436f553f9bbebd",
    "files": [
        {
            "sha": "42e19f690514ff7f28a21b6624faf86ff12e38af",
            "filename": "src/node_errors.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 17,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/f72254037e27493274d0852035436f553f9bbebd/src%2Fnode_errors.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f72254037e27493274d0852035436f553f9bbebd/src%2Fnode_errors.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_errors.cc?ref=f72254037e27493274d0852035436f553f9bbebd",
            "patch": "@@ -9,6 +9,7 @@\n \n namespace node {\n \n+using errors::TryCatchScope;\n using v8::Context;\n using v8::Exception;\n using v8::Function;\n@@ -201,8 +202,10 @@ void ReportException(Environment* env,\n   } else {\n     Local<Object> err_obj = er->ToObject(env->context()).ToLocalChecked();\n \n-    trace_value = err_obj->Get(env->context(),\n-                               env->stack_string()).ToLocalChecked();\n+    if (!err_obj->Get(env->context(), env->stack_string())\n+             .ToLocal(&trace_value)) {\n+      trace_value = Undefined(env->isolate());\n+    }\n     arrow =\n         err_obj->GetPrivate(env->context(), env->arrow_message_private_symbol())\n             .ToLocalChecked();\n@@ -222,27 +225,25 @@ void ReportException(Environment* env,\n     // this really only happens for RangeErrors, since they're the only\n     // kind that won't have all this info in the trace, or when non-Error\n     // objects are thrown manually.\n-    Local<Value> message;\n-    Local<Value> name;\n+    MaybeLocal<Value> message;\n+    MaybeLocal<Value> name;\n \n     if (er->IsObject()) {\n       Local<Object> err_obj = er.As<Object>();\n-      message = err_obj->Get(env->context(),\n-                             env->message_string()).ToLocalChecked();\n-      name = err_obj->Get(env->context(),\n-          FIXED_ONE_BYTE_STRING(env->isolate(), \"name\")).ToLocalChecked();\n+      message = err_obj->Get(env->context(), env->message_string());\n+      name = err_obj->Get(env->context(), env->name_string());\n     }\n \n-    if (message.IsEmpty() || message->IsUndefined() || name.IsEmpty() ||\n-        name->IsUndefined()) {\n+    if (message.IsEmpty() || message.ToLocalChecked()->IsUndefined() ||\n+        name.IsEmpty() || name.ToLocalChecked()->IsUndefined()) {\n       // Not an error object. Just print as-is.\n       String::Utf8Value message(env->isolate(), er);\n \n       PrintErrorString(\"%s\\n\",\n                        *message ? *message : \"<toString() threw exception>\");\n     } else {\n-      node::Utf8Value name_string(env->isolate(), name);\n-      node::Utf8Value message_string(env->isolate(), message);\n+      node::Utf8Value name_string(env->isolate(), name.ToLocalChecked());\n+      node::Utf8Value message_string(env->isolate(), message.ToLocalChecked());\n \n       if (arrow.IsEmpty() || !arrow->IsString() || decorated) {\n         PrintErrorString(\"%s: %s\\n\", *name_string, *message_string);\n@@ -681,8 +682,8 @@ void DecorateErrorStack(Environment* env,\n   if (IsExceptionDecorated(env, err_obj)) return;\n \n   AppendExceptionLine(env, exception, try_catch.Message(), CONTEXTIFY_ERROR);\n-  Local<Value> stack =\n-      err_obj->Get(env->context(), env->stack_string()).ToLocalChecked();\n+  TryCatchScope try_catch_scope(env);  // Ignore exceptions below.\n+  MaybeLocal<Value> stack = err_obj->Get(env->context(), env->stack_string());\n   MaybeLocal<Value> maybe_value =\n       err_obj->GetPrivate(env->context(), env->arrow_message_private_symbol());\n \n@@ -691,7 +692,7 @@ void DecorateErrorStack(Environment* env,\n     return;\n   }\n \n-  if (stack.IsEmpty() || !stack->IsString()) {\n+  if (stack.IsEmpty() || !stack.ToLocalChecked()->IsString()) {\n     return;\n   }\n \n@@ -700,8 +701,8 @@ void DecorateErrorStack(Environment* env,\n       String::Concat(env->isolate(),\n                      arrow.As<String>(),\n                      FIXED_ONE_BYTE_STRING(env->isolate(), \"\\n\")),\n-      stack.As<String>());\n-  err_obj->Set(env->context(), env->stack_string(), decorated_stack).FromJust();\n+      stack.ToLocalChecked().As<String>());\n+  USE(err_obj->Set(env->context(), env->stack_string(), decorated_stack));\n   err_obj->SetPrivate(\n       env->context(), env->decorated_private_symbol(), True(env->isolate()));\n }"
        },
        {
            "sha": "a807ff3e2b65041f5927e04148941c4266cb1e04",
            "filename": "test/message/throw_error_with_getter_throw.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/f72254037e27493274d0852035436f553f9bbebd/test%2Fmessage%2Fthrow_error_with_getter_throw.js",
            "raw_url": "https://github.com/nodejs/node/raw/f72254037e27493274d0852035436f553f9bbebd/test%2Fmessage%2Fthrow_error_with_getter_throw.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fthrow_error_with_getter_throw.js?ref=f72254037e27493274d0852035436f553f9bbebd",
            "patch": "@@ -0,0 +1,10 @@\n+'use strict';\n+require('../common');\n+throw {  // eslint-disable-line no-throw-literal\n+  get stack() {\n+    throw new Error('weird throw but ok');\n+  },\n+  get name() {\n+    throw new Error('weird throw but ok');\n+  },\n+};"
        },
        {
            "sha": "62d546d0bce862c5368dffca722a99843277c03b",
            "filename": "test/message/throw_error_with_getter_throw.out",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/f72254037e27493274d0852035436f553f9bbebd/test%2Fmessage%2Fthrow_error_with_getter_throw.out",
            "raw_url": "https://github.com/nodejs/node/raw/f72254037e27493274d0852035436f553f9bbebd/test%2Fmessage%2Fthrow_error_with_getter_throw.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fthrow_error_with_getter_throw.out?ref=f72254037e27493274d0852035436f553f9bbebd",
            "patch": "@@ -0,0 +1,5 @@\n+\n+*:3\n+throw {  // eslint-disable-line no-throw-literal\n+^\n+[object Object]"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 33,
        "deletions": 17
    }
}