{
    "author": "targos",
    "message": "src,lib: implement import.meta\n\nImplement the C++ callback that is required to configure the\n`import.meta` object and add one property:\n- url: absolute URL of the module\n\nPR-URL: https://github.com/nodejs/node/pull/18368\nReviewed-By: Guy Bedford <guybedford@gmail.com>\nReviewed-By: Bradley Farias <bradley.meck@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b",
    "files": [
        {
            "sha": "10f20958593b59336f7b20a1c7a964995d225a4f",
            "filename": "doc/api/esm.md",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/doc%2Fapi%2Fesm.md",
            "raw_url": "https://github.com/nodejs/node/raw/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/doc%2Fapi%2Fesm.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fesm.md?ref=9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b",
            "patch": "@@ -36,12 +36,17 @@ Only the CLI argument for the main entry point to the program can be an entry\n point into an ESM graph. Dynamic import can also be used to create entry points\n into ESM graphs at runtime.\n \n+#### `import.meta`\n+\n+The `import.meta` metaproperty is an `Object` that contains the following\n+property:\n+* `url` {string} The absolute `file:` URL of the module\n+\n ### Unsupported\n \n | Feature | Reason |\n | --- | --- |\n | `require('./foo.mjs')` | ES Modules have differing resolution and timing, use dynamic import |\n-| `import.meta` | pending V8 implementation |\n \n ## Notable differences between `import` and `require`\n "
        },
        {
            "sha": "33de5ae4be2f0df903d6ee1b47288d57db6d53a4",
            "filename": "lib/internal/bootstrap_node.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/lib%2Finternal%2Fbootstrap_node.js",
            "raw_url": "https://github.com/nodejs/node/raw/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/lib%2Finternal%2Fbootstrap_node.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap_node.js?ref=9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b",
            "patch": "@@ -100,6 +100,7 @@\n       process.emitWarning(\n         'The ESM module loader is experimental.',\n         'ExperimentalWarning', undefined);\n+      NativeModule.require('internal/process/modules').setup();\n     }\n \n "
        },
        {
            "sha": "eda47f80cddeb4c2bf418a9fd634444c9cfd2d01",
            "filename": "lib/internal/process/modules.js",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/lib%2Finternal%2Fprocess%2Fmodules.js",
            "raw_url": "https://github.com/nodejs/node/raw/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/lib%2Finternal%2Fprocess%2Fmodules.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fmodules.js?ref=9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b",
            "patch": "@@ -0,0 +1,17 @@\n+'use strict';\n+\n+const {\n+  setInitializeImportMetaObjectCallback\n+} = internalBinding('module_wrap');\n+\n+function initializeImportMetaObject(wrap, meta) {\n+  meta.url = wrap.url;\n+}\n+\n+function setupModules() {\n+  setInitializeImportMetaObjectCallback(initializeImportMetaObject);\n+}\n+\n+module.exports = {\n+  setup: setupModules\n+};"
        },
        {
            "sha": "33642e90ac91e2c9322feb5cd0422ea3f23302f2",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b",
            "patch": "@@ -112,6 +112,7 @@\n       'lib/internal/net.js',\n       'lib/internal/module.js',\n       'lib/internal/os.js',\n+      'lib/internal/process/modules.js',\n       'lib/internal/process/next_tick.js',\n       'lib/internal/process/promises.js',\n       'lib/internal/process/stdio.js',"
        },
        {
            "sha": "79fc848386cc8292826946bb1fb47ed40f4e9b00",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b",
            "patch": "@@ -250,6 +250,7 @@ class ModuleWrap;\n   V(type_string, \"type\")                                                      \\\n   V(uid_string, \"uid\")                                                        \\\n   V(unknown_string, \"<unknown>\")                                              \\\n+  V(url_string, \"url\")                                                        \\\n   V(user_string, \"user\")                                                      \\\n   V(username_string, \"username\")                                              \\\n   V(valid_from_string, \"valid_from\")                                          \\\n@@ -279,6 +280,7 @@ class ModuleWrap;\n   V(context, v8::Context)                                                     \\\n   V(domain_callback, v8::Function)                                            \\\n   V(host_import_module_dynamically_callback, v8::Function)                    \\\n+  V(host_initialize_import_meta_object_callback, v8::Function)                \\\n   V(http2ping_constructor_template, v8::ObjectTemplate)                       \\\n   V(http2stream_constructor_template, v8::ObjectTemplate)                     \\\n   V(http2settings_constructor_template, v8::ObjectTemplate)                   \\"
        },
        {
            "sha": "0fda1250d701c09f9daedbab497083c81513e590",
            "filename": "src/module_wrap.cc",
            "status": "modified",
            "additions": 53,
            "deletions": 11,
            "changes": 64,
            "blob_url": "https://github.com/nodejs/node/blob/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/src%2Fmodule_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/src%2Fmodule_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.cc?ref=9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b",
            "patch": "@@ -37,6 +37,7 @@ using v8::ScriptCompiler;\n using v8::ScriptOrigin;\n using v8::String;\n using v8::TryCatch;\n+using v8::Undefined;\n using v8::Value;\n \n static const char* const EXTENSIONS[] = {\".mjs\", \".js\", \".json\", \".node\"};\n@@ -64,6 +65,19 @@ ModuleWrap::~ModuleWrap() {\n   context_.Reset();\n }\n \n+ModuleWrap* ModuleWrap::GetFromModule(Environment* env,\n+                                      Local<Module> module) {\n+  ModuleWrap* ret = nullptr;\n+  auto range = env->module_map.equal_range(module->GetIdentityHash());\n+  for (auto it = range.first; it != range.second; ++it) {\n+    if (it->second->module_ == module) {\n+      ret = it->second;\n+      break;\n+    }\n+  }\n+  return ret;\n+}\n+\n void ModuleWrap::New(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n@@ -133,9 +147,7 @@ void ModuleWrap::New(const FunctionCallbackInfo<Value>& args) {\n     }\n   }\n \n-  Local<String> url_str = FIXED_ONE_BYTE_STRING(isolate, \"url\");\n-\n-  if (!that->Set(context, url_str, url).FromMaybe(false)) {\n+  if (!that->Set(context, env->url_string(), url).FromMaybe(false)) {\n     return;\n   }\n \n@@ -361,14 +373,7 @@ MaybeLocal<Module> ModuleWrap::ResolveCallback(Local<Context> context,\n     return MaybeLocal<Module>();\n   }\n \n-  ModuleWrap* dependent = nullptr;\n-  auto range = env->module_map.equal_range(referrer->GetIdentityHash());\n-  for (auto it = range.first; it != range.second; ++it) {\n-    if (it->second->module_ == referrer) {\n-      dependent = it->second;\n-      break;\n-    }\n-  }\n+  ModuleWrap* dependent = ModuleWrap::GetFromModule(env, referrer);\n \n   if (dependent == nullptr) {\n     env->ThrowError(\"linking error, null dep\");\n@@ -728,6 +733,40 @@ void ModuleWrap::SetImportModuleDynamicallyCallback(\n   iso->SetHostImportModuleDynamicallyCallback(ImportModuleDynamically);\n }\n \n+void ModuleWrap::HostInitializeImportMetaObjectCallback(\n+    Local<Context> context, Local<Module> module, Local<Object> meta) {\n+  Isolate* isolate = context->GetIsolate();\n+  Environment* env = Environment::GetCurrent(context);\n+  ModuleWrap* module_wrap = ModuleWrap::GetFromModule(env, module);\n+\n+  if (module_wrap == nullptr) {\n+    return;\n+  }\n+\n+  Local<Object> wrap = module_wrap->object();\n+  Local<Function> callback =\n+      env->host_initialize_import_meta_object_callback();\n+  Local<Value> args[] = { wrap, meta };\n+  callback->Call(context, Undefined(isolate), arraysize(args), args)\n+      .ToLocalChecked();\n+}\n+\n+void ModuleWrap::SetInitializeImportMetaObjectCallback(\n+    const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  Isolate* isolate = env->isolate();\n+  if (!args[0]->IsFunction()) {\n+    env->ThrowError(\"first argument is not a function\");\n+    return;\n+  }\n+\n+  Local<Function> import_meta_callback = args[0].As<Function>();\n+  env->set_host_initialize_import_meta_object_callback(import_meta_callback);\n+\n+  isolate->SetHostInitializeImportMetaObjectCallback(\n+      HostInitializeImportMetaObjectCallback);\n+}\n+\n void ModuleWrap::Initialize(Local<Object> target,\n                             Local<Value> unused,\n                             Local<Context> context) {\n@@ -752,6 +791,9 @@ void ModuleWrap::Initialize(Local<Object> target,\n   env->SetMethod(target,\n                  \"setImportModuleDynamicallyCallback\",\n                  node::loader::ModuleWrap::SetImportModuleDynamicallyCallback);\n+  env->SetMethod(target,\n+                 \"setInitializeImportMetaObjectCallback\",\n+                 ModuleWrap::SetInitializeImportMetaObjectCallback);\n \n #define V(name)                                                                \\\n     target->Set(context,                                                       \\"
        },
        {
            "sha": "5950c5a1be0177027d01fb4552dae82479cfda20",
            "filename": "src/module_wrap.h",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/src%2Fmodule_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/src%2Fmodule_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.h?ref=9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b",
            "patch": "@@ -23,6 +23,10 @@ class ModuleWrap : public BaseObject {\n   static void Initialize(v8::Local<v8::Object> target,\n                          v8::Local<v8::Value> unused,\n                          v8::Local<v8::Context> context);\n+  static void HostInitializeImportMetaObjectCallback(\n+      v8::Local<v8::Context> context,\n+      v8::Local<v8::Module> module,\n+      v8::Local<v8::Object> meta);\n \n  private:\n   ModuleWrap(Environment* env,\n@@ -44,10 +48,14 @@ class ModuleWrap : public BaseObject {\n   static void Resolve(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void SetImportModuleDynamicallyCallback(\n       const v8::FunctionCallbackInfo<v8::Value>& args);\n+  static void SetInitializeImportMetaObjectCallback(\n+      const v8::FunctionCallbackInfo<v8::Value>& args);\n   static v8::MaybeLocal<v8::Module> ResolveCallback(\n       v8::Local<v8::Context> context,\n       v8::Local<v8::String> specifier,\n       v8::Local<v8::Module> referrer);\n+  static ModuleWrap* GetFromModule(node::Environment*, v8::Local<v8::Module>);\n+\n \n   v8::Persistent<v8::Module> module_;\n   v8::Persistent<v8::String> url_;"
        },
        {
            "sha": "6b14169e913d8b0faf094c677848c0dbba7ccb9b",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b",
            "patch": "@@ -3682,6 +3682,8 @@ static void ParseArgs(int* argc,\n       config_experimental_modules = true;\n       new_v8_argv[new_v8_argc] = \"--harmony-dynamic-import\";\n       new_v8_argc += 1;\n+      new_v8_argv[new_v8_argc] = \"--harmony-import-meta\";\n+      new_v8_argc += 1;\n     } else if (strcmp(arg, \"--experimental-vm-modules\") == 0) {\n       config_experimental_vm_modules = true;\n     }  else if (strcmp(arg, \"--loader\") == 0) {"
        },
        {
            "sha": "c17e0e20d49b4de90f3a6d9823152239a9c42b32",
            "filename": "test/es-module/test-esm-import-meta.mjs",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/test%2Fes-module%2Ftest-esm-import-meta.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b/test%2Fes-module%2Ftest-esm-import-meta.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fes-module%2Ftest-esm-import-meta.mjs?ref=9e1a6f8cb1e8b9cd596c42542a9ce6ded3734b1b",
            "patch": "@@ -0,0 +1,22 @@\n+// Flags: --experimental-modules\n+\n+import '../common';\n+import assert from 'assert';\n+\n+assert.strictEqual(Object.getPrototypeOf(import.meta), null);\n+\n+const keys = ['url'];\n+assert.deepStrictEqual(Reflect.ownKeys(import.meta), keys);\n+\n+const descriptors = Object.getOwnPropertyDescriptors(import.meta);\n+for (const descriptor of Object.values(descriptors)) {\n+  delete descriptor.value; // Values are verified below.\n+  assert.deepStrictEqual(descriptor, {\n+    enumerable: true,\n+    writable: true,\n+    configurable: true\n+  });\n+}\n+\n+const urlReg = /^file:\\/\\/\\/.*\\/test\\/es-module\\/test-esm-import-meta\\.mjs$/;\n+assert(import.meta.url.match(urlReg));"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 112,
        "deletions": 12
    }
}