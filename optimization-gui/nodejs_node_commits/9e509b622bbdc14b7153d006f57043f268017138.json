{
    "author": "jasnell",
    "message": "perf_hooks: emit trace events for marks, measures, and timerify\n\nAdds the `node.perf.usertiming` trace events category for recording\nusertiming marks and measures (e.g. `perf_hooks.performance.mark()`)\nin the trace events timeline.\n\nAdds the `node.perf.function` trace events category for recording\n`perf_hooks.performance.timerify()` durations in the trace events\ntimeline.\n\nPR-URL: https://github.com/nodejs/node/pull/18789\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "9e509b622bbdc14b7153d006f57043f268017138",
    "files": [
        {
            "sha": "4e31a2478595503bcf7099f005eb0076d0d448cc",
            "filename": "doc/api/perf_hooks.md",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/9e509b622bbdc14b7153d006f57043f268017138/doc%2Fapi%2Fperf_hooks.md",
            "raw_url": "https://github.com/nodejs/node/raw/9e509b622bbdc14b7153d006f57043f268017138/doc%2Fapi%2Fperf_hooks.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fperf_hooks.md?ref=9e509b622bbdc14b7153d006f57043f268017138",
            "patch": "@@ -268,8 +268,8 @@ added: v8.5.0\n \n * {string}\n \n-The type of the performance entry. Current it may be one of: `'node'`, `'mark'`,\n-`'measure'`, `'gc'`, or `'function'`.\n+The type of the performance entry. Currently it may be one of: `'node'`,\n+`'mark'`, `'measure'`, `'gc'`, or `'function'`.\n \n ### performanceEntry.kind\n <!-- YAML"
        },
        {
            "sha": "3a534177a37530fb88800e4211805c40ddecd2d3",
            "filename": "doc/api/tracing.md",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/9e509b622bbdc14b7153d006f57043f268017138/doc%2Fapi%2Ftracing.md",
            "raw_url": "https://github.com/nodejs/node/raw/9e509b622bbdc14b7153d006f57043f268017138/doc%2Fapi%2Ftracing.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftracing.md?ref=9e509b622bbdc14b7153d006f57043f268017138",
            "patch": "@@ -10,8 +10,20 @@ starting a Node.js application.\n \n The set of categories for which traces are recorded can be specified using the\n `--trace-event-categories` flag followed by a list of comma separated category\n-names. By default the `node`, `node.async_hooks`, and `v8` categories are\n-enabled.\n+names.\n+\n+The available categories are:\n+\n+* `node`\n+* `node.async_hooks` - Enables capture of detailed async_hooks trace data.\n+* `node.perf` - Enables capture of [Performance API] measurements.\n+  * `node.perf.usertiming` - Enables capture of only Performance API User Timing\n+    measures and marks.\n+  * `node.perf.timerify` - Enables capture of only Performance API timerify\n+    measurements.\n+* `v8`\n+\n+By default the `node`, `node.async_hooks`, and `v8` categories are enabled.\n \n ```txt\n node --trace-events-enabled --trace-event-categories v8,node,node.async_hooks server.js\n@@ -24,3 +36,5 @@ tab of Chrome.\n Starting with Node 10.0.0, the tracing system uses the same time source as the\n one used by `process.hrtime()` however the trace-event timestamps are expressed\n in microseconds, unlike `process.hrtime()` which returns nanoseconds.\n+\n+[Performance API]: perf_hooks.html"
        },
        {
            "sha": "db4eff535345724e441f7caf2ca17a0530b149b5",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/9e509b622bbdc14b7153d006f57043f268017138/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9e509b622bbdc14b7153d006f57043f268017138/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=9e509b622bbdc14b7153d006f57043f268017138",
            "patch": "@@ -105,8 +105,8 @@ void Mark(const FunctionCallbackInfo<Value>& args) {\n   auto marks = env->performance_marks();\n   (*marks)[*name] = now;\n \n-  // TODO(jasnell): Once Tracing API is fully implemented, this should\n-  // record a trace event also.\n+  TRACE_EVENT_COPY_MARK_WITH_TIMESTAMP(\n+      \"node.perf,node.perf.usertiming\", *name, now / 1000);\n \n   PerformanceEntry entry(env, *name, \"mark\", now, now);\n   Local<Object> obj = entry.ToObject();\n@@ -153,8 +153,10 @@ void Measure(const FunctionCallbackInfo<Value>& args) {\n   if (endTimestamp < startTimestamp)\n     endTimestamp = startTimestamp;\n \n-  // TODO(jasnell): Once Tracing API is fully implemented, this should\n-  // record a trace event also.\n+  TRACE_EVENT_COPY_NESTABLE_ASYNC_BEGIN_WITH_TIMESTAMP0(\n+      \"node.perf,node.perf.usertiming\", *name, *name, startTimestamp / 1000);\n+  TRACE_EVENT_COPY_NESTABLE_ASYNC_END_WITH_TIMESTAMP0(\n+      \"node.perf,node.perf.usertiming\", *name, *name, endTimestamp / 1000);\n \n   PerformanceEntry entry(env, *name, \"measure\", startTimestamp, endTimestamp);\n   Local<Object> obj = entry.ToObject();\n@@ -269,22 +271,32 @@ void TimerFunctionCall(const FunctionCallbackInfo<Value>& args) {\n   v8::TryCatch try_catch(isolate);\n   if (args.IsConstructCall()) {\n     start = PERFORMANCE_NOW();\n+    TRACE_EVENT_COPY_NESTABLE_ASYNC_BEGIN_WITH_TIMESTAMP0(\n+        \"node.perf,node.perf.timerify\", *name, *name, start / 1000);\n     v8::MaybeLocal<Object> ret = fn->NewInstance(context,\n                                                  call_args.size(),\n                                                  call_args.data());\n     end = PERFORMANCE_NOW();\n+    TRACE_EVENT_COPY_NESTABLE_ASYNC_END_WITH_TIMESTAMP0(\n+        \"node.perf,node.perf.timerify\", *name, *name, end / 1000);\n+\n     if (ret.IsEmpty()) {\n       try_catch.ReThrow();\n       return;\n     }\n     args.GetReturnValue().Set(ret.ToLocalChecked());\n   } else {\n     start = PERFORMANCE_NOW();\n+    TRACE_EVENT_COPY_NESTABLE_ASYNC_BEGIN_WITH_TIMESTAMP0(\n+        \"node.perf,node.perf.timerify\", *name, *name, start / 1000);\n     v8::MaybeLocal<Value> ret = fn->Call(context,\n                                          args.This(),\n                                          call_args.size(),\n                                          call_args.data());\n     end = PERFORMANCE_NOW();\n+    TRACE_EVENT_COPY_NESTABLE_ASYNC_END_WITH_TIMESTAMP0(\n+        \"node.perf,node.perf.timerify\", *name, *name, end / 1000);\n+\n     if (ret.IsEmpty()) {\n       try_catch.ReThrow();\n       return;"
        },
        {
            "sha": "82e3f46eb83c5509e9dc396788d2320998619c5c",
            "filename": "src/node_perf.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/9e509b622bbdc14b7153d006f57043f268017138/src%2Fnode_perf.h",
            "raw_url": "https://github.com/nodejs/node/raw/9e509b622bbdc14b7153d006f57043f268017138/src%2Fnode_perf.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.h?ref=9e509b622bbdc14b7153d006f57043f268017138",
            "patch": "@@ -4,6 +4,7 @@\n #if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n \n #include \"node.h\"\n+#include \"node_internals.h\"\n #include \"node_perf_common.h\"\n #include \"env.h\"\n #include \"base_object-inl.h\""
        },
        {
            "sha": "3fbe1b0a1f9a46bd776feb93ef51ec2002f250d9",
            "filename": "src/tracing/trace_event.h",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/9e509b622bbdc14b7153d006f57043f268017138/src%2Ftracing%2Ftrace_event.h",
            "raw_url": "https://github.com/nodejs/node/raw/9e509b622bbdc14b7153d006f57043f268017138/src%2Ftracing%2Ftrace_event.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Ftrace_event.h?ref=9e509b622bbdc14b7153d006f57043f268017138",
            "patch": "@@ -244,9 +244,20 @@ enum CategoryGroupEnabledFlags {\n \n // Adds a trace event with a given id, thread_id, and timestamp. Not\n // Implemented.\n-#define INTERNAL_TRACE_EVENT_ADD_WITH_ID_TID_AND_TIMESTAMP(            \\\n-    phase, category_group, name, id, thread_id, timestamp, flags, ...) \\\n-  UNIMPLEMENTED()\n+#define INTERNAL_TRACE_EVENT_ADD_WITH_ID_TID_AND_TIMESTAMP(                  \\\n+    phase, category_group, name, id, thread_id, timestamp, flags, ...)       \\\n+  do {                                                                       \\\n+    INTERNAL_TRACE_EVENT_GET_CATEGORY_INFO(category_group);                  \\\n+    if (INTERNAL_TRACE_EVENT_CATEGORY_GROUP_ENABLED_FOR_RECORDING_MODE()) {  \\\n+      unsigned int trace_event_flags = flags | TRACE_EVENT_FLAG_HAS_ID;      \\\n+      node::tracing::TraceID trace_event_trace_id(id,                        \\\n+                                                  &trace_event_flags);       \\\n+      node::tracing::AddTraceEventWithTimestamp(                             \\\n+          phase, INTERNAL_TRACE_EVENT_UID(category_group_enabled), name,     \\\n+          trace_event_trace_id.scope(), trace_event_trace_id.raw_id(),       \\\n+          node::tracing::kNoId, trace_event_flags, timestamp, ##__VA_ARGS__);\\\n+    }                                                                        \\\n+  } while (0)\n \n // Enter and leave a context based on the current scope.\n #define INTERNAL_TRACE_EVENT_SCOPED_CONTEXT(category_group, name, context) \\"
        },
        {
            "sha": "e73579f87eec02a87d26559c911391f693bbf1d3",
            "filename": "test/parallel/test-trace-events-perf.js",
            "status": "added",
            "additions": 82,
            "deletions": 0,
            "changes": 82,
            "blob_url": "https://github.com/nodejs/node/blob/9e509b622bbdc14b7153d006f57043f268017138/test%2Fparallel%2Ftest-trace-events-perf.js",
            "raw_url": "https://github.com/nodejs/node/raw/9e509b622bbdc14b7153d006f57043f268017138/test%2Fparallel%2Ftest-trace-events-perf.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-perf.js?ref=9e509b622bbdc14b7153d006f57043f268017138",
            "patch": "@@ -0,0 +1,82 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const cp = require('child_process');\n+const path = require('path');\n+const fs = require('fs');\n+const tmpdir = require('../common/tmpdir');\n+\n+if (process.argv[2] === 'child') {\n+  const { performance } = require('perf_hooks');\n+\n+  // Will emit mark and measure trace events\n+  performance.mark('A');\n+  setTimeout(() => {\n+    performance.mark('B');\n+    performance.measure('A to B', 'A', 'B');\n+  }, 1);\n+\n+  // Intentional non-op, part of the test\n+  function f() {}\n+  const ff = performance.timerify(f);\n+  ff();  // Will emit a timerify trace event\n+} else {\n+  tmpdir.refresh();\n+  process.chdir(tmpdir.path);\n+\n+  const expectedMarks = ['A', 'B'];\n+  const expectedBegins = [\n+    { cat: 'node.perf,node.perf.timerify', name: 'f' },\n+    { cat: 'node.perf,node.perf.usertiming', name: 'A to B' }\n+  ];\n+  const expectedEnds = [\n+    { cat: 'node.perf,node.perf.timerify', name: 'f' },\n+    { cat: 'node.perf,node.perf.usertiming', name: 'A to B' }\n+  ];\n+\n+  const proc = cp.fork(__filename,\n+                       [\n+                         'child'\n+                       ], {\n+                         execArgv: [\n+                           '--trace-events-enabled',\n+                           '--trace-event-categories',\n+                           'node.perf'\n+                         ]\n+                       });\n+\n+  proc.once('exit', common.mustCall(() => {\n+    const file = path.join(tmpdir.path, 'node_trace.1.log');\n+\n+    assert(common.fileExists(file));\n+    fs.readFile(file, common.mustCall((err, data) => {\n+      const traces = JSON.parse(data.toString()).traceEvents;\n+      assert.strictEqual(traces.length,\n+                         expectedMarks.length +\n+                         expectedBegins.length +\n+                         expectedEnds.length);\n+\n+      traces.forEach((trace) => {\n+        assert.strictEqual(trace.pid, proc.pid);\n+        switch (trace.ph) {\n+          case 'R':\n+            assert.strictEqual(trace.cat, 'node.perf,node.perf.usertiming');\n+            assert.strictEqual(trace.name, expectedMarks.shift());\n+            break;\n+          case 'b':\n+            const expectedBegin = expectedBegins.shift();\n+            assert.strictEqual(trace.cat, expectedBegin.cat);\n+            assert.strictEqual(trace.name, expectedBegin.name);\n+            break;\n+          case 'e':\n+            const expectedEnd = expectedEnds.shift();\n+            assert.strictEqual(trace.cat, expectedEnd.cat);\n+            assert.strictEqual(trace.name, expectedEnd.name);\n+            break;\n+          default:\n+            assert.fail('Unexpected trace event phase');\n+        }\n+      });\n+    }));\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 142,
        "additions": 131,
        "deletions": 11
    }
}