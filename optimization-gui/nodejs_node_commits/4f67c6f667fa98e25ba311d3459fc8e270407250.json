{
    "author": "devsnek",
    "message": "vm: add Script.createCodeCache()\n\nPR-URL: https://github.com/nodejs/node/pull/20300\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Yang Guo <yangguo@chromium.org>",
    "sha": "4f67c6f667fa98e25ba311d3459fc8e270407250",
    "files": [
        {
            "sha": "df6371056d1af27bd1daad9995a3ca0d7ada0ce9",
            "filename": "doc/api/deprecations.md",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/4f67c6f667fa98e25ba311d3459fc8e270407250/doc%2Fapi%2Fdeprecations.md",
            "raw_url": "https://github.com/nodejs/node/raw/4f67c6f667fa98e25ba311d3459fc8e270407250/doc%2Fapi%2Fdeprecations.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fdeprecations.md?ref=4f67c6f667fa98e25ba311d3459fc8e270407250",
            "patch": "@@ -1005,6 +1005,14 @@ accepted by the legacy `url.parse()` API. The mentioned APIs now use the WHATWG\n URL parser that requires strictly valid URLs. Passing an invalid URL is\n deprecated and support will be removed in the future.\n \n+<a id=\"DEP00XX\"></a>\n+### DEP00XX: vm.Script cached data\n+\n+Type: Documentation-only\n+\n+The option `produceCachedData` has been deprecated. Use\n+[`script.createCachedData()`][] instead.\n+\n [`--pending-deprecation`]: cli.html#cli_pending_deprecation\n [`Buffer.allocUnsafeSlow(size)`]: buffer.html#buffer_class_method_buffer_allocunsafeslow_size\n [`Buffer.from(array)`]: buffer.html#buffer_class_method_buffer_from_array\n@@ -1055,6 +1063,7 @@ deprecated and support will be removed in the future.\n [`process.env`]: process.html#process_process_env\n [`punycode`]: punycode.html\n [`require.extensions`]: modules.html#modules_require_extensions\n+[`script.createCachedData()`]: vm.html#vm_script_create_cached_data\n [`setInterval()`]: timers.html#timers_setinterval_callback_delay_args\n [`setTimeout()`]: timers.html#timers_settimeout_callback_delay_args\n [`tls.CryptoStream`]: tls.html#tls_class_cryptostream"
        },
        {
            "sha": "e2ddd25e1cdeac31f94759bda6c70107e1814990",
            "filename": "doc/api/vm.md",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/4f67c6f667fa98e25ba311d3459fc8e270407250/doc%2Fapi%2Fvm.md",
            "raw_url": "https://github.com/nodejs/node/raw/4f67c6f667fa98e25ba311d3459fc8e270407250/doc%2Fapi%2Fvm.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fvm.md?ref=4f67c6f667fa98e25ba311d3459fc8e270407250",
            "patch": "@@ -411,6 +411,10 @@ changes:\n     pr-url: https://github.com/nodejs/node/pull/4777\n     description: The `cachedData` and `produceCachedData` options are\n                  supported now.\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/20300\n+    description: The `produceCachedData` is deprecated in favour of\n+                 `script.createCachedData()`\n -->\n \n * `code` {string} The JavaScript code to compile.\n@@ -431,11 +435,39 @@ changes:\n     `cachedData` property of the returned `vm.Script` instance.\n     The `cachedDataProduced` value will be set to either `true` or `false`\n     depending on whether code cache data is produced successfully.\n+    This option is deprecated in favor of `script.createCachedData`.\n \n Creating a new `vm.Script` object compiles `code` but does not run it. The\n compiled `vm.Script` can be run later multiple times. The `code` is not bound to\n any global object; rather, it is bound before each run, just for that run.\n \n+### script.createCachedData()\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* Returns: {Buffer}\n+\n+Creates a code cache that can be used with the Script constructor's\n+`cachedData` option. Returns a Buffer. This method may be called at any\n+time and any number of times.\n+\n+```js\n+const script = new vm.Script(`\n+function add(a, b) {\n+  return a + b;\n+}\n+\n+const x = add(1, 2);\n+`);\n+\n+const cacheWithoutX = script.createCachedData();\n+\n+script.runInThisContext();\n+\n+const cacheWithX = script.createCachedData();\n+```\n+\n ### script.runInContext(contextifiedSandbox[, options])\n <!-- YAML\n added: v0.3.1"
        },
        {
            "sha": "61c686ba001a3f8c1928bfdf87bfec33d5aeaaed",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 24,
            "deletions": 2,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/4f67c6f667fa98e25ba311d3459fc8e270407250/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4f67c6f667fa98e25ba311d3459fc8e270407250/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=4f67c6f667fa98e25ba311d3459fc8e270407250",
            "patch": "@@ -25,6 +25,7 @@\n #include \"base_object-inl.h\"\n #include \"node_contextify.h\"\n #include \"node_context_data.h\"\n+#include \"node_errors.h\"\n \n namespace node {\n namespace contextify {\n@@ -596,6 +597,7 @@ class ContextifyScript : public BaseObject {\n     Local<FunctionTemplate> script_tmpl = env->NewFunctionTemplate(New);\n     script_tmpl->InstanceTemplate()->SetInternalFieldCount(1);\n     script_tmpl->SetClassName(class_name);\n+    env->SetProtoMethod(script_tmpl, \"createCachedData\", CreateCachedData);\n     env->SetProtoMethod(script_tmpl, \"runInContext\", RunInContext);\n     env->SetProtoMethod(script_tmpl, \"runInThisContext\", RunInThisContext);\n \n@@ -637,7 +639,7 @@ class ContextifyScript : public BaseObject {\n     Local<Context> parsing_context = context;\n \n     if (argc > 2) {\n-      // new ContextifyScript(code, filename, lineOffset, columnOffset\n+      // new ContextifyScript(code, filename, lineOffset, columnOffset,\n       //                      cachedData, produceCachedData, parsingContext)\n       CHECK_EQ(argc, 7);\n       CHECK(args[2]->IsNumber());\n@@ -719,7 +721,7 @@ class ContextifyScript : public BaseObject {\n           Boolean::New(isolate, source.GetCachedData()->rejected));\n     } else if (produce_cached_data) {\n       const ScriptCompiler::CachedData* cached_data =\n-        ScriptCompiler::CreateCodeCache(v8_script.ToLocalChecked(), code);\n+        ScriptCompiler::CreateCodeCache(v8_script.ToLocalChecked());\n       bool cached_data_produced = cached_data != nullptr;\n       if (cached_data_produced) {\n         MaybeLocal<Object> buf = Buffer::Copy(\n@@ -745,6 +747,26 @@ class ContextifyScript : public BaseObject {\n   }\n \n \n+  static void CreateCachedData(const FunctionCallbackInfo<Value>& args) {\n+    Environment* env = Environment::GetCurrent(args);\n+    ContextifyScript* wrapped_script;\n+    ASSIGN_OR_RETURN_UNWRAP(&wrapped_script, args.Holder());\n+    Local<UnboundScript> unbound_script =\n+        PersistentToLocal(env->isolate(), wrapped_script->script_);\n+    std::unique_ptr<ScriptCompiler::CachedData> cached_data(\n+        ScriptCompiler::CreateCodeCache(unbound_script));\n+    if (!cached_data) {\n+      args.GetReturnValue().Set(Buffer::New(env, 0).ToLocalChecked());\n+    } else {\n+      MaybeLocal<Object> buf = Buffer::Copy(\n+          env,\n+          reinterpret_cast<const char*>(cached_data->data),\n+          cached_data->length);\n+      args.GetReturnValue().Set(buf.ToLocalChecked());\n+    }\n+  }\n+\n+\n   static void RunInThisContext(const FunctionCallbackInfo<Value>& args) {\n     Environment* env = Environment::GetCurrent(args);\n "
        },
        {
            "sha": "ba4d299b9c635531a046d865b795a8a3e32657e8",
            "filename": "test/parallel/test-vm-createcacheddata.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/4f67c6f667fa98e25ba311d3459fc8e270407250/test%2Fparallel%2Ftest-vm-createcacheddata.js",
            "raw_url": "https://github.com/nodejs/node/raw/4f67c6f667fa98e25ba311d3459fc8e270407250/test%2Fparallel%2Ftest-vm-createcacheddata.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-vm-createcacheddata.js?ref=4f67c6f667fa98e25ba311d3459fc8e270407250",
            "patch": "@@ -0,0 +1,22 @@\n+'use strict';\n+\n+require('../common');\n+\n+const { Script } = require('vm');\n+const assert = require('assert');\n+\n+const source = 'function x() {} const y = x();';\n+\n+const script = new Script(source);\n+let cachedData = script.createCachedData();\n+assert(cachedData instanceof Buffer);\n+\n+assert(!new Script(source, { cachedData }).cachedDataRejected);\n+\n+script.runInNewContext();\n+\n+for (let i = 0; i < 10; i += 1) {\n+  cachedData = script.createCachedData();\n+\n+  assert(!new Script(source, { cachedData }).cachedDataRejected);\n+}"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 87,
        "deletions": 2
    }
}