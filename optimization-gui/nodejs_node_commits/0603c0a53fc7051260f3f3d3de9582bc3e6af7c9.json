{
    "author": "unknown",
    "message": "src: bundle persistent-to-local methods as class\n\nCreate a class `PersistentToLocal` which contains three methods,\n`Strong`, `Weak`, and `Default`:\n\n* `Strong` returns a `Local` from a strong persistent reference,\n* `Weak` returns a `Local` from a weak persistent reference, and\n* `Default` decides based on `IsWeak()` which of the above two to call.\n\nThese replace `node::StrongPersistentToLocal()`,\n`node::WeakPersistentToLocal()`, and `node::PersistentToLocal()`,\nrespectively.\n\nPR-URL: https://github.com/nodejs/node/pull/24276\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
    "files": [
        {
            "sha": "0738cd400997f142132b92aab0b2ae4b96f81a52",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -346,7 +346,8 @@ void AsyncWrap::WeakCallback(const v8::WeakCallbackInfo<DestroyParam>& info) {\n   HandleScope scope(info.GetIsolate());\n \n   std::unique_ptr<DestroyParam> p{info.GetParameter()};\n-  Local<Object> prop_bag = PersistentToLocal(info.GetIsolate(), p->propBag);\n+  Local<Object> prop_bag = PersistentToLocal::Default(info.GetIsolate(),\n+                                                      p->propBag);\n   Local<Value> val;\n \n   if (!prop_bag->Get(p->env->context(), p->env->destroyed_string())"
        },
        {
            "sha": "0b8fbb8520c283cc219f829951c6023a051793e5",
            "filename": "src/base_object-inl.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fbase_object-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fbase_object-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbase_object-inl.h?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -62,7 +62,7 @@ Persistent<v8::Object>& BaseObject::persistent() {\n \n \n v8::Local<v8::Object> BaseObject::object() const {\n-  return PersistentToLocal(env_->isolate(), persistent_handle_);\n+  return PersistentToLocal::Default(env_->isolate(), persistent_handle_);\n }\n \n v8::Local<v8::Object> BaseObject::object(v8::Isolate* isolate) const {"
        },
        {
            "sha": "ba5704ed2e95741835c3732f5dabeca4862c1c29",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -895,7 +895,7 @@ void Environment::ForEachBaseObject(T&& iterator) {\n \n #define V(PropertyName, TypeName)                                             \\\n   inline v8::Local<TypeName> Environment::PropertyName() const {              \\\n-    return StrongPersistentToLocal(PropertyName ## _);                        \\\n+    return PersistentToLocal::Strong(PropertyName ## _);                      \\\n   }                                                                           \\\n   inline void Environment::set_ ## PropertyName(v8::Local<TypeName> value) {  \\\n     PropertyName ## _.Reset(isolate(), value);                                \\"
        },
        {
            "sha": "d1e3fad0980280deeac7255b2fd5ea61c19e00f6",
            "filename": "src/heap_utils.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fheap_utils.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fheap_utils.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fheap_utils.cc?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -26,7 +26,7 @@ class JSGraphJSNode : public EmbedderGraph::Node {\n   const char* Name() override { return \"<JS Node>\"; }\n   size_t SizeInBytes() override { return 0; }\n   bool IsEmbedderNode() override { return false; }\n-  Local<Value> JSValue() { return StrongPersistentToLocal(persistent_); }\n+  Local<Value> JSValue() { return PersistentToLocal::Strong(persistent_); }\n \n   int IdentityHash() {\n     Local<Value> v = JSValue();"
        },
        {
            "sha": "11dd2be7af35c949322012cfdc2297a8d7861345",
            "filename": "src/memory_tracker.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fmemory_tracker.h",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fmemory_tracker.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmemory_tracker.h?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -69,7 +69,7 @@ class NodeBIO;\n  *     // a BaseObject or an AsyncWrap class\n  *     bool IsRootNode() const override { return !wrapped_.IsWeak(); }\n  *     v8::Local<v8::Object> WrappedObject() const override {\n- *       return node::PersistentToLocal(wrapped_);\n+ *       return node::PersistentToLocal::Default(wrapped_);\n  *     }\n  *   private:\n  *     AnotherRetainerClass another_retainer_;"
        },
        {
            "sha": "500312750974eff4146598c9bf912fee637b3d2a",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -30,7 +30,7 @@ struct napi_env__ {\n   node::Persistent<v8::Context> context_persistent;\n \n   inline v8::Local<v8::Context> context() const {\n-    return StrongPersistentToLocal(context_persistent);\n+    return node::PersistentToLocal::Strong(context_persistent);\n   }\n \n   inline node::Environment* node_env() const {"
        },
        {
            "sha": "bc08e31a0653069544ff1af15f9ad00ecc361d40",
            "filename": "src/node_contextify.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_contextify.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_contextify.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.cc?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -767,7 +767,7 @@ void ContextifyScript::CreateCachedData(\n   ContextifyScript* wrapped_script;\n   ASSIGN_OR_RETURN_UNWRAP(&wrapped_script, args.Holder());\n   Local<UnboundScript> unbound_script =\n-      PersistentToLocal(env->isolate(), wrapped_script->script_);\n+      PersistentToLocal::Default(env->isolate(), wrapped_script->script_);\n   std::unique_ptr<ScriptCompiler::CachedData> cached_data(\n       ScriptCompiler::CreateCodeCache(unbound_script));\n   if (!cached_data) {\n@@ -867,7 +867,7 @@ bool ContextifyScript::EvalMachine(Environment* env,\n   ContextifyScript* wrapped_script;\n   ASSIGN_OR_RETURN_UNWRAP(&wrapped_script, args.Holder(), false);\n   Local<UnboundScript> unbound_script =\n-      PersistentToLocal(env->isolate(), wrapped_script->script_);\n+      PersistentToLocal::Default(env->isolate(), wrapped_script->script_);\n   Local<Script> script = unbound_script->BindToCurrentContext();\n \n   MaybeLocal<Value> result;"
        },
        {
            "sha": "68ba2707f8d53b1d17dbf5fdf7a8e47d110be624",
            "filename": "src/node_contextify.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_contextify.h",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_contextify.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_contextify.h?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -40,7 +40,7 @@ class ContextifyContext {\n   }\n \n   inline v8::Local<v8::Context> context() const {\n-    return PersistentToLocal(env()->isolate(), context_);\n+    return PersistentToLocal::Default(env()->isolate(), context_);\n   }\n \n   inline v8::Local<v8::Object> global_proxy() const {"
        },
        {
            "sha": "3c68aea9bbe2784779d46c9cefdfb14b72101083",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -2348,7 +2348,8 @@ int SSLWrap<Base>::TLSExtStatusCallback(SSL* s, void* arg) {\n     if (w->ocsp_response_.IsEmpty())\n       return SSL_TLSEXT_ERR_NOACK;\n \n-    Local<Object> obj = PersistentToLocal(env->isolate(), w->ocsp_response_);\n+    Local<Object> obj = PersistentToLocal::Default(env->isolate(),\n+                                                   w->ocsp_response_);\n     char* resp = Buffer::Data(obj);\n     size_t len = Buffer::Length(obj);\n "
        },
        {
            "sha": "b026a968430808adf30aec0876961daf107e06d1",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -182,14 +182,6 @@ extern std::shared_ptr<PerProcessOptions> per_process_opts;\n // Forward declaration\n class Environment;\n \n-// If persistent.IsWeak() == false, then do not call persistent.Reset()\n-// while the returned Local<T> is still in scope, it will destroy the\n-// reference to the object.\n-template <class TypeName>\n-inline v8::Local<TypeName> PersistentToLocal(\n-    v8::Isolate* isolate,\n-    const Persistent<TypeName>& persistent);\n-\n // Convert a struct sockaddr to a { address: '1.2.3.4', port: 1234 } JS object.\n // Sets address and port properties on the info object and returns it.\n // If |info| is omitted, a new object is returned."
        },
        {
            "sha": "6126ebc6c20fd533cd06a7500cb746a79bcd6659",
            "filename": "src/node_persistent.h",
            "status": "modified",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_persistent.h",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_persistent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_persistent.h?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -23,6 +23,42 @@ struct ResetInDestructorPersistentTraits {\n template <typename T>\n using Persistent = v8::Persistent<T, ResetInDestructorPersistentTraits<T>>;\n \n+class PersistentToLocal {\n+ public:\n+  // If persistent.IsWeak() == false, then do not call persistent.Reset()\n+  // while the returned Local<T> is still in scope, it will destroy the\n+  // reference to the object.\n+  template <class TypeName>\n+  static inline v8::Local<TypeName> Default(\n+      v8::Isolate* isolate,\n+      const Persistent<TypeName>& persistent) {\n+    if (persistent.IsWeak()) {\n+      return PersistentToLocal::Weak(isolate, persistent);\n+    } else {\n+      return PersistentToLocal::Strong(persistent);\n+    }\n+  }\n+\n+  // Unchecked conversion from a non-weak Persistent<T> to Local<T>,\n+  // use with care!\n+  //\n+  // Do not call persistent.Reset() while the returned Local<T> is still in\n+  // scope, it will destroy the reference to the object.\n+  template <class TypeName>\n+  static inline v8::Local<TypeName> Strong(\n+      const Persistent<TypeName>& persistent) {\n+    return *reinterpret_cast<v8::Local<TypeName>*>(\n+        const_cast<Persistent<TypeName>*>(&persistent));\n+  }\n+\n+  template <class TypeName>\n+  static inline v8::Local<TypeName> Weak(\n+      v8::Isolate* isolate,\n+      const Persistent<TypeName>& persistent) {\n+    return v8::Local<TypeName>::New(isolate, persistent);\n+  }\n+};\n+\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        },
        {
            "sha": "f476c554d4477b897013aeda652b0c19f2be05bb",
            "filename": "src/node_zlib.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_zlib.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Fnode_zlib.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_zlib.cc?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -313,8 +313,8 @@ class CompressionStream : public AsyncWrap, public ThreadPoolWork {\n     UpdateWriteResult();\n \n     // call the write() cb\n-    Local<Function> cb = PersistentToLocal(env()->isolate(),\n-                                           write_js_callback_);\n+    Local<Function> cb = PersistentToLocal::Default(env()->isolate(),\n+                                                    write_js_callback_);\n     MakeCallback(cb, 0, nullptr);\n \n     if (pending_close_)"
        },
        {
            "sha": "acd370e235826477f96539d0238b74a20abf07a5",
            "filename": "src/util-inl.h",
            "status": "modified",
            "additions": 0,
            "deletions": 25,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Futil-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Futil-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil-inl.h?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -165,31 +165,6 @@ constexpr ContainerOfHelper<Inner, Outer> ContainerOf(Inner Outer::*field,\n   return ContainerOfHelper<Inner, Outer>(field, pointer);\n }\n \n-template <class TypeName>\n-inline v8::Local<TypeName> PersistentToLocal(\n-    v8::Isolate* isolate,\n-    const Persistent<TypeName>& persistent) {\n-  if (persistent.IsWeak()) {\n-    return WeakPersistentToLocal(isolate, persistent);\n-  } else {\n-    return StrongPersistentToLocal(persistent);\n-  }\n-}\n-\n-template <class TypeName>\n-inline v8::Local<TypeName> StrongPersistentToLocal(\n-    const Persistent<TypeName>& persistent) {\n-  return *reinterpret_cast<v8::Local<TypeName>*>(\n-      const_cast<Persistent<TypeName>*>(&persistent));\n-}\n-\n-template <class TypeName>\n-inline v8::Local<TypeName> WeakPersistentToLocal(\n-    v8::Isolate* isolate,\n-    const Persistent<TypeName>& persistent) {\n-  return v8::Local<TypeName>::New(isolate, persistent);\n-}\n-\n inline v8::Local<v8::String> OneByteString(v8::Isolate* isolate,\n                                            const char* data,\n                                            int length) {"
        },
        {
            "sha": "086e33933e6b5a4246997f3358b2eaf915f44936",
            "filename": "src/util.h",
            "status": "modified",
            "additions": 0,
            "deletions": 22,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Futil.h",
            "raw_url": "https://github.com/nodejs/node/raw/0603c0a53fc7051260f3f3d3de9582bc3e6af7c9/src%2Futil.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Futil.h?ref=0603c0a53fc7051260f3f3d3de9582bc3e6af7c9",
            "patch": "@@ -201,28 +201,6 @@ template <typename Inner, typename Outer>\n constexpr ContainerOfHelper<Inner, Outer> ContainerOf(Inner Outer::*field,\n                                                       Inner* pointer);\n \n-// If persistent.IsWeak() == false, then do not call persistent.Reset()\n-// while the returned Local<T> is still in scope, it will destroy the\n-// reference to the object.\n-template <class TypeName>\n-inline v8::Local<TypeName> PersistentToLocal(\n-    v8::Isolate* isolate,\n-    const Persistent<TypeName>& persistent);\n-\n-// Unchecked conversion from a non-weak Persistent<T> to Local<T>,\n-// use with care!\n-//\n-// Do not call persistent.Reset() while the returned Local<T> is still in\n-// scope, it will destroy the reference to the object.\n-template <class TypeName>\n-inline v8::Local<TypeName> StrongPersistentToLocal(\n-    const Persistent<TypeName>& persistent);\n-\n-template <class TypeName>\n-inline v8::Local<TypeName> WeakPersistentToLocal(\n-    v8::Isolate* isolate,\n-    const Persistent<TypeName>& persistent);\n-\n // Convenience wrapper around v8::String::NewFromOneByte().\n inline v8::Local<v8::String> OneByteString(v8::Isolate* isolate,\n                                            const char* data,"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 50,
        "deletions": 67
    }
}