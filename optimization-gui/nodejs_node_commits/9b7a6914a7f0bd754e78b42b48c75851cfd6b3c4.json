{
    "author": "lpinca",
    "message": "net: emit 'close' after 'end'\n\nCurrently the writable side of the socket is closed as soon as `UV_EOF`\nis read regardless of the state of the socket. This allows the handle\nto be closed before `'end'` is emitted and thus `'close'` can be\nemitted before `'end'` if the socket is paused.\n\nThis commit prevents the handle from being closed until `'end'` is\nemitted ensuring the correct order of events.\n\nPR-URL: https://github.com/nodejs/node/pull/19241\nFixes: https://github.com/nodejs/node/issues/19166\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>",
    "sha": "9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
    "files": [
        {
            "sha": "f97b68d4c4b554c305d1dee28cb3b769722571a4",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 5,
            "deletions": 12,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -373,8 +373,6 @@ function afterShutdown(status, handle) {\n   if (self._readableState.ended) {\n     debug('readableState ended, destroying');\n     self.destroy();\n-  } else {\n-    self.once('_socketEnd', self.destroy);\n   }\n }\n \n@@ -530,6 +528,11 @@ Socket.prototype.end = function(data, encoding, callback) {\n \n // Called when the 'end' event is emitted.\n function onReadableStreamEnd() {\n+  if (!this.allowHalfOpen) {\n+    this.write = writeAfterFIN;\n+    if (this.writable)\n+      this.end();\n+  }\n   maybeDestroy(this);\n }\n \n@@ -649,16 +652,6 @@ function onread(nread, buffer) {\n   // `end` -> `close`\n   self.push(null);\n   self.read(0);\n-\n-  if (!self.allowHalfOpen) {\n-    self.write = writeAfterFIN;\n-    self.destroySoon();\n-  }\n-\n-  // internal end event so that we know that the actual socket\n-  // is no longer readable, and we can start the shutdown\n-  // procedure. No need to wait for all the data to be consumed.\n-  self.emit('_socketEnd');\n }\n \n "
        },
        {
            "sha": "babde351d3f05a5f5c58af4525417e5eb4a1d311",
            "filename": "test/parallel/test-child-process-fork-net2.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-child-process-fork-net2.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-child-process-fork-net2.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-fork-net2.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -130,6 +130,7 @@ if (process.argv[2] === 'child') {\n         console.error('[m] CLIENT: close event');\n         disconnected += 1;\n       });\n+      client.resume();\n     }\n   });\n "
        },
        {
            "sha": "b0b501eacbc5ddf265d6bab1e63064523f0b423e",
            "filename": "test/parallel/test-http2-misbehaving-multiplex.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-http2-misbehaving-multiplex.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-http2-misbehaving-multiplex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-misbehaving-multiplex.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -66,4 +66,5 @@ server.listen(0, () => {\n   // either way if it is, but we don't want to die if it is.\n   client.on('error', () => {});\n   client.on('close', common.mustCall(() => server.close()));\n+  client.resume();\n });"
        },
        {
            "sha": "301cb63dc7031005a1ab3ed13f9480c82b66c06f",
            "filename": "test/parallel/test-https-client-resume.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-https-client-resume.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-https-client-resume.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-https-client-resume.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -79,5 +79,9 @@ server.listen(0, function() {\n       console.log('close2');\n       server.close();\n     });\n+\n+    client2.resume();\n   });\n+\n+  client1.resume();\n });"
        },
        {
            "sha": "fa6b2383b4f317730636971157aa8a97fb52c126",
            "filename": "test/parallel/test-net-bytes-read.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-net-bytes-read.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-net-bytes-read.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-bytes-read.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -32,6 +32,7 @@ const server = net.createServer((socket) => {\n       assert.strictEqual(socket.bytesRead, prev);\n       assert.strictEqual(big.length, prev);\n     }));\n+\n+    socket.end();\n   });\n-  socket.end();\n });"
        },
        {
            "sha": "61de8caab15b56b8db0805007de829437f16d7a5",
            "filename": "test/parallel/test-net-connect-options-path.js",
            "status": "modified",
            "additions": 18,
            "deletions": 12,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-net-connect-options-path.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-net-connect-options-path.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-connect-options-path.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -31,23 +31,29 @@ const CLIENT_VARIANTS = 12;\n     });\n \n     // CLIENT_VARIANTS depends on the following code\n-    net.connect(serverPath, getConnectCb());\n+    net.connect(serverPath, getConnectCb()).resume();\n     net.connect(serverPath)\n-      .on('connect', getConnectCb());\n-    net.createConnection(serverPath, getConnectCb());\n+      .on('connect', getConnectCb())\n+      .resume();\n+    net.createConnection(serverPath, getConnectCb()).resume();\n     net.createConnection(serverPath)\n-      .on('connect', getConnectCb());\n-    new net.Socket().connect(serverPath, getConnectCb());\n+      .on('connect', getConnectCb())\n+      .resume();\n+    new net.Socket().connect(serverPath, getConnectCb()).resume();\n     new net.Socket().connect(serverPath)\n-      .on('connect', getConnectCb());\n-    net.connect({ path: serverPath }, getConnectCb());\n+      .on('connect', getConnectCb())\n+      .resume();\n+    net.connect({ path: serverPath }, getConnectCb()).resume();\n     net.connect({ path: serverPath })\n-      .on('connect', getConnectCb());\n-    net.createConnection({ path: serverPath }, getConnectCb());\n+      .on('connect', getConnectCb())\n+      .resume();\n+    net.createConnection({ path: serverPath }, getConnectCb()).resume();\n     net.createConnection({ path: serverPath })\n-      .on('connect', getConnectCb());\n-    new net.Socket().connect({ path: serverPath }, getConnectCb());\n+      .on('connect', getConnectCb())\n+      .resume();\n+    new net.Socket().connect({ path: serverPath }, getConnectCb()).resume();\n     new net.Socket().connect({ path: serverPath })\n-      .on('connect', getConnectCb());\n+      .on('connect', getConnectCb())\n+      .resume();\n   }));\n }"
        },
        {
            "sha": "db7a123f77b7ad679d3f9d029642298b8312e985",
            "filename": "test/parallel/test-net-connect-options-port.js",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-net-connect-options-port.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-net-connect-options-port.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-connect-options-port.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -102,27 +102,33 @@ const net = require('net');\n function doConnect(args, getCb) {\n   return [\n     function createConnectionWithCb() {\n-      return net.createConnection.apply(net, args.concat(getCb()));\n+      return net.createConnection.apply(net, args.concat(getCb()))\n+        .resume();\n     },\n     function createConnectionWithoutCb() {\n       return net.createConnection.apply(net, args)\n-        .on('connect', getCb());\n+        .on('connect', getCb())\n+        .resume();\n     },\n     function connectWithCb() {\n-      return net.connect.apply(net, args.concat(getCb()));\n+      return net.connect.apply(net, args.concat(getCb()))\n+        .resume();\n     },\n     function connectWithoutCb() {\n       return net.connect.apply(net, args)\n-        .on('connect', getCb());\n+        .on('connect', getCb())\n+        .resume();\n     },\n     function socketConnectWithCb() {\n       const socket = new net.Socket();\n-      return socket.connect.apply(socket, args.concat(getCb()));\n+      return socket.connect.apply(socket, args.concat(getCb()))\n+        .resume();\n     },\n     function socketConnectWithoutCb() {\n       const socket = new net.Socket();\n       return socket.connect.apply(socket, args)\n-        .on('connect', getCb());\n+        .on('connect', getCb())\n+        .resume();\n     }\n   ];\n }"
        },
        {
            "sha": "46084404c87661b6fcf93263534d126c2f445776",
            "filename": "test/parallel/test-net-server-connections-child-null.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-net-server-connections-child-null.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-net-server-connections-child-null.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-server-connections-child-null.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -37,6 +37,8 @@ if (process.argv[2] === 'child') {\n         assert.strictEqual(server.connections, null);\n         server.close();\n       }));\n+\n+      connect.resume();\n     }));\n   });\n "
        },
        {
            "sha": "06bf55f89d6e506c509a99765585d7c161a4e71b",
            "filename": "test/parallel/test-net-socket-close-after-end.js",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-net-socket-close-after-end.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-net-socket-close-after-end.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-socket-close-after-end.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -0,0 +1,31 @@\n+'use strict';\n+const common = require('../common');\n+\n+const assert = require('assert');\n+const net = require('net');\n+\n+const server = net.createServer();\n+\n+server.on('connection', (socket) => {\n+  let endEmitted = false;\n+\n+  socket.once('readable', () => {\n+    setTimeout(() => {\n+      socket.read();\n+    }, common.platformTimeout(100));\n+  });\n+  socket.on('end', () => {\n+    endEmitted = true;\n+  });\n+  socket.on('close', () => {\n+    assert(endEmitted);\n+    server.close();\n+  });\n+  socket.end('foo');\n+});\n+\n+server.listen(common.mustCall(() => {\n+  const socket = net.createConnection(server.address().port, () => {\n+    socket.end('foo');\n+  });\n+}));"
        },
        {
            "sha": "296df88e9f91528e2ba8557414636875f501f072",
            "filename": "test/parallel/test-tls-client-resume.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-tls-client-resume.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-tls-client-resume.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-client-resume.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -73,5 +73,9 @@ server.listen(0, function() {\n       console.log('close2');\n       server.close();\n     });\n+\n+    client2.resume();\n   });\n+\n+  client1.resume();\n });"
        },
        {
            "sha": "70f98f33e4f2b27a5d9a0a2a2798156f2785c708",
            "filename": "test/parallel/test-tls-interleave.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-tls-interleave.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-tls-interleave.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-interleave.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -42,6 +42,7 @@ const writes = [\n let receivedWrites = 0;\n \n const server = tls.createServer(options, function(c) {\n+  c.resume();\n   writes.forEach(function(str) {\n     c.write(str);\n   });"
        },
        {
            "sha": "a36016efa48a0241710f454bb24dc94f99eed484",
            "filename": "test/parallel/test-tls-tlswrap-segfault.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-tls-tlswrap-segfault.js",
            "raw_url": "https://github.com/nodejs/node/raw/9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4/test%2Fparallel%2Ftest-tls-tlswrap-segfault.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-tlswrap-segfault.js?ref=9b7a6914a7f0bd754e78b42b48c75851cfd6b3c4",
            "patch": "@@ -26,6 +26,7 @@ const server = tls.createServer(options, function(s) {\n   const client = tls.connect(opts, function() {\n     putImmediate(client);\n   });\n+  client.resume();\n });\n \n function putImmediate(client) {"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 82,
        "deletions": 31
    }
}