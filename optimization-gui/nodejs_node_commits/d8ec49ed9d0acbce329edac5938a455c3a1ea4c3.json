{
    "author": "kjin",
    "message": "src: update trace event macros to v8 6.4 version\n\nPR-URL: https://github.com/nodejs/node/pull/17640\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "d8ec49ed9d0acbce329edac5938a455c3a1ea4c3",
    "files": [
        {
            "sha": "4aac9e5543eb675d7e794b0a371dc004ed623dcd",
            "filename": "src/tracing/trace_event.h",
            "status": "modified",
            "additions": 92,
            "deletions": 5,
            "changes": 97,
            "blob_url": "https://github.com/nodejs/node/blob/d8ec49ed9d0acbce329edac5938a455c3a1ea4c3/src%2Ftracing%2Ftrace_event.h",
            "raw_url": "https://github.com/nodejs/node/raw/d8ec49ed9d0acbce329edac5938a455c3a1ea4c3/src%2Ftracing%2Ftrace_event.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Ftrace_event.h?ref=d8ec49ed9d0acbce329edac5938a455c3a1ea4c3",
            "patch": "@@ -92,6 +92,23 @@ enum CategoryGroupEnabledFlags {\n //                    unsigned int flags)\n #define TRACE_EVENT_API_ADD_TRACE_EVENT node::tracing::AddTraceEventImpl\n \n+// Add a trace event to the platform tracing system.\n+// uint64_t TRACE_EVENT_API_ADD_TRACE_EVENT_WITH_TIMESTAMP(\n+//                    char phase,\n+//                    const uint8_t* category_group_enabled,\n+//                    const char* name,\n+//                    const char* scope,\n+//                    uint64_t id,\n+//                    uint64_t bind_id,\n+//                    int num_args,\n+//                    const char** arg_names,\n+//                    const uint8_t* arg_types,\n+//                    const uint64_t* arg_values,\n+//                    unsigned int flags,\n+//                    int64_t timestamp)\n+#define TRACE_EVENT_API_ADD_TRACE_EVENT_WITH_TIMESTAMP \\\n+  node::tracing::AddTraceEventWithTimestampImpl\n+\n // Set the duration field of a COMPLETE trace event.\n // void TRACE_EVENT_API_UPDATE_TRACE_EVENT_DURATION(\n //     const uint8_t* category_group_enabled,\n@@ -207,10 +224,18 @@ enum CategoryGroupEnabledFlags {\n     }                                                                          \\\n   } while (0)\n \n-// Adds a trace event with a given timestamp. Not Implemented.\n+// Adds a trace event with a given timestamp.\n #define INTERNAL_TRACE_EVENT_ADD_WITH_TIMESTAMP(phase, category_group, name, \\\n                                                 timestamp, flags, ...)       \\\n-  UNIMPLEMENTED()\n+  do {                                                                       \\\n+    INTERNAL_TRACE_EVENT_GET_CATEGORY_INFO(category_group);                  \\\n+    if (INTERNAL_TRACE_EVENT_CATEGORY_GROUP_ENABLED_FOR_RECORDING_MODE()) {  \\\n+      node::tracing::AddTraceEventWithTimestamp(                     \\\n+          phase, INTERNAL_TRACE_EVENT_UID(category_group_enabled), name,     \\\n+          node::tracing::kGlobalScope, node::tracing::kNoId, \\\n+          node::tracing::kNoId, flags, timestamp, ##__VA_ARGS__);    \\\n+    }                                                                        \\\n+  } while (0)\n \n // Adds a trace event with a given id and timestamp. Not Implemented.\n #define INTERNAL_TRACE_EVENT_ADD_WITH_ID_AND_TIMESTAMP(     \\\n@@ -253,8 +278,6 @@ const int kZeroNumArgs = 0;\n const decltype(nullptr) kGlobalScope = nullptr;\n const uint64_t kNoId = 0;\n \n-extern intptr_t kRuntimeCallStatsTracingEnabled;\n-\n class TraceEventHelper {\n  public:\n   static v8::TracingController* GetTracingController();\n@@ -404,14 +427,36 @@ static inline uint64_t AddTraceEventImpl(\n     arg_convertibles[1].reset(reinterpret_cast<v8::ConvertableToTraceFormat*>(\n         static_cast<intptr_t>(arg_values[1])));\n   }\n-  // DCHECK(num_args <= 2);\n+  // DCHECK(num_args, 2);\n   v8::TracingController* controller =\n       node::tracing::TraceEventHelper::GetTracingController();\n   return controller->AddTraceEvent(phase, category_group_enabled, name, scope, id,\n                                    bind_id, num_args, arg_names, arg_types,\n                                    arg_values, arg_convertibles, flags);\n }\n \n+static V8_INLINE uint64_t AddTraceEventWithTimestampImpl(\n+    char phase, const uint8_t* category_group_enabled, const char* name,\n+    const char* scope, uint64_t id, uint64_t bind_id, int32_t num_args,\n+    const char** arg_names, const uint8_t* arg_types,\n+    const uint64_t* arg_values, unsigned int flags, int64_t timestamp) {\n+  std::unique_ptr<v8::ConvertableToTraceFormat> arg_convertables[2];\n+  if (num_args > 0 && arg_types[0] == TRACE_VALUE_TYPE_CONVERTABLE) {\n+    arg_convertables[0].reset(reinterpret_cast<v8::ConvertableToTraceFormat*>(\n+        static_cast<intptr_t>(arg_values[0])));\n+  }\n+  if (num_args > 1 && arg_types[1] == TRACE_VALUE_TYPE_CONVERTABLE) {\n+    arg_convertables[1].reset(reinterpret_cast<v8::ConvertableToTraceFormat*>(\n+        static_cast<intptr_t>(arg_values[1])));\n+  }\n+  // DCHECK_LE(num_args, 2);\n+  v8::TracingController* controller =\n+      node::tracing::TraceEventHelper::GetTracingController();\n+  return controller->AddTraceEventWithTimestamp(\n+      phase, category_group_enabled, name, scope, id, bind_id, num_args,\n+      arg_names, arg_types, arg_values, arg_convertables, flags, timestamp);\n+}\n+\n // Define SetTraceValue for each allowed type. It stores the type and\n // value in the return arguments. This allows this API to avoid declaring any\n // structures so that it is portable to third_party libraries.\n@@ -514,6 +559,48 @@ static inline uint64_t AddTraceEvent(\n       arg_names, arg_types, arg_values, flags);\n }\n \n+static V8_INLINE uint64_t AddTraceEventWithTimestamp(\n+    char phase, const uint8_t* category_group_enabled, const char* name,\n+    const char* scope, uint64_t id, uint64_t bind_id, unsigned int flags,\n+    int64_t timestamp) {\n+  return TRACE_EVENT_API_ADD_TRACE_EVENT_WITH_TIMESTAMP(\n+      phase, category_group_enabled, name, scope, id, bind_id, kZeroNumArgs,\n+      nullptr, nullptr, nullptr, flags, timestamp);\n+}\n+\n+template <class ARG1_TYPE>\n+static V8_INLINE uint64_t AddTraceEventWithTimestamp(\n+    char phase, const uint8_t* category_group_enabled, const char* name,\n+    const char* scope, uint64_t id, uint64_t bind_id, unsigned int flags,\n+    int64_t timestamp, const char* arg1_name, ARG1_TYPE&& arg1_val) {\n+  const int num_args = 1;\n+  uint8_t arg_type;\n+  uint64_t arg_value;\n+  SetTraceValue(std::forward<ARG1_TYPE>(arg1_val), &arg_type, &arg_value);\n+  return TRACE_EVENT_API_ADD_TRACE_EVENT_WITH_TIMESTAMP(\n+      phase, category_group_enabled, name, scope, id, bind_id, num_args,\n+      &arg1_name, &arg_type, &arg_value, flags, timestamp);\n+}\n+\n+template <class ARG1_TYPE, class ARG2_TYPE>\n+static V8_INLINE uint64_t AddTraceEventWithTimestamp(\n+    char phase, const uint8_t* category_group_enabled, const char* name,\n+    const char* scope, uint64_t id, uint64_t bind_id, unsigned int flags,\n+    int64_t timestamp, const char* arg1_name, ARG1_TYPE&& arg1_val,\n+    const char* arg2_name, ARG2_TYPE&& arg2_val) {\n+  const int num_args = 2;\n+  const char* arg_names[2] = {arg1_name, arg2_name};\n+  unsigned char arg_types[2];\n+  uint64_t arg_values[2];\n+  SetTraceValue(std::forward<ARG1_TYPE>(arg1_val), &arg_types[0],\n+                &arg_values[0]);\n+  SetTraceValue(std::forward<ARG2_TYPE>(arg2_val), &arg_types[1],\n+                &arg_values[1]);\n+  return TRACE_EVENT_API_ADD_TRACE_EVENT_WITH_TIMESTAMP(\n+      phase, category_group_enabled, name, scope, id, bind_id, num_args,\n+      arg_names, arg_types, arg_values, flags, timestamp);\n+}\n+\n // Used by TRACE_EVENTx macros. Do not use directly.\n class ScopedTracer {\n  public:"
        },
        {
            "sha": "51869ee9525614bab10e1fda7021fc067b64f6c2",
            "filename": "src/tracing/trace_event_common.h",
            "status": "modified",
            "additions": 25,
            "deletions": 2,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/d8ec49ed9d0acbce329edac5938a455c3a1ea4c3/src%2Ftracing%2Ftrace_event_common.h",
            "raw_url": "https://github.com/nodejs/node/raw/d8ec49ed9d0acbce329edac5938a455c3a1ea4c3/src%2Ftracing%2Ftrace_event_common.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Ftrace_event_common.h?ref=d8ec49ed9d0acbce329edac5938a455c3a1ea4c3",
            "patch": "@@ -189,6 +189,8 @@\n // trace points would carry a significant performance cost of acquiring a lock\n // and resolving the category.\n \n+// Check that nobody includes this file directly.  Clients are supposed to\n+// include the surrounding \"trace_event.h\" of their project instead.\n #if defined(TRACE_EVENT0)\n #error \"Another copy of this file has already been included.\"\n #endif\n@@ -258,6 +260,12 @@\n       TRACE_EVENT_PHASE_INSTANT, category_group, name, timestamp,        \\\n       TRACE_EVENT_FLAG_NONE | scope)\n \n+#define TRACE_EVENT_INSTANT_WITH_TIMESTAMP1(category_group, name, scope,  \\\n+                                            timestamp, arg_name, arg_val) \\\n+  INTERNAL_TRACE_EVENT_ADD_WITH_TIMESTAMP(                                \\\n+      TRACE_EVENT_PHASE_INSTANT, category_group, name, timestamp,         \\\n+      TRACE_EVENT_FLAG_NONE | scope, arg_name, arg_val)\n+\n // Records a single BEGIN event called \"name\" immediately, with 0, 1 or 2\n // associated arguments. If the category is not enabled, then this\n // does nothing.\n@@ -353,6 +361,12 @@\n       TRACE_EVENT_PHASE_MARK, category_group, name, timestamp,            \\\n       TRACE_EVENT_FLAG_NONE, arg1_name, arg1_val)\n \n+#define TRACE_EVENT_MARK_WITH_TIMESTAMP2(                                      \\\n+    category_group, name, timestamp, arg1_name, arg1_val, arg2_name, arg2_val) \\\n+  INTERNAL_TRACE_EVENT_ADD_WITH_TIMESTAMP(                                     \\\n+      TRACE_EVENT_PHASE_MARK, category_group, name, timestamp,                 \\\n+      TRACE_EVENT_FLAG_NONE, arg1_name, arg1_val, arg2_name, arg2_val)\n+\n #define TRACE_EVENT_COPY_MARK(category_group, name)                      \\\n   INTERNAL_TRACE_EVENT_ADD(TRACE_EVENT_PHASE_MARK, category_group, name, \\\n                            TRACE_EVENT_FLAG_COPY)\n@@ -771,13 +785,22 @@\n   INTERNAL_TRACE_EVENT_ADD_WITH_ID_TID_AND_TIMESTAMP(                          \\\n       TRACE_EVENT_PHASE_NESTABLE_ASYNC_BEGIN, category_group, name, id,        \\\n       TRACE_EVENT_API_CURRENT_THREAD_ID, timestamp, TRACE_EVENT_FLAG_NONE)\n-\n #define TRACE_EVENT_NESTABLE_ASYNC_END_WITH_TIMESTAMP0(category_group, name, \\\n                                                        id, timestamp)        \\\n   INTERNAL_TRACE_EVENT_ADD_WITH_ID_TID_AND_TIMESTAMP(                        \\\n       TRACE_EVENT_PHASE_NESTABLE_ASYNC_END, category_group, name, id,        \\\n       TRACE_EVENT_API_CURRENT_THREAD_ID, timestamp, TRACE_EVENT_FLAG_NONE)\n-\n+#define TRACE_EVENT_NESTABLE_ASYNC_END_WITH_TIMESTAMP1(                    \\\n+    category_group, name, id, timestamp, arg1_name, arg1_val)              \\\n+  INTERNAL_TRACE_EVENT_ADD_WITH_ID_TID_AND_TIMESTAMP(                      \\\n+      TRACE_EVENT_PHASE_NESTABLE_ASYNC_END, category_group, name, id,      \\\n+      TRACE_EVENT_API_CURRENT_THREAD_ID, timestamp, TRACE_EVENT_FLAG_NONE, \\\n+      arg1_name, arg1_val)\n+#define TRACE_EVENT_NESTABLE_ASYNC_INSTANT_WITH_TIMESTAMP0(               \\\n+    category_group, name, id, timestamp)                                  \\\n+  INTERNAL_TRACE_EVENT_ADD_WITH_ID_TID_AND_TIMESTAMP(                     \\\n+      TRACE_EVENT_PHASE_NESTABLE_ASYNC_INSTANT, category_group, name, id, \\\n+      TRACE_EVENT_API_CURRENT_THREAD_ID, timestamp, TRACE_EVENT_FLAG_NONE)\n #define TRACE_EVENT_COPY_NESTABLE_ASYNC_BEGIN_WITH_TIMESTAMP0(          \\\n     category_group, name, id, timestamp)                                \\\n   INTERNAL_TRACE_EVENT_ADD_WITH_ID_TID_AND_TIMESTAMP(                   \\"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 117,
        "deletions": 7
    }
}