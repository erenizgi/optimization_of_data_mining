{
    "author": "joyeecheung",
    "message": "process: group main thread execution preparation code\n\nThis patch groups the preparation of main thread execution into\n`prepareMainThreadExecution()` and removes the cluster IPC\nsetup in worker thread bootstrap since clusters do not use\nworker threads for its implementation and it's unlikely to change.\n\nPR-URL: https://github.com/nodejs/node/pull/26000\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>",
    "sha": "84000835e2be2e5b1936d774ed4c4a0106c966a4",
    "files": [
        {
            "sha": "2585fff206d02590daba142c9aae6636fd5da611",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 0,
            "deletions": 25,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=84000835e2be2e5b1936d774ed4c4a0106c966a4",
            "patch": "@@ -176,31 +176,6 @@ if (config.hasInspector) {\n   internalBinding('inspector').registerAsyncHook(enable, disable);\n }\n \n-// If the process is spawned with env NODE_CHANNEL_FD, it's probably\n-// spawned by our child_process module, then initialize IPC.\n-// This attaches some internal event listeners and creates:\n-// process.send(), process.channel, process.connected,\n-// process.disconnect()\n-if (process.env.NODE_CHANNEL_FD) {\n-  if (ownsProcessState) {\n-    mainThreadSetup.setupChildProcessIpcChannel();\n-  } else {\n-    Object.defineProperty(process, 'channel', {\n-      enumerable: false,\n-      get: workerThreadSetup.unavailable('process.channel')\n-    });\n-\n-    Object.defineProperty(process, 'connected', {\n-      enumerable: false,\n-      get: workerThreadSetup.unavailable('process.connected')\n-    });\n-\n-    process.send = workerThreadSetup.unavailable('process.send()');\n-    process.disconnect =\n-      workerThreadSetup.unavailable('process.disconnect()');\n-  }\n-}\n-\n const browserGlobals = !process._noBrowserGlobals;\n if (browserGlobals) {\n   setupGlobalTimeouts();"
        },
        {
            "sha": "ce4af115badaab6ca2dcd428236ac13e3eaf0a61",
            "filename": "lib/internal/bootstrap/pre_execution.js",
            "status": "modified",
            "additions": 37,
            "deletions": 5,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "raw_url": "https://github.com/nodejs/node/raw/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fpre_execution.js?ref=84000835e2be2e5b1936d774ed4c4a0106c966a4",
            "patch": "@@ -2,6 +2,27 @@\n \n const { getOptionValue } = require('internal/options');\n \n+function prepareMainThreadExecution() {\n+  // If the process is spawned with env NODE_CHANNEL_FD, it's probably\n+  // spawned by our child_process module, then initialize IPC.\n+  // This attaches some internal event listeners and creates:\n+  // process.send(), process.channel, process.connected,\n+  // process.disconnect().\n+  setupChildProcessIpcChannel();\n+\n+  // Load policy from disk and parse it.\n+  initializePolicy();\n+\n+  // If this is a worker in cluster mode, start up the communication\n+  // channel. This needs to be done before any user code gets executed\n+  // (including preload modules).\n+  initializeClusterIPC();\n+\n+  initializeDeprecations();\n+  initializeESMLoader();\n+  loadPreloadModules();\n+}\n+\n // In general deprecations are intialized wherever the APIs are implemented,\n // this is used to deprecate APIs implemented in C++ where the deprecation\n // utitlities are not easily accessible.\n@@ -41,10 +62,22 @@ function initializeDeprecations() {\n   }\n }\n \n+function setupChildProcessIpcChannel() {\n+  if (process.env.NODE_CHANNEL_FD) {\n+    const assert = require('internal/assert');\n+\n+    const fd = parseInt(process.env.NODE_CHANNEL_FD, 10);\n+    assert(fd >= 0);\n+\n+    // Make sure it's not accidentally inherited by child processes.\n+    delete process.env.NODE_CHANNEL_FD;\n+\n+    require('child_process')._forkChild(fd);\n+    assert(process.send);\n+  }\n+}\n+\n function initializeClusterIPC() {\n-  // If this is a worker in cluster mode, start up the communication\n-  // channel. This needs to be done before any user code gets executed\n-  // (including preload modules).\n   if (process.argv[1] && process.env.NODE_UNIQUE_ID) {\n     const cluster = require('cluster');\n     cluster._setupWorker();\n@@ -114,9 +147,8 @@ function loadPreloadModules() {\n }\n \n module.exports = {\n+  prepareMainThreadExecution,\n   initializeDeprecations,\n-  initializeClusterIPC,\n-  initializePolicy,\n   initializeESMLoader,\n   loadPreloadModules\n };"
        },
        {
            "sha": "5d98701132f0e8d560486f5c9421525293d38546",
            "filename": "lib/internal/main/check_syntax.js",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Fcheck_syntax.js",
            "raw_url": "https://github.com/nodejs/node/raw/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Fcheck_syntax.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fcheck_syntax.js?ref=84000835e2be2e5b1936d774ed4c4a0106c966a4",
            "patch": "@@ -4,11 +4,7 @@\n // instead of actually running the file.\n \n const {\n-  initializeDeprecations,\n-  initializeClusterIPC,\n-  initializePolicy,\n-  initializeESMLoader,\n-  loadPreloadModules\n+  prepareMainThreadExecution\n } = require('internal/bootstrap/pre_execution');\n \n const {\n@@ -22,11 +18,7 @@ const {\n } = require('internal/modules/cjs/helpers');\n \n // TODO(joyeecheung): not every one of these are necessary\n-initializeDeprecations();\n-initializeClusterIPC();\n-initializePolicy();\n-initializeESMLoader();\n-loadPreloadModules();\n+prepareMainThreadExecution();\n markBootstrapComplete();\n \n if (process.argv[1] && process.argv[1] !== '-') {"
        },
        {
            "sha": "2a2ef6d38a1fe8fea837bc7739fc66ce4edbaae2",
            "filename": "lib/internal/main/eval_stdin.js",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Feval_stdin.js",
            "raw_url": "https://github.com/nodejs/node/raw/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Feval_stdin.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Feval_stdin.js?ref=84000835e2be2e5b1936d774ed4c4a0106c966a4",
            "patch": "@@ -3,23 +3,15 @@\n // Stdin is not a TTY, we will read it and execute it.\n \n const {\n-  initializeDeprecations,\n-  initializeClusterIPC,\n-  initializePolicy,\n-  initializeESMLoader,\n-  loadPreloadModules\n+  prepareMainThreadExecution\n } = require('internal/bootstrap/pre_execution');\n \n const {\n   evalScript,\n   readStdin\n } = require('internal/process/execution');\n \n-initializeDeprecations();\n-initializeClusterIPC();\n-initializePolicy();\n-initializeESMLoader();\n-loadPreloadModules();\n+prepareMainThreadExecution();\n markBootstrapComplete();\n \n readStdin((code) => {"
        },
        {
            "sha": "953fab386d067198b821c7b9de3cc3b42e849ee2",
            "filename": "lib/internal/main/eval_string.js",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Feval_string.js",
            "raw_url": "https://github.com/nodejs/node/raw/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Feval_string.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Feval_string.js?ref=84000835e2be2e5b1936d774ed4c4a0106c966a4",
            "patch": "@@ -4,21 +4,13 @@\n // `--interactive`.\n \n const {\n-  initializeDeprecations,\n-  initializeClusterIPC,\n-  initializePolicy,\n-  initializeESMLoader,\n-  loadPreloadModules\n+  prepareMainThreadExecution\n } = require('internal/bootstrap/pre_execution');\n const { evalScript } = require('internal/process/execution');\n const { addBuiltinLibsToObject } = require('internal/modules/cjs/helpers');\n \n const source = require('internal/options').getOptionValue('--eval');\n-initializeDeprecations();\n-initializeClusterIPC();\n-initializePolicy();\n-initializeESMLoader();\n-loadPreloadModules();\n+prepareMainThreadExecution();\n addBuiltinLibsToObject(global);\n markBootstrapComplete();\n evalScript('[eval]', source, process._breakFirstLine);"
        },
        {
            "sha": "e6b98853511d11d31e911e15afaa715a24f147d9",
            "filename": "lib/internal/main/repl.js",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Frepl.js?ref=84000835e2be2e5b1936d774ed4c4a0106c966a4",
            "patch": "@@ -4,22 +4,14 @@\n // the main module is not specified and stdin is a TTY.\n \n const {\n-  initializeDeprecations,\n-  initializeClusterIPC,\n-  initializePolicy,\n-  initializeESMLoader,\n-  loadPreloadModules\n+  prepareMainThreadExecution\n } = require('internal/bootstrap/pre_execution');\n \n const {\n   evalScript\n } = require('internal/process/execution');\n \n-initializeDeprecations();\n-initializeClusterIPC();\n-initializePolicy();\n-initializeESMLoader();\n-loadPreloadModules();\n+prepareMainThreadExecution();\n \n const cliRepl = require('internal/repl');\n cliRepl.createInternalRepl(process.env, (err, repl) => {"
        },
        {
            "sha": "97a4e33be2e6296fb86a4aead49bf2d26bf28658",
            "filename": "lib/internal/main/run_main_module.js",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Frun_main_module.js",
            "raw_url": "https://github.com/nodejs/node/raw/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Frun_main_module.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Frun_main_module.js?ref=84000835e2be2e5b1936d774ed4c4a0106c966a4",
            "patch": "@@ -1,18 +1,10 @@\n 'use strict';\n \n const {\n-  initializeDeprecations,\n-  initializeClusterIPC,\n-  initializePolicy,\n-  initializeESMLoader,\n-  loadPreloadModules\n+  prepareMainThreadExecution\n } = require('internal/bootstrap/pre_execution');\n \n-initializeDeprecations();\n-initializeClusterIPC();\n-initializePolicy();\n-initializeESMLoader();\n-loadPreloadModules();\n+prepareMainThreadExecution();\n \n // Expand process.argv[1] into a full path.\n const path = require('path');"
        },
        {
            "sha": "ac161b7588f04cab7971c7b0dd512448d7714092",
            "filename": "lib/internal/main/worker_thread.js",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Fworker_thread.js",
            "raw_url": "https://github.com/nodejs/node/raw/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fmain%2Fworker_thread.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fworker_thread.js?ref=84000835e2be2e5b1936d774ed4c4a0106c966a4",
            "patch": "@@ -5,7 +5,6 @@\n \n const {\n   initializeDeprecations,\n-  initializeClusterIPC,\n   initializeESMLoader,\n   loadPreloadModules\n } = require('internal/bootstrap/pre_execution');\n@@ -42,6 +41,26 @@ debug(`[${threadId}] is setting up worker child environment`);\n // Set up the message port and start listening\n const port = getEnvMessagePort();\n \n+// If the main thread is spawned with env NODE_CHANNEL_FD, it's probably\n+// spawned by our child_process module. In the work threads, mark the\n+// related IPC properties as unavailable.\n+if (process.env.NODE_CHANNEL_FD) {\n+  const workerThreadSetup = require('internal/process/worker_thread_only');\n+  Object.defineProperty(process, 'channel', {\n+    enumerable: false,\n+    get: workerThreadSetup.unavailable('process.channel')\n+  });\n+\n+  Object.defineProperty(process, 'connected', {\n+    enumerable: false,\n+    get: workerThreadSetup.unavailable('process.connected')\n+  });\n+\n+  process.send = workerThreadSetup.unavailable('process.send()');\n+  process.disconnect =\n+    workerThreadSetup.unavailable('process.disconnect()');\n+}\n+\n port.on('message', (message) => {\n   if (message.type === LOAD_SCRIPT) {\n     const {\n@@ -57,7 +76,6 @@ port.on('message', (message) => {\n       require('internal/process/policy').setup(manifestSrc, manifestURL);\n     }\n     initializeDeprecations();\n-    initializeClusterIPC();\n     initializeESMLoader();\n     loadPreloadModules();\n     publicWorker.parentPort = publicPort;"
        },
        {
            "sha": "96c57fda35c755a1fb2fed30c872f2b91e7f2d2d",
            "filename": "lib/internal/process/main_thread_only.js",
            "status": "modified",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/84000835e2be2e5b1936d774ed4c4a0106c966a4/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fmain_thread_only.js?ref=84000835e2be2e5b1936d774ed4c4a0106c966a4",
            "patch": "@@ -152,22 +152,8 @@ function createSignalHandlers() {\n   };\n }\n \n-function setupChildProcessIpcChannel() {\n-  const assert = require('internal/assert');\n-\n-  const fd = parseInt(process.env.NODE_CHANNEL_FD, 10);\n-  assert(fd >= 0);\n-\n-  // Make sure it's not accidentally inherited by child processes.\n-  delete process.env.NODE_CHANNEL_FD;\n-\n-  require('child_process')._forkChild(fd);\n-  assert(process.send);\n-}\n-\n module.exports = {\n   wrapProcessMethods,\n   createSignalHandlers,\n-  setupChildProcessIpcChannel,\n   wrapPosixCredentialSetters\n };"
        }
    ],
    "stats": {
        "total": 163,
        "additions": 67,
        "deletions": 96
    }
}