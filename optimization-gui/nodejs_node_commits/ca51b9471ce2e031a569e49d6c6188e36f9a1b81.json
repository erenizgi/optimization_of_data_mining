{
    "author": "joyeecheung",
    "message": "benchmark: add dir and withFileTypes option readdir benchmarks\n\nPR-URL: https://github.com/nodejs/node/pull/24125\nRefs: https://github.com/v8/v8/commit/0483e9a9abe77a73632fd85b9c0cd608efa9aa0d\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Yang Guo <yangguo@chromium.org>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "ca51b9471ce2e031a569e49d6c6188e36f9a1b81",
    "files": [
        {
            "sha": "0d8ed04856515f6c0b56166f8d4f04b542bc20ab",
            "filename": "benchmark/fs/bench-readdir.js",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/ca51b9471ce2e031a569e49d6c6188e36f9a1b81/benchmark%2Ffs%2Fbench-readdir.js",
            "raw_url": "https://github.com/nodejs/node/raw/ca51b9471ce2e031a569e49d6c6188e36f9a1b81/benchmark%2Ffs%2Fbench-readdir.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Ffs%2Fbench-readdir.js?ref=ca51b9471ce2e031a569e49d6c6188e36f9a1b81",
            "patch": "@@ -5,16 +5,19 @@ const fs = require('fs');\n const path = require('path');\n \n const bench = common.createBenchmark(main, {\n-  n: [1e4],\n+  n: [10],\n+  dir: [ 'lib', 'test/parallel'],\n+  withFileTypes: ['true', 'false']\n });\n \n-\n-function main({ n }) {\n+function main({ n, dir, withFileTypes }) {\n+  withFileTypes = withFileTypes === 'true';\n+  const fullPath = path.resolve(__dirname, '../../', dir);\n   bench.start();\n   (function r(cntr) {\n     if (cntr-- <= 0)\n       return bench.end(n);\n-    fs.readdir(path.resolve(__dirname, '../../lib/'), function() {\n+    fs.readdir(fullPath, { withFileTypes }, function() {\n       r(cntr);\n     });\n   }(n));"
        },
        {
            "sha": "5d0e97399a33ffab08aaa09d669fa6cf71fed837",
            "filename": "benchmark/fs/bench-readdirSync.js",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/ca51b9471ce2e031a569e49d6c6188e36f9a1b81/benchmark%2Ffs%2Fbench-readdirSync.js",
            "raw_url": "https://github.com/nodejs/node/raw/ca51b9471ce2e031a569e49d6c6188e36f9a1b81/benchmark%2Ffs%2Fbench-readdirSync.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Ffs%2Fbench-readdirSync.js?ref=ca51b9471ce2e031a569e49d6c6188e36f9a1b81",
            "patch": "@@ -5,14 +5,18 @@ const fs = require('fs');\n const path = require('path');\n \n const bench = common.createBenchmark(main, {\n-  n: [1e4],\n+  n: [10],\n+  dir: [ 'lib', 'test/parallel'],\n+  withFileTypes: ['true', 'false']\n });\n \n \n-function main({ n }) {\n+function main({ n, dir, withFileTypes }) {\n+  withFileTypes = withFileTypes === 'true';\n+  const fullPath = path.resolve(__dirname, '../../', dir);\n   bench.start();\n   for (var i = 0; i < n; i++) {\n-    fs.readdirSync(path.resolve(__dirname, '../../lib/'));\n+    fs.readdirSync(fullPath, { withFileTypes });\n   }\n   bench.end(n);\n }"
        },
        {
            "sha": "fc826ffe6920a6b7deaf6f8d3fa1be6b34094617",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 53,
            "changes": 64,
            "blob_url": "https://github.com/nodejs/node/blob/ca51b9471ce2e031a569e49d6c6188e36f9a1b81/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/ca51b9471ce2e031a569e49d6c6188e36f9a1b81/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=ca51b9471ce2e031a569e49d6c6188e36f9a1b81",
            "patch": "@@ -571,7 +571,7 @@ void AfterScanDir(uv_fs_t* req) {\n   Environment* env = req_wrap->env();\n   Local<Value> error;\n   int r;\n-  std::vector<Local<Value>> name_argv;\n+  std::vector<Local<Value>> name_v;\n \n   for (int i = 0; ; i++) {\n     uv_dirent_t ent;\n@@ -593,12 +593,10 @@ void AfterScanDir(uv_fs_t* req) {\n     if (filename.IsEmpty())\n       return req_wrap->Reject(error);\n \n-    name_argv.push_back(filename.ToLocalChecked());\n+    name_v.push_back(filename.ToLocalChecked());\n   }\n \n-  Local<Array> names =\n-      Array::New(env->isolate(), name_argv.data(), name_argv.size());\n-  req_wrap->Resolve(names);\n+  req_wrap->Resolve(Array::New(env->isolate(), name_v.data(), name_v.size()));\n }\n \n void AfterScanDirWithTypes(uv_fs_t* req) {\n@@ -613,13 +611,9 @@ void AfterScanDirWithTypes(uv_fs_t* req) {\n   Isolate* isolate = env->isolate();\n   Local<Value> error;\n   int r;\n-  Local<Array> names = Array::New(isolate, 0);\n-  Local<Function> fn = env->push_values_to_array_function();\n-  Local<Value> name_argv[NODE_PUSH_VAL_TO_ARRAY_MAX];\n-  size_t name_idx = 0;\n-  Local<Value> types = Array::New(isolate, 0);\n-  Local<Value> type_argv[NODE_PUSH_VAL_TO_ARRAY_MAX];\n-  size_t type_idx = 0;\n+\n+  std::vector<Local<Value>> name_v;\n+  std::vector<Local<Value>> type_v;\n \n   for (int i = 0; ; i++) {\n     uv_dirent_t ent;\n@@ -641,48 +635,13 @@ void AfterScanDirWithTypes(uv_fs_t* req) {\n     if (filename.IsEmpty())\n       return req_wrap->Reject(error);\n \n-    name_argv[name_idx++] = filename.ToLocalChecked();\n-\n-    if (name_idx >= arraysize(name_argv)) {\n-      MaybeLocal<Value> ret = fn->Call(env->context(), names, name_idx,\n-                                       name_argv);\n-      if (ret.IsEmpty()) {\n-        return;\n-      }\n-      name_idx = 0;\n-    }\n-\n-    type_argv[type_idx++] = Integer::New(isolate, ent.type);\n-\n-    if (type_idx >= arraysize(type_argv)) {\n-      MaybeLocal<Value> ret = fn->Call(env->context(), types, type_idx,\n-          type_argv);\n-      if (ret.IsEmpty()) {\n-        return;\n-      }\n-      type_idx = 0;\n-    }\n-  }\n-\n-  if (name_idx > 0) {\n-    MaybeLocal<Value> ret = fn->Call(env->context(), names, name_idx,\n-        name_argv);\n-    if (ret.IsEmpty()) {\n-      return;\n-    }\n-  }\n-\n-  if (type_idx > 0) {\n-    MaybeLocal<Value> ret = fn->Call(env->context(), types, type_idx,\n-        type_argv);\n-    if (ret.IsEmpty()) {\n-      return;\n-    }\n+    name_v.push_back(filename.ToLocalChecked());\n+    type_v.push_back(Integer::New(isolate, ent.type));\n   }\n \n   Local<Array> result = Array::New(isolate, 2);\n-  result->Set(0, names);\n-  result->Set(1, types);\n+  result->Set(0, Array::New(isolate, name_v.data(), name_v.size()));\n+  result->Set(1, Array::New(isolate, type_v.data(), type_v.size()));\n   req_wrap->Resolve(result);\n }\n \n@@ -1523,9 +1482,8 @@ static void ReadDir(const FunctionCallbackInfo<Value>& args) {\n     Local<Array> names = Array::New(isolate, name_v.data(), name_v.size());\n     if (with_types) {\n       Local<Array> result = Array::New(isolate, 2);\n-      Local<Value> types = Array::New(isolate, type_v.data(), type_v.size());\n       result->Set(0, names);\n-      result->Set(1, types);\n+      result->Set(1, Array::New(isolate, type_v.data(), type_v.size()));\n       args.GetReturnValue().Set(result);\n     } else {\n       args.GetReturnValue().Set(names);"
        },
        {
            "sha": "7ae32fe617d58fa0c0c451d6a13854f72a30f545",
            "filename": "test/parallel/test-benchmark-fs.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/ca51b9471ce2e031a569e49d6c6188e36f9a1b81/test%2Fparallel%2Ftest-benchmark-fs.js",
            "raw_url": "https://github.com/nodejs/node/raw/ca51b9471ce2e031a569e49d6c6188e36f9a1b81/test%2Fparallel%2Ftest-benchmark-fs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-benchmark-fs.js?ref=ca51b9471ce2e031a569e49d6c6188e36f9a1b81",
            "patch": "@@ -16,5 +16,7 @@ runBenchmark('fs', [\n   'statType=fstat',\n   'statSyncType=fstatSync',\n   'encodingType=buf',\n-  'filesize=1024'\n+  'filesize=1024',\n+  'dir=.github',\n+  'withFileTypes=false'\n ], { NODE_TMPDIR: tmpdir.path, NODEJS_BENCHMARK_ZERO_ALLOWED: 1 });"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 28,
        "deletions": 61
    }
}