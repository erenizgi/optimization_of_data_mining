{
    "author": "addaleax",
    "message": "src: simplify JS Array creation\n\nUse `ToV8Value()` where appropriate to reduce duplication\nand avoid extra `Array::Set()` calls.\n\nPR-URL: https://github.com/nodejs/node/pull/25288\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4",
    "files": [
        {
            "sha": "3fb31134b9ba855260cbe3080a629adad951bcb0",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 25,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4",
            "patch": "@@ -889,28 +889,15 @@ void SetupProcessObject(Environment* env,\n #endif\n \n   // process.argv\n-  Local<Array> arguments = Array::New(env->isolate(), args.size());\n-  for (size_t i = 0; i < args.size(); ++i) {\n-    arguments->Set(env->context(), i,\n-        String::NewFromUtf8(env->isolate(), args[i].c_str(),\n-                            NewStringType::kNormal).ToLocalChecked())\n-        .FromJust();\n-  }\n   process->Set(env->context(),\n                FIXED_ONE_BYTE_STRING(env->isolate(), \"argv\"),\n-               arguments).FromJust();\n+               ToV8Value(env->context(), args).ToLocalChecked()).FromJust();\n \n   // process.execArgv\n-  Local<Array> exec_arguments = Array::New(env->isolate(), exec_args.size());\n-  for (size_t i = 0; i < exec_args.size(); ++i) {\n-    exec_arguments->Set(env->context(), i,\n-        String::NewFromUtf8(env->isolate(), exec_args[i].c_str(),\n-                            NewStringType::kNormal).ToLocalChecked())\n-        .FromJust();\n-  }\n   process->Set(env->context(),\n                FIXED_ONE_BYTE_STRING(env->isolate(), \"execArgv\"),\n-               exec_arguments).FromJust();\n+               ToV8Value(env->context(), exec_args)\n+                   .ToLocalChecked()).FromJust();\n \n   // create process.env\n   process\n@@ -960,17 +947,10 @@ void SetupProcessObject(Environment* env,\n   const std::vector<std::string>& preload_modules =\n       env->options()->preload_modules;\n   if (!preload_modules.empty()) {\n-    Local<Array> array = Array::New(env->isolate());\n-    for (unsigned int i = 0; i < preload_modules.size(); ++i) {\n-      Local<String> module = String::NewFromUtf8(env->isolate(),\n-                                                 preload_modules[i].c_str(),\n-                                                 NewStringType::kNormal)\n-                                 .ToLocalChecked();\n-      array->Set(env->context(), i, module).FromJust();\n-    }\n     READONLY_PROPERTY(process,\n                       \"_preload_modules\",\n-                      array);\n+                      ToV8Value(env->context(), preload_modules)\n+                          .ToLocalChecked());\n   }\n \n   // --no-deprecation"
        },
        {
            "sha": "82f6ef0dd8c0f3cf4e0a8b21f4fdb5eaebc9a342",
            "filename": "src/node_credentials.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 25,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4/src%2Fnode_credentials.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4/src%2Fnode_credentials.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_credentials.cc?ref=0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4",
            "patch": "@@ -15,9 +15,9 @@ using v8::Array;\n using v8::Context;\n using v8::Function;\n using v8::FunctionCallbackInfo;\n-using v8::Integer;\n using v8::Isolate;\n using v8::Local;\n+using v8::MaybeLocal;\n using v8::Object;\n using v8::String;\n using v8::Uint32;\n@@ -253,36 +253,21 @@ static void GetGroups(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n \n   int ngroups = getgroups(0, nullptr);\n-\n   if (ngroups == -1) return env->ThrowErrnoException(errno, \"getgroups\");\n \n-  gid_t* groups = new gid_t[ngroups];\n-\n-  ngroups = getgroups(ngroups, groups);\n+  std::vector<gid_t> groups(ngroups);\n \n-  if (ngroups == -1) {\n-    delete[] groups;\n+  ngroups = getgroups(ngroups, groups.data());\n+  if (ngroups == -1)\n     return env->ThrowErrnoException(errno, \"getgroups\");\n-  }\n \n-  Local<Array> groups_list = Array::New(env->isolate(), ngroups);\n-  bool seen_egid = false;\n+  groups.resize(ngroups);\n   gid_t egid = getegid();\n-\n-  for (int i = 0; i < ngroups; i++) {\n-    groups_list->Set(env->context(), i, Integer::New(env->isolate(), groups[i]))\n-        .FromJust();\n-    if (groups[i] == egid) seen_egid = true;\n-  }\n-\n-  delete[] groups;\n-\n-  if (seen_egid == false)\n-    groups_list\n-        ->Set(env->context(), ngroups, Integer::New(env->isolate(), egid))\n-        .FromJust();\n-\n-  args.GetReturnValue().Set(groups_list);\n+  if (std::find(groups.begin(), groups.end(), egid) == groups.end())\n+    groups.push_back(egid);\n+  MaybeLocal<Value> array = ToV8Value(env->context(), groups);\n+  if (!array.IsEmpty())\n+    args.GetReturnValue().Set(array.ToLocalChecked());\n }\n \n static void SetGroups(const FunctionCallbackInfo<Value>& args) {"
        },
        {
            "sha": "ab355688888ee3a394e709eeadbde3377b8bb10d",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 13,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4",
            "patch": "@@ -250,22 +250,12 @@ struct CryptoErrorVector : public std::vector<std::string> {\n     CHECK(!exception_v.IsEmpty());\n \n     if (!empty()) {\n-      Local<Array> array = Array::New(env->isolate(), size());\n-      CHECK(!array.IsEmpty());\n-\n-      for (const std::string& string : *this) {\n-        const size_t index = &string - &front();\n-        Local<String> value =\n-            String::NewFromUtf8(env->isolate(), string.data(),\n-                                NewStringType::kNormal, string.size())\n-            .ToLocalChecked();\n-        array->Set(env->context(), index, value).FromJust();\n-      }\n-\n       CHECK(exception_v->IsObject());\n       Local<Object> exception = exception_v.As<Object>();\n       exception->Set(env->context(),\n-                     env->openssl_error_stack(), array).FromJust();\n+                     env->openssl_error_stack(),\n+                     ToV8Value(env->context(), *this).ToLocalChecked())\n+          .FromJust();\n     }\n \n     return exception_v;"
        },
        {
            "sha": "1841f32aad787c25adc2dec644158ffb8c736b8f",
            "filename": "src/node_url.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 10,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4/src%2Fnode_url.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4/src%2Fnode_url.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_url.cc?ref=0ff1eb83d9c3416f9619c1ce2c3a7327efd9bee4",
            "patch": "@@ -1190,15 +1190,6 @@ inline std::vector<std::string> FromJSStringArray(Environment* env,\n   return vec;\n }\n \n-inline Local<Array> ToJSStringArray(Environment* env,\n-                                    const std::vector<std::string>& vec) {\n-  Isolate* isolate = env->isolate();\n-  Local<Array> array = Array::New(isolate, vec.size());\n-  for (size_t n = 0; n < vec.size(); n++)\n-    array->Set(env->context(), n, Utf8String(isolate, vec[n])).FromJust();\n-  return array;\n-}\n-\n inline url_data HarvestBase(Environment* env, Local<Object> base_obj) {\n   url_data base;\n   Local<Context> context = env->context();\n@@ -2119,7 +2110,7 @@ static inline void SetArgs(Environment* env,\n   if (url.port > -1)\n     argv[ARG_PORT] = Integer::New(isolate, url.port);\n   if (url.flags & URL_FLAGS_HAS_PATH)\n-    argv[ARG_PATH] = ToJSStringArray(env, url.path);\n+    argv[ARG_PATH] = ToV8Value(env->context(), url.path).ToLocalChecked();\n }\n \n static void Parse(Environment* env,"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 19,
        "deletions": 73
    }
}