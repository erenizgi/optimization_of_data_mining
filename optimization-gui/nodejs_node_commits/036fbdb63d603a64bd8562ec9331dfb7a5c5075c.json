{
    "author": "addaleax",
    "message": "src: remove `Environment::tracing_agent_writer()`\n\nAs per the conversation in https://github.com/nodejs/node/issues/22513,\nthis is essentially global, and adding this on the Environment\nis generally just confusing.\n\nRefs: https://github.com/nodejs/node/issues/22513\nFixes: https://github.com/nodejs/node/issues/22767\n\nPR-URL: https://github.com/nodejs/node/pull/23781\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Matheus Marchini <mat@mmarchini.me>",
    "sha": "036fbdb63d603a64bd8562ec9331dfb7a5c5075c",
    "files": [
        {
            "sha": "4f99bc9ec01c14e5bef4fb53ba54a14ddd5bbdbd",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=036fbdb63d603a64bd8562ec9331dfb7a5c5075c",
            "patch": "@@ -334,10 +334,6 @@ inline v8::Isolate* Environment::isolate() const {\n   return isolate_;\n }\n \n-inline tracing::AgentWriterHandle* Environment::tracing_agent_writer() const {\n-  return tracing_agent_writer_;\n-}\n-\n inline Environment* Environment::from_timer_handle(uv_timer_t* handle) {\n   return ContainerOf(&Environment::timer_handle_, handle);\n }"
        },
        {
            "sha": "5da673b3e060200a69c178db0c94227254d00872",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=036fbdb63d603a64bd8562ec9331dfb7a5c5075c",
            "patch": "@@ -143,11 +143,9 @@ void Environment::TrackingTraceStateObserver::UpdateTraceCategoryState() {\n }\n \n Environment::Environment(IsolateData* isolate_data,\n-                         Local<Context> context,\n-                         tracing::AgentWriterHandle* tracing_agent_writer)\n+                         Local<Context> context)\n     : isolate_(context->GetIsolate()),\n       isolate_data_(isolate_data),\n-      tracing_agent_writer_(tracing_agent_writer),\n       immediate_info_(context->GetIsolate()),\n       tick_info_(context->GetIsolate()),\n       timer_base_(uv_now(isolate_data->event_loop())),\n@@ -183,10 +181,9 @@ Environment::Environment(IsolateData* isolate_data,\n \n   AssignToContext(context, ContextInfo(\"\"));\n \n-  if (tracing_agent_writer_ != nullptr) {\n+  if (tracing::AgentWriterHandle* writer = GetTracingAgentWriter()) {\n     trace_state_observer_.reset(new TrackingTraceStateObserver(this));\n-    v8::TracingController* tracing_controller =\n-        tracing_agent_writer_->GetTracingController();\n+    v8::TracingController* tracing_controller = writer->GetTracingController();\n     if (tracing_controller != nullptr)\n       tracing_controller->AddTraceStateObserver(trace_state_observer_.get());\n   }\n@@ -235,9 +232,10 @@ Environment::~Environment() {\n   context()->SetAlignedPointerInEmbedderData(\n       ContextEmbedderIndex::kEnvironment, nullptr);\n \n-  if (tracing_agent_writer_ != nullptr) {\n-    v8::TracingController* tracing_controller =\n-        tracing_agent_writer_->GetTracingController();\n+  if (trace_state_observer_) {\n+    tracing::AgentWriterHandle* writer = GetTracingAgentWriter();\n+    CHECK_NOT_NULL(writer);\n+    v8::TracingController* tracing_controller = writer->GetTracingController();\n     if (tracing_controller != nullptr)\n       tracing_controller->RemoveTraceStateObserver(trace_state_observer_.get());\n   }"
        },
        {
            "sha": "36e4169b4b89787eab726849efe1616d10633fe3",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=036fbdb63d603a64bd8562ec9331dfb7a5c5075c",
            "patch": "@@ -593,8 +593,7 @@ class Environment {\n   static inline Environment* GetThreadLocalEnv();\n \n   Environment(IsolateData* isolate_data,\n-              v8::Local<v8::Context> context,\n-              tracing::AgentWriterHandle* tracing_agent_writer);\n+              v8::Local<v8::Context> context);\n   ~Environment();\n \n   void Start(const std::vector<std::string>& args,\n@@ -630,7 +629,6 @@ class Environment {\n   inline bool profiler_idle_notifier_started() const;\n \n   inline v8::Isolate* isolate() const;\n-  inline tracing::AgentWriterHandle* tracing_agent_writer() const;\n   inline uv_loop_t* event_loop() const;\n   inline uint32_t watched_providers() const;\n \n@@ -921,7 +919,6 @@ class Environment {\n \n   v8::Isolate* const isolate_;\n   IsolateData* const isolate_data_;\n-  tracing::AgentWriterHandle* const tracing_agent_writer_;\n   uv_timer_t timer_handle_;\n   uv_check_t immediate_check_handle_;\n   uv_idle_t immediate_idle_handle_;"
        },
        {
            "sha": "1ad67d9b9e7f712bb9ae448c1de5f40edc38ed7d",
            "filename": "src/inspector/tracing_agent.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Finspector%2Ftracing_agent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Finspector%2Ftracing_agent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector%2Ftracing_agent.cc?ref=036fbdb63d603a64bd8562ec9331dfb7a5c5075c",
            "patch": "@@ -1,4 +1,5 @@\n #include \"tracing_agent.h\"\n+#include \"node_internals.h\"\n \n #include \"env-inl.h\"\n #include \"v8.h\"\n@@ -74,9 +75,9 @@ DispatchResponse TracingAgent::start(\n   if (categories_set.empty())\n     return DispatchResponse::Error(\"At least one category should be enabled\");\n \n-  auto* writer = env_->tracing_agent_writer();\n+  tracing::AgentWriterHandle* writer = GetTracingAgentWriter();\n   if (writer != nullptr) {\n-    trace_writer_ = env_->tracing_agent_writer()->agent()->AddClient(\n+    trace_writer_ = writer->agent()->AddClient(\n         categories_set,\n         std::unique_ptr<InspectorTraceWriter>(\n             new InspectorTraceWriter(frontend_.get())),"
        },
        {
            "sha": "0764adc10bc9e0b403e34a9d6d6cc2e2882aaea4",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=036fbdb63d603a64bd8562ec9331dfb7a5c5075c",
            "patch": "@@ -379,6 +379,10 @@ static struct {\n #endif  //  !NODE_USE_V8_PLATFORM || !HAVE_INSPECTOR\n } v8_platform;\n \n+tracing::AgentWriterHandle* GetTracingAgentWriter() {\n+  return v8_platform.GetTracingAgentWriter();\n+}\n+\n #ifdef __POSIX__\n static const unsigned kMaxSignal = 32;\n #endif\n@@ -2763,8 +2767,7 @@ Environment* CreateEnvironment(IsolateData* isolate_data,\n   // options than the global parse call.\n   std::vector<std::string> args(argv, argv + argc);\n   std::vector<std::string> exec_args(exec_argv, exec_argv + exec_argc);\n-  Environment* env = new Environment(isolate_data, context,\n-                                     v8_platform.GetTracingAgentWriter());\n+  Environment* env = new Environment(isolate_data, context);\n   env->Start(args, exec_args, v8_is_profiling);\n   return env;\n }\n@@ -2834,7 +2837,7 @@ inline int Start(Isolate* isolate, IsolateData* isolate_data,\n   HandleScope handle_scope(isolate);\n   Local<Context> context = NewContext(isolate);\n   Context::Scope context_scope(context);\n-  Environment env(isolate_data, context, v8_platform.GetTracingAgentWriter());\n+  Environment env(isolate_data, context);\n   env.Start(args, exec_args, v8_is_profiling);\n \n   const char* path = args.size() > 1 ? args[1].c_str() : nullptr;"
        },
        {
            "sha": "d0209fedc5b703ecd712f2874eaed73111a330ed",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=036fbdb63d603a64bd8562ec9331dfb7a5c5075c",
            "patch": "@@ -538,6 +538,8 @@ int ThreadPoolWork::CancelWork() {\n   return uv_cancel(reinterpret_cast<uv_req_t*>(&work_req_));\n }\n \n+tracing::AgentWriterHandle* GetTracingAgentWriter();\n+\n static inline const char* errno_string(int errorno) {\n #define ERRNO_CASE(e)  case e: return #e;\n   switch (errorno) {"
        },
        {
            "sha": "ce60cde2d0d433166e423660f0a523f4960ab797",
            "filename": "src/node_trace_events.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fnode_trace_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fnode_trace_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_trace_events.cc?ref=036fbdb63d603a64bd8562ec9331dfb7a5c5075c",
            "patch": "@@ -57,7 +57,7 @@ void NodeCategorySet::New(const FunctionCallbackInfo<Value>& args) {\n     if (!*val) return;\n     categories.emplace(*val);\n   }\n-  CHECK_NOT_NULL(env->tracing_agent_writer());\n+  CHECK_NOT_NULL(GetTracingAgentWriter());\n   new NodeCategorySet(env, args.This(), std::move(categories));\n }\n \n@@ -68,7 +68,7 @@ void NodeCategorySet::Enable(const FunctionCallbackInfo<Value>& args) {\n   CHECK_NOT_NULL(category_set);\n   const auto& categories = category_set->GetCategories();\n   if (!category_set->enabled_ && !categories.empty()) {\n-    env->tracing_agent_writer()->Enable(categories);\n+    GetTracingAgentWriter()->Enable(categories);\n     category_set->enabled_ = true;\n   }\n }\n@@ -80,15 +80,15 @@ void NodeCategorySet::Disable(const FunctionCallbackInfo<Value>& args) {\n   CHECK_NOT_NULL(category_set);\n   const auto& categories = category_set->GetCategories();\n   if (category_set->enabled_ && !categories.empty()) {\n-    env->tracing_agent_writer()->Disable(categories);\n+    GetTracingAgentWriter()->Disable(categories);\n     category_set->enabled_ = false;\n   }\n }\n \n void GetEnabledCategories(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n   std::string categories =\n-      env->tracing_agent_writer()->agent()->GetEnabledCategories();\n+      GetTracingAgentWriter()->agent()->GetEnabledCategories();\n   if (!categories.empty()) {\n     args.GetReturnValue().Set(\n       String::NewFromUtf8(env->isolate(),"
        },
        {
            "sha": "cb6adbeba34adc15061adfdd55c0b90214cde4f6",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/036fbdb63d603a64bd8562ec9331dfb7a5c5075c/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=036fbdb63d603a64bd8562ec9331dfb7a5c5075c",
            "patch": "@@ -116,9 +116,7 @@ Worker::Worker(Environment* env, Local<Object> wrap, const std::string& url)\n     Context::Scope context_scope(context);\n \n     // TODO(addaleax): Use CreateEnvironment(), or generally another public API.\n-    env_.reset(new Environment(isolate_data_.get(),\n-                               context,\n-                               nullptr));\n+    env_.reset(new Environment(isolate_data_.get(), context));\n     CHECK_NE(env_, nullptr);\n     env_->set_abort_on_uncaught_exception(false);\n     env_->set_worker_context(this);"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 24,
        "deletions": 29
    }
}