{
    "author": "joyeecheung",
    "message": "src: refactor tickInfo access\n\n- Wrap access to tickInfo fields in functions\n- Rename `kHasScheduled` to `kHasTickScheduled` and\n  `kHasPromiseRejections` to `kHasRejectionToWarn` for clarity - note\n  the latter will be set to false if the rejection does not lead to\n  a warning so the previous description is not accurate.\n- Set `kHasRejectionToWarn` in JS land of relying on C++ to use\n  an implict contract (return value of the promise rejection handler)\n  to set it, as the decision is made entirely in JS land.\n- Destructure promise reject event constants.\n\nPR-URL: https://github.com/nodejs/node/pull/25200\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "bf566718b29a6fae8cef8d0fecd7e77948726d5a",
    "files": [
        {
            "sha": "0bfe168975acb3f0766f8148ad97b12f63ea1f5c",
            "filename": "lib/internal/process/next_tick.js",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/bf566718b29a6fae8cef8d0fecd7e77948726d5a/lib%2Finternal%2Fprocess%2Fnext_tick.js",
            "raw_url": "https://github.com/nodejs/node/raw/bf566718b29a6fae8cef8d0fecd7e77948726d5a/lib%2Finternal%2Fprocess%2Fnext_tick.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fnext_tick.js?ref=bf566718b29a6fae8cef8d0fecd7e77948726d5a",
            "patch": "@@ -11,6 +11,8 @@ const {\n } = internalBinding('task_queue');\n \n const {\n+  setHasRejectionToWarn,\n+  hasRejectionToWarn,\n   promiseRejectHandler,\n   emitPromiseRejectionWarnings\n } = require('internal/process/promises');\n@@ -30,15 +32,21 @@ const { ERR_INVALID_CALLBACK } = require('internal/errors').codes;\n const FixedQueue = require('internal/fixed_queue');\n \n // *Must* match Environment::TickInfo::Fields in src/env.h.\n-const kHasScheduled = 0;\n-const kHasPromiseRejections = 1;\n+const kHasTickScheduled = 0;\n+\n+function hasTickScheduled() {\n+  return tickInfo[kHasTickScheduled] === 1;\n+}\n+function setHasTickScheduled(value) {\n+  tickInfo[kHasTickScheduled] = value ? 1 : 0;\n+}\n \n const queue = new FixedQueue();\n \n function runNextTicks() {\n-  if (tickInfo[kHasScheduled] === 0 && tickInfo[kHasPromiseRejections] === 0)\n+  if (!hasTickScheduled() && !hasRejectionToWarn())\n     runMicrotasks();\n-  if (tickInfo[kHasScheduled] === 0 && tickInfo[kHasPromiseRejections] === 0)\n+  if (!hasTickScheduled() && !hasRejectionToWarn())\n     return;\n \n   internalTickCallback();\n@@ -70,10 +78,10 @@ function internalTickCallback() {\n \n       emitAfter(asyncId);\n     }\n-    tickInfo[kHasScheduled] = 0;\n+    setHasTickScheduled(false);\n     runMicrotasks();\n   } while (!queue.isEmpty() || emitPromiseRejectionWarnings());\n-  tickInfo[kHasPromiseRejections] = 0;\n+  setHasRejectionToWarn(false);\n }\n \n class TickObject {\n@@ -119,7 +127,7 @@ function nextTick(callback) {\n   }\n \n   if (queue.isEmpty())\n-    tickInfo[kHasScheduled] = 1;\n+    setHasTickScheduled(true);\n   queue.push(new TickObject(callback, args, getDefaultTriggerAsyncId()));\n }\n "
        },
        {
            "sha": "047a9d43aabf2b44e8af620722847c332b0a196b",
            "filename": "lib/internal/process/promises.js",
            "status": "modified",
            "additions": 36,
            "deletions": 12,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/bf566718b29a6fae8cef8d0fecd7e77948726d5a/lib%2Finternal%2Fprocess%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/bf566718b29a6fae8cef8d0fecd7e77948726d5a/lib%2Finternal%2Fprocess%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fpromises.js?ref=bf566718b29a6fae8cef8d0fecd7e77948726d5a",
            "patch": "@@ -2,24 +2,45 @@\n \n const { safeToString } = internalBinding('util');\n const {\n-  promiseRejectEvents\n+  tickInfo,\n+  promiseRejectEvents: {\n+    kPromiseRejectWithNoHandler,\n+    kPromiseHandlerAddedAfterReject,\n+    kPromiseResolveAfterResolved,\n+    kPromiseRejectAfterResolved\n+  }\n } = internalBinding('task_queue');\n \n+// *Must* match Environment::TickInfo::Fields in src/env.h.\n+const kHasRejectionToWarn = 1;\n+\n const maybeUnhandledPromises = new WeakMap();\n const pendingUnhandledRejections = [];\n const asyncHandledRejections = [];\n let lastPromiseId = 0;\n \n+function setHasRejectionToWarn(value) {\n+  tickInfo[kHasRejectionToWarn] = value ? 1 : 0;\n+}\n+\n+function hasRejectionToWarn() {\n+  return tickInfo[kHasRejectionToWarn] === 1;\n+}\n+\n function promiseRejectHandler(type, promise, reason) {\n   switch (type) {\n-    case promiseRejectEvents.kPromiseRejectWithNoHandler:\n-      return unhandledRejection(promise, reason);\n-    case promiseRejectEvents.kPromiseHandlerAddedAfterReject:\n-      return handledRejection(promise);\n-    case promiseRejectEvents.kPromiseResolveAfterResolved:\n-      return resolveError('resolve', promise, reason);\n-    case promiseRejectEvents.kPromiseRejectAfterResolved:\n-      return resolveError('reject', promise, reason);\n+    case kPromiseRejectWithNoHandler:\n+      unhandledRejection(promise, reason);\n+      break;\n+    case kPromiseHandlerAddedAfterReject:\n+      handledRejection(promise);\n+      break;\n+    case kPromiseResolveAfterResolved:\n+      resolveError('resolve', promise, reason);\n+      break;\n+    case kPromiseRejectAfterResolved:\n+      resolveError('reject', promise, reason);\n+      break;\n   }\n }\n \n@@ -38,7 +59,7 @@ function unhandledRejection(promise, reason) {\n     warned: false\n   });\n   pendingUnhandledRejections.push(promise);\n-  return true;\n+  setHasRejectionToWarn(true);\n }\n \n function handledRejection(promise) {\n@@ -54,10 +75,11 @@ function handledRejection(promise) {\n       warning.name = 'PromiseRejectionHandledWarning';\n       warning.id = uid;\n       asyncHandledRejections.push({ promise, warning });\n-      return true;\n+      setHasRejectionToWarn(true);\n+      return;\n     }\n   }\n-  return false;\n+  setHasRejectionToWarn(false);\n }\n \n const unhandledRejectionErrName = 'UnhandledPromiseRejectionWarning';\n@@ -121,6 +143,8 @@ function emitPromiseRejectionWarnings() {\n }\n \n module.exports = {\n+  hasRejectionToWarn,\n+  setHasRejectionToWarn,\n   promiseRejectHandler,\n   emitPromiseRejectionWarnings\n };"
        },
        {
            "sha": "89fd4d6dd433d05e7412018fad9cd6b7863af5c6",
            "filename": "src/callback_scope.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/bf566718b29a6fae8cef8d0fecd7e77948726d5a/src%2Fcallback_scope.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bf566718b29a6fae8cef8d0fecd7e77948726d5a/src%2Fcallback_scope.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcallback_scope.cc?ref=bf566718b29a6fae8cef8d0fecd7e77948726d5a",
            "patch": "@@ -95,7 +95,7 @@ void InternalCallbackScope::Close() {\n   Environment::TickInfo* tick_info = env_->tick_info();\n \n   if (!env_->can_call_into_js()) return;\n-  if (!tick_info->has_scheduled()) {\n+  if (!tick_info->has_tick_scheduled()) {\n     env_->isolate()->RunMicrotasks();\n   }\n \n@@ -106,7 +106,7 @@ void InternalCallbackScope::Close() {\n     CHECK_EQ(env_->trigger_async_id(), 0);\n   }\n \n-  if (!tick_info->has_scheduled() && !tick_info->has_promise_rejections()) {\n+  if (!tick_info->has_tick_scheduled() && !tick_info->has_rejection_to_warn()) {\n     return;\n   }\n "
        },
        {
            "sha": "7c643539ad94acc3bb821b5e3b73d0c036c7afad",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/bf566718b29a6fae8cef8d0fecd7e77948726d5a/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/bf566718b29a6fae8cef8d0fecd7e77948726d5a/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=bf566718b29a6fae8cef8d0fecd7e77948726d5a",
            "patch": "@@ -265,16 +265,12 @@ inline AliasedBuffer<uint8_t, v8::Uint8Array>& Environment::TickInfo::fields() {\n   return fields_;\n }\n \n-inline bool Environment::TickInfo::has_scheduled() const {\n-  return fields_[kHasScheduled] == 1;\n+inline bool Environment::TickInfo::has_tick_scheduled() const {\n+  return fields_[kHasTickScheduled] == 1;\n }\n \n-inline bool Environment::TickInfo::has_promise_rejections() const {\n-  return fields_[kHasPromiseRejections] == 1;\n-}\n-\n-inline void Environment::TickInfo::promise_rejections_toggle_on() {\n-  fields_[kHasPromiseRejections] = 1;\n+inline bool Environment::TickInfo::has_rejection_to_warn() const {\n+  return fields_[kHasRejectionToWarn] == 1;\n }\n \n inline void Environment::AssignToContext(v8::Local<v8::Context> context,"
        },
        {
            "sha": "a76f00315f5a5c0baad5cfc57dd860df62cea26f",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/bf566718b29a6fae8cef8d0fecd7e77948726d5a/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/bf566718b29a6fae8cef8d0fecd7e77948726d5a/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=bf566718b29a6fae8cef8d0fecd7e77948726d5a",
            "patch": "@@ -575,18 +575,16 @@ class Environment {\n   class TickInfo {\n    public:\n     inline AliasedBuffer<uint8_t, v8::Uint8Array>& fields();\n-    inline bool has_scheduled() const;\n-    inline bool has_promise_rejections() const;\n-\n-    inline void promise_rejections_toggle_on();\n+    inline bool has_tick_scheduled() const;\n+    inline bool has_rejection_to_warn() const;\n \n    private:\n     friend class Environment;  // So we can call the constructor.\n     inline explicit TickInfo(v8::Isolate* isolate);\n \n     enum Fields {\n-      kHasScheduled,\n-      kHasPromiseRejections,\n+      kHasTickScheduled = 0,\n+      kHasRejectionToWarn,\n       kFieldsCount\n     };\n "
        },
        {
            "sha": "5bfa281068e7552cc418bae24bda7fa000ac20a8",
            "filename": "src/node_task_queue.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/bf566718b29a6fae8cef8d0fecd7e77948726d5a/src%2Fnode_task_queue.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bf566718b29a6fae8cef8d0fecd7e77948726d5a/src%2Fnode_task_queue.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_task_queue.cc?ref=bf566718b29a6fae8cef8d0fecd7e77948726d5a",
            "patch": "@@ -17,7 +17,6 @@ using v8::kPromiseRejectAfterResolved;\n using v8::kPromiseRejectWithNoHandler;\n using v8::kPromiseResolveAfterResolved;\n using v8::Local;\n-using v8::MaybeLocal;\n using v8::Number;\n using v8::Object;\n using v8::Promise;\n@@ -80,13 +79,8 @@ static void PromiseRejectCallback(PromiseRejectMessage message) {\n   }\n \n   Local<Value> args[] = { type, promise, value };\n-  MaybeLocal<Value> ret = callback->Call(env->context(),\n-                                         Undefined(isolate),\n-                                         arraysize(args),\n-                                         args);\n-\n-  if (!ret.IsEmpty() && ret.ToLocalChecked()->IsTrue())\n-    env->tick_info()->promise_rejections_toggle_on();\n+  USE(callback->Call(\n+      env->context(), Undefined(isolate), arraysize(args), args));\n }\n \n static void InitializePromiseRejectCallback("
        }
    ],
    "stats": {
        "total": 106,
        "additions": 63,
        "deletions": 43
    }
}