{
    "author": "rubys",
    "message": "tools: Include links to source code in documentation\n\nParse source code using acorn; extracting exports.  When producing\ndocumentation, match exports to headers.  When a match is found, add a [src]\nlink.\n\nThis first commit handles simple exported classes and functions, and does so\nwithout requiring any changes to the source code or markdown.  Subsequent\ncommits will attempt to match more headers, and some of these changes are\nlikely to require changes to the source code and/or markdown.\n\nPR-URL: https://github.com/nodejs/node/pull/22405\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Vse Mozhet Byt <vsemozhetbyt@gmail.com>",
    "sha": "60465700ed055640e737ca3a53e16465dfec00d6",
    "files": [
        {
            "sha": "8769b5b95c9f580669207d4ab370c3cf3b508aea",
            "filename": "Makefile",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -645,10 +645,15 @@ out/doc/api/assets/%: doc/api_assets/% out/doc/api/assets\n run-npm-ci = $(PWD)/$(NPM) ci\n \n gen-api = tools/doc/generate.js --node-version=$(FULLVERSION) \\\n+\t\t--apilinks=out/apilinks.json \\\n \t\t--analytics=$(DOCS_ANALYTICS) $< --output-directory=out/doc/api\n+gen-apilink = tools/doc/apilinks.js $(wildcard lib/*.js) > $@\n+\n+out/apilinks.json: $(wildcard lib/*.js) tools/doc/apilinks.js\n+\t$(call available-node, $(gen-apilink))\n \n out/doc/api/%.json out/doc/api/%.html: doc/api/%.md tools/doc/generate.js \\\n-\ttools/doc/html.js tools/doc/json.js\n+\ttools/doc/html.js tools/doc/json.js | out/apilinks.json\n \t$(call available-node, $(gen-api))\n \n out/doc/api/all.html: $(apidocs_html) tools/doc/allhtml.js"
        },
        {
            "sha": "7d65b7405b41d103bccb574048247fe30de6744d",
            "filename": "doc/api_assets/style.css",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/doc%2Fapi_assets%2Fstyle.css",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/doc%2Fapi_assets%2Fstyle.css",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi_assets%2Fstyle.css?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -283,6 +283,11 @@ h2, h3, h4, h5 {\n   padding-right: 40px;\n }\n \n+.srclink {\n+  float: right;\n+  font-size: smaller;\n+}\n+\n h1 span, h2 span, h3 span, h4 span {\n   position: absolute;\n   display: block;"
        },
        {
            "sha": "e53c81a08a7203f01e62902687a0119f8082ef47",
            "filename": "test/doctool/test-apilinks.js",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/test%2Fdoctool%2Ftest-apilinks.js",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/test%2Fdoctool%2Ftest-apilinks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fdoctool%2Ftest-apilinks.js?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -0,0 +1,39 @@\n+'use strict';\n+\n+require('../common');\n+const fixtures = require('../common/fixtures');\n+const fs = require('fs');\n+const assert = require('assert');\n+const path = require('path');\n+const { execFileSync } = require('child_process');\n+\n+const script = path.join(__dirname, '..', '..', 'tools', 'doc', 'apilinks.js');\n+\n+const apilinks = fixtures.path('apilinks');\n+fs.readdirSync(apilinks).forEach((fixture) => {\n+  if (!fixture.endsWith('.js')) return;\n+  const file = path.join(apilinks, fixture);\n+\n+  const expectedContent = fs.readFileSync(file + 'on', 'utf8');\n+\n+  const output = execFileSync(\n+    process.execPath,\n+    [script, file],\n+    { encoding: 'utf-8' }\n+  );\n+\n+  const expectedLinks = JSON.parse(expectedContent);\n+  const actualLinks = JSON.parse(output);\n+\n+  for (const [k, v] of Object.entries(expectedLinks)) {\n+    assert.ok(k in actualLinks, `link not found: ${k}`);\n+    assert.ok(actualLinks[k].endsWith('/' + v),\n+              `link ${actualLinks[k]} expected to end with ${v}`);\n+    delete actualLinks[k];\n+  }\n+\n+  assert.strictEqual(\n+    Object.keys(actualLinks).length, 0,\n+    `unexpected links returned ${JSON.stringify(actualLinks)}`\n+  );\n+});"
        },
        {
            "sha": "2fcb8315afd325dd3c3c1348be2564af788023d0",
            "filename": "test/doctool/test-doctool-html.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/test%2Fdoctool%2Ftest-doctool-html.js",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/test%2Fdoctool%2Ftest-doctool-html.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fdoctool%2Ftest-doctool-html.js?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -28,7 +28,7 @@ function toHTML({ input, filename, nodeVersion, analytics }, cb) {\n     .use(html.firstHeader)\n     .use(html.preprocessText)\n     .use(html.preprocessElements, { filename })\n-    .use(html.buildToc, { filename })\n+    .use(html.buildToc, { filename, apilinks: {} })\n     .use(remark2rehype, { allowDangerousHTML: true })\n     .use(raw)\n     .use(htmlStringify)"
        },
        {
            "sha": "8ee44123a5e8ca1fb99c7a623dbf2993d8c1a820",
            "filename": "test/fixtures/apilinks/buffer.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fbuffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fbuffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fapilinks%2Fbuffer.js?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -0,0 +1,12 @@\n+'use strict';\n+\n+// Buffer instance methods are exported as 'buf'.\n+\n+function Buffer() {\n+}\n+\n+Buffer.prototype.instanceMethod = function() {}\n+\n+module.exports = {\n+  Buffer\n+};"
        },
        {
            "sha": "528eca6eb215487e5ae1931ac5df6caae9dedea4",
            "filename": "test/fixtures/apilinks/buffer.json",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fbuffer.json",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fbuffer.json",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fapilinks%2Fbuffer.json?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -0,0 +1,4 @@\n+{\n+  \"buffer.Buffer\": \"buffer.js#L5\",\n+  \"buf.instanceMethod\": \"buffer.js#L8\"\n+}"
        },
        {
            "sha": "72606121f53fdb9fc42ed457290a66f42fab4d8c",
            "filename": "test/fixtures/apilinks/mod.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fmod.js",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fmod.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fapilinks%2Fmod.js?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -0,0 +1,11 @@\n+'use strict';\n+\n+// A module may export one or more methods.\n+\n+function foo() {\n+}\n+\n+\n+module.exports = {\n+  foo\n+};"
        },
        {
            "sha": "7d803e623672da1a592ed976e6885960ea56225a",
            "filename": "test/fixtures/apilinks/mod.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fmod.json",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fmod.json",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fapilinks%2Fmod.json?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"mod.foo\": \"mod.js#L5\"\n+}"
        },
        {
            "sha": "40218e844e68ad5c83e648b381cfaff226ffcb83",
            "filename": "test/fixtures/apilinks/prototype.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fprototype.js",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fprototype.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fapilinks%2Fprototype.js?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -0,0 +1,13 @@\n+'use strict';\n+\n+// An exported class using classic prototype syntax.\n+\n+function Class() {\n+}\n+\n+Class.classMethod = function() {}\n+Class.prototype.instanceMethod = function() {}\n+\n+module.exports = {\n+  Class\n+};"
        },
        {
            "sha": "d61c32da62a64e8c169b8efae0f6b2610ab60ead",
            "filename": "test/fixtures/apilinks/prototype.json",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fprototype.json",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/test%2Ffixtures%2Fapilinks%2Fprototype.json",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fapilinks%2Fprototype.json?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -0,0 +1,5 @@\n+{\n+  \"prototype.Class\": \"prototype.js#L5\",\n+  \"Class.classMethod\": \"prototype.js#L8\",\n+  \"class.instanceMethod\": \"prototype.js#L9\"\n+}"
        },
        {
            "sha": "98dd7827d67ac0e537ded27917068f952acc2683",
            "filename": "tools/doc/apilinks.js",
            "status": "added",
            "additions": 141,
            "deletions": 0,
            "changes": 141,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/tools%2Fdoc%2Fapilinks.js",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/tools%2Fdoc%2Fapilinks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fapilinks.js?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -0,0 +1,141 @@\n+'use strict';\n+\n+// Scan API sources for definitions.\n+//\n+// Note the output is produced based on a world class parser, adherence to\n+// conventions, and a bit of guess work. Examples:\n+//\n+//  * We scan for top level module.exports statements, and determine what\n+//    is exported by looking at the source code only (i.e., we don't do\n+//    an eval). If exports include `Foo`, it probably is a class, whereas\n+//    if what is exported is `constants` it probably is prefixed by the\n+//    basename of the source file (e.g., `zlib`), unless that source file is\n+//    `buffer.js`, in which case the name is just `buf`.  unless the constant\n+//    is `kMaxLength`, in which case it is `buffer`.\n+//\n+//  * We scan for top level definitions for those exports, handling\n+//    most common cases (e.g., `X.prototype.foo =`, `X.foo =`,\n+//    `function X(...) {...}`). Over time, we expect to handle more\n+//    cases (example: ES2015 class definitions).\n+\n+const acorn = require('../../deps/acorn');\n+const fs = require('fs');\n+const path = require('path');\n+const child_process = require('child_process');\n+\n+// Run a command, capturing stdout, ignoring errors.\n+function execSync(command) {\n+  try {\n+    return child_process.execSync(\n+      command,\n+      { stdio: ['ignore', null, 'ignore'] }\n+    ).toString().trim();\n+  } catch {\n+    return '';\n+  }\n+}\n+\n+// Determine orign repo and tag (or hash) of the most recent commit.\n+const local_branch = execSync('git name-rev --name-only HEAD');\n+const tracking_remote = execSync(`git config branch.${local_branch}.remote`);\n+const remote_url = execSync(`git config remote.${tracking_remote}.url`);\n+const repo = (remote_url.match(/(\\w+\\/\\w+)\\.git\\r?\\n?$/) ||\n+             ['', 'nodejs/node'])[1];\n+\n+const hash = execSync('git log -1 --pretty=%H') || 'master';\n+const tag = execSync(`git describe --contains ${hash}`).split('\\n')[0] || hash;\n+\n+// Extract definitions from each file specified.\n+const definition = {};\n+process.argv.slice(2).forEach((file) => {\n+  const basename = path.basename(file, '.js');\n+\n+  // Parse source.\n+  const source = fs.readFileSync(file, 'utf8');\n+  const ast = acorn.parse(source, { ecmaVersion: 10, locations: true });\n+  const program = ast.body;\n+\n+  // Scan for exports.\n+  const exported = { constructors: [], identifiers: [] };\n+  program.forEach((statement) => {\n+    if (statement.type !== 'ExpressionStatement') return;\n+    const expr = statement.expression;\n+    if (expr.type !== 'AssignmentExpression') return;\n+\n+    let lhs = expr.left;\n+    if (expr.left.object.type === 'MemberExpression') lhs = lhs.object;\n+    if (lhs.type !== 'MemberExpression') return;\n+    if (lhs.object.name !== 'module') return;\n+    if (lhs.property.name !== 'exports') return;\n+\n+    let rhs = expr.right;\n+    while (rhs.type === 'AssignmentExpression') rhs = rhs.right;\n+\n+    if (rhs.type === 'NewExpression') {\n+      exported.constructors.push(rhs.callee.name);\n+    } else if (rhs.type === 'ObjectExpression') {\n+      rhs.properties.forEach((property) => {\n+        if (property.value.type === 'Identifier') {\n+          exported.identifiers.push(property.value.name);\n+          if (/^[A-Z]/.test(property.value.name[0])) {\n+            exported.constructors.push(property.value.name);\n+          }\n+        }\n+      });\n+    } else if (rhs.type === 'Identifier') {\n+      exported.identifiers.push(rhs.name);\n+    }\n+  });\n+\n+  // Scan for definitions matching those exports; currently supports:\n+  //\n+  //   ClassName.foo = ...;\n+  //   ClassName.prototype.foo = ...;\n+  //   function Identifier(...) {...};\n+  //\n+  const link = `https://github.com/${repo}/blob/${tag}/` +\n+    path.relative('.', file).replace(/\\\\/g, '/');\n+\n+  program.forEach((statement) => {\n+    if (statement.type === 'ExpressionStatement') {\n+      const expr = statement.expression;\n+      if (expr.type !== 'AssignmentExpression') return;\n+      if (expr.left.type !== 'MemberExpression') return;\n+\n+      let object;\n+      if (expr.left.object.type === 'MemberExpression') {\n+        if (expr.left.object.property.name !== 'prototype') return;\n+        object = expr.left.object.object;\n+      } else if (expr.left.object.type === 'Identifier') {\n+        object = expr.left.object;\n+      } else {\n+        return;\n+      }\n+\n+      if (!exported.constructors.includes(object.name)) return;\n+\n+      let objectName = object.name;\n+      if (expr.left.object.type === 'MemberExpression') {\n+        objectName = objectName.toLowerCase();\n+        if (objectName === 'buffer') objectName = 'buf';\n+      }\n+\n+      let name = expr.left.property.name;\n+      if (expr.left.computed) {\n+        name = `${objectName}[${name}]`;\n+      } else {\n+        name = `${objectName}.${name}`;\n+      }\n+\n+      definition[name] = `${link}#L${statement.loc.start.line}`;\n+    } else if (statement.type === 'FunctionDeclaration') {\n+      const name = statement.id.name;\n+      if (!exported.identifiers.includes(name)) return;\n+      if (basename.startsWith('_')) return;\n+      definition[`${basename}.${name}`] =\n+        `${link}#L${statement.loc.start.line}`;\n+    }\n+  });\n+});\n+\n+console.log(JSON.stringify(definition, null, 2));"
        },
        {
            "sha": "28e09d003fa6dbe1c316884b83aa1d7febf4ba36",
            "filename": "tools/doc/generate.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/tools%2Fdoc%2Fgenerate.js",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/tools%2Fdoc%2Fgenerate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fgenerate.js?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -40,6 +40,7 @@ let filename = null;\n let nodeVersion = null;\n let analytics = null;\n let outputDir = null;\n+let apilinks = {};\n \n args.forEach(function(arg) {\n   if (!arg.startsWith('--')) {\n@@ -50,6 +51,10 @@ args.forEach(function(arg) {\n     analytics = arg.replace(/^--analytics=/, '');\n   } else if (arg.startsWith('--output-directory=')) {\n     outputDir = arg.replace(/^--output-directory=/, '');\n+  } else if (arg.startsWith('--apilinks=')) {\n+    apilinks = JSON.parse(\n+      fs.readFileSync(arg.replace(/^--apilinks=/, ''), 'utf8')\n+    );\n   }\n });\n \n@@ -71,7 +76,7 @@ fs.readFile(filename, 'utf8', (er, input) => {\n     .use(json.jsonAPI, { filename })\n     .use(html.firstHeader)\n     .use(html.preprocessElements, { filename })\n-    .use(html.buildToc, { filename })\n+    .use(html.buildToc, { filename, apilinks })\n     .use(remark2rehype, { allowDangerousHTML: true })\n     .use(raw)\n     .use(htmlStringify)"
        },
        {
            "sha": "899605437ce7b339514845bd610394fb569a33c5",
            "filename": "tools/doc/html.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/60465700ed055640e737ca3a53e16465dfec00d6/tools%2Fdoc%2Fhtml.js",
            "raw_url": "https://github.com/nodejs/node/raw/60465700ed055640e737ca3a53e16465dfec00d6/tools%2Fdoc%2Fhtml.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fhtml.js?ref=60465700ed055640e737ca3a53e16465dfec00d6",
            "patch": "@@ -329,7 +329,7 @@ function versionSort(a, b) {\n   return +b.match(numberRe)[0] - +a.match(numberRe)[0];\n }\n \n-function buildToc({ filename }) {\n+function buildToc({ filename, apilinks }) {\n   return (tree, file) => {\n     const startIncludeRefRE = /^\\s*<!-- \\[start-include:(.+)\\] -->\\s*$/;\n     const endIncludeRefRE = /^\\s*<!-- \\[end-include:.+\\] -->\\s*$/;\n@@ -376,6 +376,11 @@ function buildToc({ filename }) {\n                   `id=\"${headingText}\">#</a></span>`;\n       }\n \n+      const api = headingText.replace(/^.*:\\s+/, '').replace(/\\(.*/, '');\n+      if (apilinks[api]) {\n+        anchor = `<a class=\"srclink\" href=${apilinks[api]}>[src]</a>${anchor}`;\n+      }\n+\n       node.children.push({ type: 'html', value: anchor });\n     });\n "
        }
    ],
    "stats": {
        "total": 256,
        "additions": 252,
        "deletions": 4
    }
}