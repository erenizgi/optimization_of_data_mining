{
    "author": "addaleax",
    "message": "test,inspector: add heap allocation tracker test\n\nThis provides coverage for the `InspectorTimer` instances\ncreated as part of heap allocation tracking.\n\nPR-URL: https://github.com/nodejs/node/pull/26089\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "cfcbfc001150e088b489b1fb3de50d516f4e3c65",
    "files": [
        {
            "sha": "0003a8fb694f1d085f7a6caabe97c304baa4f434",
            "filename": "test/parallel/test-inspector-heap-allocation-tracker.js",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/cfcbfc001150e088b489b1fb3de50d516f4e3c65/test%2Fparallel%2Ftest-inspector-heap-allocation-tracker.js",
            "raw_url": "https://github.com/nodejs/node/raw/cfcbfc001150e088b489b1fb3de50d516f4e3c65/test%2Fparallel%2Ftest-inspector-heap-allocation-tracker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-inspector-heap-allocation-tracker.js?ref=cfcbfc001150e088b489b1fb3de50d516f4e3c65",
            "patch": "@@ -0,0 +1,46 @@\n+'use strict';\n+const common = require('../common');\n+\n+common.skipIfInspectorDisabled();\n+\n+const assert = require('assert');\n+const inspector = require('inspector');\n+const stream = require('stream');\n+const { Worker, workerData } = require('worker_threads');\n+\n+const session = new inspector.Session();\n+session.connect();\n+session.post('HeapProfiler.enable');\n+session.post('HeapProfiler.startTrackingHeapObjects',\n+             { trackAllocations: true });\n+\n+// Perform some silly heap allocations for the next 100 ms.\n+const interval = setInterval(() => {\n+  new stream.PassThrough().end('abc').on('data', common.mustCall());\n+}, 1);\n+\n+setTimeout(() => {\n+  clearInterval(interval);\n+\n+  // Once the main test is done, we re-run it from inside a Worker thread\n+  // and stop early, as that is a good way to make sure the timer handles\n+  // internally created by the inspector are cleaned up properly.\n+  if (workerData === 'stopEarly')\n+    process.exit();\n+\n+  let data = '';\n+  session.on('HeapProfiler.addHeapSnapshotChunk',\n+             common.mustCallAtLeast((event) => {\n+               data += event.params.chunk;\n+             }));\n+\n+  // TODO(addaleax): Using `{ reportProgress: true }` crashes the process\n+  // because the progress indication event would mean calling into JS while\n+  // a heap snapshot is being taken, which is forbidden.\n+  // What can we do about that?\n+  session.post('HeapProfiler.stopTrackingHeapObjects');\n+\n+  assert(data.includes('PassThrough'), data);\n+\n+  new Worker(__filename, { workerData: 'stopEarly' });\n+}, 100);"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 46,
        "deletions": 0
    }
}