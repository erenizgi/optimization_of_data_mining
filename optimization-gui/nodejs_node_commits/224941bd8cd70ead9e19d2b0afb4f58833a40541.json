{
    "author": "jasnell",
    "message": "http2: clean up Http2Settings\n\nUse of a MaybeStackBuffer was just silly. Fix a long standing todo\nReduce code duplication a bit.\n\nPR-URL: https://github.com/nodejs/node/pull/19400\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "224941bd8cd70ead9e19d2b0afb4f58833a40541",
    "files": [
        {
            "sha": "d6f1d6e7659707fc7d1b1af8097f5acd87f475fe",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 47,
            "changes": 62,
            "blob_url": "https://github.com/nodejs/node/blob/224941bd8cd70ead9e19d2b0afb4f58833a40541/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/224941bd8cd70ead9e19d2b0afb4f58833a40541/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=224941bd8cd70ead9e19d2b0afb4f58833a40541",
            "patch": "@@ -190,60 +190,28 @@ Http2Options::Http2Options(Environment* env) {\n }\n \n void Http2Session::Http2Settings::Init() {\n-  entries_.AllocateSufficientStorage(IDX_SETTINGS_COUNT);\n   AliasedBuffer<uint32_t, v8::Uint32Array>& buffer =\n       env()->http2_state()->settings_buffer;\n   uint32_t flags = buffer[IDX_SETTINGS_COUNT];\n \n   size_t n = 0;\n \n-  if (flags & (1 << IDX_SETTINGS_HEADER_TABLE_SIZE)) {\n-    uint32_t val = buffer[IDX_SETTINGS_HEADER_TABLE_SIZE];\n-    DEBUG_HTTP2SESSION2(session_, \"setting header table size: %d\\n\", val);\n-    entries_[n].settings_id = NGHTTP2_SETTINGS_HEADER_TABLE_SIZE;\n-    entries_[n].value = val;\n-    n++;\n+#define GRABSETTING(N, trace)                                                 \\\n+  if (flags & (1 << IDX_SETTINGS_##N)) {                                      \\\n+    uint32_t val = buffer[IDX_SETTINGS_##N];                                  \\\n+    DEBUG_HTTP2SESSION2(session_, \"setting \" trace \": %d\\n\", val);            \\\n+    entries_[n++] =                                                           \\\n+        nghttp2_settings_entry {NGHTTP2_SETTINGS_##N, val};                   \\\n   }\n \n-  if (flags & (1 << IDX_SETTINGS_MAX_CONCURRENT_STREAMS)) {\n-    uint32_t val = buffer[IDX_SETTINGS_MAX_CONCURRENT_STREAMS];\n-    DEBUG_HTTP2SESSION2(session_, \"setting max concurrent streams: %d\\n\", val);\n-    entries_[n].settings_id = NGHTTP2_SETTINGS_MAX_CONCURRENT_STREAMS;\n-    entries_[n].value = val;\n-    n++;\n-  }\n-\n-  if (flags & (1 << IDX_SETTINGS_MAX_FRAME_SIZE)) {\n-    uint32_t val = buffer[IDX_SETTINGS_MAX_FRAME_SIZE];\n-    DEBUG_HTTP2SESSION2(session_, \"setting max frame size: %d\\n\", val);\n-    entries_[n].settings_id = NGHTTP2_SETTINGS_MAX_FRAME_SIZE;\n-    entries_[n].value = val;\n-    n++;\n-  }\n-\n-  if (flags & (1 << IDX_SETTINGS_INITIAL_WINDOW_SIZE)) {\n-    uint32_t val = buffer[IDX_SETTINGS_INITIAL_WINDOW_SIZE];\n-    DEBUG_HTTP2SESSION2(session_, \"setting initial window size: %d\\n\", val);\n-    entries_[n].settings_id = NGHTTP2_SETTINGS_INITIAL_WINDOW_SIZE;\n-    entries_[n].value = val;\n-    n++;\n-  }\n-\n-  if (flags & (1 << IDX_SETTINGS_MAX_HEADER_LIST_SIZE)) {\n-    uint32_t val = buffer[IDX_SETTINGS_MAX_HEADER_LIST_SIZE];\n-    DEBUG_HTTP2SESSION2(session_, \"setting max header list size: %d\\n\", val);\n-    entries_[n].settings_id = NGHTTP2_SETTINGS_MAX_HEADER_LIST_SIZE;\n-    entries_[n].value = val;\n-    n++;\n-  }\n+  GRABSETTING(HEADER_TABLE_SIZE, \"header table size\");\n+  GRABSETTING(MAX_CONCURRENT_STREAMS, \"max concurrent streams\");\n+  GRABSETTING(MAX_FRAME_SIZE, \"max frame size\");\n+  GRABSETTING(INITIAL_WINDOW_SIZE, \"initial window size\");\n+  GRABSETTING(MAX_HEADER_LIST_SIZE, \"max header list size\");\n+  GRABSETTING(ENABLE_PUSH, \"enable push\");\n \n-  if (flags & (1 << IDX_SETTINGS_ENABLE_PUSH)) {\n-    uint32_t val = buffer[IDX_SETTINGS_ENABLE_PUSH];\n-    DEBUG_HTTP2SESSION2(session_, \"setting enable push: %d\\n\", val);\n-    entries_[n].settings_id = NGHTTP2_SETTINGS_ENABLE_PUSH;\n-    entries_[n].value = val;\n-    n++;\n-  }\n+#undef GRABSETTING\n \n   count_ = n;\n }\n@@ -289,7 +257,7 @@ Local<Value> Http2Session::Http2Settings::Pack() {\n   ssize_t ret =\n       nghttp2_pack_settings_payload(\n         reinterpret_cast<uint8_t*>(Buffer::Data(buf)), len,\n-        *entries_, count_);\n+        &entries_[0], count_);\n   if (ret >= 0)\n     return buf;\n   else\n@@ -344,7 +312,7 @@ void Http2Session::Http2Settings::RefreshDefaults(Environment* env) {\n void Http2Session::Http2Settings::Send() {\n   Http2Scope h2scope(session_);\n   CHECK_EQ(nghttp2_submit_settings(**session_, NGHTTP2_FLAG_NONE,\n-                                   *entries_, length()), 0);\n+                                   &entries_[0], count_), 0);\n }\n \n void Http2Session::Http2Settings::Done(bool ack) {"
        },
        {
            "sha": "9dd65667f90670016c92c6e68c781ee3e9b57175",
            "filename": "src/node_http2.h",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/224941bd8cd70ead9e19d2b0afb4f58833a40541/src%2Fnode_http2.h",
            "raw_url": "https://github.com/nodejs/node/raw/224941bd8cd70ead9e19d2b0afb4f58833a40541/src%2Fnode_http2.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.h?ref=224941bd8cd70ead9e19d2b0afb4f58833a40541",
            "patch": "@@ -1185,12 +1185,6 @@ class Http2Session::Http2Settings : public AsyncWrap {\n   void Send();\n   void Done(bool ack);\n \n-  size_t length() const { return count_; }\n-\n-  nghttp2_settings_entry* operator*() {\n-    return *entries_;\n-  }\n-\n   // Returns a Buffer instance with the serialized SETTINGS payload\n   Local<Value> Pack();\n \n@@ -1207,7 +1201,7 @@ class Http2Session::Http2Settings : public AsyncWrap {\n   Http2Session* session_;\n   uint64_t startTime_;\n   size_t count_ = 0;\n-  MaybeStackBuffer<nghttp2_settings_entry, IDX_SETTINGS_COUNT> entries_;\n+  nghttp2_settings_entry entries_[IDX_SETTINGS_COUNT];\n };\n \n class ExternalHeader :"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 16,
        "deletions": 54
    }
}