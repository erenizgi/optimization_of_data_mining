{
    "author": "mcollina",
    "message": "stream: make async iterator .next() always resolve\n\nSee: https://github.com/nodejs/readable-stream/issues/387\n\nPR-URL: https://github.com/nodejs/node/pull/24668\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "fa1535aed7f8dcfe0400f6359c068253032f5973",
    "files": [
        {
            "sha": "cc8e218498f9956a335dd3901afe9886178fbefb",
            "filename": "lib/internal/streams/async_iterator.js",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/fa1535aed7f8dcfe0400f6359c068253032f5973/lib%2Finternal%2Fstreams%2Fasync_iterator.js",
            "raw_url": "https://github.com/nodejs/node/raw/fa1535aed7f8dcfe0400f6359c068253032f5973/lib%2Finternal%2Fstreams%2Fasync_iterator.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstreams%2Fasync_iterator.js?ref=fa1535aed7f8dcfe0400f6359c068253032f5973",
            "patch": "@@ -39,6 +39,11 @@ function onReadable(iter) {\n function wrapForNext(lastPromise, iter) {\n   return (resolve, reject) => {\n     lastPromise.then(() => {\n+      if (iter[kEnded]) {\n+        resolve(createIterResult(undefined, true));\n+        return;\n+      }\n+\n       iter[kHandlePromise](resolve, reject);\n     }, reject);\n   };\n@@ -61,7 +66,7 @@ const ReadableStreamAsyncIteratorPrototype = Object.setPrototypeOf({\n     }\n \n     if (this[kEnded]) {\n-      return Promise.resolve(createIterResult(null, true));\n+      return Promise.resolve(createIterResult(undefined, true));\n     }\n \n     if (this[kStream].destroyed) {\n@@ -74,7 +79,7 @@ const ReadableStreamAsyncIteratorPrototype = Object.setPrototypeOf({\n           if (this[kError]) {\n             reject(this[kError]);\n           } else {\n-            resolve(createIterResult(null, true));\n+            resolve(createIterResult(undefined, true));\n           }\n         });\n       });\n@@ -115,7 +120,7 @@ const ReadableStreamAsyncIteratorPrototype = Object.setPrototypeOf({\n           reject(err);\n           return;\n         }\n-        resolve(createIterResult(null, true));\n+        resolve(createIterResult(undefined, true));\n       });\n     });\n   },\n@@ -131,7 +136,6 @@ const createReadableStreamAsyncIterator = (stream) => {\n       value: stream._readableState.endEmitted,\n       writable: true\n     },\n-    [kLastPromise]: { value: null, writable: true },\n     // the function passed to new Promise\n     // is cached so we avoid allocating a new\n     // closure at every run\n@@ -151,6 +155,7 @@ const createReadableStreamAsyncIterator = (stream) => {\n       writable: true,\n     },\n   });\n+  iterator[kLastPromise] = null;\n \n   finished(stream, (err) => {\n     if (err && err.code !== 'ERR_STREAM_PREMATURE_CLOSE') {\n@@ -172,7 +177,7 @@ const createReadableStreamAsyncIterator = (stream) => {\n       iterator[kLastPromise] = null;\n       iterator[kLastResolve] = null;\n       iterator[kLastReject] = null;\n-      resolve(createIterResult(null, true));\n+      resolve(createIterResult(undefined, true));\n     }\n     iterator[kEnded] = true;\n   });"
        },
        {
            "sha": "aca1e5bcc9d18d74fe4cf41bae8e809d2ed8f81e",
            "filename": "test/parallel/test-stream-readable-async-iterators.js",
            "status": "modified",
            "additions": 65,
            "deletions": 0,
            "changes": 65,
            "blob_url": "https://github.com/nodejs/node/blob/fa1535aed7f8dcfe0400f6359c068253032f5973/test%2Fparallel%2Ftest-stream-readable-async-iterators.js",
            "raw_url": "https://github.com/nodejs/node/raw/fa1535aed7f8dcfe0400f6359c068253032f5973/test%2Fparallel%2Ftest-stream-readable-async-iterators.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-async-iterators.js?ref=fa1535aed7f8dcfe0400f6359c068253032f5973",
            "patch": "@@ -393,6 +393,71 @@ async function tests() {\n       r.destroy(null);\n     }\n   })();\n+\n+  await (async () => {\n+    console.log('all next promises must be resolved on end');\n+    const r = new Readable({\n+      objectMode: true,\n+      read() {\n+      }\n+    });\n+\n+    const b = r[Symbol.asyncIterator]();\n+    const c = b.next();\n+    const d = b.next();\n+    r.push(null);\n+    assert.deepStrictEqual(await c, { done: true, value: undefined });\n+    assert.deepStrictEqual(await d, { done: true, value: undefined });\n+  })();\n+\n+  await (async () => {\n+    console.log('all next promises must be resolved on destroy');\n+    const r = new Readable({\n+      objectMode: true,\n+      read() {\n+      }\n+    });\n+\n+    const b = r[Symbol.asyncIterator]();\n+    const c = b.next();\n+    const d = b.next();\n+    r.destroy();\n+    assert.deepStrictEqual(await c, { done: true, value: undefined });\n+    assert.deepStrictEqual(await d, { done: true, value: undefined });\n+  })();\n+\n+  await (async () => {\n+    console.log('all next promises must be resolved on destroy with error');\n+    const r = new Readable({\n+      objectMode: true,\n+      read() {\n+      }\n+    });\n+\n+    const b = r[Symbol.asyncIterator]();\n+    const c = b.next();\n+    const d = b.next();\n+    const err = new Error('kaboom');\n+    r.destroy(err);\n+\n+    await Promise.all([(async () => {\n+      let e;\n+      try {\n+        await c;\n+      } catch (_e) {\n+        e = _e;\n+      }\n+      assert.strictEqual(e, err);\n+    })(), (async () => {\n+      let e;\n+      try {\n+        await d;\n+      } catch (_e) {\n+        e = _e;\n+      }\n+      assert.strictEqual(e, err);\n+    })()]);\n+  })();\n }\n \n // to avoid missing some tests if a promise does not resolve"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 75,
        "deletions": 5
    }
}