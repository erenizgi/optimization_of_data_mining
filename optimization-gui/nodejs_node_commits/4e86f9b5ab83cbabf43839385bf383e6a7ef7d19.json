{
    "author": "lpinca",
    "message": "net: do not inherit the no-half-open enforcer\n\n`Socket.prototype.destroySoon()` is called as soon as `UV_EOF` is read\nif the `allowHalfOpen` option is disabled. This already works as a\n\"no-half-open enforcer\" so there is no need to inherit another from\n`stream.Duplex`.\n\nPR-URL: https://github.com/nodejs/node/pull/18974\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Chen Gang <gangc.cxy@foxmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "4e86f9b5ab83cbabf43839385bf383e6a7ef7d19",
    "files": [
        {
            "sha": "7fa1e20aedaec58994beea57d59749456d50e82f",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/4e86f9b5ab83cbabf43839385bf383e6a7ef7d19/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/4e86f9b5ab83cbabf43839385bf383e6a7ef7d19/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=4e86f9b5ab83cbabf43839385bf383e6a7ef7d19",
            "patch": "@@ -64,6 +64,7 @@ const {\n   ERR_SOCKET_BAD_PORT,\n   ERR_SOCKET_CLOSED\n } = errors.codes;\n+const DuplexBase = require('internal/streams/duplex_base');\n const dns = require('dns');\n \n const kLastWriteQueueSize = Symbol('lastWriteQueueSize');\n@@ -238,7 +239,11 @@ function Socket(options) {\n   // For backwards compat do not emit close on destroy.\n   options.emitClose = false;\n \n-  stream.Duplex.call(this, options);\n+  // `DuplexBase` is just a slimmed down constructor for `Duplex` which allow\n+  // us to not inherit the \"no-half-open enforcer\" as there is already one in\n+  // place. Instances of `Socket` are still instances of `Duplex`, that is,\n+  // `socket instanceof Duplex === true`.\n+  DuplexBase.call(this, options);\n \n   if (options.handle) {\n     this._handle = options.handle; // private\n@@ -263,8 +268,6 @@ function Socket(options) {\n       this._writev = null;\n       this._write = makeSyncWrite(fd);\n     }\n-    this.readable = options.readable !== false;\n-    this.writable = options.writable !== false;\n   } else {\n     // these will be set once there is a connection\n     this.readable = this.writable = false;\n@@ -282,7 +285,7 @@ function Socket(options) {\n   this._writableState.decodeStrings = false;\n \n   // default to *not* allowing half open sockets\n-  this.allowHalfOpen = options && options.allowHalfOpen || false;\n+  this.allowHalfOpen = options.allowHalfOpen || false;\n \n   // if we have a handle, then start the flow of data into the\n   // buffer.  if not, then this will happen when we connect"
        },
        {
            "sha": "ec2c8846bbb1345e5f85d347f62420acfdafe881",
            "filename": "test/parallel/test-http-connect.js",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/4e86f9b5ab83cbabf43839385bf383e6a7ef7d19/test%2Fparallel%2Ftest-http-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/4e86f9b5ab83cbabf43839385bf383e6a7ef7d19/test%2Fparallel%2Ftest-http-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-connect.js?ref=4e86f9b5ab83cbabf43839385bf383e6a7ef7d19",
            "patch": "@@ -75,12 +75,7 @@ server.listen(0, common.mustCall(() => {\n     assert.strictEqual(socket.listeners('connect').length, 0);\n     assert.strictEqual(socket.listeners('data').length, 0);\n     assert.strictEqual(socket.listeners('drain').length, 0);\n-\n-    // the stream.Duplex onend listener\n-    // allow 0 here, so that i can run the same test on streams1 impl\n-    assert(socket.listenerCount('end') <= 2,\n-           `Found ${socket.listenerCount('end')} end listeners`);\n-\n+    assert.strictEqual(socket.listeners('end').length, 1);\n     assert.strictEqual(socket.listeners('free').length, 0);\n     assert.strictEqual(socket.listeners('close').length, 0);\n     assert.strictEqual(socket.listeners('error').length, 0);"
        },
        {
            "sha": "3df5b6d7b9c8cbb09eb105c667e29e297b294b9e",
            "filename": "test/parallel/test-net-socket-no-halfopen-enforcer.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/4e86f9b5ab83cbabf43839385bf383e6a7ef7d19/test%2Fparallel%2Ftest-net-socket-no-halfopen-enforcer.js",
            "raw_url": "https://github.com/nodejs/node/raw/4e86f9b5ab83cbabf43839385bf383e6a7ef7d19/test%2Fparallel%2Ftest-net-socket-no-halfopen-enforcer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-socket-no-halfopen-enforcer.js?ref=4e86f9b5ab83cbabf43839385bf383e6a7ef7d19",
            "patch": "@@ -0,0 +1,11 @@\n+'use strict';\n+require('../common');\n+\n+// This test ensures that `net.Socket` does not inherit the no-half-open\n+// enforcer from `stream.Duplex`.\n+\n+const { Socket } = require('net');\n+const { strictEqual } = require('assert');\n+\n+const socket = new Socket({ allowHalfOpen: false });\n+strictEqual(socket.listenerCount('end'), 1);"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 19,
        "deletions": 10
    }
}