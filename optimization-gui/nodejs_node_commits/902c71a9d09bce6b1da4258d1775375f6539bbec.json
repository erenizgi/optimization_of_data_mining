{
    "author": "addaleax",
    "message": "test: add `Worker` + `--prof` regression test\n\nFixes: https://github.com/nodejs/node/issues/24016\n\nPR-URL: https://github.com/nodejs/node/pull/26011\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "902c71a9d09bce6b1da4258d1775375f6539bbec",
    "files": [
        {
            "sha": "5b0703f5f9b5ca12ca22af0494d55881f38a86ae",
            "filename": "test/parallel/test-worker-prof.js",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/902c71a9d09bce6b1da4258d1775375f6539bbec/test%2Fparallel%2Ftest-worker-prof.js",
            "raw_url": "https://github.com/nodejs/node/raw/902c71a9d09bce6b1da4258d1775375f6539bbec/test%2Fparallel%2Ftest-worker-prof.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-prof.js?ref=902c71a9d09bce6b1da4258d1775375f6539bbec",
            "patch": "@@ -0,0 +1,41 @@\n+'use strict';\n+const common = require('../common');\n+const tmpdir = require('../common/tmpdir');\n+const fs = require('fs');\n+const assert = require('assert');\n+const { spawnSync } = require('child_process');\n+const { Worker } = require('worker_threads');\n+\n+if (!common.isMainThread)\n+  common.skip('process.chdir is not available in Workers');\n+\n+// Test that --prof also tracks Worker threads.\n+// Refs: https://github.com/nodejs/node/issues/24016\n+\n+if (process.argv[2] === 'child') {\n+  const spin = `\n+  const start = Date.now();\n+  while (Date.now() - start < 200);\n+  `;\n+  new Worker(spin, { eval: true });\n+  eval(spin);\n+  return;\n+}\n+\n+tmpdir.refresh();\n+process.chdir(tmpdir.path);\n+spawnSync(process.execPath, ['--prof', __filename, 'child']);\n+const logfiles = fs.readdirSync('.').filter((name) => /\\.log$/.test(name));\n+assert.strictEqual(logfiles.length, 2);  // Parent thread + child thread.\n+\n+for (const logfile of logfiles) {\n+  const lines = fs.readFileSync(logfile, 'utf8').split('\\n');\n+  const ticks = lines.filter((line) => /^tick,/.test(line)).length;\n+\n+  // Test that at least 20 ticks have been recorded for both parent and child\n+  // threads. When not tracking Worker threads, only 1 or 2 ticks would\n+  // have been recorded.\n+  // When running locally on x64 Linux, this number is usually at least 150\n+  // for both threads, so 15 seems like a very safe threshold.\n+  assert(ticks >= 15, `${ticks} >= 15`);\n+}"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 41,
        "deletions": 0
    }
}