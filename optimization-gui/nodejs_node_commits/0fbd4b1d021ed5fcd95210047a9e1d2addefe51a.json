{
    "author": "BridgeAR",
    "message": "util: improve iterator inspect output\n\n1) So far extra keys on an (Set|Map)Iterator were ignored. Those\n   will now be visible.\n2) Improve the performance of showing (Set|Map)Iterator by using\n   the cloned iterator instead of copying all entries first.\n3) So far the output was strictly limited to up to 100 entries.\n   The limit will now depend on `maxArrayLength` instead (that\n   default is set to 100 as well) and the output indicates that\n   more entries exist than visible.\n\nPR-URL: https://github.com/nodejs/node/pull/19259\nReviewed-By: Yosuke Furukawa <yosuke.furukawa@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "0fbd4b1d021ed5fcd95210047a9e1d2addefe51a",
    "files": [
        {
            "sha": "9055e8c41986c3d43e1443811e4592dfb36d2a2c",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/0fbd4b1d021ed5fcd95210047a9e1d2addefe51a/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/0fbd4b1d021ed5fcd95210047a9e1d2addefe51a/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=0fbd4b1d021ed5fcd95210047a9e1d2addefe51a",
            "patch": "@@ -471,8 +471,8 @@\n     // functions lazily (unless --nolazy is set) so we need to do this\n     // before we turn off --allow_natives_syntax again.\n     const v8 = NativeModule.require('internal/v8');\n-    v8.previewMapIterator(new Map().entries(), 1);\n-    v8.previewSetIterator(new Set().entries(), 1);\n+    v8.previewMapIterator(new Map().entries());\n+    v8.previewSetIterator(new Set().entries());\n     // Disable --allow_natives_syntax again unless it was explicitly\n     // specified on the command line.\n     const re = /^--allow[-_]natives[-_]syntax$/;"
        },
        {
            "sha": "92d5beb7c4ca37f7f502f6bc45d5705b937fa138",
            "filename": "lib/internal/v8.js",
            "status": "modified",
            "additions": 16,
            "deletions": 14,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/0fbd4b1d021ed5fcd95210047a9e1d2addefe51a/lib%2Finternal%2Fv8.js",
            "raw_url": "https://github.com/nodejs/node/raw/0fbd4b1d021ed5fcd95210047a9e1d2addefe51a/lib%2Finternal%2Fv8.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fv8.js?ref=0fbd4b1d021ed5fcd95210047a9e1d2addefe51a",
            "patch": "@@ -1,21 +1,23 @@\n 'use strict';\n \n-function take(it, n) {\n-  const result = [];\n-  for (const e of it) {\n-    if (--n < 0)\n-      break;\n-    result.push(e);\n-  }\n-  return result;\n-}\n+// This file provides access to some of V8's native runtime functions. See\n+// https://github.com/v8/v8/wiki/Built-in-functions for further information\n+// about their implementation.\n+// They have to be loaded before anything else to make sure we deactivate them\n+// before executing any other code. Gaining access is achieved by using a\n+// specific flag that is used internally in the startup phase.\n \n-function previewMapIterator(it, n) {\n-  return take(%MapIteratorClone(it), n);\n+// Clone the provided Map Iterator.\n+function previewMapIterator(it) {\n+  return %MapIteratorClone(it);\n }\n \n-function previewSetIterator(it, n) {\n-  return take(%SetIteratorClone(it), n);\n+// Clone the provided Set Iterator.\n+function previewSetIterator(it) {\n+  return %SetIteratorClone(it);\n }\n \n-module.exports = { previewMapIterator, previewSetIterator };\n+module.exports = {\n+  previewMapIterator,\n+  previewSetIterator\n+};"
        },
        {
            "sha": "774b185095c53a0ab6b1c96cccf6d0313d0af04d",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 18,
            "deletions": 11,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/0fbd4b1d021ed5fcd95210047a9e1d2addefe51a/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/0fbd4b1d021ed5fcd95210047a9e1d2addefe51a/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=0fbd4b1d021ed5fcd95210047a9e1d2addefe51a",
            "patch": "@@ -30,7 +30,10 @@ const {\n const { TextDecoder, TextEncoder } = require('internal/encoding');\n const { isBuffer } = require('buffer').Buffer;\n \n-const { previewMapIterator, previewSetIterator } = require('internal/v8');\n+const {\n+  previewMapIterator,\n+  previewSetIterator\n+} = require('internal/v8');\n \n const {\n   getPromiseDetails,\n@@ -836,25 +839,29 @@ function formatMap(ctx, value, recurseTimes, keys) {\n   return output;\n }\n \n-function formatCollectionIterator(preview, ctx, value, recurseTimes,\n-                                  visibleKeys, keys) {\n-  const nextRecurseTimes = recurseTimes === null ? null : recurseTimes - 1;\n-  const vals = preview(value, 100);\n+function formatCollectionIterator(preview, ctx, value, recurseTimes, keys) {\n   const output = [];\n-  for (const o of vals) {\n-    output.push(formatValue(ctx, o, nextRecurseTimes));\n+  for (const entry of preview(value)) {\n+    if (ctx.maxArrayLength === output.length) {\n+      output.push('... more items');\n+      break;\n+    }\n+    output.push(formatValue(ctx, entry, recurseTimes));\n+  }\n+  for (var n = 0; n < keys.length; n++) {\n+    output.push(formatProperty(ctx, value, recurseTimes, keys[n], 0));\n   }\n   return output;\n }\n \n-function formatMapIterator(ctx, value, recurseTimes, visibleKeys, keys) {\n+function formatMapIterator(ctx, value, recurseTimes, keys) {\n   return formatCollectionIterator(previewMapIterator, ctx, value, recurseTimes,\n-                                  visibleKeys, keys);\n+                                  keys);\n }\n \n-function formatSetIterator(ctx, value, recurseTimes, visibleKeys, keys) {\n+function formatSetIterator(ctx, value, recurseTimes, keys) {\n   return formatCollectionIterator(previewSetIterator, ctx, value, recurseTimes,\n-                                  visibleKeys, keys);\n+                                  keys);\n }\n \n function formatPromise(ctx, value, recurseTimes, keys) {"
        },
        {
            "sha": "ab27e69c1832026901ae76397e7fbdb623e55541",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/0fbd4b1d021ed5fcd95210047a9e1d2addefe51a/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/0fbd4b1d021ed5fcd95210047a9e1d2addefe51a/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=0fbd4b1d021ed5fcd95210047a9e1d2addefe51a",
            "patch": "@@ -448,7 +448,7 @@ assert.strictEqual(util.inspect(-5e-324), '-5e-324');\n {\n   const map = new Map();\n   map.set(1, 2);\n-  const vals = previewMapIterator(map.entries(), 100);\n+  const vals = previewMapIterator(map.entries());\n   const valsOutput = [];\n   for (const o of vals) {\n     valsOutput.push(o);\n@@ -924,6 +924,10 @@ if (typeof Symbol !== 'undefined') {\n   const keys = map.keys();\n   assert.strictEqual(util.inspect(keys), '[Map Iterator] { \\'foo\\' }');\n   assert.strictEqual(util.inspect(keys), '[Map Iterator] { \\'foo\\' }');\n+  keys.extra = true;\n+  assert.strictEqual(\n+    util.inspect(keys, { maxArrayLength: 0 }),\n+    '[Map Iterator] { ... more items, extra: true }');\n }\n \n // Test Set iterators.\n@@ -937,6 +941,10 @@ if (typeof Symbol !== 'undefined') {\n   const keys = aSet.keys();\n   assert.strictEqual(util.inspect(keys), '[Set Iterator] { 1, 3 }');\n   assert.strictEqual(util.inspect(keys), '[Set Iterator] { 1, 3 }');\n+  keys.extra = true;\n+  assert.strictEqual(\n+    util.inspect(keys, { maxArrayLength: 1 }),\n+    '[Set Iterator] { 1, ... more items, extra: true }');\n }\n \n // Test alignment of items in container."
        }
    ],
    "stats": {
        "total": 73,
        "additions": 45,
        "deletions": 28
    }
}