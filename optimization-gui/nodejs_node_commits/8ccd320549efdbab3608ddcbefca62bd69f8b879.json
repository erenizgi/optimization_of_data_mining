{
    "author": "bnoordhuis",
    "message": "src: don't abort when package.json is a directory\n\nPR-URL: https://github.com/nodejs/node/pull/18270\nFixes: https://github.com/nodejs/node/issues/8307\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Bradley Farias <bradley.meck@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Guy Bedford <guybedford@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "8ccd320549efdbab3608ddcbefca62bd69f8b879",
    "files": [
        {
            "sha": "a77dc0a986765b1bdca02039530cd18055d61360",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/8ccd320549efdbab3608ddcbefca62bd69f8b879/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8ccd320549efdbab3608ddcbefca62bd69f8b879/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=8ccd320549efdbab3608ddcbefca62bd69f8b879",
            "patch": "@@ -673,6 +673,12 @@ static void InternalModuleReadJSON(const FunctionCallbackInfo<Value>& args) {\n     return;\n   }\n \n+  std::shared_ptr<void> defer_close(nullptr, [fd, loop] (...) {\n+    uv_fs_t close_req;\n+    CHECK_EQ(0, uv_fs_close(loop, &close_req, fd, nullptr));\n+    uv_fs_req_cleanup(&close_req);\n+  });\n+\n   const size_t kBlockSize = 32 << 10;\n   std::vector<char> chars;\n   int64_t offset = 0;\n@@ -689,14 +695,12 @@ static void InternalModuleReadJSON(const FunctionCallbackInfo<Value>& args) {\n     numchars = uv_fs_read(loop, &read_req, fd, &buf, 1, offset, nullptr);\n     uv_fs_req_cleanup(&read_req);\n \n-    CHECK_GE(numchars, 0);\n+    if (numchars < 0)\n+      return;\n+\n     offset += numchars;\n   } while (static_cast<size_t>(numchars) == kBlockSize);\n \n-  uv_fs_t close_req;\n-  CHECK_EQ(0, uv_fs_close(loop, &close_req, fd, nullptr));\n-  uv_fs_req_cleanup(&close_req);\n-\n   size_t start = 0;\n   if (offset >= 3 && 0 == memcmp(&chars[0], \"\\xEF\\xBB\\xBF\", 3)) {\n     start = 3;  // Skip UTF-8 BOM."
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "test/fixtures/packages/is-dir/package.json/.placeholder",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/nodejs/node/blob/8ccd320549efdbab3608ddcbefca62bd69f8b879/test%2Ffixtures%2Fpackages%2Fis-dir%2Fpackage.json%2F.placeholder",
            "raw_url": "https://github.com/nodejs/node/raw/8ccd320549efdbab3608ddcbefca62bd69f8b879/test%2Ffixtures%2Fpackages%2Fis-dir%2Fpackage.json%2F.placeholder",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fpackages%2Fis-dir%2Fpackage.json%2F.placeholder?ref=8ccd320549efdbab3608ddcbefca62bd69f8b879"
        },
        {
            "sha": "811d7d5ded8576376330f2a3d47d3d81e1eb67c0",
            "filename": "test/parallel/test-module-loading-error.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/8ccd320549efdbab3608ddcbefca62bd69f8b879/test%2Fparallel%2Ftest-module-loading-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/8ccd320549efdbab3608ddcbefca62bd69f8b879/test%2Fparallel%2Ftest-module-loading-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-module-loading-error.js?ref=8ccd320549efdbab3608ddcbefca62bd69f8b879",
            "patch": "@@ -78,3 +78,10 @@ common.expectsError(\n     code: 'ERR_INVALID_ARG_VALUE',\n     message: 'The argument \\'id\\' must be a non-empty string. Received \\'\\''\n   });\n+\n+common.expectsError(\n+  () => { require('../fixtures/packages/is-dir'); },\n+  {\n+    code: 'MODULE_NOT_FOUND',\n+    message: 'Cannot find module \\'../fixtures/packages/is-dir\\''\n+  });"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 16,
        "deletions": 5
    }
}