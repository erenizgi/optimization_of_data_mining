{
    "author": "srl295",
    "message": "build: check minimum ICU in configure for system-icu\n\n- check the version number coming out of pkg-config\n\nPR-URL: https://github.com/nodejs/node/pull/24255\nFixes: https://github.com/nodejs/node/issues/24253\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "ed1c40e977cc5bb87645bc1dcf62d2e25386a2c0",
    "files": [
        {
            "sha": "e6e1810d130573bbf6eaaac06b79f268001fe515",
            "filename": "configure.py",
            "status": "modified",
            "additions": 17,
            "deletions": 8,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/ed1c40e977cc5bb87645bc1dcf62d2e25386a2c0/configure.py",
            "raw_url": "https://github.com/nodejs/node/raw/ed1c40e977cc5bb87645bc1dcf62d2e25386a2c0/configure.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/configure.py?ref=ed1c40e977cc5bb87645bc1dcf62d2e25386a2c0",
            "patch": "@@ -434,7 +434,7 @@\n     dest='with_icu_source',\n     help='Intl mode: optional local path to icu/ dir, or path/URL of '\n         'the icu4c source archive. '\n-        'v%d.x or later recommended.' % icu_versions[\"minimum_icu\"])\n+        'v%d.x or later recommended.' % icu_versions['minimum_icu'])\n \n parser.add_option('--with-ltcg',\n     action='store_true',\n@@ -622,17 +622,21 @@ def b(value):\n \n \n def pkg_config(pkg):\n+  \"\"\"Run pkg-config on the specified package\n+  Returns (\"-l flags\", \"-I flags\", \"-L flags\", \"version\")\n+  otherwise (None, None, None, None)\"\"\"\n   pkg_config = os.environ.get('PKG_CONFIG', 'pkg-config')\n   retval = ()\n-  for flag in ['--libs-only-l', '--cflags-only-I', '--libs-only-L']:\n+  for flag in ['--libs-only-l', '--cflags-only-I',\n+               '--libs-only-L', '--modversion']:\n     try:\n       proc = subprocess.Popen(\n           shlex.split(pkg_config) + ['--silence-errors', flag, pkg],\n           stdout=subprocess.PIPE)\n       val = proc.communicate()[0].strip()\n     except OSError as e:\n       if e.errno != errno.ENOENT: raise e  # Unexpected error.\n-      return (None, None, None)  # No pkg-config/pkgconf installed.\n+      return (None, None, None, None)  # No pkg-config/pkgconf installed.\n     retval += (val,)\n   return retval\n \n@@ -1119,7 +1123,7 @@ def configure_library(lib, output):\n   output['variables']['node_' + shared_lib] = b(getattr(options, shared_lib))\n \n   if getattr(options, shared_lib):\n-    (pkg_libs, pkg_cflags, pkg_libpath) = pkg_config(lib)\n+    (pkg_libs, pkg_cflags, pkg_libpath, pkg_modversion) = pkg_config(lib)\n \n     if options.__dict__[shared_lib + '_includes']:\n       output['include_dirs'] += [options.__dict__[shared_lib + '_includes']]\n@@ -1354,7 +1358,12 @@ def write_config(data, name):\n     if pkgicu[0] is None:\n       error('''Could not load pkg-config data for \"icu-i18n\".\n        See above errors or the README.md.''')\n-    (libs, cflags, libpath) = pkgicu\n+    (libs, cflags, libpath, icuversion) = pkgicu\n+    icu_ver_major = icuversion.split('.')[0]\n+    o['variables']['icu_ver_major'] = icu_ver_major\n+    if int(icu_ver_major) < icu_versions['minimum_icu']:\n+      error('icu4c v%s is too old, v%d.x or later is required.' %\n+            (icuversion, icu_versions['minimum_icu']))\n     # libpath provides linker path which may contain spaces\n     if libpath:\n       o['libraries'] += [libpath]\n@@ -1473,9 +1482,9 @@ def write_config(data, name):\n       icu_ver_major = m.group(1)\n   if not icu_ver_major:\n     error('Could not read U_ICU_VERSION_SHORT version from %s' % uvernum_h)\n-  elif int(icu_ver_major) < icu_versions[\"minimum_icu\"]:\n-    error('icu4c v%d.x is too old, v%d.x or later is required.' % (int(icu_ver_major),\n-                                                                  icu_versions[\"minimum_icu\"]))\n+  elif int(icu_ver_major) < icu_versions['minimum_icu']:\n+    error('icu4c v%s.x is too old, v%d.x or later is required.' %\n+          (icu_ver_major, icu_versions['minimum_icu']))\n   icu_endianness = sys.byteorder[0];\n   o['variables']['icu_ver_major'] = icu_ver_major\n   o['variables']['icu_endianness'] = icu_endianness"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 17,
        "deletions": 8
    }
}