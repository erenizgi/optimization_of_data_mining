{
    "author": "addaleax",
    "message": "lib,src: use V8 API for collection inspection\n\nUse a new public V8 API for inspecting weak collections and\ncollection iterators, rather than using V8-internal functions\nto achieve this. This currently comes with a slight modification of\nthe output for inspecting iterators generated by `Set().entries()`.\n\nFixes: https://github.com/nodejs/node/issues/20409\n\nPR-URL: https://github.com/nodejs/node/pull/20719\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "70cc5da0f11a024cf5be1ff20fd885556c1d2153",
    "files": [
        {
            "sha": "e8b89536b92a2b9eb5ee0baa394b98440b7b8033",
            "filename": "lib/console.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/70cc5da0f11a024cf5be1ff20fd885556c1d2153/lib%2Fconsole.js",
            "raw_url": "https://github.com/nodejs/node/raw/70cc5da0f11a024cf5be1ff20fd885556c1d2153/lib%2Fconsole.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fconsole.js?ref=70cc5da0f11a024cf5be1ff20fd885556c1d2153",
            "patch": "@@ -29,7 +29,7 @@ const {\n     ERR_INVALID_ARG_VALUE,\n   },\n } = require('internal/errors');\n-const { previewMapIterator, previewSetIterator } = require('internal/v8');\n+const { previewEntries } = process.binding('util');\n const { Buffer: { isBuffer } } = require('buffer');\n const util = require('util');\n const {\n@@ -345,7 +345,7 @@ Console.prototype.table = function(tabularData, properties) {\n \n   const mapIter = isMapIterator(tabularData);\n   if (mapIter)\n-    tabularData = previewMapIterator(tabularData);\n+    tabularData = previewEntries(tabularData);\n \n   if (mapIter || isMap(tabularData)) {\n     const keys = [];\n@@ -367,7 +367,7 @@ Console.prototype.table = function(tabularData, properties) {\n \n   const setIter = isSetIterator(tabularData);\n   if (setIter)\n-    tabularData = previewSetIterator(tabularData);\n+    tabularData = previewEntries(tabularData);\n \n   const setlike = setIter || isSet(tabularData);\n   if (setlike) {"
        },
        {
            "sha": "a8485f5d1c2aadbd4d488f020cbdc02f60d1ca5d",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 0,
            "deletions": 17,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/70cc5da0f11a024cf5be1ff20fd885556c1d2153/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/70cc5da0f11a024cf5be1ff20fd885556c1d2153/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=70cc5da0f11a024cf5be1ff20fd885556c1d2153",
            "patch": "@@ -29,7 +29,6 @@\n     // Do this good and early, since it handles errors.\n     setupProcessFatal();\n \n-    setupV8();\n     setupProcessICUVersions();\n \n     setupGlobalVariables();\n@@ -479,22 +478,6 @@\n     };\n   }\n \n-  function setupV8() {\n-    // Warm up the map and set iterator preview functions.  V8 compiles\n-    // functions lazily (unless --nolazy is set) so we need to do this\n-    // before we turn off --allow_natives_syntax again.\n-    const v8 = NativeModule.require('internal/v8');\n-    v8.previewMapIterator(new Map().entries());\n-    v8.previewSetIterator(new Set().entries());\n-    v8.previewWeakMap(new WeakMap(), 1);\n-    v8.previewWeakSet(new WeakSet(), 1);\n-    // Disable --allow_natives_syntax again unless it was explicitly\n-    // specified on the command line.\n-    const re = /^--allow[-_]natives[-_]syntax$/;\n-    if (!process.execArgv.some((s) => re.test(s)))\n-      process.binding('v8').setFlagsFromString('--noallow_natives_syntax');\n-  }\n-\n   function setupProcessICUVersions() {\n     const icu = process.binding('config').hasIntl ?\n       process.binding('icu') : undefined;"
        },
        {
            "sha": "3102b45a2d403262e1cfe123f2d27c8f62f11ddc",
            "filename": "lib/internal/v8.js",
            "status": "removed",
            "additions": 0,
            "deletions": 39,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/143a2f8d67a81154bdb2849999837fb0a5c13d8e/lib%2Finternal%2Fv8.js",
            "raw_url": "https://github.com/nodejs/node/raw/143a2f8d67a81154bdb2849999837fb0a5c13d8e/lib%2Finternal%2Fv8.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fv8.js?ref=143a2f8d67a81154bdb2849999837fb0a5c13d8e",
            "patch": "@@ -1,39 +0,0 @@\n-'use strict';\n-\n-// This file provides access to some of V8's native runtime functions. See\n-// https://github.com/v8/v8/wiki/Built-in-functions for further information\n-// about their implementation.\n-// They have to be loaded before anything else to make sure we deactivate them\n-// before executing any other code. Gaining access is achieved by using a\n-// specific flag that is used internally in the startup phase.\n-\n-// Clone the provided Map Iterator.\n-function previewMapIterator(it) {\n-  return %MapIteratorClone(it);\n-}\n-\n-// Clone the provided Set Iterator.\n-function previewSetIterator(it) {\n-  return %SetIteratorClone(it);\n-}\n-\n-// Retrieve all WeakMap instance key / value pairs up to `max`. `max` limits the\n-// number of key / value pairs returned. Make sure it is a positive number,\n-// otherwise V8 aborts. Passing through `0` returns all elements.\n-function previewWeakMap(weakMap, max) {\n-  return %GetWeakMapEntries(weakMap, max);\n-}\n-\n-// Retrieve all WeakSet instance values up to `max`. `max` limits the\n-// number of key / value pairs returned. Make sure it is a positive number,\n-// otherwise V8 aborts. Passing through `0` returns all elements.\n-function previewWeakSet(weakSet, max) {\n-  return %GetWeakSetValues(weakSet, max);\n-}\n-\n-module.exports = {\n-  previewMapIterator,\n-  previewSetIterator,\n-  previewWeakMap,\n-  previewWeakSet\n-};"
        },
        {
            "sha": "f358adefdb25d614aee712b1c0061f06b3bd4c38",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 11,
            "deletions": 21,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/70cc5da0f11a024cf5be1ff20fd885556c1d2153/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/70cc5da0f11a024cf5be1ff20fd885556c1d2153/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=70cc5da0f11a024cf5be1ff20fd885556c1d2153",
            "patch": "@@ -30,18 +30,12 @@ const {\n const { TextDecoder, TextEncoder } = require('internal/encoding');\n const { isBuffer } = require('buffer').Buffer;\n \n-const {\n-  previewMapIterator,\n-  previewSetIterator,\n-  previewWeakMap,\n-  previewWeakSet\n-} = require('internal/v8');\n-\n const {\n   getPromiseDetails,\n   getProxyDetails,\n   kPending,\n   kRejected,\n+  previewEntries\n } = process.binding('util');\n \n const { internalBinding } = require('internal/bootstrap/loaders');\n@@ -912,7 +906,7 @@ function formatMap(ctx, value, recurseTimes, keys) {\n \n function formatWeakSet(ctx, value, recurseTimes, keys) {\n   const maxArrayLength = Math.max(ctx.maxArrayLength, 0);\n-  const entries = previewWeakSet(value, maxArrayLength + 1);\n+  const entries = previewEntries(value).slice(0, maxArrayLength + 1);\n   const maxLength = Math.min(maxArrayLength, entries.length);\n   let output = new Array(maxLength);\n   for (var i = 0; i < maxLength; ++i)\n@@ -929,16 +923,14 @@ function formatWeakSet(ctx, value, recurseTimes, keys) {\n \n function formatWeakMap(ctx, value, recurseTimes, keys) {\n   const maxArrayLength = Math.max(ctx.maxArrayLength, 0);\n-  const entries = previewWeakMap(value, maxArrayLength + 1);\n-  // Entries exist as [key1, val1, key2, val2, ...]\n-  const remainder = entries.length / 2 > maxArrayLength;\n-  const len = entries.length / 2 - (remainder ? 1 : 0);\n+  const entries = previewEntries(value).slice(0, maxArrayLength + 1);\n+  const remainder = entries.length > maxArrayLength;\n+  const len = entries.length - (remainder ? 1 : 0);\n   const maxLength = Math.min(maxArrayLength, len);\n   let output = new Array(maxLength);\n   for (var i = 0; i < len; i++) {\n-    const pos = i * 2;\n-    output[i] = `${formatValue(ctx, entries[pos], recurseTimes)} => ` +\n-      formatValue(ctx, entries[pos + 1], recurseTimes);\n+    output[i] = `${formatValue(ctx, entries[i][0], recurseTimes)} => ` +\n+      formatValue(ctx, entries[i][1], recurseTimes);\n   }\n   // Sort all entries to have a halfway reliable output (if more entries than\n   // retrieved ones exist, we can not reliably return the same output).\n@@ -950,9 +942,9 @@ function formatWeakMap(ctx, value, recurseTimes, keys) {\n   return output;\n }\n \n-function formatCollectionIterator(preview, ctx, value, recurseTimes, keys) {\n+function formatCollectionIterator(ctx, value, recurseTimes, keys) {\n   const output = [];\n-  for (const entry of preview(value)) {\n+  for (const entry of previewEntries(value)) {\n     if (ctx.maxArrayLength === output.length) {\n       output.push('... more items');\n       break;\n@@ -966,13 +958,11 @@ function formatCollectionIterator(preview, ctx, value, recurseTimes, keys) {\n }\n \n function formatMapIterator(ctx, value, recurseTimes, keys) {\n-  return formatCollectionIterator(previewMapIterator, ctx, value, recurseTimes,\n-                                  keys);\n+  return formatCollectionIterator(ctx, value, recurseTimes, keys);\n }\n \n function formatSetIterator(ctx, value, recurseTimes, keys) {\n-  return formatCollectionIterator(previewSetIterator, ctx, value, recurseTimes,\n-                                  keys);\n+  return formatCollectionIterator(ctx, value, recurseTimes, keys);\n }\n \n function formatPromise(ctx, value, recurseTimes, keys) {"
        },
        {
            "sha": "b4606ccc6f9caeb7ebc224b665b9bafe419ceff8",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/70cc5da0f11a024cf5be1ff20fd885556c1d2153/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/70cc5da0f11a024cf5be1ff20fd885556c1d2153/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=70cc5da0f11a024cf5be1ff20fd885556c1d2153",
            "patch": "@@ -146,7 +146,6 @@\n       'lib/internal/http2/core.js',\n       'lib/internal/http2/compat.js',\n       'lib/internal/http2/util.js',\n-      'lib/internal/v8.js',\n       'lib/internal/v8_prof_polyfill.js',\n       'lib/internal/v8_prof_processor.js',\n       'lib/internal/validators.js',"
        },
        {
            "sha": "960769663525a3fec92ea9d14d7a1c0c255a70bf",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/70cc5da0f11a024cf5be1ff20fd885556c1d2153/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/70cc5da0f11a024cf5be1ff20fd885556c1d2153/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=70cc5da0f11a024cf5be1ff20fd885556c1d2153",
            "patch": "@@ -4355,12 +4355,6 @@ void Init(int* argc,\n   }\n #endif\n \n-  // Needed for access to V8 intrinsics.  Disabled again during bootstrapping,\n-  // see lib/internal/bootstrap/node.js.\n-  const char allow_natives_syntax[] = \"--allow_natives_syntax\";\n-  V8::SetFlagsFromString(allow_natives_syntax,\n-                         sizeof(allow_natives_syntax) - 1);\n-\n   // We should set node_is_initialized here instead of in node::Start,\n   // otherwise embedders using node::Init to initialize everything will not be\n   // able to set it and native modules will not load for them."
        },
        {
            "sha": "2db68586459ab2eda509d225398f2ad923cd6599",
            "filename": "src/node_util.cc",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/70cc5da0f11a024cf5be1ff20fd885556c1d2153/src%2Fnode_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/70cc5da0f11a024cf5be1ff20fd885556c1d2153/src%2Fnode_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_util.cc?ref=70cc5da0f11a024cf5be1ff20fd885556c1d2153",
            "patch": "@@ -49,6 +49,35 @@ static void GetProxyDetails(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(ret);\n }\n \n+static void PreviewEntries(const FunctionCallbackInfo<Value>& args) {\n+  if (!args[0]->IsObject())\n+    return;\n+\n+  bool is_key_value;\n+  Local<Array> entries;\n+  if (!args[0].As<Object>()->PreviewEntries(&is_key_value).ToLocal(&entries))\n+    return;\n+  if (!is_key_value)\n+    return args.GetReturnValue().Set(entries);\n+\n+  uint32_t length = entries->Length();\n+  CHECK_EQ(length % 2, 0);\n+\n+  Environment* env = Environment::GetCurrent(args);\n+  Local<Context> context = env->context();\n+\n+  Local<Array> pairs = Array::New(env->isolate(), length / 2);\n+  for (uint32_t i = 0; i < length / 2; i++) {\n+    Local<Array> pair = Array::New(env->isolate(), 2);\n+    pair->Set(context, 0, entries->Get(context, i * 2).ToLocalChecked())\n+        .FromJust();\n+    pair->Set(context, 1, entries->Get(context, i * 2 + 1).ToLocalChecked())\n+        .FromJust();\n+    pairs->Set(context, i, pair).FromJust();\n+  }\n+  args.GetReturnValue().Set(pairs);\n+}\n+\n // Side effect-free stringification that will never throw exceptions.\n static void SafeToString(const FunctionCallbackInfo<Value>& args) {\n   auto context = args.GetIsolate()->GetCurrentContext();\n@@ -188,6 +217,7 @@ void Initialize(Local<Object> target,\n   env->SetMethod(target, \"getPromiseDetails\", GetPromiseDetails);\n   env->SetMethod(target, \"getProxyDetails\", GetProxyDetails);\n   env->SetMethod(target, \"safeToString\", SafeToString);\n+  env->SetMethod(target, \"previewEntries\", PreviewEntries);\n \n   env->SetMethod(target, \"startSigintWatchdog\", StartSigintWatchdog);\n   env->SetMethod(target, \"stopSigintWatchdog\", StopSigintWatchdog);"
        },
        {
            "sha": "b80e932dd1c17fabc415453acd58d901db46739f",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/70cc5da0f11a024cf5be1ff20fd885556c1d2153/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/70cc5da0f11a024cf5be1ff20fd885556c1d2153/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=70cc5da0f11a024cf5be1ff20fd885556c1d2153",
            "patch": "@@ -19,14 +19,13 @@\n // OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n // USE OR OTHER DEALINGS IN THE SOFTWARE.\n \n-// Flags: --expose_internals\n 'use strict';\n const common = require('../common');\n const assert = require('assert');\n const JSStream = process.binding('js_stream').JSStream;\n const util = require('util');\n const vm = require('vm');\n-const { previewMapIterator } = require('internal/v8');\n+const { previewEntries } = process.binding('util');\n \n assert.strictEqual(util.inspect(1), '1');\n assert.strictEqual(util.inspect(false), 'false');\n@@ -448,7 +447,7 @@ assert.strictEqual(util.inspect(-5e-324), '-5e-324');\n {\n   const map = new Map();\n   map.set(1, 2);\n-  const vals = previewMapIterator(map.entries());\n+  const vals = previewEntries(map.entries());\n   const valsOutput = [];\n   for (const o of vals) {\n     valsOutput.push(o);\n@@ -935,8 +934,7 @@ if (typeof Symbol !== 'undefined') {\n   const aSet = new Set([1, 3]);\n   assert.strictEqual(util.inspect(aSet.keys()), '[Set Iterator] { 1, 3 }');\n   assert.strictEqual(util.inspect(aSet.values()), '[Set Iterator] { 1, 3 }');\n-  assert.strictEqual(util.inspect(aSet.entries()),\n-                     '[Set Iterator] { [ 1, 1 ], [ 3, 3 ] }');\n+  assert.strictEqual(util.inspect(aSet.entries()), '[Set Iterator] { 1, 3 }');\n   // Make sure the iterator doesn't get consumed.\n   const keys = aSet.keys();\n   assert.strictEqual(util.inspect(keys), '[Set Iterator] { 1, 3 }');"
        }
    ],
    "stats": {
        "total": 139,
        "additions": 47,
        "deletions": 92
    }
}