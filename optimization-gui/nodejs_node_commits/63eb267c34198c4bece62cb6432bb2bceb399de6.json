{
    "author": "joyeecheung",
    "message": "src: migrate string_bytes.cc to throw errors with code\n\nPR-URL: https://github.com/nodejs/node/pull/19739\nFixes: https://github.com/nodejs/node/issues/3175\nFixes: https://github.com/nodejs/node/issues/9489\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "63eb267c34198c4bece62cb6432bb2bceb399de6",
    "files": [
        {
            "sha": "bbd381d33a5cf7a375522a01dccbd2ca673bf434",
            "filename": "src/string_bytes.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 25,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/63eb267c34198c4bece62cb6432bb2bceb399de6/src%2Fstring_bytes.cc",
            "raw_url": "https://github.com/nodejs/node/raw/63eb267c34198c4bece62cb6432bb2bceb399de6/src%2Fstring_bytes.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstring_bytes.cc?ref=63eb267c34198c4bece62cb6432bb2bceb399de6",
            "patch": "@@ -23,6 +23,7 @@\n \n #include \"base64.h\"\n #include \"node_internals.h\"\n+#include \"node_errors.h\"\n #include \"node_buffer.h\"\n \n #include <limits.h>\n@@ -36,20 +37,6 @@\n // use external string resources.\n #define EXTERN_APEX 0xFBEE9\n \n-// TODO(addaleax): These should all have better error messages. In particular,\n-// they should mention what the actual limits are.\n-#define SB_MALLOC_FAILED_ERROR \\\n-  v8::Exception::Error(OneByteString(isolate, \"\\\"toString()\\\" failed\"))\n-\n-#define SB_STRING_TOO_LONG_ERROR \\\n-  v8::Exception::Error(OneByteString(isolate, \"\\\"toString()\\\" failed\"))\n-\n-#define SB_BUFFER_CREATION_ERROR \\\n-  v8::Exception::Error(OneByteString(isolate, \"\\\"toString()\\\" failed\"))\n-\n-#define SB_BUFFER_SIZE_EXCEEDED_ERROR \\\n-  v8::Exception::Error(OneByteString(isolate, \"\\\"toString()\\\" failed\"))\n-\n namespace node {\n \n using v8::HandleScope;\n@@ -93,7 +80,7 @@ class ExternString: public ResourceType {\n \n     TypeName* new_data = node::UncheckedMalloc<TypeName>(length);\n     if (new_data == nullptr) {\n-      *error = SB_MALLOC_FAILED_ERROR;\n+      *error = node::ERR_MEMORY_ALLOCATION_FAILED(isolate);\n       return MaybeLocal<Value>();\n     }\n     memcpy(new_data, data, length * sizeof(*new_data));\n@@ -126,7 +113,7 @@ class ExternString: public ResourceType {\n \n     if (str.IsEmpty()) {\n       delete h_str;\n-      *error = SB_STRING_TOO_LONG_ERROR;\n+      *error = node::ERR_STRING_TOO_LARGE(isolate);\n       return MaybeLocal<Value>();\n     }\n \n@@ -183,7 +170,7 @@ MaybeLocal<Value> ExternOneByteString::NewSimpleFromCopy(Isolate* isolate,\n                              v8::NewStringType::kNormal,\n                              length);\n   if (str.IsEmpty()) {\n-    *error = SB_STRING_TOO_LONG_ERROR;\n+    *error = node::ERR_STRING_TOO_LARGE(isolate);\n     return MaybeLocal<Value>();\n   }\n   return str.ToLocalChecked();\n@@ -201,7 +188,7 @@ MaybeLocal<Value> ExternTwoByteString::NewSimpleFromCopy(Isolate* isolate,\n                              v8::NewStringType::kNormal,\n                              length);\n   if (str.IsEmpty()) {\n-    *error = SB_STRING_TOO_LONG_ERROR;\n+    *error = node::ERR_STRING_TOO_LARGE(isolate);\n     return MaybeLocal<Value>();\n   }\n   return str.ToLocalChecked();\n@@ -616,7 +603,7 @@ static size_t hex_encode(const char* src, size_t slen, char* dst, size_t dlen) {\n #define CHECK_BUFLEN_IN_RANGE(len)                                    \\\n   do {                                                                \\\n     if ((len) > Buffer::kMaxLength) {                                 \\\n-      *error = SB_BUFFER_SIZE_EXCEEDED_ERROR;                         \\\n+      *error = node::ERR_BUFFER_TOO_LARGE(isolate);                   \\\n       return MaybeLocal<Value>();                                     \\\n     }                                                                 \\\n   } while (0)\n@@ -639,9 +626,13 @@ MaybeLocal<Value> StringBytes::Encode(Isolate* isolate,\n   switch (encoding) {\n     case BUFFER:\n       {\n+        if (buflen > node::Buffer::kMaxLength) {\n+          *error = node::ERR_BUFFER_TOO_LARGE(isolate);\n+          return MaybeLocal<Value>();\n+        }\n         auto maybe_buf = Buffer::Copy(isolate, buf, buflen);\n         if (maybe_buf.IsEmpty()) {\n-          *error = SB_BUFFER_CREATION_ERROR;\n+          *error = node::ERR_MEMORY_ALLOCATION_FAILED(isolate);\n           return MaybeLocal<Value>();\n         }\n         return maybe_buf.ToLocalChecked();\n@@ -651,7 +642,7 @@ MaybeLocal<Value> StringBytes::Encode(Isolate* isolate,\n       if (contains_non_ascii(buf, buflen)) {\n         char* out = node::UncheckedMalloc(buflen);\n         if (out == nullptr) {\n-          *error = SB_MALLOC_FAILED_ERROR;\n+          *error = node::ERR_MEMORY_ALLOCATION_FAILED(isolate);\n           return MaybeLocal<Value>();\n         }\n         force_ascii(buf, out, buflen);\n@@ -666,7 +657,7 @@ MaybeLocal<Value> StringBytes::Encode(Isolate* isolate,\n                                 v8::NewStringType::kNormal,\n                                 buflen);\n       if (val.IsEmpty()) {\n-        *error = SB_STRING_TOO_LONG_ERROR;\n+        *error = node::ERR_STRING_TOO_LARGE(isolate);\n         return MaybeLocal<Value>();\n       }\n       return val.ToLocalChecked();\n@@ -678,7 +669,7 @@ MaybeLocal<Value> StringBytes::Encode(Isolate* isolate,\n       size_t dlen = base64_encoded_size(buflen);\n       char* dst = node::UncheckedMalloc(dlen);\n       if (dst == nullptr) {\n-        *error = SB_MALLOC_FAILED_ERROR;\n+        *error = node::ERR_MEMORY_ALLOCATION_FAILED(isolate);\n         return MaybeLocal<Value>();\n       }\n \n@@ -692,7 +683,7 @@ MaybeLocal<Value> StringBytes::Encode(Isolate* isolate,\n       size_t dlen = buflen * 2;\n       char* dst = node::UncheckedMalloc(dlen);\n       if (dst == nullptr) {\n-        *error = SB_MALLOC_FAILED_ERROR;\n+        *error = node::ERR_MEMORY_ALLOCATION_FAILED(isolate);\n         return MaybeLocal<Value>();\n       }\n       size_t written = hex_encode(buf, buflen, dst, dlen);\n@@ -723,7 +714,7 @@ MaybeLocal<Value> StringBytes::Encode(Isolate* isolate,\n   if (IsBigEndian()) {\n     uint16_t* dst = node::UncheckedMalloc<uint16_t>(buflen);\n     if (dst == nullptr) {\n-      *error = SB_MALLOC_FAILED_ERROR;\n+      *error = node::ERR_MEMORY_ALLOCATION_FAILED(isolate);\n       return MaybeLocal<Value>();\n     }\n     size_t nbytes = buflen * sizeof(uint16_t);"
        },
        {
            "sha": "96a3273254d8d79d2b2ff684b657708dd302eadd",
            "filename": "test/addons/stringbytes-external-exceed-max/test-stringbytes-external-exceed-max-by-1-ascii.js",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-ascii.js",
            "raw_url": "https://github.com/nodejs/node/raw/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-ascii.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-ascii.js?ref=63eb267c34198c4bece62cb6432bb2bceb399de6",
            "patch": "@@ -6,7 +6,6 @@ if (!common.enoughTestMem)\n   common.skip(skipMessage);\n \n const binding = require(`./build/${common.buildType}/binding`);\n-const assert = require('assert');\n \n // v8 fails silently if string length > v8::String::kMaxLength\n // v8::String::kMaxLength defined in v8.h\n@@ -25,6 +24,11 @@ try {\n if (!binding.ensureAllocation(2 * kStringMaxLength))\n   common.skip(skipMessage);\n \n-assert.throws(function() {\n+const stringLengthHex = kStringMaxLength.toString(16);\n+common.expectsError(function() {\n   buf.toString('ascii');\n-}, /\"toString\\(\\)\" failed/);\n+}, {\n+  message: `Cannot create a string larger than 0x${stringLengthHex} bytes`,\n+  code: 'ERR_STRING_TOO_LARGE',\n+  type: Error\n+});"
        },
        {
            "sha": "90e13ce788efcc1901a5f437566e1d846c0bf2a6",
            "filename": "test/addons/stringbytes-external-exceed-max/test-stringbytes-external-exceed-max-by-1-base64.js",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-base64.js",
            "raw_url": "https://github.com/nodejs/node/raw/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-base64.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-base64.js?ref=63eb267c34198c4bece62cb6432bb2bceb399de6",
            "patch": "@@ -6,7 +6,6 @@ if (!common.enoughTestMem)\n   common.skip(skipMessage);\n \n const binding = require(`./build/${common.buildType}/binding`);\n-const assert = require('assert');\n \n // v8 fails silently if string length > v8::String::kMaxLength\n // v8::String::kMaxLength defined in v8.h\n@@ -25,6 +24,11 @@ try {\n if (!binding.ensureAllocation(2 * kStringMaxLength))\n   common.skip(skipMessage);\n \n-assert.throws(function() {\n+const stringLengthHex = kStringMaxLength.toString(16);\n+common.expectsError(function() {\n   buf.toString('base64');\n-}, /\"toString\\(\\)\" failed/);\n+}, {\n+  message: `Cannot create a string larger than 0x${stringLengthHex} bytes`,\n+  code: 'ERR_STRING_TOO_LARGE',\n+  type: Error\n+});"
        },
        {
            "sha": "0ffd1eb416698907fc95ea2ac59e212226b49c2b",
            "filename": "test/addons/stringbytes-external-exceed-max/test-stringbytes-external-exceed-max-by-1-binary.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-binary.js",
            "raw_url": "https://github.com/nodejs/node/raw/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-binary.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-binary.js?ref=63eb267c34198c4bece62cb6432bb2bceb399de6",
            "patch": "@@ -25,9 +25,14 @@ try {\n if (!binding.ensureAllocation(2 * kStringMaxLength))\n   common.skip(skipMessage);\n \n-assert.throws(function() {\n+const stringLengthHex = kStringMaxLength.toString(16);\n+common.expectsError(function() {\n   buf.toString('latin1');\n-}, /\"toString\\(\\)\" failed/);\n+}, {\n+  message: `Cannot create a string larger than 0x${stringLengthHex} bytes`,\n+  code: 'ERR_STRING_TOO_LARGE',\n+  type: Error\n+});\n \n let maxString = buf.toString('latin1', 1);\n assert.strictEqual(maxString.length, kStringMaxLength);"
        },
        {
            "sha": "bc64ef396dc2d34f917cd7fcff5c30b75f7258f0",
            "filename": "test/addons/stringbytes-external-exceed-max/test-stringbytes-external-exceed-max-by-1-hex.js",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-hex.js",
            "raw_url": "https://github.com/nodejs/node/raw/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-hex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-hex.js?ref=63eb267c34198c4bece62cb6432bb2bceb399de6",
            "patch": "@@ -6,7 +6,6 @@ if (!common.enoughTestMem)\n   common.skip(skipMessage);\n \n const binding = require(`./build/${common.buildType}/binding`);\n-const assert = require('assert');\n \n // v8 fails silently if string length > v8::String::kMaxLength\n // v8::String::kMaxLength defined in v8.h\n@@ -25,6 +24,11 @@ try {\n if (!binding.ensureAllocation(2 * kStringMaxLength))\n   common.skip(skipMessage);\n \n-assert.throws(function() {\n+const stringLengthHex = kStringMaxLength.toString(16);\n+common.expectsError(function() {\n   buf.toString('hex');\n-}, /\"toString\\(\\)\" failed/);\n+}, {\n+  message: `Cannot create a string larger than 0x${stringLengthHex} bytes`,\n+  code: 'ERR_STRING_TOO_LARGE',\n+  type: Error\n+});"
        },
        {
            "sha": "f6c9f21e4b06e25ad447fda9a3d6b058761966af",
            "filename": "test/addons/stringbytes-external-exceed-max/test-stringbytes-external-exceed-max-by-1-utf8.js",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-utf8.js",
            "raw_url": "https://github.com/nodejs/node/raw/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-utf8.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max-by-1-utf8.js?ref=63eb267c34198c4bece62cb6432bb2bceb399de6",
            "patch": "@@ -25,10 +25,27 @@ try {\n if (!binding.ensureAllocation(2 * kStringMaxLength))\n   common.skip(skipMessage);\n \n+const stringLengthHex = kStringMaxLength.toString(16);\n+\n assert.throws(function() {\n   buf.toString();\n-}, /\"toString\\(\\)\" failed|Array buffer allocation failed/);\n+}, function(e) {\n+  if (e.message !== 'Array buffer allocation failed') {\n+    common.expectsError({\n+      message: `Cannot create a string larger than 0x${stringLengthHex} bytes`,\n+      code: 'ERR_STRING_TOO_LARGE',\n+      type: Error\n+    })(e);\n+    return true;\n+  } else {\n+    return true;\n+  }\n+});\n \n-assert.throws(function() {\n+common.expectsError(function() {\n   buf.toString('utf8');\n-}, /\"toString\\(\\)\" failed/);\n+}, {\n+  message: `Cannot create a string larger than 0x${stringLengthHex} bytes`,\n+  code: 'ERR_STRING_TOO_LARGE',\n+  type: Error\n+});"
        },
        {
            "sha": "e4b66d8f30bae39684de72cb2b46ec6bdcc21403",
            "filename": "test/addons/stringbytes-external-exceed-max/test-stringbytes-external-exceed-max.js",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max.js",
            "raw_url": "https://github.com/nodejs/node/raw/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fstringbytes-external-exceed-max%2Ftest-stringbytes-external-exceed-max.js?ref=63eb267c34198c4bece62cb6432bb2bceb399de6",
            "patch": "@@ -6,7 +6,6 @@ if (!common.enoughTestMem)\n   common.skip(skipMessage);\n \n const binding = require(`./build/${common.buildType}/binding`);\n-const assert = require('assert');\n \n // v8 fails silently if string length > v8::String::kMaxLength\n // v8::String::kMaxLength defined in v8.h\n@@ -25,6 +24,12 @@ try {\n if (!binding.ensureAllocation(2 * kStringMaxLength))\n   common.skip(skipMessage);\n \n-assert.throws(function() {\n+const stringLengthHex = kStringMaxLength.toString(16);\n+\n+common.expectsError(function() {\n   buf.toString('utf16le');\n-}, /\"toString\\(\\)\" failed/);\n+}, {\n+  message: `Cannot create a string larger than 0x${stringLengthHex} bytes`,\n+  code: 'ERR_STRING_TOO_LARGE',\n+  type: Error\n+});"
        },
        {
            "sha": "f8b0c666a01b23f2e00f05f7a0f7ed8d4598118f",
            "filename": "test/sequential/test-fs-readfile-tostring-fail.js",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Fsequential%2Ftest-fs-readfile-tostring-fail.js",
            "raw_url": "https://github.com/nodejs/node/raw/63eb267c34198c4bece62cb6432bb2bceb399de6/test%2Fsequential%2Ftest-fs-readfile-tostring-fail.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-fs-readfile-tostring-fail.js?ref=63eb267c34198c4bece62cb6432bb2bceb399de6",
            "patch": "@@ -32,8 +32,15 @@ stream.end();\n stream.on('finish', common.mustCall(function() {\n   fs.readFile(file, 'utf8', common.mustCall(function(err, buf) {\n     assert.ok(err instanceof Error);\n-    assert.ok(/^(Array buffer allocation failed|\"toString\\(\\)\" failed)$/\n-              .test(err.message));\n+    if (err.message !== 'Array buffer allocation failed') {\n+      const stringLengthHex = kStringMaxLength.toString(16);\n+      common.expectsError({\n+        message: 'Cannot create a string larger than ' +\n+                 `0x${stringLengthHex} bytes`,\n+        code: 'ERR_STRING_TOO_LARGE',\n+        type: Error\n+      })(err);\n+    }\n     assert.strictEqual(buf, undefined);\n   }));\n }));"
        }
    ],
    "stats": {
        "total": 125,
        "additions": 81,
        "deletions": 44
    }
}