{
    "author": "joyeecheung",
    "message": "src: create env->inspector_console_api_object earlier\n\nPreviously we create env->inspector_console_api_object() when\n`process.binding('inspector')` is called, which may be too late\nif the inspector console is used before the first call to\n`process.binding('inspector')` - that is possible when\nusing `--inspect-brk-node`. Setting a breakpoint and using the\ninspector console before that would crash the process.\n\nThis patch moves the initialization of the console API object to\nthe point when Environment is initialized so that\n`installAdditionalCommandLineAPI()` can be essentially a noop\nif we use the inspector console before the inspector binding\nis initialized instead of crashing on an empty object.\n\nPR-URL: https://github.com/nodejs/node/pull/24906\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>",
    "sha": "a1b283c2cacccb2e6d6f3a2382d986cd4ead11b4",
    "files": [
        {
            "sha": "023e69665d94ed020b1b734c78150e7d25bd30b6",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/a1b283c2cacccb2e6d6f3a2382d986cd4ead11b4/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a1b283c2cacccb2e6d6f3a2382d986cd4ead11b4/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=a1b283c2cacccb2e6d6f3a2382d986cd4ead11b4",
            "patch": "@@ -341,6 +341,13 @@ void Environment::Start(const std::vector<std::string>& args,\n   static uv_once_t init_once = UV_ONCE_INIT;\n   uv_once(&init_once, InitThreadLocalOnce);\n   uv_key_set(&thread_local_env, this);\n+\n+#if HAVE_INSPECTOR\n+  // This needs to be set before we start the inspector\n+  Local<Object> obj = Object::New(isolate());\n+  CHECK(obj->SetPrototype(context(), Null(isolate())).FromJust());\n+  set_inspector_console_api_object(obj);\n+#endif  // HAVE_INSPECTOR\n }\n \n void Environment::RegisterHandleCleanups() {"
        },
        {
            "sha": "8710b8569072a100fd4989464aa2492941c08470",
            "filename": "src/inspector_agent.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/a1b283c2cacccb2e6d6f3a2382d986cd4ead11b4/src%2Finspector_agent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a1b283c2cacccb2e6d6f3a2382d986cd4ead11b4/src%2Finspector_agent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_agent.cc?ref=a1b283c2cacccb2e6d6f3a2382d986cd4ead11b4",
            "patch": "@@ -506,6 +506,7 @@ class NodeInspectorClient : public V8InspectorClient {\n   void installAdditionalCommandLineAPI(Local<Context> context,\n                                        Local<Object> target) override {\n     Local<Object> console_api = env_->inspector_console_api_object();\n+    CHECK(!console_api.IsEmpty());\n \n     Local<Array> properties =\n         console_api->GetOwnPropertyNames(context).ToLocalChecked();"
        },
        {
            "sha": "f12cc3fb5adb6ae2a8614aac4fe76b665d8bd817",
            "filename": "src/inspector_js_api.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/a1b283c2cacccb2e6d6f3a2382d986cd4ead11b4/src%2Finspector_js_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a1b283c2cacccb2e6d6f3a2382d986cd4ead11b4/src%2Finspector_js_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_js_api.cc?ref=a1b283c2cacccb2e6d6f3a2382d986cd4ead11b4",
            "patch": "@@ -277,12 +277,6 @@ void Url(const FunctionCallbackInfo<Value>& args) {\n void Initialize(Local<Object> target, Local<Value> unused,\n                 Local<Context> context, void* priv) {\n   Environment* env = Environment::GetCurrent(context);\n-  {\n-    auto obj = Object::New(env->isolate());\n-    auto null = Null(env->isolate());\n-    CHECK(obj->SetPrototype(context, null).FromJust());\n-    env->set_inspector_console_api_object(obj);\n-  }\n \n   Agent* agent = env->inspector_agent();\n   env->SetMethod(target, \"consoleCall\", InspectorConsoleCall);"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 8,
        "deletions": 6
    }
}