{
    "author": "bnoordhuis",
    "message": "lib: replace checkUint() with validateInt32()\n\nPR-URL: https://github.com/nodejs/node/pull/20816\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "d669251f67b0d6e70853b18f7d9358fc98cb5ceb",
    "files": [
        {
            "sha": "7dd51e8f72881a4f969bedf054e76265cbe127f2",
            "filename": "lib/internal/crypto/pbkdf2.js",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/d669251f67b0d6e70853b18f7d9358fc98cb5ceb/lib%2Finternal%2Fcrypto%2Fpbkdf2.js",
            "raw_url": "https://github.com/nodejs/node/raw/d669251f67b0d6e70853b18f7d9358fc98cb5ceb/lib%2Finternal%2Fcrypto%2Fpbkdf2.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Fpbkdf2.js?ref=d669251f67b0d6e70853b18f7d9358fc98cb5ceb",
            "patch": "@@ -2,7 +2,8 @@\n \n const { AsyncWrap, Providers } = process.binding('async_wrap');\n const { Buffer } = require('buffer');\n-const { pbkdf2: _pbkdf2 } = process.binding('crypto');\n+const { INT_MAX, pbkdf2: _pbkdf2 } = process.binding('crypto');\n+const { validateInt32 } = require('internal/validators');\n const {\n   ERR_CRYPTO_INVALID_DIGEST,\n   ERR_CRYPTO_PBKDF2_ERROR,\n@@ -11,7 +12,6 @@ const {\n } = require('internal/errors').codes;\n const {\n   checkIsArrayBufferView,\n-  checkIsUint,\n   getDefaultEncoding,\n } = require('internal/crypto/util');\n \n@@ -59,10 +59,8 @@ function check(password, salt, iterations, keylen, digest, callback) {\n \n   password = checkIsArrayBufferView('password', password);\n   salt = checkIsArrayBufferView('salt', salt);\n-  // FIXME(bnoordhuis) The error message is in fact wrong since |iterations|\n-  // cannot be > INT_MAX.  Adjust in the next major release.\n-  iterations = checkIsUint('iterations', iterations, 'a non-negative number');\n-  keylen = checkIsUint('keylen', keylen);\n+  iterations = validateInt32(iterations, 'iterations', 0, INT_MAX);\n+  keylen = validateInt32(keylen, 'keylen', 0, INT_MAX);\n \n   return { password, salt, iterations, keylen, digest };\n }"
        },
        {
            "sha": "a512af0f810bc308edaa5ca0d73e0b0033d74529",
            "filename": "lib/internal/crypto/scrypt.js",
            "status": "modified",
            "additions": 11,
            "deletions": 8,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/d669251f67b0d6e70853b18f7d9358fc98cb5ceb/lib%2Finternal%2Fcrypto%2Fscrypt.js",
            "raw_url": "https://github.com/nodejs/node/raw/d669251f67b0d6e70853b18f7d9358fc98cb5ceb/lib%2Finternal%2Fcrypto%2Fscrypt.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Fscrypt.js?ref=d669251f67b0d6e70853b18f7d9358fc98cb5ceb",
            "patch": "@@ -2,15 +2,15 @@\n \n const { AsyncWrap, Providers } = process.binding('async_wrap');\n const { Buffer } = require('buffer');\n-const { scrypt: _scrypt } = process.binding('crypto');\n+const { INT_MAX, scrypt: _scrypt } = process.binding('crypto');\n+const { validateInt32 } = require('internal/validators');\n const {\n   ERR_CRYPTO_SCRYPT_INVALID_PARAMETER,\n   ERR_CRYPTO_SCRYPT_NOT_SUPPORTED,\n   ERR_INVALID_CALLBACK,\n } = require('internal/errors').codes;\n const {\n   checkIsArrayBufferView,\n-  checkIsUint,\n   getDefaultEncoding,\n } = require('internal/crypto/util');\n \n@@ -75,16 +75,19 @@ function check(password, salt, keylen, options, callback) {\n     throw new ERR_CRYPTO_SCRYPT_NOT_SUPPORTED();\n \n   password = checkIsArrayBufferView('password', password);\n-  salt = checkIsArrayBufferView('salt', salt);\n-  keylen = checkIsUint('keylen', keylen);\n+  salt = checkIsArrayBufferView(salt, 'salt');\n+  keylen = validateInt32(keylen, 'keylen', 0, INT_MAX);\n \n   let { N, r, p, maxmem } = defaults;\n   if (options && options !== defaults) {\n-    if (options.hasOwnProperty('N')) N = checkIsUint('N', options.N);\n-    if (options.hasOwnProperty('r')) r = checkIsUint('r', options.r);\n-    if (options.hasOwnProperty('p')) p = checkIsUint('p', options.p);\n+    if (options.hasOwnProperty('N'))\n+      N = validateInt32(options.N, 'N', 0, INT_MAX);\n+    if (options.hasOwnProperty('r'))\n+      r = validateInt32(options.r, 'r', 0, INT_MAX);\n+    if (options.hasOwnProperty('p'))\n+      p = validateInt32(options.p, 'p', 0, INT_MAX);\n     if (options.hasOwnProperty('maxmem'))\n-      maxmem = checkIsUint('maxmem', options.maxmem);\n+      maxmem = validateInt32(options.maxmem, 'maxmem', 0, INT_MAX);\n     if (N === 0) N = defaults.N;\n     if (r === 0) r = defaults.r;\n     if (p === 0) p = defaults.p;"
        },
        {
            "sha": "e2cd810a011bfa1ddad203fccd8ac93e09561cd8",
            "filename": "lib/internal/crypto/util.js",
            "status": "modified",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/d669251f67b0d6e70853b18f7d9358fc98cb5ceb/lib%2Finternal%2Fcrypto%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/d669251f67b0d6e70853b18f7d9358fc98cb5ceb/lib%2Finternal%2Fcrypto%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Futil.js?ref=d669251f67b0d6e70853b18f7d9358fc98cb5ceb",
            "patch": "@@ -16,7 +16,6 @@ const {\n   ERR_CRYPTO_ENGINE_UNKNOWN,\n   ERR_CRYPTO_TIMING_SAFE_EQUAL_LENGTH,\n   ERR_INVALID_ARG_TYPE,\n-  ERR_OUT_OF_RANGE,\n } = require('internal/errors').codes;\n const { Buffer } = require('buffer');\n const {\n@@ -26,9 +25,6 @@ const {\n const {\n   isArrayBufferView\n } = require('internal/util/types');\n-const {\n-  INT_MAX\n-} = process.binding('constants').crypto;\n \n var defaultEncoding = 'buffer';\n \n@@ -99,19 +95,8 @@ function checkIsArrayBufferView(name, buffer) {\n   return buffer;\n }\n \n-function checkIsUint(name, value, errmsg = `>= 0 && <= ${INT_MAX}`) {\n-  if (typeof value !== 'number')\n-    throw new ERR_INVALID_ARG_TYPE(name, 'number', value);\n-\n-  if (value < 0 || !Number.isInteger(value) || value > INT_MAX)\n-    throw new ERR_OUT_OF_RANGE(name, errmsg, value);\n-\n-  return value;\n-}\n-\n module.exports = {\n   checkIsArrayBufferView,\n-  checkIsUint,\n   getCiphers,\n   getCurves,\n   getDefaultEncoding,"
        },
        {
            "sha": "ab8643b9af673cfec3571f97b383a0bfaf4f08c9",
            "filename": "lib/internal/validators.js",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/d669251f67b0d6e70853b18f7d9358fc98cb5ceb/lib%2Finternal%2Fvalidators.js",
            "raw_url": "https://github.com/nodejs/node/raw/d669251f67b0d6e70853b18f7d9358fc98cb5ceb/lib%2Finternal%2Fvalidators.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fvalidators.js?ref=d669251f67b0d6e70853b18f7d9358fc98cb5ceb",
            "patch": "@@ -71,6 +71,8 @@ function validateInteger(value, name) {\n     Error.captureStackTrace(err, validateInteger);\n     throw err;\n   }\n+\n+  return value;\n }\n \n function validateInt32(value, name, min = -2147483648, max = 2147483647) {\n@@ -91,6 +93,8 @@ function validateInt32(value, name, min = -2147483648, max = 2147483647) {\n     Error.captureStackTrace(err, validateInt32);\n     throw err;\n   }\n+\n+  return value;\n }\n \n function validateUint32(value, name, positive) {\n@@ -112,6 +116,8 @@ function validateUint32(value, name, positive) {\n     Error.captureStackTrace(err, validateUint32);\n     throw err;\n   }\n+\n+  return value;\n }\n \n module.exports = {"
        },
        {
            "sha": "e1fa1e3d86f5fb90f0f7bd86cc6053f13ba2568c",
            "filename": "test/parallel/test-crypto-pbkdf2.js",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/d669251f67b0d6e70853b18f7d9358fc98cb5ceb/test%2Fparallel%2Ftest-crypto-pbkdf2.js",
            "raw_url": "https://github.com/nodejs/node/raw/d669251f67b0d6e70853b18f7d9358fc98cb5ceb/test%2Fparallel%2Ftest-crypto-pbkdf2.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-crypto-pbkdf2.js?ref=d669251f67b0d6e70853b18f7d9358fc98cb5ceb",
            "patch": "@@ -71,7 +71,7 @@ assert.throws(\n     code: 'ERR_OUT_OF_RANGE',\n     name: 'RangeError [ERR_OUT_OF_RANGE]',\n     message: 'The value of \"iterations\" is out of range. ' +\n-             'It must be a non-negative number. Received -1'\n+             'It must be >= 0 && <= 2147483647. Received -1'\n   }\n );\n \n@@ -87,7 +87,20 @@ assert.throws(\n     });\n });\n \n-[Infinity, -Infinity, NaN, -1, 4073741824, INT_MAX + 1].forEach((input) => {\n+[Infinity, -Infinity, NaN].forEach((input) => {\n+  assert.throws(\n+    () => {\n+      crypto.pbkdf2('password', 'salt', 1, input, 'sha256',\n+                    common.mustNotCall());\n+    }, {\n+      code: 'ERR_OUT_OF_RANGE',\n+      name: 'RangeError [ERR_OUT_OF_RANGE]',\n+      message: 'The value of \"keylen\" is out of range. It ' +\n+               `must be an integer. Received ${input}`\n+    });\n+});\n+\n+[-1, 4073741824, INT_MAX + 1].forEach((input) => {\n   assert.throws(\n     () => {\n       crypto.pbkdf2('password', 'salt', 1, input, 'sha256',"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 36,
        "deletions": 31
    }
}