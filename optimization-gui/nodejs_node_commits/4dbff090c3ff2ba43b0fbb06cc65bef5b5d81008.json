{
    "author": "addaleax",
    "message": "src: pass along errors from stream obj instantiation\n\nPR-URL: https://github.com/nodejs/node/pull/25734\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008",
    "files": [
        {
            "sha": "b894382c0370d5da5c309246086d43326ade1e07",
            "filename": "src/connection_wrap.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fconnection_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fconnection_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fconnection_wrap.cc?ref=4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008",
            "patch": "@@ -48,9 +48,10 @@ void ConnectionWrap<WrapType, UVType>::OnConnection(uv_stream_t* handle,\n \n   if (status == 0) {\n     // Instantiate the client javascript object and handle.\n-    Local<Object> client_obj = WrapType::Instantiate(env,\n-                                                     wrap_data,\n-                                                     WrapType::SOCKET);\n+    Local<Object> client_obj;\n+    if (!WrapType::Instantiate(env, wrap_data, WrapType::SOCKET)\n+             .ToLocal(&client_obj))\n+      return;\n \n     // Unwrap the client javascript object.\n     WrapType* wrap;"
        },
        {
            "sha": "06bb3dd73d1b3ccf8f4de5baf048c021b54b51f5",
            "filename": "src/pipe_wrap.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fpipe_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fpipe_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fpipe_wrap.cc?ref=4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008",
            "patch": "@@ -42,16 +42,16 @@ using v8::FunctionTemplate;\n using v8::HandleScope;\n using v8::Int32;\n using v8::Local;\n+using v8::MaybeLocal;\n using v8::Object;\n using v8::String;\n using v8::Value;\n \n using AsyncHooks = Environment::AsyncHooks;\n \n-\n-Local<Object> PipeWrap::Instantiate(Environment* env,\n-                                    AsyncWrap* parent,\n-                                    PipeWrap::SocketType type) {\n+MaybeLocal<Object> PipeWrap::Instantiate(Environment* env,\n+                                         AsyncWrap* parent,\n+                                         PipeWrap::SocketType type) {\n   EscapableHandleScope handle_scope(env->isolate());\n   AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(parent);\n   CHECK_EQ(false, env->pipe_constructor_template().IsEmpty());\n@@ -60,9 +60,8 @@ Local<Object> PipeWrap::Instantiate(Environment* env,\n                                     .ToLocalChecked();\n   CHECK_EQ(false, constructor.IsEmpty());\n   Local<Value> type_value = Int32::New(env->isolate(), type);\n-  Local<Object> instance =\n-      constructor->NewInstance(env->context(), 1, &type_value).ToLocalChecked();\n-  return handle_scope.Escape(instance);\n+  return handle_scope.EscapeMaybe(\n+      constructor->NewInstance(env->context(), 1, &type_value));\n }\n \n "
        },
        {
            "sha": "473179a4f6fba04c7393b76ced1db51ab7fc2a55",
            "filename": "src/pipe_wrap.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fpipe_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fpipe_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fpipe_wrap.h?ref=4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008",
            "patch": "@@ -38,9 +38,9 @@ class PipeWrap : public ConnectionWrap<PipeWrap, uv_pipe_t> {\n     IPC\n   };\n \n-  static v8::Local<v8::Object> Instantiate(Environment* env,\n-                                           AsyncWrap* parent,\n-                                           SocketType type);\n+  static v8::MaybeLocal<v8::Object> Instantiate(Environment* env,\n+                                                AsyncWrap* parent,\n+                                                SocketType type);\n   static void Initialize(v8::Local<v8::Object> target,\n                          v8::Local<v8::Value> unused,\n                          v8::Local<v8::Context> context,"
        },
        {
            "sha": "e957cb172533c3ce85c0eea00fc14e783e21d1d6",
            "filename": "src/stream_wrap.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fstream_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fstream_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_wrap.cc?ref=4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008",
            "patch": "@@ -44,6 +44,7 @@ using v8::FunctionCallbackInfo;\n using v8::FunctionTemplate;\n using v8::HandleScope;\n using v8::Local;\n+using v8::MaybeLocal;\n using v8::Object;\n using v8::ReadOnly;\n using v8::Signature;\n@@ -195,19 +196,17 @@ void LibuvStreamWrap::OnUvAlloc(size_t suggested_size, uv_buf_t* buf) {\n   *buf = EmitAlloc(suggested_size);\n }\n \n-\n-\n template <class WrapType>\n-static Local<Object> AcceptHandle(Environment* env, LibuvStreamWrap* parent) {\n+static MaybeLocal<Object> AcceptHandle(Environment* env,\n+                                       LibuvStreamWrap* parent) {\n   static_assert(std::is_base_of<LibuvStreamWrap, WrapType>::value ||\n                 std::is_base_of<UDPWrap, WrapType>::value,\n                 \"Can only accept stream handles\");\n \n   EscapableHandleScope scope(env->isolate());\n   Local<Object> wrap_obj;\n \n-  wrap_obj = WrapType::Instantiate(env, parent, WrapType::SOCKET);\n-  if (wrap_obj.IsEmpty())\n+  if (!WrapType::Instantiate(env, parent, WrapType::SOCKET).ToLocal(&wrap_obj))\n     return Local<Object>();\n \n   HandleWrap* wrap = Unwrap<HandleWrap>(wrap_obj);\n@@ -237,7 +236,7 @@ void LibuvStreamWrap::OnUvRead(ssize_t nread, const uv_buf_t* buf) {\n   CHECK_EQ(persistent().IsEmpty(), false);\n \n   if (nread > 0) {\n-    Local<Object> pending_obj;\n+    MaybeLocal<Object> pending_obj;\n \n     if (type == UV_TCP) {\n       pending_obj = AcceptHandle<TCPWrap>(env(), this);\n@@ -250,9 +249,11 @@ void LibuvStreamWrap::OnUvRead(ssize_t nread, const uv_buf_t* buf) {\n     }\n \n     if (!pending_obj.IsEmpty()) {\n-      object()->Set(env()->context(),\n-                    env()->pending_handle_string(),\n-                    pending_obj).FromJust();\n+      object()\n+          ->Set(env()->context(),\n+                env()->pending_handle_string(),\n+                pending_obj.ToLocalChecked())\n+          .FromJust();\n     }\n   }\n "
        },
        {
            "sha": "cb6e634006709d9824cfee9ad32a720481a113af",
            "filename": "src/tcp_wrap.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Ftcp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Ftcp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.cc?ref=4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008",
            "patch": "@@ -46,17 +46,17 @@ using v8::HandleScope;\n using v8::Int32;\n using v8::Integer;\n using v8::Local;\n+using v8::MaybeLocal;\n using v8::Object;\n using v8::String;\n using v8::Uint32;\n using v8::Value;\n \n using AsyncHooks = Environment::AsyncHooks;\n \n-\n-Local<Object> TCPWrap::Instantiate(Environment* env,\n-                                   AsyncWrap* parent,\n-                                   TCPWrap::SocketType type) {\n+MaybeLocal<Object> TCPWrap::Instantiate(Environment* env,\n+                                        AsyncWrap* parent,\n+                                        TCPWrap::SocketType type) {\n   EscapableHandleScope handle_scope(env->isolate());\n   AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(parent);\n   CHECK_EQ(env->tcp_constructor_template().IsEmpty(), false);\n@@ -65,9 +65,8 @@ Local<Object> TCPWrap::Instantiate(Environment* env,\n                                     .ToLocalChecked();\n   CHECK_EQ(constructor.IsEmpty(), false);\n   Local<Value> type_value = Int32::New(env->isolate(), type);\n-  Local<Object> instance =\n-      constructor->NewInstance(env->context(), 1, &type_value).ToLocalChecked();\n-  return handle_scope.Escape(instance);\n+  return handle_scope.EscapeMaybe(\n+      constructor->NewInstance(env->context(), 1, &type_value));\n }\n \n "
        },
        {
            "sha": "0467a1c3f3bf20894b015fd4a714d424432fe7d4",
            "filename": "src/tcp_wrap.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Ftcp_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Ftcp_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.h?ref=4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008",
            "patch": "@@ -37,9 +37,9 @@ class TCPWrap : public ConnectionWrap<TCPWrap, uv_tcp_t> {\n     SERVER\n   };\n \n-  static v8::Local<v8::Object> Instantiate(Environment* env,\n-                                           AsyncWrap* parent,\n-                                           SocketType type);\n+  static v8::MaybeLocal<v8::Object> Instantiate(Environment* env,\n+                                                AsyncWrap* parent,\n+                                                SocketType type);\n   static void Initialize(v8::Local<v8::Object> target,\n                          v8::Local<v8::Value> unused,\n                          v8::Local<v8::Context> context,"
        },
        {
            "sha": "e4aca28c89500e6298b8ca2a2ce8f791634740de",
            "filename": "src/udp_wrap.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 9,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fudp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fudp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fudp_wrap.cc?ref=4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008",
            "patch": "@@ -30,12 +30,12 @@ namespace node {\n \n using v8::Array;\n using v8::Context;\n-using v8::EscapableHandleScope;\n using v8::FunctionCallbackInfo;\n using v8::FunctionTemplate;\n using v8::HandleScope;\n using v8::Integer;\n using v8::Local;\n+using v8::MaybeLocal;\n using v8::Object;\n using v8::PropertyAttribute;\n using v8::Signature;\n@@ -518,18 +518,14 @@ void UDPWrap::OnRecv(uv_udp_t* handle,\n   wrap->MakeCallback(env->onmessage_string(), arraysize(argv), argv);\n }\n \n-\n-Local<Object> UDPWrap::Instantiate(Environment* env,\n-                                   AsyncWrap* parent,\n-                                   UDPWrap::SocketType type) {\n-  EscapableHandleScope scope(env->isolate());\n+MaybeLocal<Object> UDPWrap::Instantiate(Environment* env,\n+                                        AsyncWrap* parent,\n+                                        UDPWrap::SocketType type) {\n   AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(parent);\n \n   // If this assert fires then Initialize hasn't been called yet.\n   CHECK_EQ(env->udp_constructor_function().IsEmpty(), false);\n-  Local<Object> instance = env->udp_constructor_function()\n-      ->NewInstance(env->context()).ToLocalChecked();\n-  return scope.Escape(instance);\n+  return env->udp_constructor_function()->NewInstance(env->context());\n }\n \n "
        },
        {
            "sha": "97d95b57d3dd8483566ca9cf6443df4d4e878ad4",
            "filename": "src/udp_wrap.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fudp_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008/src%2Fudp_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fudp_wrap.h?ref=4dbff090c3ff2ba43b0fbb06cc65bef5b5d81008",
            "patch": "@@ -61,9 +61,9 @@ class UDPWrap: public HandleWrap {\n   static void SetTTL(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void BufferSize(const v8::FunctionCallbackInfo<v8::Value>& args);\n \n-  static v8::Local<v8::Object> Instantiate(Environment* env,\n-                                           AsyncWrap* parent,\n-                                           SocketType type);\n+  static v8::MaybeLocal<v8::Object> Instantiate(Environment* env,\n+                                                AsyncWrap* parent,\n+                                                SocketType type);\n   SET_NO_MEMORY_INFO()\n   SET_MEMORY_INFO_NAME(UDPWrap)\n   SET_SELF_SIZE(UDPWrap)"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 40,
        "deletions": 44
    }
}