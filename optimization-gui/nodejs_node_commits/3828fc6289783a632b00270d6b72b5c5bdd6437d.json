{
    "author": "bnoordhuis",
    "message": "src: make process.dlopen() load well-known symbol\n\nLook for symbol `node_register_module_v${NODE_MODULE_VERSION}` if the\nadd-on didn't self-register.  This can be used to create add-ons that\nsupport multiple Node.js versions from a single shared object.\n\nPR-URL: https://github.com/nodejs/node/pull/18934\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Matheus Marchini <matheus@sthima.com>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>",
    "sha": "3828fc6289783a632b00270d6b72b5c5bdd6437d",
    "files": [
        {
            "sha": "dbf9314273efebb1ba9a92398a6baab4b877481d",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 27,
            "deletions": 2,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/3828fc6289783a632b00270d6b72b5c5bdd6437d/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/3828fc6289783a632b00270d6b72b5c5bdd6437d/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=3828fc6289783a632b00270d6b72b5c5bdd6437d",
            "patch": "@@ -2158,6 +2158,7 @@ struct DLib {\n \n   inline bool Open();\n   inline void Close();\n+  inline void* GetSymbolAddress(const char* name);\n \n   const std::string filename_;\n   const int flags_;\n@@ -2185,6 +2186,10 @@ void DLib::Close() {\n   dlclose(handle_);\n   handle_ = nullptr;\n }\n+\n+void* DLib::GetSymbolAddress(const char* name) {\n+  return dlsym(handle_, name);\n+}\n #else  // !__POSIX__\n bool DLib::Open() {\n   int ret = uv_dlopen(filename_.c_str(), &lib_);\n@@ -2202,8 +2207,23 @@ void DLib::Close() {\n   uv_dlclose(&lib_);\n   handle_ = nullptr;\n }\n+\n+void* DLib::GetSymbolAddress(const char* name) {\n+  void* address;\n+  if (0 == uv_dlsym(&lib_, name, &address)) return address;\n+  return nullptr;\n+}\n #endif  // !__POSIX__\n \n+using InitializerCallback = void (*)(Local<Object> exports,\n+                                     Local<Value> module,\n+                                     Local<Context> context);\n+\n+inline InitializerCallback GetInitializerCallback(DLib* dlib) {\n+  const char* name = \"node_register_module_v\" STRINGIFY(NODE_MODULE_VERSION);\n+  return reinterpret_cast<InitializerCallback>(dlib->GetSymbolAddress(name));\n+}\n+\n // DLOpen is process.dlopen(module, filename, flags).\n // Used to load 'module.node' dynamically shared objects.\n //\n@@ -2258,10 +2278,15 @@ static void DLOpen(const FunctionCallbackInfo<Value>& args) {\n   }\n \n   if (mp == nullptr) {\n-    dlib.Close();\n-    env->ThrowError(\"Module did not self-register.\");\n+    if (auto callback = GetInitializerCallback(&dlib)) {\n+      callback(exports, module, context);\n+    } else {\n+      dlib.Close();\n+      env->ThrowError(\"Module did not self-register.\");\n+    }\n     return;\n   }\n+\n   if (mp->nm_version == -1) {\n     if (env->EmitNapiWarning()) {\n       if (ProcessEmitWarning(env, \"N-API is an experimental feature and could \""
        },
        {
            "sha": "ab5d1c120fa007c2d161ea794a521e11c614d6dc",
            "filename": "src/node.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/3828fc6289783a632b00270d6b72b5c5bdd6437d/src%2Fnode.h",
            "raw_url": "https://github.com/nodejs/node/raw/3828fc6289783a632b00270d6b72b5c5bdd6437d/src%2Fnode.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.h?ref=3828fc6289783a632b00270d6b72b5c5bdd6437d",
            "patch": "@@ -535,6 +535,9 @@ extern \"C\" NODE_EXTERN void node_module_register(void* mod);\n     }                                                                 \\\n   }\n \n+// Usage: `NODE_MODULE(NODE_GYP_MODULE_NAME, InitializerFunction)`\n+// If no NODE_MODULE is declared, Node.js looks for the well-known\n+// symbol `node_register_module_v${NODE_MODULE_VERSION}`.\n #define NODE_MODULE(modname, regfunc)                                 \\\n   NODE_MODULE_X(modname, regfunc, NULL, 0)  // NOLINT (readability/null_usage)\n "
        },
        {
            "sha": "ba6a22d7196d268fce26b51de38e988f24e4796a",
            "filename": "test/addons/hello-world/binding.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/3828fc6289783a632b00270d6b72b5c5bdd6437d/test%2Faddons%2Fhello-world%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/3828fc6289783a632b00270d6b72b5c5bdd6437d/test%2Faddons%2Fhello-world%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Fhello-world%2Fbinding.cc?ref=3828fc6289783a632b00270d6b72b5c5bdd6437d",
            "patch": "@@ -6,8 +6,12 @@ void Method(const v8::FunctionCallbackInfo<v8::Value>& args) {\n   args.GetReturnValue().Set(v8::String::NewFromUtf8(isolate, \"world\"));\n }\n \n-void init(v8::Local<v8::Object> exports) {\n+#define CONCAT(a, b) CONCAT_HELPER(a, b)\n+#define CONCAT_HELPER(a, b) a##b\n+#define INITIALIZER CONCAT(node_register_module_v, NODE_MODULE_VERSION)\n+\n+extern \"C\" NODE_MODULE_EXPORT void INITIALIZER(v8::Local<v8::Object> exports,\n+                                               v8::Local<v8::Value> module,\n+                                               v8::Local<v8::Context> context) {\n   NODE_SET_METHOD(exports, \"hello\", Method);\n }\n-\n-NODE_MODULE(NODE_GYP_MODULE_NAME, init)"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 37,
        "deletions": 5
    }
}