{
    "author": "jasnell",
    "message": "trace_events: add support for builtin trace\n\nPR-URL: https://github.com/nodejs/node/pull/21899\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "f7454a53f1318837ea2ca8f2ad495a9869b80e81",
    "files": [
        {
            "sha": "75c87d363a6b03705b8f15f9260016456c6024a6",
            "filename": "benchmark/misc/trace.js",
            "status": "added",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/nodejs/node/blob/f7454a53f1318837ea2ca8f2ad495a9869b80e81/benchmark%2Fmisc%2Ftrace.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7454a53f1318837ea2ca8f2ad495a9869b80e81/benchmark%2Fmisc%2Ftrace.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fmisc%2Ftrace.js?ref=f7454a53f1318837ea2ca8f2ad495a9869b80e81",
            "patch": "@@ -0,0 +1,75 @@\n+'use strict';\n+\n+const common = require('../common.js');\n+\n+const bench = common.createBenchmark(main, {\n+  n: [100000],\n+  method: ['trace', 'emit', 'isTraceCategoryEnabled', 'categoryGroupEnabled']\n+}, {\n+  flags: ['--expose-internals', '--trace-event-categories', 'foo']\n+});\n+\n+const {\n+  trace,\n+  isTraceCategoryEnabled,\n+  emit,\n+  categoryGroupEnabled\n+} = process.binding('trace_events');\n+\n+const {\n+  TRACE_EVENT_PHASE_NESTABLE_ASYNC_BEGIN: kBeforeEvent\n+} = process.binding('constants').trace;\n+\n+function doEmit(n) {\n+  bench.start();\n+  for (var i = 0; i < n; i++) {\n+    emit(kBeforeEvent, 'foo', 'test', 0, 'arg1', 1);\n+  }\n+  bench.end(n);\n+}\n+\n+function doTrace(n) {\n+  bench.start();\n+  for (var i = 0; i < n; i++) {\n+    trace(kBeforeEvent, 'foo', 'test', 0, 'test');\n+  }\n+  bench.end(n);\n+}\n+\n+function doIsTraceCategoryEnabled(n) {\n+  bench.start();\n+  for (var i = 0; i < n; i++) {\n+    isTraceCategoryEnabled('foo');\n+    isTraceCategoryEnabled('bar');\n+  }\n+  bench.end(n);\n+}\n+\n+function doCategoryGroupEnabled(n) {\n+  bench.start();\n+  for (var i = 0; i < n; i++) {\n+    categoryGroupEnabled('foo');\n+    categoryGroupEnabled('bar');\n+  }\n+  bench.end(n);\n+}\n+\n+function main({ n, method }) {\n+  switch (method) {\n+    case '':\n+    case 'trace':\n+      doTrace(n);\n+      break;\n+    case 'emit':\n+      doEmit(n);\n+      break;\n+    case 'isTraceCategoryEnabled':\n+      doIsTraceCategoryEnabled(n);\n+      break;\n+    case 'categoryGroupEnabled':\n+      doCategoryGroupEnabled(n);\n+      break;\n+    default:\n+      throw new Error(`Unexpected method \"${method}\"`);\n+  }\n+}"
        },
        {
            "sha": "61aa42a8efb6b2ef95680a94966b02d4d4efd313",
            "filename": "src/node_constants.cc",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/f7454a53f1318837ea2ca8f2ad495a9869b80e81/src%2Fnode_constants.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f7454a53f1318837ea2ca8f2ad495a9869b80e81/src%2Fnode_constants.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_constants.cc?ref=f7454a53f1318837ea2ca8f2ad495a9869b80e81",
            "patch": "@@ -1282,6 +1282,35 @@ void DefineDLOpenConstants(Local<Object> target) {\n #endif\n }\n \n+void DefineTraceConstants(Local<Object> target) {\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_BEGIN);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_END);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_COMPLETE);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_INSTANT);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_ASYNC_BEGIN);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_ASYNC_STEP_INTO);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_ASYNC_STEP_PAST);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_ASYNC_END);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_NESTABLE_ASYNC_BEGIN);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_NESTABLE_ASYNC_END);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_NESTABLE_ASYNC_INSTANT);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_FLOW_BEGIN);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_FLOW_STEP);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_FLOW_END);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_METADATA);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_COUNTER);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_SAMPLE);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_CREATE_OBJECT);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_SNAPSHOT_OBJECT);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_DELETE_OBJECT);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_MEMORY_DUMP);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_MARK);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_CLOCK_SYNC);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_ENTER_CONTEXT);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_LEAVE_CONTEXT);\n+  NODE_DEFINE_CONSTANT(target, TRACE_EVENT_PHASE_LINK_IDS);\n+}\n+\n }  // anonymous namespace\n \n void DefineConstants(v8::Isolate* isolate, Local<Object> target) {\n@@ -1315,6 +1344,10 @@ void DefineConstants(v8::Isolate* isolate, Local<Object> target) {\n   CHECK(dlopen_constants->SetPrototype(env->context(),\n                                        Null(env->isolate())).FromJust());\n \n+  Local<Object> trace_constants = Object::New(isolate);\n+  CHECK(trace_constants->SetPrototype(env->context(),\n+                                      Null(env->isolate())).FromJust());\n+\n   DefineErrnoConstants(err_constants);\n   DefineWindowsErrorConstants(err_constants);\n   DefineSignalConstants(sig_constants);\n@@ -1323,6 +1356,7 @@ void DefineConstants(v8::Isolate* isolate, Local<Object> target) {\n   DefineCryptoConstants(crypto_constants);\n   DefineZlibConstants(zlib_constants);\n   DefineDLOpenConstants(dlopen_constants);\n+  DefineTraceConstants(trace_constants);\n \n   // Define libuv constants.\n   NODE_DEFINE_CONSTANT(os_constants, UV_UDP_REUSEADDR);\n@@ -1334,6 +1368,7 @@ void DefineConstants(v8::Isolate* isolate, Local<Object> target) {\n   target->Set(OneByteString(isolate, \"fs\"), fs_constants);\n   target->Set(OneByteString(isolate, \"crypto\"), crypto_constants);\n   target->Set(OneByteString(isolate, \"zlib\"), zlib_constants);\n+  target->Set(OneByteString(isolate, \"trace\"), trace_constants);\n }\n \n }  // namespace node"
        },
        {
            "sha": "a2f42249483cd7ec8d11ce4476f4b68904cec962",
            "filename": "src/node_trace_events.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/f7454a53f1318837ea2ca8f2ad495a9869b80e81/src%2Fnode_trace_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f7454a53f1318837ea2ca8f2ad495a9869b80e81/src%2Fnode_trace_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_trace_events.cc?ref=f7454a53f1318837ea2ca8f2ad495a9869b80e81",
            "patch": "@@ -232,6 +232,19 @@ void Initialize(Local<Object> target,\n \n   target->Set(FIXED_ONE_BYTE_STRING(env->isolate(), \"CategorySet\"),\n               category_set->GetFunction());\n+\n+  Local<String> isTraceCategoryEnabled =\n+      FIXED_ONE_BYTE_STRING(env->isolate(), \"isTraceCategoryEnabled\");\n+  Local<String> trace = FIXED_ONE_BYTE_STRING(env->isolate(), \"trace\");\n+\n+  // Grab the trace and isTraceCategoryEnabled intrinsics from the binding\n+  // object and expose those to our binding layer.\n+  Local<Object> binding = context->GetExtrasBindingObject();\n+  target->Set(context, isTraceCategoryEnabled,\n+              binding->Get(context, isTraceCategoryEnabled).ToLocalChecked())\n+                  .FromJust();\n+  target->Set(context, trace,\n+              binding->Get(context, trace).ToLocalChecked()).FromJust();\n }\n \n }  // namespace node"
        },
        {
            "sha": "b8e852b3525ab84ccfa1ba0c06f2d984017d15c2",
            "filename": "test/parallel/test-binding-constants.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/f7454a53f1318837ea2ca8f2ad495a9869b80e81/test%2Fparallel%2Ftest-binding-constants.js",
            "raw_url": "https://github.com/nodejs/node/raw/f7454a53f1318837ea2ca8f2ad495a9869b80e81/test%2Fparallel%2Ftest-binding-constants.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-binding-constants.js?ref=f7454a53f1318837ea2ca8f2ad495a9869b80e81",
            "patch": "@@ -5,7 +5,7 @@ const constants = process.binding('constants');\n const assert = require('assert');\n \n assert.deepStrictEqual(\n-  Object.keys(constants).sort(), ['crypto', 'fs', 'os', 'zlib']\n+  Object.keys(constants).sort(), ['crypto', 'fs', 'os', 'trace', 'zlib']\n );\n \n assert.deepStrictEqual(\n@@ -26,6 +26,6 @@ function test(obj) {\n }\n \n [\n-  constants, constants.crypto, constants.fs, constants.os, constants.zlib,\n-  constants.os.dlopen, constants.os.errno, constants.os.signals\n+  constants, constants.crypto, constants.fs, constants.os, constants.trace,\n+  constants.zlib, constants.os.dlopen, constants.os.errno, constants.os.signals\n ].forEach(test);"
        }
    ],
    "stats": {
        "total": 129,
        "additions": 126,
        "deletions": 3
    }
}