{
    "author": "apapirovski",
    "message": "async_hooks,process: remove internalNextTick\n\nInstead of having mostly duplicate code in form of internalNextTick,\ninstead use the existing defaultAsyncTriggerIdScope with a slight\nmodification which allows undefined triggerAsyncId to be passed in,\nwhich then just triggers the callback with the provided arguments.\n\nPR-URL: https://github.com/nodejs/node/pull/19147\nRefs: https://github.com/nodejs/node/issues/19104\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Andreas Madsen <amwebdk@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "4d074343ddf674817b8479896bfdce5ae23a83e8",
    "files": [
        {
            "sha": "5a18e40b4f13b8554a2125d03e6ff2c850a1c419",
            "filename": "lib/_http_agent.js",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2F_http_agent.js",
            "raw_url": "https://github.com/nodejs/node/raw/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2F_http_agent.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_agent.js?ref=4d074343ddf674817b8479896bfdce5ae23a83e8",
            "patch": "@@ -26,7 +26,6 @@ const util = require('util');\n const EventEmitter = require('events');\n const debug = util.debuglog('http');\n const { async_id_symbol } = require('internal/async_hooks').symbols;\n-const { nextTick } = require('internal/process/next_tick');\n \n // New Agent code.\n \n@@ -342,10 +341,7 @@ Agent.prototype.destroy = function destroy() {\n function handleSocketCreation(request, informRequest) {\n   return function handleSocketCreation_Inner(err, socket) {\n     if (err) {\n-      const asyncId = (socket && socket._handle && socket._handle.getAsyncId) ?\n-        socket._handle.getAsyncId() :\n-        null;\n-      nextTick(asyncId, () => request.emit('error', err));\n+      process.nextTick(emitErrorNT, request, err);\n       return;\n     }\n     if (informRequest)\n@@ -355,6 +351,10 @@ function handleSocketCreation(request, informRequest) {\n   };\n }\n \n+function emitErrorNT(emitter, err) {\n+  emitter.emit('error', err);\n+}\n+\n module.exports = {\n   Agent,\n   globalAgent: new Agent()"
        },
        {
            "sha": "8e3d61a75612ca59ef99b2d34dcc5f48bd3605ec",
            "filename": "lib/_http_client.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2F_http_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2F_http_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_client.js?ref=4d074343ddf674817b8479896bfdce5ae23a83e8",
            "patch": "@@ -36,9 +36,9 @@ const {\n const { OutgoingMessage } = require('_http_outgoing');\n const Agent = require('_http_agent');\n const { Buffer } = require('buffer');\n+const { defaultTriggerAsyncIdScope } = require('internal/async_hooks');\n const { urlToOptions, searchParamsSymbol } = require('internal/url');\n const { outHeadersKey, ondrain } = require('internal/http');\n-const { nextTick } = require('internal/process/next_tick');\n const {\n   ERR_HTTP_HEADERS_SENT,\n   ERR_INVALID_ARG_TYPE,\n@@ -563,10 +563,10 @@ function responseKeepAlive(res, req) {\n     socket.once('error', freeSocketErrorListener);\n     // There are cases where _handle === null. Avoid those. Passing null to\n     // nextTick() will call getDefaultTriggerAsyncId() to retrieve the id.\n-    const asyncId = socket._handle ? socket._handle.getAsyncId() : null;\n+    const asyncId = socket._handle ? socket._handle.getAsyncId() : undefined;\n     // Mark this socket as available, AFTER user-added end\n     // handlers have a chance to run.\n-    nextTick(asyncId, emitFreeNT, socket);\n+    defaultTriggerAsyncIdScope(asyncId, process.nextTick, emitFreeNT, socket);\n   }\n }\n "
        },
        {
            "sha": "1c2250a4b2d836027cb3036f4696edb1dea8f548",
            "filename": "lib/_http_outgoing.js",
            "status": "modified",
            "additions": 16,
            "deletions": 12,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2F_http_outgoing.js",
            "raw_url": "https://github.com/nodejs/node/raw/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2F_http_outgoing.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_outgoing.js?ref=4d074343ddf674817b8479896bfdce5ae23a83e8",
            "patch": "@@ -31,8 +31,10 @@ const common = require('_http_common');\n const checkIsHttpToken = common._checkIsHttpToken;\n const checkInvalidHeaderChar = common._checkInvalidHeaderChar;\n const { outHeadersKey } = require('internal/http');\n-const { async_id_symbol } = require('internal/async_hooks').symbols;\n-const { nextTick } = require('internal/process/next_tick');\n+const {\n+  defaultTriggerAsyncIdScope,\n+  symbols: { async_id_symbol }\n+} = require('internal/async_hooks');\n const {\n   ERR_HTTP_HEADERS_SENT,\n   ERR_HTTP_INVALID_HEADER_VALUE,\n@@ -272,15 +274,14 @@ function _writeRaw(data, encoding, callback) {\n       this._flushOutput(conn);\n     } else if (!data.length) {\n       if (typeof callback === 'function') {\n-        let socketAsyncId = this.socket[async_id_symbol];\n         // If the socket was set directly it won't be correctly initialized\n         // with an async_id_symbol.\n         // TODO(AndreasMadsen): @trevnorris suggested some more correct\n         // solutions in:\n         // https://github.com/nodejs/node/pull/14389/files#r128522202\n-        if (socketAsyncId === undefined) socketAsyncId = null;\n-\n-        nextTick(socketAsyncId, callback);\n+        defaultTriggerAsyncIdScope(conn[async_id_symbol],\n+                                   process.nextTick,\n+                                   callback);\n       }\n       return true;\n     }\n@@ -633,10 +634,13 @@ OutgoingMessage.prototype.write = function write(chunk, encoding, callback) {\n function write_(msg, chunk, encoding, callback, fromEnd) {\n   if (msg.finished) {\n     const err = new ERR_STREAM_WRITE_AFTER_END();\n-    nextTick(msg.socket && msg.socket[async_id_symbol],\n-             writeAfterEndNT.bind(msg),\n-             err,\n-             callback);\n+    const triggerAsyncId = msg.socket ? msg.socket[async_id_symbol] : undefined;\n+    defaultTriggerAsyncIdScope(triggerAsyncId,\n+                               process.nextTick,\n+                               writeAfterEndNT,\n+                               msg,\n+                               err,\n+                               callback);\n \n     return true;\n   }\n@@ -686,8 +690,8 @@ function write_(msg, chunk, encoding, callback, fromEnd) {\n }\n \n \n-function writeAfterEndNT(err, callback) {\n-  this.emit('error', err);\n+function writeAfterEndNT(msg, err, callback) {\n+  msg.emit('error', err);\n   if (callback) callback(err);\n }\n "
        },
        {
            "sha": "b9caeddabe2374a4a92d7242eafa75566f713d54",
            "filename": "lib/dgram.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2Fdgram.js",
            "raw_url": "https://github.com/nodejs/node/raw/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2Fdgram.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fdgram.js?ref=4d074343ddf674817b8479896bfdce5ae23a83e8",
            "patch": "@@ -44,7 +44,6 @@ const {\n   symbols: { async_id_symbol }\n } = require('internal/async_hooks');\n const { UV_UDP_REUSEADDR } = process.binding('constants').os;\n-const { nextTick } = require('internal/process/next_tick');\n \n const { UDP, SendWrap } = process.binding('udp_wrap');\n \n@@ -526,7 +525,10 @@ Socket.prototype.close = function(callback) {\n   this._stopReceiving();\n   this._handle.close();\n   this._handle = null;\n-  nextTick(this[async_id_symbol], socketCloseNT, this);\n+  defaultTriggerAsyncIdScope(this[async_id_symbol],\n+                             process.nextTick,\n+                             socketCloseNT,\n+                             this);\n \n   return this;\n };"
        },
        {
            "sha": "8c4fd08fd83c0fd9e3d6db6902a62f681bb863b8",
            "filename": "lib/internal/async_hooks.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2Finternal%2Fasync_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2Finternal%2Fasync_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fasync_hooks.js?ref=4d074343ddf674817b8479896bfdce5ae23a83e8",
            "patch": "@@ -281,6 +281,8 @@ function clearDefaultTriggerAsyncId() {\n \n \n function defaultTriggerAsyncIdScope(triggerAsyncId, block, ...args) {\n+  if (triggerAsyncId === undefined)\n+    return Reflect.apply(block, null, args);\n   // CHECK(Number.isSafeInteger(triggerAsyncId))\n   // CHECK(triggerAsyncId > 0)\n   const oldDefaultTriggerAsyncId = async_id_fields[kDefaultTriggerAsyncId];"
        },
        {
            "sha": "7acf266cb7f73d4cd62acd270fa57afdf0a15467",
            "filename": "lib/internal/process/next_tick.js",
            "status": "modified",
            "additions": 0,
            "deletions": 33,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2Finternal%2Fprocess%2Fnext_tick.js",
            "raw_url": "https://github.com/nodejs/node/raw/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2Finternal%2Fprocess%2Fnext_tick.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fnext_tick.js?ref=4d074343ddf674817b8479896bfdce5ae23a83e8",
            "patch": "@@ -1,8 +1,6 @@\n 'use strict';\n \n exports.setup = setupNextTick;\n-// Will be overwritten when setupNextTick() is called.\n-exports.nextTick = null;\n \n function setupNextTick() {\n   const {\n@@ -87,9 +85,6 @@ function setupNextTick() {\n   // Needs to be accessible from beyond this scope.\n   process._tickCallback = _tickCallback;\n \n-  // Set the nextTick() function for internal usage.\n-  exports.nextTick = internalNextTick;\n-\n   function _tickCallback() {\n     let tock;\n     do {\n@@ -165,32 +160,4 @@ function setupNextTick() {\n \n     push(new TickObject(callback, args, getDefaultTriggerAsyncId()));\n   }\n-\n-  // `internalNextTick()` will not enqueue any callback when the process is\n-  // about to exit since the callback would not have a chance to be executed.\n-  function internalNextTick(triggerAsyncId, callback) {\n-    if (typeof callback !== 'function')\n-      throw new ERR_INVALID_CALLBACK();\n-    // CHECK(Number.isSafeInteger(triggerAsyncId) || triggerAsyncId === null)\n-    // CHECK(triggerAsyncId > 0 || triggerAsyncId === null)\n-\n-    if (process._exiting)\n-      return;\n-\n-    var args;\n-    switch (arguments.length) {\n-      case 2: break;\n-      case 3: args = [arguments[2]]; break;\n-      case 4: args = [arguments[2], arguments[3]]; break;\n-      case 5: args = [arguments[2], arguments[3], arguments[4]]; break;\n-      default:\n-        args = new Array(arguments.length - 2);\n-        for (var i = 2; i < arguments.length; i++)\n-          args[i - 2] = arguments[i];\n-    }\n-\n-    if (triggerAsyncId === null)\n-      triggerAsyncId = getDefaultTriggerAsyncId();\n-    push(new TickObject(callback, args, triggerAsyncId));\n-  }\n }"
        },
        {
            "sha": "19f5b135891eb2d5a6e6fd2f1aa91ba91d008345",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 20,
            "deletions": 9,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/4d074343ddf674817b8479896bfdce5ae23a83e8/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=4d074343ddf674817b8479896bfdce5ae23a83e8",
            "patch": "@@ -52,7 +52,6 @@ const {\n   defaultTriggerAsyncIdScope,\n   symbols: { async_id_symbol }\n } = require('internal/async_hooks');\n-const { nextTick } = require('internal/process/next_tick');\n const errors = require('internal/errors');\n const {\n   ERR_INVALID_ARG_TYPE,\n@@ -392,7 +391,7 @@ function writeAfterFIN(chunk, encoding, cb) {\n   // TODO: defer error events consistently everywhere, not just the cb\n   this.emit('error', er);\n   if (typeof cb === 'function') {\n-    nextTick(this[async_id_symbol], cb, er);\n+    defaultTriggerAsyncIdScope(this[async_id_symbol], process.nextTick, cb, er);\n   }\n }\n \n@@ -1069,7 +1068,7 @@ function lookupAndConnect(self, options) {\n   // If host is an IP, skip performing a lookup\n   var addressType = isIP(host);\n   if (addressType) {\n-    nextTick(self[async_id_symbol], function() {\n+    defaultTriggerAsyncIdScope(self[async_id_symbol], process.nextTick, () => {\n       if (self.connecting)\n         defaultTriggerAsyncIdScope(\n           self[async_id_symbol],\n@@ -1372,7 +1371,11 @@ function setupListenHandle(address, port, addressType, backlog, fd) {\n     var ex = exceptionWithHostPort(err, 'listen', address, port);\n     this._handle.close();\n     this._handle = null;\n-    nextTick(this[async_id_symbol], emitErrorNT, this, ex);\n+    defaultTriggerAsyncIdScope(this[async_id_symbol],\n+                               process.nextTick,\n+                               emitErrorNT,\n+                               this,\n+                               ex);\n     return;\n   }\n \n@@ -1383,7 +1386,10 @@ function setupListenHandle(address, port, addressType, backlog, fd) {\n   if (this._unref)\n     this.unref();\n \n-  nextTick(this[async_id_symbol], emitListeningNT, this);\n+  defaultTriggerAsyncIdScope(this[async_id_symbol],\n+                             process.nextTick,\n+                             emitListeningNT,\n+                             this);\n }\n \n Server.prototype._listen2 = setupListenHandle;  // legacy alias\n@@ -1590,8 +1596,11 @@ Server.prototype.getConnections = function(cb) {\n   const self = this;\n \n   function end(err, connections) {\n-    const asyncId = self._handle ? self[async_id_symbol] : null;\n-    nextTick(asyncId, cb, err, connections);\n+    defaultTriggerAsyncIdScope(self[async_id_symbol],\n+                               process.nextTick,\n+                               cb,\n+                               err,\n+                               connections);\n   }\n \n   if (!this._usingWorkers) {\n@@ -1669,8 +1678,10 @@ Server.prototype._emitCloseIfDrained = function() {\n     return;\n   }\n \n-  const asyncId = this._handle ? this[async_id_symbol] : null;\n-  nextTick(asyncId, emitCloseNT, this);\n+  defaultTriggerAsyncIdScope(this[async_id_symbol],\n+                             process.nextTick,\n+                             emitCloseNT,\n+                             this);\n };\n \n "
        },
        {
            "sha": "ed54186854220614227880b194e6a0335d87cb01",
            "filename": "test/async-hooks/test-internal-nexttick-default-trigger.js",
            "status": "removed",
            "additions": 0,
            "deletions": 47,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/64d523411f4a87e4f27624f83590341eb3693cef/test%2Fasync-hooks%2Ftest-internal-nexttick-default-trigger.js",
            "raw_url": "https://github.com/nodejs/node/raw/64d523411f4a87e4f27624f83590341eb3693cef/test%2Fasync-hooks%2Ftest-internal-nexttick-default-trigger.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-internal-nexttick-default-trigger.js?ref=64d523411f4a87e4f27624f83590341eb3693cef",
            "patch": "@@ -1,47 +0,0 @@\n-'use strict';\n-// Flags: --expose-internals\n-const common = require('../common');\n-\n-// This tests ensures that the triggerId of both the internal and external\n-// nextTick function sets the triggerAsyncId correctly.\n-\n-const assert = require('assert');\n-const async_hooks = require('async_hooks');\n-const initHooks = require('./init-hooks');\n-const { checkInvocations } = require('./hook-checks');\n-const internal = require('internal/process/next_tick');\n-\n-const hooks = initHooks();\n-hooks.enable();\n-\n-const rootAsyncId = async_hooks.executionAsyncId();\n-\n-// public\n-process.nextTick(common.mustCall(function() {\n-  assert.strictEqual(async_hooks.triggerAsyncId(), rootAsyncId);\n-}));\n-\n-// internal default\n-internal.nextTick(null, common.mustCall(function() {\n-  assert.strictEqual(async_hooks.triggerAsyncId(), rootAsyncId);\n-}));\n-\n-// internal\n-internal.nextTick(rootAsyncId + 1, common.mustCall(function() {\n-  assert.strictEqual(async_hooks.triggerAsyncId(), rootAsyncId + 1);\n-}));\n-\n-process.on('exit', function() {\n-  hooks.sanityCheck();\n-\n-  const as = hooks.activitiesOfTypes('TickObject');\n-  checkInvocations(as[0], {\n-    init: 1, before: 1, after: 1, destroy: 1\n-  }, 'when process exits');\n-  checkInvocations(as[1], {\n-    init: 1, before: 1, after: 1, destroy: 1\n-  }, 'when process exits');\n-  checkInvocations(as[2], {\n-    init: 1, before: 1, after: 1, destroy: 1\n-  }, 'when process exits');\n-});"
        },
        {
            "sha": "1bc93f29737389e2cb69acc61af0621cb25bb3f9",
            "filename": "test/async-hooks/test-nexttick-default-trigger.js",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/4d074343ddf674817b8479896bfdce5ae23a83e8/test%2Fasync-hooks%2Ftest-nexttick-default-trigger.js",
            "raw_url": "https://github.com/nodejs/node/raw/4d074343ddf674817b8479896bfdce5ae23a83e8/test%2Fasync-hooks%2Ftest-nexttick-default-trigger.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-nexttick-default-trigger.js?ref=4d074343ddf674817b8479896bfdce5ae23a83e8",
            "patch": "@@ -0,0 +1,28 @@\n+'use strict';\n+const common = require('../common');\n+\n+// This tests ensures that the triggerId of the nextTick function sets the\n+// triggerAsyncId correctly.\n+\n+const assert = require('assert');\n+const async_hooks = require('async_hooks');\n+const initHooks = require('./init-hooks');\n+const { checkInvocations } = require('./hook-checks');\n+\n+const hooks = initHooks();\n+hooks.enable();\n+\n+const rootAsyncId = async_hooks.executionAsyncId();\n+\n+process.nextTick(common.mustCall(function() {\n+  assert.strictEqual(async_hooks.triggerAsyncId(), rootAsyncId);\n+}));\n+\n+process.on('exit', function() {\n+  hooks.sanityCheck();\n+\n+  const as = hooks.activitiesOfTypes('TickObject');\n+  checkInvocations(as[0], {\n+    init: 1, before: 1, after: 1, destroy: 1\n+  }, 'when process exits');\n+});"
        },
        {
            "sha": "12742bd5d4f014ec944924bf9d50b58e69d5f8e7",
            "filename": "test/async-hooks/test-no-assert-when-disabled.js",
            "status": "modified",
            "additions": 1,
            "deletions": 8,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/4d074343ddf674817b8479896bfdce5ae23a83e8/test%2Fasync-hooks%2Ftest-no-assert-when-disabled.js",
            "raw_url": "https://github.com/nodejs/node/raw/4d074343ddf674817b8479896bfdce5ae23a83e8/test%2Fasync-hooks%2Ftest-no-assert-when-disabled.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-no-assert-when-disabled.js?ref=4d074343ddf674817b8479896bfdce5ae23a83e8",
            "patch": "@@ -1,15 +1,8 @@\n 'use strict';\n // Flags: --no-force-async-hooks-checks --expose-internals\n-const common = require('../common');\n+require('../common');\n \n const async_hooks = require('internal/async_hooks');\n-const internal = require('internal/process/next_tick');\n-\n-// Using undefined as the triggerAsyncId.\n-// Ref: https://github.com/nodejs/node/issues/14386\n-// Ref: https://github.com/nodejs/node/issues/14381\n-// Ref: https://github.com/nodejs/node/issues/14368\n-internal.nextTick(undefined, common.mustCall());\n \n // Negative asyncIds and invalid type name\n async_hooks.emitInit(-1, null, -1, {});"
        }
    ],
    "stats": {
        "total": 198,
        "additions": 79,
        "deletions": 119
    }
}