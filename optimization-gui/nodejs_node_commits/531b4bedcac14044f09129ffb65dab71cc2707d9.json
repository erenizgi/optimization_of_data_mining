{
    "author": "bzoz",
    "message": "net: allow IPC servers be accessible by all\n\nAdds mappings to uv_pipe_chmod call by adding two new options to\nlisten call. This allows the IPC server pipe to be made readable or\nwritable by all users.\n\nFixes: https://github.com/nodejs/node/issues/19154\n\nPR-URL: https://github.com/nodejs/node/pull/19472\nReviewed-By: Santiago Gimeno <santiago.gimeno@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "531b4bedcac14044f09129ffb65dab71cc2707d9",
    "files": [
        {
            "sha": "e48bdc1eaaf3b7c0307b6c879015507835ebe94d",
            "filename": "doc/api/net.md",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/531b4bedcac14044f09129ffb65dab71cc2707d9/doc%2Fapi%2Fnet.md",
            "raw_url": "https://github.com/nodejs/node/raw/531b4bedcac14044f09129ffb65dab71cc2707d9/doc%2Fapi%2Fnet.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fnet.md?ref=531b4bedcac14044f09129ffb65dab71cc2707d9",
            "patch": "@@ -260,6 +260,10 @@ added: v0.11.14\n   * `backlog` {number} Common parameter of [`server.listen()`][]\n     functions.\n   * `exclusive` {boolean} **Default:** `false`\n+  * `readableAll` {boolean} For IPC servers makes the pipe readable\n+    for all users. **Default:** `false`\n+  * `writableAll` {boolean} For IPC servers makes the pipe writable\n+    for all users. **Default:** `false`\n * `callback` {Function} Common parameter of [`server.listen()`][]\n   functions.\n * Returns: {net.Server}\n@@ -285,6 +289,10 @@ server.listen({\n });\n ```\n \n+Starting an IPC server as root may cause the server path to be inaccessible for\n+unprivileged users. Using `readableAll` and `writableAll` will make the server\n+accessible for all users.\n+\n #### server.listen(path[, backlog][, callback])\n <!-- YAML\n added: v0.1.90"
        },
        {
            "sha": "6eb6ae818f5ae3d36b6f478f67d444fdd80c40f5",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/531b4bedcac14044f09129ffb65dab71cc2707d9/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/531b4bedcac14044f09129ffb65dab71cc2707d9/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=531b4bedcac14044f09129ffb65dab71cc2707d9",
            "patch": "@@ -1475,6 +1475,19 @@ Server.prototype.listen = function(...args) {\n     backlog = options.backlog || backlogFromArgs;\n     listenInCluster(this, pipeName, -1, -1,\n                     backlog, undefined, options.exclusive);\n+    let mode = 0;\n+    if (options.readableAll === true)\n+      mode |= PipeConstants.UV_READABLE;\n+    if (options.writableAll === true)\n+      mode |= PipeConstants.UV_WRITABLE;\n+    if (mode !== 0) {\n+      const err = this._handle.fchmod(mode);\n+      if (err) {\n+        this._handle.close();\n+        this._handle = null;\n+        throw errnoException(err, 'uv_pipe_chmod');\n+      }\n+    }\n     return this;\n   }\n "
        },
        {
            "sha": "52e3f2730ed125035ac1601434f794c9cd9df157",
            "filename": "src/pipe_wrap.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/531b4bedcac14044f09129ffb65dab71cc2707d9/src%2Fpipe_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/531b4bedcac14044f09129ffb65dab71cc2707d9/src%2Fpipe_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fpipe_wrap.cc?ref=531b4bedcac14044f09129ffb65dab71cc2707d9",
            "patch": "@@ -98,6 +98,8 @@ void PipeWrap::Initialize(Local<Object> target,\n   env->SetProtoMethod(t, \"setPendingInstances\", SetPendingInstances);\n #endif\n \n+  env->SetProtoMethod(t, \"fchmod\", Fchmod);\n+\n   target->Set(pipeString, t->GetFunction());\n   env->set_pipe_constructor_template(t);\n \n@@ -114,6 +116,8 @@ void PipeWrap::Initialize(Local<Object> target,\n   NODE_DEFINE_CONSTANT(constants, SOCKET);\n   NODE_DEFINE_CONSTANT(constants, SERVER);\n   NODE_DEFINE_CONSTANT(constants, IPC);\n+  NODE_DEFINE_CONSTANT(constants, UV_READABLE);\n+  NODE_DEFINE_CONSTANT(constants, UV_WRITABLE);\n   target->Set(context,\n               FIXED_ONE_BYTE_STRING(env->isolate(), \"constants\"),\n               constants).FromJust();\n@@ -184,6 +188,17 @@ void PipeWrap::SetPendingInstances(const FunctionCallbackInfo<Value>& args) {\n #endif\n \n \n+void PipeWrap::Fchmod(const v8::FunctionCallbackInfo<v8::Value>& args) {\n+  PipeWrap* wrap;\n+  ASSIGN_OR_RETURN_UNWRAP(&wrap, args.Holder());\n+  CHECK(args[0]->IsInt32());\n+  int mode = args[0].As<Int32>()->Value();\n+  int err = uv_pipe_chmod(reinterpret_cast<uv_pipe_t*>(&wrap->handle_),\n+                          mode);\n+  args.GetReturnValue().Set(err);\n+}\n+\n+\n void PipeWrap::Listen(const FunctionCallbackInfo<Value>& args) {\n   PipeWrap* wrap;\n   ASSIGN_OR_RETURN_UNWRAP(&wrap, args.Holder());"
        },
        {
            "sha": "d6e45c28ff7822e4a04fb39c39ea6417a626072c",
            "filename": "src/pipe_wrap.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/531b4bedcac14044f09129ffb65dab71cc2707d9/src%2Fpipe_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/531b4bedcac14044f09129ffb65dab71cc2707d9/src%2Fpipe_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fpipe_wrap.h?ref=531b4bedcac14044f09129ffb65dab71cc2707d9",
            "patch": "@@ -63,6 +63,7 @@ class PipeWrap : public ConnectionWrap<PipeWrap, uv_pipe_t> {\n   static void SetPendingInstances(\n       const v8::FunctionCallbackInfo<v8::Value>& args);\n #endif\n+  static void Fchmod(const v8::FunctionCallbackInfo<v8::Value>& args);\n };\n \n "
        },
        {
            "sha": "22ad50f11ea2f6b74b306295ef99fe806eb0583b",
            "filename": "test/parallel/test-net-server-listen-path.js",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/531b4bedcac14044f09129ffb65dab71cc2707d9/test%2Fparallel%2Ftest-net-server-listen-path.js",
            "raw_url": "https://github.com/nodejs/node/raw/531b4bedcac14044f09129ffb65dab71cc2707d9/test%2Fparallel%2Ftest-net-server-listen-path.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-server-listen-path.js?ref=531b4bedcac14044f09129ffb65dab71cc2707d9",
            "patch": "@@ -2,6 +2,8 @@\n \n const common = require('../common');\n const net = require('net');\n+const assert = require('assert');\n+const fs = require('fs');\n \n const tmpdir = require('../common/tmpdir');\n tmpdir.refresh();\n@@ -48,3 +50,22 @@ function randomPipePath() {\n   net.createServer()\n     .listen({ path: handlePath }, closeServer());\n }\n+\n+// Test pipe chmod\n+{\n+  const handlePath = randomPipePath();\n+\n+  const srv = net.createServer()\n+    .listen({\n+      path: handlePath,\n+      readableAll: true,\n+      writableAll: true\n+    }, common.mustCall(() => {\n+      if (process.platform !== 'win32') {\n+        const mode = fs.statSync(handlePath).mode;\n+        assert.ok(mode & fs.constants.S_IROTH !== 0);\n+        assert.ok(mode & fs.constants.S_IWOTH !== 0);\n+      }\n+      srv.close();\n+    }));\n+}"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 58,
        "deletions": 0
    }
}