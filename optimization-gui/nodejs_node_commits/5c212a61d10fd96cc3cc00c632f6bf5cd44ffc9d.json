{
    "author": "addaleax",
    "message": "src: plug trace file file descriptor leak\n\nClose existing file descriptors before overriding\nthe field with new ones.\n\nAlso, use `nullptr` as the loop for these synchronous\noperations, since they do not run on the same thread\nas the `uv_run()` call for the previously used loop.\n\nPR-URL: https://github.com/nodejs/node/pull/21867\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "5c212a61d10fd96cc3cc00c632f6bf5cd44ffc9d",
    "files": [
        {
            "sha": "2fb7c12a82dace7e215ed8533e04c0f6135f9521",
            "filename": "src/tracing/node_trace_writer.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/5c212a61d10fd96cc3cc00c632f6bf5cd44ffc9d/src%2Ftracing%2Fnode_trace_writer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5c212a61d10fd96cc3cc00c632f6bf5cd44ffc9d/src%2Ftracing%2Fnode_trace_writer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fnode_trace_writer.cc?ref=5c212a61d10fd96cc3cc00c632f6bf5cd44ffc9d",
            "patch": "@@ -53,7 +53,7 @@ NodeTraceWriter::~NodeTraceWriter() {\n   uv_fs_t req;\n   int err;\n   if (fd_ != -1) {\n-    err = uv_fs_close(tracing_loop_, &req, fd_, nullptr);\n+    err = uv_fs_close(nullptr, &req, fd_, nullptr);\n     CHECK_EQ(err, 0);\n     uv_fs_req_cleanup(&req);\n   }\n@@ -84,7 +84,12 @@ void NodeTraceWriter::OpenNewFileForStreaming() {\n   replace_substring(&filepath, \"${pid}\", std::to_string(uv_os_getpid()));\n   replace_substring(&filepath, \"${rotation}\", std::to_string(file_num_));\n \n-  fd_ = uv_fs_open(tracing_loop_, &req, filepath.c_str(),\n+  if (fd_ != -1) {\n+    CHECK_EQ(uv_fs_close(nullptr, &req, fd_, nullptr), 0);\n+    uv_fs_req_cleanup(&req);\n+  }\n+\n+  fd_ = uv_fs_open(nullptr, &req, filepath.c_str(),\n       O_CREAT | O_WRONLY | O_TRUNC, 0644, nullptr);\n   uv_fs_req_cleanup(&req);\n   if (fd_ < 0) {"
        }
    ],
    "stats": {
        "total": 9,
        "additions": 7,
        "deletions": 2
    }
}