{
    "author": "joyeecheung",
    "message": "test: support more icu requirements in the WPT status file\n\nSupport `small-icu` and `full-icu` requirements, where `full-icu`\nimplies `small-icu`.\n\nPR-URL: https://github.com/nodejs/node/pull/25321\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "c667325cbea83ef50c72484692ca5c9114b43c4a",
    "files": [
        {
            "sha": "0b4424ef73b2247721074c464fe6117b4b9cfecc",
            "filename": "test/common/wpt.js",
            "status": "modified",
            "additions": 43,
            "deletions": 5,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/c667325cbea83ef50c72484692ca5c9114b43c4a/test%2Fcommon%2Fwpt.js",
            "raw_url": "https://github.com/nodejs/node/raw/c667325cbea83ef50c72484692ca5c9114b43c4a/test%2Fcommon%2Fwpt.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Fwpt.js?ref=c667325cbea83ef50c72484692ca5c9114b43c4a",
            "patch": "@@ -1,7 +1,7 @@\n+/* eslint-disable node-core/required-modules */\n 'use strict';\n \n const assert = require('assert');\n-const common = require('../common');\n const fixtures = require('../common/fixtures');\n const fs = require('fs');\n const fsPromises = fs.promises;\n@@ -160,12 +160,49 @@ class WPTTest {\n   getContent() {\n     return fs.readFileSync(this.getAbsolutePath(), 'utf8');\n   }\n+}\n+\n+const kIntlRequirement = {\n+  none: 0,\n+  small: 1,\n+  full: 2,\n+  // TODO(joyeecheung): we may need to deal with --with-intl=system-icu\n+};\n+\n+class IntlRequirement {\n+  constructor() {\n+    this.currentIntl = kIntlRequirement.none;\n+    if (process.config.variables.v8_enable_i18n_support === 0) {\n+      this.currentIntl = kIntlRequirement.none;\n+      return;\n+    }\n+    // i18n enabled\n+    if (process.config.variables.icu_small) {\n+      this.currentIntl = kIntlRequirement.small;\n+    } else {\n+      this.currentIntl = kIntlRequirement.full;\n+    }\n+  }\n \n-  requireIntl() {\n-    return this.requires.has('intl');\n+  /**\n+   * @param {Set} requires\n+   * @returns {string|false} The config that the build is lacking, or false\n+   */\n+  isLacking(requires) {\n+    const current = this.currentIntl;\n+    if (requires.has('full-icu') && current !== kIntlRequirement.full) {\n+      return 'full-icu';\n+    }\n+    if (requires.has('small-icu') && current < kIntlRequirement.small) {\n+      return 'small-icu';\n+    }\n+    return false;\n   }\n }\n \n+const intlRequirements = new IntlRequirement();\n+\n+\n class StatusLoader {\n   constructor(path) {\n     this.path = path;\n@@ -498,8 +535,9 @@ class WPTRunner {\n         continue;\n       }\n \n-      if (!common.hasIntl && test.requireIntl()) {\n-        this.skip(filename, [ 'missing Intl' ]);\n+      const lackingIntl = intlRequirements.isLacking(test.requires);\n+      if (lackingIntl) {\n+        this.skip(filename, [ `requires ${lackingIntl}` ]);\n         continue;\n       }\n "
        },
        {
            "sha": "15318b2aefe5d7889689a9966d7e4ede8ebb6d3a",
            "filename": "test/wpt/README.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c667325cbea83ef50c72484692ca5c9114b43c4a/test%2Fwpt%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/c667325cbea83ef50c72484692ca5c9114b43c4a/test%2Fwpt%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fwpt%2FREADME.md?ref=c667325cbea83ef50c72484692ca5c9114b43c4a",
            "patch": "@@ -151,7 +151,7 @@ expected failures.\n {\n   \"something.scope.js\": {  // the file name\n     // Optional: If the requirement is not met, this test will be skipped\n-    \"requires\": [\"intl\"],  // currently only intl is supported\n+    \"requires\": [\"small-icu\"],  // supports: \"small-icu\", \"full-icu\"\n \n     // Optional: the test will be skipped with the reason printed\n     \"skip\": \"explain why we cannot run a test that's supposed to pass\","
        },
        {
            "sha": "fa27b25abdb54cf74033b56d6885eb2ab71ec10e",
            "filename": "test/wpt/status/url.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/c667325cbea83ef50c72484692ca5c9114b43c4a/test%2Fwpt%2Fstatus%2Furl.json",
            "raw_url": "https://github.com/nodejs/node/raw/c667325cbea83ef50c72484692ca5c9114b43c4a/test%2Fwpt%2Fstatus%2Furl.json",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fwpt%2Fstatus%2Furl.json?ref=c667325cbea83ef50c72484692ca5c9114b43c4a",
            "patch": "@@ -1,10 +1,10 @@\n {\n   \"toascii.window.js\": {\n-    \"requires\": [\"intl\"],\n+    \"requires\": [\"small-icu\"],\n     \"skip\": \"TODO: port from .window.js\"\n   },\n   \"historical.any.js\": {\n-    \"requires\": [\"intl\"]\n+    \"requires\": [\"small-icu\"]\n   },\n   \"urlencoded-parser.any.js\": {\n     \"fail\": \"missing Request and Response\""
        }
    ],
    "stats": {
        "total": 54,
        "additions": 46,
        "deletions": 8
    }
}