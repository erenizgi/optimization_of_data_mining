{
    "author": "jasnell",
    "message": "fs: consistent constants use and cleanup\n\n* only require('buffer') once\n* use constants directly\n* fix incorrect constants\n\nPR-URL: https://github.com/nodejs/node/pull/20765\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ron Korving <ron@ronkorving.nl>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "1d3759a33c153dc0216b53085a25922abee34c8d",
    "files": [
        {
            "sha": "c7ac1a8a92368fe001b8c44c9f3504ca71c612ed",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 37,
            "deletions": 22,
            "changes": 59,
            "blob_url": "https://github.com/nodejs/node/blob/1d3759a33c153dc0216b53085a25922abee34c8d/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/1d3759a33c153dc0216b53085a25922abee34c8d/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=1d3759a33c153dc0216b53085a25922abee34c8d",
            "patch": "@@ -24,16 +24,31 @@\n \n 'use strict';\n \n-const constants = process.binding('constants').fs;\n-const { S_IFIFO, S_IFLNK, S_IFMT, S_IFREG, S_IFSOCK } = constants;\n+const { fs: constants } = process.binding('constants');\n+const {\n+  S_IFIFO,\n+  S_IFLNK,\n+  S_IFMT,\n+  S_IFREG,\n+  S_IFSOCK,\n+  F_OK,\n+  R_OK,\n+  W_OK,\n+  X_OK,\n+  O_WRONLY,\n+  O_SYMLINK,\n+  UV_FS_COPYFILE_EXCL,\n+  UV_FS_COPYFILE_FICLONE,\n+  UV_FS_COPYFILE_FICLONE_FORCE\n+} = constants;\n const util = require('util');\n const pathModule = require('path');\n const { isUint8Array } = require('internal/util/types');\n const { createPromise, promiseResolve } = process.binding('util');\n \n const binding = process.binding('fs');\n const fs = exports;\n-const { Buffer } = require('buffer');\n+const { Buffer, kMaxLength } = require('buffer');\n const errors = require('internal/errors');\n const {\n   ERR_FS_FILE_TOO_LARGE,\n@@ -56,6 +71,7 @@ const {\n   preprocessSymlinkDestination,\n   Stats,\n   getStatsFromBinding,\n+  realpathCacheKey,\n   stringToFlags,\n   stringToSymlinkType,\n   toUnixTimestamp,\n@@ -105,7 +121,6 @@ function lazyAssert() {\n }\n \n const kMinPoolSpace = 128;\n-const { kMaxLength } = require('buffer');\n \n const isWindows = process.platform === 'win32';\n \n@@ -181,16 +196,16 @@ function isFileType(stats, fileType) {\n \n // Don't allow mode to accidentally be overwritten.\n Object.defineProperties(fs, {\n-  F_OK: { enumerable: true, value: constants.F_OK || 0 },\n-  R_OK: { enumerable: true, value: constants.R_OK || 0 },\n-  W_OK: { enumerable: true, value: constants.W_OK || 0 },\n-  X_OK: { enumerable: true, value: constants.X_OK || 0 },\n+  F_OK: { enumerable: true, value: F_OK || 0 },\n+  R_OK: { enumerable: true, value: R_OK || 0 },\n+  W_OK: { enumerable: true, value: W_OK || 0 },\n+  X_OK: { enumerable: true, value: X_OK || 0 },\n });\n \n fs.access = function(path, mode, callback) {\n   if (typeof mode === 'function') {\n     callback = mode;\n-    mode = fs.F_OK;\n+    mode = F_OK;\n   }\n \n   path = getPathFromURL(path);\n@@ -207,7 +222,7 @@ fs.accessSync = function(path, mode) {\n   validatePath(path);\n \n   if (mode === undefined)\n-    mode = fs.F_OK;\n+    mode = F_OK;\n   else\n     mode = mode | 0;\n \n@@ -224,7 +239,7 @@ fs.exists = function(path, callback) {\n   }\n \n   try {\n-    fs.access(path, fs.FS_OK, suppressedCallback);\n+    fs.access(path, F_OK, suppressedCallback);\n   } catch (err) {\n     return callback(false);\n   }\n@@ -246,7 +261,7 @@ Object.defineProperty(fs.exists, internalUtil.promisify.custom, {\n // TODO(joyeecheung): deprecate the never-throw-on-invalid-arguments behavior\n fs.existsSync = function(path) {\n   try {\n-    fs.accessSync(path, fs.FS_OK);\n+    fs.accessSync(path, F_OK);\n     return true;\n   } catch (e) {\n     return false;\n@@ -1056,10 +1071,10 @@ fs.fchmodSync = function(fd, mode) {\n   handleErrorFromBinding(ctx);\n };\n \n-if (constants.O_SYMLINK !== undefined) {\n+if (O_SYMLINK !== undefined) {\n   fs.lchmod = function(path, mode, callback) {\n     callback = maybeCallback(callback);\n-    fs.open(path, constants.O_WRONLY | constants.O_SYMLINK, function(err, fd) {\n+    fs.open(path, O_WRONLY | O_SYMLINK, function(err, fd) {\n       if (err) {\n         callback(err);\n         return;\n@@ -1075,7 +1090,7 @@ if (constants.O_SYMLINK !== undefined) {\n   };\n \n   fs.lchmodSync = function(path, mode) {\n-    const fd = fs.openSync(path, constants.O_WRONLY | constants.O_SYMLINK);\n+    const fd = fs.openSync(path, O_WRONLY | O_SYMLINK);\n \n     // Prefer to return the chmod error, if one occurs,\n     // but still try to close, and report closing errors if they occur.\n@@ -1111,10 +1126,10 @@ fs.chmodSync = function(path, mode) {\n   handleErrorFromBinding(ctx);\n };\n \n-if (constants.O_SYMLINK !== undefined) {\n+if (O_SYMLINK !== undefined) {\n   fs.lchown = function(path, uid, gid, callback) {\n     callback = maybeCallback(callback);\n-    fs.open(path, constants.O_WRONLY | constants.O_SYMLINK, function(err, fd) {\n+    fs.open(path, O_WRONLY | O_SYMLINK, function(err, fd) {\n       if (err) {\n         callback(err);\n         return;\n@@ -1130,7 +1145,7 @@ if (constants.O_SYMLINK !== undefined) {\n   };\n \n   fs.lchownSync = function(path, uid, gid) {\n-    const fd = fs.openSync(path, constants.O_WRONLY | constants.O_SYMLINK);\n+    const fd = fs.openSync(path, O_WRONLY | O_SYMLINK);\n     let ret;\n     try {\n       ret = fs.fchownSync(fd, uid, gid);\n@@ -1632,7 +1647,7 @@ fs.realpathSync = function realpathSync(p, options) {\n   validatePath(p);\n   p = pathModule.resolve(p);\n \n-  const cache = options[internalFS.realpathCacheKey];\n+  const cache = options[realpathCacheKey];\n   const maybeCachedResult = cache && cache.get(p);\n   if (maybeCachedResult) {\n     return maybeCachedResult;\n@@ -1937,14 +1952,14 @@ fs.mkdtempSync = function(prefix, options) {\n \n // Define copyFile() flags.\n Object.defineProperties(fs.constants, {\n-  COPYFILE_EXCL: { enumerable: true, value: constants.UV_FS_COPYFILE_EXCL },\n+  COPYFILE_EXCL: { enumerable: true, value: UV_FS_COPYFILE_EXCL },\n   COPYFILE_FICLONE: {\n     enumerable: true,\n-    value: constants.UV_FS_COPYFILE_FICLONE\n+    value: UV_FS_COPYFILE_FICLONE\n   },\n   COPYFILE_FICLONE_FORCE: {\n     enumerable: true,\n-    value: constants.UV_FS_COPYFILE_FICLONE_FORCE\n+    value: UV_FS_COPYFILE_FICLONE_FORCE\n   }\n });\n "
        }
    ],
    "stats": {
        "total": 59,
        "additions": 37,
        "deletions": 22
    }
}