{
    "author": "addaleax",
    "message": "build: build addon tests in parallel\n\nUse a JS script to build addons rather than a shell command\nembedded in the Makefile, because parallelizing is hard in sh\nand easy in JS.\n\nPR-URL: https://github.com/nodejs/node/pull/21155\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "cea10baa221e7ed3c5408d526dcec4fb7a6e99fa",
    "files": [
        {
            "sha": "8bfd4e674a452bd25991b30847e5a986c12d41af",
            "filename": "Makefile",
            "status": "modified",
            "additions": 9,
            "deletions": 30,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/cea10baa221e7ed3c5408d526dcec4fb7a6e99fa/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/cea10baa221e7ed3c5408d526dcec4fb7a6e99fa/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=cea10baa221e7ed3c5408d526dcec4fb7a6e99fa",
            "patch": "@@ -315,25 +315,14 @@ ADDONS_BINDING_SOURCES := \\\n # Depends on node-gyp package.json so that build-addons is (re)executed when\n # node-gyp is updated as part of an npm update.\n test/addons/.buildstamp: config.gypi \\\n-\tdeps/npm/node_modules/node-gyp/package.json \\\n+\tdeps/npm/node_modules/node-gyp/package.json tools/build-addons.js \\\n \t$(ADDONS_BINDING_GYPS) $(ADDONS_BINDING_SOURCES) \\\n \tdeps/uv/include/*.h deps/v8/include/*.h \\\n \tsrc/node.h src/node_buffer.h src/node_object_wrap.h src/node_version.h \\\n \ttest/addons/.docbuildstamp\n-#\tCannot use $(wildcard test/addons/*/) here, it's evaluated before\n-#\tembedded addons have been generated from the documentation.\n-#\tIgnore folders without binding.gyp\n-#\t(https://github.com/nodejs/node/issues/14843)\n-\t@for dirname in test/addons/*/; do \\\n-\t\tif [ ! -f \"$$PWD/$${dirname}binding.gyp\" ]; then \\\n-\t\t\tcontinue; fi ; \\\n-\t\tprintf \"\\nBuilding addon $$PWD/$$dirname\\n\" ; \\\n-\t\tenv MAKEFLAGS=\"-j1\" $(NODE) deps/npm/node_modules/node-gyp/bin/node-gyp \\\n-\t\t        --loglevel=$(LOGLEVEL) rebuild \\\n-\t\t\t--python=\"$(PYTHON)\" \\\n-\t\t\t--directory=\"$$PWD/$$dirname\" \\\n-\t\t\t--nodedir=\"$$PWD\" || exit 1 ; \\\n-\tdone\n+\tenv npm_config_loglevel=$(LOGLEVEL) npm_config_nodedir=\"$$PWD\" \\\n+\t\tnpm_config_python=\"$(PYTHON)\" $(NODE) \"$$PWD/tools/build-addons\" \\\n+\t\t\"$$PWD/deps/npm/node_modules/node-gyp/bin/node-gyp.js\" \"$$PWD/test/addons\"\n \ttouch $@\n \n .PHONY: build-addons\n@@ -355,25 +344,15 @@ ADDONS_NAPI_BINDING_SOURCES := \\\n \n # Implicitly depends on $(NODE_EXE), see the build-addons-napi rule for rationale.\n test/addons-napi/.buildstamp: config.gypi \\\n-\tdeps/npm/node_modules/node-gyp/package.json \\\n+\tdeps/npm/node_modules/node-gyp/package.json tools/build-addons.js \\\n \t$(ADDONS_NAPI_BINDING_GYPS) $(ADDONS_NAPI_BINDING_SOURCES) \\\n \tdeps/uv/include/*.h deps/v8/include/*.h \\\n \tsrc/node.h src/node_buffer.h src/node_object_wrap.h src/node_version.h \\\n \tsrc/node_api.h src/node_api_types.h\n-#\tCannot use $(wildcard test/addons-napi/*/) here, it's evaluated before\n-#\tembedded addons have been generated from the documentation.\n-#\tIgnore folders without binding.gyp\n-#\t(https://github.com/nodejs/node/issues/14843)\n-\t@for dirname in test/addons-napi/*/; do \\\n-\t\tif [ ! -f \"$$PWD/$${dirname}binding.gyp\" ]; then \\\n-\t\t\tcontinue; fi ; \\\n-\t\tprintf \"\\nBuilding addon $$PWD/$$dirname\\n\" ; \\\n-\t\tenv MAKEFLAGS=\"-j1\" $(NODE) deps/npm/node_modules/node-gyp/bin/node-gyp \\\n-\t\t        --loglevel=$(LOGLEVEL) rebuild \\\n-\t\t\t--python=\"$(PYTHON)\" \\\n-\t\t\t--directory=\"$$PWD/$$dirname\" \\\n-\t\t\t--nodedir=\"$$PWD\" || exit 1 ; \\\n-\tdone\n+\tenv npm_config_loglevel=$(LOGLEVEL) npm_config_nodedir=\"$$PWD\" \\\n+\t\tnpm_config_python=\"$(PYTHON)\" $(NODE) \"$$PWD/tools/build-addons\" \\\n+\t\t\"$$PWD/deps/npm/node_modules/node-gyp/bin/node-gyp.js\" \\\n+\t\t\"$$PWD/test/addons-napi\"\n \ttouch $@\n \n .PHONY: build-addons-napi"
        },
        {
            "sha": "1d4bcbc917972c57f0a94e9beb59f56883f75483",
            "filename": "tools/build-addons.js",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/cea10baa221e7ed3c5408d526dcec4fb7a6e99fa/tools%2Fbuild-addons.js",
            "raw_url": "https://github.com/nodejs/node/raw/cea10baa221e7ed3c5408d526dcec4fb7a6e99fa/tools%2Fbuild-addons.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fbuild-addons.js?ref=cea10baa221e7ed3c5408d526dcec4fb7a6e99fa",
            "patch": "@@ -0,0 +1,58 @@\n+'use strict';\n+\n+// Usage: e.g. node build-addons.js <path to node-gyp> <directory>\n+\n+const child_process = require('child_process');\n+const path = require('path');\n+const fs = require('fs').promises;\n+const util = require('util');\n+\n+const execFile = util.promisify(child_process.execFile);\n+\n+const parallelization = +process.env.JOBS || require('os').cpus().length;\n+const nodeGyp = process.argv[2];\n+\n+async function runner(directoryQueue) {\n+  if (directoryQueue.length === 0)\n+    return;\n+\n+  const dir = directoryQueue.shift();\n+  const next = () => runner(directoryQueue);\n+\n+  try {\n+    // Only run for directories that have a `binding.gyp`.\n+    // (https://github.com/nodejs/node/issues/14843)\n+    await fs.stat(path.join(dir, 'binding.gyp'));\n+  } catch (err) {\n+    if (err.code === 'ENOENT' || err.code === 'ENOTDIR')\n+      return next();\n+    throw err;\n+  }\n+\n+  console.log(`Building addon in ${dir}`);\n+  const { stdout, stderr } =\n+    await execFile(process.execPath, [nodeGyp, 'rebuild', `--directory=${dir}`],\n+                   {\n+                     stdio: 'inherit',\n+                     env: { ...process.env, MAKEFLAGS: '-j1' }\n+                   });\n+\n+  // We buffer the output and print it out once the process is done in order\n+  // to avoid interleaved output from multiple builds running at once.\n+  process.stdout.write(stdout);\n+  process.stderr.write(stderr);\n+\n+  return next();\n+}\n+\n+async function main(directory) {\n+  const directoryQueue = (await fs.readdir(directory))\n+    .map((subdir) => path.join(directory, subdir));\n+\n+  const runners = [];\n+  for (let i = 0; i < parallelization; ++i)\n+    runners.push(runner(directoryQueue));\n+  return Promise.all(runners);\n+}\n+\n+main(process.argv[3]).catch((err) => setImmediate(() => { throw err; }));"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 67,
        "deletions": 30
    }
}