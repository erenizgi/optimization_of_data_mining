{
    "author": "addaleax",
    "message": "console,util: avoid pair array generation in C++\n\nUse a plain `[key, value, key, value]`-style list instead\nof an array of pairs for inspecting collections.\n\nThis also fixes a bug with `console.table()` where\ninspecting a non-key-value `MapIterator` would have\nled to odd results.\n\nPR-URL: https://github.com/nodejs/node/pull/20831\nRefs: https://github.com/nodejs/node/pull/20719#discussion_r189342513\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "db495896249b29a93d8013b5ee2067ecf87ed081",
    "files": [
        {
            "sha": "92ac64173a17cb19af6b5eda3abe06b79b260d86",
            "filename": "lib/console.js",
            "status": "modified",
            "additions": 19,
            "deletions": 9,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/db495896249b29a93d8013b5ee2067ecf87ed081/lib%2Fconsole.js",
            "raw_url": "https://github.com/nodejs/node/raw/db495896249b29a93d8013b5ee2067ecf87ed081/lib%2Fconsole.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fconsole.js?ref=db495896249b29a93d8013b5ee2067ecf87ed081",
            "patch": "@@ -363,17 +363,27 @@ Console.prototype.table = function(tabularData, properties) {\n   const getIndexArray = (length) => ArrayFrom({ length }, (_, i) => inspect(i));\n \n   const mapIter = isMapIterator(tabularData);\n+  let isKeyValue = false;\n+  let i = 0;\n   if (mapIter)\n-    tabularData = previewEntries(tabularData);\n+    [ tabularData, isKeyValue ] = previewEntries(tabularData);\n \n-  if (mapIter || isMap(tabularData)) {\n+  if (isKeyValue || isMap(tabularData)) {\n     const keys = [];\n     const values = [];\n     let length = 0;\n-    for (const [k, v] of tabularData) {\n-      keys.push(inspect(k));\n-      values.push(inspect(v));\n-      length++;\n+    if (mapIter) {\n+      for (; i < tabularData.length / 2; ++i) {\n+        keys.push(inspect(tabularData[i * 2]));\n+        values.push(inspect(tabularData[i * 2 + 1]));\n+        length++;\n+      }\n+    } else {\n+      for (const [k, v] of tabularData) {\n+        keys.push(inspect(k));\n+        values.push(inspect(v));\n+        length++;\n+      }\n     }\n     return final([\n       iterKey, keyKey, valuesKey\n@@ -386,9 +396,9 @@ Console.prototype.table = function(tabularData, properties) {\n \n   const setIter = isSetIterator(tabularData);\n   if (setIter)\n-    tabularData = previewEntries(tabularData);\n+    [ tabularData ] = previewEntries(tabularData);\n \n-  const setlike = setIter || isSet(tabularData);\n+  const setlike = setIter || (mapIter && !isKeyValue) || isSet(tabularData);\n   if (setlike) {\n     const values = [];\n     let length = 0;\n@@ -407,7 +417,7 @@ Console.prototype.table = function(tabularData, properties) {\n   const valuesKeyArray = [];\n   const indexKeyArray = ObjectKeys(tabularData);\n \n-  for (var i = 0; i < indexKeyArray.length; i++) {\n+  for (; i < indexKeyArray.length; i++) {\n     const item = tabularData[indexKeyArray[i]];\n     const primitive = item === null ||\n         (typeof item !== 'function' && typeof item !== 'object');"
        },
        {
            "sha": "5413cc0a337abd5148cd9d86d71fe7c7c3125cec",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 20,
            "deletions": 8,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/db495896249b29a93d8013b5ee2067ecf87ed081/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/db495896249b29a93d8013b5ee2067ecf87ed081/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=db495896249b29a93d8013b5ee2067ecf87ed081",
            "patch": "@@ -981,7 +981,7 @@ function formatMap(ctx, value, recurseTimes, keys) {\n \n function formatWeakSet(ctx, value, recurseTimes, keys) {\n   const maxArrayLength = Math.max(ctx.maxArrayLength, 0);\n-  const entries = previewEntries(value).slice(0, maxArrayLength + 1);\n+  const [ entries ] = previewEntries(value).slice(0, maxArrayLength + 1);\n   const maxLength = Math.min(maxArrayLength, entries.length);\n   let output = new Array(maxLength);\n   for (var i = 0; i < maxLength; ++i)\n@@ -998,14 +998,16 @@ function formatWeakSet(ctx, value, recurseTimes, keys) {\n \n function formatWeakMap(ctx, value, recurseTimes, keys) {\n   const maxArrayLength = Math.max(ctx.maxArrayLength, 0);\n-  const entries = previewEntries(value).slice(0, maxArrayLength + 1);\n-  const remainder = entries.length > maxArrayLength;\n-  const len = entries.length - (remainder ? 1 : 0);\n+  const [ entries ] = previewEntries(value).slice(0, (maxArrayLength + 1) * 2);\n+  // Entries exist as [key1, val1, key2, val2, ...]\n+  const remainder = entries.length / 2 > maxArrayLength;\n+  const len = entries.length / 2 - (remainder ? 1 : 0);\n   const maxLength = Math.min(maxArrayLength, len);\n   let output = new Array(maxLength);\n-  for (var i = 0; i < len; i++) {\n-    output[i] = `${formatValue(ctx, entries[i][0], recurseTimes)} => ` +\n-      formatValue(ctx, entries[i][1], recurseTimes);\n+  for (var i = 0; i < maxLength; i++) {\n+    const pos = i * 2;\n+    output[i] = `${formatValue(ctx, entries[pos], recurseTimes)} => ` +\n+      formatValue(ctx, entries[pos + 1], recurseTimes);\n   }\n   // Sort all entries to have a halfway reliable output (if more entries than\n   // retrieved ones exist, we can not reliably return the same output).\n@@ -1017,9 +1019,19 @@ function formatWeakMap(ctx, value, recurseTimes, keys) {\n   return output;\n }\n \n+function zip2(list) {\n+  const ret = Array(list.length / 2);\n+  for (var i = 0; i < ret.length; ++i)\n+    ret[i] = [list[2 * i], list[2 * i + 1]];\n+  return ret;\n+}\n+\n function formatCollectionIterator(ctx, value, recurseTimes, keys) {\n   const output = [];\n-  for (const entry of previewEntries(value)) {\n+  var [ entries, isKeyValue ] = previewEntries(value);\n+  if (isKeyValue)\n+    entries = zip2(entries);\n+  for (const entry of entries) {\n     if (ctx.maxArrayLength === output.length) {\n       output.push('... more items');\n       break;"
        },
        {
            "sha": "ef7dc8a818bf11d3c00ebb93f562494a8bccd342",
            "filename": "src/node_util.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 19,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/db495896249b29a93d8013b5ee2067ecf87ed081/src%2Fnode_util.cc",
            "raw_url": "https://github.com/nodejs/node/raw/db495896249b29a93d8013b5ee2067ecf87ed081/src%2Fnode_util.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_util.cc?ref=db495896249b29a93d8013b5ee2067ecf87ed081",
            "patch": "@@ -53,29 +53,16 @@ static void PreviewEntries(const FunctionCallbackInfo<Value>& args) {\n   if (!args[0]->IsObject())\n     return;\n \n+  Environment* env = Environment::GetCurrent(args);\n   bool is_key_value;\n   Local<Array> entries;\n   if (!args[0].As<Object>()->PreviewEntries(&is_key_value).ToLocal(&entries))\n     return;\n-  if (!is_key_value)\n-    return args.GetReturnValue().Set(entries);\n-\n-  uint32_t length = entries->Length();\n-  CHECK_EQ(length % 2, 0);\n-\n-  Environment* env = Environment::GetCurrent(args);\n-  Local<Context> context = env->context();\n-\n-  Local<Array> pairs = Array::New(env->isolate(), length / 2);\n-  for (uint32_t i = 0; i < length / 2; i++) {\n-    Local<Array> pair = Array::New(env->isolate(), 2);\n-    pair->Set(context, 0, entries->Get(context, i * 2).ToLocalChecked())\n-        .FromJust();\n-    pair->Set(context, 1, entries->Get(context, i * 2 + 1).ToLocalChecked())\n-        .FromJust();\n-    pairs->Set(context, i, pair).FromJust();\n-  }\n-  args.GetReturnValue().Set(pairs);\n+  Local<Array> ret = Array::New(env->isolate(), 2);\n+  ret->Set(env->context(), 0, entries).FromJust();\n+  ret->Set(env->context(), 1, v8::Boolean::New(env->isolate(), is_key_value))\n+      .FromJust();\n+  return args.GetReturnValue().Set(ret);\n }\n \n // Side effect-free stringification that will never throw exceptions."
        },
        {
            "sha": "844d2e01e4180b0c939995f7d567061bbd80e414",
            "filename": "test/parallel/test-console-table.js",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/db495896249b29a93d8013b5ee2067ecf87ed081/test%2Fparallel%2Ftest-console-table.js",
            "raw_url": "https://github.com/nodejs/node/raw/db495896249b29a93d8013b5ee2067ecf87ed081/test%2Fparallel%2Ftest-console-table.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-console-table.js?ref=db495896249b29a93d8013b5ee2067ecf87ed081",
            "patch": "@@ -120,6 +120,26 @@ test(new Map([[1, 1], [2, 2], [3, 3]]).entries(), `\n └───────────────────┴─────┴────────┘\n `);\n \n+test(new Map([[1, 1], [2, 2], [3, 3]]).values(), `\n+┌───────────────────┬────────┐\n+│ (iteration index) │ Values │\n+├───────────────────┼────────┤\n+│         0         │   1    │\n+│         1         │   2    │\n+│         2         │   3    │\n+└───────────────────┴────────┘\n+`);\n+\n+test(new Map([[1, 1], [2, 2], [3, 3]]).keys(), `\n+┌───────────────────┬────────┐\n+│ (iteration index) │ Values │\n+├───────────────────┼────────┤\n+│         0         │   1    │\n+│         1         │   2    │\n+│         2         │   3    │\n+└───────────────────┴────────┘\n+`);\n+\n test(new Set([1, 2, 3]).values(), `\n ┌───────────────────┬────────┐\n │ (iteration index) │ Values │"
        },
        {
            "sha": "f97ab95cdea52437e1c8322acb8d6e28adbcc392",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/db495896249b29a93d8013b5ee2067ecf87ed081/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/db495896249b29a93d8013b5ee2067ecf87ed081/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=db495896249b29a93d8013b5ee2067ecf87ed081",
            "patch": "@@ -447,13 +447,13 @@ assert.strictEqual(util.inspect(-5e-324), '-5e-324');\n {\n   const map = new Map();\n   map.set(1, 2);\n-  const vals = previewEntries(map.entries());\n+  const [ vals ] = previewEntries(map.entries());\n   const valsOutput = [];\n   for (const o of vals) {\n     valsOutput.push(o);\n   }\n \n-  assert.strictEqual(util.inspect(valsOutput), '[ [ 1, 2 ] ]');\n+  assert.strictEqual(util.inspect(valsOutput), '[ 1, 2 ]');\n }\n \n // Test for other constructors in different context."
        }
    ],
    "stats": {
        "total": 105,
        "additions": 67,
        "deletions": 38
    }
}