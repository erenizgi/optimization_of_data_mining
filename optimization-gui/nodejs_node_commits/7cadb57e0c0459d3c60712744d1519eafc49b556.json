{
    "author": "addaleax",
    "message": "src: refactor setting JS properties on WriteWrap\n\n`async` and `bytes` are only interesting when the write\nis coming from JS, and unnecessary otherwise.\n\nAlso, make all of the stream `Write*()` bindings use the same\ncode for setting these, and upgrade to the non-deprecated versions.\n\nPR-URL: https://github.com/nodejs/node/pull/18963\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "7cadb57e0c0459d3c60712744d1519eafc49b556",
    "files": [
        {
            "sha": "81adf7a866b927a164eb71b5b1093fa6f26a7067",
            "filename": "src/stream_base-inl.h",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/7cadb57e0c0459d3c60712744d1519eafc49b556/src%2Fstream_base-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/7cadb57e0c0459d3c60712744d1519eafc49b556/src%2Fstream_base-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base-inl.h?ref=7cadb57e0c0459d3c60712744d1519eafc49b556",
            "patch": "@@ -220,8 +220,6 @@ inline StreamWriteResult StreamBase::Write(\n     ClearError();\n   }\n \n-  req_wrap_obj->Set(env->async(), v8::Boolean::New(env->isolate(), async));\n-\n   return StreamWriteResult { async, err, req_wrap };\n }\n "
        },
        {
            "sha": "1d1d324841537f03e6c72dead4ac4564f00db601",
            "filename": "src/stream_base.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 8,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/7cadb57e0c0459d3c60712744d1519eafc49b556/src%2Fstream_base.cc",
            "raw_url": "https://github.com/nodejs/node/raw/7cadb57e0c0459d3c60712744d1519eafc49b556/src%2Fstream_base.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.cc?ref=7cadb57e0c0459d3c60712744d1519eafc49b556",
            "patch": "@@ -14,6 +14,7 @@\n namespace node {\n \n using v8::Array;\n+using v8::Boolean;\n using v8::Context;\n using v8::FunctionCallbackInfo;\n using v8::HandleScope;\n@@ -56,6 +57,20 @@ int StreamBase::Shutdown(const FunctionCallbackInfo<Value>& args) {\n   return Shutdown(req_wrap_obj);\n }\n \n+inline void SetWriteResultPropertiesOnWrapObject(\n+    Environment* env,\n+    Local<Object> req_wrap_obj,\n+    const StreamWriteResult& res,\n+    size_t bytes) {\n+  req_wrap_obj->Set(\n+      env->context(),\n+      env->bytes_string(),\n+      Number::New(env->isolate(), bytes)).FromJust();\n+  req_wrap_obj->Set(\n+      env->context(),\n+      env->async(),\n+      Boolean::New(env->isolate(), res.async)).FromJust();\n+}\n \n int StreamBase::Writev(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n@@ -150,7 +165,7 @@ int StreamBase::Writev(const FunctionCallbackInfo<Value>& args) {\n   }\n \n   StreamWriteResult res = Write(*bufs, count, nullptr, req_wrap_obj);\n-  req_wrap_obj->Set(env->bytes_string(), Number::New(env->isolate(), bytes));\n+  SetWriteResultPropertiesOnWrapObject(env, req_wrap_obj, res, bytes);\n   if (res.wrap != nullptr && storage) {\n     res.wrap->SetAllocatedStorage(storage.release(), storage_size);\n   }\n@@ -178,9 +193,7 @@ int StreamBase::WriteBuffer(const FunctionCallbackInfo<Value>& args) {\n \n   if (res.async)\n     req_wrap_obj->Set(env->context(), env->buffer_string(), args[1]).FromJust();\n-  req_wrap_obj->Set(env->context(), env->bytes_string(),\n-                    Integer::NewFromUnsigned(env->isolate(), buf.len))\n-      .FromJust();\n+  SetWriteResultPropertiesOnWrapObject(env, req_wrap_obj, res, buf.len);\n \n   return res.err;\n }\n@@ -286,10 +299,7 @@ int StreamBase::WriteString(const FunctionCallbackInfo<Value>& args) {\n \n   StreamWriteResult res = Write(&buf, 1, send_handle, req_wrap_obj);\n \n-  req_wrap_obj->Set(env->context(), env->bytes_string(),\n-                    Integer::NewFromUnsigned(env->isolate(), data_size))\n-      .FromJust();\n-\n+  SetWriteResultPropertiesOnWrapObject(env, req_wrap_obj, res, data_size);\n   if (res.wrap != nullptr) {\n     res.wrap->SetAllocatedStorage(data.release(), data_size);\n   }"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 18,
        "deletions": 10
    }
}