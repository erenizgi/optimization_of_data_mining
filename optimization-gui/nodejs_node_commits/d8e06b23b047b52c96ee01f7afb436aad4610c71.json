{
    "author": "Trott",
    "message": "test: fix flaky VM timeout test on Raspberry Pi\n\nIncrease the timeouts based on platform. This required adjusting\ncommon.platformTimeout() to deal with bigint.\n\nFixes: https://github.com/nodejs/node/issues/24120\n\nPR-URL: https://github.com/nodejs/node/pull/24238\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "d8e06b23b047b52c96ee01f7afb436aad4610c71",
    "files": [
        {
            "sha": "f0bcced82e61490c3f7baf0ca499a853c32831b5",
            "filename": "test/common/README.md",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/d8e06b23b047b52c96ee01f7afb436aad4610c71/test%2Fcommon%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/d8e06b23b047b52c96ee01f7afb436aad4610c71/test%2Fcommon%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2FREADME.md?ref=d8e06b23b047b52c96ee01f7afb436aad4610c71",
            "patch": "@@ -271,10 +271,12 @@ See `common.expectWarning()` for usage.\n Indicates whether 'opensslCli' is supported.\n \n ### platformTimeout(ms)\n-* `ms` [&lt;number>]\n-* return [&lt;number>]\n+* `ms` [&lt;number>|&lt;bigint>]\n+* return [&lt;number>|&lt;bigint>]\n \n-Platform normalizes timeout.\n+Returns a timeout value based on detected conditions. For example, a debug build\n+may need extra time so the returned value will be larger than on a release\n+build.\n \n ### PIPE\n * [&lt;string>]"
        },
        {
            "sha": "7b668e58c48eaddf7a0674be50c3bff402298591",
            "filename": "test/common/index.js",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/d8e06b23b047b52c96ee01f7afb436aad4610c71/test%2Fcommon%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/d8e06b23b047b52c96ee01f7afb436aad4610c71/test%2Fcommon%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Findex.js?ref=d8e06b23b047b52c96ee01f7afb436aad4610c71",
            "patch": "@@ -187,25 +187,31 @@ const pwdCommand = isWindows ?\n \n \n function platformTimeout(ms) {\n+  // ESLint will not support 'bigint' in valid-typeof until it reaches stage 4.\n+  // See https://github.com/eslint/eslint/pull/9636.\n+  // eslint-disable-next-line valid-typeof\n+  const multipliers = typeof ms === 'bigint' ?\n+    { two: 2n, four: 4n, seven: 7n } : { two: 2, four: 4, seven: 7 };\n+\n   if (process.features.debug)\n-    ms = 2 * ms;\n+    ms = multipliers.two * ms;\n \n   if (global.__coverage__)\n-    ms = 4 * ms;\n+    ms = multipliers.four * ms;\n \n   if (isAIX)\n-    return 2 * ms; // default localhost speed is slower on AIX\n+    return multipliers.two * ms; // default localhost speed is slower on AIX\n \n   if (process.arch !== 'arm')\n     return ms;\n \n   const armv = process.config.variables.arm_version;\n \n   if (armv === '6')\n-    return 7 * ms;  // ARMv6\n+    return multipliers.seven * ms;  // ARMv6\n \n   if (armv === '7')\n-    return 2 * ms;  // ARMv7\n+    return multipliers.two * ms;  // ARMv7\n \n   return ms; // ARMv8+\n }"
        },
        {
            "sha": "2a5514920b27bbf4228afcac75c4c8f2373d896f",
            "filename": "test/known_issues/known_issues.status",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/d8e06b23b047b52c96ee01f7afb436aad4610c71/test%2Fknown_issues%2Fknown_issues.status",
            "raw_url": "https://github.com/nodejs/node/raw/d8e06b23b047b52c96ee01f7afb436aad4610c71/test%2Fknown_issues%2Fknown_issues.status",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fknown_issues%2Fknown_issues.status?ref=d8e06b23b047b52c96ee01f7afb436aad4610c71",
            "patch": "@@ -9,7 +9,6 @@ prefix known_issues\n [$system==win32]\n \n [$system==linux]\n-test-vm-timeout-escape-nexttick: PASS,FLAKY\n test-vm-timeout-escape-promise: PASS,FLAKY\n test-vm-timeout-escape-queuemicrotask: PASS,FLAKY\n "
        },
        {
            "sha": "814da178fb2f78ca820d3b175e4a01e09c265cfa",
            "filename": "test/known_issues/test-vm-timeout-escape-nexttick.js",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/d8e06b23b047b52c96ee01f7afb436aad4610c71/test%2Fknown_issues%2Ftest-vm-timeout-escape-nexttick.js",
            "raw_url": "https://github.com/nodejs/node/raw/d8e06b23b047b52c96ee01f7afb436aad4610c71/test%2Fknown_issues%2Ftest-vm-timeout-escape-nexttick.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fknown_issues%2Ftest-vm-timeout-escape-nexttick.js?ref=d8e06b23b047b52c96ee01f7afb436aad4610c71",
            "patch": "@@ -4,7 +4,7 @@\n // Promises, nextTick, and queueMicrotask allow code to escape the timeout\n // set for runInContext, runInNewContext, and runInThisContext\n \n-require('../common');\n+const common = require('../common');\n const assert = require('assert');\n const vm = require('vm');\n \n@@ -13,12 +13,14 @@ const NS_PER_MS = 1000000n;\n const hrtime = process.hrtime.bigint;\n const nextTick = process.nextTick;\n \n+const waitDuration = common.platformTimeout(100n);\n+\n function loop() {\n   const start = hrtime();\n   while (1) {\n     const current = hrtime();\n     const span = (current - start) / NS_PER_MS;\n-    if (span >= 100n) {\n+    if (span >= waitDuration) {\n       throw new Error(\n         `escaped timeout at ${span} milliseconds!`);\n     }\n@@ -33,9 +35,8 @@ assert.throws(() => {\n       nextTick,\n       loop\n     },\n-    { timeout: 5 }\n+    { timeout: common.platformTimeout(5) }\n   );\n }, {\n-  code: 'ERR_SCRIPT_EXECUTION_TIMEOUT',\n-  message: 'Script execution timed out after 5ms'\n+  code: 'ERR_SCRIPT_EXECUTION_TIMEOUT'\n });"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 22,
        "deletions": 14
    }
}