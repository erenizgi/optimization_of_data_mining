{
    "author": "yhwang",
    "message": "build: fix coverage build\n\nAfter adding the node_lib target in node.gyp, most of the node source\nfiles are moved to that target. When coverage option is enabled,\ncorresponding cflags and ldflags are needed in that target as well.\ngcovr also needs to check .gcda data for both node and node_lib.\n\nPR-URL: https://github.com/nodejs/node/pull/18409\nFixes: https://github.com/nodejs/node/issues/18402\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "a89d215b79cc1aa300e25be13aa2489a2322f1ad",
    "files": [
        {
            "sha": "6ccce30085b1a930cefea12c04a2fd8eeebb9d3a",
            "filename": "Makefile",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/a89d215b79cc1aa300e25be13aa2489a2322f1ad/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/a89d215b79cc1aa300e25be13aa2489a2322f1ad/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=a89d215b79cc1aa300e25be13aa2489a2322f1ad",
            "patch": "@@ -191,6 +191,9 @@ coverage-test: coverage-build\n \t$(RM) out/$(BUILDTYPE)/obj.target/node/gen/*.gcda\n \t$(RM) out/$(BUILDTYPE)/obj.target/node/src/*.gcda\n \t$(RM) out/$(BUILDTYPE)/obj.target/node/src/tracing/*.gcda\n+\t$(RM) out/$(BUILDTYPE)/obj.target/node_lib/gen/*.gcda\n+\t$(RM) out/$(BUILDTYPE)/obj.target/node_lib/src/*.gcda\n+\t$(RM) out/$(BUILDTYPE)/obj.target/node_lib/src/tracing/*.gcda\n \t-$(MAKE) $(COVTESTS)\n \tmv lib lib__\n \tmv lib_ lib\n@@ -201,7 +204,7 @@ coverage-test: coverage-build\n \t\t--temp-directory \"$(CURDIR)/.cov_tmp\" \\\n \t\t--report-dir \"../coverage\")\n \t-(cd out && \"../gcovr/scripts/gcovr\" --gcov-exclude='.*deps' \\\n-\t\t--gcov-exclude='.*usr' -v -r Release/obj.target/node \\\n+\t\t--gcov-exclude='.*usr' -v -r Release/obj.target \\\n \t\t--html --html-detail -o ../coverage/cxxcoverage.html \\\n \t\t--gcov-executable=\"$(GCOV)\")\n \tmv lib lib_"
        },
        {
            "sha": "d01004ce8cc449b0d8036bf2140ca897a482902f",
            "filename": "node.gypi",
            "status": "modified",
            "additions": 6,
            "deletions": 11,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/a89d215b79cc1aa300e25be13aa2489a2322f1ad/node.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/a89d215b79cc1aa300e25be13aa2489a2322f1ad/node.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gypi?ref=a89d215b79cc1aa300e25be13aa2489a2322f1ad",
            "patch": "@@ -184,25 +184,20 @@\n       ],\n     }],\n     [ '(OS==\"freebsd\" or OS==\"linux\") and node_shared==\"false\"'\n-        ' and coverage==\"false\" and force_load==\"true\"', {\n+        ' and force_load==\"true\"', {\n       'ldflags': [ '-Wl,-z,noexecstack',\n                    '-Wl,--whole-archive <(v8_base)',\n                    '-Wl,--no-whole-archive' ]\n     }],\n-    [ '(OS==\"freebsd\" or OS==\"linux\") and node_shared==\"false\"'\n-        ' and coverage==\"true\" and force_load==\"true\"', {\n-      'ldflags': [ '-Wl,-z,noexecstack',\n-                   '-Wl,--whole-archive <(v8_base)',\n-                   '-Wl,--no-whole-archive',\n-                   '--coverage',\n+    [ 'OS in \"mac freebsd linux\" and node_shared==\"false\"'\n+        ' and coverage==\"true\"', {\n+      'ldflags': [ '--coverage',\n                    '-g',\n                    '-O0' ],\n-       'cflags': [ '--coverage',\n+      'cflags': [ '--coverage',\n                    '-g',\n                    '-O0' ],\n-       'cflags!': [ '-O3' ]\n-    }],\n-    [ 'OS==\"mac\" and node_shared==\"false\" and coverage==\"true\"', {\n+      'cflags!': [ '-O3' ],\n       'xcode_settings': {\n         'OTHER_LDFLAGS': [\n           '--coverage',"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 10,
        "deletions": 12
    }
}