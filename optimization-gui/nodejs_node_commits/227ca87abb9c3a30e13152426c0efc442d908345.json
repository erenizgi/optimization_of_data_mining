{
    "author": "unknown",
    "message": "test: add test for Linux perf\n\nThis commit adds a test to validate if Linux perf is working correctly\non Node.js. The test is marked as flaky because its intention is to let\nus know when changes on V8 potentially broke Linux perf, so we can fix\nit before a new version of V8 lands on Node.js master.\n\nPR-URL: https://github.com/nodejs/node/pull/20783\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "227ca87abb9c3a30e13152426c0efc442d908345",
    "files": [
        {
            "sha": "011ef19777bd3777c81c401561779b6f44f7f5a6",
            "filename": "test/fixtures/linux-perf.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/227ca87abb9c3a30e13152426c0efc442d908345/test%2Ffixtures%2Flinux-perf.js",
            "raw_url": "https://github.com/nodejs/node/raw/227ca87abb9c3a30e13152426c0efc442d908345/test%2Ffixtures%2Flinux-perf.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Flinux-perf.js?ref=227ca87abb9c3a30e13152426c0efc442d908345",
            "patch": "@@ -0,0 +1,26 @@\n+'use strict';\n+\n+const crypto = require('crypto');\n+\n+// Functions should be complex enough for V8 to run them a few times before\n+// compiling, but not complex enough to always stay in interpreted mode. They\n+// should also take some time to run, otherwise Linux perf might miss them\n+// entirely even when sampling at a high frequency.\n+function functionOne(i) {\n+  for (let j=i; j > 0; j--) {\n+    crypto.createHash('md5').update(functionTwo(i, j)).digest(\"hex\");\n+  }\n+}\n+\n+function functionTwo(x, y) {\n+  let data = ((((x * y) + (x / y)) * y) ** (x + 1)).toString();\n+  if (x % 2 == 0) {\n+    return crypto.createHash('md5').update(data.repeat((x % 100) + 1)).digest(\"hex\");\n+  } else {\n+    return crypto.createHash('md5').update(data.repeat((y % 100) + 1)).digest(\"hex\");\n+  }\n+}\n+\n+for (let i = 0; i < 1000; i++) {\n+  functionOne(i);\n+}"
        },
        {
            "sha": "0a7f199e040d5883429eac3631e02579a3da19bc",
            "filename": "test/v8-updates/test-linux-perf.js",
            "status": "added",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/nodejs/node/blob/227ca87abb9c3a30e13152426c0efc442d908345/test%2Fv8-updates%2Ftest-linux-perf.js",
            "raw_url": "https://github.com/nodejs/node/raw/227ca87abb9c3a30e13152426c0efc442d908345/test%2Fv8-updates%2Ftest-linux-perf.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fv8-updates%2Ftest-linux-perf.js?ref=227ca87abb9c3a30e13152426c0efc442d908345",
            "patch": "@@ -0,0 +1,81 @@\n+'use strict';\n+\n+// This test verifies that JavaScript functions are being correctly sampled by\n+// Linux perf. The test runs a JavaScript script, sampling the execution with\n+// Linux perf. It then uses `perf script` to generate a human-readable output,\n+// and uses regular expressions to find samples of the functions defined in\n+// `fixtures/linux-perf.js`.\n+\n+// NOTE (mmarchini): this test is meant to run only on Linux machines with Linux\n+// perf installed. It will skip if those criteria are not met.\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+\n+const assert = require('assert');\n+const { spawnSync } = require('child_process');\n+const fixtures = require('../common/fixtures');\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+if (process.config.variables.node_shared)\n+  common.skip(\"can't test Linux perf with shared libraries yet\");\n+\n+const perfArgs = [\n+  'record',\n+  '-F500',\n+  '-g',\n+  '--',\n+  process.execPath,\n+  '--perf-basic-prof',\n+  '--interpreted-frames-native-stack',\n+  '--no-turbo-inlining',  // Otherwise simple functions might get inlined.\n+  fixtures.path('linux-perf.js'),\n+];\n+\n+const perfScriptArgs = [\n+  'script',\n+];\n+\n+const options = {\n+  cwd: tmpdir.path,\n+  encoding: 'utf-8',\n+};\n+\n+if (!common.isLinux)\n+  common.skip('only testing Linux for now');\n+\n+const perf = spawnSync('perf', perfArgs, options);\n+\n+if (perf.error && perf.error.errno === 'ENOENT')\n+  common.skip('perf not found on system');\n+\n+if (perf.status !== 0) {\n+  common.skip(`Failed to execute perf: ${perf.stderr}`);\n+}\n+\n+const perfScript = spawnSync('perf', perfScriptArgs, options);\n+\n+if (perf.error)\n+  common.skip(`perf script aborted: ${perf.error.errno}`);\n+\n+if (perfScript.status !== 0) {\n+  common.skip(`Failed to execute perf script: ${perfScript.stderr}`);\n+}\n+\n+const interpretedFunctionOneRe = /InterpretedFunction:functionOne/;\n+const compiledFunctionOneRe = /LazyCompile:\\*functionOne/;\n+const interpretedFunctionTwoRe = /InterpretedFunction:functionTwo/;\n+const compiledFunctionTwoRe = /LazyCompile:\\*functionTwo/;\n+\n+const output = perfScript.stdout;\n+\n+assert.ok(output.match(interpretedFunctionOneRe),\n+          \"Couldn't find interpreted functionOne()\");\n+assert.ok(output.match(compiledFunctionOneRe),\n+          \"Couldn't find compiled functionOne()\");\n+assert.ok(output.match(interpretedFunctionTwoRe),\n+          \"Couldn't find interpreted functionTwo()\");\n+assert.ok(output.match(compiledFunctionTwoRe),\n+          \"Couldn't find compiled functionTwo\");"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 107,
        "deletions": 0
    }
}