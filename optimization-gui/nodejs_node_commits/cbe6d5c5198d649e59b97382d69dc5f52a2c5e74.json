{
    "author": "addaleax",
    "message": "doc: warn against concurrent http2stream.respondWithFD\n\nUpcoming changes to move away from synchronous I/O on the main\nthread will imply that using the same file descriptor to\nrespond on multiple HTTP/2 streams at the same time is invalid,\nbecause at least on Windows `uv_fs_read()` is race-y.\n\nTherefore, warn against such usage.\n\nPR-URL: https://github.com/nodejs/node/pull/18762\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "cbe6d5c5198d649e59b97382d69dc5f52a2c5e74",
    "files": [
        {
            "sha": "66cf7aafa0ff485d04806e6d6f1321b99821c1cc",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/cbe6d5c5198d649e59b97382d69dc5f52a2c5e74/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/cbe6d5c5198d649e59b97382d69dc5f52a2c5e74/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=cbe6d5c5198d649e59b97382d69dc5f52a2c5e74",
            "patch": "@@ -1257,19 +1257,19 @@ automatically.\n const http2 = require('http2');\n const fs = require('fs');\n \n-const fd = fs.openSync('/some/file', 'r');\n-\n const server = http2.createServer();\n server.on('stream', (stream) => {\n+  const fd = fs.openSync('/some/file', 'r');\n+\n   const stat = fs.fstatSync(fd);\n   const headers = {\n     'content-length': stat.size,\n     'last-modified': stat.mtime.toUTCString(),\n     'content-type': 'text/plain'\n   };\n   stream.respondWithFD(fd, headers);\n+  stream.on('close', () => fs.closeSync(fd));\n });\n-server.on('close', () => fs.closeSync(fd));\n ```\n \n The optional `options.statCheck` function may be specified to give user code\n@@ -1282,6 +1282,12 @@ The `offset` and `length` options may be used to limit the response to a\n specific range subset. This can be used, for instance, to support HTTP Range\n requests.\n \n+The file descriptor is not closed when the stream is closed, so it will need\n+to be closed manually once it is no longer needed.\n+Note that using the same file descriptor concurrently for multiple streams\n+is not supported and may result in data loss. Re-using a file descriptor\n+after a stream has finished is supported.\n+\n When set, the `options.getTrailers()` function is called immediately after\n queuing the last chunk of payload data to be sent. The callback is passed a\n single object (with a `null` prototype) that the listener may use to specify\n@@ -1291,10 +1297,10 @@ the trailing header fields to send to the peer.\n const http2 = require('http2');\n const fs = require('fs');\n \n-const fd = fs.openSync('/some/file', 'r');\n-\n const server = http2.createServer();\n server.on('stream', (stream) => {\n+  const fd = fs.openSync('/some/file', 'r');\n+\n   const stat = fs.fstatSync(fd);\n   const headers = {\n     'content-length': stat.size,\n@@ -1306,8 +1312,9 @@ server.on('stream', (stream) => {\n       trailers.ABC = 'some value to send';\n     }\n   });\n+\n+  stream.on('close', () => fs.closeSync(fd));\n });\n-server.on('close', () => fs.closeSync(fd));\n ```\n \n The HTTP/1 specification forbids trailers from containing HTTP/2 pseudo-header"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 13,
        "deletions": 6
    }
}