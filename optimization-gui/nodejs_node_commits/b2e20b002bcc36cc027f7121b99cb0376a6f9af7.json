{
    "author": "joyeecheung",
    "message": "fs: extract binding error handling into a helper\n\nPR-URL: https://github.com/nodejs/node/pull/18642\nReviewed-By: Jon Moss <me@jonathanmoss.me>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>",
    "sha": "b2e20b002bcc36cc027f7121b99cb0376a6f9af7",
    "files": [
        {
            "sha": "6129e3c3ef35a0c740425f6148e637e9552a06d7",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 32,
            "deletions": 60,
            "changes": 92,
            "blob_url": "https://github.com/nodejs/node/blob/b2e20b002bcc36cc027f7121b99cb0376a6f9af7/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/b2e20b002bcc36cc027f7121b99cb0376a6f9af7/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=b2e20b002bcc36cc027f7121b99cb0376a6f9af7",
            "patch": "@@ -108,6 +108,20 @@ function copyObject(source) {\n   return target;\n }\n \n+function handleErrorFromBinding(ctx) {\n+  if (ctx.errno !== undefined) {  // libuv error numbers\n+    const err = errors.uvException(ctx);\n+    Error.captureStackTrace(err, handleErrorFromBinding);\n+    throw err;\n+  } else if (ctx.error !== undefined) {  // errors created in C++ land.\n+    // TODO(joyeecheung): currently, ctx.error are encoding errors\n+    // usually caused by memory problems. We need to figure out proper error\n+    // code(s) for this.\n+    Error.captureStackTrace(ctx.error, handleErrorFromBinding);\n+    throw ctx.error;\n+  }\n+}\n+\n // TODO(joyeecheung): explore how the deprecation could be solved via linting\n // rules. See https://github.com/nodejs/node/pull/12976\n function rethrow() {\n@@ -405,10 +419,7 @@ fs.accessSync = function(path, mode) {\n \n   const ctx = { path };\n   binding.access(pathModule.toNamespacedPath(path), mode, undefined, ctx);\n-\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n };\n \n // fs.exists never throws even when the arguments are invalid - if there is\n@@ -742,9 +753,7 @@ fs.closeSync = function(fd) {\n \n   const ctx = {};\n   binding.close(fd, undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n };\n \n function modeNum(m, def) {\n@@ -924,9 +933,7 @@ fs.renameSync = function(oldPath, newPath) {\n   const ctx = { path: oldPath, dest: newPath };\n   binding.rename(pathModule.toNamespacedPath(oldPath),\n                  pathModule.toNamespacedPath(newPath), undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n };\n \n fs.truncate = function(path, len, callback) {\n@@ -994,9 +1001,7 @@ fs.ftruncateSync = function(fd, len = 0) {\n   len = Math.max(0, len);\n   const ctx = {};\n   binding.ftruncate(fd, len, undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n };\n \n fs.rmdir = function(path, callback) {\n@@ -1025,9 +1030,7 @@ fs.fdatasyncSync = function(fd) {\n   validateUint32(fd, 'fd');\n   const ctx = {};\n   binding.fdatasync(fd, undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n };\n \n fs.fsync = function(fd, callback) {\n@@ -1041,9 +1044,7 @@ fs.fsyncSync = function(fd) {\n   validateUint32(fd, 'fd');\n   const ctx = {};\n   binding.fsync(fd, undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n };\n \n fs.mkdir = function(path, mode, callback) {\n@@ -1114,9 +1115,7 @@ fs.fstatSync = function(fd) {\n   validateUint32(fd, 'fd');\n   const ctx = { fd };\n   binding.fstat(fd, undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n   return statsFromValues();\n };\n \n@@ -1125,9 +1124,7 @@ fs.lstatSync = function(path) {\n   validatePath(path);\n   const ctx = { path };\n   binding.lstat(pathModule.toNamespacedPath(path), undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n   return statsFromValues();\n };\n \n@@ -1136,9 +1133,7 @@ fs.statSync = function(path) {\n   validatePath(path);\n   const ctx = { path };\n   binding.stat(pathModule.toNamespacedPath(path), undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n   return statsFromValues();\n };\n \n@@ -1159,14 +1154,7 @@ fs.readlinkSync = function(path, options) {\n   const ctx = { path };\n   const result = binding.readlink(pathModule.toNamespacedPath(path),\n                                   options.encoding, undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  } else if (ctx.error) {\n-    // TODO(joyeecheung): this is an encoding error usually caused by memory\n-    // problems. We need to figure out proper error code(s) for this.\n-    Error.captureStackTrace(ctx.error);\n-    throw ctx.error;\n-  }\n+  handleErrorFromBinding(ctx);\n   return result;\n };\n \n@@ -1235,9 +1223,7 @@ fs.symlinkSync = function(target, path, type) {\n   binding.symlink(preprocessSymlinkDestination(target, type, path),\n                   pathModule.toNamespacedPath(path), flags, undefined, ctx);\n \n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n };\n \n fs.link = function(existingPath, newPath, callback) {\n@@ -1266,9 +1252,7 @@ fs.linkSync = function(existingPath, newPath) {\n   const result = binding.link(pathModule.toNamespacedPath(existingPath),\n                               pathModule.toNamespacedPath(newPath),\n                               undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n   return result;\n };\n \n@@ -1286,9 +1270,7 @@ fs.unlinkSync = function(path) {\n   validatePath(path);\n   const ctx = { path };\n   binding.unlink(pathModule.toNamespacedPath(path), undefined, ctx);\n-  if (ctx.errno !== undefined) {\n-    throw errors.uvException(ctx);\n-  }\n+  handleErrorFromBinding(ctx);\n };\n \n fs.fchmod = function(fd, mode, callback) {\n@@ -1887,9 +1869,7 @@ fs.realpathSync = function realpathSync(p, options) {\n   if (isWindows && !knownHard[base]) {\n     const ctx = { path: base };\n     binding.lstat(pathModule.toNamespacedPath(base), undefined, ctx);\n-    if (ctx.errno !== undefined) {\n-      throw errors.uvException(ctx);\n-    }\n+    handleErrorFromBinding(ctx);\n     knownHard[base] = true;\n   }\n \n@@ -1931,9 +1911,7 @@ fs.realpathSync = function realpathSync(p, options) {\n       var baseLong = pathModule.toNamespacedPath(base);\n       const ctx = { path: base };\n       binding.lstat(baseLong, undefined, ctx);\n-      if (ctx.errno !== undefined) {\n-        throw errors.uvException(ctx);\n-      }\n+      handleErrorFromBinding(ctx);\n \n       if ((statValues[1/*mode*/] & S_IFMT) !== S_IFLNK) {\n         knownHard[base] = true;\n@@ -1956,13 +1934,9 @@ fs.realpathSync = function realpathSync(p, options) {\n       if (linkTarget === null) {\n         const ctx = { path: base };\n         binding.stat(baseLong, undefined, ctx);\n-        if (ctx.errno !== undefined) {\n-          throw errors.uvException(ctx);\n-        }\n+        handleErrorFromBinding(ctx);\n         linkTarget = binding.readlink(baseLong, undefined, undefined, ctx);\n-        if (ctx.errno !== undefined) {\n-          throw errors.uvException(ctx);\n-        }\n+        handleErrorFromBinding(ctx);\n       }\n       resolvedLink = pathModule.resolve(previous, linkTarget);\n \n@@ -1981,9 +1955,7 @@ fs.realpathSync = function realpathSync(p, options) {\n     if (isWindows && !knownHard[base]) {\n       const ctx = { path: base };\n       binding.lstat(pathModule.toNamespacedPath(base), undefined, ctx);\n-      if (ctx.errno !== undefined) {\n-        throw errors.uvException(ctx);\n-      }\n+      handleErrorFromBinding(ctx);\n       knownHard[base] = true;\n     }\n   }"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 32,
        "deletions": 60
    }
}