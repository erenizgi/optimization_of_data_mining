{
    "author": "BridgeAR",
    "message": "assert: validate the block return type\n\nThis makes sure the returned value when calling `block` is actually\nof type promise in case `assert.rejects` or `assert.doesNotReject`\nis called.\n\nPR-URL: https://github.com/nodejs/node/pull/19886\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Vse Mozhet Byt <vsemozhetbyt@gmail.com>",
    "sha": "7007eee6a272398054c65f2f32bdf3467a29ee9f",
    "files": [
        {
            "sha": "62c96801d34ffdc1dcc9388bf38aae08c5ed5a7e",
            "filename": "doc/api/assert.md",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/7007eee6a272398054c65f2f32bdf3467a29ee9f/doc%2Fapi%2Fassert.md",
            "raw_url": "https://github.com/nodejs/node/raw/7007eee6a272398054c65f2f32bdf3467a29ee9f/doc%2Fapi%2Fassert.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fassert.md?ref=7007eee6a272398054c65f2f32bdf3467a29ee9f",
            "patch": "@@ -387,8 +387,10 @@ function and awaits the returned promise to complete. It will then check that\n the promise is not rejected.\n \n If `block` is a function and it throws an error synchronously,\n-`assert.doesNotReject()` will return a rejected Promise with that error without\n-checking the error handler.\n+`assert.doesNotReject()` will return a rejected Promise with that error. If the\n+function does not return a promise, `assert.doesNotReject()` will return a\n+rejected Promise with an [`ERR_INVALID_RETURN_VALUE`][] error. In both cases the\n+error handler is skipped.\n \n Please note: Using `assert.doesNotReject()` is actually not useful because there\n is little benefit by catching a rejection and then rejecting it again. Instead,\n@@ -929,8 +931,10 @@ function and awaits the returned promise to complete. It will then check that\n the promise is rejected.\n \n If `block` is a function and it throws an error synchronously,\n-`assert.rejects()` will return a rejected Promise with that error without\n-checking the error handler.\n+`assert.rejects()` will return a rejected Promise with that error. If the\n+function does not return a promise, `assert.rejects()` will return a rejected\n+Promise with an [`ERR_INVALID_RETURN_VALUE`][] error. In both cases the error\n+handler is skipped.\n \n Besides the async nature to await the completion behaves identically to\n [`assert.throws()`][].\n@@ -1138,6 +1142,7 @@ assert.throws(throwingFirst, /Second$/);\n Due to the confusing notation, it is recommended not to use a string as the\n second argument. This might lead to difficult-to-spot errors.\n \n+[`ERR_INVALID_RETURN_VALUE`]: errors.html#errors_err_invalid_return_value\n [`Class`]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes\n [`Error.captureStackTrace`]: errors.html#errors_error_capturestacktrace_targetobject_constructoropt\n [`Error`]: errors.html#errors_class_error"
        },
        {
            "sha": "df81718e7d7fb07c513ad20c5101aa16ef36adee",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/7007eee6a272398054c65f2f32bdf3467a29ee9f/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/7007eee6a272398054c65f2f32bdf3467a29ee9f/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=7007eee6a272398054c65f2f32bdf3467a29ee9f",
            "patch": "@@ -1186,6 +1186,12 @@ An invalid `options.protocol` was passed.\n Both `breakEvalOnSigint` and `eval` options were set in the REPL config, which\n is not supported.\n \n+<a id=\"ERR_INVALID_RETURN_VALUE\"></a>\n+### ERR_INVALID_RETURN_VALUE\n+\n+Thrown in case a function option does not return an expected value on execution.\n+For example when a function is expected to return a promise.\n+\n <a id=\"ERR_INVALID_SYNC_FORK_INPUT\"></a>\n ### ERR_INVALID_SYNC_FORK_INPUT\n "
        },
        {
            "sha": "05b43b5b54d0743dfb949337dca7ce4179e94688",
            "filename": "lib/assert.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/7007eee6a272398054c65f2f32bdf3467a29ee9f/lib%2Fassert.js",
            "raw_url": "https://github.com/nodejs/node/raw/7007eee6a272398054c65f2f32bdf3467a29ee9f/lib%2Fassert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fassert.js?ref=7007eee6a272398054c65f2f32bdf3467a29ee9f",
            "patch": "@@ -30,7 +30,8 @@ const {\n   errorCache,\n   codes: {\n     ERR_AMBIGUOUS_ARGUMENT,\n-    ERR_INVALID_ARG_TYPE\n+    ERR_INVALID_ARG_TYPE,\n+    ERR_INVALID_RETURN_VALUE\n   }\n } = require('internal/errors');\n const { openSync, closeSync, readSync } = require('fs');\n@@ -455,6 +456,11 @@ async function waitForActual(block) {\n   if (typeof block === 'function') {\n     // Return a rejected promise if `block` throws synchronously.\n     resultPromise = block();\n+    // Fail in case no promise is returned.\n+    if (!checkIsPromise(resultPromise)) {\n+      throw new ERR_INVALID_RETURN_VALUE('instance of Promise',\n+                                         'block', resultPromise);\n+    }\n   } else if (checkIsPromise(block)) {\n     resultPromise = block;\n   } else {"
        },
        {
            "sha": "88c7f86eb91df3cc2757f6d6758445b465c4e848",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/7007eee6a272398054c65f2f32bdf3467a29ee9f/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/7007eee6a272398054c65f2f32bdf3467a29ee9f/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=7007eee6a272398054c65f2f32bdf3467a29ee9f",
            "patch": "@@ -904,6 +904,16 @@ E('ERR_INVALID_PROTOCOL',\n   TypeError);\n E('ERR_INVALID_REPL_EVAL_CONFIG',\n   'Cannot specify both \"breakEvalOnSigint\" and \"eval\" for REPL', TypeError);\n+E('ERR_INVALID_RETURN_VALUE', (input, name, value) => {\n+  let type;\n+  if (value && value.constructor && value.constructor.name) {\n+    type = `instance of ${value.constructor.name}`;\n+  } else {\n+    type = `type ${typeof value}`;\n+  }\n+  return `Expected ${input} to be returned from the \"${name}\"` +\n+          ` function but got ${type}.`;\n+}, TypeError);\n E('ERR_INVALID_SYNC_FORK_INPUT',\n   'Asynchronous forks do not support Buffer, Uint8Array or string input: %s',\n   TypeError);"
        },
        {
            "sha": "4b3664e0cbdf15f7ecff7d3b31cbca3178722048",
            "filename": "test/parallel/test-assert-async.js",
            "status": "modified",
            "additions": 24,
            "deletions": 13,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/7007eee6a272398054c65f2f32bdf3467a29ee9f/test%2Fparallel%2Ftest-assert-async.js",
            "raw_url": "https://github.com/nodejs/node/raw/7007eee6a272398054c65f2f32bdf3467a29ee9f/test%2Fparallel%2Ftest-assert-async.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert-async.js?ref=7007eee6a272398054c65f2f32bdf3467a29ee9f",
            "patch": "@@ -29,20 +29,25 @@ const promises = [];\n            `${err.name} is not instance of AssertionError`);\n     assert.strictEqual(err.code, 'ERR_ASSERTION');\n     assert.strictEqual(err.message,\n-                       'Missing expected rejection (handler).');\n+                       'Missing expected rejection (mustNotCall).');\n     assert.strictEqual(err.operator, 'rejects');\n     assert.ok(!err.stack.includes('at Function.rejects'));\n     return true;\n   };\n \n-  let promise = assert.rejects(async () => {}, handler);\n-  promises.push(assert.rejects(promise, handler));\n+  let promise = assert.rejects(async () => {}, common.mustNotCall());\n+  promises.push(assert.rejects(promise, common.mustCall(handler)));\n \n-  promise = assert.rejects(() => {}, handler);\n-  promises.push(assert.rejects(promise, handler));\n+  promise = assert.rejects(() => {}, common.mustNotCall());\n+  promises.push(assert.rejects(promise, {\n+    name: 'TypeError [ERR_INVALID_RETURN_VALUE]',\n+    code: 'ERR_INVALID_RETURN_VALUE',\n+    message: 'Expected instance of Promise to be returned ' +\n+             'from the \"block\" function but got type undefined.'\n+  }));\n \n-  promise = assert.rejects(Promise.resolve(), handler);\n-  promises.push(assert.rejects(promise, handler));\n+  promise = assert.rejects(Promise.resolve(), common.mustNotCall());\n+  promises.push(assert.rejects(promise, common.mustCall(handler)));\n }\n \n {\n@@ -67,7 +72,13 @@ promises.push(assert.rejects(\n // Check `assert.doesNotReject`.\n {\n   // `assert.doesNotReject` accepts a function or a promise as first argument.\n-  promises.push(assert.doesNotReject(() => {}));\n+  const promise = assert.doesNotReject(() => new Map(), common.mustNotCall());\n+  promises.push(assert.rejects(promise, {\n+    message: 'Expected instance of Promise to be returned ' +\n+             'from the \"block\" function but got instance of Map.',\n+    code: 'ERR_INVALID_RETURN_VALUE',\n+    name: 'TypeError [ERR_INVALID_RETURN_VALUE]'\n+  }));\n   promises.push(assert.doesNotReject(async () => {}));\n   promises.push(assert.doesNotReject(Promise.resolve()));\n }\n@@ -93,14 +104,14 @@ promises.push(assert.rejects(\n \n   const rejectingFn = async () => assert.fail();\n \n-  let promise = assert.doesNotReject(rejectingFn, handler1);\n-  promises.push(assert.rejects(promise, handler2));\n+  let promise = assert.doesNotReject(rejectingFn, common.mustCall(handler1));\n+  promises.push(assert.rejects(promise, common.mustCall(handler2)));\n \n-  promise = assert.doesNotReject(rejectingFn(), handler1);\n-  promises.push(assert.rejects(promise, handler2));\n+  promise = assert.doesNotReject(rejectingFn(), common.mustCall(handler1));\n+  promises.push(assert.rejects(promise, common.mustCall(handler2)));\n \n   promise = assert.doesNotReject(() => assert.fail(), common.mustNotCall());\n-  promises.push(assert.rejects(promise, handler1));\n+  promises.push(assert.rejects(promise, common.mustCall(handler1)));\n }\n \n promises.push(assert.rejects("
        }
    ],
    "stats": {
        "total": 74,
        "additions": 56,
        "deletions": 18
    }
}