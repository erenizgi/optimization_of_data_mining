{
    "author": "jasnell",
    "message": "trace_events: add node.promises category, rejection counter\n\nAllow the trace event log to include a count of unhandled rejections\nand handled after rejections. This is useful primarily as a quick\ncheck to see if rejections may be going unhandled (and unnoticed\nin a process).\n\nPR-URL: https://github.com/nodejs/node/pull/22124\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "080316b32a0e6320e012214c32725099a0248de6",
    "files": [
        {
            "sha": "e067760643a1eaffc465d95dc0f6fa4911d93cf0",
            "filename": "doc/api/tracing.md",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/080316b32a0e6320e012214c32725099a0248de6/doc%2Fapi%2Ftracing.md",
            "raw_url": "https://github.com/nodejs/node/raw/080316b32a0e6320e012214c32725099a0248de6/doc%2Fapi%2Ftracing.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftracing.md?ref=080316b32a0e6320e012214c32725099a0248de6",
            "patch": "@@ -18,12 +18,14 @@ The available categories are:\n   The [`async_hooks`] events have a unique `asyncId` and a special `triggerId`\n   `triggerAsyncId` property.\n * `node.bootstrap` - Enables capture of Node.js bootstrap milestones.\n+* `node.fs.sync` - Enables capture of trace data for file system sync methods.\n * `node.perf` - Enables capture of [Performance API] measurements.\n   * `node.perf.usertiming` - Enables capture of only Performance API User Timing\n     measures and marks.\n   * `node.perf.timerify` - Enables capture of only Performance API timerify\n     measurements.\n-* `node.fs.sync` - Enables capture of trace data for file system sync methods.\n+* `node.promises.rejections` - Enables capture of trace data tracking the number\n+  of unhandled Promise rejections and handled-after-rejections.\n * `node.vm.script` - Enables capture of trace data for the `vm` module's\n   `runInNewContext()`, `runInContext()`, and `runInThisContext()` methods.\n * `v8` - The [V8] events are GC, compiling, and execution related."
        },
        {
            "sha": "94bb9413772dd09c4a35b76eb62835b3ed00c65b",
            "filename": "src/bootstrapper.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/080316b32a0e6320e012214c32725099a0248de6/src%2Fbootstrapper.cc",
            "raw_url": "https://github.com/nodejs/node/raw/080316b32a0e6320e012214c32725099a0248de6/src%2Fbootstrapper.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbootstrapper.cc?ref=080316b32a0e6320e012214c32725099a0248de6",
            "patch": "@@ -3,6 +3,8 @@\n #include \"node_internals.h\"\n #include \"v8.h\"\n \n+#include <atomic>\n+\n namespace node {\n \n using v8::Array;\n@@ -51,6 +53,9 @@ void SetupNextTick(const FunctionCallbackInfo<Value>& args) {\n }\n \n void PromiseRejectCallback(PromiseRejectMessage message) {\n+  static std::atomic<uint64_t> unhandledRejections{0};\n+  static std::atomic<uint64_t> rejectionsHandledAfter{0};\n+\n   Local<Promise> promise = message.GetPromise();\n   Isolate* isolate = promise->GetIsolate();\n   PromiseRejectEvent event = message.GetEvent();\n@@ -65,13 +70,23 @@ void PromiseRejectCallback(PromiseRejectMessage message) {\n \n     if (value.IsEmpty())\n       value = Undefined(isolate);\n+\n+    unhandledRejections++;\n   } else if (event == v8::kPromiseHandlerAddedAfterReject) {\n     callback = env->promise_reject_handled_function();\n     value = Undefined(isolate);\n+\n+    rejectionsHandledAfter++;\n   } else {\n     return;\n   }\n \n+  TRACE_COUNTER2(TRACING_CATEGORY_NODE2(promises, rejections),\n+                 \"rejections\",\n+                 \"unhandled\", unhandledRejections,\n+                 \"handledAfter\", rejectionsHandledAfter);\n+\n+\n   Local<Value> args[] = { promise, value };\n   MaybeLocal<Value> ret = callback->Call(env->context(),\n                                          Undefined(isolate),"
        },
        {
            "sha": "69d35f25ecb3bb4c3be3ea96841984d6cd439ff8",
            "filename": "test/parallel/test-trace-event-promises.js",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/nodejs/node/blob/080316b32a0e6320e012214c32725099a0248de6/test%2Fparallel%2Ftest-trace-event-promises.js",
            "raw_url": "https://github.com/nodejs/node/raw/080316b32a0e6320e012214c32725099a0248de6/test%2Fparallel%2Ftest-trace-event-promises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-event-promises.js?ref=080316b32a0e6320e012214c32725099a0248de6",
            "patch": "@@ -0,0 +1,48 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const cp = require('child_process');\n+const path = require('path');\n+const fs = require('fs');\n+const tmpdir = require('../common/tmpdir');\n+\n+common.disableCrashOnUnhandledRejection();\n+\n+if (!common.isMainThread)\n+  common.skip('process.chdir is not available in Workers');\n+\n+if (process.argv[2] === 'child') {\n+  const p = Promise.reject(1);  // Handled later\n+  Promise.reject(2);  // Unhandled\n+  setImmediate(() => {\n+    p.catch(() => { /* intentional noop */ });\n+  });\n+} else {\n+  tmpdir.refresh();\n+  process.chdir(tmpdir.path);\n+\n+  const proc = cp.fork(__filename,\n+                       [ 'child' ], {\n+                         execArgv: [\n+                           '--no-warnings',\n+                           '--trace-event-categories',\n+                           'node.promises.rejections'\n+                         ]\n+                       });\n+\n+  proc.once('exit', common.mustCall(() => {\n+    const file = path.join(tmpdir.path, 'node_trace.1.log');\n+\n+    assert(common.fileExists(file));\n+    fs.readFile(file, common.mustCall((err, data) => {\n+      const traces = JSON.parse(data.toString()).traceEvents\n+        .filter((trace) => trace.cat !== '__metadata');\n+      traces.forEach((trace) => {\n+        assert.strictEqual(trace.pid, proc.pid);\n+        assert.strictEqual(trace.name, 'rejections');\n+        assert(trace.args.unhandled <= 2);\n+        assert(trace.args.handledAfter <= 1);\n+      });\n+    }));\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 66,
        "deletions": 1
    }
}