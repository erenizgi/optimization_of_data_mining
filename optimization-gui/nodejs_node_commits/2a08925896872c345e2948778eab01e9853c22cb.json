{
    "author": "addaleax",
    "message": "n-api: name CallbackBundle function fields\n\nUse field names rather than indices.\n\nRefs: https://github.com/nodejs/node/pull/21072\n\nPR-URL: https://github.com/nodejs/node/pull/21240\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "2a08925896872c345e2948778eab01e9853c22cb",
    "files": [
        {
            "sha": "b1b498958b85df704266946e245deec11e693979",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 18,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/2a08925896872c345e2948778eab01e9853c22cb/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2a08925896872c345e2948778eab01e9853c22cb/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=2a08925896872c345e2948778eab01e9853c22cb",
            "patch": "@@ -476,15 +476,6 @@ class TryCatch : public v8::TryCatch {\n \n //=== Function napi_callback wrapper =================================\n \n-// TODO(somebody): these constants can be removed with relevant changes\n-// in CallbackWrapperBase<> and CallbackBundle.\n-// Leave them for now just to keep the change set and cognitive load minimal.\n-static const int kFunctionIndex = 0;  // Used in CallbackBundle::cb[]\n-static const int kGetterIndex = 0;    // Used in CallbackBundle::cb[]\n-static const int kSetterIndex = 1;    // Used in CallbackBundle::cb[]\n-static const int kCallbackCount = 2;  // Used in CallbackBundle::cb[]\n-                                      // Max is \"getter + setter\" case\n-\n // Use this data structure to associate callback data with each N-API function\n // exposed to JavaScript. The structure is stored in a v8::External which gets\n // passed into our callback wrapper. This reduces the performance impact of\n@@ -501,7 +492,8 @@ struct CallbackBundle {\n \n   napi_env       env;      // Necessary to invoke C++ NAPI callback\n   void*          cb_data;  // The user provided callback data\n-  napi_callback  cb[kCallbackCount];   // Max capacity is 2 (getter + setter)\n+  napi_callback  function_or_getter;\n+  napi_callback  setter;\n   node::Persistent<v8::Value> handle;  // Die with this JavaScript object\n \n  private:\n@@ -539,7 +531,7 @@ class CallbackWrapper {\n   void* _data;\n };\n \n-template <typename Info, int kInternalFieldIndex>\n+template <typename Info, napi_callback CallbackBundle::*FunctionField>\n class CallbackWrapperBase : public CallbackWrapper {\n  public:\n   CallbackWrapperBase(const Info& cbinfo, const size_t args_length)\n@@ -561,7 +553,7 @@ class CallbackWrapperBase : public CallbackWrapper {\n \n     // All other pointers we need are stored in `_bundle`\n     napi_env env = _bundle->env;\n-    napi_callback cb = _bundle->cb[kInternalFieldIndex];\n+    napi_callback cb = _bundle->*FunctionField;\n \n     napi_value result;\n     NAPI_CALL_INTO_MODULE_THROW(env, result = cb(env, cbinfo_wrapper));\n@@ -577,7 +569,7 @@ class CallbackWrapperBase : public CallbackWrapper {\n \n class FunctionCallbackWrapper\n     : public CallbackWrapperBase<v8::FunctionCallbackInfo<v8::Value>,\n-                                 kFunctionIndex> {\n+                                 &CallbackBundle::function_or_getter> {\n  public:\n   static void Invoke(const v8::FunctionCallbackInfo<v8::Value>& info) {\n     FunctionCallbackWrapper cbwrapper(info);\n@@ -623,7 +615,7 @@ class FunctionCallbackWrapper\n \n class GetterCallbackWrapper\n     : public CallbackWrapperBase<v8::PropertyCallbackInfo<v8::Value>,\n-                                 kGetterIndex> {\n+                                 &CallbackBundle::function_or_getter> {\n  public:\n   static void Invoke(v8::Local<v8::Name> property,\n                      const v8::PropertyCallbackInfo<v8::Value>& info) {\n@@ -654,7 +646,8 @@ class GetterCallbackWrapper\n };\n \n class SetterCallbackWrapper\n-    : public CallbackWrapperBase<v8::PropertyCallbackInfo<void>, kSetterIndex> {\n+    : public CallbackWrapperBase<v8::PropertyCallbackInfo<void>,\n+                                 &CallbackBundle::setter> {\n  public:\n   static void Invoke(v8::Local<v8::Name> property,\n                      v8::Local<v8::Value> value,\n@@ -698,7 +691,7 @@ v8::Local<v8::Value> CreateFunctionCallbackData(napi_env env,\n                                                 napi_callback cb,\n                                                 void* data) {\n   CallbackBundle* bundle = new CallbackBundle();\n-  bundle->cb[kFunctionIndex] = cb;\n+  bundle->function_or_getter = cb;\n   bundle->cb_data = data;\n   bundle->env = env;\n   v8::Local<v8::Value> cbdata = v8::External::New(env->isolate, bundle);\n@@ -716,8 +709,8 @@ v8::Local<v8::Value> CreateAccessorCallbackData(napi_env env,\n                                                 napi_callback setter,\n                                                 void* data) {\n   CallbackBundle* bundle = new CallbackBundle();\n-  bundle->cb[kGetterIndex] = getter;\n-  bundle->cb[kSetterIndex] = setter;\n+  bundle->function_or_getter = getter;\n+  bundle->setter = setter;\n   bundle->cb_data = data;\n   bundle->env = env;\n   v8::Local<v8::Value> cbdata = v8::External::New(env->isolate, bundle);"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 11,
        "deletions": 18
    }
}