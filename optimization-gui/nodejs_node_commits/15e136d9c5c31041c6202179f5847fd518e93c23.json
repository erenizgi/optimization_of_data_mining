{
    "author": "apapirovski",
    "message": "test: fix http-agent-destroyed-socket cb not firing\n\nA whole part of the test-http-agent-destroyed-socket test\nwas not running as the semantics of http events changed\nslightly and were no longer triggering the expected event.\nInstead listen to the same event on the socket to verify\nthat the code being tested is still working as expected.\n\nPR-URL: https://github.com/nodejs/node/pull/20006\nFixes: https://github.com/nodejs/node/issues/8613\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "15e136d9c5c31041c6202179f5847fd518e93c23",
    "files": [
        {
            "sha": "af63a676f62fd9295dd6f75334d49712196969e1",
            "filename": "test/parallel/test-http-agent-destroyed-socket.js",
            "status": "modified",
            "additions": 2,
            "deletions": 15,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/15e136d9c5c31041c6202179f5847fd518e93c23/test%2Fparallel%2Ftest-http-agent-destroyed-socket.js",
            "raw_url": "https://github.com/nodejs/node/raw/15e136d9c5c31041c6202179f5847fd518e93c23/test%2Fparallel%2Ftest-http-agent-destroyed-socket.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-agent-destroyed-socket.js?ref=15e136d9c5c31041c6202179f5847fd518e93c23",
            "patch": "@@ -44,24 +44,11 @@ const server = http.createServer(common.mustCall((req, res) => {\n     // assert request2 is queued in the agent\n     const key = agent.getName(requestOptions);\n     assert.strictEqual(agent.requests[key].length, 1);\n-    request1.socket.on('close', common.mustCall());\n     response.resume();\n     response.on('end', common.mustCall(() => {\n-      //\n-      // THE IMPORTANT PART\n-      //\n-      // It is possible for the socket to get destroyed and other work\n-      // to run before the 'close' event fires because it happens on\n-      // nextTick. This example is contrived because it destroys the\n-      // socket manually at just the right time, but at Voxer we have\n-      // seen cases where the socket is destroyed by non-user code\n-      // then handed out again by an agent *before* the 'close' event\n-      // is triggered.\n       request1.socket.destroy();\n \n-      // TODO(jasnell): This close event does not appear to be triggered.\n-      // is it necessary?\n-      response.once('close', () => {\n+      response.socket.once('close', common.mustCall(() => {\n         // assert request2 was removed from the queue\n         assert(!agent.requests[key]);\n         process.nextTick(() => {\n@@ -70,7 +57,7 @@ const server = http.createServer(common.mustCall((req, res) => {\n           assert.notStrictEqual(request1.socket, request2.socket);\n           assert(!request2.socket.destroyed, 'the socket is destroyed');\n         });\n-      });\n+      }));\n     }));\n   }));\n "
        }
    ],
    "stats": {
        "total": 17,
        "additions": 2,
        "deletions": 15
    }
}