{
    "author": "jasnell",
    "message": "src: handle exceptions in env->SetImmediates\n\nPR-URL: https://github.com/nodejs/node/pull/18297\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "df3402995cfdb40da8f997b2f7c627aef41474a2",
    "files": [
        {
            "sha": "2b8ad7248a3ff08a41eb4c2f6f4bb0cbcbfde39f",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/df3402995cfdb40da8f997b2f7c627aef41474a2/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/df3402995cfdb40da8f997b2f7c627aef41474a2/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=df3402995cfdb40da8f997b2f7c627aef41474a2",
            "patch": "@@ -290,13 +290,26 @@ void Environment::RunAndClearNativeImmediates() {\n     size_t ref_count = 0;\n     std::vector<NativeImmediateCallback> list;\n     native_immediate_callbacks_.swap(list);\n-    for (const auto& cb : list) {\n-      cb.cb_(this, cb.data_);\n-      if (cb.keep_alive_)\n-        cb.keep_alive_->Reset();\n-      if (cb.refed_)\n-        ref_count++;\n-    }\n+    auto drain_list = [&]() {\n+      v8::TryCatch try_catch(isolate());\n+      for (auto it = list.begin(); it != list.end(); ++it) {\n+        it->cb_(this, it->data_);\n+        if (it->keep_alive_)\n+          it->keep_alive_->Reset();\n+        if (it->refed_)\n+          ref_count++;\n+        if (UNLIKELY(try_catch.HasCaught())) {\n+          FatalException(isolate(), try_catch);\n+          // Bail out, remove the already executed callbacks from list\n+          // and set up a new TryCatch for the other pending callbacks.\n+          std::move_backward(it, list.end(), list.begin() + (list.end() - it));\n+          list.resize(list.end() - it);\n+          return true;\n+        }\n+      }\n+      return false;\n+    };\n+    while (drain_list()) {}\n \n #ifdef DEBUG\n     CHECK_GE(immediate_info()->count(), count);"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 20,
        "deletions": 7
    }
}