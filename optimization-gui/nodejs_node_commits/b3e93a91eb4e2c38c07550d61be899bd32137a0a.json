{
    "author": "BridgeAR",
    "message": "util: do not escape single quotes if not necessary\n\nRight now util.inspect will always escape single quotes. That is not\nnecessary though in case the string that will be escaped does not\ncontain double quotes. In that case the string can simply be wrapped\nin double quotes instead.\nIf the string contains single and double quotes and it does not\ncontain `${` as part of the string, backticks will be used instead.\nThat makes sure only very few strings have to escape quotes at all.\nThus it increases the readability of these strings.\n\nPR-URL: https://github.com/nodejs/node/pull/21624\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "b3e93a91eb4e2c38c07550d61be899bd32137a0a",
    "files": [
        {
            "sha": "c56b8429f47350ec1b65541b3708c705e7e7b9c5",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 44,
            "deletions": 6,
            "changes": 50,
            "blob_url": "https://github.com/nodejs/node/blob/b3e93a91eb4e2c38c07550d61be899bd32137a0a/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/b3e93a91eb4e2c38c07550d61be899bd32137a0a/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=b3e93a91eb4e2c38c07550d61be899bd32137a0a",
            "patch": "@@ -90,6 +90,9 @@ let internalDeepEqual;\n /* eslint-disable no-control-regex */\n const strEscapeSequencesRegExp = /[\\x00-\\x1f\\x27\\x5c]/;\n const strEscapeSequencesReplacer = /[\\x00-\\x1f\\x27\\x5c]/g;\n+const strEscapeSequencesRegExpSingle = /[\\x00-\\x1f\\x5c]/;\n+const strEscapeSequencesReplacerSingle = /[\\x00-\\x1f\\x5c]/g;\n+\n /* eslint-enable no-control-regex */\n \n const keyStrRegExp = /^[a-zA-Z_][a-zA-Z_0-9]*$/;\n@@ -116,21 +119,56 @@ const meta = [\n   '', '', '', '', '', '', '', '\\\\\\\\'\n ];\n \n+function addQuotes(str, quotes) {\n+  if (quotes === -1) {\n+    return `\"${str}\"`;\n+  }\n+  if (quotes === -2) {\n+    return `\\`${str}\\``;\n+  }\n+  return `'${str}'`;\n+}\n+\n const escapeFn = (str) => meta[str.charCodeAt(0)];\n \n // Escape control characters, single quotes and the backslash.\n // This is similar to JSON stringify escaping.\n function strEscape(str) {\n+  let escapeTest = strEscapeSequencesRegExp;\n+  let escapeReplace = strEscapeSequencesReplacer;\n+  let singleQuote = 39;\n+\n+  // Check for double quotes. If not present, do not escape single quotes and\n+  // instead wrap the text in double quotes. If double quotes exist, check for\n+  // backticks. If they do not exist, use those as fallback instead of the\n+  // double quotes.\n+  if (str.indexOf(\"'\") !== -1) {\n+    // This invalidates the charCode and therefore can not be matched for\n+    // anymore.\n+    if (str.indexOf('\"') === -1) {\n+      singleQuote = -1;\n+    } else if (str.indexOf('`') === -1 && str.indexOf('${') === -1) {\n+      singleQuote = -2;\n+    }\n+    if (singleQuote !== 39) {\n+      escapeTest = strEscapeSequencesRegExpSingle;\n+      escapeReplace = strEscapeSequencesReplacerSingle;\n+    }\n+  }\n+\n   // Some magic numbers that worked out fine while benchmarking with v8 6.0\n-  if (str.length < 5000 && !strEscapeSequencesRegExp.test(str))\n-    return `'${str}'`;\n-  if (str.length > 100)\n-    return `'${str.replace(strEscapeSequencesReplacer, escapeFn)}'`;\n+  if (str.length < 5000 && !escapeTest.test(str))\n+    return addQuotes(str, singleQuote);\n+  if (str.length > 100) {\n+    str = str.replace(escapeReplace, escapeFn);\n+    return addQuotes(str, singleQuote);\n+  }\n+\n   let result = '';\n   let last = 0;\n   for (var i = 0; i < str.length; i++) {\n     const point = str.charCodeAt(i);\n-    if (point === 39 || point === 92 || point < 32) {\n+    if (point === singleQuote || point === 92 || point < 32) {\n       if (last === i) {\n         result += meta[point];\n       } else {\n@@ -144,7 +182,7 @@ function strEscape(str) {\n   } else if (last !== i) {\n     result += str.slice(last);\n   }\n-  return `'${result}'`;\n+  return addQuotes(result, singleQuote);\n }\n \n function tryStringify(arg) {"
        },
        {
            "sha": "f484f57945a16b1f7129590adbd8764f72452589",
            "filename": "test/parallel/test-repl-colors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b3e93a91eb4e2c38c07550d61be899bd32137a0a/test%2Fparallel%2Ftest-repl-colors.js",
            "raw_url": "https://github.com/nodejs/node/raw/b3e93a91eb4e2c38c07550d61be899bd32137a0a/test%2Fparallel%2Ftest-repl-colors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-colors.js?ref=b3e93a91eb4e2c38c07550d61be899bd32137a0a",
            "patch": "@@ -24,7 +24,7 @@ process.on('exit', function() {\n   // https://github.com/nodejs/node/pull/16485#issuecomment-350428638\n   // The color setting of the REPL should not have leaked over into\n   // the color setting of `util.inspect.defaultOptions`.\n-  strictEqual(output.includes(`'\\\\'string\\\\''`), true);\n+  strictEqual(output.includes(`\"'string'\"`), true);\n   strictEqual(output.includes(`'\\u001b[32m\\\\'string\\\\'\\u001b[39m'`), false);\n   strictEqual(inspect.defaultOptions.colors, false);\n   strictEqual(repl.writer.options.colors, true);"
        },
        {
            "sha": "e0dceb60f794a9f2cf53975b1bc51c4356de506e",
            "filename": "test/parallel/test-util-inspect.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/b3e93a91eb4e2c38c07550d61be899bd32137a0a/test%2Fparallel%2Ftest-util-inspect.js",
            "raw_url": "https://github.com/nodejs/node/raw/b3e93a91eb4e2c38c07550d61be899bd32137a0a/test%2Fparallel%2Ftest-util-inspect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-util-inspect.js?ref=b3e93a91eb4e2c38c07550d61be899bd32137a0a",
            "patch": "@@ -47,7 +47,7 @@ assert.strictEqual(util.inspect(new Date('')), (new Date('')).toString());\n assert.strictEqual(util.inspect('\\n\\u0001'), \"'\\\\n\\\\u0001'\");\n assert.strictEqual(\n   util.inspect(`${Array(75).fill(1)}'\\n\\u001d\\n\\u0003`),\n-  `'${Array(75).fill(1)}\\\\'\\\\n\\\\u001d\\\\n\\\\u0003'`\n+  `\"${Array(75).fill(1)}'\\\\n\\\\u001d\\\\n\\\\u0003\"`\n );\n assert.strictEqual(util.inspect([]), '[]');\n assert.strictEqual(util.inspect(Object.create([])), 'Array {}');\n@@ -1424,3 +1424,9 @@ util.inspect(process);\n   assert(longList.includes('[Object: Inspection interrupted ' +\n     'prematurely. Maximum call stack size exceeded.]'));\n }\n+\n+// Do not escape single quotes if no double quote or backtick is present.\n+assert.strictEqual(util.inspect(\"'\"), '\"\\'\"');\n+assert.strictEqual(util.inspect('\"\\''), '`\"\\'`');\n+// eslint-disable-next-line no-template-curly-in-string\n+assert.strictEqual(util.inspect('\"\\'${a}'), \"'\\\"\\\\'${a}'\");"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 52,
        "deletions": 8
    }
}