{
    "author": "BridgeAR",
    "message": "test: harden test-gc-http-client\n\nThis reduces the total number of requests from 500 to 300 and triggers\nmore requests in parallel. It also moves some function creation out\nand waits with the first request until the server is listening.\n\nPR-URL: https://github.com/nodejs/node/pull/22373\nFixes: https://github.com/nodejs/node/issues/22336\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "79642ae071bde3d0552566a31cc3867d85476795",
    "files": [
        {
            "sha": "5248a1504dfd37996cebdbf6535ef39ba2f10902",
            "filename": "test/parallel/test-gc-http-client.js",
            "status": "modified",
            "additions": 18,
            "deletions": 22,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/79642ae071bde3d0552566a31cc3867d85476795/test%2Fparallel%2Ftest-gc-http-client.js",
            "raw_url": "https://github.com/nodejs/node/raw/79642ae071bde3d0552566a31cc3867d85476795/test%2Fparallel%2Ftest-gc-http-client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-gc-http-client.js?ref=79642ae071bde3d0552566a31cc3867d85476795",
            "patch": "@@ -10,44 +10,40 @@ function serverHandler(req, res) {\n }\n \n const http = require('http');\n-const todo = 500;\n+const todo = 300;\n let done = 0;\n let count = 0;\n let countGC = 0;\n \n console.log(`We should do ${todo} requests`);\n \n const server = http.createServer(serverHandler);\n-server.listen(0, getall);\n-\n+server.listen(0, common.mustCall(() => {\n+  for (let i = 0; i < 15; i++)\n+    getall();\n+}));\n \n function getall() {\n-  if (count >= todo)\n+  if (count === todo)\n     return;\n \n-  (function() {\n-    function cb(res) {\n-      res.resume();\n-      console.error('in cb');\n-      done += 1;\n-      res.on('end', global.gc);\n-    }\n-\n-    const req = http.get({\n-      hostname: 'localhost',\n-      pathname: '/',\n-      port: server.address().port\n-    }, cb);\n+  const req = http.get({\n+    hostname: 'localhost',\n+    pathname: '/',\n+    port: server.address().port\n+  }, cb);\n \n-    count++;\n-    common.onGC(req, { ongc });\n-  })();\n+  count++;\n+  common.onGC(req, { ongc });\n \n   setImmediate(getall);\n }\n \n-for (let i = 0; i < 10; i++)\n-  getall();\n+function cb(res) {\n+  res.resume();\n+  done += 1;\n+  res.on('end', global.gc);\n+}\n \n function ongc() {\n   countGC++;"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 18,
        "deletions": 22
    }
}