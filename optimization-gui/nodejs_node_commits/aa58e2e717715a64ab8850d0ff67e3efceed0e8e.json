{
    "author": "addaleax",
    "message": "deps: cherry-pick 555c811 from upstream V8\n\nOriginal commit message:\n\n    [api] Switch from `SetBuildEmbedderGraphCallback` to `AddBuildEmbedderGraphCallback`\n\n    `SetBuildEmbedderGraphCallback`, unlike `SetWrapperClassInfoProvider`,\n    assumes a monolithic embedder that can provide all necessary information.\n    That is not the case for e.g. Node.js, which can e.g. provide multiple Node.js\n    instances per V8 Isolate, as well as native addons that may allocate resources\n    on their own.\n\n    Cq-Include-Trybots: luci.chromium.try:linux_chromium_rel_ng\n    Change-Id: Ib53dfde82416dd69934b08623e27d674a483ac2d\n    Reviewed-on: https://chromium-review.googlesource.com/1082441\n    Commit-Queue: Ulan Degenbaev <ulan@chromium.org>\n    Reviewed-by: Ulan Degenbaev <ulan@chromium.org>\n    Reviewed-by: Yang Guo <yangguo@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#53545}\n\nRefs: https://github.com/v8/v8/commit/555c811c0d44d9aaaccf8e76059ed24537b3f012\n\nPR-URL: https://github.com/nodejs/node/pull/21741\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "aa58e2e717715a64ab8850d0ff67e3efceed0e8e",
    "files": [
        {
            "sha": "0f3f990916a621738e67589e0fc16382815fb3d5",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=aa58e2e717715a64ab8850d0ff67e3efceed0e8e",
            "patch": "@@ -28,7 +28,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.7',\n+    'v8_embedder_string': '-node.8',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "0e09d8732f2b72f2ce0206f8d883cf3ecef60fcb",
            "filename": "deps/v8/include/v8-profiler.h",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/deps%2Fv8%2Finclude%2Fv8-profiler.h",
            "raw_url": "https://github.com/nodejs/node/raw/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/deps%2Fv8%2Finclude%2Fv8-profiler.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8-profiler.h?ref=aa58e2e717715a64ab8850d0ff67e3efceed0e8e",
            "patch": "@@ -640,7 +640,7 @@ class V8_EXPORT AllocationProfile {\n  * Usage:\n  * 1) Define derived class of EmbedderGraph::Node for embedder objects.\n  * 2) Set the build embedder graph callback on the heap profiler using\n- *    HeapProfiler::SetBuildEmbedderGraphCallback.\n+ *    HeapProfiler::AddBuildEmbedderGraphCallback.\n  * 3) In the callback use graph->AddEdge(node1, node2) to add an edge from\n  *    node1 to node2.\n  * 4) To represent references from/to V8 object, construct V8 nodes using\n@@ -740,7 +740,12 @@ class V8_EXPORT HeapProfiler {\n    * The callback must not trigger garbage collection in V8.\n    */\n   typedef void (*BuildEmbedderGraphCallback)(v8::Isolate* isolate,\n-                                             v8::EmbedderGraph* graph);\n+                                             v8::EmbedderGraph* graph,\n+                                             void* data);\n+\n+  /** TODO(addaleax): Remove */\n+  typedef void (*LegacyBuildEmbedderGraphCallback)(v8::Isolate* isolate,\n+                                                   v8::EmbedderGraph* graph);\n \n   /** Returns the number of snapshots taken. */\n   int GetSnapshotCount();\n@@ -882,15 +887,22 @@ class V8_EXPORT HeapProfiler {\n \n   /** Binds a callback to embedder's class ID. */\n   V8_DEPRECATED(\n-      \"Use SetBuildEmbedderGraphCallback to provide info about embedder nodes\",\n+      \"Use AddBuildEmbedderGraphCallback to provide info about embedder nodes\",\n       void SetWrapperClassInfoProvider(uint16_t class_id,\n                                        WrapperInfoCallback callback));\n \n   V8_DEPRECATED(\n-      \"Use SetBuildEmbedderGraphCallback to provide info about embedder nodes\",\n+      \"Use AddBuildEmbedderGraphCallback to provide info about embedder nodes\",\n       void SetGetRetainerInfosCallback(GetRetainerInfosCallback callback));\n \n-  void SetBuildEmbedderGraphCallback(BuildEmbedderGraphCallback callback);\n+  V8_DEPRECATE_SOON(\n+      \"Use AddBuildEmbedderGraphCallback to provide info about embedder nodes\",\n+      void SetBuildEmbedderGraphCallback(\n+          LegacyBuildEmbedderGraphCallback callback));\n+  void AddBuildEmbedderGraphCallback(BuildEmbedderGraphCallback callback,\n+                                     void* data);\n+  void RemoveBuildEmbedderGraphCallback(BuildEmbedderGraphCallback callback,\n+                                        void* data);\n \n   /**\n    * Default value of persistent handle class ID. Must not be used to"
        },
        {
            "sha": "87b6b24270777f6d536051f92f1b7ba9ecb77662",
            "filename": "deps/v8/src/api.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/deps%2Fv8%2Fsrc%2Fapi.cc",
            "raw_url": "https://github.com/nodejs/node/raw/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/deps%2Fv8%2Fsrc%2Fapi.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fapi.cc?ref=aa58e2e717715a64ab8850d0ff67e3efceed0e8e",
            "patch": "@@ -10451,9 +10451,25 @@ void HeapProfiler::SetGetRetainerInfosCallback(\n }\n \n void HeapProfiler::SetBuildEmbedderGraphCallback(\n-    BuildEmbedderGraphCallback callback) {\n-  reinterpret_cast<i::HeapProfiler*>(this)->SetBuildEmbedderGraphCallback(\n-      callback);\n+    LegacyBuildEmbedderGraphCallback callback) {\n+  reinterpret_cast<i::HeapProfiler*>(this)->AddBuildEmbedderGraphCallback(\n+      [](v8::Isolate* isolate, v8::EmbedderGraph* graph, void* data) {\n+        reinterpret_cast<LegacyBuildEmbedderGraphCallback>(data)(isolate,\n+                                                                 graph);\n+      },\n+      reinterpret_cast<void*>(callback));\n+}\n+\n+void HeapProfiler::AddBuildEmbedderGraphCallback(\n+    BuildEmbedderGraphCallback callback, void* data) {\n+  reinterpret_cast<i::HeapProfiler*>(this)->AddBuildEmbedderGraphCallback(\n+      callback, data);\n+}\n+\n+void HeapProfiler::RemoveBuildEmbedderGraphCallback(\n+    BuildEmbedderGraphCallback callback, void* data) {\n+  reinterpret_cast<i::HeapProfiler*>(this)->RemoveBuildEmbedderGraphCallback(\n+      callback, data);\n }\n \n v8::Testing::StressType internal::Testing::stress_type_ ="
        },
        {
            "sha": "10645ad16161f86e1ccaf3b2e6f731757fc089d9",
            "filename": "deps/v8/src/profiler/heap-profiler.cc",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.cc?ref=aa58e2e717715a64ab8850d0ff67e3efceed0e8e",
            "patch": "@@ -69,16 +69,25 @@ v8::HeapProfiler::RetainerInfos HeapProfiler::GetRetainerInfos(\n   return infos;\n }\n \n-void HeapProfiler::SetBuildEmbedderGraphCallback(\n-    v8::HeapProfiler::BuildEmbedderGraphCallback callback) {\n-  build_embedder_graph_callback_ = callback;\n+void HeapProfiler::AddBuildEmbedderGraphCallback(\n+    v8::HeapProfiler::BuildEmbedderGraphCallback callback, void* data) {\n+  build_embedder_graph_callbacks_.push_back({callback, data});\n+}\n+\n+void HeapProfiler::RemoveBuildEmbedderGraphCallback(\n+    v8::HeapProfiler::BuildEmbedderGraphCallback callback, void* data) {\n+  auto it = std::find(build_embedder_graph_callbacks_.begin(),\n+                      build_embedder_graph_callbacks_.end(),\n+                      std::make_pair(callback, data));\n+  if (it != build_embedder_graph_callbacks_.end())\n+    build_embedder_graph_callbacks_.erase(it);\n }\n \n void HeapProfiler::BuildEmbedderGraph(Isolate* isolate,\n                                       v8::EmbedderGraph* graph) {\n-  if (build_embedder_graph_callback_ != nullptr)\n-    build_embedder_graph_callback_(reinterpret_cast<v8::Isolate*>(isolate),\n-                                   graph);\n+  for (const auto& cb : build_embedder_graph_callbacks_) {\n+    cb.first(reinterpret_cast<v8::Isolate*>(isolate), graph, cb.second);\n+  }\n }\n \n HeapSnapshot* HeapProfiler::TakeSnapshot("
        },
        {
            "sha": "fc0b005e1c67ceab9d85c7013479866641127a84",
            "filename": "deps/v8/src/profiler/heap-profiler.h",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.h",
            "raw_url": "https://github.com/nodejs/node/raw/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-profiler.h?ref=aa58e2e717715a64ab8850d0ff67e3efceed0e8e",
            "patch": "@@ -71,11 +71,13 @@ class HeapProfiler : public HeapObjectAllocationTracker {\n       v8::HeapProfiler::GetRetainerInfosCallback callback);\n   v8::HeapProfiler::RetainerInfos GetRetainerInfos(Isolate* isolate);\n \n-  void SetBuildEmbedderGraphCallback(\n-      v8::HeapProfiler::BuildEmbedderGraphCallback callback);\n+  void AddBuildEmbedderGraphCallback(\n+      v8::HeapProfiler::BuildEmbedderGraphCallback callback, void* data);\n+  void RemoveBuildEmbedderGraphCallback(\n+      v8::HeapProfiler::BuildEmbedderGraphCallback callback, void* data);\n   void BuildEmbedderGraph(Isolate* isolate, v8::EmbedderGraph* graph);\n   bool HasBuildEmbedderGraphCallback() {\n-    return build_embedder_graph_callback_ != nullptr;\n+    return !build_embedder_graph_callbacks_.empty();\n   }\n \n   bool is_tracking_object_moves() const { return is_tracking_object_moves_; }\n@@ -103,8 +105,8 @@ class HeapProfiler : public HeapObjectAllocationTracker {\n   std::unique_ptr<SamplingHeapProfiler> sampling_heap_profiler_;\n   v8::HeapProfiler::GetRetainerInfosCallback get_retainer_infos_callback_ =\n       nullptr;\n-  v8::HeapProfiler::BuildEmbedderGraphCallback build_embedder_graph_callback_ =\n-      nullptr;\n+  std::vector<std::pair<v8::HeapProfiler::BuildEmbedderGraphCallback, void*>>\n+      build_embedder_graph_callbacks_;\n \n   DISALLOW_COPY_AND_ASSIGN(HeapProfiler);\n };"
        },
        {
            "sha": "70dc07d3dc872eb605188504120a3a678bf128f6",
            "filename": "deps/v8/test/cctest/test-heap-profiler.cc",
            "status": "modified",
            "additions": 93,
            "deletions": 11,
            "changes": 104,
            "blob_url": "https://github.com/nodejs/node/blob/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/aa58e2e717715a64ab8850d0ff67e3efceed0e8e/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc?ref=aa58e2e717715a64ab8850d0ff67e3efceed0e8e",
            "patch": "@@ -1541,8 +1541,8 @@ class EmbedderGraphBuilder : public v8::PersistentHandleVisitor {\n         graph->AddNode(std::unique_ptr<Group>(new Group(\"ccc-group\")));\n   }\n \n-  static void BuildEmbedderGraph(v8::Isolate* isolate,\n-                                 v8::EmbedderGraph* graph) {\n+  static void BuildEmbedderGraph(v8::Isolate* isolate, v8::EmbedderGraph* graph,\n+                                 void* data) {\n     EmbedderGraphBuilder builder(isolate, graph);\n     isolate->VisitHandlesWithClassIds(&builder);\n   }\n@@ -1604,8 +1604,8 @@ TEST(HeapSnapshotRetainedObjectInfo) {\n   v8::HandleScope scope(isolate);\n   v8::HeapProfiler* heap_profiler = isolate->GetHeapProfiler();\n \n-  heap_profiler->SetBuildEmbedderGraphCallback(\n-      EmbedderGraphBuilder::BuildEmbedderGraph);\n+  heap_profiler->AddBuildEmbedderGraphCallback(\n+      EmbedderGraphBuilder::BuildEmbedderGraph, nullptr);\n   v8::Persistent<v8::String> p_AAA(isolate, v8_str(\"AAA\"));\n   p_AAA.SetWrapperClassId(1);\n   v8::Persistent<v8::String> p_BBB(isolate, v8_str(\"BBB\"));\n@@ -2932,7 +2932,8 @@ class EmbedderRootNode : public EmbedderNode {\n // global object.\n v8::Local<v8::Value>* global_object_pointer;\n \n-void BuildEmbedderGraph(v8::Isolate* v8_isolate, v8::EmbedderGraph* graph) {\n+void BuildEmbedderGraph(v8::Isolate* v8_isolate, v8::EmbedderGraph* graph,\n+                        void* data) {\n   using Node = v8::EmbedderGraph::Node;\n   Node* global_node = graph->V8Node(*global_object_pointer);\n   Node* embedder_node_A = graph->AddNode(\n@@ -2979,12 +2980,92 @@ TEST(EmbedderGraph) {\n           (isolate->context()->native_context()->global_object())));\n   global_object_pointer = &global_object;\n   v8::HeapProfiler* heap_profiler = env->GetIsolate()->GetHeapProfiler();\n-  heap_profiler->SetBuildEmbedderGraphCallback(BuildEmbedderGraph);\n+  heap_profiler->AddBuildEmbedderGraphCallback(BuildEmbedderGraph, nullptr);\n   const v8::HeapSnapshot* snapshot = heap_profiler->TakeHeapSnapshot();\n   CHECK(ValidateSnapshot(snapshot));\n   CheckEmbedderGraphSnapshot(env->GetIsolate(), snapshot);\n }\n \n+struct GraphBuildingContext {\n+  int counter = 0;\n+};\n+\n+void CheckEmbedderGraphSnapshotWithContext(\n+    v8::Isolate* isolate, const v8::HeapSnapshot* snapshot,\n+    const GraphBuildingContext* context) {\n+  const v8::HeapGraphNode* global = GetGlobalObject(snapshot);\n+  CHECK_GE(context->counter, 1);\n+  CHECK_LE(context->counter, 2);\n+\n+  const v8::HeapGraphNode* embedder_node_A =\n+      GetChildByName(global, \"EmbedderNodeA\");\n+  CHECK_EQ(10, GetSize(embedder_node_A));\n+\n+  const v8::HeapGraphNode* embedder_node_B =\n+      GetChildByName(global, \"EmbedderNodeB\");\n+  if (context->counter == 2) {\n+    CHECK_NOT_NULL(embedder_node_B);\n+    CHECK_EQ(20, GetSize(embedder_node_B));\n+  } else {\n+    CHECK_NULL(embedder_node_B);\n+  }\n+}\n+\n+void BuildEmbedderGraphWithContext(v8::Isolate* v8_isolate,\n+                                   v8::EmbedderGraph* graph, void* data) {\n+  using Node = v8::EmbedderGraph::Node;\n+  GraphBuildingContext* context = static_cast<GraphBuildingContext*>(data);\n+  Node* global_node = graph->V8Node(*global_object_pointer);\n+\n+  CHECK_GE(context->counter, 0);\n+  CHECK_LE(context->counter, 1);\n+  switch (context->counter++) {\n+    case 0: {\n+      Node* embedder_node_A = graph->AddNode(\n+          std::unique_ptr<Node>(new EmbedderNode(\"EmbedderNodeA\", 10)));\n+      graph->AddEdge(global_node, embedder_node_A);\n+      break;\n+    }\n+    case 1: {\n+      Node* embedder_node_B = graph->AddNode(\n+          std::unique_ptr<Node>(new EmbedderNode(\"EmbedderNodeB\", 20)));\n+      graph->AddEdge(global_node, embedder_node_B);\n+      break;\n+    }\n+  }\n+}\n+\n+TEST(EmbedderGraphMultipleCallbacks) {\n+  i::FLAG_heap_profiler_use_embedder_graph = true;\n+  LocalContext env;\n+  v8::HandleScope scope(env->GetIsolate());\n+  i::Isolate* isolate = reinterpret_cast<i::Isolate*>(env->GetIsolate());\n+  v8::Local<v8::Value> global_object =\n+      v8::Utils::ToLocal(i::Handle<i::JSObject>(\n+          (isolate->context()->native_context()->global_object())));\n+  global_object_pointer = &global_object;\n+  v8::HeapProfiler* heap_profiler = env->GetIsolate()->GetHeapProfiler();\n+  GraphBuildingContext context;\n+\n+  heap_profiler->AddBuildEmbedderGraphCallback(BuildEmbedderGraphWithContext,\n+                                               &context);\n+  heap_profiler->AddBuildEmbedderGraphCallback(BuildEmbedderGraphWithContext,\n+                                               &context);\n+  const v8::HeapSnapshot* snapshot = heap_profiler->TakeHeapSnapshot();\n+  CHECK_EQ(context.counter, 2);\n+  CHECK(ValidateSnapshot(snapshot));\n+  CheckEmbedderGraphSnapshotWithContext(env->GetIsolate(), snapshot, &context);\n+\n+  heap_profiler->RemoveBuildEmbedderGraphCallback(BuildEmbedderGraphWithContext,\n+                                                  &context);\n+  context.counter = 0;\n+\n+  snapshot = heap_profiler->TakeHeapSnapshot();\n+  CHECK_EQ(context.counter, 1);\n+  CHECK(ValidateSnapshot(snapshot));\n+  CheckEmbedderGraphSnapshotWithContext(env->GetIsolate(), snapshot, &context);\n+}\n+\n TEST(StrongHandleAnnotation) {\n   LocalContext env;\n   v8::HandleScope scope(env->GetIsolate());\n@@ -3010,7 +3091,7 @@ TEST(StrongHandleAnnotation) {\n }\n \n void BuildEmbedderGraphWithWrapperNode(v8::Isolate* v8_isolate,\n-                                       v8::EmbedderGraph* graph) {\n+                                       v8::EmbedderGraph* graph, void* data) {\n   using Node = v8::EmbedderGraph::Node;\n   Node* global_node = graph->V8Node(*global_object_pointer);\n   Node* wrapper_node = graph->AddNode(\n@@ -3041,8 +3122,8 @@ TEST(EmbedderGraphWithWrapperNode) {\n           (isolate->context()->native_context()->global_object())));\n   global_object_pointer = &global_object;\n   v8::HeapProfiler* heap_profiler = env->GetIsolate()->GetHeapProfiler();\n-  heap_profiler->SetBuildEmbedderGraphCallback(\n-      BuildEmbedderGraphWithWrapperNode);\n+  heap_profiler->AddBuildEmbedderGraphCallback(\n+      BuildEmbedderGraphWithWrapperNode, nullptr);\n   const v8::HeapSnapshot* snapshot = heap_profiler->TakeHeapSnapshot();\n   CHECK(ValidateSnapshot(snapshot));\n   const v8::HeapGraphNode* global = GetGlobalObject(snapshot);\n@@ -3080,7 +3161,7 @@ class EmbedderNodeWithPrefix : public v8::EmbedderGraph::Node {\n };\n \n void BuildEmbedderGraphWithPrefix(v8::Isolate* v8_isolate,\n-                                  v8::EmbedderGraph* graph) {\n+                                  v8::EmbedderGraph* graph, void* data) {\n   using Node = v8::EmbedderGraph::Node;\n   Node* global_node = graph->V8Node(*global_object_pointer);\n   Node* node = graph->AddNode(\n@@ -3098,7 +3179,8 @@ TEST(EmbedderGraphWithPrefix) {\n           (isolate->context()->native_context()->global_object())));\n   global_object_pointer = &global_object;\n   v8::HeapProfiler* heap_profiler = env->GetIsolate()->GetHeapProfiler();\n-  heap_profiler->SetBuildEmbedderGraphCallback(BuildEmbedderGraphWithPrefix);\n+  heap_profiler->AddBuildEmbedderGraphCallback(BuildEmbedderGraphWithPrefix,\n+                                               nullptr);\n   const v8::HeapSnapshot* snapshot = heap_profiler->TakeHeapSnapshot();\n   CHECK(ValidateSnapshot(snapshot));\n   const v8::HeapGraphNode* global = GetGlobalObject(snapshot);"
        }
    ],
    "stats": {
        "total": 183,
        "additions": 152,
        "deletions": 31
    }
}