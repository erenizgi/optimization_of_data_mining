{
    "author": "unknown",
    "message": "n-api: ensure in-module exceptions are propagated\n\nWhenever we call into an addon, whether it is for a callback, for\nmodule init, or for async work-related reasons, we should make sure\nthat\n\n* the last error is cleared,\n* the scopes before the call are the same as after, and\n* if an exception was thrown and captured inside the module, then it is\n  re-thrown after the call.\n\nTherefore we should call into the module in a unified fashion. This\nchange introduces the macro NAPI_CALL_INTO_MODULE() which should be\nused whenever invoking a callback provided by the module.\n\nFixes: https://github.com/nodejs/node/issues/19437\nPR-URL: https://github.com/nodejs/node/pull/19537\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>",
    "sha": "9e226475e8e28b8664643d6644503ccd06bceb9a",
    "files": [
        {
            "sha": "c5b93db959ceeb7b0b47a271013441d41e88c883",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 41,
            "deletions": 37,
            "changes": 78,
            "blob_url": "https://github.com/nodejs/node/blob/9e226475e8e28b8664643d6644503ccd06bceb9a/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/9e226475e8e28b8664643d6644503ccd06bceb9a/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=9e226475e8e28b8664643d6644503ccd06bceb9a",
            "patch": "@@ -157,6 +157,23 @@ struct napi_env__ {\n     (out) = v8::type::New((buffer), (byte_offset), (length));                  \\\n   } while (0)\n \n+#define NAPI_CALL_INTO_MODULE(env, call, handle_exception)                   \\\n+  do {                                                                       \\\n+    int open_handle_scopes = (env)->open_handle_scopes;                      \\\n+    int open_callback_scopes = (env)->open_callback_scopes;                  \\\n+    napi_clear_last_error((env));                                            \\\n+    call;                                                                    \\\n+    CHECK_EQ((env)->open_handle_scopes, open_handle_scopes);                 \\\n+    CHECK_EQ((env)->open_callback_scopes, open_callback_scopes);             \\\n+    if (!(env)->last_exception.IsEmpty()) {                                  \\\n+      handle_exception(                                                      \\\n+          v8::Local<v8::Value>::New((env)->isolate, (env)->last_exception)); \\\n+      (env)->last_exception.Reset();                                         \\\n+    }                                                                        \\\n+  } while (0)\n+\n+#define NAPI_CALL_INTO_MODULE_THROW(env, call) \\\n+  NAPI_CALL_INTO_MODULE((env), call, (env)->isolate->ThrowException)\n \n namespace {\n namespace v8impl {\n@@ -336,10 +353,11 @@ class Finalizer {\n   static void FinalizeBufferCallback(char* data, void* hint) {\n     Finalizer* finalizer = static_cast<Finalizer*>(hint);\n     if (finalizer->_finalize_callback != nullptr) {\n-      finalizer->_finalize_callback(\n-        finalizer->_env,\n-        data,\n-        finalizer->_finalize_hint);\n+      NAPI_CALL_INTO_MODULE_THROW(finalizer->_env,\n+        finalizer->_finalize_callback(\n+          finalizer->_env,\n+          data,\n+          finalizer->_finalize_hint));\n     }\n \n     Delete(finalizer);\n@@ -441,10 +459,11 @@ class Reference : private Finalizer {\n     bool delete_self = reference->_delete_self;\n \n     if (reference->_finalize_callback != nullptr) {\n-      reference->_finalize_callback(\n-          reference->_env,\n-          reference->_finalize_data,\n-          reference->_finalize_hint);\n+      NAPI_CALL_INTO_MODULE_THROW(reference->_env,\n+        reference->_finalize_callback(\n+            reference->_env,\n+            reference->_finalize_data,\n+            reference->_finalize_hint));\n     }\n \n     if (delete_self) {\n@@ -529,32 +548,17 @@ class CallbackWrapperBase : public CallbackWrapper {\n     napi_callback cb = reinterpret_cast<napi_callback>(\n         v8::Local<v8::External>::Cast(\n             _cbdata->GetInternalField(kInternalFieldIndex))->Value());\n-    v8::Isolate* isolate = _cbinfo.GetIsolate();\n \n     napi_env env = static_cast<napi_env>(\n         v8::Local<v8::External>::Cast(\n             _cbdata->GetInternalField(kEnvIndex))->Value());\n \n-    // Make sure any errors encountered last time we were in N-API are gone.\n-    napi_clear_last_error(env);\n-\n-    int open_handle_scopes = env->open_handle_scopes;\n-    int open_callback_scopes = env->open_callback_scopes;\n-\n-    napi_value result = cb(env, cbinfo_wrapper);\n+    napi_value result;\n+    NAPI_CALL_INTO_MODULE_THROW(env, result = cb(env, cbinfo_wrapper));\n \n     if (result != nullptr) {\n       this->SetReturnValue(result);\n     }\n-\n-    CHECK_EQ(env->open_handle_scopes, open_handle_scopes);\n-    CHECK_EQ(env->open_callback_scopes, open_callback_scopes);\n-\n-    if (!env->last_exception.IsEmpty()) {\n-      isolate->ThrowException(\n-          v8::Local<v8::Value>::New(isolate, env->last_exception));\n-      env->last_exception.Reset();\n-    }\n   }\n \n   const Info& _cbinfo;\n@@ -861,8 +865,10 @@ void napi_module_register_cb(v8::Local<v8::Object> exports,\n   // one is found.\n   napi_env env = v8impl::GetEnv(context);\n \n-  napi_value _exports =\n-      mod->nm_register_func(env, v8impl::JsValueFromV8LocalValue(exports));\n+  napi_value _exports;\n+  NAPI_CALL_INTO_MODULE_THROW(env,\n+      _exports = mod->nm_register_func(env,\n+          v8impl::JsValueFromV8LocalValue(exports)));\n \n   // If register function returned a non-null exports object different from\n   // the exports object we passed it, set that as the \"exports\" property of\n@@ -3357,19 +3363,17 @@ class Work : public node::AsyncResource {\n       v8::HandleScope scope(env->isolate);\n       CallbackScope callback_scope(work);\n \n-      work->_complete(env, ConvertUVErrorCode(status), work->_data);\n+      NAPI_CALL_INTO_MODULE(env,\n+          work->_complete(env, ConvertUVErrorCode(status), work->_data),\n+          [env] (v8::Local<v8::Value> local_err) {\n+            // If there was an unhandled exception in the complete callback,\n+            // report it as a fatal exception. (There is no JavaScript on the\n+            // callstack that can possibly handle it.)\n+            v8impl::trigger_fatal_exception(env, local_err);\n+          });\n \n       // Note: Don't access `work` after this point because it was\n       // likely deleted by the complete callback.\n-\n-      // If there was an unhandled exception in the complete callback,\n-      // report it as a fatal exception. (There is no JavaScript on the\n-      // callstack that can possibly handle it.)\n-      if (!env->last_exception.IsEmpty()) {\n-        v8::Local<v8::Value> local_err = v8::Local<v8::Value>::New(\n-          env->isolate, env->last_exception);\n-        v8impl::trigger_fatal_exception(env, local_err);\n-      }\n     }\n   }\n "
        },
        {
            "sha": "b9311add6c92d7ca9403a5e194a2d84543a65ef4",
            "filename": "test/addons-napi/test_exception/test.js",
            "status": "modified",
            "additions": 29,
            "deletions": 1,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/9e226475e8e28b8664643d6644503ccd06bceb9a/test%2Faddons-napi%2Ftest_exception%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/9e226475e8e28b8664643d6644503ccd06bceb9a/test%2Faddons-napi%2Ftest_exception%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_exception%2Ftest.js?ref=9e226475e8e28b8664643d6644503ccd06bceb9a",
            "patch": "@@ -1,10 +1,26 @@\n 'use strict';\n+// Flags: --expose-gc\n \n const common = require('../../common');\n-const test_exception = require(`./build/${common.buildType}/test_exception`);\n const assert = require('assert');\n const theError = new Error('Some error');\n \n+// The test module throws an error during Init, but in order for its exports to\n+// not be lost, it attaches them to the error's \"bindings\" property. This way,\n+// we can make sure that exceptions thrown during the module initialization\n+// phase are propagated through require() into JavaScript.\n+// https://github.com/nodejs/node/issues/19437\n+const test_exception = (function() {\n+  let resultingException;\n+  try {\n+    require(`./build/${common.buildType}/test_exception`);\n+  } catch (anException) {\n+    resultingException = anException;\n+  }\n+  assert.strictEqual(resultingException.message, 'Error during Init');\n+  return resultingException.binding;\n+})();\n+\n {\n   const throwTheError = () => { throw theError; };\n \n@@ -50,3 +66,15 @@ const theError = new Error('Some error');\n                      'Exception state did not remain clear as expected,' +\n                      ` .wasPending() returned ${exception_pending}`);\n }\n+\n+// Make sure that exceptions that occur during finalization are propagated.\n+function testFinalize(binding) {\n+  let x = test_exception[binding]();\n+  x = null;\n+  assert.throws(() => { global.gc(); }, /Error during Finalize/);\n+\n+  // To assuage the linter's concerns.\n+  (function() {})(x);\n+}\n+testFinalize('createExternal');\n+testFinalize('createExternalBuffer');"
        },
        {
            "sha": "61116d0603bfae87d5c7dd665ca879830375f20f",
            "filename": "test/addons-napi/test_exception/test_exception.c",
            "status": "modified",
            "additions": 37,
            "deletions": 5,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/9e226475e8e28b8664643d6644503ccd06bceb9a/test%2Faddons-napi%2Ftest_exception%2Ftest_exception.c",
            "raw_url": "https://github.com/nodejs/node/raw/9e226475e8e28b8664643d6644503ccd06bceb9a/test%2Faddons-napi%2Ftest_exception%2Ftest_exception.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2Ftest_exception%2Ftest_exception.c?ref=9e226475e8e28b8664643d6644503ccd06bceb9a",
            "patch": "@@ -3,7 +3,7 @@\n \n static bool exceptionWasPending = false;\n \n-napi_value returnException(napi_env env, napi_callback_info info) {\n+static napi_value returnException(napi_env env, napi_callback_info info) {\n   size_t argc = 1;\n   napi_value args[1];\n   NAPI_CALL(env, napi_get_cb_info(env, info, &argc, args, NULL, NULL));\n@@ -22,7 +22,7 @@ napi_value returnException(napi_env env, napi_callback_info info) {\n   return NULL;\n }\n \n-napi_value allowException(napi_env env, napi_callback_info info) {\n+static napi_value allowException(napi_env env, napi_callback_info info) {\n   size_t argc = 1;\n   napi_value args[1];\n   NAPI_CALL(env, napi_get_cb_info(env, info, &argc, args, NULL, NULL));\n@@ -38,23 +38,55 @@ napi_value allowException(napi_env env, napi_callback_info info) {\n   return NULL;\n }\n \n-napi_value wasPending(napi_env env, napi_callback_info info) {\n+static napi_value wasPending(napi_env env, napi_callback_info info) {\n   napi_value result;\n   NAPI_CALL(env, napi_get_boolean(env, exceptionWasPending, &result));\n \n   return result;\n }\n \n-napi_value Init(napi_env env, napi_value exports) {\n+static void finalizer(napi_env env, void *data, void *hint) {\n+  NAPI_CALL_RETURN_VOID(env,\n+      napi_throw_error(env, NULL, \"Error during Finalize\"));\n+}\n+\n+static napi_value createExternal(napi_env env, napi_callback_info info) {\n+  napi_value external;\n+\n+  NAPI_CALL(env,\n+      napi_create_external(env, NULL, finalizer, NULL, &external));\n+\n+  return external;\n+}\n+\n+static char buffer_data[12];\n+\n+static napi_value createExternalBuffer(napi_env env, napi_callback_info info) {\n+  napi_value buffer;\n+  NAPI_CALL(env, napi_create_external_buffer(env, sizeof(buffer_data),\n+      buffer_data, finalizer, NULL, &buffer));\n+  return buffer;\n+}\n+\n+static napi_value Init(napi_env env, napi_value exports) {\n   napi_property_descriptor descriptors[] = {\n     DECLARE_NAPI_PROPERTY(\"returnException\", returnException),\n     DECLARE_NAPI_PROPERTY(\"allowException\", allowException),\n     DECLARE_NAPI_PROPERTY(\"wasPending\", wasPending),\n+    DECLARE_NAPI_PROPERTY(\"createExternal\", createExternal),\n+    DECLARE_NAPI_PROPERTY(\"createExternalBuffer\", createExternalBuffer),\n   };\n-\n   NAPI_CALL(env, napi_define_properties(\n       env, exports, sizeof(descriptors) / sizeof(*descriptors), descriptors));\n \n+  napi_value error, code, message;\n+  NAPI_CALL(env, napi_create_string_utf8(env, \"Error during Init\",\n+      NAPI_AUTO_LENGTH, &message));\n+  NAPI_CALL(env, napi_create_string_utf8(env, \"\", NAPI_AUTO_LENGTH, &code));\n+  NAPI_CALL(env, napi_create_error(env, code, message, &error));\n+  NAPI_CALL(env, napi_set_named_property(env, error, \"binding\", exports));\n+  NAPI_CALL(env, napi_throw(env, error));\n+\n   return exports;\n }\n "
        }
    ],
    "stats": {
        "total": 150,
        "additions": 107,
        "deletions": 43
    }
}