{
    "author": "Fishrock123",
    "message": "child_process: truncate output when maxBuffer is exceeded\n\nPreserves truncated output for `child_process.exec()` when `maxBuffer`\nis exceeded.\n\nThis is particularly useful for commands which have indistinguishable\nerror codes for what output they produce.\n\nPR-URL: https://github.com/nodejs/node/pull/24951\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "e47f972d6851b3196b3b2ba611929f25a5fcadb6",
    "files": [
        {
            "sha": "cdfdab1a98d6359c9d5a4a4a826f2311034240ea",
            "filename": "doc/api/child_process.md",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/e47f972d6851b3196b3b2ba611929f25a5fcadb6/doc%2Fapi%2Fchild_process.md",
            "raw_url": "https://github.com/nodejs/node/raw/e47f972d6851b3196b3b2ba611929f25a5fcadb6/doc%2Fapi%2Fchild_process.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fchild_process.md?ref=e47f972d6851b3196b3b2ba611929f25a5fcadb6",
            "patch": "@@ -147,8 +147,9 @@ changes:\n     `'/bin/sh'` on UNIX, `process.env.ComSpec` on Windows.\n   * `timeout` {number} **Default:** `0`\n   * `maxBuffer` {number} Largest amount of data in bytes allowed on stdout or\n-    stderr. If exceeded, the child process is terminated. See caveat at\n-    [`maxBuffer` and Unicode][]. **Default:** `200 * 1024`.\n+    stderr. If exceeded, the child process is terminated and any output is\n+    truncated. See caveat at [`maxBuffer` and Unicode][].\n+    **Default:** `200 * 1024`.\n   * `killSignal` {string|integer} **Default:** `'SIGTERM'`\n   * `uid` {number} Sets the user identity of the process (see setuid(2)).\n   * `gid` {number} Sets the group identity of the process (see setgid(2)).\n@@ -245,8 +246,9 @@ changes:\n   * `encoding` {string} **Default:** `'utf8'`\n   * `timeout` {number} **Default:** `0`\n   * `maxBuffer` {number} Largest amount of data in bytes allowed on stdout or\n-    stderr. If exceeded, the child process is terminated. See caveat at\n-    [`maxBuffer` and Unicode][]. **Default:** `200 * 1024`.\n+    stderr. If exceeded, the child process is terminated and any output is\n+    truncated. See caveat at [`maxBuffer` and Unicode][].\n+    **Default:** `200 * 1024`.\n   * `killSignal` {string|integer} **Default:** `'SIGTERM'`\n   * `uid` {number} Sets the user identity of the process (see setuid(2)).\n   * `gid` {number} Sets the group identity of the process (see setgid(2)).\n@@ -779,8 +781,9 @@ changes:\n   * `killSignal` {string|integer} The signal value to be used when the spawned\n     process will be killed. **Default:** `'SIGTERM'`.\n   * `maxBuffer` {number} Largest amount of data in bytes allowed on stdout or\n-    stderr. If exceeded, the child process is terminated. See caveat at\n-    [`maxBuffer` and Unicode][]. **Default:** `200 * 1024`.\n+    stderr. If exceeded, the child process is terminated and any output is\n+    truncated. See caveat at [`maxBuffer` and Unicode][].\n+    **Default:** `200 * 1024`.\n   * `encoding` {string} The encoding used for all stdio inputs and outputs.\n     **Default:** `'buffer'`.\n   * `windowsHide` {boolean} Hide the subprocess console window that would\n@@ -842,8 +845,9 @@ changes:\n   * `killSignal` {string|integer} The signal value to be used when the spawned\n     process will be killed. **Default:** `'SIGTERM'`.\n   * `maxBuffer` {number} Largest amount of data in bytes allowed on stdout or\n-    stderr. If exceeded, the child process is terminated. See caveat at\n-    [`maxBuffer` and Unicode][]. **Default:** `200 * 1024`.\n+    stderr. If exceeded, the child process is terminated and any output is\n+    truncated. See caveat at [`maxBuffer` and Unicode][].\n+    **Default:** `200 * 1024`.\n   * `encoding` {string} The encoding used for all stdio inputs and outputs.\n     **Default:** `'buffer'`.\n   * `shell` {boolean|string} If `true`, runs `command` inside of a shell. Uses"
        },
        {
            "sha": "8060412b3f076f5ff73248d8ae23f0c82b33754f",
            "filename": "lib/child_process.js",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/e47f972d6851b3196b3b2ba611929f25a5fcadb6/lib%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/e47f972d6851b3196b3b2ba611929f25a5fcadb6/lib%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fchild_process.js?ref=e47f972d6851b3196b3b2ba611929f25a5fcadb6",
            "patch": "@@ -343,9 +343,15 @@ exports.execFile = function execFile(file /* , args, options, callback */) {\n \n     child.stdout.on('data', function onChildStdout(chunk) {\n       var encoding = child.stdout._readableState.encoding;\n-      stdoutLen += encoding ? Buffer.byteLength(chunk, encoding) : chunk.length;\n+      const length = encoding ?\n+        Buffer.byteLength(chunk, encoding) :\n+        chunk.length;\n+      stdoutLen += length;\n \n       if (stdoutLen > options.maxBuffer) {\n+        const truncatedLen = options.maxBuffer - (stdoutLen - length);\n+        _stdout.push(chunk.slice(0, truncatedLen));\n+\n         ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER('stdout');\n         kill();\n       } else {\n@@ -360,9 +366,15 @@ exports.execFile = function execFile(file /* , args, options, callback */) {\n \n     child.stderr.on('data', function onChildStderr(chunk) {\n       var encoding = child.stderr._readableState.encoding;\n-      stderrLen += encoding ? Buffer.byteLength(chunk, encoding) : chunk.length;\n+      const length = encoding ?\n+        Buffer.byteLength(chunk, encoding) :\n+        chunk.length;\n+      stderrLen += length;\n \n       if (stderrLen > options.maxBuffer) {\n+        const truncatedLen = options.maxBuffer - (stderrLen - length);\n+        _stderr.push(chunk.slice(0, truncatedLen));\n+\n         ex = new ERR_CHILD_PROCESS_STDIO_MAXBUFFER('stderr');\n         kill();\n       } else {"
        },
        {
            "sha": "dfa46b0b000aab1e6c318b059ddc594cea8778d8",
            "filename": "test/parallel/test-child-process-exec-maxBuffer.js",
            "status": "modified",
            "additions": 19,
            "deletions": 6,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/e47f972d6851b3196b3b2ba611929f25a5fcadb6/test%2Fparallel%2Ftest-child-process-exec-maxBuffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/e47f972d6851b3196b3b2ba611929f25a5fcadb6/test%2Fparallel%2Ftest-child-process-exec-maxBuffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-exec-maxBuffer.js?ref=e47f972d6851b3196b3b2ba611929f25a5fcadb6",
            "patch": "@@ -22,13 +22,13 @@ function runChecks(err, stdio, streamName, expected) {\n }\n \n {\n-  const cmd = 'echo \"hello world\"';\n+  const cmd = 'echo hello world';\n \n   cp.exec(\n     cmd,\n     { maxBuffer: 5 },\n     common.mustCall((err, stdout, stderr) => {\n-      runChecks(err, { stdout, stderr }, 'stdout', '');\n+      runChecks(err, { stdout, stderr }, 'stdout', 'hello');\n     })\n   );\n }\n@@ -42,7 +42,7 @@ const unicode = '中文测试'; // length = 4, byte length = 12\n     cmd,\n     { maxBuffer: 10 },\n     common.mustCall((err, stdout, stderr) => {\n-      runChecks(err, { stdout, stderr }, 'stdout', '');\n+      runChecks(err, { stdout, stderr }, 'stdout', '中文测试\\n');\n     })\n   );\n }\n@@ -54,7 +54,7 @@ const unicode = '中文测试'; // length = 4, byte length = 12\n     cmd,\n     { maxBuffer: 3 },\n     common.mustCall((err, stdout, stderr) => {\n-      runChecks(err, { stdout, stderr }, 'stderr', '');\n+      runChecks(err, { stdout, stderr }, 'stderr', '中文测');\n     })\n   );\n }\n@@ -66,7 +66,7 @@ const unicode = '中文测试'; // length = 4, byte length = 12\n     cmd,\n     { encoding: null, maxBuffer: 10 },\n     common.mustCall((err, stdout, stderr) => {\n-      runChecks(err, { stdout, stderr }, 'stdout', '');\n+      runChecks(err, { stdout, stderr }, 'stdout', '中文测试\\n');\n     })\n   );\n \n@@ -80,9 +80,22 @@ const unicode = '中文测试'; // length = 4, byte length = 12\n     cmd,\n     { encoding: null, maxBuffer: 3 },\n     common.mustCall((err, stdout, stderr) => {\n-      runChecks(err, { stdout, stderr }, 'stderr', '');\n+      runChecks(err, { stdout, stderr }, 'stderr', '中文测');\n     })\n   );\n \n   child.stderr.setEncoding('utf-8');\n }\n+\n+{\n+  const cmd = `\"${process.execPath}\" -e \"console.error('${unicode}');\"`;\n+\n+  cp.exec(\n+    cmd,\n+    { encoding: null, maxBuffer: 5 },\n+    common.mustCall((err, stdout, stderr) => {\n+      const buf = Buffer.from(unicode).slice(0, 5);\n+      runChecks(err, { stdout, stderr }, 'stderr', buf);\n+    })\n+  );\n+}"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 45,
        "deletions": 16
    }
}