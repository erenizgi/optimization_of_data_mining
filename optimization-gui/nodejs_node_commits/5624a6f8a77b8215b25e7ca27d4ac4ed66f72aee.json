{
    "author": "Trott",
    "message": "test: improve assert test hygiene\n\nDo not pollute the source tree for the test. Instead of writing to the\nsource tree, spawn a process with the temp dir as cwd and write the file\nthere.\n\nPR-URL: https://github.com/nodejs/node/pull/20861\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "5624a6f8a77b8215b25e7ca27d4ac4ed66f72aee",
    "files": [
        {
            "sha": "000798aca267a3c6808955ec862be56a64ea7984",
            "filename": "test/parallel/test-assert-builtins-not-read-from-filesystem.js",
            "status": "modified",
            "additions": 27,
            "deletions": 20,
            "changes": 47,
            "blob_url": "https://github.com/nodejs/node/blob/5624a6f8a77b8215b25e7ca27d4ac4ed66f72aee/test%2Fparallel%2Ftest-assert-builtins-not-read-from-filesystem.js",
            "raw_url": "https://github.com/nodejs/node/raw/5624a6f8a77b8215b25e7ca27d4ac4ed66f72aee/test%2Fparallel%2Ftest-assert-builtins-not-read-from-filesystem.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert-builtins-not-read-from-filesystem.js?ref=5624a6f8a77b8215b25e7ca27d4ac4ed66f72aee",
            "patch": "@@ -1,16 +1,25 @@\n-// Flags: --expose-internals\n-\n 'use strict';\n \n-require('../common');\n+// Do not read filesystem when creating AssertionError messages for code in\n+// builtin modules.\n \n+require('../common');\n const assert = require('assert');\n-const EventEmitter = require('events');\n-const { errorCache } = require('internal/assert');\n-const { writeFileSync, unlinkSync } = require('fs');\n \n-// Do not read filesystem for error messages in builtin modules.\n-{\n+if (process.argv[2] !== 'child') {\n+  const tmpdir = require('../common/tmpdir');\n+  tmpdir.refresh();\n+  const { spawnSync } = require('child_process');\n+  const { output, status, error } =\n+    spawnSync(process.execPath,\n+              ['--expose-internals', process.argv[1], 'child'],\n+              { cwd: tmpdir.path, env: process.env });\n+  assert.ifError(error);\n+  assert.strictEqual(status, 0, `Exit code: ${status}\\n${output}`);\n+} else {\n+  const EventEmitter = require('events');\n+  const { errorCache } = require('internal/assert');\n+  const { writeFileSync } = require('fs');\n   const e = new EventEmitter();\n \n   e.on('hello', assert);\n@@ -27,18 +36,16 @@ const { writeFileSync, unlinkSync } = require('fs');\n     assert.strictEqual(errorCache.size, size - 1);\n     const data = `${'\\n'.repeat(line - 1)}${' '.repeat(column - 1)}` +\n                  'ok(failed(badly));';\n-    try {\n-      writeFileSync(filename, data);\n-      assert.throws(\n-        () => e.emit('hello', false),\n-        {\n-          message: 'false == true'\n-        }\n-      );\n-      threw = true;\n-    } finally {\n-      unlinkSync(filename);\n-    }\n+\n+    writeFileSync(filename, data);\n+    assert.throws(\n+      () => e.emit('hello', false),\n+      {\n+        message: 'false == true'\n+      }\n+    );\n+    threw = true;\n+\n   }\n   assert(threw);\n }"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 27,
        "deletions": 20
    }
}