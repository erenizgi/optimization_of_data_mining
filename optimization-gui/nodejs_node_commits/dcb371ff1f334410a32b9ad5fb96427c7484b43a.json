{
    "author": "devsnek",
    "message": "per_context: add warning to Atomics.wake\n\nPR-URL: https://github.com/nodejs/node/pull/21518\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "dcb371ff1f334410a32b9ad5fb96427c7484b43a",
    "files": [
        {
            "sha": "17c14e816ff668476e86858c1fdb77e5e565e09f",
            "filename": "lib/internal/bootstrap/cache.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/dcb371ff1f334410a32b9ad5fb96427c7484b43a/lib%2Finternal%2Fbootstrap%2Fcache.js",
            "raw_url": "https://github.com/nodejs/node/raw/dcb371ff1f334410a32b9ad5fb96427c7484b43a/lib%2Finternal%2Fbootstrap%2Fcache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fcache.js?ref=dcb371ff1f334410a32b9ad5fb96427c7484b43a",
            "patch": "@@ -25,6 +25,7 @@ module.exports = {\n     // the code cache is also used when compiling these\n     // two files.\n     'internal/bootstrap/loaders',\n-    'internal/bootstrap/node'\n+    'internal/bootstrap/node',\n+    'internal/per_context',\n   ]\n };"
        },
        {
            "sha": "bdbad5344ff430bcf617833f90a9bf1673084822",
            "filename": "lib/internal/per_context.js",
            "status": "modified",
            "additions": 41,
            "deletions": 5,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/dcb371ff1f334410a32b9ad5fb96427c7484b43a/lib%2Finternal%2Fper_context.js",
            "raw_url": "https://github.com/nodejs/node/raw/dcb371ff1f334410a32b9ad5fb96427c7484b43a/lib%2Finternal%2Fper_context.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fper_context.js?ref=dcb371ff1f334410a32b9ad5fb96427c7484b43a",
            "patch": "@@ -7,10 +7,46 @@\n   delete global.Intl.v8BreakIterator;\n \n   // https://github.com/nodejs/node/issues/21219\n-  Object.defineProperty(global.Atomics, 'notify', {\n-    value: global.Atomics.wake,\n-    writable: true,\n-    enumerable: false,\n-    configurable: true,\n+  // Adds Atomics.notify and warns on first usage of Atomics.wake\n+\n+  const AtomicsWake = global.Atomics.wake;\n+  const ReflectApply = global.Reflect.apply;\n+\n+  // wrap for function.name\n+  function notify(...args) {\n+    return ReflectApply(AtomicsWake, this, args);\n+  }\n+\n+  const warning = 'Atomics.wake will be removed in a future version, ' +\n+    'use Atomics.notify instead.';\n+\n+  let wakeWarned = false;\n+  function wake(...args) {\n+    if (!wakeWarned) {\n+      wakeWarned = true;\n+\n+      if (global.process !== undefined) {\n+        global.process.emitWarning(warning, 'Atomics');\n+      } else {\n+        global.console.error(`Atomics: ${warning}`);\n+      }\n+    }\n+\n+    return ReflectApply(AtomicsWake, this, args);\n+  }\n+\n+  global.Object.defineProperties(global.Atomics, {\n+    notify: {\n+      value: notify,\n+      writable: true,\n+      enumerable: false,\n+      configurable: true,\n+    },\n+    wake: {\n+      value: wake,\n+      writable: true,\n+      enumerable: false,\n+      configurable: true,\n+    },\n   });\n }(this));"
        },
        {
            "sha": "fc59d5aa3310848218b6d82ac4501f63117eb710",
            "filename": "test/parallel/test-atomics-notify.js",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/dcb371ff1f334410a32b9ad5fb96427c7484b43a/test%2Fparallel%2Ftest-atomics-notify.js",
            "raw_url": "https://github.com/nodejs/node/raw/dcb371ff1f334410a32b9ad5fb96427c7484b43a/test%2Fparallel%2Ftest-atomics-notify.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-atomics-notify.js?ref=dcb371ff1f334410a32b9ad5fb96427c7484b43a",
            "patch": "@@ -1,10 +1,19 @@\n 'use strict';\n \n-require('../common');\n+const { expectWarning, noWarnCode } = require('../common');\n \n const assert = require('assert');\n const { runInNewContext } = require('vm');\n \n-assert.strictEqual(Atomics.wake, Atomics.notify);\n+assert.strictEqual(typeof Atomics.wake, 'function');\n+assert.strictEqual(typeof Atomics.notify, 'function');\n \n-assert(runInNewContext('Atomics.wake === Atomics.notify'));\n+assert.strictEqual(runInNewContext('typeof Atomics.wake'), 'function');\n+assert.strictEqual(runInNewContext('typeof Atomics.notify'), 'function');\n+\n+expectWarning(\n+  'Atomics',\n+  'Atomics.wake will be removed in a future version, ' +\n+  'use Atomics.notify instead.', noWarnCode);\n+\n+Atomics.wake(new Int32Array(new SharedArrayBuffer(4)), 0, 0);"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 55,
        "deletions": 9
    }
}