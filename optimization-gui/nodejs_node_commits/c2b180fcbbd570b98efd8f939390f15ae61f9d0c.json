{
    "author": "cjihrig",
    "message": "test: simplify node-report/test-exception.js\n\nPR-URL: https://github.com/nodejs/node/pull/26277\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>",
    "sha": "c2b180fcbbd570b98efd8f939390f15ae61f9d0c",
    "files": [
        {
            "sha": "b3da7c4244ae092a7e7f056e875d0aafd5b47211",
            "filename": "test/node-report/test-exception.js",
            "status": "modified",
            "additions": 18,
            "deletions": 36,
            "changes": 54,
            "blob_url": "https://github.com/nodejs/node/blob/c2b180fcbbd570b98efd8f939390f15ae61f9d0c/test%2Fnode-report%2Ftest-exception.js",
            "raw_url": "https://github.com/nodejs/node/raw/c2b180fcbbd570b98efd8f939390f15ae61f9d0c/test%2Fnode-report%2Ftest-exception.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fnode-report%2Ftest-exception.js?ref=c2b180fcbbd570b98efd8f939390f15ae61f9d0c",
            "patch": "@@ -1,42 +1,24 @@\n+// Flags: --experimental-report --diagnostic-report-uncaught-exception\n 'use strict';\n-\n-// Testcase to produce report on uncaught exception\n+// Test producing a report on uncaught exception.\n const common = require('../common');\n common.skipIfReportDisabled();\n-if (process.argv[2] === 'child') {\n-  function myException(request, response) {\n-    const m = '*** test-exception.js: throwing uncaught Error';\n-    throw new Error(m);\n-  }\n+const assert = require('assert');\n+const helper = require('../common/report');\n+const tmpdir = require('../common/tmpdir');\n+const error = new Error('test error');\n \n-  myException();\n+common.expectWarning('ExperimentalWarning',\n+                     'report is an experimental feature. This feature could ' +\n+                     'change at any time');\n+tmpdir.refresh();\n+process.report.setOptions({ path: tmpdir.path });\n \n-} else {\n-  const helper = require('../common/report.js');\n-  const tmpdir = require('../common/tmpdir');\n-  tmpdir.refresh();\n-  const spawn = require('child_process').spawn;\n-  const assert = require('assert');\n+process.on('uncaughtException', common.mustCall((err) => {\n+  assert.strictEqual(err, error);\n+  const reports = helper.findReports(process.pid, tmpdir.path);\n+  assert.strictEqual(reports.length, 1);\n+  helper.validate(reports[0]);\n+}));\n \n-  const child = spawn(process.execPath,\n-                      ['--experimental-report',\n-                       '--diagnostic-report-uncaught-exception',\n-                       __filename, 'child'],\n-                      { cwd: tmpdir.path });\n-  // Capture stderr output from the child process\n-  let stderr = '';\n-  child.stderr.on('data', (chunk) => {\n-    stderr += chunk;\n-  });\n-  child.on('exit', common.mustCall((code) => {\n-    const report_msg = 'No reports found';\n-    const process_msg = 'Process exited unexpectedly';\n-    assert.strictEqual(code, 1, process_msg + ':' + code);\n-    assert.ok(new RegExp('myException').test(stderr),\n-              'Check for expected stack trace frame in stderr');\n-    const reports = helper.findReports(child.pid, tmpdir.path);\n-    assert.strictEqual(reports.length, 1, report_msg);\n-    const report = reports[0];\n-    helper.validate(report);\n-  }));\n-}\n+throw error;"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 18,
        "deletions": 36
    }
}