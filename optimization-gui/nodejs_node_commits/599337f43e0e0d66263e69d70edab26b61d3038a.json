{
    "author": "feugy",
    "message": "assert: add rejects() and doesNotReject()\n\nImplement asynchronous equivalent for assert.throws() and\nassert.doesNotThrow().\n\nPR-URL: https://github.com/nodejs/node/pull/18023\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Shingo Inoue <leko.noor@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "599337f43e0e0d66263e69d70edab26b61d3038a",
    "files": [
        {
            "sha": "591d26a515dc71040219b408d7f47032a968e3ed",
            "filename": "doc/api/assert.md",
            "status": "modified",
            "additions": 80,
            "deletions": 0,
            "changes": 80,
            "blob_url": "https://github.com/nodejs/node/blob/599337f43e0e0d66263e69d70edab26b61d3038a/doc%2Fapi%2Fassert.md",
            "raw_url": "https://github.com/nodejs/node/raw/599337f43e0e0d66263e69d70edab26b61d3038a/doc%2Fapi%2Fassert.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fassert.md?ref=599337f43e0e0d66263e69d70edab26b61d3038a",
            "patch": "@@ -312,6 +312,43 @@ parameter is undefined, a default error message is assigned. If the `message`\n parameter is an instance of an [`Error`][] then it will be thrown instead of the\n `AssertionError`.\n \n+## assert.doesNotReject(block[, error][, message])\n+<!-- YAML\n+added: REPLACEME\n+-->\n+* `block` {Function}\n+* `error` {RegExp|Function}\n+* `message` {any}\n+\n+Awaits for the promise returned by function `block` to complete and not be\n+rejected. See [`assert.rejects()`][] for more details.\n+\n+When `assert.doesNotReject()` is called, it will immediately call the `block`\n+function, and awaits for completion.\n+\n+Besides the async nature to await the completion behaves identical to\n+[`assert.doesNotThrow()`][].\n+\n+```js\n+(async () => {\n+  await assert.doesNotReject(\n+    async () => {\n+      throw new TypeError('Wrong value');\n+    },\n+    SyntaxError\n+  );\n+})();\n+```\n+\n+```js\n+assert.doesNotReject(\n+  () => Promise.reject(new TypeError('Wrong value')),\n+  SyntaxError\n+).then(() => {\n+  // ...\n+});\n+```\n+\n ## assert.doesNotThrow(block[, error][, message])\n <!-- YAML\n added: v0.1.21\n@@ -841,6 +878,48 @@ If the values are not strictly equal, an `AssertionError` is thrown with a\n `message` parameter is an instance of an [`Error`][] then it will be thrown\n instead of the `AssertionError`.\n \n+## assert.rejects(block[, error][, message])\n+<!-- YAML\n+added: REPLACEME\n+-->\n+* `block` {Function}\n+* `error` {RegExp|Function|Object}\n+* `message` {any}\n+\n+Awaits for promise returned by function `block` to be rejected.\n+\n+When `assert.rejects()` is called, it will immediately call the `block`\n+function, and awaits for completion.\n+\n+Besides the async nature to await the completion behaves identical to\n+[`assert.throws()`][].\n+\n+If specified, `error` can be a constructor, [`RegExp`][], a validation\n+function, or an object where each property will be tested for.\n+\n+If specified, `message` will be the message provided by the `AssertionError` if\n+the block fails to reject.\n+\n+```js\n+(async () => {\n+  await assert.rejects(\n+    async () => {\n+      throw new Error('Wrong value');\n+    },\n+    Error\n+  );\n+})();\n+```\n+\n+```js\n+assert.rejects(\n+  () => Promise.reject(new Error('Wrong value')),\n+  Error\n+).then(() => {\n+  // ...\n+});\n+```\n+\n ## assert.throws(block[, error][, message])\n <!-- YAML\n added: v0.1.21\n@@ -977,6 +1056,7 @@ second argument. This might lead to difficult-to-spot errors.\n [`assert.ok()`]: #assert_assert_ok_value_message\n [`assert.strictEqual()`]: #assert_assert_strictequal_actual_expected_message\n [`assert.throws()`]: #assert_assert_throws_block_error_message\n+[`assert.rejects()`]: #assert_assert_rejects_block_error_message\n [`strict mode`]: #assert_strict_mode\n [Abstract Equality Comparison]: https://tc39.github.io/ecma262/#sec-abstract-equality-comparison\n [Object.prototype.toString()]: https://tc39.github.io/ecma262/#sec-object.prototype.tostring"
        },
        {
            "sha": "b0d0d9ab4c0e3836ac307cb4fa3d7d99bdbe8449",
            "filename": "lib/assert.js",
            "status": "modified",
            "additions": 49,
            "deletions": 15,
            "changes": 64,
            "blob_url": "https://github.com/nodejs/node/blob/599337f43e0e0d66263e69d70edab26b61d3038a/lib%2Fassert.js",
            "raw_url": "https://github.com/nodejs/node/raw/599337f43e0e0d66263e69d70edab26b61d3038a/lib%2Fassert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fassert.js?ref=599337f43e0e0d66263e69d70edab26b61d3038a",
            "patch": "@@ -425,14 +425,23 @@ function getActual(block) {\n   return NO_EXCEPTION_SENTINEL;\n }\n \n-// Expected to throw an error.\n-assert.throws = function throws(block, error, message) {\n-  const actual = getActual(block);\n+async function waitForActual(block) {\n+  if (typeof block !== 'function') {\n+    throw new ERR_INVALID_ARG_TYPE('block', 'Function', block);\n+  }\n+  try {\n+    await block();\n+  } catch (e) {\n+    return e;\n+  }\n+  return NO_EXCEPTION_SENTINEL;\n+}\n \n+function expectsError(stackStartFn, actual, error, message) {\n   if (typeof error === 'string') {\n-    if (arguments.length === 3)\n+    if (arguments.length === 4) {\n       throw new ERR_INVALID_ARG_TYPE('error', ['Function', 'RegExp'], error);\n-\n+    }\n     message = error;\n     error = null;\n   }\n@@ -443,21 +452,21 @@ assert.throws = function throws(block, error, message) {\n       details += ` (${error.name})`;\n     }\n     details += message ? `: ${message}` : '.';\n+    const fnType = stackStartFn === rejects ? 'rejection' : 'exception';\n     innerFail({\n       actual,\n       expected: error,\n-      operator: 'throws',\n-      message: `Missing expected exception${details}`,\n-      stackStartFn: throws\n+      operator: stackStartFn.name,\n+      message: `Missing expected ${fnType}${details}`,\n+      stackStartFn\n     });\n   }\n   if (error && expectedException(actual, error, message) === false) {\n     throw actual;\n   }\n-};\n+}\n \n-assert.doesNotThrow = function doesNotThrow(block, error, message) {\n-  const actual = getActual(block);\n+function expectsNoError(stackStartFn, actual, error, message) {\n   if (actual === NO_EXCEPTION_SENTINEL)\n     return;\n \n@@ -468,16 +477,41 @@ assert.doesNotThrow = function doesNotThrow(block, error, message) {\n \n   if (!error || expectedException(actual, error)) {\n     const details = message ? `: ${message}` : '.';\n+    const fnType = stackStartFn === doesNotReject ? 'rejection' : 'exception';\n     innerFail({\n       actual,\n       expected: error,\n-      operator: 'doesNotThrow',\n-      message: `Got unwanted exception${details}\\n${actual && actual.message}`,\n-      stackStartFn: doesNotThrow\n+      operator: stackStartFn.name,\n+      message: `Got unwanted ${fnType}${details}\\n${actual && actual.message}`,\n+      stackStartFn\n     });\n   }\n   throw actual;\n-};\n+}\n+\n+function throws(block, ...args) {\n+  expectsError(throws, getActual(block), ...args);\n+}\n+\n+assert.throws = throws;\n+\n+async function rejects(block, ...args) {\n+  expectsError(rejects, await waitForActual(block), ...args);\n+}\n+\n+assert.rejects = rejects;\n+\n+function doesNotThrow(block, ...args) {\n+  expectsNoError(doesNotThrow, getActual(block), ...args);\n+}\n+\n+assert.doesNotThrow = doesNotThrow;\n+\n+async function doesNotReject(block, ...args) {\n+  expectsNoError(doesNotReject, await waitForActual(block), ...args);\n+}\n+\n+assert.doesNotReject = doesNotReject;\n \n assert.ifError = function ifError(err) {\n   if (err !== null && err !== undefined) {"
        },
        {
            "sha": "9fcde68bd5ae15efed7b04623d993b17f1a0cac1",
            "filename": "test/parallel/test-assert-async.js",
            "status": "added",
            "additions": 66,
            "deletions": 0,
            "changes": 66,
            "blob_url": "https://github.com/nodejs/node/blob/599337f43e0e0d66263e69d70edab26b61d3038a/test%2Fparallel%2Ftest-assert-async.js",
            "raw_url": "https://github.com/nodejs/node/raw/599337f43e0e0d66263e69d70edab26b61d3038a/test%2Fparallel%2Ftest-assert-async.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert-async.js?ref=599337f43e0e0d66263e69d70edab26b61d3038a",
            "patch": "@@ -0,0 +1,66 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const { promisify } = require('util');\n+const wait = promisify(setTimeout);\n+\n+/* eslint-disable prefer-common-expectserror, no-restricted-properties */\n+\n+// Test assert.rejects() and assert.doesNotReject() by checking their\n+// expected output and by verifying that they do not work sync\n+\n+assert.rejects(\n+  () => assert.fail(),\n+  common.expectsError({\n+    code: 'ERR_ASSERTION',\n+    type: assert.AssertionError,\n+    message: 'Failed'\n+  })\n+);\n+\n+assert.doesNotReject(() => {});\n+\n+{\n+  const promise = assert.rejects(async () => {\n+    await wait(1);\n+    assert.fail();\n+  }, common.expectsError({\n+    code: 'ERR_ASSERTION',\n+    type: assert.AssertionError,\n+    message: 'Failed'\n+  }));\n+  assert.doesNotReject(() => promise);\n+}\n+\n+{\n+  const promise = assert.doesNotReject(async () => {\n+    await wait(1);\n+    throw new Error();\n+  });\n+  assert.rejects(() => promise,\n+                 (err) => {\n+                   assert(err instanceof assert.AssertionError,\n+                          `${err.name} is not instance of AssertionError`);\n+                   assert.strictEqual(err.code, 'ERR_ASSERTION');\n+                   assert(/^Got unwanted rejection\\.\\n$/.test(err.message));\n+                   assert.strictEqual(err.operator, 'doesNotReject');\n+                   assert.ok(!err.stack.includes('at Function.doesNotReject'));\n+                   return true;\n+                 }\n+  );\n+}\n+\n+{\n+  const promise = assert.rejects(() => {});\n+  assert.rejects(() => promise,\n+                 (err) => {\n+                   assert(err instanceof assert.AssertionError,\n+                          `${err.name} is not instance of AssertionError`);\n+                   assert.strictEqual(err.code, 'ERR_ASSERTION');\n+                   assert(/^Missing expected rejection\\.$/.test(err.message));\n+                   assert.strictEqual(err.operator, 'rejects');\n+                   assert.ok(!err.stack.includes('at Function.rejects'));\n+                   return true;\n+                 }\n+  );\n+}"
        },
        {
            "sha": "9964c393edc7d8631d26dfea9d6ae1b305670b97",
            "filename": "test/parallel/test-assert.js",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/599337f43e0e0d66263e69d70edab26b61d3038a/test%2Fparallel%2Ftest-assert.js",
            "raw_url": "https://github.com/nodejs/node/raw/599337f43e0e0d66263e69d70edab26b61d3038a/test%2Fparallel%2Ftest-assert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert.js?ref=599337f43e0e0d66263e69d70edab26b61d3038a",
            "patch": "@@ -116,6 +116,7 @@ assert.throws(() => thrower(TypeError));\n   } catch (e) {\n     threw = true;\n     assert.ok(e instanceof a.AssertionError);\n+    assert.ok(!e.stack.includes('at Function.doesNotThrow'));\n   }\n   assert.ok(threw, 'a.doesNotThrow is not catching type matching errors');\n }\n@@ -221,6 +222,16 @@ a.throws(() => thrower(TypeError), (err) => {\n       code: 'ERR_ASSERTION',\n       message: /^Missing expected exception \\(TypeError\\): fhqwhgads$/\n     }));\n+\n+  let threw = false;\n+  try {\n+    a.throws(noop);\n+  } catch (e) {\n+    threw = true;\n+    assert.ok(e instanceof a.AssertionError);\n+    assert.ok(!e.stack.includes('at Function.throws'));\n+  }\n+  assert.ok(threw);\n }\n \n const circular = { y: 1 };"
        }
    ],
    "stats": {
        "total": 221,
        "additions": 206,
        "deletions": 15
    }
}