{
    "author": "unknown",
    "message": "deps: backport aa6ce3e from upstream V8\n\nOriginal commit message:\n\n    [log][api] introduce public CodeEventListener API\n\n    Introduce a new public API called CodeEventListener to allow\n    embedders to better support external profilers and other diagnostic\n    tools without relying on unsupported methods like --perf-basic-prof.\n\n    Bug: v8:7694\n    Cq-Include-Trybots: luci.chromium.try:linux_chromium_rel_ng\n    Change-Id: I063cc965394d59401358757634c9ea84c11517e9\n    Co-authored-by: Daniel Beckert <daniel@sthima.com.br>\n    Reviewed-on: https://chromium-review.googlesource.com/1028770\n    Commit-Queue: Yang Guo <yangguo@chromium.org>\n    Reviewed-by: Hannes Payer <hpayer@chromium.org>\n    Reviewed-by: Yang Guo <yangguo@chromium.org>\n    Reviewed-by: Andreas Haas <ahaas@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#53382}\n\nRefs: https://github.com/v8/v8/commit/aa6ce3ee617b2f324bea3a5d8e3263aee\n\nPR-URL: https://github.com/nodejs/node/pull/21126\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "b3627560a94eaf51262cc041aebc9ef150b5fcbc",
    "files": [
        {
            "sha": "15826a2195fc4875aab303b12da76bf80fedf735",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -27,7 +27,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.9',\n+    'v8_embedder_string': '-node.10',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "5df9b2a217ea8ed3021b6b6c86687c3b5355fc06",
            "filename": "deps/v8/include/v8-profiler.h",
            "status": "modified",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Finclude%2Fv8-profiler.h",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Finclude%2Fv8-profiler.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8-profiler.h?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -988,6 +988,76 @@ struct HeapStatsUpdate {\n   uint32_t size;  // New value of size field for the interval with this index.\n };\n \n+#define CODE_EVENTS_LIST(V) \\\n+  V(Builtin)                \\\n+  V(Callback)               \\\n+  V(Eval)                   \\\n+  V(Function)               \\\n+  V(InterpretedFunction)    \\\n+  V(Handler)                \\\n+  V(BytecodeHandler)        \\\n+  V(LazyCompile)            \\\n+  V(RegExp)                 \\\n+  V(Script)                 \\\n+  V(Stub)\n+\n+/**\n+ * Note that this enum may be extended in the future. Please include a default\n+ * case if this enum is used in a switch statement.\n+ */\n+enum CodeEventType {\n+  kUnknownType = 0\n+#define V(Name) , k##Name##Type\n+  CODE_EVENTS_LIST(V)\n+#undef V\n+};\n+\n+/**\n+ * Representation of a code creation event\n+ */\n+class V8_EXPORT CodeEvent {\n+ public:\n+  uintptr_t GetCodeStartAddress();\n+  size_t GetCodeSize();\n+  Local<String> GetFunctionName();\n+  Local<String> GetScriptName();\n+  int GetScriptLine();\n+  int GetScriptColumn();\n+  /**\n+   * NOTE (mmarchini): We can't allocate objects in the heap when we collect\n+   * existing code, and both the code type and the comment are not stored in the\n+   * heap, so we return those as const char*.\n+   */\n+  CodeEventType GetCodeType();\n+  const char* GetComment();\n+\n+  static const char* GetCodeEventTypeName(CodeEventType code_event_type);\n+};\n+\n+/**\n+ * Interface to listen to code creation events.\n+ */\n+class V8_EXPORT CodeEventHandler {\n+ public:\n+  /**\n+   * Creates a new listener for the |isolate|. The isolate must be initialized.\n+   * The listener object must be disposed after use by calling |Dispose| method.\n+   * Multiple listeners can be created for the same isolate.\n+   */\n+  explicit CodeEventHandler(Isolate* isolate);\n+  virtual ~CodeEventHandler();\n+\n+  virtual void Handle(CodeEvent* code_event) = 0;\n+\n+  void Enable();\n+  void Disable();\n+\n+ private:\n+  CodeEventHandler();\n+  CodeEventHandler(const CodeEventHandler&);\n+  CodeEventHandler& operator=(const CodeEventHandler&);\n+  void* internal_listener_;\n+};\n \n }  // namespace v8\n "
        },
        {
            "sha": "d101bc419a7c55a5080a27f7f1962a13512b0ab5",
            "filename": "deps/v8/src/api.cc",
            "status": "modified",
            "additions": 64,
            "deletions": 0,
            "changes": 64,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fapi.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fapi.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fapi.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -10211,6 +10211,70 @@ void CpuProfiler::SetIdle(bool is_idle) {\n   isolate->SetIdle(is_idle);\n }\n \n+uintptr_t CodeEvent::GetCodeStartAddress() {\n+  return reinterpret_cast<i::CodeEvent*>(this)->code_start_address;\n+}\n+\n+size_t CodeEvent::GetCodeSize() {\n+  return reinterpret_cast<i::CodeEvent*>(this)->code_size;\n+}\n+\n+Local<String> CodeEvent::GetFunctionName() {\n+  return ToApiHandle<String>(\n+      reinterpret_cast<i::CodeEvent*>(this)->function_name);\n+}\n+\n+Local<String> CodeEvent::GetScriptName() {\n+  return ToApiHandle<String>(\n+      reinterpret_cast<i::CodeEvent*>(this)->script_name);\n+}\n+\n+int CodeEvent::GetScriptLine() {\n+  return reinterpret_cast<i::CodeEvent*>(this)->script_line;\n+}\n+\n+int CodeEvent::GetScriptColumn() {\n+  return reinterpret_cast<i::CodeEvent*>(this)->script_column;\n+}\n+\n+CodeEventType CodeEvent::GetCodeType() {\n+  return reinterpret_cast<i::CodeEvent*>(this)->code_type;\n+}\n+\n+const char* CodeEvent::GetComment() {\n+  return reinterpret_cast<i::CodeEvent*>(this)->comment;\n+}\n+\n+const char* CodeEvent::GetCodeEventTypeName(CodeEventType code_event_type) {\n+  switch (code_event_type) {\n+    case kUnknownType:\n+      return \"Unknown\";\n+#define V(Name)       \\\n+  case k##Name##Type: \\\n+    return #Name;\n+      CODE_EVENTS_LIST(V)\n+#undef V\n+  }\n+}\n+\n+CodeEventHandler::CodeEventHandler(Isolate* isolate) {\n+  internal_listener_ =\n+      new i::ExternalCodeEventListener(reinterpret_cast<i::Isolate*>(isolate));\n+}\n+\n+CodeEventHandler::~CodeEventHandler() {\n+  delete reinterpret_cast<i::ExternalCodeEventListener*>(internal_listener_);\n+}\n+\n+void CodeEventHandler::Enable() {\n+  reinterpret_cast<i::ExternalCodeEventListener*>(internal_listener_)\n+      ->StartListening(this);\n+}\n+\n+void CodeEventHandler::Disable() {\n+  reinterpret_cast<i::ExternalCodeEventListener*>(internal_listener_)\n+      ->StopListening();\n+}\n \n static i::HeapGraphEdge* ToInternal(const HeapGraphEdge* edge) {\n   return const_cast<i::HeapGraphEdge*>("
        },
        {
            "sha": "caed5160f47a24e81a69b33934588f27f9f17007",
            "filename": "deps/v8/src/code-events.h",
            "status": "modified",
            "additions": 39,
            "deletions": 23,
            "changes": 62,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fcode-events.h",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fcode-events.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fcode-events.h?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -24,32 +24,38 @@ class WasmCode;\n using WasmName = Vector<const char>;\n }  // namespace wasm\n \n-#define LOG_EVENTS_AND_TAGS_LIST(V)                      \\\n-  V(CODE_CREATION_EVENT, \"code-creation\")                \\\n-  V(CODE_DISABLE_OPT_EVENT, \"code-disable-optimization\") \\\n-  V(CODE_MOVE_EVENT, \"code-move\")                        \\\n-  V(CODE_DELETE_EVENT, \"code-delete\")                    \\\n-  V(CODE_MOVING_GC, \"code-moving-gc\")                    \\\n-  V(SHARED_FUNC_MOVE_EVENT, \"sfi-move\")                  \\\n-  V(SNAPSHOT_CODE_NAME_EVENT, \"snapshot-code-name\")      \\\n-  V(TICK_EVENT, \"tick\")                                  \\\n-  V(BUILTIN_TAG, \"Builtin\")                              \\\n-  V(CALLBACK_TAG, \"Callback\")                            \\\n-  V(EVAL_TAG, \"Eval\")                                    \\\n-  V(FUNCTION_TAG, \"Function\")                            \\\n-  V(INTERPRETED_FUNCTION_TAG, \"InterpretedFunction\")     \\\n-  V(HANDLER_TAG, \"Handler\")                              \\\n-  V(BYTECODE_HANDLER_TAG, \"BytecodeHandler\")             \\\n-  V(LAZY_COMPILE_TAG, \"LazyCompile\")                     \\\n-  V(REG_EXP_TAG, \"RegExp\")                               \\\n-  V(SCRIPT_TAG, \"Script\")                                \\\n-  V(STUB_TAG, \"Stub\")                                    \\\n-  V(NATIVE_FUNCTION_TAG, \"Function\")                     \\\n-  V(NATIVE_LAZY_COMPILE_TAG, \"LazyCompile\")              \\\n-  V(NATIVE_SCRIPT_TAG, \"Script\")\n+#define LOG_EVENTS_LIST(V)                             \\\n+  V(CODE_CREATION_EVENT, code-creation)                \\\n+  V(CODE_DISABLE_OPT_EVENT, code-disable-optimization) \\\n+  V(CODE_MOVE_EVENT, code-move)                        \\\n+  V(CODE_DELETE_EVENT, code-delete)                    \\\n+  V(CODE_MOVING_GC, code-moving-gc)                    \\\n+  V(SHARED_FUNC_MOVE_EVENT, sfi-move)                  \\\n+  V(SNAPSHOT_CODE_NAME_EVENT, snapshot-code-name)      \\\n+  V(TICK_EVENT, tick)\n+\n+#define TAGS_LIST(V)                               \\\n+  V(BUILTIN_TAG, Builtin)                          \\\n+  V(CALLBACK_TAG, Callback)                        \\\n+  V(EVAL_TAG, Eval)                                \\\n+  V(FUNCTION_TAG, Function)                        \\\n+  V(INTERPRETED_FUNCTION_TAG, InterpretedFunction) \\\n+  V(HANDLER_TAG, Handler)                          \\\n+  V(BYTECODE_HANDLER_TAG, BytecodeHandler)         \\\n+  V(LAZY_COMPILE_TAG, LazyCompile)                 \\\n+  V(REG_EXP_TAG, RegExp)                           \\\n+  V(SCRIPT_TAG, Script)                            \\\n+  V(STUB_TAG, Stub)                                \\\n+  V(NATIVE_FUNCTION_TAG, Function)                 \\\n+  V(NATIVE_LAZY_COMPILE_TAG, LazyCompile)          \\\n+  V(NATIVE_SCRIPT_TAG, Script)\n // Note that 'NATIVE_' cases for functions and scripts are mapped onto\n // original tags when writing to the log.\n \n+#define LOG_EVENTS_AND_TAGS_LIST(V) \\\n+  LOG_EVENTS_LIST(V)                \\\n+  TAGS_LIST(V)\n+\n #define PROFILE(the_isolate, Call) (the_isolate)->code_event_dispatcher()->Call;\n \n class CodeEventListener {\n@@ -85,6 +91,8 @@ class CodeEventListener {\n   enum DeoptKind { kSoft, kLazy, kEager };\n   virtual void CodeDeoptEvent(Code* code, DeoptKind kind, Address pc,\n                               int fp_to_sp_delta) = 0;\n+\n+  virtual bool is_listening_to_code_events() { return false; }\n };\n \n class CodeEventDispatcher {\n@@ -101,6 +109,14 @@ class CodeEventDispatcher {\n     base::LockGuard<base::Mutex> guard(&mutex_);\n     listeners_.erase(listener);\n   }\n+  bool IsListeningToCodeEvents() {\n+    for (auto it : listeners_) {\n+      if (it->is_listening_to_code_events()) {\n+        return true;\n+      }\n+    }\n+    return false;\n+  }\n \n #define CODE_EVENT_DISPATCH(code)              \\\n   base::LockGuard<base::Mutex> guard(&mutex_); \\"
        },
        {
            "sha": "d63f03d358e3db47173a5f4bc552353eda6433ae",
            "filename": "deps/v8/src/compiler.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fcompiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fcompiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fcompiler.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -84,8 +84,9 @@ void LogFunctionCompilation(CodeEventListener::LogEventsAndTags tag,\n   // Log the code generation. If source information is available include\n   // script name and line number. Check explicitly whether logging is\n   // enabled as finding the line number is not free.\n-  if (!isolate->logger()->is_logging_code_events() &&\n-      !isolate->is_profiling() && !FLAG_log_function_events) {\n+  if (!isolate->logger()->is_listening_to_code_events() &&\n+      !isolate->is_profiling() && !FLAG_log_function_events &&\n+      !isolate->code_event_dispatcher()->IsListeningToCodeEvents()) {\n     return;\n   }\n "
        },
        {
            "sha": "85bedd3c53c86205fcf933d5ff13948d7a79e97b",
            "filename": "deps/v8/src/compiler/wasm-compiler.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fcompiler%2Fwasm-compiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fcompiler%2Fwasm-compiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fcompiler%2Fwasm-compiler.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -4625,7 +4625,8 @@ Node* WasmGraphBuilder::AtomicOp(wasm::WasmOpcode opcode, Node* const* inputs,\n \n namespace {\n bool must_record_function_compilation(Isolate* isolate) {\n-  return isolate->logger()->is_logging_code_events() || isolate->is_profiling();\n+  return isolate->logger()->is_listening_to_code_events() ||\n+         isolate->is_profiling();\n }\n \n PRINTF_FORMAT(4, 5)"
        },
        {
            "sha": "7784c3e3f6739681544eea41bd220156073589d9",
            "filename": "deps/v8/src/heap/mark-compact.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fheap%2Fmark-compact.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fheap%2Fmark-compact.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fheap%2Fmark-compact.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -2458,7 +2458,7 @@ void MarkCompactCollectorBase::CreateAndExecuteEvacuationTasks(\n \n   const bool profiling =\n       heap()->isolate()->is_profiling() ||\n-      heap()->isolate()->logger()->is_logging_code_events() ||\n+      heap()->isolate()->logger()->is_listening_to_code_events() ||\n       heap()->isolate()->heap_profiler()->is_tracking_object_moves() ||\n       heap()->has_heap_object_allocation_tracker();\n   ProfilingMigrationObserver profiling_observer(heap());"
        },
        {
            "sha": "7ef0214f4a646268c7da9438d217867302af1866",
            "filename": "deps/v8/src/isolate.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fisolate.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fisolate.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fisolate.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -2883,7 +2883,7 @@ void CreateOffHeapTrampolines(Isolate* isolate) {\n     // thus collected by the GC.\n     builtins->set_builtin(i, *trampoline);\n \n-    if (isolate->logger()->is_logging_code_events() ||\n+    if (isolate->logger()->is_listening_to_code_events() ||\n         isolate->is_profiling()) {\n       isolate->logger()->LogCodeObject(*trampoline);\n     }"
        },
        {
            "sha": "99d8f530f0b148a792a6489a340c6069214b40dc",
            "filename": "deps/v8/src/isolate.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fisolate.h",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fisolate.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fisolate.h?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -56,6 +56,7 @@ class BuiltinsConstantsTableBuilder;\n class CallInterfaceDescriptorData;\n class CancelableTaskManager;\n class CodeEventDispatcher;\n+class ExternalCodeEventListener;\n class CodeGenerator;\n class CodeRange;\n class CodeStubDescriptor;"
        },
        {
            "sha": "38967a34696ddaba91512d6eb5bd54db0ca980fd",
            "filename": "deps/v8/src/log.cc",
            "status": "modified",
            "additions": 348,
            "deletions": 162,
            "changes": 510,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Flog.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Flog.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Flog.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -40,11 +40,33 @@\n namespace v8 {\n namespace internal {\n \n-#define DECLARE_EVENT(ignore1, name) name,\n+#define DECLARE_EVENT(ignore1, name) #name,\n static const char* kLogEventsNames[CodeEventListener::NUMBER_OF_LOG_EVENTS] = {\n     LOG_EVENTS_AND_TAGS_LIST(DECLARE_EVENT)};\n #undef DECLARE_EVENT\n \n+static v8::CodeEventType GetCodeEventTypeForTag(\n+    CodeEventListener::LogEventsAndTags tag) {\n+  switch (tag) {\n+    case CodeEventListener::NUMBER_OF_LOG_EVENTS:\n+#define V(Event, _) case CodeEventListener::Event:\n+      LOG_EVENTS_LIST(V)\n+#undef V\n+      return v8::CodeEventType::kUnknownType;\n+#define V(From, To)             \\\n+  case CodeEventListener::From: \\\n+    return v8::CodeEventType::k##To##Type;\n+      TAGS_LIST(V)\n+#undef V\n+  }\n+}\n+#define CALL_CODE_EVENT_HANDLER(Call) \\\n+  if (listener_) {                    \\\n+    listener_->Call;                  \\\n+  } else {                            \\\n+    PROFILE(isolate_, Call);          \\\n+  }\n+\n static const char* ComputeMarker(SharedFunctionInfo* shared,\n                                  AbstractCode* code) {\n   switch (code->kind()) {\n@@ -321,9 +343,147 @@ void PerfBasicLogger::LogRecordedBuffer(const wasm::WasmCode* code,\n       code->instructions().length(), name, length);\n }\n \n-// Low-level logging support.\n-#define LL_LOG(Call) if (ll_logger_) ll_logger_->Call;\n+// External CodeEventListener\n+ExternalCodeEventListener::ExternalCodeEventListener(Isolate* isolate)\n+    : is_listening_(false), isolate_(isolate), code_event_handler_(nullptr) {}\n+\n+ExternalCodeEventListener::~ExternalCodeEventListener() {\n+  if (is_listening_) {\n+    StopListening();\n+  }\n+}\n+\n+void ExternalCodeEventListener::LogExistingCode() {\n+  HandleScope scope(isolate_);\n+  ExistingCodeLogger logger(isolate_, this);\n+  logger.LogCodeObjects();\n+  logger.LogBytecodeHandlers();\n+  logger.LogCompiledFunctions();\n+}\n+\n+void ExternalCodeEventListener::StartListening(\n+    CodeEventHandler* code_event_handler) {\n+  if (is_listening_ || code_event_handler == nullptr) {\n+    return;\n+  }\n+  code_event_handler_ = code_event_handler;\n+  is_listening_ = isolate_->code_event_dispatcher()->AddListener(this);\n+  if (is_listening_) {\n+    LogExistingCode();\n+  }\n+}\n \n+void ExternalCodeEventListener::StopListening() {\n+  if (!is_listening_) {\n+    return;\n+  }\n+\n+  isolate_->code_event_dispatcher()->RemoveListener(this);\n+  is_listening_ = false;\n+}\n+\n+void ExternalCodeEventListener::CodeCreateEvent(\n+    CodeEventListener::LogEventsAndTags tag, AbstractCode* code,\n+    const char* comment) {\n+  CodeEvent code_event;\n+  code_event.code_start_address =\n+      reinterpret_cast<uintptr_t>(code->InstructionStart());\n+  code_event.code_size = static_cast<size_t>(code->InstructionSize());\n+  code_event.function_name = isolate_->factory()->empty_string();\n+  code_event.script_name = isolate_->factory()->empty_string();\n+  code_event.script_line = 0;\n+  code_event.script_column = 0;\n+  code_event.code_type = GetCodeEventTypeForTag(tag);\n+  code_event.comment = comment;\n+\n+  code_event_handler_->Handle(reinterpret_cast<v8::CodeEvent*>(&code_event));\n+}\n+\n+void ExternalCodeEventListener::CodeCreateEvent(\n+    CodeEventListener::LogEventsAndTags tag, AbstractCode* code, Name* name) {\n+  Handle<String> name_string =\n+      Name::ToFunctionName(Handle<Name>(name, isolate_)).ToHandleChecked();\n+\n+  CodeEvent code_event;\n+  code_event.code_start_address =\n+      reinterpret_cast<uintptr_t>(code->InstructionStart());\n+  code_event.code_size = static_cast<size_t>(code->InstructionSize());\n+  code_event.function_name = name_string;\n+  code_event.script_name = isolate_->factory()->empty_string();\n+  code_event.script_line = 0;\n+  code_event.script_column = 0;\n+  code_event.code_type = GetCodeEventTypeForTag(tag);\n+  code_event.comment = \"\";\n+\n+  code_event_handler_->Handle(reinterpret_cast<v8::CodeEvent*>(&code_event));\n+}\n+\n+void ExternalCodeEventListener::CodeCreateEvent(\n+    CodeEventListener::LogEventsAndTags tag, AbstractCode* code,\n+    SharedFunctionInfo* shared, Name* name) {\n+  Handle<String> name_string =\n+      Name::ToFunctionName(Handle<Name>(name, isolate_)).ToHandleChecked();\n+\n+  CodeEvent code_event;\n+  code_event.code_start_address =\n+      reinterpret_cast<uintptr_t>(code->InstructionStart());\n+  code_event.code_size = static_cast<size_t>(code->InstructionSize());\n+  code_event.function_name = name_string;\n+  code_event.script_name = isolate_->factory()->empty_string();\n+  code_event.script_line = 0;\n+  code_event.script_column = 0;\n+  code_event.code_type = GetCodeEventTypeForTag(tag);\n+  code_event.comment = \"\";\n+\n+  code_event_handler_->Handle(reinterpret_cast<v8::CodeEvent*>(&code_event));\n+}\n+\n+void ExternalCodeEventListener::CodeCreateEvent(\n+    CodeEventListener::LogEventsAndTags tag, AbstractCode* code,\n+    SharedFunctionInfo* shared, Name* source, int line, int column) {\n+  Handle<String> name_string =\n+      Name::ToFunctionName(Handle<Name>(shared->Name(), isolate_))\n+          .ToHandleChecked();\n+  Handle<String> source_string =\n+      Name::ToFunctionName(Handle<Name>(source, isolate_)).ToHandleChecked();\n+\n+  CodeEvent code_event;\n+  code_event.code_start_address =\n+      reinterpret_cast<uintptr_t>(code->InstructionStart());\n+  code_event.code_size = static_cast<size_t>(code->InstructionSize());\n+  code_event.function_name = name_string;\n+  code_event.script_name = source_string;\n+  code_event.script_line = line;\n+  code_event.script_column = column;\n+  code_event.code_type = GetCodeEventTypeForTag(tag);\n+  code_event.comment = \"\";\n+\n+  code_event_handler_->Handle(reinterpret_cast<v8::CodeEvent*>(&code_event));\n+}\n+\n+void ExternalCodeEventListener::CodeCreateEvent(LogEventsAndTags tag,\n+                                                const wasm::WasmCode* code,\n+                                                wasm::WasmName name) {\n+  // TODO(mmarchini): handle later\n+}\n+\n+void ExternalCodeEventListener::RegExpCodeCreateEvent(AbstractCode* code,\n+                                                      String* source) {\n+  CodeEvent code_event;\n+  code_event.code_start_address =\n+      reinterpret_cast<uintptr_t>(code->InstructionStart());\n+  code_event.code_size = static_cast<size_t>(code->InstructionSize());\n+  code_event.function_name = Handle<String>(source, isolate_);\n+  code_event.script_name = isolate_->factory()->empty_string();\n+  code_event.script_line = 0;\n+  code_event.script_column = 0;\n+  code_event.code_type = GetCodeEventTypeForTag(CodeEventListener::REG_EXP_TAG);\n+  code_event.comment = \"\";\n+\n+  code_event_handler_->Handle(reinterpret_cast<v8::CodeEvent*>(&code_event));\n+}\n+\n+// Low-level logging support.\n class LowLevelLogger : public CodeEventLogger {\n  public:\n   explicit LowLevelLogger(const char* file_name);\n@@ -810,7 +970,8 @@ Logger::Logger(Isolate* isolate)\n       perf_jit_logger_(nullptr),\n       ll_logger_(nullptr),\n       jit_logger_(nullptr),\n-      is_initialized_(false) {}\n+      is_initialized_(false),\n+      existing_code_logger_(isolate) {}\n \n Logger::~Logger() {\n   delete log_;\n@@ -1079,7 +1240,7 @@ void AppendCodeCreateHeader(Log::MessageBuilder& msg,\n \n void Logger::CodeCreateEvent(CodeEventListener::LogEventsAndTags tag,\n                              AbstractCode* code, const char* comment) {\n-  if (!is_logging_code_events()) return;\n+  if (!is_listening_to_code_events()) return;\n   if (!FLAG_log_code || !log_->IsEnabled()) return;\n   Log::MessageBuilder msg(log_);\n   AppendCodeCreateHeader(msg, tag, code, &timer_);\n@@ -1089,7 +1250,7 @@ void Logger::CodeCreateEvent(CodeEventListener::LogEventsAndTags tag,\n \n void Logger::CodeCreateEvent(CodeEventListener::LogEventsAndTags tag,\n                              AbstractCode* code, Name* name) {\n-  if (!is_logging_code_events()) return;\n+  if (!is_listening_to_code_events()) return;\n   if (!FLAG_log_code || !log_->IsEnabled()) return;\n   Log::MessageBuilder msg(log_);\n   AppendCodeCreateHeader(msg, tag, code, &timer_);\n@@ -1100,7 +1261,7 @@ void Logger::CodeCreateEvent(CodeEventListener::LogEventsAndTags tag,\n void Logger::CodeCreateEvent(CodeEventListener::LogEventsAndTags tag,\n                              AbstractCode* code, SharedFunctionInfo* shared,\n                              Name* name) {\n-  if (!is_logging_code_events()) return;\n+  if (!is_listening_to_code_events()) return;\n   if (!FLAG_log_code || !log_->IsEnabled()) return;\n   if (code == AbstractCode::cast(\n                   isolate_->builtins()->builtin(Builtins::kCompileLazy))) {\n@@ -1116,7 +1277,7 @@ void Logger::CodeCreateEvent(CodeEventListener::LogEventsAndTags tag,\n \n void Logger::CodeCreateEvent(CodeEventListener::LogEventsAndTags tag,\n                              const wasm::WasmCode* code, wasm::WasmName name) {\n-  if (!is_logging_code_events()) return;\n+  if (!is_listening_to_code_events()) return;\n   if (!FLAG_log_code || !log_->IsEnabled()) return;\n   Log::MessageBuilder msg(log_);\n   AppendCodeCreateHeader(msg, tag, AbstractCode::Kind::WASM_FUNCTION,\n@@ -1144,7 +1305,7 @@ void Logger::CodeCreateEvent(CodeEventListener::LogEventsAndTags tag,\n void Logger::CodeCreateEvent(CodeEventListener::LogEventsAndTags tag,\n                              AbstractCode* code, SharedFunctionInfo* shared,\n                              Name* source, int line, int column) {\n-  if (!is_logging_code_events()) return;\n+  if (!is_listening_to_code_events()) return;\n   if (!FLAG_log_code || !log_->IsEnabled()) return;\n \n   Log::MessageBuilder msg(log_);\n@@ -1260,7 +1421,7 @@ void Logger::CodeCreateEvent(CodeEventListener::LogEventsAndTags tag,\n \n void Logger::CodeDisableOptEvent(AbstractCode* code,\n                                  SharedFunctionInfo* shared) {\n-  if (!is_logging_code_events()) return;\n+  if (!is_listening_to_code_events()) return;\n   if (!FLAG_log_code || !log_->IsEnabled()) return;\n   Log::MessageBuilder msg(log_);\n   msg << kLogEventsNames[CodeEventListener::CODE_DISABLE_OPT_EVENT] << kNext\n@@ -1271,13 +1432,13 @@ void Logger::CodeDisableOptEvent(AbstractCode* code,\n \n \n void Logger::CodeMovingGCEvent() {\n-  if (!is_logging_code_events()) return;\n+  if (!is_listening_to_code_events()) return;\n   if (!log_->IsEnabled() || !FLAG_ll_prof) return;\n   base::OS::SignalCodeMovingGC();\n }\n \n void Logger::RegExpCodeCreateEvent(AbstractCode* code, String* source) {\n-  if (!is_logging_code_events()) return;\n+  if (!is_listening_to_code_events()) return;\n   if (!FLAG_log_code || !log_->IsEnabled()) return;\n   Log::MessageBuilder msg(log_);\n   AppendCodeCreateHeader(msg, CodeEventListener::REG_EXP_TAG, code, &timer_);\n@@ -1286,7 +1447,7 @@ void Logger::RegExpCodeCreateEvent(AbstractCode* code, String* source) {\n }\n \n void Logger::CodeMoveEvent(AbstractCode* from, Address to) {\n-  if (!is_logging_code_events()) return;\n+  if (!is_listening_to_code_events()) return;\n   MoveEventInternal(CodeEventListener::CODE_MOVE_EVENT, from->address(), to);\n }\n \n@@ -1335,7 +1496,7 @@ void Logger::CodeNameEvent(Address addr, int pos, const char* code_name) {\n \n \n void Logger::SharedFunctionInfoMoveEvent(Address from, Address to) {\n-  if (!is_logging_code_events()) return;\n+  if (!is_listening_to_code_events()) return;\n   MoveEventInternal(CodeEventListener::SHARED_FUNC_MOVE_EVENT, from, to);\n }\n \n@@ -1625,170 +1786,28 @@ static int EnumerateWasmModules(Heap* heap,\n }\n \n void Logger::LogCodeObject(Object* object) {\n-  AbstractCode* code_object = AbstractCode::cast(object);\n-  CodeEventListener::LogEventsAndTags tag = CodeEventListener::STUB_TAG;\n-  const char* description = \"Unknown code from the snapshot\";\n-  switch (code_object->kind()) {\n-    case AbstractCode::INTERPRETED_FUNCTION:\n-    case AbstractCode::OPTIMIZED_FUNCTION:\n-      return;  // We log this later using LogCompiledFunctions.\n-    case AbstractCode::BYTECODE_HANDLER:\n-      return;  // We log it later by walking the dispatch table.\n-    case AbstractCode::STUB:\n-      description =\n-          CodeStub::MajorName(CodeStub::GetMajorKey(code_object->GetCode()));\n-      if (description == nullptr) description = \"A stub from the snapshot\";\n-      tag = CodeEventListener::STUB_TAG;\n-      break;\n-    case AbstractCode::REGEXP:\n-      description = \"Regular expression code\";\n-      tag = CodeEventListener::REG_EXP_TAG;\n-      break;\n-    case AbstractCode::BUILTIN:\n-      description =\n-          isolate_->builtins()->name(code_object->GetCode()->builtin_index());\n-      tag = CodeEventListener::BUILTIN_TAG;\n-      break;\n-    case AbstractCode::WASM_FUNCTION:\n-      description = \"A Wasm function\";\n-      tag = CodeEventListener::FUNCTION_TAG;\n-      break;\n-    case AbstractCode::JS_TO_WASM_FUNCTION:\n-      description = \"A JavaScript to Wasm adapter\";\n-      tag = CodeEventListener::STUB_TAG;\n-      break;\n-    case AbstractCode::WASM_TO_JS_FUNCTION:\n-      description = \"A Wasm to JavaScript adapter\";\n-      tag = CodeEventListener::STUB_TAG;\n-      break;\n-    case AbstractCode::WASM_INTERPRETER_ENTRY:\n-      description = \"A Wasm to Interpreter adapter\";\n-      tag = CodeEventListener::STUB_TAG;\n-      break;\n-    case AbstractCode::C_WASM_ENTRY:\n-      description = \"A C to Wasm entry stub\";\n-      tag = CodeEventListener::STUB_TAG;\n-      break;\n-    case AbstractCode::NUMBER_OF_KINDS:\n-      UNIMPLEMENTED();\n-  }\n-  PROFILE(isolate_, CodeCreateEvent(tag, code_object, description));\n+  existing_code_logger_.LogCodeObject(object);\n }\n \n-void Logger::LogCodeObjects() {\n-  Heap* heap = isolate_->heap();\n-  HeapIterator iterator(heap);\n-  DisallowHeapAllocation no_gc;\n-  for (HeapObject* obj = iterator.next(); obj != nullptr;\n-       obj = iterator.next()) {\n-    if (obj->IsCode()) LogCodeObject(obj);\n-    if (obj->IsBytecodeArray()) LogCodeObject(obj);\n-  }\n-}\n+void Logger::LogCodeObjects() { existing_code_logger_.LogCodeObjects(); }\n \n void Logger::LogBytecodeHandler(interpreter::Bytecode bytecode,\n                                 interpreter::OperandScale operand_scale,\n                                 Code* code) {\n-  std::string bytecode_name =\n-      interpreter::Bytecodes::ToString(bytecode, operand_scale);\n-  PROFILE(isolate_,\n-          CodeCreateEvent(CodeEventListener::BYTECODE_HANDLER_TAG,\n-                          AbstractCode::cast(code), bytecode_name.c_str()));\n+  existing_code_logger_.LogBytecodeHandler(bytecode, operand_scale, code);\n }\n \n void Logger::LogBytecodeHandlers() {\n-  const interpreter::OperandScale kOperandScales[] = {\n-#define VALUE(Name, _) interpreter::OperandScale::k##Name,\n-      OPERAND_SCALE_LIST(VALUE)\n-#undef VALUE\n-  };\n-\n-  const int last_index = static_cast<int>(interpreter::Bytecode::kLast);\n-  interpreter::Interpreter* interpreter = isolate_->interpreter();\n-  for (auto operand_scale : kOperandScales) {\n-    for (int index = 0; index <= last_index; ++index) {\n-      interpreter::Bytecode bytecode = interpreter::Bytecodes::FromByte(index);\n-      if (interpreter::Bytecodes::BytecodeHasHandler(bytecode, operand_scale)) {\n-        Code* code = interpreter->GetBytecodeHandler(bytecode, operand_scale);\n-        if (isolate_->heap()->IsDeserializeLazyHandler(code)) continue;\n-        LogBytecodeHandler(bytecode, operand_scale, code);\n-      }\n-    }\n-  }\n+  existing_code_logger_.LogBytecodeHandlers();\n }\n \n void Logger::LogExistingFunction(Handle<SharedFunctionInfo> shared,\n                                  Handle<AbstractCode> code) {\n-  if (shared->script()->IsScript()) {\n-    Handle<Script> script(Script::cast(shared->script()));\n-    int line_num = Script::GetLineNumber(script, shared->StartPosition()) + 1;\n-    int column_num =\n-        Script::GetColumnNumber(script, shared->StartPosition()) + 1;\n-    if (script->name()->IsString()) {\n-      Handle<String> script_name(String::cast(script->name()));\n-      if (line_num > 0) {\n-        PROFILE(isolate_,\n-                CodeCreateEvent(\n-                    Logger::ToNativeByScript(\n-                        CodeEventListener::LAZY_COMPILE_TAG, *script),\n-                    *code, *shared, *script_name, line_num, column_num));\n-      } else {\n-        // Can't distinguish eval and script here, so always use Script.\n-        PROFILE(isolate_,\n-                CodeCreateEvent(Logger::ToNativeByScript(\n-                                    CodeEventListener::SCRIPT_TAG, *script),\n-                                *code, *shared, *script_name));\n-      }\n-    } else {\n-      PROFILE(isolate_,\n-              CodeCreateEvent(Logger::ToNativeByScript(\n-                                  CodeEventListener::LAZY_COMPILE_TAG, *script),\n-                              *code, *shared, isolate_->heap()->empty_string(),\n-                              line_num, column_num));\n-    }\n-  } else if (shared->IsApiFunction()) {\n-    // API function.\n-    FunctionTemplateInfo* fun_data = shared->get_api_func_data();\n-    Object* raw_call_data = fun_data->call_code();\n-    if (!raw_call_data->IsUndefined(isolate_)) {\n-      CallHandlerInfo* call_data = CallHandlerInfo::cast(raw_call_data);\n-      Object* callback_obj = call_data->callback();\n-      Address entry_point = v8::ToCData<Address>(callback_obj);\n-#if USES_FUNCTION_DESCRIPTORS\n-      entry_point = *FUNCTION_ENTRYPOINT_ADDRESS(entry_point);\n-#endif\n-      PROFILE(isolate_, CallbackEvent(shared->DebugName(), entry_point));\n-    }\n-  } else {\n-    PROFILE(isolate_,\n-            CodeCreateEvent(CodeEventListener::LAZY_COMPILE_TAG, *code, *shared,\n-                            isolate_->heap()->empty_string()));\n-  }\n+  existing_code_logger_.LogExistingFunction(shared, code);\n }\n \n void Logger::LogCompiledFunctions() {\n-  Heap* heap = isolate_->heap();\n-  HandleScope scope(isolate_);\n-  const int compiled_funcs_count =\n-      EnumerateCompiledFunctions(heap, nullptr, nullptr);\n-  ScopedVector<Handle<SharedFunctionInfo>> sfis(compiled_funcs_count);\n-  ScopedVector<Handle<AbstractCode> > code_objects(compiled_funcs_count);\n-  EnumerateCompiledFunctions(heap, sfis.start(), code_objects.start());\n-\n-  // During iteration, there can be heap allocation due to\n-  // GetScriptLineNumber call.\n-  for (int i = 0; i < compiled_funcs_count; ++i) {\n-    if (code_objects[i].is_identical_to(BUILTIN_CODE(isolate_, CompileLazy)))\n-      continue;\n-    LogExistingFunction(sfis[i], code_objects[i]);\n-  }\n-\n-  const int compiled_wasm_modules_count = EnumerateWasmModules(heap, nullptr);\n-  ScopedVector<Handle<WasmCompiledModule>> modules(compiled_wasm_modules_count);\n-  EnumerateWasmModules(heap, modules.start());\n-  for (int i = 0; i < compiled_wasm_modules_count; ++i) {\n-    modules[i]->LogWasmCodes(isolate_);\n-  }\n+  existing_code_logger_.LogCompiledFunctions();\n }\n \n void Logger::LogAccessorCallbacks() {\n@@ -2011,5 +2030,172 @@ FILE* Logger::TearDown() {\n   return log_->Close();\n }\n \n+void ExistingCodeLogger::LogCodeObject(Object* object) {\n+  AbstractCode* code_object = AbstractCode::cast(object);\n+  CodeEventListener::LogEventsAndTags tag = CodeEventListener::STUB_TAG;\n+  const char* description = \"Unknown code from before profiling\";\n+  switch (code_object->kind()) {\n+    case AbstractCode::INTERPRETED_FUNCTION:\n+    case AbstractCode::OPTIMIZED_FUNCTION:\n+      return;  // We log this later using LogCompiledFunctions.\n+    case AbstractCode::BYTECODE_HANDLER:\n+      return;  // We log it later by walking the dispatch table.\n+    case AbstractCode::STUB:\n+      description =\n+          CodeStub::MajorName(CodeStub::GetMajorKey(code_object->GetCode()));\n+      if (description == nullptr) description = \"A stub from before profiling\";\n+      tag = CodeEventListener::STUB_TAG;\n+      break;\n+    case AbstractCode::REGEXP:\n+      description = \"Regular expression code\";\n+      tag = CodeEventListener::REG_EXP_TAG;\n+      break;\n+    case AbstractCode::BUILTIN:\n+      description =\n+          isolate_->builtins()->name(code_object->GetCode()->builtin_index());\n+      tag = CodeEventListener::BUILTIN_TAG;\n+      break;\n+    case AbstractCode::WASM_FUNCTION:\n+      description = \"A Wasm function\";\n+      tag = CodeEventListener::FUNCTION_TAG;\n+      break;\n+    case AbstractCode::JS_TO_WASM_FUNCTION:\n+      description = \"A JavaScript to Wasm adapter\";\n+      tag = CodeEventListener::STUB_TAG;\n+      break;\n+    case AbstractCode::WASM_TO_JS_FUNCTION:\n+      description = \"A Wasm to JavaScript adapter\";\n+      tag = CodeEventListener::STUB_TAG;\n+      break;\n+    case AbstractCode::WASM_INTERPRETER_ENTRY:\n+      description = \"A Wasm to Interpreter adapter\";\n+      tag = CodeEventListener::STUB_TAG;\n+      break;\n+    case AbstractCode::C_WASM_ENTRY:\n+      description = \"A C to Wasm entry stub\";\n+      tag = CodeEventListener::STUB_TAG;\n+      break;\n+    case AbstractCode::NUMBER_OF_KINDS:\n+      UNIMPLEMENTED();\n+  }\n+  CALL_CODE_EVENT_HANDLER(CodeCreateEvent(tag, code_object, description))\n+}\n+\n+void ExistingCodeLogger::LogCodeObjects() {\n+  Heap* heap = isolate_->heap();\n+  HeapIterator iterator(heap);\n+  DisallowHeapAllocation no_gc;\n+  for (HeapObject* obj = iterator.next(); obj != nullptr;\n+       obj = iterator.next()) {\n+    if (obj->IsCode()) LogCodeObject(obj);\n+    if (obj->IsBytecodeArray()) LogCodeObject(obj);\n+  }\n+}\n+\n+void ExistingCodeLogger::LogCompiledFunctions() {\n+  Heap* heap = isolate_->heap();\n+  HandleScope scope(isolate_);\n+  const int compiled_funcs_count =\n+      EnumerateCompiledFunctions(heap, nullptr, nullptr);\n+  ScopedVector<Handle<SharedFunctionInfo>> sfis(compiled_funcs_count);\n+  ScopedVector<Handle<AbstractCode>> code_objects(compiled_funcs_count);\n+  EnumerateCompiledFunctions(heap, sfis.start(), code_objects.start());\n+\n+  // During iteration, there can be heap allocation due to\n+  // GetScriptLineNumber call.\n+  for (int i = 0; i < compiled_funcs_count; ++i) {\n+    if (code_objects[i].is_identical_to(BUILTIN_CODE(isolate_, CompileLazy)))\n+      continue;\n+    LogExistingFunction(sfis[i], code_objects[i]);\n+  }\n+\n+  const int compiled_wasm_modules_count = EnumerateWasmModules(heap, nullptr);\n+  ScopedVector<Handle<WasmCompiledModule>> modules(compiled_wasm_modules_count);\n+  EnumerateWasmModules(heap, modules.start());\n+  for (int i = 0; i < compiled_wasm_modules_count; ++i) {\n+    modules[i]->LogWasmCodes(isolate_);\n+  }\n+}\n+\n+void ExistingCodeLogger::LogBytecodeHandler(\n+    interpreter::Bytecode bytecode, interpreter::OperandScale operand_scale,\n+    Code* code) {\n+  std::string bytecode_name =\n+      interpreter::Bytecodes::ToString(bytecode, operand_scale);\n+  CALL_CODE_EVENT_HANDLER(\n+      CodeCreateEvent(CodeEventListener::BYTECODE_HANDLER_TAG,\n+                      AbstractCode::cast(code), bytecode_name.c_str()))\n+}\n+\n+void ExistingCodeLogger::LogBytecodeHandlers() {\n+  const interpreter::OperandScale kOperandScales[] = {\n+#define VALUE(Name, _) interpreter::OperandScale::k##Name,\n+      OPERAND_SCALE_LIST(VALUE)\n+#undef VALUE\n+  };\n+\n+  const int last_index = static_cast<int>(interpreter::Bytecode::kLast);\n+  interpreter::Interpreter* interpreter = isolate_->interpreter();\n+  for (auto operand_scale : kOperandScales) {\n+    for (int index = 0; index <= last_index; ++index) {\n+      interpreter::Bytecode bytecode = interpreter::Bytecodes::FromByte(index);\n+      if (interpreter::Bytecodes::BytecodeHasHandler(bytecode, operand_scale)) {\n+        Code* code = interpreter->GetBytecodeHandler(bytecode, operand_scale);\n+        if (isolate_->heap()->IsDeserializeLazyHandler(code)) continue;\n+        LogBytecodeHandler(bytecode, operand_scale, code);\n+      }\n+    }\n+  }\n+}\n+\n+void ExistingCodeLogger::LogExistingFunction(Handle<SharedFunctionInfo> shared,\n+                                             Handle<AbstractCode> code) {\n+  if (shared->script()->IsScript()) {\n+    Handle<Script> script(Script::cast(shared->script()));\n+    int line_num = Script::GetLineNumber(script, shared->StartPosition()) + 1;\n+    int column_num =\n+        Script::GetColumnNumber(script, shared->StartPosition()) + 1;\n+    if (script->name()->IsString()) {\n+      Handle<String> script_name(String::cast(script->name()));\n+      if (line_num > 0) {\n+        CALL_CODE_EVENT_HANDLER(\n+            CodeCreateEvent(Logger::ToNativeByScript(\n+                                CodeEventListener::LAZY_COMPILE_TAG, *script),\n+                            *code, *shared, *script_name, line_num, column_num))\n+      } else {\n+        // Can't distinguish eval and script here, so always use Script.\n+        CALL_CODE_EVENT_HANDLER(CodeCreateEvent(\n+            Logger::ToNativeByScript(CodeEventListener::SCRIPT_TAG, *script),\n+            *code, *shared, *script_name))\n+      }\n+    } else {\n+      CALL_CODE_EVENT_HANDLER(\n+          CodeCreateEvent(Logger::ToNativeByScript(\n+                              CodeEventListener::LAZY_COMPILE_TAG, *script),\n+                          *code, *shared, isolate_->heap()->empty_string(),\n+                          line_num, column_num))\n+    }\n+  } else if (shared->IsApiFunction()) {\n+    // API function.\n+    FunctionTemplateInfo* fun_data = shared->get_api_func_data();\n+    Object* raw_call_data = fun_data->call_code();\n+    if (!raw_call_data->IsUndefined(isolate_)) {\n+      CallHandlerInfo* call_data = CallHandlerInfo::cast(raw_call_data);\n+      Object* callback_obj = call_data->callback();\n+      Address entry_point = v8::ToCData<Address>(callback_obj);\n+#if USES_FUNCTION_DESCRIPTORS\n+      entry_point = *FUNCTION_ENTRYPOINT_ADDRESS(entry_point);\n+#endif\n+      CALL_CODE_EVENT_HANDLER(CallbackEvent(shared->DebugName(), entry_point))\n+    }\n+  } else {\n+    CALL_CODE_EVENT_HANDLER(CodeCreateEvent(CodeEventListener::LAZY_COMPILE_TAG,\n+                                            *code, *shared,\n+                                            isolate_->heap()->empty_string()))\n+  }\n+}\n+\n+#undef CALL_CODE_EVENT_HANDLER\n+\n }  // namespace internal\n }  // namespace v8"
        },
        {
            "sha": "fefc4b1a2d123a1c74a147629bba3e7aca00474b",
            "filename": "deps/v8/src/log.h",
            "status": "modified",
            "additions": 81,
            "deletions": 5,
            "changes": 86,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Flog.h",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Flog.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Flog.h?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -8,6 +8,7 @@\n #include <set>\n #include <string>\n \n+#include \"include/v8-profiler.h\"\n #include \"src/allocation.h\"\n #include \"src/base/compiler-specific.h\"\n #include \"src/base/platform/elapsed-timer.h\"\n@@ -87,12 +88,33 @@ class WasmCode;\n     if (logger->is_logging()) logger->Call;             \\\n   } while (false)\n \n-#define LOG_CODE_EVENT(isolate, Call)                   \\\n-  do {                                                  \\\n-    v8::internal::Logger* logger = (isolate)->logger(); \\\n-    if (logger->is_logging_code_events()) logger->Call; \\\n+#define LOG_CODE_EVENT(isolate, Call)                        \\\n+  do {                                                       \\\n+    v8::internal::Logger* logger = (isolate)->logger();      \\\n+    if (logger->is_listening_to_code_events()) logger->Call; \\\n   } while (false)\n \n+class ExistingCodeLogger {\n+ public:\n+  explicit ExistingCodeLogger(Isolate* isolate,\n+                              CodeEventListener* listener = nullptr)\n+      : isolate_(isolate), listener_(listener) {}\n+\n+  void LogCodeObjects();\n+  void LogBytecodeHandlers();\n+\n+  void LogCompiledFunctions();\n+  void LogExistingFunction(Handle<SharedFunctionInfo> shared,\n+                           Handle<AbstractCode> code);\n+  void LogCodeObject(Object* object);\n+  void LogBytecodeHandler(interpreter::Bytecode bytecode,\n+                          interpreter::OperandScale operand_scale, Code* code);\n+\n+ private:\n+  Isolate* isolate_;\n+  CodeEventListener* listener_;\n+};\n+\n class Logger : public CodeEventListener {\n  public:\n   enum StartEnd { START = 0, END = 1, STAMP = 2 };\n@@ -233,7 +255,7 @@ class Logger : public CodeEventListener {\n     return is_logging_;\n   }\n \n-  bool is_logging_code_events() {\n+  bool is_listening_to_code_events() {\n     return is_logging() || jit_logger_ != nullptr;\n   }\n \n@@ -332,6 +354,8 @@ class Logger : public CodeEventListener {\n   // 'true' between SetUp() and TearDown().\n   bool is_initialized_;\n \n+  ExistingCodeLogger existing_code_logger_;\n+\n   base::ElapsedTimer timer_;\n \n   friend class CpuProfiler;\n@@ -412,6 +436,58 @@ class CodeEventLogger : public CodeEventListener {\n   NameBuffer* name_buffer_;\n };\n \n+struct CodeEvent {\n+  uintptr_t code_start_address;\n+  size_t code_size;\n+  Handle<String> function_name;\n+  Handle<String> script_name;\n+  int script_line;\n+  int script_column;\n+  CodeEventType code_type;\n+  const char* comment;\n+};\n+\n+class ExternalCodeEventListener : public CodeEventListener {\n+ public:\n+  explicit ExternalCodeEventListener(Isolate* isolate);\n+  ~ExternalCodeEventListener() override;\n+\n+  void CodeCreateEvent(LogEventsAndTags tag, AbstractCode* code,\n+                       const char* comment) override;\n+  void CodeCreateEvent(LogEventsAndTags tag, AbstractCode* code,\n+                       Name* name) override;\n+  void CodeCreateEvent(LogEventsAndTags tag, AbstractCode* code,\n+                       SharedFunctionInfo* shared, Name* name) override;\n+  void CodeCreateEvent(LogEventsAndTags tag, AbstractCode* code,\n+                       SharedFunctionInfo* shared, Name* source, int line,\n+                       int column) override;\n+  void CodeCreateEvent(LogEventsAndTags tag, const wasm::WasmCode* code,\n+                       wasm::WasmName name) override;\n+\n+  void RegExpCodeCreateEvent(AbstractCode* code, String* source) override;\n+  void CallbackEvent(Name* name, Address entry_point) override {}\n+  void GetterCallbackEvent(Name* name, Address entry_point) override {}\n+  void SetterCallbackEvent(Name* name, Address entry_point) override {}\n+  void SharedFunctionInfoMoveEvent(Address from, Address to) override {}\n+  void CodeMoveEvent(AbstractCode* from, Address to) override {}\n+  void CodeDisableOptEvent(AbstractCode* code,\n+                           SharedFunctionInfo* shared) override {}\n+  void CodeMovingGCEvent() override {}\n+  void CodeDeoptEvent(Code* code, DeoptKind kind, Address pc,\n+                      int fp_to_sp_delta) override {}\n+\n+  void StartListening(CodeEventHandler* code_event_handler);\n+  void StopListening();\n+\n+  bool is_listening_to_code_events() override { return true; }\n+\n+ private:\n+  void LogExistingCode();\n+\n+  bool is_listening_;\n+  Isolate* isolate_;\n+  v8::CodeEventHandler* code_event_handler_;\n+};\n \n }  // namespace internal\n }  // namespace v8"
        },
        {
            "sha": "9f1cbc00e998b7dd015b932c316d709b66bb9daa",
            "filename": "deps/v8/src/runtime/runtime-function.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime-function.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime-function.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fruntime%2Fruntime-function.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -147,7 +147,8 @@ RUNTIME_FUNCTION(Runtime_SetCode) {\n   // the target_shared optimized code map.\n   JSFunction::EnsureFeedbackVector(target);\n \n-  if (isolate->logger()->is_logging_code_events() || isolate->is_profiling()) {\n+  if (isolate->logger()->is_listening_to_code_events() ||\n+      isolate->is_profiling()) {\n     isolate->logger()->LogExistingFunction(\n         source_shared, Handle<AbstractCode>(source_shared->abstract_code()));\n   }"
        },
        {
            "sha": "d096500686e31b2ccadf06107381237a64cef767",
            "filename": "deps/v8/src/snapshot/code-serializer.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fsnapshot%2Fcode-serializer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fsnapshot%2Fcode-serializer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fsnapshot%2Fcode-serializer.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -284,7 +284,8 @@ MaybeHandle<SharedFunctionInfo> CodeSerializer::Deserialize(\n     PrintF(\"[Deserializing from %d bytes took %0.3f ms]\\n\", length, ms);\n   }\n \n-  if (isolate->logger()->is_logging_code_events() || isolate->is_profiling()) {\n+  if (isolate->logger()->is_listening_to_code_events() ||\n+      isolate->is_profiling()) {\n     String* name = isolate->heap()->empty_string();\n     if (result->script()->IsScript()) {\n       Script* script = Script::cast(result->script());"
        },
        {
            "sha": "a59e1552c6e1d0f8fa40228309322661351b3c87",
            "filename": "deps/v8/src/snapshot/snapshot-common.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fsnapshot%2Fsnapshot-common.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fsnapshot%2Fsnapshot-common.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fsnapshot%2Fsnapshot-common.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -114,7 +114,8 @@ Code* Snapshot::DeserializeBuiltin(Isolate* isolate, int builtin_id) {\n            Builtins::name(builtin_id), bytes, ms);\n   }\n \n-  if (isolate->logger()->is_logging_code_events() || isolate->is_profiling()) {\n+  if (isolate->logger()->is_listening_to_code_events() ||\n+      isolate->is_profiling()) {\n     isolate->logger()->LogCodeObject(code);\n   }\n \n@@ -195,7 +196,8 @@ Code* Snapshot::DeserializeHandler(Isolate* isolate,\n            bytes, ms);\n   }\n \n-  if (isolate->logger()->is_logging_code_events() || isolate->is_profiling()) {\n+  if (isolate->logger()->is_listening_to_code_events() ||\n+      isolate->is_profiling()) {\n     isolate->logger()->LogBytecodeHandler(bytecode, operand_scale, code);\n   }\n "
        },
        {
            "sha": "f72c0a3a472b42da131bb9688e7cf2d693a90875",
            "filename": "deps/v8/src/wasm/wasm-code-manager.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fwasm%2Fwasm-code-manager.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Fsrc%2Fwasm%2Fwasm-code-manager.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fwasm%2Fwasm-code-manager.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -190,7 +190,7 @@ bool WasmCode::HasTrapHandlerIndex() const { return trap_handler_index_ >= 0; }\n void WasmCode::ResetTrapHandlerIndex() { trap_handler_index_ = -1; }\n \n bool WasmCode::ShouldBeLogged(Isolate* isolate) {\n-  return isolate->logger()->is_logging_code_events() ||\n+  return isolate->logger()->is_listening_to_code_events() ||\n          isolate->is_profiling() || FLAG_print_wasm_code || FLAG_print_code;\n }\n "
        },
        {
            "sha": "3f8b0a517809cdd49d057d91571abf15875215aa",
            "filename": "deps/v8/test/cctest/test-log.cc",
            "status": "modified",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/nodejs/node/blob/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Ftest%2Fcctest%2Ftest-log.cc",
            "raw_url": "https://github.com/nodejs/node/raw/b3627560a94eaf51262cc041aebc9ef150b5fcbc/deps%2Fv8%2Ftest%2Fcctest%2Ftest-log.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-log.cc?ref=b3627560a94eaf51262cc041aebc9ef150b5fcbc",
            "patch": "@@ -35,6 +35,7 @@\n #endif  // __linux__\n \n #include <unordered_set>\n+#include <vector>\n #include \"src/api.h\"\n #include \"src/log-utils.h\"\n #include \"src/log.h\"\n@@ -251,6 +252,38 @@ class ScopedLoggerInitializer {\n   DISALLOW_COPY_AND_ASSIGN(ScopedLoggerInitializer);\n };\n \n+class TestCodeEventHandler : public v8::CodeEventHandler {\n+ public:\n+  explicit TestCodeEventHandler(v8::Isolate* isolate)\n+      : v8::CodeEventHandler(isolate) {}\n+\n+  const char* FindLine(const char* prefix, const char* suffix = nullptr,\n+                       const char* start = nullptr) {\n+    if (!log_.length()) return NULL;\n+    const char* c_log = log_.c_str();\n+    if (start == nullptr) start = c_log;\n+    const char* end = c_log + log_.length();\n+    return FindLogLine(start, end, prefix, suffix);\n+  }\n+\n+  void Handle(v8::CodeEvent* code_event) override {\n+    const char* code_type =\n+        v8::CodeEvent::GetCodeEventTypeName(code_event->GetCodeType());\n+    char function_name[1000];\n+    strncpy(function_name, code_type, 1000);\n+    function_name[strlen(code_type)] = ' ';\n+    code_event->GetFunctionName()->WriteUtf8(\n+        function_name + strlen(code_type) + 1, 1000);\n+    function_name[strlen(function_name) + 1] = '\\0';\n+    function_name[strlen(function_name)] = '\\n';\n+\n+    log_ += std::string(function_name);\n+  }\n+\n+ private:\n+  std::string log_;\n+};\n+\n }  // namespace\n \n TEST(FindLogLine) {\n@@ -801,6 +834,48 @@ TEST(LogInterpretedFramesNativeStack) {\n   isolate->Dispose();\n }\n \n+TEST(ExternalCodeEventListener) {\n+  i::FLAG_log = false;\n+  i::FLAG_prof = false;\n+\n+  v8::Isolate::CreateParams create_params;\n+  create_params.array_buffer_allocator = CcTest::array_buffer_allocator();\n+  v8::Isolate* isolate = v8::Isolate::New(create_params);\n+\n+  {\n+    v8::HandleScope scope(isolate);\n+    v8::Isolate::Scope isolate_scope(isolate);\n+    v8::Local<v8::Context> context = v8::Context::New(isolate);\n+    context->Enter();\n+\n+    TestCodeEventHandler code_event_handler(isolate);\n+\n+    const char* source_text_before_start =\n+        \"function testCodeEventListenerBeforeStart(a,b) { return a + b };\"\n+        \"testCodeEventListenerBeforeStart('1', 1);\";\n+    CompileRun(source_text_before_start);\n+\n+    CHECK_NULL(code_event_handler.FindLine(\"LazyCompile\",\n+                                           \"testCodeEventListenerBeforeStart\"));\n+\n+    code_event_handler.Enable();\n+\n+    CHECK_NOT_NULL(code_event_handler.FindLine(\n+        \"LazyCompile\", \"testCodeEventListenerBeforeStart\"));\n+\n+    const char* source_text_after_start =\n+        \"function testCodeEventListenerAfterStart(a,b) { return a + b };\"\n+        \"testCodeEventListenerAfterStart('1', 1);\";\n+    CompileRun(source_text_after_start);\n+\n+    CHECK_NOT_NULL(code_event_handler.FindLine(\n+        \"LazyCompile\", \"testCodeEventListenerAfterStart\"));\n+\n+    context->Exit();\n+  }\n+  isolate->Dispose();\n+}\n+\n TEST(TraceMaps) {\n   SETUP_FLAGS();\n   i::FLAG_trace_maps = true;"
        }
    ],
    "stats": {
        "total": 896,
        "additions": 695,
        "deletions": 201
    }
}