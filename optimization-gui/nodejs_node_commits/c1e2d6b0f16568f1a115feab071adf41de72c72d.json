{
    "author": "jasnell",
    "message": "trace_events: move trace_events to internalBinding\n\nPR-URL: https://github.com/nodejs/node/pull/22159\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Jon Moss <me@jonathanmoss.me>",
    "sha": "c1e2d6b0f16568f1a115feab071adf41de72c72d",
    "files": [
        {
            "sha": "7ac80ca4cf8528e99d82a7e40b322a7cf82d7a92",
            "filename": "benchmark/misc/trace.js",
            "status": "modified",
            "additions": 17,
            "deletions": 15,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/c1e2d6b0f16568f1a115feab071adf41de72c72d/benchmark%2Fmisc%2Ftrace.js",
            "raw_url": "https://github.com/nodejs/node/raw/c1e2d6b0f16568f1a115feab071adf41de72c72d/benchmark%2Fmisc%2Ftrace.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fmisc%2Ftrace.js?ref=c1e2d6b0f16568f1a115feab071adf41de72c72d",
            "patch": "@@ -9,34 +9,27 @@ const bench = common.createBenchmark(main, {\n   flags: ['--expose-internals', '--trace-event-categories', 'foo']\n });\n \n-const {\n-  trace,\n-  isTraceCategoryEnabled,\n-  emit,\n-  categoryGroupEnabled\n-} = process.binding('trace_events');\n-\n const {\n   TRACE_EVENT_PHASE_NESTABLE_ASYNC_BEGIN: kBeforeEvent\n } = process.binding('constants').trace;\n \n-function doEmit(n) {\n+function doEmit(n, emit) {\n   bench.start();\n   for (var i = 0; i < n; i++) {\n     emit(kBeforeEvent, 'foo', 'test', 0, 'arg1', 1);\n   }\n   bench.end(n);\n }\n \n-function doTrace(n) {\n+function doTrace(n, trace) {\n   bench.start();\n   for (var i = 0; i < n; i++) {\n     trace(kBeforeEvent, 'foo', 'test', 0, 'test');\n   }\n   bench.end(n);\n }\n \n-function doIsTraceCategoryEnabled(n) {\n+function doIsTraceCategoryEnabled(n, isTraceCategoryEnabled) {\n   bench.start();\n   for (var i = 0; i < n; i++) {\n     isTraceCategoryEnabled('foo');\n@@ -45,7 +38,7 @@ function doIsTraceCategoryEnabled(n) {\n   bench.end(n);\n }\n \n-function doCategoryGroupEnabled(n) {\n+function doCategoryGroupEnabled(n, categoryGroupEnabled) {\n   bench.start();\n   for (var i = 0; i < n; i++) {\n     categoryGroupEnabled('foo');\n@@ -55,19 +48,28 @@ function doCategoryGroupEnabled(n) {\n }\n \n function main({ n, method }) {\n+  const { internalBinding } = require('internal/test/binding');\n+\n+  const {\n+    trace,\n+    isTraceCategoryEnabled,\n+    emit,\n+    categoryGroupEnabled\n+  } = internalBinding('trace_events');\n+\n   switch (method) {\n     case '':\n     case 'trace':\n-      doTrace(n);\n+      doTrace(n, trace);\n       break;\n     case 'emit':\n-      doEmit(n);\n+      doEmit(n, emit);\n       break;\n     case 'isTraceCategoryEnabled':\n-      doIsTraceCategoryEnabled(n);\n+      doIsTraceCategoryEnabled(n, isTraceCategoryEnabled);\n       break;\n     case 'categoryGroupEnabled':\n-      doCategoryGroupEnabled(n);\n+      doCategoryGroupEnabled(n, categoryGroupEnabled);\n       break;\n     default:\n       throw new Error(`Unexpected method \"${method}\"`);"
        },
        {
            "sha": "5cd00932bd866750e52ecbd27a389c51299c891a",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c1e2d6b0f16568f1a115feab071adf41de72c72d/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/c1e2d6b0f16568f1a115feab071adf41de72c72d/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=c1e2d6b0f16568f1a115feab071adf41de72c72d",
            "patch": "@@ -100,7 +100,7 @@\n \n \n     {\n-      const traceEvents = process.binding('trace_events');\n+      const traceEvents = internalBinding('trace_events');\n       const traceEventCategory = 'node,node.async_hooks';\n \n       if (traceEvents.categoryGroupEnabled(traceEventCategory)) {"
        },
        {
            "sha": "79347b370e70dee48a3b2ddc977e5e258d71c64d",
            "filename": "lib/trace_events.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/c1e2d6b0f16568f1a115feab071adf41de72c72d/lib%2Ftrace_events.js",
            "raw_url": "https://github.com/nodejs/node/raw/c1e2d6b0f16568f1a115feab071adf41de72c72d/lib%2Ftrace_events.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftrace_events.js?ref=c1e2d6b0f16568f1a115feab071adf41de72c72d",
            "patch": "@@ -16,7 +16,8 @@ const {\n if (!hasTracing)\n   throw new ERR_TRACE_EVENTS_UNAVAILABLE();\n \n-const { CategorySet, getEnabledCategories } = process.binding('trace_events');\n+const { internalBinding } = require('internal/bootstrap/loaders');\n+const { CategorySet, getEnabledCategories } = internalBinding('trace_events');\n const { customInspectSymbol } = require('internal/util');\n const { format } = require('util');\n "
        },
        {
            "sha": "8413620e3f5f5bfaa71d2c32f0adc9b5852f5b91",
            "filename": "src/node_trace_events.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/c1e2d6b0f16568f1a115feab071adf41de72c72d/src%2Fnode_trace_events.cc",
            "raw_url": "https://github.com/nodejs/node/raw/c1e2d6b0f16568f1a115feab071adf41de72c72d/src%2Fnode_trace_events.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_trace_events.cc?ref=c1e2d6b0f16568f1a115feab071adf41de72c72d",
            "patch": "@@ -257,4 +257,4 @@ void Initialize(Local<Object> target,\n \n }  // namespace node\n \n-NODE_BUILTIN_MODULE_CONTEXT_AWARE(trace_events, node::Initialize)\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(trace_events, node::Initialize)"
        },
        {
            "sha": "2544c196acee49e5179cb3bf2282957114d75226",
            "filename": "test/parallel/test-trace-events-binding.js",
            "status": "modified",
            "additions": 11,
            "deletions": 12,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/c1e2d6b0f16568f1a115feab071adf41de72c72d/test%2Fparallel%2Ftest-trace-events-binding.js",
            "raw_url": "https://github.com/nodejs/node/raw/c1e2d6b0f16568f1a115feab071adf41de72c72d/test%2Fparallel%2Ftest-trace-events-binding.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-binding.js?ref=c1e2d6b0f16568f1a115feab071adf41de72c72d",
            "patch": "@@ -8,18 +8,16 @@ if (!common.isMainThread)\n   common.skip('process.chdir is not available in Workers');\n \n const CODE = `\n-  process.binding(\"trace_events\").emit(\n-    'b'.charCodeAt(0), 'custom',\n-    'type-value', 10, 'extra-value', 20);\n-  process.binding(\"trace_events\").emit(\n-    'b'.charCodeAt(0), 'custom',\n-    'type-value', 20, 'first-value', 20, 'second-value', 30);\n-  process.binding(\"trace_events\").emit(\n-    'b'.charCodeAt(0), 'custom',\n-    'type-value', 30);\n-  process.binding(\"trace_events\").emit(\n-    'b'.charCodeAt(0), 'missing',\n-    'type-value', 10, 'extra-value', 20);\n+  const { internalBinding } = require('internal/test/binding');\n+  const { emit } = internalBinding('trace_events');\n+  emit('b'.charCodeAt(0), 'custom',\n+       'type-value', 10, 'extra-value', 20);\n+  emit('b'.charCodeAt(0), 'custom',\n+       'type-value', 20, 'first-value', 20, 'second-value', 30);\n+  emit('b'.charCodeAt(0), 'custom',\n+       'type-value', 30);\n+  emit('b'.charCodeAt(0), 'missing',\n+       'type-value', 10, 'extra-value', 20);\n `;\n const FILE_NAME = 'node_trace.1.log';\n \n@@ -29,6 +27,7 @@ process.chdir(tmpdir.path);\n \n const proc = cp.spawn(process.execPath,\n                       [ '--trace-event-categories', 'custom',\n+                        '--expose-internals',\n                         '-e', CODE ]);\n \n proc.once('exit', common.mustCall(() => {"
        },
        {
            "sha": "4f9ad69366fdb00b36d214ae55aa0aaa2966d894",
            "filename": "test/parallel/test-trace-events-category-used.js",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/c1e2d6b0f16568f1a115feab071adf41de72c72d/test%2Fparallel%2Ftest-trace-events-category-used.js",
            "raw_url": "https://github.com/nodejs/node/raw/c1e2d6b0f16568f1a115feab071adf41de72c72d/test%2Fparallel%2Ftest-trace-events-category-used.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-category-used.js?ref=c1e2d6b0f16568f1a115feab071adf41de72c72d",
            "patch": "@@ -6,17 +6,23 @@ const cp = require('child_process');\n if (!common.isMainThread)\n   common.skip('process.chdir is not available in Workers');\n \n-const CODE = `console.log(\n-  process.binding(\"trace_events\").categoryGroupEnabled(\"custom\")\n-);`;\n+const CODE = `\n+  const { internalBinding } = require('internal/test/binding');\n+  const { categoryGroupEnabled } = internalBinding('trace_events');\n+  console.log(\n+    categoryGroupEnabled(\"custom\")\n+  );\n+`;\n \n const tmpdir = require('../common/tmpdir');\n tmpdir.refresh();\n process.chdir(tmpdir.path);\n \n const procEnabled = cp.spawn(\n   process.execPath,\n-  [ '--trace-event-categories', 'custom', '-e', CODE ]\n+  [ '--trace-event-categories', 'custom',\n+    '--expose-internals',\n+    '-e', CODE ]\n );\n let procEnabledOutput = '';\n \n@@ -28,7 +34,9 @@ procEnabled.once('exit', common.mustCall(() => {\n \n const procDisabled = cp.spawn(\n   process.execPath,\n-  [ '--trace-event-categories', 'other', '-e', CODE ]\n+  [ '--trace-event-categories', 'other',\n+    '--expose-internals',\n+    '-e', CODE ]\n );\n let procDisabledOutput = '';\n "
        }
    ],
    "stats": {
        "total": 80,
        "additions": 45,
        "deletions": 35
    }
}