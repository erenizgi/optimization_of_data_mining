{
    "author": "apapirovski",
    "message": "http: refactor outgoing headers processing\n\nUse a shared function, for..in instead of Object.keys, do less work in\n`setHeader` and instead defer some of it until later, and other minor\nchanges to improve clarity, as well as a slight boost in performance.\n\nPR-URL: https://github.com/nodejs/node/pull/20250\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "602ffd6986becd6ac8ac172bf4372878f7ba8f22",
    "files": [
        {
            "sha": "748865afbf3a0429f776f20a52dfa9fad2e2d50f",
            "filename": "benchmark/http/headers.js",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/602ffd6986becd6ac8ac172bf4372878f7ba8f22/benchmark%2Fhttp%2Fheaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/602ffd6986becd6ac8ac172bf4372878f7ba8f22/benchmark%2Fhttp%2Fheaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fhttp%2Fheaders.js?ref=602ffd6986becd6ac8ac172bf4372878f7ba8f22",
            "patch": "@@ -0,0 +1,36 @@\n+'use strict';\n+\n+const common = require('../common.js');\n+const http = require('http');\n+\n+const bench = common.createBenchmark(main, {\n+  duplicates: [1, 100],\n+  n: [10, 1000],\n+});\n+\n+function main({ duplicates, n }) {\n+  const headers = {\n+    'Connection': 'keep-alive',\n+    'Transfer-Encoding': 'chunked',\n+  };\n+\n+  for (var i = 0; i < n / duplicates; i++) {\n+    headers[`foo${i}`] = [];\n+    for (var j = 0; j < duplicates; j++) {\n+      headers[`foo${i}`].push(`some header value ${i}`);\n+    }\n+  }\n+\n+  const server = http.createServer(function(req, res) {\n+    res.writeHead(200, headers);\n+    res.end();\n+  });\n+  server.listen(common.PORT, function() {\n+    bench.http({\n+      path: '/',\n+      connections: 10\n+    }, function() {\n+      server.close();\n+    });\n+  });\n+}"
        },
        {
            "sha": "f075e0ecad7a2b1b08fc8150877f920739f33afe",
            "filename": "lib/_http_outgoing.js",
            "status": "modified",
            "additions": 79,
            "deletions": 99,
            "changes": 178,
            "blob_url": "https://github.com/nodejs/node/blob/602ffd6986becd6ac8ac172bf4372878f7ba8f22/lib%2F_http_outgoing.js",
            "raw_url": "https://github.com/nodejs/node/raw/602ffd6986becd6ac8ac172bf4372878f7ba8f22/lib%2F_http_outgoing.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_outgoing.js?ref=602ffd6986becd6ac8ac172bf4372878f7ba8f22",
            "patch": "@@ -52,6 +52,8 @@ const { utcDate } = internalHttp;\n \n const kIsCorked = Symbol('isCorked');\n \n+const hasOwnProperty = Function.call.bind(Object.prototype.hasOwnProperty);\n+\n var RE_CONN_CLOSE = /(?:^|\\W)close(?:$|\\W)/i;\n var RE_TE_CHUNKED = common.chunkExpression;\n \n@@ -116,7 +118,7 @@ Object.defineProperty(OutgoingMessage.prototype, '_headers', {\n     if (val == null) {\n       this[outHeadersKey] = null;\n     } else if (typeof val === 'object') {\n-      const headers = this[outHeadersKey] = {};\n+      const headers = this[outHeadersKey] = Object.create(null);\n       const keys = Object.keys(val);\n       for (var i = 0; i < keys.length; ++i) {\n         const name = keys[i];\n@@ -129,7 +131,7 @@ Object.defineProperty(OutgoingMessage.prototype, '_headers', {\n Object.defineProperty(OutgoingMessage.prototype, '_headerNames', {\n   get: function() {\n     const headers = this[outHeadersKey];\n-    if (headers) {\n+    if (headers !== null) {\n       const out = Object.create(null);\n       const keys = Object.keys(headers);\n       for (var i = 0; i < keys.length; ++i) {\n@@ -138,9 +140,8 @@ Object.defineProperty(OutgoingMessage.prototype, '_headerNames', {\n         out[key] = val;\n       }\n       return out;\n-    } else {\n-      return headers;\n     }\n+    return null;\n   },\n   set: function(val) {\n     if (typeof val === 'object' && val !== null) {\n@@ -164,14 +165,14 @@ OutgoingMessage.prototype._renderHeaders = function _renderHeaders() {\n   }\n \n   var headersMap = this[outHeadersKey];\n-  if (!headersMap) return {};\n-\n-  var headers = {};\n-  var keys = Object.keys(headersMap);\n+  const headers = {};\n \n-  for (var i = 0, l = keys.length; i < l; i++) {\n-    var key = keys[i];\n-    headers[headersMap[key][0]] = headersMap[key][1];\n+  if (headersMap !== null) {\n+    const keys = Object.keys(headersMap);\n+    for (var i = 0, l = keys.length; i < l; i++) {\n+      const key = keys[i];\n+      headers[headersMap[key][0]] = headersMap[key][1];\n+    }\n   }\n   return headers;\n };\n@@ -285,72 +286,40 @@ OutgoingMessage.prototype._storeHeader = _storeHeader;\n function _storeHeader(firstLine, headers) {\n   // firstLine in the case of request is: 'GET /index.html HTTP/1.1\\r\\n'\n   // in the case of response it is: 'HTTP/1.1 200 OK\\r\\n'\n-  var state = {\n+  const state = {\n     connection: false,\n     contLen: false,\n     te: false,\n     date: false,\n     expect: false,\n     trailer: false,\n-    upgrade: false,\n     header: firstLine\n   };\n \n-  var field;\n   var key;\n-  var value;\n-  var i;\n-  var j;\n   if (headers === this[outHeadersKey]) {\n     for (key in headers) {\n-      var entry = headers[key];\n-      field = entry[0];\n-      value = entry[1];\n-\n-      if (value instanceof Array) {\n-        if (value.length < 2 || !isCookieField(field)) {\n-          for (j = 0; j < value.length; j++)\n-            storeHeader(this, state, field, value[j], false);\n-          continue;\n-        }\n-        value = value.join('; ');\n-      }\n-      storeHeader(this, state, field, value, false);\n+      const entry = headers[key];\n+      processHeader(this, state, entry[0], entry[1], false);\n     }\n-  } else if (headers instanceof Array) {\n-    for (i = 0; i < headers.length; i++) {\n-      field = headers[i][0];\n-      value = headers[i][1];\n-\n-      if (value instanceof Array) {\n-        for (j = 0; j < value.length; j++) {\n-          storeHeader(this, state, field, value[j], true);\n-        }\n-      } else {\n-        storeHeader(this, state, field, value, true);\n-      }\n+  } else if (Array.isArray(headers)) {\n+    for (var i = 0; i < headers.length; i++) {\n+      const entry = headers[i];\n+      processHeader(this, state, entry[0], entry[1], true);\n     }\n   } else if (headers) {\n-    var keys = Object.keys(headers);\n-    for (i = 0; i < keys.length; i++) {\n-      field = keys[i];\n-      value = headers[field];\n-\n-      if (value instanceof Array) {\n-        if (value.length < 2 || !isCookieField(field)) {\n-          for (j = 0; j < value.length; j++)\n-            storeHeader(this, state, field, value[j], true);\n-          continue;\n-        }\n-        value = value.join('; ');\n+    for (key in headers) {\n+      if (hasOwnProperty(headers, key)) {\n+        processHeader(this, state, key, headers[key], true);\n       }\n-      storeHeader(this, state, field, value, true);\n     }\n   }\n \n+  let { header } = state;\n+\n   // Date header\n   if (this.sendDate && !state.date) {\n-    state.header += 'Date: ' + utcDate() + CRLF;\n+    header += 'Date: ' + utcDate() + CRLF;\n   }\n \n   // Force the connection to close when the response is a 204 No Content or\n@@ -364,9 +333,9 @@ function _storeHeader(firstLine, headers) {\n   // It was pointed out that this might confuse reverse proxies to the point\n   // of creating security liabilities, so suppress the zero chunk and force\n   // the connection to close.\n-  var statusCode = this.statusCode;\n-  if ((statusCode === 204 || statusCode === 304) && this.chunkedEncoding) {\n-    debug(statusCode + ' response should not use chunked encoding,' +\n+  if (this.chunkedEncoding && (this.statusCode === 204 ||\n+                               this.statusCode === 304)) {\n+    debug(this.statusCode + ' response should not use chunked encoding,' +\n           ' closing connection.');\n     this.chunkedEncoding = false;\n     this.shouldKeepAlive = false;\n@@ -377,13 +346,13 @@ function _storeHeader(firstLine, headers) {\n     this._last = true;\n     this.shouldKeepAlive = false;\n   } else if (!state.connection) {\n-    var shouldSendKeepAlive = this.shouldKeepAlive &&\n+    const shouldSendKeepAlive = this.shouldKeepAlive &&\n         (state.contLen || this.useChunkedEncodingByDefault || this.agent);\n     if (shouldSendKeepAlive) {\n-      state.header += 'Connection: keep-alive\\r\\n';\n+      header += 'Connection: keep-alive\\r\\n';\n     } else {\n       this._last = true;\n-      state.header += 'Connection: close\\r\\n';\n+      header += 'Connection: close\\r\\n';\n     }\n   }\n \n@@ -396,9 +365,9 @@ function _storeHeader(firstLine, headers) {\n     } else if (!state.trailer &&\n                !this._removedContLen &&\n                typeof this._contentLength === 'number') {\n-      state.header += 'Content-Length: ' + this._contentLength + CRLF;\n+      header += 'Content-Length: ' + this._contentLength + CRLF;\n     } else if (!this._removedTE) {\n-      state.header += 'Transfer-Encoding: chunked\\r\\n';\n+      header += 'Transfer-Encoding: chunked\\r\\n';\n       this.chunkedEncoding = true;\n     } else {\n       // We should only be able to get here if both Content-Length and\n@@ -416,18 +385,31 @@ function _storeHeader(firstLine, headers) {\n     throw new ERR_HTTP_TRAILER_INVALID();\n   }\n \n-  this._header = state.header + CRLF;\n+  this._header = header + CRLF;\n   this._headerSent = false;\n \n   // wait until the first body chunk, or close(), is sent to flush,\n   // UNLESS we're sending Expect: 100-continue.\n   if (state.expect) this._send('');\n }\n \n-function storeHeader(self, state, key, value, validate) {\n-  if (validate) {\n-    validateHeader(key, value);\n+function processHeader(self, state, key, value, validate) {\n+  if (validate)\n+    validateHeaderName(key);\n+  if (Array.isArray(value)) {\n+    if (value.length < 2 || !isCookieField(key)) {\n+      for (var i = 0; i < value.length; i++)\n+        storeHeader(self, state, key, value[i], validate);\n+      return;\n+    }\n+    value = value.join('; ');\n   }\n+  storeHeader(self, state, key, value, validate);\n+}\n+\n+function storeHeader(self, state, key, value, validate) {\n+  if (validate)\n+    validateHeaderValue(key, value);\n   state.header += key + ': ' + escapeHeaderValue(value) + CRLF;\n   matchHeader(self, state, key, value);\n }\n@@ -439,39 +421,47 @@ function matchHeader(self, state, field, value) {\n   switch (field) {\n     case 'connection':\n       state.connection = true;\n+      self._removedConnection = false;\n       if (RE_CONN_CLOSE.test(value))\n         self._last = true;\n       else\n         self.shouldKeepAlive = true;\n       break;\n     case 'transfer-encoding':\n       state.te = true;\n+      self._removedTE = false;\n       if (RE_TE_CHUNKED.test(value)) self.chunkedEncoding = true;\n       break;\n     case 'content-length':\n       state.contLen = true;\n+      self._removedContLen = false;\n       break;\n     case 'date':\n     case 'expect':\n     case 'trailer':\n-    case 'upgrade':\n       state[field] = true;\n       break;\n   }\n }\n \n-function validateHeader(name, value) {\n-  let err;\n+function validateHeaderName(name) {\n   if (typeof name !== 'string' || !name || !checkIsHttpToken(name)) {\n-    err = new ERR_INVALID_HTTP_TOKEN('Header name', name);\n-  } else if (value === undefined) {\n+    const err = new ERR_INVALID_HTTP_TOKEN('Header name', name);\n+    Error.captureStackTrace(err, validateHeaderName);\n+    throw err;\n+  }\n+}\n+\n+function validateHeaderValue(name, value) {\n+  let err;\n+  if (value === undefined) {\n     err = new ERR_HTTP_INVALID_HEADER_VALUE(value, name);\n   } else if (checkInvalidHeaderChar(value)) {\n     debug('Header \"%s\" contains invalid characters', name);\n     err = new ERR_INVALID_CHAR('header content', name);\n   }\n   if (err !== undefined) {\n-    Error.captureStackTrace(err, validateHeader);\n+    Error.captureStackTrace(err, validateHeaderValue);\n     throw err;\n   }\n }\n@@ -480,25 +470,14 @@ OutgoingMessage.prototype.setHeader = function setHeader(name, value) {\n   if (this._header) {\n     throw new ERR_HTTP_HEADERS_SENT('set');\n   }\n-  validateHeader(name, value);\n+  validateHeaderName(name);\n+  validateHeaderValue(name, value);\n \n-  if (!this[outHeadersKey])\n-    this[outHeadersKey] = {};\n+  let headers = this[outHeadersKey];\n+  if (headers === null)\n+    this[outHeadersKey] = headers = Object.create(null);\n \n-  const key = name.toLowerCase();\n-  this[outHeadersKey][key] = [name, value];\n-\n-  switch (key) {\n-    case 'connection':\n-      this._removedConnection = false;\n-      break;\n-    case 'content-length':\n-      this._removedContLen = false;\n-      break;\n-    case 'transfer-encoding':\n-      this._removedTE = false;\n-      break;\n-  }\n+  headers[name.toLowerCase()] = [name, value];\n };\n \n \n@@ -507,18 +486,18 @@ OutgoingMessage.prototype.getHeader = function getHeader(name) {\n     throw new ERR_INVALID_ARG_TYPE('name', 'string', name);\n   }\n \n-  if (!this[outHeadersKey]) return;\n-\n-  var entry = this[outHeadersKey][name.toLowerCase()];\n-  if (!entry)\n+  const headers = this[outHeadersKey];\n+  if (headers === null)\n     return;\n-  return entry[1];\n+\n+  const entry = headers[name.toLowerCase()];\n+  return entry && entry[1];\n };\n \n \n // Returns an array of the names of the current outgoing headers.\n OutgoingMessage.prototype.getHeaderNames = function getHeaderNames() {\n-  return (this[outHeadersKey] ? Object.keys(this[outHeadersKey]) : []);\n+  return this[outHeadersKey] !== null ? Object.keys(this[outHeadersKey]) : [];\n };\n \n \n@@ -543,7 +522,8 @@ OutgoingMessage.prototype.hasHeader = function hasHeader(name) {\n     throw new ERR_INVALID_ARG_TYPE('name', 'string', name);\n   }\n \n-  return !!(this[outHeadersKey] && this[outHeadersKey][name.toLowerCase()]);\n+  return this[outHeadersKey] !== null &&\n+    !!this[outHeadersKey][name.toLowerCase()];\n };\n \n \n@@ -573,7 +553,7 @@ OutgoingMessage.prototype.removeHeader = function removeHeader(name) {\n       break;\n   }\n \n-  if (this[outHeadersKey]) {\n+  if (this[outHeadersKey] !== null) {\n     delete this[outHeadersKey][key];\n   }\n };"
        },
        {
            "sha": "de75a44e8a05d767e4e399839a27c1be5759230c",
            "filename": "test/parallel/test-http-outgoing-internal-headers.js",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/602ffd6986becd6ac8ac172bf4372878f7ba8f22/test%2Fparallel%2Ftest-http-outgoing-internal-headers.js",
            "raw_url": "https://github.com/nodejs/node/raw/602ffd6986becd6ac8ac172bf4372878f7ba8f22/test%2Fparallel%2Ftest-http-outgoing-internal-headers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-outgoing-internal-headers.js?ref=602ffd6986becd6ac8ac172bf4372878f7ba8f22",
            "patch": "@@ -21,8 +21,10 @@ const { OutgoingMessage } = require('http');\n     Origin: 'localhost'\n   };\n \n-  assert.deepStrictEqual(outgoingMessage[outHeadersKey], {\n-    host: ['host', 'risingstack.com'],\n-    origin: ['Origin', 'localhost']\n-  });\n+  assert.deepStrictEqual(\n+    Object.entries(outgoingMessage[outHeadersKey]),\n+    Object.entries({\n+      host: ['host', 'risingstack.com'],\n+      origin: ['Origin', 'localhost']\n+    }));\n }"
        },
        {
            "sha": "22efce519094815dc023c3453e6bef2e3e7c55f5",
            "filename": "test/sequential/test-benchmark-http.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/602ffd6986becd6ac8ac172bf4372878f7ba8f22/test%2Fsequential%2Ftest-benchmark-http.js",
            "raw_url": "https://github.com/nodejs/node/raw/602ffd6986becd6ac8ac172bf4372878f7ba8f22/test%2Fsequential%2Ftest-benchmark-http.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-benchmark-http.js?ref=602ffd6986becd6ac8ac172bf4372878f7ba8f22",
            "patch": "@@ -18,6 +18,7 @@ runBenchmark('http',\n                'chunkedEnc=true',\n                'chunks=0',\n                'dur=0.1',\n+               'duplicates=1',\n                'input=keep-alive',\n                'key=\"\"',\n                'len=1',"
        }
    ],
    "stats": {
        "total": 225,
        "additions": 122,
        "deletions": 103
    }
}