{
    "author": "addaleax",
    "message": "http2: shrink memory to match read data\n\nPerform a shrinking `Realloc()` so that less data is\nused for HTTP2 reads.\n\nPR-URL: https://github.com/nodejs/node/pull/26201\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "83e1b9744317496b2a3b257bbf87e241496dd5ab",
    "files": [
        {
            "sha": "e5451d1fc7b6faa98323173f08ea79df5e44eeec",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 16,
            "deletions": 19,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/83e1b9744317496b2a3b257bbf87e241496dd5ab/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/83e1b9744317496b2a3b257bbf87e241496dd5ab/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=83e1b9744317496b2a3b257bbf87e241496dd5ab",
            "patch": "@@ -1774,17 +1774,8 @@ void Http2Session::OnStreamRead(ssize_t nread, const uv_buf_t& buf) {\n   Http2Scope h2scope(this);\n   CHECK_NOT_NULL(stream_);\n   Debug(this, \"receiving %d bytes\", nread);\n-  IncrementCurrentSessionMemory(buf.len);\n   CHECK(stream_buf_ab_.IsEmpty());\n \n-  OnScopeLeave on_scope_leave([&]() {\n-    // Once finished handling this write, reset the stream buffer.\n-    // The memory has either been free()d or was handed over to V8.\n-    DecrementCurrentSessionMemory(buf.len);\n-    stream_buf_ab_ = Local<ArrayBuffer>();\n-    stream_buf_ = uv_buf_init(nullptr, 0);\n-  });\n-\n   // Only pass data on if nread > 0\n   if (nread <= 0) {\n     free(buf.base);\n@@ -1794,29 +1785,35 @@ void Http2Session::OnStreamRead(ssize_t nread, const uv_buf_t& buf) {\n     return;\n   }\n \n+  // Shrink to the actual amount of used data.\n+  char* base = Realloc(buf.base, nread);\n+\n+  IncrementCurrentSessionMemory(nread);\n+  OnScopeLeave on_scope_leave([&]() {\n+    // Once finished handling this write, reset the stream buffer.\n+    // The memory has either been free()d or was handed over to V8.\n+    DecrementCurrentSessionMemory(nread);\n+    stream_buf_ab_ = Local<ArrayBuffer>();\n+    stream_buf_ = uv_buf_init(nullptr, 0);\n+  });\n+\n   // Make sure that there was no read previously active.\n   CHECK_NULL(stream_buf_.base);\n   CHECK_EQ(stream_buf_.len, 0);\n \n   // Remember the current buffer, so that OnDataChunkReceived knows the\n   // offset of a DATA frame's data into the socket read buffer.\n-  stream_buf_ = uv_buf_init(buf.base, nread);\n-\n-  // Verify that currently: There is memory allocated into which\n-  // the data has been read, and that memory buffer is at least as large\n-  // as the amount of data we have read, but we have not yet made an\n-  // ArrayBuffer out of it.\n-  CHECK_LE(static_cast<size_t>(nread), stream_buf_.len);\n+  stream_buf_ = uv_buf_init(base, nread);\n \n   Isolate* isolate = env()->isolate();\n \n   // Create an array buffer for the read data. DATA frames will be emitted\n   // as slices of this array buffer to avoid having to copy memory.\n   stream_buf_ab_ =\n       ArrayBuffer::New(isolate,\n-                        buf.base,\n-                        nread,\n-                        ArrayBufferCreationMode::kInternalized);\n+                       base,\n+                       nread,\n+                       ArrayBufferCreationMode::kInternalized);\n \n   statistics_.data_received += nread;\n   ssize_t ret = Write(&stream_buf_, 1);"
        },
        {
            "sha": "f770ee113945fc5476acc6b98ddcebe5e8a15f30",
            "filename": "test/sequential/test-http2-max-session-memory.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/83e1b9744317496b2a3b257bbf87e241496dd5ab/test%2Fsequential%2Ftest-http2-max-session-memory.js",
            "raw_url": "https://github.com/nodejs/node/raw/83e1b9744317496b2a3b257bbf87e241496dd5ab/test%2Fsequential%2Ftest-http2-max-session-memory.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http2-max-session-memory.js?ref=83e1b9744317496b2a3b257bbf87e241496dd5ab",
            "patch": "@@ -8,7 +8,7 @@ const http2 = require('http2');\n \n // Test that maxSessionMemory Caps work\n \n-const largeBuffer = Buffer.alloc(1e6);\n+const largeBuffer = Buffer.alloc(2e6);\n \n const server = http2.createServer({ maxSessionMemory: 1 });\n "
        }
    ],
    "stats": {
        "total": 37,
        "additions": 17,
        "deletions": 20
    }
}