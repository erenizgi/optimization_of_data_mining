{
    "author": "ZYSzys",
    "message": "buffer: harden validation of buffer allocation size\n\nThis makes using `NaN` as the buffer size throw an error.\n\nFixes: https://github.com/nodejs/node/issues/26151\n\nPR-URL: https://github.com/nodejs/node/pull/26162\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Сковорода Никита Андреевич <chalkerx@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "6fb7baf935442a1ceddcd0a585892456438f95aa",
    "files": [
        {
            "sha": "8b7aba1aaf06df864baf8e0e07b526c1f0f15ca2",
            "filename": "lib/buffer.js",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/6fb7baf935442a1ceddcd0a585892456438f95aa/lib%2Fbuffer.js",
            "raw_url": "https://github.com/nodejs/node/raw/6fb7baf935442a1ceddcd0a585892456438f95aa/lib%2Fbuffer.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fbuffer.js?ref=6fb7baf935442a1ceddcd0a585892456438f95aa",
            "patch": "@@ -256,7 +256,7 @@ function assertSize(size) {\n \n   if (typeof size !== 'number') {\n     err = new ERR_INVALID_ARG_TYPE('size', 'number', size);\n-  } else if (size < 0 || size > kMaxLength) {\n+  } else if (!(size >= 0 && size <= kMaxLength)) {\n     err = new ERR_INVALID_OPT_VALUE.RangeError('size', size);\n   }\n \n@@ -458,8 +458,11 @@ Buffer.concat = function concat(list, length) {\n \n   if (length === undefined) {\n     length = 0;\n-    for (i = 0; i < list.length; i++)\n-      length += list[i].length;\n+    for (i = 0; i < list.length; i++) {\n+      if (list[i].length) {\n+        length += list[i].length;\n+      }\n+    }\n   } else {\n     length = length >>> 0;\n   }"
        },
        {
            "sha": "2b8e9c5f2250e9f676c38e13820d1f7fd4017a09",
            "filename": "test/parallel/test-buffer-alloc.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/6fb7baf935442a1ceddcd0a585892456438f95aa/test%2Fparallel%2Ftest-buffer-alloc.js",
            "raw_url": "https://github.com/nodejs/node/raw/6fb7baf935442a1ceddcd0a585892456438f95aa/test%2Fparallel%2Ftest-buffer-alloc.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-buffer-alloc.js?ref=6fb7baf935442a1ceddcd0a585892456438f95aa",
            "patch": "@@ -764,7 +764,6 @@ assert.strictEqual(x.inspect(), '<Buffer 81 a3 66 6f 6f a3 62 61 72>');\n Buffer.allocUnsafe(3.3).fill().toString();\n // throws bad argument error in commit 43cb4ec\n Buffer.alloc(3.3).fill().toString();\n-assert.strictEqual(Buffer.allocUnsafe(NaN).length, 0);\n assert.strictEqual(Buffer.allocUnsafe(3.3).length, 3);\n assert.strictEqual(Buffer.from({ length: 3.3 }).length, 3);\n assert.strictEqual(Buffer.from({ length: 'BAM' }).length, 0);"
        },
        {
            "sha": "3a4958c8f62c6070a83d7aa35bbb05a28b9e903e",
            "filename": "test/parallel/test-buffer-no-negative-allocation.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/6fb7baf935442a1ceddcd0a585892456438f95aa/test%2Fparallel%2Ftest-buffer-no-negative-allocation.js",
            "raw_url": "https://github.com/nodejs/node/raw/6fb7baf935442a1ceddcd0a585892456438f95aa/test%2Fparallel%2Ftest-buffer-no-negative-allocation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-buffer-no-negative-allocation.js?ref=6fb7baf935442a1ceddcd0a585892456438f95aa",
            "patch": "@@ -7,22 +7,26 @@ const msg = common.expectsError({\n   code: 'ERR_INVALID_OPT_VALUE',\n   type: RangeError,\n   message: /^The value \"[^\"]*\" is invalid for option \"size\"$/\n-}, 12);\n+}, 16);\n \n // Test that negative Buffer length inputs throw errors.\n \n assert.throws(() => Buffer(-Buffer.poolSize), msg);\n assert.throws(() => Buffer(-100), msg);\n assert.throws(() => Buffer(-1), msg);\n+assert.throws(() => Buffer(NaN), msg);\n \n assert.throws(() => Buffer.alloc(-Buffer.poolSize), msg);\n assert.throws(() => Buffer.alloc(-100), msg);\n assert.throws(() => Buffer.alloc(-1), msg);\n+assert.throws(() => Buffer.alloc(NaN), msg);\n \n assert.throws(() => Buffer.allocUnsafe(-Buffer.poolSize), msg);\n assert.throws(() => Buffer.allocUnsafe(-100), msg);\n assert.throws(() => Buffer.allocUnsafe(-1), msg);\n+assert.throws(() => Buffer.allocUnsafe(NaN), msg);\n \n assert.throws(() => Buffer.allocUnsafeSlow(-Buffer.poolSize), msg);\n assert.throws(() => Buffer.allocUnsafeSlow(-100), msg);\n assert.throws(() => Buffer.allocUnsafeSlow(-1), msg);\n+assert.throws(() => Buffer.allocUnsafeSlow(NaN), msg);"
        },
        {
            "sha": "99362add3bb3361560050f8ab99661755105b091",
            "filename": "test/parallel/test-buffer-slow.js",
            "status": "modified",
            "additions": 9,
            "deletions": 21,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/6fb7baf935442a1ceddcd0a585892456438f95aa/test%2Fparallel%2Ftest-buffer-slow.js",
            "raw_url": "https://github.com/nodejs/node/raw/6fb7baf935442a1ceddcd0a585892456438f95aa/test%2Fparallel%2Ftest-buffer-slow.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-buffer-slow.js?ref=6fb7baf935442a1ceddcd0a585892456438f95aa",
            "patch": "@@ -43,29 +43,17 @@ try {\n assert.strictEqual(SlowBuffer('6').length, 6);\n assert.strictEqual(SlowBuffer(true).length, 1);\n \n-// Should create zero-length buffer if parameter is not a number\n-assert.strictEqual(SlowBuffer().length, 0);\n-assert.strictEqual(SlowBuffer(NaN).length, 0);\n-assert.strictEqual(SlowBuffer({}).length, 0);\n-assert.strictEqual(SlowBuffer('string').length, 0);\n-\n // should throw with invalid length\n const bufferMaxSizeMsg = common.expectsError({\n   code: 'ERR_INVALID_OPT_VALUE',\n   type: RangeError,\n   message: /^The value \"[^\"]*\" is invalid for option \"size\"$/\n-}, 2);\n-assert.throws(function() {\n-  SlowBuffer(Infinity);\n-}, bufferMaxSizeMsg);\n-common.expectsError(function() {\n-  SlowBuffer(-1);\n-}, {\n-  code: 'ERR_INVALID_OPT_VALUE',\n-  type: RangeError,\n-  message: 'The value \"-1\" is invalid for option \"size\"'\n-});\n-\n-assert.throws(function() {\n-  SlowBuffer(buffer.kMaxLength + 1);\n-}, bufferMaxSizeMsg);\n+}, 7);\n+\n+assert.throws(() => SlowBuffer(), bufferMaxSizeMsg);\n+assert.throws(() => SlowBuffer(NaN), bufferMaxSizeMsg);\n+assert.throws(() => SlowBuffer({}), bufferMaxSizeMsg);\n+assert.throws(() => SlowBuffer('string'), bufferMaxSizeMsg);\n+assert.throws(() => SlowBuffer(Infinity), bufferMaxSizeMsg);\n+assert.throws(() => SlowBuffer(-1), bufferMaxSizeMsg);\n+assert.throws(() => SlowBuffer(buffer.kMaxLength + 1), bufferMaxSizeMsg);"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 20,
        "deletions": 26
    }
}