{
    "author": "joyeecheung",
    "message": "lib: unmask mode_t values with 0o777\n\nThis commit allows permission bits higher than 0o777 to go through\nthe API (e.g. `S_ISVTX`=`0o1000`, `S_ISGID`=`0o2000`,\n`S_ISUID`=`0o4000`).\n\nAlso documents that these bits are not exposed through `fs.constants`\nand their behaviors are platform-specific, so the users need to\nuse them on their own risk.\n\nPR-URL: https://github.com/nodejs/node/pull/20975\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "cf723015458031fc80398971a0cfa0cbc9440004",
    "files": [
        {
            "sha": "9d4abce960eef441053dcdcb6415885058e3a884",
            "filename": "doc/api/fs.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/cf723015458031fc80398971a0cfa0cbc9440004/doc%2Fapi%2Ffs.md",
            "raw_url": "https://github.com/nodejs/node/raw/cf723015458031fc80398971a0cfa0cbc9440004/doc%2Fapi%2Ffs.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ffs.md?ref=cf723015458031fc80398971a0cfa0cbc9440004",
            "patch": "@@ -1089,6 +1089,12 @@ For example, the octal value `0o765` means:\n * The group may read and write the file.\n * Others may read and execute the file.\n \n+Note: When using raw numbers where file modes are expected,\n+any value larger than `0o777` may result in platform-specific\n+behaviors that are not supported to work consistently.\n+Therefore constants like `S_ISVTX`, `S_ISGID` or `S_ISUID` are\n+not exposed in `fs.constants`.\n+\n Caveats: on Windows only the write permission can be changed, and the\n distinction among the permissions of group, owner or others is not\n implemented."
        },
        {
            "sha": "0dd2d0d90cc8ca8f6ff0aabc2746c71e19e3f416",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/cf723015458031fc80398971a0cfa0cbc9440004/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf723015458031fc80398971a0cfa0cbc9440004/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=cf723015458031fc80398971a0cfa0cbc9440004",
            "patch": "@@ -77,7 +77,7 @@ const {\n } = require('internal/constants');\n const {\n   isUint32,\n-  validateAndMaskMode,\n+  validateMode,\n   validateInteger,\n   validateInt32,\n   validateUint32\n@@ -416,7 +416,7 @@ function open(path, flags, mode, callback) {\n     callback = makeCallback(mode);\n     mode = 0o666;\n   } else {\n-    mode = validateAndMaskMode(mode, 'mode', 0o666);\n+    mode = validateMode(mode, 'mode', 0o666);\n     callback = makeCallback(callback);\n   }\n \n@@ -434,7 +434,7 @@ function openSync(path, flags, mode) {\n   path = getPathFromURL(path);\n   validatePath(path);\n   const flagsNumber = stringToFlags(flags);\n-  mode = validateAndMaskMode(mode, 'mode', 0o666);\n+  mode = validateMode(mode, 'mode', 0o666);\n \n   const ctx = { path };\n   const result = binding.open(pathModule.toNamespacedPath(path),\n@@ -721,7 +721,7 @@ function mkdir(path, mode, callback) {\n     mode = 0o777;\n   } else {\n     callback = makeCallback(callback);\n-    mode = validateAndMaskMode(mode, 'mode', 0o777);\n+    mode = validateMode(mode, 'mode', 0o777);\n   }\n \n   const req = new FSReqWrap();\n@@ -732,7 +732,7 @@ function mkdir(path, mode, callback) {\n function mkdirSync(path, mode) {\n   path = getPathFromURL(path);\n   validatePath(path);\n-  mode = validateAndMaskMode(mode, 'mode', 0o777);\n+  mode = validateMode(mode, 'mode', 0o777);\n   const ctx = { path };\n   binding.mkdir(pathModule.toNamespacedPath(path), mode, undefined, ctx);\n   handleErrorFromBinding(ctx);\n@@ -915,7 +915,7 @@ function unlinkSync(path) {\n \n function fchmod(fd, mode, callback) {\n   validateInt32(fd, 'fd', 0);\n-  mode = validateAndMaskMode(mode, 'mode');\n+  mode = validateMode(mode, 'mode');\n   callback = makeCallback(callback);\n \n   const req = new FSReqWrap();\n@@ -925,7 +925,7 @@ function fchmod(fd, mode, callback) {\n \n function fchmodSync(fd, mode) {\n   validateInt32(fd, 'fd', 0);\n-  mode = validateAndMaskMode(mode, 'mode');\n+  mode = validateMode(mode, 'mode');\n   const ctx = {};\n   binding.fchmod(fd, mode, undefined, ctx);\n   handleErrorFromBinding(ctx);\n@@ -966,7 +966,7 @@ function lchmodSync(path, mode) {\n function chmod(path, mode, callback) {\n   path = getPathFromURL(path);\n   validatePath(path);\n-  mode = validateAndMaskMode(mode, 'mode');\n+  mode = validateMode(mode, 'mode');\n   callback = makeCallback(callback);\n \n   const req = new FSReqWrap();\n@@ -977,7 +977,7 @@ function chmod(path, mode, callback) {\n function chmodSync(path, mode) {\n   path = getPathFromURL(path);\n   validatePath(path);\n-  mode = validateAndMaskMode(mode, 'mode');\n+  mode = validateMode(mode, 'mode');\n \n   const ctx = { path };\n   binding.chmod(pathModule.toNamespacedPath(path), mode, undefined, ctx);"
        },
        {
            "sha": "43956dae3f4d18df901402abf25cb66a13581156",
            "filename": "lib/internal/fs/promises.js",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/cf723015458031fc80398971a0cfa0cbc9440004/lib%2Finternal%2Ffs%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf723015458031fc80398971a0cfa0cbc9440004/lib%2Finternal%2Ffs%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs%2Fpromises.js?ref=cf723015458031fc80398971a0cfa0cbc9440004",
            "patch": "@@ -32,7 +32,7 @@ const {\n } = require('internal/fs/utils');\n const {\n   isUint32,\n-  validateAndMaskMode,\n+  validateMode,\n   validateInteger,\n   validateUint32\n } = require('internal/validators');\n@@ -192,7 +192,7 @@ async function copyFile(src, dest, flags) {\n async function open(path, flags, mode) {\n   path = getPathFromURL(path);\n   validatePath(path);\n-  mode = validateAndMaskMode(mode, 'mode', 0o666);\n+  mode = validateMode(mode, 'mode', 0o666);\n   return new FileHandle(\n     await binding.openFileHandle(pathModule.toNamespacedPath(path),\n                                  stringToFlags(flags),\n@@ -287,7 +287,7 @@ async function fsync(handle) {\n async function mkdir(path, mode) {\n   path = getPathFromURL(path);\n   validatePath(path);\n-  mode = validateAndMaskMode(mode, 'mode', 0o777);\n+  mode = validateMode(mode, 'mode', 0o777);\n   return binding.mkdir(pathModule.toNamespacedPath(path), mode, kUsePromises);\n }\n \n@@ -359,14 +359,14 @@ async function unlink(path) {\n \n async function fchmod(handle, mode) {\n   validateFileHandle(handle);\n-  mode = validateAndMaskMode(mode, 'mode');\n+  mode = validateMode(mode, 'mode');\n   return binding.fchmod(handle.fd, mode, kUsePromises);\n }\n \n async function chmod(path, mode) {\n   path = getPathFromURL(path);\n   validatePath(path);\n-  mode = validateAndMaskMode(mode, 'mode');\n+  mode = validateMode(mode, 'mode');\n   return binding.chmod(pathModule.toNamespacedPath(path), mode, kUsePromises);\n }\n "
        },
        {
            "sha": "91aca398b346d48f4bfca6e1b49ebfb56789abe8",
            "filename": "lib/internal/process/methods.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cf723015458031fc80398971a0cfa0cbc9440004/lib%2Finternal%2Fprocess%2Fmethods.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf723015458031fc80398971a0cfa0cbc9440004/lib%2Finternal%2Fprocess%2Fmethods.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fmethods.js?ref=cf723015458031fc80398971a0cfa0cbc9440004",
            "patch": "@@ -5,7 +5,7 @@ const {\n   ERR_UNKNOWN_CREDENTIAL\n } = require('internal/errors').codes;\n const {\n-  validateAndMaskMode,\n+  validateMode,\n   validateUint32\n } = require('internal/validators');\n \n@@ -30,7 +30,7 @@ function setupProcessMethods(_chdir, _cpuUsage, _hrtime, _memoryUsage,\n       // Get the mask\n       return _umask(mask);\n     }\n-    mask = validateAndMaskMode(mask, 'mask');\n+    mask = validateMode(mask, 'mask');\n     return _umask(mask);\n   };\n }"
        },
        {
            "sha": "b7b21d29bfa097f312a63fbd32e893cdf6d3aa38",
            "filename": "lib/internal/validators.js",
            "status": "modified",
            "additions": 17,
            "deletions": 6,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/cf723015458031fc80398971a0cfa0cbc9440004/lib%2Finternal%2Fvalidators.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf723015458031fc80398971a0cfa0cbc9440004/lib%2Finternal%2Fvalidators.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fvalidators.js?ref=cf723015458031fc80398971a0cfa0cbc9440004",
            "patch": "@@ -16,11 +16,22 @@ function isUint32(value) {\n \n const octalReg = /^[0-7]+$/;\n const modeDesc = 'must be a 32-bit unsigned integer or an octal string';\n-// Validator for mode_t (the S_* constants). Valid numbers or octal strings\n-// will be masked with 0o777 to be consistent with the behavior in POSIX APIs.\n-function validateAndMaskMode(value, name, def) {\n+\n+/**\n+ * Validate values that will be converted into mode_t (the S_* constants).\n+ * Only valid numbers and octal strings are allowed. They could be converted\n+ * to 32-bit unsigned integers or non-negative signed integers in the C++\n+ * land, but any value higher than 0o777 will result in platform-specific\n+ * behaviors.\n+ *\n+ * @param {*} value Values to be validated\n+ * @param {string} name Name of the argument\n+ * @param {number} def If specified, will be returned for invalid values\n+ * @returns {number}\n+ */\n+function validateMode(value, name, def) {\n   if (isUint32(value)) {\n-    return value & 0o777;\n+    return value;\n   }\n \n   if (typeof value === 'number') {\n@@ -37,7 +48,7 @@ function validateAndMaskMode(value, name, def) {\n       throw new ERR_INVALID_ARG_VALUE(name, value, modeDesc);\n     }\n     const parsed = parseInt(value, 8);\n-    return parsed & 0o777;\n+    return parsed;\n   }\n \n   // TODO(BridgeAR): Only return `def` in case `value == null`\n@@ -106,7 +117,7 @@ function validateUint32(value, name, positive) {\n module.exports = {\n   isInt32,\n   isUint32,\n-  validateAndMaskMode,\n+  validateMode,\n   validateInteger,\n   validateInt32,\n   validateUint32"
        },
        {
            "sha": "9564ca142bd6430f32cf0094b9c2cc3ea316d6bb",
            "filename": "test/parallel/test-fs-chmod-mask.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/cf723015458031fc80398971a0cfa0cbc9440004/test%2Fparallel%2Ftest-fs-chmod-mask.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf723015458031fc80398971a0cfa0cbc9440004/test%2Fparallel%2Ftest-fs-chmod-mask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-chmod-mask.js?ref=cf723015458031fc80398971a0cfa0cbc9440004",
            "patch": "@@ -1,6 +1,6 @@\n 'use strict';\n \n-// This tests that mode > 0o777 will be masked off with 0o777 in fs APIs.\n+// This tests that the lower bits of mode > 0o777 still works in fs APIs.\n \n const common = require('../common');\n const assert = require('assert');"
        },
        {
            "sha": "515b982054b82bd24a38a5745f4a347b76435b68",
            "filename": "test/parallel/test-fs-mkdir-mode-mask.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/cf723015458031fc80398971a0cfa0cbc9440004/test%2Fparallel%2Ftest-fs-mkdir-mode-mask.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf723015458031fc80398971a0cfa0cbc9440004/test%2Fparallel%2Ftest-fs-mkdir-mode-mask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-mkdir-mode-mask.js?ref=cf723015458031fc80398971a0cfa0cbc9440004",
            "patch": "@@ -1,6 +1,6 @@\n 'use strict';\n \n-// This tests that mode > 0o777 will be masked off with 0o777 in fs.mkdir().\n+// This tests that the lower bits of mode > 0o777 still works in fs.mkdir().\n \n const common = require('../common');\n const assert = require('assert');"
        },
        {
            "sha": "0cd9a2c5923a718aeb36717aff55b5a32025c7ba",
            "filename": "test/parallel/test-fs-open-mode-mask.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/cf723015458031fc80398971a0cfa0cbc9440004/test%2Fparallel%2Ftest-fs-open-mode-mask.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf723015458031fc80398971a0cfa0cbc9440004/test%2Fparallel%2Ftest-fs-open-mode-mask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-open-mode-mask.js?ref=cf723015458031fc80398971a0cfa0cbc9440004",
            "patch": "@@ -1,6 +1,6 @@\n 'use strict';\n \n-// This tests that mode > 0o777 will be masked off with 0o777 in fs.open().\n+// This tests that the lower bits of mode > 0o777 still works in fs.open().\n \n const common = require('../common');\n const assert = require('assert');"
        },
        {
            "sha": "6871a6762b68e2927c165a650ca33cec5349b4f7",
            "filename": "test/parallel/test-fs-promises.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/cf723015458031fc80398971a0cfa0cbc9440004/test%2Fparallel%2Ftest-fs-promises.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf723015458031fc80398971a0cfa0cbc9440004/test%2Fparallel%2Ftest-fs-promises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises.js?ref=cf723015458031fc80398971a0cfa0cbc9440004",
            "patch": "@@ -107,9 +107,8 @@ function verifyStatObject(stat) {\n     await chmod(dest, 0o666);\n     await handle.chmod(0o666);\n \n-    // Mode larger than 0o777 should be masked off.\n-    await chmod(dest, (0o777 + 1));\n-    await handle.chmod(0o777 + 1);\n+    await chmod(dest, (0o10777));\n+    await handle.chmod(0o10777);\n \n     await utimes(dest, new Date(), new Date());\n "
        },
        {
            "sha": "8ec8fc0074ac1b2027009a03694ef43ed0efe582",
            "filename": "test/parallel/test-process-umask-mask.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/cf723015458031fc80398971a0cfa0cbc9440004/test%2Fparallel%2Ftest-process-umask-mask.js",
            "raw_url": "https://github.com/nodejs/node/raw/cf723015458031fc80398971a0cfa0cbc9440004/test%2Fparallel%2Ftest-process-umask-mask.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-umask-mask.js?ref=cf723015458031fc80398971a0cfa0cbc9440004",
            "patch": "@@ -1,6 +1,6 @@\n 'use strict';\n \n-// This tests that mask > 0o777 will be masked off with 0o777 in\n+// This tests that the lower bits of mode > 0o777 still works in\n // process.umask()\n \n const common = require('../common');"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 45,
        "deletions": 29
    }
}