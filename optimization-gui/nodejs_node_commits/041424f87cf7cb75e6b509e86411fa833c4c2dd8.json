{
    "author": "joyeecheung",
    "message": "lib: move signal event handling into bootstrap/node.js\n\nMoves the `process.on()` and `promise.emit()` calls happened during\nbootstrap for signal events into `bootstrap/node.js` so it's easier\nto tell the side effects.\n\nDrive-by changes:\n\n- Moves the signal event re-arming to a point later during\n  the bootstrap - as early as it were it's unlikely that there\n  could be any existing signal events to re-arm for node-report.\n- Use a Map instead of an Object for signal wraps since it is used\n  as a deletable dictionary anyway.\n\nPR-URL: https://github.com/nodejs/node/pull/25859\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "041424f87cf7cb75e6b509e86411fa833c4c2dd8",
    "files": [
        {
            "sha": "360b871d0cd38c840a1b1cddf1871ba252428371",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 17,
            "deletions": 3,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/041424f87cf7cb75e6b509e86411fa833c4c2dd8/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/041424f87cf7cb75e6b509e86411fa833c4c2dd8/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=041424f87cf7cb75e6b509e86411fa833c4c2dd8",
            "patch": "@@ -67,9 +67,6 @@ process.config = JSON.parse(internalBinding('native_module').config);\n const rawMethods = internalBinding('process_methods');\n // Set up methods and events on the process object for the main thread\n if (isMainThread) {\n-  // This depends on process being an event emitter\n-  mainThreadSetup.setupSignalHandlers(internalBinding);\n-\n   process.abort = rawMethods.abort;\n   const wrapped = mainThreadSetup.wrapProcessMethods(rawMethods);\n   process.umask = wrapped.umask;\n@@ -320,6 +317,23 @@ if (process.env.NODE_V8_COVERAGE) {\n   };\n }\n \n+// Worker threads don't receive signals.\n+if (isMainThread) {\n+  const {\n+    isSignal,\n+    startListeningIfSignal,\n+    stopListeningIfSignal\n+  } = mainThreadSetup.createSignalHandlers();\n+  process.on('newListener', startListeningIfSignal);\n+  process.on('removeListener', stopListeningIfSignal);\n+  // re-arm pre-existing signal event registrations\n+  // with this signal wrap capabilities.\n+  const signalEvents = process.eventNames().filter(isSignal);\n+  for (const ev of signalEvents) {\n+    process.emit('newListener', ev);\n+  }\n+}\n+\n if (getOptionValue('--experimental-report')) {\n   const {\n     config,"
        },
        {
            "sha": "290d2f7e9e2eb8657d2beb525dace4d677a182eb",
            "filename": "lib/internal/process/main_thread_only.js",
            "status": "modified",
            "additions": 27,
            "deletions": 26,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/041424f87cf7cb75e6b509e86411fa833c4c2dd8/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "raw_url": "https://github.com/nodejs/node/raw/041424f87cf7cb75e6b509e86411fa833c4c2dd8/lib%2Finternal%2Fprocess%2Fmain_thread_only.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fmain_thread_only.js?ref=041424f87cf7cb75e6b509e86411fa833c4c2dd8",
            "patch": "@@ -16,6 +16,8 @@ const {\n   validateString\n } = require('internal/validators');\n \n+const { signals } = internalBinding('constants').os;\n+\n // The execution of this function itself should not cause any side effects.\n function wrapProcessMethods(binding) {\n   function chdir(directory) {\n@@ -104,19 +106,18 @@ function wrapPosixCredentialSetters(credentials) {\n   };\n }\n \n-// Worker threads don't receive signals.\n-function setupSignalHandlers(internalBinding) {\n-  const constants = internalBinding('constants').os.signals;\n-  const signalWraps = Object.create(null);\n-  let Signal;\n+let Signal;\n+function isSignal(event) {\n+  return typeof event === 'string' && signals[event] !== undefined;\n+}\n \n-  function isSignal(event) {\n-    return typeof event === 'string' && constants[event] !== undefined;\n-  }\n+// Worker threads don't receive signals.\n+function createSignalHandlers() {\n+  const signalWraps = new Map();\n \n   // Detect presence of a listener for the special signal types\n-  process.on('newListener', function(type) {\n-    if (isSignal(type) && signalWraps[type] === undefined) {\n+  function startListeningIfSignal(type) {\n+    if (isSignal(type) && !signalWraps.has(type)) {\n       if (Signal === undefined)\n         Signal = internalBinding('signal_wrap').Signal;\n       const wrap = new Signal();\n@@ -125,30 +126,30 @@ function setupSignalHandlers(internalBinding) {\n \n       wrap.onsignal = process.emit.bind(process, type, type);\n \n-      const signum = constants[type];\n+      const signum = signals[type];\n       const err = wrap.start(signum);\n       if (err) {\n         wrap.close();\n         throw errnoException(err, 'uv_signal_start');\n       }\n \n-      signalWraps[type] = wrap;\n+      signalWraps.set(type, wrap);\n     }\n-  });\n+  }\n \n-  process.on('removeListener', function(type) {\n-    if (signalWraps[type] !== undefined && this.listenerCount(type) === 0) {\n-      signalWraps[type].close();\n-      delete signalWraps[type];\n+  function stopListeningIfSignal(type) {\n+    const wrap = signalWraps.get(type);\n+    if (wrap !== undefined && process.listenerCount(type) === 0) {\n+      wrap.close();\n+      signalWraps.delete(type);\n     }\n-  });\n-\n-  // re-arm pre-existing signal event registrations\n-  // with this signal wrap capabilities.\n-  process.eventNames().forEach((ev) => {\n-    if (isSignal(ev))\n-      process.emit('newListener', ev);\n-  });\n+  }\n+\n+  return {\n+    isSignal,\n+    startListeningIfSignal,\n+    stopListeningIfSignal\n+  };\n }\n \n function setupChildProcessIpcChannel() {\n@@ -166,7 +167,7 @@ function setupChildProcessIpcChannel() {\n \n module.exports = {\n   wrapProcessMethods,\n-  setupSignalHandlers,\n+  createSignalHandlers,\n   setupChildProcessIpcChannel,\n   wrapPosixCredentialSetters\n };"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 44,
        "deletions": 29
    }
}