{
    "author": "davisjam",
    "message": "dns: improve setServers() errors and performance\n\nIssue 1: make invalid setServers yield uniform error\n\nBehavior:\ndns.setServers throws a null pointer dereference on some inputs.\nExpected behavior was the more pleasant\n  TypeError [ERR_INVALID_IP_ADDRESS] ...\n\nRoot cause(s?):\n- Dereferencing the result of a regex match without confirming\n  that there was a match.\n- assuming the capture of an optional group (?)\n\nSolution:\nConfirm the match, and handle a missing port cleanly.\n\nTests: I added tests for various unusual inputs.\n\nIssue 2: revise quadratic regex in setServers\n\nProblem:\nThe IPv6 regex was quadratic.\nOn long malicious input the event loop could block.\n\nThe security team did not deem it a security risk,\nbut said a PR was welcome.\n\nSolution:\nRevise the regex to a linear-complexity version.\n\nTests:\nI added REDOS tests to the \"oddities\" section.\n\nFixes: https://github.com/nodejs/node/issues/20441\nFixes: https://github.com/nodejs/node/issues/20443\n\nPR-URL: https://github.com/nodejs/node/pull/20445\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "872c331a930df3e44e8f5db5a90a0383e8d0491b",
    "files": [
        {
            "sha": "1f6994ba16fd21e468e6e60ad2c1eaeae2afc5fc",
            "filename": "lib/dns.js",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/872c331a930df3e44e8f5db5a90a0383e8d0491b/lib%2Fdns.js",
            "raw_url": "https://github.com/nodejs/node/raw/872c331a930df3e44e8f5db5a90a0383e8d0491b/lib%2Fdns.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fdns.js?ref=872c331a930df3e44e8f5db5a90a0383e8d0491b",
            "patch": "@@ -289,7 +289,7 @@ function setServers(servers) {\n   // servers cares won't have any servers available for resolution\n   const orig = this._handle.getServers();\n   const newSet = [];\n-  const IPv6RE = /\\[(.*)\\]/;\n+  const IPv6RE = /^\\[([^[\\]]*)\\]/;\n   const addrSplitRE = /(^.+?)(?::(\\d+))?$/;\n \n   servers.forEach((serv) => {\n@@ -309,11 +309,16 @@ function setServers(servers) {\n       }\n     }\n \n-    const [, s, p] = serv.match(addrSplitRE);\n-    ipVersion = isIP(s);\n+    // addr::port\n+    const addrSplitMatch = serv.match(addrSplitRE);\n+    if (addrSplitMatch) {\n+      const hostIP = addrSplitMatch[1];\n+      const port = addrSplitMatch[2] || IANA_DNS_PORT;\n \n-    if (ipVersion !== 0) {\n-      return newSet.push([ipVersion, s, parseInt(p)]);\n+      ipVersion = isIP(hostIP);\n+      if (ipVersion !== 0) {\n+        return newSet.push([ipVersion, hostIP, parseInt(port)]);\n+      }\n     }\n \n     throw new ERR_INVALID_IP_ADDRESS(serv);"
        },
        {
            "sha": "f50b9464f102cc3e985046c886d14d85a1bb906d",
            "filename": "test/parallel/test-dns.js",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/872c331a930df3e44e8f5db5a90a0383e8d0491b/test%2Fparallel%2Ftest-dns.js",
            "raw_url": "https://github.com/nodejs/node/raw/872c331a930df3e44e8f5db5a90a0383e8d0491b/test%2Fparallel%2Ftest-dns.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-dns.js?ref=872c331a930df3e44e8f5db5a90a0383e8d0491b",
            "patch": "@@ -62,6 +62,31 @@ assert(existing.length > 0);\n   ]);\n }\n \n+{\n+  // Various invalidities, all of which should throw a clean error.\n+  const invalidServers = [\n+    ' ',\n+    '\\n',\n+    '\\0',\n+    '1'.repeat(3 * 4),\n+    // Check for REDOS issues.\n+    ':'.repeat(100000),\n+    '['.repeat(100000),\n+    '['.repeat(100000) + ']'.repeat(100000) + 'a'\n+  ];\n+  invalidServers.forEach((serv) => {\n+    assert.throws(\n+      () => {\n+        dns.setServers([serv]);\n+      },\n+      {\n+        name: 'TypeError [ERR_INVALID_IP_ADDRESS]',\n+        code: 'ERR_INVALID_IP_ADDRESS'\n+      }\n+    );\n+  });\n+}\n+\n const goog = [\n   '8.8.8.8',\n   '8.8.4.4',"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 35,
        "deletions": 5
    }
}