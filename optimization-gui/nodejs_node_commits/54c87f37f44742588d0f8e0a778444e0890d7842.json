{
    "author": "joyeecheung",
    "message": "deps: cherry-pick 6ee8345 from upstream V8\n\nOriginal commit message:\n\n    [heap-profiler] Allow embedder to specify edge names\n\n    This patch adds a variant of EmbedderGraph::AddEdge() which\n    allows the embedder to specify the name of an edge. The edges\n    added without name are element edges with auto-incremented indexes\n    while the edges added with names will be internal edges with\n    the specified names for more meaningful output in the heap\n    snapshot.\n\n    Refs: https://github.com/nodejs/node/pull/21741\n    Bug: v8:7938\n    Cq-Include-Trybots: luci.chromium.try:linux_chromium_rel_ng\n    Change-Id: I8feefa2cf6911743e24b3b2024e0e849b0c65cd3\n    Reviewed-on: https://chromium-review.googlesource.com/1133299\n    Commit-Queue: Ulan Degenbaev <ulan@chromium.org>\n    Reviewed-by: Ulan Degenbaev <ulan@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#54412}\n\nRefs: https://github.com/v8/v8/commit/6ee834532d6f924f6057584085fa79b4777c396a\n\nPR-URL: https://github.com/nodejs/node/pull/22106\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "54c87f37f44742588d0f8e0a778444e0890d7842",
    "files": [
        {
            "sha": "ec877db9900e0e0c73299f144d1affcaab197c0c",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/54c87f37f44742588d0f8e0a778444e0890d7842/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/54c87f37f44742588d0f8e0a778444e0890d7842/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=54c87f37f44742588d0f8e0a778444e0890d7842",
            "patch": "@@ -29,7 +29,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.15',\n+    'v8_embedder_string': '-node.16',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "bcb53f1446004aab325e241b36f7e847e3c6b3a6",
            "filename": "deps/v8/include/v8-profiler.h",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/54c87f37f44742588d0f8e0a778444e0890d7842/deps%2Fv8%2Finclude%2Fv8-profiler.h",
            "raw_url": "https://github.com/nodejs/node/raw/54c87f37f44742588d0f8e0a778444e0890d7842/deps%2Fv8%2Finclude%2Fv8-profiler.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8-profiler.h?ref=54c87f37f44742588d0f8e0a778444e0890d7842",
            "patch": "@@ -686,11 +686,14 @@ class V8_EXPORT EmbedderGraph {\n   virtual Node* AddNode(std::unique_ptr<Node> node) = 0;\n \n   /**\n-   * Adds an edge that represents a strong reference from the given node\n-   * |from| to the given node |to|. The nodes must be added to the graph\n+   * Adds an edge that represents a strong reference from the given\n+   * node |from| to the given node |to|. The nodes must be added to the graph\n    * before calling this function.\n+   *\n+   * If name is nullptr, the edge will have auto-increment indexes, otherwise\n+   * it will be named accordingly.\n    */\n-  virtual void AddEdge(Node* from, Node* to) = 0;\n+  virtual void AddEdge(Node* from, Node* to, const char* name = nullptr) = 0;\n \n   virtual ~EmbedderGraph() = default;\n };"
        },
        {
            "sha": "6564250d2e6672e44fac7b199fa7275e902c7912",
            "filename": "deps/v8/src/profiler/heap-snapshot-generator.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/54c87f37f44742588d0f8e0a778444e0890d7842/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-snapshot-generator.cc",
            "raw_url": "https://github.com/nodejs/node/raw/54c87f37f44742588d0f8e0a778444e0890d7842/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-snapshot-generator.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fprofiler%2Fheap-snapshot-generator.cc?ref=54c87f37f44742588d0f8e0a778444e0890d7842",
            "patch": "@@ -1989,6 +1989,7 @@ class EmbedderGraphImpl : public EmbedderGraph {\n   struct Edge {\n     Node* from;\n     Node* to;\n+    const char* name;\n   };\n \n   class V8NodeImpl : public Node {\n@@ -2025,7 +2026,9 @@ class EmbedderGraphImpl : public EmbedderGraph {\n     return result;\n   }\n \n-  void AddEdge(Node* from, Node* to) final { edges_.push_back({from, to}); }\n+  void AddEdge(Node* from, Node* to, const char* name) final {\n+    edges_.push_back({from, to, name});\n+  }\n \n   const std::vector<std::unique_ptr<Node>>& nodes() { return nodes_; }\n   const std::vector<Edge>& edges() { return edges_; }\n@@ -2318,8 +2321,13 @@ bool NativeObjectsExplorer::IterateAndExtractReferences(\n       int from_index = from->index();\n       HeapEntry* to = EntryForEmbedderGraphNode(edge.to);\n       if (to) {\n-        filler_->SetIndexedAutoIndexReference(HeapGraphEdge::kElement,\n-                                              from_index, to);\n+        if (edge.name == nullptr) {\n+          filler_->SetIndexedAutoIndexReference(HeapGraphEdge::kElement,\n+                                                from_index, to);\n+        } else {\n+          filler_->SetNamedReference(HeapGraphEdge::kInternal, from_index,\n+                                     edge.name, to);\n+        }\n       }\n     }\n   } else {"
        },
        {
            "sha": "f164355bf8c25f53cab321c11c369214acd58682",
            "filename": "deps/v8/test/cctest/test-heap-profiler.cc",
            "status": "modified",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/nodejs/node/blob/54c87f37f44742588d0f8e0a778444e0890d7842/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc",
            "raw_url": "https://github.com/nodejs/node/raw/54c87f37f44742588d0f8e0a778444e0890d7842/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-heap-profiler.cc?ref=54c87f37f44742588d0f8e0a778444e0890d7842",
            "patch": "@@ -112,6 +112,12 @@ static const char* GetName(const v8::HeapGraphNode* node) {\n       ->name();\n }\n \n+static const char* GetName(const v8::HeapGraphEdge* edge) {\n+  return const_cast<i::HeapGraphEdge*>(\n+             reinterpret_cast<const i::HeapGraphEdge*>(edge))\n+      ->name();\n+}\n+\n static size_t GetSize(const v8::HeapGraphNode* node) {\n   return const_cast<i::HeapEntry*>(reinterpret_cast<const i::HeapEntry*>(node))\n       ->self_size();\n@@ -128,6 +134,18 @@ static const v8::HeapGraphNode* GetChildByName(const v8::HeapGraphNode* node,\n   return nullptr;\n }\n \n+static const v8::HeapGraphEdge* GetEdgeByChildName(\n+    const v8::HeapGraphNode* node, const char* name) {\n+  for (int i = 0, count = node->GetChildrenCount(); i < count; ++i) {\n+    const v8::HeapGraphEdge* edge = node->GetChild(i);\n+    const v8::HeapGraphNode* child = edge->GetToNode();\n+    if (!strcmp(name, GetName(child))) {\n+      return edge;\n+    }\n+  }\n+  return nullptr;\n+}\n+\n static const v8::HeapGraphNode* GetRootChild(const v8::HeapSnapshot* snapshot,\n                                              const char* name) {\n   return GetChildByName(snapshot->GetRoot(), name);\n@@ -2986,6 +3004,71 @@ TEST(EmbedderGraph) {\n   CheckEmbedderGraphSnapshot(env->GetIsolate(), snapshot);\n }\n \n+void BuildEmbedderGraphWithNamedEdges(v8::Isolate* v8_isolate,\n+                                      v8::EmbedderGraph* graph, void* data) {\n+  using Node = v8::EmbedderGraph::Node;\n+  Node* global_node = graph->V8Node(*global_object_pointer);\n+  Node* embedder_node_A = graph->AddNode(\n+      std::unique_ptr<Node>(new EmbedderNode(\"EmbedderNodeA\", 10)));\n+  Node* embedder_node_B = graph->AddNode(\n+      std::unique_ptr<Node>(new EmbedderNode(\"EmbedderNodeB\", 20)));\n+  Node* embedder_node_C = graph->AddNode(\n+      std::unique_ptr<Node>(new EmbedderNode(\"EmbedderNodeC\", 30)));\n+  graph->AddEdge(global_node, embedder_node_A, \"global_to_a\");\n+  graph->AddEdge(embedder_node_A, embedder_node_B, \"a_to_b\");\n+  graph->AddEdge(embedder_node_B, embedder_node_C);\n+}\n+\n+void CheckEmbedderGraphWithNamedEdges(v8::Isolate* isolate,\n+                                      const v8::HeapSnapshot* snapshot) {\n+  const v8::HeapGraphNode* global = GetGlobalObject(snapshot);\n+  const v8::HeapGraphEdge* global_to_a =\n+      GetEdgeByChildName(global, \"EmbedderNodeA\");\n+  CHECK(global_to_a);\n+  CHECK_EQ(v8::HeapGraphEdge::kInternal, global_to_a->GetType());\n+  CHECK(global_to_a->GetName()->IsString());\n+  CHECK_EQ(0, strcmp(\"global_to_a\", GetName(global_to_a)));\n+  const v8::HeapGraphNode* embedder_node_A = global_to_a->GetToNode();\n+  CHECK_EQ(0, strcmp(\"EmbedderNodeA\", GetName(embedder_node_A)));\n+  CHECK_EQ(10, GetSize(embedder_node_A));\n+\n+  const v8::HeapGraphEdge* a_to_b =\n+      GetEdgeByChildName(embedder_node_A, \"EmbedderNodeB\");\n+  CHECK(a_to_b);\n+  CHECK(a_to_b->GetName()->IsString());\n+  CHECK_EQ(0, strcmp(\"a_to_b\", GetName(a_to_b)));\n+  CHECK_EQ(v8::HeapGraphEdge::kInternal, a_to_b->GetType());\n+  const v8::HeapGraphNode* embedder_node_B = a_to_b->GetToNode();\n+  CHECK_EQ(0, strcmp(\"EmbedderNodeB\", GetName(embedder_node_B)));\n+  CHECK_EQ(20, GetSize(embedder_node_B));\n+\n+  const v8::HeapGraphEdge* b_to_c =\n+      GetEdgeByChildName(embedder_node_B, \"EmbedderNodeC\");\n+  CHECK(b_to_c);\n+  CHECK(b_to_c->GetName()->IsNumber());\n+  CHECK_EQ(v8::HeapGraphEdge::kElement, b_to_c->GetType());\n+  const v8::HeapGraphNode* embedder_node_C = b_to_c->GetToNode();\n+  CHECK_EQ(0, strcmp(\"EmbedderNodeC\", GetName(embedder_node_C)));\n+  CHECK_EQ(30, GetSize(embedder_node_C));\n+}\n+\n+TEST(EmbedderGraphWithNamedEdges) {\n+  i::FLAG_heap_profiler_use_embedder_graph = true;\n+  LocalContext env;\n+  v8::HandleScope scope(env->GetIsolate());\n+  i::Isolate* isolate = reinterpret_cast<i::Isolate*>(env->GetIsolate());\n+  v8::Local<v8::Value> global_object =\n+      v8::Utils::ToLocal(i::Handle<i::JSObject>(\n+          (isolate->context()->native_context()->global_object()), isolate));\n+  global_object_pointer = &global_object;\n+  v8::HeapProfiler* heap_profiler = env->GetIsolate()->GetHeapProfiler();\n+  heap_profiler->AddBuildEmbedderGraphCallback(BuildEmbedderGraphWithNamedEdges,\n+                                               nullptr);\n+  const v8::HeapSnapshot* snapshot = heap_profiler->TakeHeapSnapshot();\n+  CHECK(ValidateSnapshot(snapshot));\n+  CheckEmbedderGraphWithNamedEdges(env->GetIsolate(), snapshot);\n+}\n+\n struct GraphBuildingContext {\n   int counter = 0;\n };"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 101,
        "deletions": 7
    }
}