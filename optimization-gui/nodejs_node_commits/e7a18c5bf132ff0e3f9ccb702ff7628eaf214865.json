{
    "author": "devsnek",
    "message": "deps: cherry-pick 477df06 from upstream v8\n\nOriginal commit message:\n\n    [API] Expand BigInt API\n\n    Provide a more complete BigInt API.\n\n    Bug: v8:7712\n    Cq-Include-Trybots: luci.chromium.try:linux_chromium_rel_ng\n    Change-Id: Ic8562d616f3125deabdf8b52c7019b191bef0e07\n    Reviewed-on: chromium-review.googlesource.com/1101198\n    Commit-Queue: Yang Guo <yangguo@chromium.org>\n    Reviewed-by: Jakob Kummerow <jkummerow@chromium.org>\n    Reviewed-by: Yang Guo <yangguo@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#54122}\n\nPR-URL: https://github.com/nodejs/node/pull/21644\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "e7a18c5bf132ff0e3f9ccb702ff7628eaf214865",
    "files": [
        {
            "sha": "65eb7caf575498c3396fddb160c11613e19e7068",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=e7a18c5bf132ff0e3f9ccb702ff7628eaf214865",
            "patch": "@@ -28,7 +28,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.13',\n+    'v8_embedder_string': '-node.14',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "fe8f5a383952f7c63a80eb14af76bd80ffe3a72e",
            "filename": "deps/v8/include/v8.h",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/nodejs/node/blob/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Finclude%2Fv8.h",
            "raw_url": "https://github.com/nodejs/node/raw/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Finclude%2Fv8.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Finclude%2Fv8.h?ref=e7a18c5bf132ff0e3f9ccb702ff7628eaf214865",
            "patch": "@@ -3048,6 +3048,48 @@ class V8_EXPORT Uint32 : public Integer {\n class V8_EXPORT BigInt : public Primitive {\n  public:\n   static Local<BigInt> New(Isolate* isolate, int64_t value);\n+  static Local<BigInt> NewFromUnsigned(Isolate* isolate, uint64_t value);\n+  /**\n+   * Creates a new BigInt object using a specified sign bit and a\n+   * specified list of digits/words.\n+   * The resulting number is calculated as:\n+   *\n+   * (-1)^sign_bit * (words[0] * (2^64)^0 + words[1] * (2^64)^1 + ...)\n+   */\n+  static MaybeLocal<BigInt> NewFromWords(Local<Context> context, int sign_bit,\n+                                         int word_count, const uint64_t* words);\n+\n+  /**\n+   * Returns the value of this BigInt as an unsigned 64-bit integer.\n+   * If `lossless` is provided, it will reflect whether the return value was\n+   * truncated or wrapped around. In particular, it is set to `false` if this\n+   * BigInt is negative.\n+   */\n+  uint64_t Uint64Value(bool* lossless = nullptr) const;\n+\n+  /**\n+   * Returns the value of this BigInt as a signed 64-bit integer.\n+   * If `lossless` is provided, it will reflect whether this BigInt was\n+   * truncated or not.\n+   */\n+  int64_t Int64Value(bool* lossless = nullptr) const;\n+\n+  /**\n+   * Returns the number of 64-bit words needed to store the result of\n+   * ToWordsArray().\n+   */\n+  int WordCount() const;\n+\n+  /**\n+   * Writes the contents of this BigInt to a specified memory location.\n+   * `sign_bit` must be provided and will be set to 1 if this BigInt is\n+   * negative.\n+   * `*word_count` has to be initialized to the length of the `words` array.\n+   * Upon return, it will be set to the actual number of words that would\n+   * be needed to store this BigInt (i.e. the return value of `WordCount()`).\n+   */\n+  void ToWordsArray(int* sign_bit, int* word_count, uint64_t* words) const;\n+\n   V8_INLINE static BigInt* Cast(v8::Value* obj);\n \n  private:"
        },
        {
            "sha": "a7f6d00f6fabf7b3a5b2ceffb251e2d2d019689b",
            "filename": "deps/v8/src/api.cc",
            "status": "modified",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Fsrc%2Fapi.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Fsrc%2Fapi.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fapi.cc?ref=e7a18c5bf132ff0e3f9ccb702ff7628eaf214865",
            "patch": "@@ -8121,6 +8121,49 @@ Local<BigInt> v8::BigInt::New(Isolate* isolate, int64_t value) {\n   return Utils::ToLocal(result);\n }\n \n+Local<BigInt> v8::BigInt::NewFromUnsigned(Isolate* isolate, uint64_t value) {\n+  CHECK(i::FLAG_harmony_bigint);\n+  i::Isolate* internal_isolate = reinterpret_cast<i::Isolate*>(isolate);\n+  ENTER_V8_NO_SCRIPT_NO_EXCEPTION(internal_isolate);\n+  i::Handle<i::BigInt> result = i::BigInt::FromUint64(internal_isolate, value);\n+  return Utils::ToLocal(result);\n+}\n+\n+MaybeLocal<BigInt> v8::BigInt::NewFromWords(Local<Context> context,\n+                                            int sign_bit, int word_count,\n+                                            const uint64_t* words) {\n+  CHECK(i::FLAG_harmony_bigint);\n+  i::Isolate* isolate = reinterpret_cast<i::Isolate*>(context->GetIsolate());\n+  ENTER_V8_NO_SCRIPT(isolate, context, BigInt, NewFromWords,\n+                     MaybeLocal<BigInt>(), InternalEscapableScope);\n+  i::MaybeHandle<i::BigInt> result =\n+      i::BigInt::FromWords64(isolate, sign_bit, word_count, words);\n+  has_pending_exception = result.is_null();\n+  RETURN_ON_FAILED_EXECUTION(BigInt);\n+  RETURN_ESCAPED(Utils::ToLocal(result.ToHandleChecked()));\n+}\n+\n+uint64_t v8::BigInt::Uint64Value(bool* lossless) const {\n+  i::Handle<i::BigInt> handle = Utils::OpenHandle(this);\n+  return handle->AsUint64(lossless);\n+}\n+\n+int64_t v8::BigInt::Int64Value(bool* lossless) const {\n+  i::Handle<i::BigInt> handle = Utils::OpenHandle(this);\n+  return handle->AsInt64(lossless);\n+}\n+\n+int BigInt::WordCount() const {\n+  i::Handle<i::BigInt> handle = Utils::OpenHandle(this);\n+  return handle->Words64Count();\n+}\n+\n+void BigInt::ToWordsArray(int* sign_bit, int* word_count,\n+                          uint64_t* words) const {\n+  i::Handle<i::BigInt> handle = Utils::OpenHandle(this);\n+  return handle->ToWordsArray64(sign_bit, word_count, words);\n+}\n+\n void Isolate::ReportExternalAllocationLimitReached() {\n   i::Heap* heap = reinterpret_cast<i::Isolate*>(this)->heap();\n   if (heap->gc_state() != i::Heap::NOT_IN_GC) return;"
        },
        {
            "sha": "c67de0482df66c520b2d15fdaeb788060a36a6c4",
            "filename": "deps/v8/src/api.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Fsrc%2Fapi.h",
            "raw_url": "https://github.com/nodejs/node/raw/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Fsrc%2Fapi.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fapi.h?ref=e7a18c5bf132ff0e3f9ccb702ff7628eaf214865",
            "patch": "@@ -114,6 +114,7 @@ class RegisteredExtension {\n   V(Promise, JSPromise)                        \\\n   V(Primitive, Object)                         \\\n   V(PrimitiveArray, FixedArray)                \\\n+  V(BigInt, BigInt)                            \\\n   V(ScriptOrModule, Script)\n \n class Utils {"
        },
        {
            "sha": "3318055185521e3ef6f51dd140d4069ba03bcef6",
            "filename": "deps/v8/src/counters.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Fsrc%2Fcounters.h",
            "raw_url": "https://github.com/nodejs/node/raw/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Fsrc%2Fcounters.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fcounters.h?ref=e7a18c5bf132ff0e3f9ccb702ff7628eaf214865",
            "patch": "@@ -692,6 +692,7 @@ class RuntimeCallTimer final {\n   V(ArrayBuffer_New)                                       \\\n   V(Array_CloneElementAt)                                  \\\n   V(Array_New)                                             \\\n+  V(BigInt_NewFromWords)                                   \\\n   V(BigInt64Array_New)                                     \\\n   V(BigUint64Array_New)                                    \\\n   V(BigIntObject_New)                                      \\"
        },
        {
            "sha": "66962033ffe8b0c60f765ffd3e68ffaffb203f5e",
            "filename": "deps/v8/src/objects/bigint.cc",
            "status": "modified",
            "additions": 64,
            "deletions": 0,
            "changes": 64,
            "blob_url": "https://github.com/nodejs/node/blob/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Fsrc%2Fobjects%2Fbigint.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Fsrc%2Fobjects%2Fbigint.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fobjects%2Fbigint.cc?ref=e7a18c5bf132ff0e3f9ccb702ff7628eaf214865",
            "patch": "@@ -2205,6 +2205,70 @@ Handle<BigInt> BigInt::FromUint64(Isolate* isolate, uint64_t n) {\n   return MutableBigInt::MakeImmutable(result);\n }\n \n+MaybeHandle<BigInt> BigInt::FromWords64(Isolate* isolate, int sign_bit,\n+                                        int words64_count,\n+                                        const uint64_t* words) {\n+  if (words64_count < 0 || words64_count > kMaxLength / (64 / kDigitBits)) {\n+    THROW_NEW_ERROR(isolate, NewRangeError(MessageTemplate::kBigIntTooBig),\n+                    BigInt);\n+  }\n+  if (words64_count == 0) return MutableBigInt::Zero(isolate);\n+  STATIC_ASSERT(kDigitBits == 64 || kDigitBits == 32);\n+  int length = (64 / kDigitBits) * words64_count;\n+  DCHECK_GT(length, 0);\n+  if (kDigitBits == 32 && words[words64_count - 1] <= (1ULL << 32)) length--;\n+\n+  Handle<MutableBigInt> result;\n+  if (!MutableBigInt::New(isolate, length).ToHandle(&result)) {\n+    return MaybeHandle<BigInt>();\n+  }\n+\n+  result->set_sign(sign_bit);\n+  if (kDigitBits == 64) {\n+    for (int i = 0; i < length; ++i) {\n+      result->set_digit(i, static_cast<digit_t>(words[i]));\n+    }\n+  } else {\n+    for (int i = 0; i < length; i += 2) {\n+      digit_t lo = static_cast<digit_t>(words[i / 2]);\n+      digit_t hi = static_cast<digit_t>(words[i / 2] >> 32);\n+      result->set_digit(i, lo);\n+      if (i + 1 < length) result->set_digit(i + 1, hi);\n+    }\n+  }\n+\n+  return MutableBigInt::MakeImmutable(result);\n+}\n+\n+int BigInt::Words64Count() {\n+  STATIC_ASSERT(kDigitBits == 64 || kDigitBits == 32);\n+  return length() / (64 / kDigitBits) +\n+         (kDigitBits == 32 && length() % 2 == 1 ? 1 : 0);\n+}\n+\n+void BigInt::ToWordsArray64(int* sign_bit, int* words64_count,\n+                            uint64_t* words) {\n+  DCHECK_NE(sign_bit, nullptr);\n+  DCHECK_NE(words64_count, nullptr);\n+  *sign_bit = sign();\n+  int available_words = *words64_count;\n+  *words64_count = Words64Count();\n+  if (available_words == 0) return;\n+  DCHECK_NE(words, nullptr);\n+\n+  int len = length();\n+  if (kDigitBits == 64) {\n+    for (int i = 0; i < len && i < available_words; ++i) words[i] = digit(i);\n+  } else {\n+    for (int i = 0; i < len && available_words > 0; i += 2) {\n+      uint64_t lo = digit(i);\n+      uint64_t hi = (i + 1) < len ? digit(i + 1) : 0;\n+      words[i / 2] = lo | (hi << 32);\n+      available_words--;\n+    }\n+  }\n+}\n+\n uint64_t MutableBigInt::GetRawBits(BigIntBase* x, bool* lossless) {\n   if (lossless != nullptr) *lossless = true;\n   if (x->is_zero()) return 0;"
        },
        {
            "sha": "65ce808394452daf635ec236186f199f0ab5c4af",
            "filename": "deps/v8/src/objects/bigint.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Fsrc%2Fobjects%2Fbigint.h",
            "raw_url": "https://github.com/nodejs/node/raw/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Fsrc%2Fobjects%2Fbigint.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Fobjects%2Fbigint.h?ref=e7a18c5bf132ff0e3f9ccb702ff7628eaf214865",
            "patch": "@@ -144,8 +144,13 @@ class V8_EXPORT_PRIVATE BigInt : public BigIntBase {\n \n   static Handle<BigInt> FromInt64(Isolate* isolate, int64_t n);\n   static Handle<BigInt> FromUint64(Isolate* isolate, uint64_t n);\n+  static MaybeHandle<BigInt> FromWords64(Isolate* isolate, int sign_bit,\n+                                         int words64_count,\n+                                         const uint64_t* words);\n   int64_t AsInt64(bool* lossless = nullptr);\n   uint64_t AsUint64(bool* lossless = nullptr);\n+  int Words64Count();\n+  void ToWordsArray64(int* sign_bit, int* words64_count, uint64_t* words);\n \n   DECL_CAST(BigInt)\n   DECL_VERIFIER(BigInt)"
        },
        {
            "sha": "637dc7d2062f9a0d285f5cea0a062a4caeeb9791",
            "filename": "deps/v8/test/cctest/test-api.cc",
            "status": "modified",
            "additions": 114,
            "deletions": 0,
            "changes": 114,
            "blob_url": "https://github.com/nodejs/node/blob/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e7a18c5bf132ff0e3f9ccb702ff7628eaf214865/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-api.cc?ref=e7a18c5bf132ff0e3f9ccb702ff7628eaf214865",
            "patch": "@@ -27613,3 +27613,117 @@ TEST(WasmStreamingAbortNoReject) {\n   streaming.Abort({});\n   CHECK_EQ(streaming.GetPromise()->State(), v8::Promise::kPending);\n }\n+\n+TEST(BigIntAPI) {\n+  LocalContext env;\n+  v8::Isolate* isolate = env->GetIsolate();\n+  v8::HandleScope scope(isolate);\n+  bool lossless;\n+  uint64_t words1[10];\n+  uint64_t words2[10];\n+\n+  {\n+    Local<Value> bi = CompileRun(\"12n\");\n+    CHECK(bi->IsBigInt());\n+\n+    CHECK_EQ(bi.As<v8::BigInt>()->Uint64Value(), 12);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Uint64Value(&lossless), 12);\n+    CHECK_EQ(lossless, true);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Int64Value(), 12);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Int64Value(&lossless), 12);\n+    CHECK_EQ(lossless, true);\n+  }\n+\n+  {\n+    Local<Value> bi = CompileRun(\"-12n\");\n+    CHECK(bi->IsBigInt());\n+\n+    CHECK_EQ(bi.As<v8::BigInt>()->Uint64Value(), static_cast<uint64_t>(-12));\n+    CHECK_EQ(bi.As<v8::BigInt>()->Uint64Value(&lossless),\n+             static_cast<uint64_t>(-12));\n+    CHECK_EQ(lossless, false);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Int64Value(), -12);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Int64Value(&lossless), -12);\n+    CHECK_EQ(lossless, true);\n+  }\n+\n+  {\n+    Local<Value> bi = CompileRun(\"123456789012345678901234567890n\");\n+    CHECK(bi->IsBigInt());\n+\n+    CHECK_EQ(bi.As<v8::BigInt>()->Uint64Value(), 14083847773837265618ULL);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Uint64Value(&lossless),\n+             14083847773837265618ULL);\n+    CHECK_EQ(lossless, false);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Int64Value(), -4362896299872285998LL);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Int64Value(&lossless),\n+             -4362896299872285998LL);\n+    CHECK_EQ(lossless, false);\n+  }\n+\n+  {\n+    Local<Value> bi = CompileRun(\"-123456789012345678901234567890n\");\n+    CHECK(bi->IsBigInt());\n+\n+    CHECK_EQ(bi.As<v8::BigInt>()->Uint64Value(), 4362896299872285998LL);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Uint64Value(&lossless),\n+             4362896299872285998LL);\n+    CHECK_EQ(lossless, false);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Int64Value(), 4362896299872285998LL);\n+    CHECK_EQ(bi.As<v8::BigInt>()->Int64Value(&lossless), 4362896299872285998LL);\n+    CHECK_EQ(lossless, false);\n+  }\n+\n+  {\n+    Local<v8::BigInt> bi =\n+        v8::BigInt::NewFromWords(env.local(), 0, 0, words1).ToLocalChecked();\n+    CHECK_EQ(bi->Uint64Value(), 0);\n+    CHECK_EQ(bi->WordCount(), 0);\n+  }\n+\n+  {\n+    TryCatch try_catch(isolate);\n+    v8::MaybeLocal<v8::BigInt> bi = v8::BigInt::NewFromWords(\n+        env.local(), 0, std::numeric_limits<int>::max(), words1);\n+    CHECK(bi.IsEmpty());\n+    CHECK(try_catch.HasCaught());\n+  }\n+\n+  {\n+    TryCatch try_catch(isolate);\n+    v8::MaybeLocal<v8::BigInt> bi =\n+        v8::BigInt::NewFromWords(env.local(), 0, -1, words1);\n+    CHECK(bi.IsEmpty());\n+    CHECK(try_catch.HasCaught());\n+  }\n+\n+  {\n+    TryCatch try_catch(isolate);\n+    v8::MaybeLocal<v8::BigInt> bi =\n+        v8::BigInt::NewFromWords(env.local(), 0, 1 << 30, words1);\n+    CHECK(bi.IsEmpty());\n+    CHECK(try_catch.HasCaught());\n+  }\n+\n+  for (int sign_bit = 0; sign_bit <= 1; sign_bit++) {\n+    words1[0] = 0xffffffff00000000ULL;\n+    words1[1] = 0x00000000ffffffffULL;\n+    v8::Local<v8::BigInt> bi =\n+        v8::BigInt::NewFromWords(env.local(), sign_bit, 2, words1)\n+            .ToLocalChecked();\n+    CHECK_EQ(bi->Uint64Value(&lossless),\n+             sign_bit ? static_cast<uint64_t>(-static_cast<int64_t>(words1[0]))\n+                      : words1[0]);\n+    CHECK_EQ(lossless, false);\n+    CHECK_EQ(bi->Int64Value(&lossless), sign_bit\n+                                            ? -static_cast<int64_t>(words1[0])\n+                                            : static_cast<int64_t>(words1[0]));\n+    CHECK_EQ(lossless, false);\n+    CHECK_EQ(bi->WordCount(), 2);\n+    int real_sign_bit;\n+    int word_count = arraysize(words2);\n+    bi->ToWordsArray(&real_sign_bit, &word_count, words2);\n+    CHECK_EQ(real_sign_bit, sign_bit);\n+    CHECK_EQ(word_count, 2);\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 272,
        "additions": 271,
        "deletions": 1
    }
}