{
    "author": "joyeecheung",
    "message": "src: implement the new EmbedderGraph::AddEdge()\n\nThe signature of EmbedderGraph::AddEdge() has been changed so\nthe current implementation of JSGraph no longer compiles.\nThis patch updates the implementation accordingly.\n\nPR-URL: https://github.com/nodejs/node/pull/22106\nRefs: https://github.com/v8/v8/commit/6ee834532d6f924f6057584085fa79b4777c396a\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "2d72a9543c15be57c3b4a383f0c80d09245eb9ba",
    "files": [
        {
            "sha": "668dff3451686f8457911ba1810fa239f531280b",
            "filename": "src/heap_utils.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 7,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/2d72a9543c15be57c3b4a383f0c80d09245eb9ba/src%2Fheap_utils.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2d72a9543c15be57c3b4a383f0c80d09245eb9ba/src%2Fheap_utils.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fheap_utils.cc?ref=2d72a9543c15be57c3b4a383f0c80d09245eb9ba",
            "patch": "@@ -76,8 +76,8 @@ class JSGraph : public EmbedderGraph {\n     return n;\n   }\n \n-  void AddEdge(Node* from, Node* to) override {\n-    edges_[from].insert(to);\n+  void AddEdge(Node* from, Node* to, const char* name = nullptr) override {\n+    edges_[from].insert(std::make_pair(name, to));\n   }\n \n   MaybeLocal<Array> CreateObject() const {\n@@ -92,6 +92,7 @@ class JSGraph : public EmbedderGraph {\n     Local<String> size_string = FIXED_ONE_BYTE_STRING(isolate_, \"size\");\n     Local<String> value_string = FIXED_ONE_BYTE_STRING(isolate_, \"value\");\n     Local<String> wraps_string = FIXED_ONE_BYTE_STRING(isolate_, \"wraps\");\n+    Local<String> to_string = FIXED_ONE_BYTE_STRING(isolate_, \"to\");\n \n     for (const std::unique_ptr<Node>& n : nodes_)\n       info_objects[n.get()] = Object::New(isolate_);\n@@ -141,10 +142,23 @@ class JSGraph : public EmbedderGraph {\n       }\n \n       size_t i = 0;\n-      for (Node* target : edge_info.second) {\n-        if (edges.As<Array>()->Set(context,\n-                                   i++,\n-                                   info_objects[target]).IsNothing()) {\n+      size_t j = 0;\n+      for (const auto& edge : edge_info.second) {\n+        Local<Object> to_object = info_objects[edge.second];\n+        Local<Object> edge_info = Object::New(isolate_);\n+        Local<Value> edge_name_value;\n+        const char* edge_name = edge.first;\n+        if (edge_name != nullptr &&\n+            !String::NewFromUtf8(\n+                 isolate_, edge_name, v8::NewStringType::kNormal)\n+                 .ToLocal(&edge_name_value)) {\n+          return MaybeLocal<Array>();\n+        } else {\n+          edge_name_value = Number::New(isolate_, j++);\n+        }\n+        if (edge_info->Set(context, name_string, edge_name_value).IsNothing() ||\n+            edge_info->Set(context, to_string, to_object).IsNothing() ||\n+            edges.As<Array>()->Set(context, i++, edge_info).IsNothing()) {\n           return MaybeLocal<Array>();\n         }\n       }\n@@ -158,7 +172,7 @@ class JSGraph : public EmbedderGraph {\n   std::unordered_set<std::unique_ptr<Node>> nodes_;\n   std::unordered_set<JSGraphJSNode*, JSGraphJSNode::Hash, JSGraphJSNode::Equal>\n       engine_nodes_;\n-  std::unordered_map<Node*, std::unordered_set<Node*>> edges_;\n+  std::unordered_map<Node*, std::set<std::pair<const char*, Node*>>> edges_;\n };\n \n void BuildEmbedderGraph(const FunctionCallbackInfo<Value>& args) {"
        },
        {
            "sha": "a36223fa9c786c5b24aae0545357ae6cdccb52d0",
            "filename": "test/common/heap.js",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/2d72a9543c15be57c3b4a383f0c80d09245eb9ba/test%2Fcommon%2Fheap.js",
            "raw_url": "https://github.com/nodejs/node/raw/2d72a9543c15be57c3b4a383f0c80d09245eb9ba/test%2Fcommon%2Fheap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcommon%2Fheap.js?ref=2d72a9543c15be57c3b4a383f0c80d09245eb9ba",
            "patch": "@@ -47,15 +47,19 @@ class State {\n     else\n       assert.strictEqual(graph.length, expected.length);\n     for (const expectedNode of expected) {\n-      if (expectedNode.edges) {\n+      if (expectedNode.children) {\n         for (const expectedChild of expectedNode.children) {\n-          const check = typeof expectedChild === 'function' ?\n-            expectedChild : (node) => {\n-              return node.name === expectedChild.name ||\n-                (node.value &&\n-                 node.value.constructor &&\n-                 node.value.constructor.name === expectedChild.name);\n-            };\n+          const check = (edge) => {\n+            // TODO(joyeecheung): check the edge names\n+            const node = edge.to;\n+            if (typeof expectedChild === 'function') {\n+              return expectedChild(node);\n+            }\n+            return node.name === expectedChild.name ||\n+              (node.value &&\n+                node.value.constructor &&\n+                node.value.constructor.name === expectedChild.name);\n+          };\n \n           assert(graph.some((node) => node.edges.some(check)),\n                  `expected to find child ${util.inspect(expectedChild)} ` +"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 33,
        "deletions": 15
    }
}