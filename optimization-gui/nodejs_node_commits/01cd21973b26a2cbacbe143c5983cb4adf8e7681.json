{
    "author": "yaelhe",
    "message": "worker: enable passing command line flags\n\nThis PR adds the ability to provide Workers with their own\nexecArgv flags in replacement of the main thread's execArgv. Only\nper-Isolate/per-Environment options are allowed. Per-Process options\nand V8 flags are not allowed. Passing an empty execArgv array will\nreset per-Isolate and per-Environment options of the Worker to their\ndefaults. If execArgv option is not passed, the Worker will get\nthe same flags as the main thread.\n\nUsage example:\n```\nconst worker = new Worker(__filename, {\n    execArgv: ['--trace-warnings'],\n});\n```\n\nPR-URL: https://github.com/nodejs/node/pull/25467\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "01cd21973b26a2cbacbe143c5983cb4adf8e7681",
    "files": [
        {
            "sha": "96ba39dd486a2950f53c3b16de4099e6c26c71a0",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -1909,6 +1909,12 @@ The fulfilled value of a linking promise is not a `vm.SourceTextModule` object.\n The current module's status does not allow for this operation. The specific\n meaning of the error depends on the specific function.\n \n+<a id=\"ERR_WORKER_INVALID_EXEC_ARGV\"></a>\n+### ERR_WORKER_INVALID_EXEC_ARGV\n+\n+The `execArgv` option passed to the `Worker` constructor contains\n+invalid flags.\n+\n <a id=\"ERR_WORKER_PATH\"></a>\n ### ERR_WORKER_PATH\n "
        },
        {
            "sha": "05cafa9cb178e7c16ecd6545f7daf2dc1336c47e",
            "filename": "doc/api/worker_threads.md",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/doc%2Fapi%2Fworker_threads.md",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/doc%2Fapi%2Fworker_threads.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fworker_threads.md?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -316,13 +316,16 @@ if (isMainThread) {\n     occur as described in the [HTML structured clone algorithm][], and an error\n     will be thrown if the object cannot be cloned (e.g. because it contains\n     `function`s).\n-  * stdin {boolean} If this is set to `true`, then `worker.stdin` will\n+  * `stdin` {boolean} If this is set to `true`, then `worker.stdin` will\n     provide a writable stream whose contents will appear as `process.stdin`\n     inside the Worker. By default, no data is provided.\n-  * stdout {boolean} If this is set to `true`, then `worker.stdout` will\n+  * `stdout` {boolean} If this is set to `true`, then `worker.stdout` will\n     not automatically be piped through to `process.stdout` in the parent.\n-  * stderr {boolean} If this is set to `true`, then `worker.stderr` will\n+  * `stderr` {boolean} If this is set to `true`, then `worker.stderr` will\n     not automatically be piped through to `process.stderr` in the parent.\n+  * `execArgv` {string[]} List of node CLI options passed to the worker.\n+    V8 options (such as `--max-old-space-size`) and options that affect the\n+    process (such as `--title`) are not supported.\n \n ### Event: 'error'\n <!-- YAML"
        },
        {
            "sha": "b33cd2710960b6a5878d7ea7cb8e783d41d0e59c",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -992,6 +992,9 @@ E('ERR_VM_MODULE_NOT_LINKED',\n E('ERR_VM_MODULE_NOT_MODULE',\n   'Provided module is not an instance of Module', Error);\n E('ERR_VM_MODULE_STATUS', 'Module status %s', Error);\n+E('ERR_WORKER_INVALID_EXEC_ARGV', (errors) =>\n+  `Initiated Worker with invalid execArgv flags: ${errors.join(', ')}`,\n+  Error);\n E('ERR_WORKER_PATH',\n   'The worker script filename must be an absolute path or a relative ' +\n   'path starting with \\'./\\' or \\'../\\'. Received \"%s\"',"
        },
        {
            "sha": "e20a37af8a7d6b8180ada7589a371982ddfa8773",
            "filename": "lib/internal/worker.js",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/lib%2Finternal%2Fworker.js",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/lib%2Finternal%2Fworker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fworker.js?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -8,6 +8,8 @@ const {\n   ERR_WORKER_PATH,\n   ERR_WORKER_UNSERIALIZABLE_ERROR,\n   ERR_WORKER_UNSUPPORTED_EXTENSION,\n+  ERR_WORKER_INVALID_EXEC_ARGV,\n+  ERR_INVALID_ARG_TYPE,\n } = require('internal/errors').codes;\n const { validateString } = require('internal/validators');\n \n@@ -49,7 +51,11 @@ class Worker extends EventEmitter {\n     super();\n     debug(`[${threadId}] create new worker`, filename, options);\n     validateString(filename, 'filename');\n-\n+    if (options.execArgv && !Array.isArray(options.execArgv)) {\n+      throw new ERR_INVALID_ARG_TYPE('options.execArgv',\n+                                     'array',\n+                                     options.execArgv);\n+    }\n     if (!options.eval) {\n       if (!path.isAbsolute(filename) &&\n           !filename.startsWith('./') &&\n@@ -68,7 +74,10 @@ class Worker extends EventEmitter {\n \n     const url = options.eval ? null : pathToFileURL(filename);\n     // Set up the C++ handle for the worker, as well as some internal wiring.\n-    this[kHandle] = new WorkerImpl(url);\n+    this[kHandle] = new WorkerImpl(url, options.execArgv);\n+    if (this[kHandle].invalidExecArgv) {\n+      throw new ERR_WORKER_INVALID_EXEC_ARGV(this[kHandle].invalidExecArgv);\n+    }\n     this[kHandle].onexit = (code) => this[kOnExit](code);\n     this[kPort] = this[kHandle].messagePort;\n     this[kPort].on('message', (data) => this[kOnMessage](data));"
        },
        {
            "sha": "d5bf6bc086ab775fb71b3b4041fd8c1c6b392144",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -595,6 +595,11 @@ inline std::shared_ptr<PerIsolateOptions> IsolateData::options() {\n   return options_;\n }\n \n+inline void IsolateData::set_options(\n+    std::shared_ptr<PerIsolateOptions> options) {\n+  options_ = options;\n+}\n+\n void Environment::CreateImmediate(native_immediate_callback cb,\n                                   void* data,\n                                   v8::Local<v8::Object> obj,"
        },
        {
            "sha": "711d07963a5f100ed391ad33729c8557a8107fb9",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -394,6 +394,7 @@ class IsolateData {\n   inline uint32_t* zero_fill_field() const;\n   inline MultiIsolatePlatform* platform() const;\n   inline std::shared_ptr<PerIsolateOptions> options();\n+  inline void set_options(std::shared_ptr<PerIsolateOptions> options);\n \n #define VP(PropertyName, StringValue) V(v8::Private, PropertyName)\n #define VY(PropertyName, StringValue) V(v8::Symbol, PropertyName)"
        },
        {
            "sha": "30004957a47442f5f3b3b08c169f23a17822ad17",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 64,
            "deletions": 3,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -10,7 +10,9 @@\n #include \"async_wrap-inl.h\"\n \n #include <string>\n+#include <vector>\n \n+using node::options_parser::kDisallowedInEnvironment;\n using v8::ArrayBuffer;\n using v8::Context;\n using v8::Function;\n@@ -68,7 +70,10 @@ void WaitForWorkerInspectorToStop(Environment* child) {}\n \n }  // anonymous namespace\n \n-Worker::Worker(Environment* env, Local<Object> wrap, const std::string& url)\n+Worker::Worker(Environment* env,\n+               Local<Object> wrap,\n+               const std::string& url,\n+               std::shared_ptr<PerIsolateOptions> per_isolate_opts)\n     : AsyncWrap(env, wrap, AsyncWrap::PROVIDER_WORKER), url_(url) {\n   // Generate a new thread id.\n   {\n@@ -113,6 +118,9 @@ Worker::Worker(Environment* env, Local<Object> wrap, const std::string& url)\n                                           &loop_,\n                                           env->isolate_data()->platform(),\n                                           array_buffer_allocator_.get()));\n+    if (per_isolate_opts != nullptr) {\n+      isolate_data_->set_options(per_isolate_opts);\n+    }\n     CHECK(isolate_data_);\n \n     Local<Context> context = NewContext(isolate_);\n@@ -391,14 +399,67 @@ void Worker::New(const FunctionCallbackInfo<Value>& args) {\n   }\n \n   std::string url;\n+  std::shared_ptr<PerIsolateOptions> per_isolate_opts = nullptr;\n+\n   // Argument might be a string or URL\n-  if (args.Length() == 1 && !args[0]->IsNullOrUndefined()) {\n+  if (args.Length() > 0 && !args[0]->IsNullOrUndefined()) {\n     Utf8Value value(\n         args.GetIsolate(),\n         args[0]->ToString(env->context()).FromMaybe(v8::Local<v8::String>()));\n     url.append(value.out(), value.length());\n+\n+    if (args.Length() > 1 && args[1]->IsArray()) {\n+      v8::Local<v8::Array> array = args[1].As<v8::Array>();\n+      // The first argument is reserved for program name, but we don't need it\n+      // in workers.\n+      std::vector<std::string> exec_argv = {\"\"};\n+      uint32_t length = array->Length();\n+      for (uint32_t i = 0; i < length; i++) {\n+        v8::Local<v8::Value> arg;\n+        if (!array->Get(env->context(), i).ToLocal(&arg)) {\n+          return;\n+        }\n+        v8::MaybeLocal<v8::String> arg_v8_string =\n+            arg->ToString(env->context());\n+        if (arg_v8_string.IsEmpty()) {\n+          return;\n+        }\n+        Utf8Value arg_utf8_value(\n+            args.GetIsolate(),\n+            arg_v8_string.FromMaybe(v8::Local<v8::String>()));\n+        std::string arg_string(arg_utf8_value.out(), arg_utf8_value.length());\n+        exec_argv.push_back(arg_string);\n+      }\n+\n+      std::vector<std::string> invalid_args{};\n+      std::vector<std::string> errors{};\n+      per_isolate_opts.reset(new PerIsolateOptions());\n+\n+      // Using invalid_args as the v8_args argument as it stores unknown\n+      // options for the per isolate parser.\n+      options_parser::PerIsolateOptionsParser::instance.Parse(\n+          &exec_argv,\n+          nullptr,\n+          &invalid_args,\n+          per_isolate_opts.get(),\n+          kDisallowedInEnvironment,\n+          &errors);\n+\n+      // The first argument is program name.\n+      invalid_args.erase(invalid_args.begin());\n+      if (errors.size() > 0 || invalid_args.size() > 0) {\n+        v8::Local<v8::Value> value =\n+            ToV8Value(env->context(),\n+                      errors.size() > 0 ? errors : invalid_args)\n+                .ToLocalChecked();\n+        Local<String> key =\n+            FIXED_ONE_BYTE_STRING(env->isolate(), \"invalidExecArgv\");\n+        args.This()->Set(env->context(), key, value).FromJust();\n+        return;\n+      }\n+    }\n   }\n-  new Worker(env, args.This(), url);\n+  new Worker(env, args.This(), url, per_isolate_opts);\n }\n \n void Worker::StartThread(const FunctionCallbackInfo<Value>& args) {"
        },
        {
            "sha": "dd054ac38d5f76f309a9b41284cb4db71e3140d3",
            "filename": "src/node_worker.h",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/src%2Fnode_worker.h",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/src%2Fnode_worker.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.h?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -12,7 +12,10 @@ namespace worker {\n // A worker thread, as represented in its parent thread.\n class Worker : public AsyncWrap {\n  public:\n-  Worker(Environment* env, v8::Local<v8::Object> wrap, const std::string& url);\n+  Worker(Environment* env,\n+         v8::Local<v8::Object> wrap,\n+         const std::string& url,\n+         std::shared_ptr<PerIsolateOptions> per_isolate_opts);\n   ~Worker();\n \n   // Run the worker. This is only called from the worker thread."
        },
        {
            "sha": "e53a9a9fe42ca813ac88157d7162ab1b4797a039",
            "filename": "test/parallel/test-internal-errors.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/test%2Fparallel%2Ftest-internal-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/test%2Fparallel%2Ftest-internal-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-internal-errors.js?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -269,3 +269,13 @@ assert.strictEqual(\n \n   restoreStdout();\n }\n+\n+{\n+  const error = new errors.codes.ERR_WORKER_INVALID_EXEC_ARGV(\n+    ['--foo, --bar']\n+  );\n+  assert.strictEqual(\n+    error.message,\n+    'Initiated Worker with invalid execArgv flags: --foo, --bar'\n+  );\n+}"
        },
        {
            "sha": "e2deaf5464113ac310313dee210a040b1fa00305",
            "filename": "test/parallel/test-worker-execargv-invalid.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/test%2Fparallel%2Ftest-worker-execargv-invalid.js",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/test%2Fparallel%2Ftest-worker-execargv-invalid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-execargv-invalid.js?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -0,0 +1,35 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const { Worker } = require('worker_threads');\n+\n+{\n+  const expectedErr = common.expectsError({\n+    code: 'ERR_INVALID_ARG_TYPE',\n+    type: TypeError\n+  }, 2);\n+\n+  assert.throws(() => {\n+    new Worker(__filename, { execArgv: 'hello' });\n+  }, expectedErr);\n+  assert.throws(() => {\n+    new Worker(__filename, { execArgv: 6 });\n+  }, expectedErr);\n+}\n+\n+{\n+  const expectedErr = common.expectsError({\n+    code: 'ERR_WORKER_INVALID_EXEC_ARGV',\n+    type: Error\n+  }, 3);\n+  assert.throws(() => {\n+    new Worker(__filename, { execArgv: ['--foo'] });\n+  }, expectedErr);\n+  assert.throws(() => {\n+    new Worker(__filename, { execArgv: ['--title=blah'] });\n+  }, expectedErr);\n+  assert.throws(() => {\n+    new Worker(__filename, { execArgv: ['--redirect-warnings'] });\n+  }, expectedErr);\n+}"
        },
        {
            "sha": "e04f015e03e2ffd9f4511f195970547ce05a5d1c",
            "filename": "test/parallel/test-worker-execargv.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/01cd21973b26a2cbacbe143c5983cb4adf8e7681/test%2Fparallel%2Ftest-worker-execargv.js",
            "raw_url": "https://github.com/nodejs/node/raw/01cd21973b26a2cbacbe143c5983cb4adf8e7681/test%2Fparallel%2Ftest-worker-execargv.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-execargv.js?ref=01cd21973b26a2cbacbe143c5983cb4adf8e7681",
            "patch": "@@ -0,0 +1,22 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+\n+// This test ensures that Workers have the ability to get\n+// their own command line flags.\n+\n+const { Worker, isMainThread } = require('worker_threads');\n+const { StringDecoder } = require('string_decoder');\n+const decoder = new StringDecoder('utf8');\n+\n+if (isMainThread) {\n+  const w = new Worker(__filename, { execArgv: ['--trace-warnings'] });\n+  w.stderr.on('data', common.mustCall((chunk) => {\n+    const error = decoder.write(chunk);\n+    assert.ok(\n+      /Warning: some warning[\\s\\S]*at Object\\.<anonymous>/.test(error)\n+    );\n+  }));\n+} else {\n+  process.emitWarning('some warning');\n+}"
        }
    ],
    "stats": {
        "total": 176,
        "additions": 167,
        "deletions": 9
    }
}