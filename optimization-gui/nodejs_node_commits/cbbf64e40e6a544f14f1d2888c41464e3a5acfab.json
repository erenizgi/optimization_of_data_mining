{
    "author": "addaleax",
    "message": "tls: do not rely on 'drain' handlers in StreamWrap\n\n`'drain'` event handlers may not be invoked if the stream\nis currently finishing. Instead, use the fact that we know\nwhen writes are active or not, and invoke the delayed shutdown\nhandler from our own after-write callback.\n\nPR-URL: https://github.com/nodejs/node/pull/24290\nRefs: https://github.com/nodejs/node/pull/24288\nRefs: https://github.com/nodejs/node/pull/24075\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Ouyang Yadong <oyydoibh@gmail.com>",
    "sha": "cbbf64e40e6a544f14f1d2888c41464e3a5acfab",
    "files": [
        {
            "sha": "cf8f45aa4505ffdd0133d0c3b36ae13d8e470246",
            "filename": "lib/internal/wrap_js_stream.js",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/cbbf64e40e6a544f14f1d2888c41464e3a5acfab/lib%2Finternal%2Fwrap_js_stream.js",
            "raw_url": "https://github.com/nodejs/node/raw/cbbf64e40e6a544f14f1d2888c41464e3a5acfab/lib%2Finternal%2Fwrap_js_stream.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fwrap_js_stream.js?ref=cbbf64e40e6a544f14f1d2888c41464e3a5acfab",
            "patch": "@@ -11,6 +11,7 @@ const { ERR_STREAM_WRAP } = require('internal/errors').codes;\n \n const kCurrentWriteRequest = Symbol('kCurrentWriteRequest');\n const kCurrentShutdownRequest = Symbol('kCurrentShutdownRequest');\n+const kPendingShutdownRequest = Symbol('kPendingShutdownRequest');\n \n function isClosing() { return this[owner_symbol].isClosing(); }\n function onreadstart() { return this[owner_symbol].readStart(); }\n@@ -79,6 +80,7 @@ class JSStreamWrap extends Socket {\n     this.stream = stream;\n     this[kCurrentWriteRequest] = null;\n     this[kCurrentShutdownRequest] = null;\n+    this[kPendingShutdownRequest] = null;\n     this.readable = stream.readable;\n     this.writable = stream.writable;\n \n@@ -115,8 +117,10 @@ class JSStreamWrap extends Socket {\n     // Working around that on the native side is not quite trivial (yet?),\n     // so for now that is supported here.\n \n-    if (this[kCurrentWriteRequest] !== null)\n-      return this.once('drain', () => this.doShutdown(req));\n+    if (this[kCurrentWriteRequest] !== null) {\n+      this[kPendingShutdownRequest] = req;\n+      return 0;\n+    }\n     assert.strictEqual(this[kCurrentWriteRequest], null);\n     assert.strictEqual(this[kCurrentShutdownRequest], null);\n     this[kCurrentShutdownRequest] = req;\n@@ -189,6 +193,11 @@ class JSStreamWrap extends Socket {\n     this[kCurrentWriteRequest] = null;\n \n     handle.finishWrite(req, errCode);\n+    if (this[kPendingShutdownRequest]) {\n+      const req = this[kPendingShutdownRequest];\n+      this[kPendingShutdownRequest] = null;\n+      this.doShutdown(req);\n+    }\n   }\n \n   doClose(cb) {"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 11,
        "deletions": 2
    }
}