{
    "author": "addaleax",
    "message": "worker: set stack size for worker threads\n\nThis is so we can inform V8 about a known limit for the stack.\n\nOtherwise, on some systems recursive functions may lead to\nsegmentation faults rather than “safe” failures.\n\nPR-URL: https://github.com/nodejs/node/pull/26049\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "a80b29b38a66cec456e4ec73fb8030f45d186005",
    "files": [
        {
            "sha": "f38b187c18c5b8836ddb5d9ef4104b18af7138d6",
            "filename": "src/node_worker.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/a80b29b38a66cec456e4ec73fb8030f45d186005/src%2Fnode_worker.cc",
            "raw_url": "https://github.com/nodejs/node/raw/a80b29b38a66cec456e4ec73fb8030f45d186005/src%2Fnode_worker.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.cc?ref=a80b29b38a66cec456e4ec73fb8030f45d186005",
            "patch": "@@ -118,6 +118,8 @@ class WorkerThreadData {\n     {\n       Locker locker(isolate);\n       Isolate::Scope isolate_scope(isolate);\n+      isolate->SetStackLimit(w_->stack_base_);\n+\n       HandleScope handle_scope(isolate);\n       isolate_data_.reset(CreateIsolateData(isolate,\n                                             &loop_,\n@@ -488,8 +490,17 @@ void Worker::StartThread(const FunctionCallbackInfo<Value>& args) {\n     static_cast<Worker*>(handle->data)->OnThreadStopped();\n   }), 0);\n \n-  CHECK_EQ(uv_thread_create(&w->tid_, [](void* arg) {\n+  uv_thread_options_t thread_options;\n+  thread_options.flags = UV_THREAD_HAS_STACK_SIZE;\n+  thread_options.stack_size = kStackSize;\n+  CHECK_EQ(uv_thread_create_ex(&w->tid_, &thread_options, [](void* arg) {\n     Worker* w = static_cast<Worker*>(arg);\n+    const uintptr_t stack_top = reinterpret_cast<uintptr_t>(&arg);\n+\n+    // Leave a few kilobytes just to make sure we're within limits and have\n+    // some space to do work in C++ land.\n+    w->stack_base_ = stack_top - (kStackSize - kStackBufferSize);\n+\n     w->Run();\n \n     Mutex::ScopedLock lock(w->mutex_);"
        },
        {
            "sha": "68848c859990f097c450e05d45309ea2ffdd95ed",
            "filename": "src/node_worker.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/a80b29b38a66cec456e4ec73fb8030f45d186005/src%2Fnode_worker.h",
            "raw_url": "https://github.com/nodejs/node/raw/a80b29b38a66cec456e4ec73fb8030f45d186005/src%2Fnode_worker.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_worker.h?ref=a80b29b38a66cec456e4ec73fb8030f45d186005",
            "patch": "@@ -80,6 +80,12 @@ class Worker : public AsyncWrap {\n   bool thread_joined_ = true;\n   int exit_code_ = 0;\n   uint64_t thread_id_ = -1;\n+  uintptr_t stack_base_;\n+\n+  // Full size of the thread's stack.\n+  static constexpr size_t kStackSize = 4 * 1024 * 1024;\n+  // Stack buffer size that is not available to the JS engine.\n+  static constexpr size_t kStackBufferSize = 192 * 1024;\n \n   std::unique_ptr<MessagePortData> child_port_data_;\n "
        },
        {
            "sha": "99a34b5369006fd2d5f6d710ef961d140a07c9ad",
            "filename": "test/parallel/test-worker-stack-overflow.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/a80b29b38a66cec456e4ec73fb8030f45d186005/test%2Fparallel%2Ftest-worker-stack-overflow.js",
            "raw_url": "https://github.com/nodejs/node/raw/a80b29b38a66cec456e4ec73fb8030f45d186005/test%2Fparallel%2Ftest-worker-stack-overflow.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-stack-overflow.js?ref=a80b29b38a66cec456e4ec73fb8030f45d186005",
            "patch": "@@ -0,0 +1,11 @@\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const { Worker } = require('worker_threads');\n+\n+const worker = new Worker('function f() { f(); } f();', { eval: true });\n+\n+worker.on('error', common.mustCall((err) => {\n+  assert.strictEqual(err.constructor, RangeError);\n+  assert.strictEqual(err.message, 'Maximum call stack size exceeded');\n+}));"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 29,
        "deletions": 1
    }
}