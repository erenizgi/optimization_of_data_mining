{
    "author": "apapirovski",
    "message": "timers: fix priority queue removeAt fn\n\nPR-URL: https://github.com/nodejs/node/pull/23870\nFixes: https://github.com/nodejs/node/issues/23860\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "958d5b7f1d1fa47133de48625abb2fb3aa7b8ffd",
    "files": [
        {
            "sha": "2f1db934b43cc8faa0f06a1170922b8db60fd307",
            "filename": "lib/internal/priority_queue.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/958d5b7f1d1fa47133de48625abb2fb3aa7b8ffd/lib%2Finternal%2Fpriority_queue.js",
            "raw_url": "https://github.com/nodejs/node/raw/958d5b7f1d1fa47133de48625abb2fb3aa7b8ffd/lib%2Finternal%2Fpriority_queue.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fpriority_queue.js?ref=958d5b7f1d1fa47133de48625abb2fb3aa7b8ffd",
            "patch": "@@ -83,8 +83,13 @@ module.exports = class PriorityQueue {\n     heap[pos] = heap[size + 1];\n     heap[size + 1] = undefined;\n \n-    if (size > 0)\n+    if (size > 0) {\n+      // If not removing the last item, update the shifted item's position.\n+      if (pos <= size && this[kSetPosition] !== undefined)\n+        this[kSetPosition](heap[pos], pos);\n+\n       this.percolateDown(1);\n+    }\n   }\n \n   remove(value) {"
        },
        {
            "sha": "702b5528ba9611fe3e0da9fadc7f9f21c8bfe43c",
            "filename": "test/parallel/test-priority-queue.js",
            "status": "modified",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/958d5b7f1d1fa47133de48625abb2fb3aa7b8ffd/test%2Fparallel%2Ftest-priority-queue.js",
            "raw_url": "https://github.com/nodejs/node/raw/958d5b7f1d1fa47133de48625abb2fb3aa7b8ffd/test%2Fparallel%2Ftest-priority-queue.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-priority-queue.js?ref=958d5b7f1d1fa47133de48625abb2fb3aa7b8ffd",
            "patch": "@@ -95,3 +95,39 @@ const PriorityQueue = require('internal/priority_queue');\n \n   assert.strictEqual(queue.peek(), undefined);\n }\n+\n+{\n+  const queue = new PriorityQueue((a, b) => {\n+    return a.value - b.value;\n+  }, (node, pos) => (node.position = pos));\n+\n+  queue.insert({ value: 1, position: null });\n+  queue.insert({ value: 2, position: null });\n+  queue.insert({ value: 3, position: null });\n+  queue.insert({ value: 4, position: null });\n+  queue.insert({ value: 5, position: null });\n+\n+  queue.insert({ value: 2, position: null });\n+  const secondLargest = { value: 10, position: null };\n+  queue.insert(secondLargest);\n+  const largest = { value: 15, position: null };\n+  queue.insert(largest);\n+\n+  queue.removeAt(5);\n+  assert.strictEqual(largest.position, 5);\n+\n+  // check that removing 2nd to last item works fine\n+  queue.removeAt(6);\n+  assert.strictEqual(secondLargest.position, 6);\n+\n+  // check that removing the last item doesn't throw\n+  queue.removeAt(6);\n+\n+  assert.strictEqual(queue.shift().value, 1);\n+  assert.strictEqual(queue.shift().value, 2);\n+  assert.strictEqual(queue.shift().value, 2);\n+  assert.strictEqual(queue.shift().value, 4);\n+  assert.strictEqual(queue.shift().value, 15);\n+\n+  assert.strictEqual(queue.shift(), undefined);\n+}"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 42,
        "deletions": 1
    }
}