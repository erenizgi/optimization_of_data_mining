{
    "author": "joyeecheung",
    "message": "src: move async hooks trace events setup to pre_execution.js\n\nReasons:\n\n- Moves more environment-dependent setup out of bootstrap/node.js\n- No async operations should be done before the call to\n  the setup functions in pre_execution.js so no async hooks should be\n  triggered before that. Therefore it is safe to delay the setup\n  until then.\n\nPR-URL: https://github.com/nodejs/node/pull/26062\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "435eea6400522189c9e521bde32134b03791a576",
    "files": [
        {
            "sha": "aa0a6b282e138a515d648961072aeae11df88ebc",
            "filename": "lib/internal/bootstrap/node.js",
            "status": "modified",
            "additions": 0,
            "deletions": 31,
            "changes": 31,
            "blob_url": "https://github.com/nodejs/node/blob/435eea6400522189c9e521bde32134b03791a576/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "raw_url": "https://github.com/nodejs/node/raw/435eea6400522189c9e521bde32134b03791a576/lib%2Finternal%2Fbootstrap%2Fnode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fnode.js?ref=435eea6400522189c9e521bde32134b03791a576",
            "patch": "@@ -42,8 +42,6 @@ const { getOptionValue } = NativeModule.require('internal/options');\n const config = internalBinding('config');\n const { deprecate } = NativeModule.require('internal/util');\n \n-setupTraceCategoryState();\n-\n setupProcessObject();\n \n setupGlobalProxy();\n@@ -316,35 +314,6 @@ if (getOptionValue('--experimental-report')) {\n   }\n }\n \n-function setupTraceCategoryState() {\n-  const {\n-    traceCategoryState,\n-    setTraceCategoryStateUpdateHandler\n-  } = internalBinding('trace_events');\n-  const kCategoryAsyncHooks = 0;\n-  let traceEventsAsyncHook;\n-\n-  function toggleTraceCategoryState() {\n-    // Dynamically enable/disable the traceEventsAsyncHook\n-    const asyncHooksEnabled = !!traceCategoryState[kCategoryAsyncHooks];\n-\n-    if (asyncHooksEnabled) {\n-      // Lazy load internal/trace_events_async_hooks only if the async_hooks\n-      // trace event category is enabled.\n-      if (!traceEventsAsyncHook) {\n-        traceEventsAsyncHook =\n-          NativeModule.require('internal/trace_events_async_hooks');\n-      }\n-      traceEventsAsyncHook.enable();\n-    } else if (traceEventsAsyncHook) {\n-      traceEventsAsyncHook.disable();\n-    }\n-  }\n-\n-  toggleTraceCategoryState();\n-  setTraceCategoryStateUpdateHandler(toggleTraceCategoryState);\n-}\n-\n function setupProcessObject() {\n   const EventEmitter = NativeModule.require('events');\n   const origProcProto = Object.getPrototypeOf(process);"
        },
        {
            "sha": "8c9d7e1eafec731cf5162f16960cb4cf1cfea07f",
            "filename": "lib/internal/bootstrap/pre_execution.js",
            "status": "modified",
            "additions": 32,
            "deletions": 1,
            "changes": 33,
            "blob_url": "https://github.com/nodejs/node/blob/435eea6400522189c9e521bde32134b03791a576/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "raw_url": "https://github.com/nodejs/node/raw/435eea6400522189c9e521bde32134b03791a576/lib%2Finternal%2Fbootstrap%2Fpre_execution.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fpre_execution.js?ref=435eea6400522189c9e521bde32134b03791a576",
            "patch": "@@ -3,6 +3,8 @@\n const { getOptionValue } = require('internal/options');\n \n function prepareMainThreadExecution() {\n+  setupTraceCategoryState();\n+\n   // If the process is spawned with env NODE_CHANNEL_FD, it's probably\n   // spawned by our child_process module, then initialize IPC.\n   // This attaches some internal event listeners and creates:\n@@ -23,6 +25,34 @@ function prepareMainThreadExecution() {\n   loadPreloadModules();\n }\n \n+function setupTraceCategoryState() {\n+  const {\n+    traceCategoryState,\n+    setTraceCategoryStateUpdateHandler\n+  } = internalBinding('trace_events');\n+  const kCategoryAsyncHooks = 0;\n+  let traceEventsAsyncHook;\n+\n+  function toggleTraceCategoryState() {\n+    // Dynamically enable/disable the traceEventsAsyncHook\n+    const asyncHooksEnabled = !!traceCategoryState[kCategoryAsyncHooks];\n+\n+    if (asyncHooksEnabled) {\n+      // Lazy load internal/trace_events_async_hooks only if the async_hooks\n+      // trace event category is enabled.\n+      if (!traceEventsAsyncHook) {\n+        traceEventsAsyncHook = require('internal/trace_events_async_hooks');\n+      }\n+      traceEventsAsyncHook.enable();\n+    } else if (traceEventsAsyncHook) {\n+      traceEventsAsyncHook.disable();\n+    }\n+  }\n+\n+  toggleTraceCategoryState();\n+  setTraceCategoryStateUpdateHandler(toggleTraceCategoryState);\n+}\n+\n // In general deprecations are intialized wherever the APIs are implemented,\n // this is used to deprecate APIs implemented in C++ where the deprecation\n // utitlities are not easily accessible.\n@@ -150,5 +180,6 @@ module.exports = {\n   prepareMainThreadExecution,\n   initializeDeprecations,\n   initializeESMLoader,\n-  loadPreloadModules\n+  loadPreloadModules,\n+  setupTraceCategoryState\n };"
        },
        {
            "sha": "7df70b272091ff70cb2fc4380ed0dffcb446034e",
            "filename": "lib/internal/main/check_syntax.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/435eea6400522189c9e521bde32134b03791a576/lib%2Finternal%2Fmain%2Fcheck_syntax.js",
            "raw_url": "https://github.com/nodejs/node/raw/435eea6400522189c9e521bde32134b03791a576/lib%2Finternal%2Fmain%2Fcheck_syntax.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fcheck_syntax.js?ref=435eea6400522189c9e521bde32134b03791a576",
            "patch": "@@ -22,14 +22,16 @@ if (process.argv[1] && process.argv[1] !== '-') {\n   // Expand process.argv[1] into a full path.\n   const path = require('path');\n   process.argv[1] = path.resolve(process.argv[1]);\n+\n+  // TODO(joyeecheung): not every one of these are necessary\n+  prepareMainThreadExecution();\n+\n   // Read the source.\n   const filename = CJSModule._resolveFilename(process.argv[1]);\n \n   const fs = require('fs');\n   const source = fs.readFileSync(filename, 'utf-8');\n \n-  // TODO(joyeecheung): not every one of these are necessary\n-  prepareMainThreadExecution();\n   markBootstrapComplete();\n \n   checkScriptSyntax(source, filename);"
        },
        {
            "sha": "13c1b136edaf43078457f94309c5957a582eeaf9",
            "filename": "lib/internal/main/worker_thread.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/435eea6400522189c9e521bde32134b03791a576/lib%2Finternal%2Fmain%2Fworker_thread.js",
            "raw_url": "https://github.com/nodejs/node/raw/435eea6400522189c9e521bde32134b03791a576/lib%2Finternal%2Fmain%2Fworker_thread.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fmain%2Fworker_thread.js?ref=435eea6400522189c9e521bde32134b03791a576",
            "patch": "@@ -6,7 +6,8 @@\n const {\n   initializeDeprecations,\n   initializeESMLoader,\n-  loadPreloadModules\n+  loadPreloadModules,\n+  setupTraceCategoryState\n } = require('internal/bootstrap/pre_execution');\n \n const {\n@@ -72,6 +73,8 @@ port.on('message', (message) => {\n       manifestURL,\n       hasStdin\n     } = message;\n+\n+    setupTraceCategoryState();\n     if (manifestSrc) {\n       require('internal/process/policy').setup(manifestSrc, manifestURL);\n     }"
        }
    ],
    "stats": {
        "total": 75,
        "additions": 40,
        "deletions": 35
    }
}