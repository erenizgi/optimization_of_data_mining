{
    "author": "lundibundi",
    "message": "test: harden test-gc-http-client-timeout\n\n* decrease number of requests 500 -> 300\n* extract 'cb' to a file-local function\n\nThis should make test more reliable and less resource intensive.\n\nPR-URL: https://github.com/nodejs/node/pull/23184\nRefs: https://github.com/nodejs/node/issues/23066\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "69a422bba7810a6f34b2783bbd8ed5b7da86d008",
    "files": [
        {
            "sha": "359f890dc3944e13cf71186a1eac8e00b978f5a4",
            "filename": "test/sequential/test-gc-http-client-timeout.js",
            "status": "modified",
            "additions": 18,
            "deletions": 20,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/69a422bba7810a6f34b2783bbd8ed5b7da86d008/test%2Fsequential%2Ftest-gc-http-client-timeout.js",
            "raw_url": "https://github.com/nodejs/node/raw/69a422bba7810a6f34b2783bbd8ed5b7da86d008/test%2Fsequential%2Ftest-gc-http-client-timeout.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-gc-http-client-timeout.js?ref=69a422bba7810a6f34b2783bbd8ed5b7da86d008",
            "patch": "@@ -3,7 +3,7 @@\n // just like test-gc-http-client.js,\n // but with a timeout set\n \n-require('../common');\n+const common = require('../common');\n const onGC = require('../common/ongc');\n \n function serverHandler(req, res) {\n@@ -15,46 +15,44 @@ function serverHandler(req, res) {\n }\n \n const http = require('http');\n-const todo = 550;\n+const todo = 300;\n let done = 0;\n let count = 0;\n let countGC = 0;\n \n console.log(`We should do ${todo} requests`);\n \n const server = http.createServer(serverHandler);\n-server.listen(0, getall);\n+server.listen(0, common.mustCall(getall));\n \n function getall() {\n   if (count >= todo)\n     return;\n \n-  (function() {\n-    function cb(res) {\n-      res.resume();\n-      done += 1;\n-    }\n+  const req = http.get({\n+    hostname: 'localhost',\n+    pathname: '/',\n+    port: server.address().port\n+  }, cb);\n \n-    const req = http.get({\n-      hostname: 'localhost',\n-      pathname: '/',\n-      port: server.address().port\n-    }, cb);\n+  req.setTimeout(10, function() {\n+    console.log('timeout (expected)');\n+  });\n \n-    req.setTimeout(10, function() {\n-      console.log('timeout (expected)');\n-    });\n-\n-    count++;\n-    onGC(req, { ongc });\n-  })();\n+  count++;\n+  onGC(req, { ongc });\n \n   setImmediate(getall);\n }\n \n for (let i = 0; i < 10; i++)\n   getall();\n \n+function cb(res) {\n+  res.resume();\n+  done += 1;\n+}\n+\n function ongc() {\n   countGC++;\n }"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 18,
        "deletions": 20
    }
}