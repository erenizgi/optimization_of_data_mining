{
    "author": "BridgeAR",
    "message": "Revert \"repl: refactor tests to not rely on timing\"\n\nThis reverts commit de848ac1e0483327a2ce8716c3f8567eaeacb660.\n\nThe commit broke multiline repl.\n\nPR-URL: https://github.com/nodejs/node/pull/18715\nRefs: https://github.com/nodejs/node/pull/17828\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "1fc373bdf6758dcf045db21e4a075e4099ca7c19",
    "files": [
        {
            "sha": "adbb80b0af7e60a1c206b23c5875814d759e4861",
            "filename": "lib/internal/repl.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/lib%2Finternal%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/lib%2Finternal%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Frepl.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -8,7 +8,7 @@ const os = require('os');\n const util = require('util');\n const debug = util.debuglog('repl');\n module.exports = Object.create(REPL);\n-module.exports.createInternalRepl = createInternalRepl;\n+module.exports.createInternalRepl = createRepl;\n \n // XXX(chrisdickinson): The 15ms debounce value is somewhat arbitrary.\n // The debounce is to guard against code pasted into the REPL.\n@@ -19,7 +19,7 @@ function _writeToOutput(repl, message) {\n   repl._refreshLine();\n }\n \n-function createInternalRepl(env, opts, cb) {\n+function createRepl(env, opts, cb) {\n   if (typeof opts === 'function') {\n     cb = opts;\n     opts = null;"
        },
        {
            "sha": "84682b1b63e6cce45684465b9887f1cdd0e50ed6",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 39,
            "deletions": 40,
            "changes": 79,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -109,11 +109,6 @@ writer.options = Object.assign({},\n \n exports._builtinLibs = internalModule.builtinLibs;\n \n-const sep = '\\u0000\\u0000\\u0000';\n-const regExMatcher = new RegExp(`^${sep}(.*)${sep}(.*)${sep}(.*)${sep}(.*)` +\n-                                `${sep}(.*)${sep}(.*)${sep}(.*)${sep}(.*)` +\n-                                `${sep}(.*)$`);\n-\n function REPLServer(prompt,\n                     stream,\n                     eval_,\n@@ -154,7 +149,6 @@ function REPLServer(prompt,\n   }\n \n   var self = this;\n-  replMap.set(self, self);\n \n   self._domain = dom || domain.create();\n   self.useGlobal = !!useGlobal;\n@@ -171,6 +165,41 @@ function REPLServer(prompt,\n   self.rli = this;\n \n   const savedRegExMatches = ['', '', '', '', '', '', '', '', '', ''];\n+  const sep = '\\u0000\\u0000\\u0000';\n+  const regExMatcher = new RegExp(`^${sep}(.*)${sep}(.*)${sep}(.*)${sep}(.*)` +\n+                                  `${sep}(.*)${sep}(.*)${sep}(.*)${sep}(.*)` +\n+                                  `${sep}(.*)$`);\n+\n+  eval_ = eval_ || defaultEval;\n+\n+  // Pause taking in new input, and store the keys in a buffer.\n+  const pausedBuffer = [];\n+  let paused = false;\n+  function pause() {\n+    paused = true;\n+  }\n+  function unpause() {\n+    if (!paused) return;\n+    paused = false;\n+    let entry;\n+    while (entry = pausedBuffer.shift()) {\n+      const [type, payload] = entry;\n+      switch (type) {\n+        case 'key': {\n+          const [d, key] = payload;\n+          self._ttyWrite(d, key);\n+          break;\n+        }\n+        case 'close':\n+          self.emit('exit');\n+          break;\n+      }\n+      if (paused) {\n+        break;\n+      }\n+    }\n+  }\n+\n   function defaultEval(code, context, file, cb) {\n     var err, result, script, wrappedErr;\n     var wrappedCmd = false;\n@@ -302,6 +331,7 @@ function REPLServer(prompt,\n \n       if (awaitPromise && !err) {\n         let sigintListener;\n+        pause();\n         let promise = result;\n         if (self.breakEvalOnSigint) {\n           const interrupt = new Promise((resolve, reject) => {\n@@ -320,6 +350,7 @@ function REPLServer(prompt,\n           prioritizedSigintQueue.delete(sigintListener);\n \n           finishExecution(undefined, result);\n+          unpause();\n         }, (err) => {\n           // Remove prioritized SIGINT listener if it was not called.\n           prioritizedSigintQueue.delete(sigintListener);\n@@ -329,6 +360,7 @@ function REPLServer(prompt,\n             Object.defineProperty(err, 'stack', { value: '' });\n           }\n \n+          unpause();\n           if (err && process.domain) {\n             debug('not recoverable, send to domain');\n             process.domain.emit('error', err);\n@@ -345,36 +377,6 @@ function REPLServer(prompt,\n     }\n   }\n \n-  eval_ = eval_ || defaultEval;\n-\n-  // Pause taking in new input, and store the keys in a buffer.\n-  const pausedBuffer = [];\n-  let paused = false;\n-  function pause() {\n-    paused = true;\n-  }\n-  function unpause() {\n-    if (!paused) return;\n-    paused = false;\n-    let entry;\n-    while (entry = pausedBuffer.shift()) {\n-      const [type, payload] = entry;\n-      switch (type) {\n-        case 'key': {\n-          const [d, key] = payload;\n-          self._ttyWrite(d, key);\n-          break;\n-        }\n-        case 'close':\n-          self.emit('exit');\n-          break;\n-      }\n-      if (paused) {\n-        break;\n-      }\n-    }\n-  }\n-\n   self.eval = self._domain.bind(eval_);\n \n   self._domain.on('error', function debugDomainError(e) {\n@@ -403,7 +405,6 @@ function REPLServer(prompt,\n     top.clearBufferedCommand();\n     top.lines.level = [];\n     top.displayPrompt();\n-    unpause();\n   });\n \n   if (!input && !output) {\n@@ -592,7 +593,6 @@ function REPLServer(prompt,\n     const evalCmd = self[kBufferedCommandSymbol] + cmd + '\\n';\n \n     debug('eval %j', evalCmd);\n-    pause();\n     self.eval(evalCmd, self.context, 'repl', finish);\n \n     function finish(e, ret) {\n@@ -605,7 +605,6 @@ function REPLServer(prompt,\n                                 '(Press Control-D to exit.)\\n');\n         self.clearBufferedCommand();\n         self.displayPrompt();\n-        unpause();\n         return;\n       }\n \n@@ -643,7 +642,6 @@ function REPLServer(prompt,\n \n       // Display prompt again\n       self.displayPrompt();\n-      unpause();\n     }\n   });\n \n@@ -726,6 +724,7 @@ exports.start = function(prompt,\n                             ignoreUndefined,\n                             replMode);\n   if (!exports.repl) exports.repl = repl;\n+  replMap.set(repl, repl);\n   return repl;\n };\n "
        },
        {
            "sha": "52234deb5e732ebc98768435d08ff18b3428f234",
            "filename": "test/parallel/test-repl-autolibs.js",
            "status": "modified",
            "additions": 1,
            "deletions": 26,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-autolibs.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-autolibs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-autolibs.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -29,22 +29,7 @@ const repl = require('repl');\n common.globalCheck = false;\n \n const putIn = new common.ArrayStream();\n-\n-\n-const replserver = repl.start('', putIn, null, true);\n-const callbacks = [];\n-const $eval = replserver.eval;\n-replserver.eval = function(code, context, file, cb) {\n-  const expected = callbacks.shift();\n-  return $eval.call(this, code, context, file, (...args) => {\n-    try {\n-      expected(cb, ...args);\n-    } catch (e) {\n-      console.error(e);\n-      process.exit(1);\n-    }\n-  });\n-};\n+repl.start('', putIn, null, true);\n \n test1();\n \n@@ -63,11 +48,6 @@ function test1() {\n     }\n   };\n   assert(!gotWrite);\n-  callbacks.push(common.mustCall((cb, err, result) => {\n-    assert.ifError(err);\n-    assert.strictEqual(result, require('fs'));\n-    cb(err, result);\n-  }));\n   putIn.run(['fs']);\n   assert(gotWrite);\n }\n@@ -86,11 +66,6 @@ function test2() {\n   const val = {};\n   global.url = val;\n   assert(!gotWrite);\n-  callbacks.push(common.mustCall((cb, err, result) => {\n-    assert.ifError(err);\n-    assert.strictEqual(result, val);\n-    cb(err, result);\n-  }));\n   putIn.run(['url']);\n   assert(gotWrite);\n }"
        },
        {
            "sha": "9d18067bc2aca431c6c43e9fa424a5f2d73a0d66",
            "filename": "test/parallel/test-repl-context.js",
            "status": "modified",
            "additions": 25,
            "deletions": 42,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-context.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-context.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-context.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -27,57 +27,40 @@ function testContext(repl) {\n   repl.close();\n }\n \n-const replserver = repl.start({ input: stream, output: stream });\n-const callbacks = [];\n-const $eval = replserver.eval;\n-replserver.eval = function(code, context, file, cb) {\n-  const expected = callbacks.shift();\n-  return $eval.call(this, code, context, file, (...args) => {\n-    try {\n-      expected(cb, ...args);\n-    } catch (e) {\n-      console.error(e);\n-      process.exit(1);\n-    }\n-  });\n-};\n-testContextSideEffects(replserver);\n+testContextSideEffects(repl.start({ input: stream, output: stream }));\n \n function testContextSideEffects(server) {\n   assert.ok(!server.underscoreAssigned);\n   assert.strictEqual(server.lines.length, 0);\n \n   // an assignment to '_' in the repl server\n-  callbacks.push(common.mustCall((cb, ...args) => {\n-    assert.ok(server.underscoreAssigned);\n-    assert.strictEqual(server.last, 500);\n-    cb(...args);\n-    assert.strictEqual(server.lines.length, 1);\n-    assert.strictEqual(server.lines[0], '_ = 500;');\n+  server.write('_ = 500;\\n');\n+  assert.ok(server.underscoreAssigned);\n+  assert.strictEqual(server.lines.length, 1);\n+  assert.strictEqual(server.lines[0], '_ = 500;');\n+  assert.strictEqual(server.last, 500);\n \n-    // use the server to create a new context\n-    const context = server.createContext();\n+  // use the server to create a new context\n+  const context = server.createContext();\n \n-    // ensure that creating a new context does not\n-    // have side effects on the server\n-    assert.ok(server.underscoreAssigned);\n-    assert.strictEqual(server.lines.length, 1);\n-    assert.strictEqual(server.lines[0], '_ = 500;');\n-    assert.strictEqual(server.last, 500);\n+  // ensure that creating a new context does not\n+  // have side effects on the server\n+  assert.ok(server.underscoreAssigned);\n+  assert.strictEqual(server.lines.length, 1);\n+  assert.strictEqual(server.lines[0], '_ = 500;');\n+  assert.strictEqual(server.last, 500);\n \n-    // reset the server context\n-    server.resetContext();\n-    assert.ok(!server.underscoreAssigned);\n-    assert.strictEqual(server.lines.length, 0);\n+  // reset the server context\n+  server.resetContext();\n+  assert.ok(!server.underscoreAssigned);\n+  assert.strictEqual(server.lines.length, 0);\n \n-    // ensure that assigning to '_' in the new context\n-    // does not change the value in our server.\n-    assert.ok(!server.underscoreAssigned);\n-    vm.runInContext('_ = 1000;\\n', context);\n+  // ensure that assigning to '_' in the new context\n+  // does not change the value in our server.\n+  assert.ok(!server.underscoreAssigned);\n+  vm.runInContext('_ = 1000;\\n', context);\n \n-    assert.ok(!server.underscoreAssigned);\n-    assert.strictEqual(server.lines.length, 0);\n-    server.close();\n-  }));\n-  server.write('_ = 500;\\n');\n+  assert.ok(!server.underscoreAssigned);\n+  assert.strictEqual(server.lines.length, 0);\n+  server.close();\n }"
        },
        {
            "sha": "67f667eeb3d8dbbfdefcd0f960bbe97bb4d6e6a3",
            "filename": "test/parallel/test-repl-end-emits-exit.js",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-end-emits-exit.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-end-emits-exit.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-end-emits-exit.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -21,7 +21,10 @@\n \n 'use strict';\n const common = require('../common');\n+const assert = require('assert');\n const repl = require('repl');\n+let terminalExit = 0;\n+let regularExit = 0;\n \n // Create a dummy stream that does nothing\n const stream = new common.ArrayStream();\n@@ -38,10 +41,11 @@ function testTerminalMode() {\n     stream.emit('data', '\\u0004');\n   });\n \n-  r1.on('exit', common.mustCall(function() {\n+  r1.on('exit', function() {\n     // should be fired from the simulated ^D keypress\n+    terminalExit++;\n     testRegularMode();\n-  }));\n+  });\n }\n \n function testRegularMode() {\n@@ -55,11 +59,17 @@ function testRegularMode() {\n     stream.emit('end');\n   });\n \n-  r2.on('exit', common.mustCall(function() {\n+  r2.on('exit', function() {\n     // should be fired from the simulated 'end' event\n-  }));\n+    regularExit++;\n+  });\n }\n \n+process.on('exit', function() {\n+  assert.strictEqual(terminalExit, 1);\n+  assert.strictEqual(regularExit, 1);\n+});\n+\n \n // start\n testTerminalMode();"
        },
        {
            "sha": "00b577cba73f76c9dc29cde8c22ddbb76b27d459",
            "filename": "test/parallel/test-repl-eval-scope.js",
            "status": "modified",
            "additions": 16,
            "deletions": 22,
            "changes": 38,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-eval-scope.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-eval-scope.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-eval-scope.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -3,27 +3,21 @@ const common = require('../common');\n const assert = require('assert');\n const repl = require('repl');\n \n-const exitTests = [];\n-process.on('exit', () => {\n-  for (const test of exitTests) test();\n-});\n-const CONTEXT = { animal: 'Sterrance' };\n-const stream = new common.ArrayStream();\n-const options = {\n-  eval: common.mustCall((cmd, context) => {\n-    // need to escape the domain\n-    exitTests.push(common.mustCall(() => {\n-      assert.strictEqual(cmd, '.scope');\n-      assert.ok(context === CONTEXT);\n-    }));\n-  }),\n-  input: stream,\n-  output: stream,\n-  terminal: true\n-};\n+{\n+  const stream = new common.ArrayStream();\n+  const options = {\n+    eval: common.mustCall((cmd, context) => {\n+      assert.strictEqual(cmd, '.scope\\n');\n+      assert.deepStrictEqual(context, { animal: 'Sterrance' });\n+    }),\n+    input: stream,\n+    output: stream,\n+    terminal: true\n+  };\n \n-const r = repl.start(options);\n-r.context = CONTEXT;\n+  const r = repl.start(options);\n+  r.context = { animal: 'Sterrance' };\n \n-stream.emit('data', '\\t');\n-stream.emit('.exit\\n');\n+  stream.emit('data', '\\t');\n+  stream.emit('.exit\\n');\n+}"
        },
        {
            "sha": "d775423fb74a520874afe912a519acc7a4182f48",
            "filename": "test/parallel/test-repl-eval.js",
            "status": "modified",
            "additions": 25,
            "deletions": 25,
            "changes": 50,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-eval.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-eval.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-eval.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -3,31 +3,31 @@ const common = require('../common');\n const assert = require('assert');\n const repl = require('repl');\n \n-const exitTests = [];\n-process.on('exit', () => {\n-  for (const test of exitTests) test();\n-});\n-const options = {\n-  eval: common.mustCall((cmd, context) => {\n-    // Assertions here will not cause the test to exit with an error code\n-    // so set a boolean that is checked later instead.\n-    exitTests.push(common.mustCall(() => {\n-      assert.strictEqual(cmd, 'function f() {}\\n');\n-      assert.strictEqual(context.foo, 'bar');\n-    }));\n-  })\n-};\n+{\n+  let evalCalledWithExpectedArgs = false;\n \n-const r = repl.start(options);\n-r.context = { foo: 'bar' };\n+  const options = {\n+    eval: common.mustCall((cmd, context) => {\n+      // Assertions here will not cause the test to exit with an error code\n+      // so set a boolean that is checked later instead.\n+      evalCalledWithExpectedArgs = (cmd === 'function f() {}\\n' &&\n+                                    context.foo === 'bar');\n+    })\n+  };\n \n-try {\n-  // Default preprocessor transforms\n-  //  function f() {}  to\n-  //  var f = function f() {}\n-  // Test to ensure that original input is preserved.\n-  // Reference: https://github.com/nodejs/node/issues/9743\n-  r.write('function f() {}\\n');\n-} finally {\n-  r.write('.exit\\n');\n+  const r = repl.start(options);\n+  r.context = { foo: 'bar' };\n+\n+  try {\n+    // Default preprocessor transforms\n+    //  function f() {}  to\n+    //  var f = function f() {}\n+    // Test to ensure that original input is preserved.\n+    // Reference: https://github.com/nodejs/node/issues/9743\n+    r.write('function f() {}\\n');\n+  } finally {\n+    r.write('.exit\\n');\n+  }\n+\n+  assert(evalCalledWithExpectedArgs);\n }"
        },
        {
            "sha": "1e3063e3db53ff7d936ba6404ec28d78ecb27cca",
            "filename": "test/parallel/test-repl-function-definition-edge-case.js",
            "status": "modified",
            "additions": 28,
            "deletions": 43,
            "changes": 71,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-function-definition-edge-case.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-function-definition-edge-case.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-function-definition-edge-case.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -7,47 +7,32 @@ const stream = require('stream');\n \n common.globalCheck = false;\n \n-const input = new stream();\n-input.write = input.pause = input.resume = () => {};\n-input.readable = true;\n-\n-const output = new stream();\n-output.writable = true;\n-output.accumulator = [];\n-\n-output.write = (data) => output.accumulator.push(data);\n-\n-const replserver = repl.start({\n-  input,\n-  output,\n-  useColors: false,\n-  terminal: false,\n-  prompt: ''\n-});\n-const callbacks = [];\n-const $eval = replserver.eval;\n-replserver.eval = function(code, context, file, cb) {\n-  const expected = callbacks.shift();\n-  return $eval.call(this, code, context, file, (...args) => {\n-    try {\n-      expected(...args);\n-    } catch (e) {\n-      console.error(e);\n-      process.exit(1);\n-    }\n-    cb(...args);\n+const r = initRepl();\n+\n+r.input.emit('data', 'function a() { return 42; } (1)\\n');\n+r.input.emit('data', 'a\\n');\n+r.input.emit('data', '.exit');\n+\n+const expected = '1\\n[Function: a]\\n';\n+const got = r.output.accumulator.join('');\n+assert.strictEqual(got, expected);\n+\n+function initRepl() {\n+  const input = new stream();\n+  input.write = input.pause = input.resume = () => {};\n+  input.readable = true;\n+\n+  const output = new stream();\n+  output.writable = true;\n+  output.accumulator = [];\n+\n+  output.write = (data) => output.accumulator.push(data);\n+\n+  return repl.start({\n+    input,\n+    output,\n+    useColors: false,\n+    terminal: false,\n+    prompt: ''\n   });\n-};\n-\n-callbacks.push(common.mustCall((err, result) => {\n-  assert.ifError(err);\n-  assert.strictEqual(result, 1);\n-}));\n-replserver.input.emit('data', 'function a() { return 42; } (1)\\n');\n-callbacks.push(common.mustCall((err, result) => {\n-  assert.ifError(err);\n-  assert.strictEqual(typeof result, 'function');\n-  assert.strictEqual(result.toString(), 'function a() { return 42; }');\n-}));\n-replserver.input.emit('data', 'a\\n');\n-replserver.input.emit('data', '.exit');\n+}"
        },
        {
            "sha": "8ab878ae768ddd0f9751c4375ecd53edbb598119",
            "filename": "test/parallel/test-repl-load-multiline.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-load-multiline.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-load-multiline.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-load-multiline.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -36,7 +36,5 @@ const r = repl.start({\n });\n \n r.write(`${command}\\n`);\n-r.on('exit', common.mustCall(() => {\n-  assert.strictEqual(accum.replace(terminalCodeRegex, ''), expected);\n-}));\n+assert.strictEqual(accum.replace(terminalCodeRegex, ''), expected);\n r.close();"
        },
        {
            "sha": "60b430d8c7ee31b784a8e0122be6d930c2dc99a0",
            "filename": "test/parallel/test-repl-mode.js",
            "status": "modified",
            "additions": 11,
            "deletions": 42,
            "changes": 53,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-mode.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-mode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-mode.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -19,49 +19,35 @@ tests.forEach(function(test) {\n function testSloppyMode() {\n   const cli = initRepl(repl.REPL_MODE_SLOPPY);\n \n-  cli.callbacks.push(common.mustCall((err, result) => {\n-    assert.ifError(err);\n-    assert.strictEqual(result, 3);\n-  }));\n   cli.input.emit('data', 'x = 3\\n');\n+  assert.strictEqual(cli.output.accumulator.join(''), '> 3\\n> ');\n+  cli.output.accumulator.length = 0;\n \n-  cli.callbacks.push(common.mustCall((err, result) => {\n-    assert.ifError(err);\n-    assert.strictEqual(result, undefined);\n-  }));\n   cli.input.emit('data', 'let y = 3\\n');\n+  assert.strictEqual(cli.output.accumulator.join(''), 'undefined\\n> ');\n }\n \n function testStrictMode() {\n   const cli = initRepl(repl.REPL_MODE_STRICT);\n \n-  cli._domain.once('error', common.mustCall((err) => {\n-    assert.ok(err);\n-    assert.ok(/ReferenceError: x is not defined/.test(err.message));\n-  }));\n   cli.input.emit('data', 'x = 3\\n');\n+  assert.ok(/ReferenceError: x is not defined/.test(\n+    cli.output.accumulator.join('')));\n+  cli.output.accumulator.length = 0;\n \n-  cli.callbacks.push(common.mustCall((err, result) => {\n-    assert.ifError(err);\n-    assert.strictEqual(result, undefined);\n-  }));\n   cli.input.emit('data', 'let y = 3\\n');\n+  assert.strictEqual(cli.output.accumulator.join(''), 'undefined\\n> ');\n }\n \n function testAutoMode() {\n   const cli = initRepl(repl.REPL_MODE_MAGIC);\n \n-  cli.callbacks.push(common.mustCall((err, result) => {\n-    assert.ifError(err);\n-    assert.strictEqual(result, 3);\n-  }));\n   cli.input.emit('data', 'x = 3\\n');\n+  assert.strictEqual(cli.output.accumulator.join(''), '> 3\\n> ');\n+  cli.output.accumulator.length = 0;\n \n-  cli.callbacks.push(common.mustCall((err, result) => {\n-    assert.ifError(err);\n-    assert.strictEqual(result, undefined);\n-  }));\n   cli.input.emit('data', 'let y = 3\\n');\n+  assert.strictEqual(cli.output.accumulator.join(''), 'undefined\\n> ');\n }\n \n function initRepl(mode) {\n@@ -76,28 +62,11 @@ function initRepl(mode) {\n   output.accumulator = [];\n   output.writable = true;\n \n-  const replserver = repl.start({\n+  return repl.start({\n     input: input,\n     output: output,\n     useColors: false,\n     terminal: false,\n     replMode: mode\n   });\n-  const callbacks = [];\n-  const $eval = replserver.eval;\n-  replserver.eval = function(code, context, file, cb) {\n-    const expected = callbacks.shift();\n-    return $eval.call(this, code, context, file, (...args) => {\n-      console.log('EVAL RET', args);\n-      try {\n-        expected(...args);\n-      } catch (e) {\n-        console.error(e);\n-        process.exit(1);\n-      }\n-      cb(...args);\n-    });\n-  };\n-  replserver.callbacks = callbacks;\n-  return replserver;\n }"
        },
        {
            "sha": "1fe5d30396d53469026d1886ba2db9f4b0ee2ec2",
            "filename": "test/parallel/test-repl-null-thrown.js",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-null-thrown.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-null-thrown.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-null-thrown.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -1,5 +1,5 @@\n 'use strict';\n-const common = require('../common');\n+require('../common');\n const repl = require('repl');\n const assert = require('assert');\n const Stream = require('stream');\n@@ -18,6 +18,7 @@ const replserver = repl.start({\n replserver.emit('line', 'process.nextTick(() => { throw null; })');\n replserver.emit('line', '.exit');\n \n-replserver.on('exit', common.mustCall(() => {\n+setTimeout(() => {\n+  console.log(text);\n   assert(text.includes('Thrown: null'));\n-}));\n+}, 0);"
        },
        {
            "sha": "66d09b28f28b84dbed85c1a58655daac39b2c3c8",
            "filename": "test/parallel/test-repl-null.js",
            "status": "modified",
            "additions": 1,
            "deletions": 20,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-null.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-null.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-null.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -1,28 +1,9 @@\n 'use strict';\n-const common = require('../common');\n+require('../common');\n const repl = require('repl');\n const assert = require('assert');\n \n-const callbacks = [\n-  common.mustCall((err, value) => {\n-    assert.ifError(err);\n-    assert.strictEqual(value, undefined);\n-  })\n-];\n const replserver = new repl.REPLServer();\n-const $eval = replserver.eval;\n-replserver.eval = function(code, context, file, cb) {\n-  const expected = callbacks.shift();\n-  return $eval.call(this, code, context, file, (...args) => {\n-    try {\n-      expected(...args);\n-    } catch (e) {\n-      console.error(e);\n-      process.exit(1);\n-    }\n-    cb(...args);\n-  });\n-};\n \n replserver._inTemplateLiteral = true;\n "
        },
        {
            "sha": "be102c1d677a9c8503f41cdfd00e8ccf12d60aed",
            "filename": "test/parallel/test-repl-pretty-custom-stack.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-pretty-custom-stack.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-pretty-custom-stack.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-pretty-custom-stack.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -22,9 +22,7 @@ function run({ command, expected }) {\n   });\n \n   r.write(`${command}\\n`);\n-  r.on('exit', common.mustCall(() => {\n-    assert.strictEqual(accum, expected);\n-  }));\n+  assert.strictEqual(accum, expected);\n   r.close();\n }\n "
        },
        {
            "sha": "0fc6b3ada04c796e4be053d973227900828ba8ff",
            "filename": "test/parallel/test-repl-pretty-stack.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-pretty-stack.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-pretty-stack.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-pretty-stack.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -22,9 +22,7 @@ function run({ command, expected }) {\n   });\n \n   r.write(`${command}\\n`);\n-  r.on('exit', common.mustCall(() => {\n-    assert.strictEqual(accum, expected);\n-  }));\n+  assert.strictEqual(accum, expected);\n   r.close();\n }\n "
        },
        {
            "sha": "6788d84595066cdba81a92bf411c1d811cba4522",
            "filename": "test/parallel/test-repl-recoverable.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-recoverable.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-recoverable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-recoverable.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -4,11 +4,14 @@ const common = require('../common');\n const assert = require('assert');\n const repl = require('repl');\n \n+let evalCount = 0;\n let recovered = false;\n let rendered = false;\n \n function customEval(code, context, file, cb) {\n-  return cb(!recovered ? new repl.Recoverable() : null, true);\n+  evalCount++;\n+\n+  return cb(evalCount === 1 ? new repl.Recoverable() : null, true);\n }\n \n const putIn = new common.ArrayStream();\n@@ -23,7 +26,7 @@ putIn.write = function(msg) {\n   }\n };\n \n-repl.start('', putIn, common.mustCall(customEval, 2));\n+repl.start('', putIn, customEval);\n \n // https://github.com/nodejs/node/issues/2939\n // Expose recoverable errors to the consumer.\n@@ -33,4 +36,5 @@ putIn.emit('data', '2\\n');\n process.on('exit', function() {\n   assert(recovered, 'REPL never recovered');\n   assert(rendered, 'REPL never rendered the result');\n+  assert.strictEqual(evalCount, 2);\n });"
        },
        {
            "sha": "fd2fd202b5bcb6a61e7e77d64a4dbb2b09a6e02e",
            "filename": "test/parallel/test-repl-throw-null-or-undefined.js",
            "status": "modified",
            "additions": 9,
            "deletions": 11,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-throw-null-or-undefined.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-throw-null-or-undefined.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-throw-null-or-undefined.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -1,20 +1,18 @@\n 'use strict';\n-const common = require('../common');\n+require('../common');\n \n // This test ensures that the repl does not\n // crash or emit error when throwing `null|undefined`\n // ie `throw null` or `throw undefined`\n \n+const assert = require('assert');\n const repl = require('repl');\n \n-const replserver = repl.start();\n-const $eval = replserver.eval;\n-replserver.eval = function(code, context, file, cb) {\n-  return $eval.call(this, code, context, file,\n-                    common.mustNotCall(\n-                      'repl crashes/throw error on `throw null|undefined`'));\n-};\n-replserver.write('throw null\\n');\n-replserver.write('throw undefined\\n');\n+const r = repl.start();\n \n-replserver.write('.exit\\n');\n+assert.doesNotThrow(() => {\n+  r.write('throw null\\n');\n+  r.write('throw undefined\\n');\n+}, TypeError, 'repl crashes/throw error on `throw null|undefined`');\n+\n+r.write('.exit\\n');"
        },
        {
            "sha": "91f32223e180b9887af56952a74a0c6dcc3150f0",
            "filename": "test/parallel/test-repl-underscore.js",
            "status": "modified",
            "additions": 57,
            "deletions": 67,
            "changes": 124,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-underscore.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-underscore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-underscore.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -28,22 +28,20 @@ function testSloppyMode() {\n           _;           // remains 30 from user input\n           `);\n \n-  r.on('exit', () => {\n-    assertOutput(r.output, [\n-      'undefined',\n-      'undefined',\n-      'undefined',\n-      '10',\n-      '10',\n-      'Expression assignment to _ now disabled.',\n-      '20',\n-      '20',\n-      '30',\n-      '30',\n-      '40',\n-      '30'\n-    ]);\n-  });\n+  assertOutput(r.output, [\n+    'undefined',\n+    'undefined',\n+    'undefined',\n+    '10',\n+    '10',\n+    'Expression assignment to _ now disabled.',\n+    '20',\n+    '20',\n+    '30',\n+    '30',\n+    '40',\n+    '30'\n+  ]);\n }\n \n function testStrictMode() {\n@@ -63,22 +61,20 @@ function testStrictMode() {\n           _;           // remains 30 from user input\n           `);\n \n-  r.on('exit', () => {\n-    assertOutput(r.output, [\n-      'undefined',\n-      'undefined',\n-      'undefined',\n-      'undefined',\n-      '20',\n-      '30',\n-      '30',\n-      'undefined',\n-      '30',\n-      'undefined',\n-      'undefined',\n-      '30'\n-    ]);\n-  });\n+  assertOutput(r.output, [\n+    'undefined',\n+    'undefined',\n+    'undefined',\n+    'undefined',\n+    '20',\n+    '30',\n+    '30',\n+    'undefined',\n+    '30',\n+    'undefined',\n+    'undefined',\n+    '30'\n+  ]);\n }\n \n function testMagicMode() {\n@@ -98,22 +94,20 @@ function testMagicMode() {\n           _;           // remains 30 from user input\n           `);\n \n-  r.on('exit', () => {\n-    assertOutput(r.output, [\n-      'undefined',\n-      '10',\n-      '10',\n-      'undefined',\n-      '20',\n-      '30',\n-      '30',\n-      'undefined',\n-      '30',\n-      'undefined',\n-      '50',\n-      '30'\n-    ]);\n-  });\n+  assertOutput(r.output, [\n+    'undefined',\n+    '10',\n+    '10',\n+    'undefined',\n+    '20',\n+    '30',\n+    '30',\n+    'undefined',\n+    '30',\n+    'undefined',\n+    '50',\n+    '30'\n+  ]);\n }\n \n function testResetContext() {\n@@ -127,17 +121,15 @@ function testResetContext() {\n           _;           // expect 20\n           `);\n \n-  r.on('exit', () => {\n-    assertOutput(r.output, [\n-      'Expression assignment to _ now disabled.',\n-      '10',\n-      '10',\n-      'Clearing context...',\n-      '10',\n-      '20',\n-      '20'\n-    ]);\n-  });\n+  assertOutput(r.output, [\n+    'Expression assignment to _ now disabled.',\n+    '10',\n+    '10',\n+    'Clearing context...',\n+    '10',\n+    '20',\n+    '20'\n+  ]);\n }\n \n function testResetContextGlobal() {\n@@ -149,14 +141,12 @@ function testResetContextGlobal() {\n           _;           // remains 10\n           `);\n \n-  r.on('exit', () => {\n-    assertOutput(r.output, [\n-      'Expression assignment to _ now disabled.',\n-      '10',\n-      '10',\n-      '10',\n-    ]);\n-  });\n+  assertOutput(r.output, [\n+    'Expression assignment to _ now disabled.',\n+    '10',\n+    '10',\n+    '10',\n+  ]);\n \n   // delete globals leaked by REPL when `useGlobal` is `true`\n   delete global.module;"
        },
        {
            "sha": "c76505272b268218cb4d93ae664db4b8467a9a7e",
            "filename": "test/parallel/test-repl-use-global.js",
            "status": "modified",
            "additions": 32,
            "deletions": 33,
            "changes": 65,
            "blob_url": "https://github.com/nodejs/node/blob/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-use-global.js",
            "raw_url": "https://github.com/nodejs/node/raw/1fc373bdf6758dcf045db21e4a075e4099ca7c19/test%2Fparallel%2Ftest-repl-use-global.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-use-global.js?ref=1fc373bdf6758dcf045db21e4a075e4099ca7c19",
            "patch": "@@ -7,6 +7,13 @@ const stream = require('stream');\n const repl = require('internal/repl');\n const assert = require('assert');\n \n+// Array of [useGlobal, expectedResult] pairs\n+const globalTestCases = [\n+  [false, 'undefined'],\n+  [true, '\\'tacos\\''],\n+  [undefined, 'undefined']\n+];\n+\n const globalTest = (useGlobal, cb, output) => (err, repl) => {\n   if (err)\n     return cb(err);\n@@ -19,12 +26,26 @@ const globalTest = (useGlobal, cb, output) => (err, repl) => {\n   global.lunch = 'tacos';\n   repl.write('global.lunch;\\n');\n   repl.close();\n-  repl.on('exit', common.mustCall(() => {\n-    delete global.lunch;\n-    cb(null, str.trim());\n-  }));\n+  delete global.lunch;\n+  cb(null, str.trim());\n };\n \n+// Test how the global object behaves in each state for useGlobal\n+for (const [option, expected] of globalTestCases) {\n+  runRepl(option, globalTest, common.mustCall((err, output) => {\n+    assert.ifError(err);\n+    assert.strictEqual(output, expected);\n+  }));\n+}\n+\n+// Test how shadowing the process object via `let`\n+// behaves in each useGlobal state. Note: we can't\n+// actually test the state when useGlobal is true,\n+// because the exception that's generated is caught\n+// (see below), but errors are printed, and the test\n+// suite is aware of it, causing a failure to be flagged.\n+//\n+const processTestCases = [false, undefined];\n const processTest = (useGlobal, cb, output) => (err, repl) => {\n   if (err)\n     return cb(err);\n@@ -36,37 +57,15 @@ const processTest = (useGlobal, cb, output) => (err, repl) => {\n   repl.write('let process;\\n');\n   repl.write('21 * 2;\\n');\n   repl.close();\n-  repl.on('exit', common.mustCall((err) => {\n-    assert.ifError(err);\n-    cb(null, str.trim());\n-  }));\n+  cb(null, str.trim());\n };\n \n-// Array of [useGlobal, expectedResult, fn] pairs\n-const testCases = [\n-  // Test how the global object behaves in each state for useGlobal\n-  [false, 'undefined', globalTest],\n-  [true, '\\'tacos\\'', globalTest],\n-  [undefined, 'undefined', globalTest],\n-  // Test how shadowing the process object via `let`\n-  // behaves in each useGlobal state. Note: we can't\n-  // actually test the state when useGlobal is true,\n-  // because the exception that's generated is caught\n-  // (see below), but errors are printed, and the test\n-  // suite is aware of it, causing a failure to be flagged.\n-  [false, 'undefined\\n42', processTest]\n-];\n-\n-const next = common.mustCall(() => {\n-  if (testCases.length) {\n-    const [option, expected, runner] = testCases.shift();\n-    runRepl(option, runner, common.mustCall((err, output) => {\n-      assert.strictEqual(output, expected);\n-      next();\n-    }));\n-  }\n-}, testCases.length + 1);\n-next();\n+for (const option of processTestCases) {\n+  runRepl(option, processTest, common.mustCall((err, output) => {\n+    assert.ifError(err);\n+    assert.strictEqual(output, 'undefined\\n42');\n+  }));\n+}\n \n function runRepl(useGlobal, testFunc, cb) {\n   const inputStream = new stream.PassThrough();"
        }
    ],
    "stats": {
        "total": 664,
        "additions": 273,
        "deletions": 391
    }
}