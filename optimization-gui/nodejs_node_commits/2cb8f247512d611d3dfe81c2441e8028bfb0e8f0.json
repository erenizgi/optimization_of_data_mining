{
    "author": "addaleax",
    "message": "http: switch default parser to llhttp\n\nRefs: https://github.com/nodejs/node/pull/24739\nFixes: https://github.com/nodejs/node/issues/24730\n\nPR-URL: https://github.com/nodejs/node/pull/24870\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Fedor Indutny <fedor.indutny@gmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "2cb8f247512d611d3dfe81c2441e8028bfb0e8f0",
    "files": [
        {
            "sha": "d13c622d54010e43a7912603b9ca0ae830bc22fc",
            "filename": "configure.py",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/configure.py",
            "raw_url": "https://github.com/nodejs/node/raw/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/configure.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/configure.py?ref=2cb8f247512d611d3dfe81c2441e8028bfb0e8f0",
            "patch": "@@ -187,7 +187,7 @@\n parser.add_option('--experimental-http-parser',\n     action='store_true',\n     dest='experimental_http_parser',\n-    help='use llhttp instead of http_parser by default')\n+    help='(no-op)')\n \n shared_optgroup.add_option('--shared-http-parser',\n     action='store_true',\n@@ -1118,9 +1118,6 @@ def configure_node(o):\n   else:\n     o['variables']['node_target_type'] = 'executable'\n \n-  o['variables']['node_experimental_http_parser'] = \\\n-      b(options.experimental_http_parser)\n-\n def configure_library(lib, output):\n   shared_lib = 'shared_' + lib\n   output['variables']['node_' + shared_lib] = b(getattr(options, shared_lib))"
        },
        {
            "sha": "22e087f31725e273bf30076a6d61dc5c79eb587c",
            "filename": "doc/api/cli.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/doc%2Fapi%2Fcli.md",
            "raw_url": "https://github.com/nodejs/node/raw/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/doc%2Fapi%2Fcli.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcli.md?ref=2cb8f247512d611d3dfe81c2441e8028bfb0e8f0",
            "patch": "@@ -129,7 +129,7 @@ Chooses an HTTP parser library. Available values are:\n - `llhttp` for https://llhttp.org/\n - `legacy` for https://github.com/nodejs/http-parser\n \n-The default is `legacy`, unless otherwise specified when building Node.js.\n+The default is `llhttp`, unless otherwise specified when building Node.js.\n \n This flag exists to aid in experimentation with the internal implementation of\n the Node.js http parser."
        },
        {
            "sha": "cf334c4acec13d31ab9661ade3c428a8cd910bbd",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=2cb8f247512d611d3dfe81c2441e8028bfb0e8f0",
            "patch": "@@ -12,7 +12,6 @@\n     'force_dynamic_crt%': 0,\n     'node_module_version%': '',\n     'node_shared_zlib%': 'false',\n-    'node_experimental_http_parser%': 'false',\n     'node_shared_http_parser%': 'false',\n     'node_shared_cares%': 'false',\n     'node_shared_libuv%': 'false',"
        },
        {
            "sha": "7bcd0a42b4f55a90349db3775e5ce6d565a0acbc",
            "filename": "node.gypi",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/node.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/node.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gypi?ref=2cb8f247512d611d3dfe81c2441e8028bfb0e8f0",
            "patch": "@@ -163,10 +163,6 @@\n       ],\n     }],\n \n-    [ 'node_experimental_http_parser==\"true\"', {\n-      'defines': [ 'NODE_EXPERIMENTAL_HTTP_DEFAULT' ],\n-    } ],\n-\n     [ 'node_shared_http_parser==\"false\"', {\n       'dependencies': [\n         'deps/http_parser/http_parser.gyp:http_parser',"
        },
        {
            "sha": "511f144c3f8e1d58fbb6293d4da4d5fb418dc0a0",
            "filename": "src/inspector_socket.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/src%2Finspector_socket.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/src%2Finspector_socket.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_socket.cc?ref=2cb8f247512d611d3dfe81c2441e8028bfb0e8f0",
            "patch": "@@ -1,8 +1,6 @@\n #include \"inspector_socket.h\"\n \n-#ifdef NODE_EXPERIMENTAL_HTTP_DEFAULT\n #define NODE_EXPERIMENTAL_HTTP\n-#endif\n #include \"http_parser_adaptor.h\"\n \n #include \"util-inl.h\"\n@@ -437,13 +435,8 @@ class HttpHandler : public ProtocolHandler {\n   explicit HttpHandler(InspectorSocket* inspector, TcpHolder::Pointer tcp)\n                        : ProtocolHandler(inspector, std::move(tcp)),\n                          parsing_value_(false) {\n-#ifdef NODE_EXPERIMENTAL_HTTP_DEFAULT\n     llhttp_init(&parser_, HTTP_REQUEST, &parser_settings);\n     llhttp_settings_init(&parser_settings);\n-#else  /* !NODE_EXPERIMENTAL_HTTP_DEFAULT */\n-    http_parser_init(&parser_, HTTP_REQUEST);\n-    http_parser_settings_init(&parser_settings);\n-#endif  /* NODE_EXPERIMENTAL_HTTP_DEFAULT */\n     parser_settings.on_header_field = OnHeaderField;\n     parser_settings.on_header_value = OnHeaderValue;\n     parser_settings.on_message_complete = OnMessageComplete;\n@@ -488,17 +481,12 @@ class HttpHandler : public ProtocolHandler {\n \n   void OnData(std::vector<char>* data) override {\n     parser_errno_t err;\n-#ifdef NODE_EXPERIMENTAL_HTTP_DEFAULT\n     err = llhttp_execute(&parser_, data->data(), data->size());\n \n     if (err == HPE_PAUSED_UPGRADE) {\n       err = HPE_OK;\n       llhttp_resume_after_upgrade(&parser_);\n     }\n-#else  /* !NODE_EXPERIMENTAL_HTTP_DEFAULT */\n-    http_parser_execute(&parser_, &parser_settings, data->data(), data->size());\n-    err = HTTP_PARSER_ERRNO(&parser_);\n-#endif  /* NODE_EXPERIMENTAL_HTTP_DEFAULT */\n     data->clear();\n     if (err != HPE_OK) {\n       CancelHandshake();"
        },
        {
            "sha": "ef80971461455b1a8f686e4fccb61e55fe697498",
            "filename": "src/node_options.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/src%2Fnode_options.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/src%2Fnode_options.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.cc?ref=2cb8f247512d611d3dfe81c2441e8028bfb0e8f0",
            "patch": "@@ -111,11 +111,7 @@ EnvironmentOptionsParser::EnvironmentOptionsParser() {\n   AddOption(\"--expose-internals\", \"\", &EnvironmentOptions::expose_internals);\n   AddOption(\"--http-parser\",\n             \"Select which HTTP parser to use; either 'legacy' or 'llhttp' \"\n-#ifdef NODE_EXPERIMENTAL_HTTP_DEFAULT\n             \"(default: llhttp).\",\n-#else\n-            \"(default: legacy).\",\n-#endif\n             &EnvironmentOptions::http_parser,\n             kAllowedInEnvironment);\n   AddOption(\"--loader\","
        },
        {
            "sha": "816243345dcdaebe5bdcf4f46da95823deb9baef",
            "filename": "src/node_options.h",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/src%2Fnode_options.h",
            "raw_url": "https://github.com/nodejs/node/raw/2cb8f247512d611d3dfe81c2441e8028bfb0e8f0/src%2Fnode_options.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.h?ref=2cb8f247512d611d3dfe81c2441e8028bfb0e8f0",
            "patch": "@@ -97,12 +97,7 @@ class EnvironmentOptions : public Options {\n   bool experimental_vm_modules = false;\n   bool experimental_worker = false;\n   bool expose_internals = false;\n-  std::string http_parser =\n-#ifdef NODE_EXPERIMENTAL_HTTP_DEFAULT\n-    \"llhttp\";\n-#else\n-    \"legacy\";\n-#endif\n+  std::string http_parser = \"llhttp\";\n   bool no_deprecation = false;\n   bool no_force_async_hooks_checks = false;\n   bool no_warnings = false;"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 3,
        "deletions": 32
    }
}