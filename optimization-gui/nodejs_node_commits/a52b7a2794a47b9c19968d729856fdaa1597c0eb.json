{
    "author": "unknown",
    "message": "stream: cleanup() when unpiping all streams.\n\nThis PR makes sure the object emitted as the 'unpipe'\nevent in the destination stream is not shared between\ndestination, as it would be muted.\n\nRefs: https://github.com/nodejs/node/pull/12746\nPR-URL: https://github.com/nodejs/node/pull/18266\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "a52b7a2794a47b9c19968d729856fdaa1597c0eb",
    "files": [
        {
            "sha": "dc2c587aed64df49012fe08a12c7403907b3e3fa",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/a52b7a2794a47b9c19968d729856fdaa1597c0eb/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/a52b7a2794a47b9c19968d729856fdaa1597c0eb/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=a52b7a2794a47b9c19968d729856fdaa1597c0eb",
            "patch": "@@ -751,7 +751,7 @@ Readable.prototype.unpipe = function(dest) {\n     state.flowing = false;\n \n     for (var i = 0; i < len; i++)\n-      dests[i].emit('unpipe', this, unpipeInfo);\n+      dests[i].emit('unpipe', this, { hasUnpiped: false });\n     return this;\n   }\n "
        },
        {
            "sha": "49e02bea9cb695461f9e4c9ba481be5d77d09e05",
            "filename": "test/parallel/test-stream-pipe-unpipe-streams.js",
            "status": "modified",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/nodejs/node/blob/a52b7a2794a47b9c19968d729856fdaa1597c0eb/test%2Fparallel%2Ftest-stream-pipe-unpipe-streams.js",
            "raw_url": "https://github.com/nodejs/node/raw/a52b7a2794a47b9c19968d729856fdaa1597c0eb/test%2Fparallel%2Ftest-stream-pipe-unpipe-streams.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-pipe-unpipe-streams.js?ref=a52b7a2794a47b9c19968d729856fdaa1597c0eb",
            "patch": "@@ -31,3 +31,57 @@ source.unpipe(dest2);\n source.unpipe(dest1);\n \n assert.strictEqual(source._readableState.pipes, null);\n+\n+{\n+  // test `cleanup()` if we unpipe all streams.\n+  const source = Readable({ read: () => {} });\n+  const dest1 = Writable({ write: () => {} });\n+  const dest2 = Writable({ write: () => {} });\n+\n+  let destCount = 0;\n+  const srcCheckEventNames = ['end', 'data'];\n+  const destCheckEventNames = ['close', 'finish', 'drain', 'error', 'unpipe'];\n+\n+  const checkSrcCleanup = common.mustCall(() => {\n+    assert.strictEqual(source._readableState.pipes, null);\n+    assert.strictEqual(source._readableState.pipesCount, 0);\n+    assert.strictEqual(source._readableState.flowing, false);\n+\n+    srcCheckEventNames.forEach((eventName) => {\n+      assert.strictEqual(\n+        source.listenerCount(eventName), 0,\n+        `source's '${eventName}' event listeners not removed`\n+      );\n+    });\n+  });\n+\n+  function checkDestCleanup(dest) {\n+    const currentDestId = ++destCount;\n+    source.pipe(dest);\n+\n+    const unpipeChecker = common.mustCall(() => {\n+      assert.deepStrictEqual(\n+        dest.listeners('unpipe'), [unpipeChecker],\n+        `destination{${currentDestId}} should have a 'unpipe' event ` +\n+        'listener which is `unpipeChecker`'\n+      );\n+      dest.removeListener('unpipe', unpipeChecker);\n+      destCheckEventNames.forEach((eventName) => {\n+        assert.strictEqual(\n+          dest.listenerCount(eventName), 0,\n+          `destination{${currentDestId}}'s '${eventName}' event ` +\n+          'listeners not removed'\n+        );\n+      });\n+\n+      if (--destCount === 0)\n+        checkSrcCleanup();\n+    });\n+\n+    dest.on('unpipe', unpipeChecker);\n+  }\n+\n+  checkDestCleanup(dest1);\n+  checkDestCleanup(dest2);\n+  source.unpipe();\n+}"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 55,
        "deletions": 1
    }
}