{
    "author": "legendecas",
    "message": "test: checks on napi factory wrapâ€™s finalization\n\nFixes: https://github.com/nodejs/node/issues/22396\nPR-URL: https://github.com/nodejs/node/pull/22612\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Gabriel Schulhof <gabriel.schulhof@intel.com>",
    "sha": "1cee08536794b6d7bc8d3b9ace2b494c74985f7d",
    "files": [
        {
            "sha": "e937516c894a909dbe0106bf44ea0b5a49446e54",
            "filename": "test/addons-napi/7_factory_wrap/binding.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/1cee08536794b6d7bc8d3b9ace2b494c74985f7d/test%2Faddons-napi%2F7_factory_wrap%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1cee08536794b6d7bc8d3b9ace2b494c74985f7d/test%2Faddons-napi%2F7_factory_wrap%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2F7_factory_wrap%2Fbinding.cc?ref=1cee08536794b6d7bc8d3b9ace2b494c74985f7d",
            "patch": "@@ -15,9 +15,14 @@ napi_value CreateObject(napi_env env, napi_callback_info info) {\n napi_value Init(napi_env env, napi_value exports) {\n   NAPI_CALL(env, MyObject::Init(env));\n \n-  NAPI_CALL(env,\n-      // NOLINTNEXTLINE (readability/null_usage)\n-      napi_create_function(env, \"exports\", -1, CreateObject, NULL, &exports));\n+  napi_property_descriptor descriptors[] = {\n+    DECLARE_NAPI_GETTER(\"finalizeCount\", MyObject::GetFinalizeCount),\n+    DECLARE_NAPI_PROPERTY(\"createObject\", CreateObject),\n+  };\n+\n+  NAPI_CALL(env, napi_define_properties(\n+      env, exports, sizeof(descriptors) / sizeof(*descriptors), descriptors));\n+\n   return exports;\n }\n "
        },
        {
            "sha": "b7cc9c534f366a57c148b6508859ee7f1cd6581a",
            "filename": "test/addons-napi/7_factory_wrap/myobject.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/1cee08536794b6d7bc8d3b9ace2b494c74985f7d/test%2Faddons-napi%2F7_factory_wrap%2Fmyobject.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1cee08536794b6d7bc8d3b9ace2b494c74985f7d/test%2Faddons-napi%2F7_factory_wrap%2Fmyobject.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2F7_factory_wrap%2Fmyobject.cc?ref=1cee08536794b6d7bc8d3b9ace2b494c74985f7d",
            "patch": "@@ -1,17 +1,26 @@\n #include \"myobject.h\"\n #include \"../common.h\"\n \n+static int finalize_count = 0;\n+\n MyObject::MyObject() : env_(nullptr), wrapper_(nullptr) {}\n \n MyObject::~MyObject() { napi_delete_reference(env_, wrapper_); }\n \n void MyObject::Destructor(napi_env env,\n                           void* nativeObject,\n                           void* /*finalize_hint*/) {\n+  ++finalize_count;\n   MyObject* obj = static_cast<MyObject*>(nativeObject);\n   delete obj;\n }\n \n+napi_value MyObject::GetFinalizeCount(napi_env env, napi_callback_info info) {\n+  napi_value result;\n+  NAPI_CALL(env, napi_create_int32(env, finalize_count, &result));\n+  return result;\n+}\n+\n napi_ref MyObject::constructor;\n \n napi_status MyObject::Init(napi_env env) {"
        },
        {
            "sha": "172fcd3ca492956d9b304edccfabce48c0ab6dd8",
            "filename": "test/addons-napi/7_factory_wrap/myobject.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/1cee08536794b6d7bc8d3b9ace2b494c74985f7d/test%2Faddons-napi%2F7_factory_wrap%2Fmyobject.h",
            "raw_url": "https://github.com/nodejs/node/raw/1cee08536794b6d7bc8d3b9ace2b494c74985f7d/test%2Faddons-napi%2F7_factory_wrap%2Fmyobject.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2F7_factory_wrap%2Fmyobject.h?ref=1cee08536794b6d7bc8d3b9ace2b494c74985f7d",
            "patch": "@@ -7,6 +7,7 @@ class MyObject {\n  public:\n   static napi_status Init(napi_env env);\n   static void Destructor(napi_env env, void* nativeObject, void* finalize_hint);\n+  static napi_value GetFinalizeCount(napi_env env, napi_callback_info info);\n   static napi_status NewInstance(napi_env env,\n                                  napi_value arg,\n                                  napi_value* instance);"
        },
        {
            "sha": "8aaf1b0ba91ee74ad7b18af88fc7d66cf25c7a08",
            "filename": "test/addons-napi/7_factory_wrap/test.js",
            "status": "modified",
            "additions": 20,
            "deletions": 9,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/1cee08536794b6d7bc8d3b9ace2b494c74985f7d/test%2Faddons-napi%2F7_factory_wrap%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/1cee08536794b6d7bc8d3b9ace2b494c74985f7d/test%2Faddons-napi%2F7_factory_wrap%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2F7_factory_wrap%2Ftest.js?ref=1cee08536794b6d7bc8d3b9ace2b494c74985f7d",
            "patch": "@@ -1,14 +1,25 @@\n 'use strict';\n+// Flags: --expose-gc\n+\n const common = require('../../common');\n const assert = require('assert');\n-const createObject = require(`./build/${common.buildType}/binding`);\n+const test = require(`./build/${common.buildType}/binding`);\n \n-const obj = createObject(10);\n-assert.strictEqual(obj.plusOne(), 11);\n-assert.strictEqual(obj.plusOne(), 12);\n-assert.strictEqual(obj.plusOne(), 13);\n+assert.strictEqual(test.finalizeCount, 0);\n+(() => {\n+  const obj = test.createObject(10);\n+  assert.strictEqual(obj.plusOne(), 11);\n+  assert.strictEqual(obj.plusOne(), 12);\n+  assert.strictEqual(obj.plusOne(), 13);\n+})();\n+global.gc();\n+assert.strictEqual(test.finalizeCount, 1);\n \n-const obj2 = createObject(20);\n-assert.strictEqual(obj2.plusOne(), 21);\n-assert.strictEqual(obj2.plusOne(), 22);\n-assert.strictEqual(obj2.plusOne(), 23);\n+(() => {\n+  const obj2 = test.createObject(20);\n+  assert.strictEqual(obj2.plusOne(), 21);\n+  assert.strictEqual(obj2.plusOne(), 22);\n+  assert.strictEqual(obj2.plusOne(), 23);\n+})();\n+global.gc();\n+assert.strictEqual(test.finalizeCount, 2);"
        },
        {
            "sha": "525993c96d3bad7ab378fedc3b0e941bbe15386c",
            "filename": "test/addons-napi/8_passing_wrapped/test.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1cee08536794b6d7bc8d3b9ace2b494c74985f7d/test%2Faddons-napi%2F8_passing_wrapped%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/1cee08536794b6d7bc8d3b9ace2b494c74985f7d/test%2Faddons-napi%2F8_passing_wrapped%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons-napi%2F8_passing_wrapped%2Ftest.js?ref=1cee08536794b6d7bc8d3b9ace2b494c74985f7d",
            "patch": "@@ -6,11 +6,12 @@ const assert = require('assert');\n const addon = require(`./build/${common.buildType}/binding`);\n \n let obj1 = addon.createObject(10);\n-const obj2 = addon.createObject(20);\n+let obj2 = addon.createObject(20);\n const result = addon.add(obj1, obj2);\n assert.strictEqual(result, 30);\n \n // Make sure the native destructor gets called.\n obj1 = null;\n+obj2 = null;\n global.gc();\n-assert.strictEqual(addon.finalizeCount(), 1);\n+assert.strictEqual(addon.finalizeCount(), 2);"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 41,
        "deletions": 14
    }
}