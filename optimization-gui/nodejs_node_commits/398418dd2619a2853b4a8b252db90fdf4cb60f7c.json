{
    "author": "mcollina",
    "message": "stream: ended streams should resolve the async iteration\n\nFixes: https://github.com/nodejs/node/issues/23891\n\nPR-URL: https://github.com/nodejs/node/pull/23901\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "398418dd2619a2853b4a8b252db90fdf4cb60f7c",
    "files": [
        {
            "sha": "5d7f3f0fb424b7c36df0077f34f09a8827ad8cf4",
            "filename": "lib/internal/streams/async_iterator.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/398418dd2619a2853b4a8b252db90fdf4cb60f7c/lib%2Finternal%2Fstreams%2Fasync_iterator.js",
            "raw_url": "https://github.com/nodejs/node/raw/398418dd2619a2853b4a8b252db90fdf4cb60f7c/lib%2Finternal%2Fstreams%2Fasync_iterator.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstreams%2Fasync_iterator.js?ref=398418dd2619a2853b4a8b252db90fdf4cb60f7c",
            "patch": "@@ -127,7 +127,10 @@ const createReadableStreamAsyncIterator = (stream) => {\n     [kLastResolve]: { value: null, writable: true },\n     [kLastReject]: { value: null, writable: true },\n     [kError]: { value: null, writable: true },\n-    [kEnded]: { value: false, writable: true },\n+    [kEnded]: {\n+      value: stream._readableState.endEmitted,\n+      writable: true\n+    },\n     [kLastPromise]: { value: null, writable: true },\n     // the function passed to new Promise\n     // is cached so we avoid allocating a new"
        },
        {
            "sha": "a9431fab81654a826c08c94c9423ef4f15cacefb",
            "filename": "test/parallel/test-stream-readable-async-iterators.js",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/398418dd2619a2853b4a8b252db90fdf4cb60f7c/test%2Fparallel%2Ftest-stream-readable-async-iterators.js",
            "raw_url": "https://github.com/nodejs/node/raw/398418dd2619a2853b4a8b252db90fdf4cb60f7c/test%2Fparallel%2Ftest-stream-readable-async-iterators.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-async-iterators.js?ref=398418dd2619a2853b4a8b252db90fdf4cb60f7c",
            "patch": "@@ -362,6 +362,24 @@ async function tests() {\n       assert.strictEqual(e, err);\n     }\n   })();\n+\n+  await (async () => {\n+    console.log('iterating on an ended stream completes');\n+    const r = new Readable({\n+      objectMode: true,\n+      read() {\n+        this.push('asdf');\n+        this.push('hehe');\n+        this.push(null);\n+      }\n+    });\n+    // eslint-disable-next-line no-unused-vars\n+    for await (const a of r) {\n+    }\n+    // eslint-disable-next-line no-unused-vars\n+    for await (const b of r) {\n+    }\n+  })();\n }\n \n // to avoid missing some tests if a promise does not resolve"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 22,
        "deletions": 1
    }
}