{
    "author": "bnoordhuis",
    "message": "src: make process.env.TZ setter clear tz cache\n\nSince the presence of the libc and V8 timezone caches seem to be\na perennial source of confusion to users (\"why doesn't it work?!\"),\nlet's try to support that pattern by intercepting assignments to\nthe `TZ` environment variable and reset the caches as a side effect.\n\nPR-URL: https://github.com/nodejs/node/pull/20026\nFixes: https://github.com/nodejs/node/issues/19974\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "1d1ab76e1737da4229b3a0774c60a8fbead89040",
    "files": [
        {
            "sha": "355b71de672ae31667f4bafdecb8709151f89cd4",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/1d1ab76e1737da4229b3a0774c60a8fbead89040/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1d1ab76e1737da4229b3a0774c60a8fbead89040/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=1d1ab76e1737da4229b3a0774c60a8fbead89040",
            "patch": "@@ -80,6 +80,7 @@\n #include <stdlib.h>\n #include <string.h>\n #include <sys/types.h>\n+#include <time.h>  // tzset(), _tzset()\n \n #include <string>\n #include <vector>\n@@ -135,6 +136,7 @@ using v8::Array;\n using v8::ArrayBuffer;\n using v8::Boolean;\n using v8::Context;\n+using v8::Date;\n using v8::EscapableHandleScope;\n using v8::Exception;\n using v8::Float64Array;\n@@ -2679,6 +2681,10 @@ static void EnvSetter(Local<Name> property,\n   node::Utf8Value key(info.GetIsolate(), property);\n   node::Utf8Value val(info.GetIsolate(), value);\n   setenv(*key, *val, 1);\n+  if (key.length() == 2 && key[0] == 'T' && key[1] == 'Z') {\n+    tzset();\n+    Date::DateTimeConfigurationChangeNotification(info.GetIsolate());\n+  }\n #else  // _WIN32\n   node::TwoByteValue key(info.GetIsolate(), property);\n   node::TwoByteValue val(info.GetIsolate(), value);\n@@ -2687,6 +2693,10 @@ static void EnvSetter(Local<Name> property,\n   if (key_ptr[0] != L'=') {\n     SetEnvironmentVariableW(key_ptr, reinterpret_cast<WCHAR*>(*val));\n   }\n+  if (key.length() == 2 && key[0] == L'T' && key[1] == L'Z') {\n+    _tzset();\n+    Date::DateTimeConfigurationChangeNotification(info.GetIsolate());\n+  }\n #endif\n   // Whether it worked or not, always return value.\n   info.GetReturnValue().Set(value);"
        },
        {
            "sha": "7e077588d46e642280ad9fbe1e9f04dd3e1fc353",
            "filename": "test/parallel/test-process-env-tz.js",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/1d1ab76e1737da4229b3a0774c60a8fbead89040/test%2Fparallel%2Ftest-process-env-tz.js",
            "raw_url": "https://github.com/nodejs/node/raw/1d1ab76e1737da4229b3a0774c60a8fbead89040/test%2Fparallel%2Ftest-process-env-tz.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-env-tz.js?ref=1d1ab76e1737da4229b3a0774c60a8fbead89040",
            "patch": "@@ -0,0 +1,23 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+\n+if (common.isWindows)  // Using a different TZ format.\n+  common.skip('todo: test on Windows');\n+\n+if (common.isAIX || common.isSunOS)  // Reports 2018 CEST as CET.\n+  common.skip('tzdata too old');\n+\n+const date = new Date('2018-04-14T12:34:56.789Z');\n+\n+process.env.TZ = 'Europe/Amsterdam';\n+if (/\\(Europe\\)/.test(date.toString()))\n+  common.skip('not using bundled ICU');  // Shared library or --with-intl=none.\n+assert.strictEqual(date.toString(), 'Sat Apr 14 2018 14:34:56 GMT+0200 (CEST)');\n+\n+process.env.TZ = 'Europe/London';\n+assert.strictEqual(date.toString(), 'Sat Apr 14 2018 13:34:56 GMT+0100 (BST)');\n+\n+process.env.TZ = 'Etc/UTC';\n+assert.strictEqual(date.toString(), 'Sat Apr 14 2018 12:34:56 GMT+0000 (UTC)');"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 33,
        "deletions": 0
    }
}