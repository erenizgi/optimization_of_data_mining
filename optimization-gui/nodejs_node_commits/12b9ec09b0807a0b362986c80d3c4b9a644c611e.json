{
    "author": "addaleax",
    "message": "http2: remove regular-file-only restriction\n\nRequiring `respondWithFile()` to only work with regular files\nis an artificial restriction on Nodeâ€™s side and has become unnecessary.\n\nOffsets or lengths cannot be specified for those files,\nbut that is an inherent property of other file types.\n\nPR-URL: https://github.com/nodejs/node/pull/18936\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "12b9ec09b0807a0b362986c80d3c4b9a644c611e",
    "files": [
        {
            "sha": "f5190dc52bffa9549b60295b159b5c4d19e92863",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/12b9ec09b0807a0b362986c80d3c4b9a644c611e/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/12b9ec09b0807a0b362986c80d3c4b9a644c611e/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=12b9ec09b0807a0b362986c80d3c4b9a644c611e",
            "patch": "@@ -971,7 +971,14 @@ client.\n ### ERR_HTTP2_SEND_FILE\n \n An attempt was made to use the `Http2Stream.prototype.responseWithFile()` API to\n-send something other than a regular file.\n+send a directory.\n+\n+<a id=\"ERR_HTTP2_SEND_FILE_NOSEEK\"></a>\n+### ERR_HTTP2_SEND_FILE_NOSEEK\n+\n+An attempt was made to use the `Http2Stream.prototype.responseWithFile()` API to\n+send something other than a regular file, but `offset` or `length` options were\n+provided.\n \n <a id=\"ERR_HTTP2_SESSION_ERROR\"></a>\n ### ERR_HTTP2_SESSION_ERROR"
        },
        {
            "sha": "13aa4d1e2103d142b6a8489831ee4009f0be37fb",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/12b9ec09b0807a0b362986c80d3c4b9a644c611e/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/12b9ec09b0807a0b362986c80d3c4b9a644c611e/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=12b9ec09b0807a0b362986c80d3c4b9a644c611e",
            "patch": "@@ -1223,6 +1223,11 @@ if the `getTrailers` callback attempts to set such header fields.\n #### http2stream.respondWithFD(fd[, headers[, options]])\n <!-- YAML\n added: v8.4.0\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/18936\n+    description: Any readable file descriptor, not necessarily for a\n+                 regular file, is supported now.\n -->\n \n * `fd` {number} A readable file descriptor.\n@@ -1313,6 +1318,11 @@ if the `getTrailers` callback attempts to set such header fields.\n #### http2stream.respondWithFile(path[, headers[, options]])\n <!-- YAML\n added: v8.4.0\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/18936\n+    description: Any readable file, not necessarily a\n+                 regular file, is supported now.\n -->\n \n * `path` {string|Buffer|URL}"
        },
        {
            "sha": "3d0b6cf9b39177cb13c906e3c771ef849598e66a",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/12b9ec09b0807a0b362986c80d3c4b9a644c611e/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b9ec09b0807a0b362986c80d3c4b9a644c611e/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=12b9ec09b0807a0b362986c80d3c4b9a644c611e",
            "patch": "@@ -714,7 +714,9 @@ E('ERR_HTTP2_PING_LENGTH', 'HTTP2 ping payload must be 8 bytes', RangeError);\n E('ERR_HTTP2_PSEUDOHEADER_NOT_ALLOWED',\n   'Cannot set HTTP/2 pseudo-headers', Error);\n E('ERR_HTTP2_PUSH_DISABLED', 'HTTP/2 client has disabled push streams', Error);\n-E('ERR_HTTP2_SEND_FILE', 'Only regular files can be sent', Error);\n+E('ERR_HTTP2_SEND_FILE', 'Directories cannot be sent', Error);\n+E('ERR_HTTP2_SEND_FILE_NOSEEK',\n+  'Offset or length can only be specified for regular files', Error);\n E('ERR_HTTP2_SESSION_ERROR', 'Session closed with error code %s', Error);\n E('ERR_HTTP2_SOCKET_BOUND',\n   'The socket is already bound to an Http2Session', Error);"
        },
        {
            "sha": "7137e527df07aa9fb138eeba5a0df344c390e706",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 23,
            "deletions": 11,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/12b9ec09b0807a0b362986c80d3c4b9a644c611e/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b9ec09b0807a0b362986c80d3c4b9a644c611e/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=12b9ec09b0807a0b362986c80d3c4b9a644c611e",
            "patch": "@@ -42,6 +42,7 @@ const {\n     ERR_HTTP2_PING_LENGTH,\n     ERR_HTTP2_PUSH_DISABLED,\n     ERR_HTTP2_SEND_FILE,\n+    ERR_HTTP2_SEND_FILE_NOSEEK,\n     ERR_HTTP2_SESSION_ERROR,\n     ERR_HTTP2_SETTINGS_CANCEL,\n     ERR_HTTP2_SOCKET_BOUND,\n@@ -2045,12 +2046,21 @@ function doSendFileFD(session, options, fd, headers, streamOptions, err, stat) {\n   }\n \n   if (!stat.isFile()) {\n-    const err = new ERR_HTTP2_SEND_FILE();\n-    if (onError)\n-      onError(err);\n-    else\n-      this.destroy(err);\n-    return;\n+    const isDirectory = stat.isDirectory();\n+    if (options.offset !== undefined || options.offset > 0 ||\n+        options.length !== undefined || options.length >= 0 ||\n+        isDirectory) {\n+      const err = isDirectory ?\n+        new ERR_HTTP2_SEND_FILE() : new ERR_HTTP2_SEND_FILE_NOSEEK();\n+      if (onError)\n+        onError(err);\n+      else\n+        this.destroy(err);\n+      return;\n+    }\n+\n+    options.offset = -1;\n+    options.length = -1;\n   }\n \n   if (this.destroyed || this.closed) {\n@@ -2075,12 +2085,14 @@ function doSendFileFD(session, options, fd, headers, streamOptions, err, stat) {\n     return;\n   }\n \n-  statOptions.length =\n-    statOptions.length < 0 ? stat.size - (+statOptions.offset) :\n-      Math.min(stat.size - (+statOptions.offset),\n-               statOptions.length);\n+  if (stat.isFile()) {\n+    statOptions.length =\n+      statOptions.length < 0 ? stat.size - (+statOptions.offset) :\n+        Math.min(stat.size - (+statOptions.offset),\n+                 statOptions.length);\n \n-  headers[HTTP2_HEADER_CONTENT_LENGTH] = statOptions.length;\n+    headers[HTTP2_HEADER_CONTENT_LENGTH] = statOptions.length;\n+  }\n \n   processRespondWithFD(this, fd, headers,\n                        options.offset | 0,"
        },
        {
            "sha": "24a6d2dc96597e825195c310fd776415f7aefca5",
            "filename": "test/parallel/test-http2-respond-file-error-dir.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/12b9ec09b0807a0b362986c80d3c4b9a644c611e/test%2Fparallel%2Ftest-http2-respond-file-error-dir.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b9ec09b0807a0b362986c80d3c4b9a644c611e/test%2Fparallel%2Ftest-http2-respond-file-error-dir.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-file-error-dir.js?ref=12b9ec09b0807a0b362986c80d3c4b9a644c611e",
            "patch": "@@ -15,7 +15,7 @@ server.on('stream', (stream) => {\n       common.expectsError({\n         code: 'ERR_HTTP2_SEND_FILE',\n         type: Error,\n-        message: 'Only regular files can be sent'\n+        message: 'Directories cannot be sent'\n       })(err);\n \n       stream.respond({ ':status': 404 });"
        },
        {
            "sha": "eb782e2dea66c43613adf5deb11a48a5d4d88c11",
            "filename": "test/parallel/test-http2-respond-file-error-pipe-offset.js",
            "status": "added",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/nodejs/node/blob/12b9ec09b0807a0b362986c80d3c4b9a644c611e/test%2Fparallel%2Ftest-http2-respond-file-error-pipe-offset.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b9ec09b0807a0b362986c80d3c4b9a644c611e/test%2Fparallel%2Ftest-http2-respond-file-error-pipe-offset.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-file-error-pipe-offset.js?ref=12b9ec09b0807a0b362986c80d3c4b9a644c611e",
            "patch": "@@ -0,0 +1,61 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+if (common.isWindows)\n+  common.skip('no mkfifo on Windows');\n+const child_process = require('child_process');\n+const path = require('path');\n+const fs = require('fs');\n+const http2 = require('http2');\n+const assert = require('assert');\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+const pipeName = path.join(tmpdir.path, 'pipe');\n+\n+const mkfifo = child_process.spawnSync('mkfifo', [ pipeName ]);\n+if (mkfifo.error && mkfifo.error.code === 'ENOENT') {\n+  common.skip('missing mkfifo');\n+}\n+\n+process.on('exit', () => fs.unlinkSync(pipeName));\n+\n+const server = http2.createServer();\n+server.on('stream', (stream) => {\n+  stream.respondWithFile(pipeName, {\n+    'content-type': 'text/plain'\n+  }, {\n+    offset: 10,\n+    onError(err) {\n+      common.expectsError({\n+        code: 'ERR_HTTP2_SEND_FILE_NOSEEK',\n+        type: Error,\n+        message: 'Offset or length can only be specified for regular files'\n+      })(err);\n+\n+      stream.respond({ ':status': 404 });\n+      stream.end();\n+    },\n+    statCheck: common.mustNotCall()\n+  });\n+});\n+server.listen(0, () => {\n+\n+  const client = http2.connect(`http://localhost:${server.address().port}`);\n+  const req = client.request();\n+\n+  req.on('response', common.mustCall((headers) => {\n+    assert.strictEqual(headers[':status'], 404);\n+  }));\n+  req.on('data', common.mustNotCall());\n+  req.on('end', common.mustCall(() => {\n+    client.close();\n+    server.close();\n+  }));\n+  req.end();\n+});\n+\n+fs.writeFile(pipeName, 'Hello, world!\\n', common.mustCall());"
        },
        {
            "sha": "2b7ca3fc9a51ee69f3895c7709db7d87af924852",
            "filename": "test/parallel/test-http2-respond-file-with-pipe.js",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/12b9ec09b0807a0b362986c80d3c4b9a644c611e/test%2Fparallel%2Ftest-http2-respond-file-with-pipe.js",
            "raw_url": "https://github.com/nodejs/node/raw/12b9ec09b0807a0b362986c80d3c4b9a644c611e/test%2Fparallel%2Ftest-http2-respond-file-with-pipe.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-respond-file-with-pipe.js?ref=12b9ec09b0807a0b362986c80d3c4b9a644c611e",
            "patch": "@@ -0,0 +1,58 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+if (common.isWindows)\n+  common.skip('no mkfifo on Windows');\n+const child_process = require('child_process');\n+const path = require('path');\n+const fs = require('fs');\n+const http2 = require('http2');\n+const assert = require('assert');\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+const pipeName = path.join(tmpdir.path, 'pipe');\n+\n+const mkfifo = child_process.spawnSync('mkfifo', [ pipeName ]);\n+if (mkfifo.error && mkfifo.error.code === 'ENOENT') {\n+  common.skip('missing mkfifo');\n+}\n+\n+process.on('exit', () => fs.unlinkSync(pipeName));\n+\n+const server = http2.createServer();\n+server.on('stream', (stream) => {\n+  stream.respondWithFile(pipeName, {\n+    'content-type': 'text/plain'\n+  }, {\n+    onError: common.mustNotCall(),\n+    statCheck: common.mustCall()\n+  });\n+});\n+\n+server.listen(0, () => {\n+  const client = http2.connect(`http://localhost:${server.address().port}`);\n+  const req = client.request();\n+\n+  req.on('response', common.mustCall((headers) => {\n+    assert.strictEqual(headers[':status'], 200);\n+  }));\n+  let body = '';\n+  req.setEncoding('utf8');\n+  req.on('data', (chunk) => body += chunk);\n+  req.on('end', common.mustCall(() => {\n+    assert.strictEqual(body, 'Hello, world!\\n');\n+    client.close();\n+    server.close();\n+  }));\n+  req.end();\n+});\n+\n+fs.open(pipeName, 'w', common.mustCall((err, fd) => {\n+  assert.ifError(err);\n+  fs.writeSync(fd, 'Hello, world!\\n');\n+  fs.closeSync(fd);\n+}));"
        }
    ],
    "stats": {
        "total": 178,
        "additions": 164,
        "deletions": 14
    }
}