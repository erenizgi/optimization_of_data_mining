{
    "author": "mcollina",
    "message": "http2: fix flaky test-http2-https-fallback\n\nThe test was flaky because it relied on a specific order of\nasynchronous operation that were fired paralellely. This was true\non most platform and conditions, but not all the time.\n\nSee: https://github.com/nodejs/node/pull/18986\n\nPR-URL: https://github.com/nodejs/node/pull/19093\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "bbc9807b207b08759b447672fa638c9ec96d4c17",
    "files": [
        {
            "sha": "a872d686d34f852d5a2b5c413d3837ec69079a27",
            "filename": "test/parallel/test-http2-https-fallback.js",
            "status": "modified",
            "additions": 29,
            "deletions": 16,
            "changes": 45,
            "blob_url": "https://github.com/nodejs/node/blob/bbc9807b207b08759b447672fa638c9ec96d4c17/test%2Fparallel%2Ftest-http2-https-fallback.js",
            "raw_url": "https://github.com/nodejs/node/raw/bbc9807b207b08759b447672fa638c9ec96d4c17/test%2Fparallel%2Ftest-http2-https-fallback.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-https-fallback.js?ref=bbc9807b207b08759b447672fa638c9ec96d4c17",
            "patch": "@@ -31,7 +31,7 @@ function onRequest(request, response) {\n   }));\n }\n \n-function onSession(session) {\n+function onSession(session, next) {\n   const headers = {\n     ':path': '/',\n     ':method': 'GET',\n@@ -54,6 +54,10 @@ function onSession(session) {\n \n     session.close();\n     this.cleanup();\n+\n+    if (typeof next === 'function') {\n+      next();\n+    }\n   }));\n   request.end();\n }\n@@ -126,22 +130,31 @@ function onSession(session) {\n     connect(\n       origin,\n       clientOptions,\n-      common.mustCall(onSession.bind({ cleanup, server }))\n+      common.mustCall(function(session) {\n+        onSession.call({ cleanup, server },\n+                       session,\n+                       common.mustCall(testNoTls));\n+      })\n     );\n \n-    // HTTP/1.1 client\n-    get(Object.assign(parse(origin), clientOptions), common.mustNotCall())\n-      .on('error', common.mustCall(cleanup))\n-      .end();\n-\n-    // Incompatible ALPN TLS client\n-    let text = '';\n-    tls(Object.assign({ port, ALPNProtocols: ['fake'] }, clientOptions))\n-      .setEncoding('utf8')\n-      .on('data', (chunk) => text += chunk)\n-      .on('end', common.mustCall(() => {\n-        ok(/Unknown ALPN Protocol, expected `h2` to be available/.test(text));\n-        cleanup();\n-      }));\n+    function testNoTls() {\n+      // HTTP/1.1 client\n+      get(Object.assign(parse(origin), clientOptions), common.mustNotCall)\n+        .on('error', common.mustCall(cleanup))\n+        .on('error', common.mustCall(testWrongALPN))\n+        .end();\n+    }\n+\n+    function testWrongALPN() {\n+      // Incompatible ALPN TLS client\n+      let text = '';\n+      tls(Object.assign({ port, ALPNProtocols: ['fake'] }, clientOptions))\n+        .setEncoding('utf8')\n+        .on('data', (chunk) => text += chunk)\n+        .on('end', common.mustCall(() => {\n+          ok(/Unknown ALPN Protocol, expected `h2` to be available/.test(text));\n+          cleanup();\n+        }));\n+    }\n   }));\n }"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 29,
        "deletions": 16
    }
}