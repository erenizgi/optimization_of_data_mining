{
    "author": "addaleax",
    "message": "src: use lock for c-ares library init/cleanup\n\nThis helps embedders wishing to use Node.js in a multi-threaded fashion\nand helps pave the way for thread-based worker support.\n\nThanks to Stephen Belanger for reviewing this commit in its original PR.\n\nRefs: https://github.com/ayojs/ayo/pull/82\n\nPR-URL: https://github.com/nodejs/node/pull/20539\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "ccdee34072eab0f7ea385571aa43b00cb8dba4fd",
    "files": [
        {
            "sha": "4208c02d4fe4453d629dfa27cad61f37facc89be",
            "filename": "src/cares_wrap.cc",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/ccdee34072eab0f7ea385571aa43b00cb8dba4fd/src%2Fcares_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/ccdee34072eab0f7ea385571aa43b00cb8dba4fd/src%2Fcares_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcares_wrap.cc?ref=ccdee34072eab0f7ea385571aa43b00cb8dba4fd",
            "patch": "@@ -70,6 +70,8 @@ using v8::Value;\n \n namespace {\n \n+Mutex ares_library_mutex;\n+\n inline uint16_t cares_get_16bit(const unsigned char* p) {\n   return static_cast<uint32_t>(p[0] << 8U) | (static_cast<uint32_t>(p[1]));\n }\n@@ -470,6 +472,7 @@ void ChannelWrap::Setup() {\n \n   int r;\n   if (!library_inited_) {\n+    Mutex::ScopedLock lock(ares_library_mutex);\n     // Multiple calls to ares_library_init() increase a reference counter,\n     // so this is a no-op except for the first call to it.\n     r = ares_library_init(ARES_LIB_INIT_ALL);\n@@ -483,6 +486,7 @@ void ChannelWrap::Setup() {\n                         ARES_OPT_FLAGS | ARES_OPT_SOCK_STATE_CB);\n \n   if (r != ARES_SUCCESS) {\n+    Mutex::ScopedLock lock(ares_library_mutex);\n     ares_library_cleanup();\n     return env()->ThrowError(ToErrorCodeString(r));\n   }\n@@ -500,6 +504,7 @@ void ChannelWrap::Setup() {\n \n ChannelWrap::~ChannelWrap() {\n   if (library_inited_) {\n+    Mutex::ScopedLock lock(ares_library_mutex);\n     // This decreases the reference counter increased by ares_library_init().\n     ares_library_cleanup();\n   }"
        }
    ],
    "stats": {
        "total": 5,
        "additions": 5,
        "deletions": 0
    }
}