{
    "author": "addaleax",
    "message": "worker: use engine-provided deleter for `SharedArrayBuffer`s\n\nStore the full information we have on a given `SharedArrayBuffer`,\nand use the deleter provided by the JS engine to free the memory\nwhen that is needed.\n\nThis fixes memory lifetime management for WASM buffers that are\npassed through a `MessageChannel` (e.g. between threads).\n\nPR-URL: https://github.com/nodejs/node/pull/25307\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "1f1a373df0121a9e4a2887f69862169b2f4ed2fd",
    "files": [
        {
            "sha": "671ad6d68204402f88efb6bf00a1a5725df72acc",
            "filename": "src/sharedarraybuffer_metadata.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/1f1a373df0121a9e4a2887f69862169b2f4ed2fd/src%2Fsharedarraybuffer_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/1f1a373df0121a9e4a2887f69862169b2f4ed2fd/src%2Fsharedarraybuffer_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fsharedarraybuffer_metadata.cc?ref=1f1a373df0121a9e4a2887f69862169b2f4ed2fd",
            "patch": "@@ -89,8 +89,7 @@ SharedArrayBufferMetadata::ForSharedArrayBuffer(\n   }\n \n   SharedArrayBuffer::Contents contents = source->Externalize();\n-  SharedArrayBufferMetadataReference r(new SharedArrayBufferMetadata(\n-      contents.Data(), contents.ByteLength()));\n+  SharedArrayBufferMetadataReference r(new SharedArrayBufferMetadata(contents));\n   if (r->AssignToSharedArrayBuffer(env, context, source).IsNothing())\n     return nullptr;\n   return r;\n@@ -111,17 +110,22 @@ Maybe<bool> SharedArrayBufferMetadata::AssignToSharedArrayBuffer(\n                             obj);\n }\n \n-SharedArrayBufferMetadata::SharedArrayBufferMetadata(void* data, size_t size)\n-  : data(data), size(size) { }\n+SharedArrayBufferMetadata::SharedArrayBufferMetadata(\n+    const SharedArrayBuffer::Contents& contents)\n+  : contents_(contents) { }\n \n SharedArrayBufferMetadata::~SharedArrayBufferMetadata() {\n-  free(data);\n+  contents_.Deleter()(contents_.Data(),\n+                      contents_.ByteLength(),\n+                      contents_.DeleterData());\n }\n \n MaybeLocal<SharedArrayBuffer> SharedArrayBufferMetadata::GetSharedArrayBuffer(\n     Environment* env, Local<Context> context) {\n   Local<SharedArrayBuffer> obj =\n-      SharedArrayBuffer::New(env->isolate(), data, size);\n+      SharedArrayBuffer::New(env->isolate(),\n+                             contents_.Data(),\n+                             contents_.ByteLength());\n \n   if (AssignToSharedArrayBuffer(env, context, obj).IsNothing())\n     return MaybeLocal<SharedArrayBuffer>();"
        },
        {
            "sha": "8c753a89c11a883c3aeded4cb25712450708b678",
            "filename": "src/sharedarraybuffer_metadata.h",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/1f1a373df0121a9e4a2887f69862169b2f4ed2fd/src%2Fsharedarraybuffer_metadata.h",
            "raw_url": "https://github.com/nodejs/node/raw/1f1a373df0121a9e4a2887f69862169b2f4ed2fd/src%2Fsharedarraybuffer_metadata.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fsharedarraybuffer_metadata.h?ref=1f1a373df0121a9e4a2887f69862169b2f4ed2fd",
            "patch": "@@ -46,16 +46,15 @@ class SharedArrayBufferMetadata\n   SharedArrayBufferMetadata(const SharedArrayBufferMetadata&) = delete;\n \n  private:\n-  explicit SharedArrayBufferMetadata(void* data, size_t size);\n+  explicit SharedArrayBufferMetadata(const v8::SharedArrayBuffer::Contents&);\n \n   // Attach a lifetime tracker object with a reference count to `target`.\n   v8::Maybe<bool> AssignToSharedArrayBuffer(\n       Environment* env,\n       v8::Local<v8::Context> context,\n       v8::Local<v8::SharedArrayBuffer> target);\n \n-  void* data = nullptr;\n-  size_t size = 0;\n+  v8::SharedArrayBuffer::Contents contents_;\n };\n \n }  // namespace worker"
        },
        {
            "sha": "24b4d691058fd4f8987fb45e5ff5b9069ff1c36d",
            "filename": "test/fixtures/wasm-threads-shared-memory.wasm",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/nodejs/node/blob/1f1a373df0121a9e4a2887f69862169b2f4ed2fd/test%2Ffixtures%2Fwasm-threads-shared-memory.wasm",
            "raw_url": "https://github.com/nodejs/node/raw/1f1a373df0121a9e4a2887f69862169b2f4ed2fd/test%2Ffixtures%2Fwasm-threads-shared-memory.wasm",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fwasm-threads-shared-memory.wasm?ref=1f1a373df0121a9e4a2887f69862169b2f4ed2fd"
        },
        {
            "sha": "68a2698df6564e951f2ca75c92e627d525ab1a8c",
            "filename": "test/fixtures/wasm-threads-shared-memory.wat",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/1f1a373df0121a9e4a2887f69862169b2f4ed2fd/test%2Ffixtures%2Fwasm-threads-shared-memory.wat",
            "raw_url": "https://github.com/nodejs/node/raw/1f1a373df0121a9e4a2887f69862169b2f4ed2fd/test%2Ffixtures%2Fwasm-threads-shared-memory.wat",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fwasm-threads-shared-memory.wat?ref=1f1a373df0121a9e4a2887f69862169b2f4ed2fd",
            "patch": "@@ -0,0 +1,4 @@\n+(module\n+  (memory $mem 1 2 shared)\n+  (export \"memory\" (memory $mem))\n+)\n\\ No newline at end of file"
        },
        {
            "sha": "6d4f21d728d1b399f392059ae730336bb9a3ecfa",
            "filename": "test/parallel/test-worker-message-port-wasm-threads.js",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/nodejs/node/blob/1f1a373df0121a9e4a2887f69862169b2f4ed2fd/test%2Fparallel%2Ftest-worker-message-port-wasm-threads.js",
            "raw_url": "https://github.com/nodejs/node/raw/1f1a373df0121a9e4a2887f69862169b2f4ed2fd/test%2Fparallel%2Ftest-worker-message-port-wasm-threads.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-worker-message-port-wasm-threads.js?ref=1f1a373df0121a9e4a2887f69862169b2f4ed2fd",
            "patch": "@@ -0,0 +1,46 @@\n+// Flags: --experimental-worker --experimental-wasm-threads\n+'use strict';\n+const common = require('../common');\n+const assert = require('assert');\n+const { MessageChannel, Worker } = require('worker_threads');\n+\n+// Test that SharedArrayBuffer instances created from WASM are transferrable\n+// through MessageChannels (without crashing).\n+\n+const fixtures = require('../common/fixtures');\n+const wasmSource = fixtures.readSync('wasm-threads-shared-memory.wasm');\n+const wasmModule = new WebAssembly.Module(wasmSource);\n+const instance = new WebAssembly.Instance(wasmModule);\n+\n+const { buffer } = instance.exports.memory;\n+assert(buffer instanceof SharedArrayBuffer);\n+\n+{\n+  const { port1, port2 } = new MessageChannel();\n+  port1.postMessage(buffer);\n+  port2.once('message', common.mustCall((buffer2) => {\n+    // Make sure serialized + deserialized buffer refer to the same memory.\n+    const expected = 'Hello, world!';\n+    const bytes = Buffer.from(buffer).write(expected);\n+    const deserialized = Buffer.from(buffer2).toString('utf8', 0, bytes);\n+    assert.deepStrictEqual(deserialized, expected);\n+  }));\n+}\n+\n+{\n+  // Make sure we can free WASM memory originating from a thread that already\n+  // stopped when we exit.\n+  const worker = new Worker(`\n+  const { parentPort } = require('worker_threads');\n+  const wasmSource = new Uint8Array([${wasmSource.join(',')}]);\n+  const wasmModule = new WebAssembly.Module(wasmSource);\n+  const instance = new WebAssembly.Instance(wasmModule);\n+  parentPort.postMessage(instance.exports.memory);\n+  `, { eval: true });\n+  worker.once('message', common.mustCall(({ buffer }) => {\n+    assert(buffer instanceof SharedArrayBuffer);\n+    worker.buf = buffer; // Basically just keep the reference to buffer alive.\n+  }));\n+  worker.once('exit', common.mustCall());\n+  worker.postMessage({ wasmModule });\n+}"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 62,
        "deletions": 9
    }
}