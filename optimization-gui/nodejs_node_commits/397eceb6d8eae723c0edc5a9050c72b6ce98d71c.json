{
    "author": "gireeshpunathil",
    "message": "test: fix worker send error\n\nIn test-child-process-fork-closed-channel-segfault.js, race condition\nis observed between the server getting closed and the worker sending\na message. Accommodate the potential errors.\n\nEarlier, the same race was observed between the client and server\nand was addressed through ignoring the relevant errors through error\nhandler. The same mechanism is re-used for worker too.\n\nThe only difference is that the filter is applied at the callback\ninstead of at the worker's error listener.\n\nRefs: https://github.com/nodejs/node/issues/3635#issuecomment-157714683\nFixes: https://github.com/nodejs/node/issues/20836\nPR-URL: https://github.com/nodejs/node/pull/20973\n\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Jon Moss <me@jonathanmoss.me>\nReviewed-By: Matheus Marchini <matheus@sthima.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Bartosz Sosnowski <bartosz@janeasystems.com>",
    "sha": "397eceb6d8eae723c0edc5a9050c72b6ce98d71c",
    "files": [
        {
            "sha": "c24a62379bf66ed5229b7fc885f1804a140227de",
            "filename": "test/parallel/test-child-process-fork-closed-channel-segfault.js",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/397eceb6d8eae723c0edc5a9050c72b6ce98d71c/test%2Fparallel%2Ftest-child-process-fork-closed-channel-segfault.js",
            "raw_url": "https://github.com/nodejs/node/raw/397eceb6d8eae723c0edc5a9050c72b6ce98d71c/test%2Fparallel%2Ftest-child-process-fork-closed-channel-segfault.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-child-process-fork-closed-channel-segfault.js?ref=397eceb6d8eae723c0edc5a9050c72b6ce98d71c",
            "patch": "@@ -31,6 +31,16 @@ const server = net\n   .listen(0, function() {\n     const worker = cluster.fork();\n \n+    worker.on('error', function(err) {\n+      if (\n+        err.code !== 'ECONNRESET' &&\n+        err.code !== 'ECONNREFUSED' &&\n+        err.code !== 'EMFILE'\n+      ) {\n+        throw err;\n+      }\n+    });\n+\n     function send(callback) {\n       const s = net.connect(server.address().port, function() {\n         worker.send({}, s, callback);\n@@ -66,7 +76,10 @@ const server = net\n         send(function(err) {\n           // Ignore errors when sending the second handle because the worker\n           // may already have exited.\n-          if (err && err.code !== 'ERR_IPC_CHANNEL_CLOSED') {\n+          if (err && err.code !== 'ERR_IPC_CHANNEL_CLOSED' &&\n+                     err.code !== 'ECONNRESET' &&\n+                     err.code !== 'ECONNREFUSED' &&\n+                     err.code !== 'EMFILE') {\n             throw err;\n           }\n         });"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 14,
        "deletions": 1
    }
}