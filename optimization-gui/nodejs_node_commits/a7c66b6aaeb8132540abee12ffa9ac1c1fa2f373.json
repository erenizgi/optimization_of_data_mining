{
    "author": "Fishrock123",
    "message": "timers: truncate decimal values\n\nReverts some timers behavior back to as it was before\n2930bd1317d15d12738a4896c0a6c05700411b47\n\nThat commit introduced an unintended change which allowed non-integer\ntimeouts to actually exist since the value is no longer converted to an\ninteger via a TimeWrap handle directly.\n\nEven with the fix in\ne9de43549843da9f4f081cce917945878967df7\nnon-integer timeouts are still indeterministic, because libuv does not\nsupport them.\n\nThis fixes the issue by emulating the old behavior:\ntruncate the `_idleTimeout` before using it.\n\nSee comments in\nhttps://github.com/nodejs/node/pull/24214\nfor more background on this.\n\nPR-URL: https://github.com/nodejs/node/pull/24819\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "a7c66b6aaeb8132540abee12ffa9ac1c1fa2f373",
    "files": [
        {
            "sha": "9460028928bba1b1a801d7c515cc2743ea502d6a",
            "filename": "doc/api/timers.md",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/a7c66b6aaeb8132540abee12ffa9ac1c1fa2f373/doc%2Fapi%2Ftimers.md",
            "raw_url": "https://github.com/nodejs/node/raw/a7c66b6aaeb8132540abee12ffa9ac1c1fa2f373/doc%2Fapi%2Ftimers.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftimers.md?ref=a7c66b6aaeb8132540abee12ffa9ac1c1fa2f373",
            "patch": "@@ -186,7 +186,7 @@ added: v0.0.1\n Schedules repeated execution of `callback` every `delay` milliseconds.\n \n When `delay` is larger than `2147483647` or less than `1`, the `delay` will be\n-set to `1`.\n+set to `1`. Non-integer delays are truncated to an integer.\n \n If `callback` is not a function, a [`TypeError`][] will be thrown.\n \n@@ -209,7 +209,7 @@ nor of their ordering. The callback will be called as close as possible to the\n time specified.\n \n When `delay` is larger than `2147483647` or less than `1`, the `delay`\n-will be set to `1`.\n+will be set to `1`. Non-integer delays are truncated to an integer.\n \n If `callback` is not a function, a [`TypeError`][] will be thrown.\n "
        },
        {
            "sha": "14151d6d81d63e8cf4e67e43426cf8aa65f5979f",
            "filename": "lib/timers.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/a7c66b6aaeb8132540abee12ffa9ac1c1fa2f373/lib%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/a7c66b6aaeb8132540abee12ffa9ac1c1fa2f373/lib%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftimers.js?ref=a7c66b6aaeb8132540abee12ffa9ac1c1fa2f373",
            "patch": "@@ -193,10 +193,13 @@ exports._unrefActive = function(item) {\n // Appends a timer onto the end of an existing timers list, or creates a new\n // list if one does not already exist for the specified timeout duration.\n function insert(item, refed, start) {\n-  const msecs = item._idleTimeout;\n+  let msecs = item._idleTimeout;\n   if (msecs < 0 || msecs === undefined)\n     return;\n \n+  // Truncate so that accuracy of sub-milisecond timers is not assumed.\n+  msecs = Math.trunc(msecs);\n+\n   item._idleStart = start;\n \n   // Use an existing list if there is one, otherwise we need to make a new one.\n@@ -378,7 +381,9 @@ function unenroll(item) {\n   // clearTimeout that makes it clear that the list should not be deleted.\n   // That function could then be used by http and other similar modules.\n   if (item[kRefed]) {\n-    const list = lists[item._idleTimeout];\n+    // Compliment truncation during insert().\n+    const msecs = Math.trunc(item._idleTimeout);\n+    const list = lists[msecs];\n     if (list !== undefined && L.isEmpty(list)) {\n       debug('unenroll: list empty');\n       queue.removeAt(list.priorityQueuePosition);"
        },
        {
            "sha": "a57922e3c78fe3191bcb5456615ef1a410211ebe",
            "filename": "test/parallel/test-timers-non-integer-delay.js",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/a7c66b6aaeb8132540abee12ffa9ac1c1fa2f373/test%2Fparallel%2Ftest-timers-non-integer-delay.js",
            "raw_url": "https://github.com/nodejs/node/raw/a7c66b6aaeb8132540abee12ffa9ac1c1fa2f373/test%2Fparallel%2Ftest-timers-non-integer-delay.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-timers-non-integer-delay.js?ref=a7c66b6aaeb8132540abee12ffa9ac1c1fa2f373",
            "patch": "@@ -21,6 +21,7 @@\n \n 'use strict';\n const common = require('../common');\n+const assert = require('assert');\n \n /*\n  * This test makes sure that non-integer timer delays do not make the process\n@@ -47,3 +48,37 @@ const interval = setInterval(common.mustCall(() => {\n     process.exit(0);\n   }\n }, N), TIMEOUT_DELAY);\n+\n+// Test non-integer delay ordering\n+{\n+  const ordering = [];\n+\n+  setTimeout(common.mustCall(() => {\n+    ordering.push(1);\n+  }), 1);\n+\n+  setTimeout(common.mustCall(() => {\n+    ordering.push(2);\n+  }), 1.8);\n+\n+  setTimeout(common.mustCall(() => {\n+    ordering.push(3);\n+  }), 1.1);\n+\n+  setTimeout(common.mustCall(() => {\n+    ordering.push(4);\n+  }), 1);\n+\n+  setTimeout(common.mustCall(() => {\n+    const expected = [1, 2, 3, 4];\n+\n+    assert.deepStrictEqual(\n+      ordering,\n+      expected,\n+      `Non-integer delay ordering should be ${expected}, but got ${ordering}`\n+    );\n+\n+    // 2 should always be last of these delays due to ordering guarentees by\n+    // the implementation.\n+  }), 2);\n+}"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 44,
        "deletions": 4
    }
}