{
    "author": "sam-github",
    "message": "test: do not assume server gets secure connection\n\nTest assumed that server got the the connection before the client\ndestroys it, but that is not guaranteed. Also, the test was closing the\nTCP connection 3 times, effectively:\n\n1. on the server side, right after TLS connection occurs (if it does)\n2. on the client side, internal to tls, when the cert is rejected\n3. again on the client side, in the error event which is emitted by\n   the internal tls destroy from 2\n\nThis is too often, and the dependency on 1 occurring is fragile.\n\nPR-URL: https://github.com/nodejs/node/pull/25508\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "8bc39e7286526dfc1b7edf5861f9c4c6f6146721",
    "files": [
        {
            "sha": "4ae9d3f3f956d428eeb0f3595ffe2c38eca8e93b",
            "filename": "test/parallel/test-tls-friendly-error-message.js",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/8bc39e7286526dfc1b7edf5861f9c4c6f6146721/test%2Fparallel%2Ftest-tls-friendly-error-message.js",
            "raw_url": "https://github.com/nodejs/node/raw/8bc39e7286526dfc1b7edf5861f9c4c6f6146721/test%2Fparallel%2Ftest-tls-friendly-error-message.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-friendly-error-message.js?ref=8bc39e7286526dfc1b7edf5861f9c4c6f6146721",
            "patch": "@@ -31,14 +31,15 @@ const tls = require('tls');\n const key = fixtures.readKey('agent1-key.pem');\n const cert = fixtures.readKey('agent1-cert.pem');\n \n-tls.createServer({ key, cert }, common.mustCall(function(conn) {\n-  conn.end();\n+tls.createServer({ key, cert }).on('connection', common.mustCall(function() {\n+  // Server only receives one TCP connection, stop listening when that\n+  // connection is destroyed by the client, which it should do after the cert is\n+  // rejected as unauthorized.\n   this.close();\n })).listen(0, common.mustCall(function() {\n   const options = { port: this.address().port, rejectUnauthorized: true };\n   tls.connect(options).on('error', common.mustCall(function(err) {\n     assert.strictEqual(err.code, 'UNABLE_TO_VERIFY_LEAF_SIGNATURE');\n     assert.strictEqual(err.message, 'unable to verify the first certificate');\n-    this.destroy();\n   }));\n }));"
        }
    ],
    "stats": {
        "total": 7,
        "additions": 4,
        "deletions": 3
    }
}