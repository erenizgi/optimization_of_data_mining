{
    "author": "Trott",
    "message": "test: add test-benchmark-http2\n\nPR-URL: https://github.com/nodejs/node/pull/23863\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "2812759f9352e2d180aeea8c1999dd2c6ab36371",
    "files": [
        {
            "sha": "baa50f72cde906079ab6d8a147cba6cc677f5f17",
            "filename": "benchmark/_http-benchmarkers.js",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/2812759f9352e2d180aeea8c1999dd2c6ab36371/benchmark%2F_http-benchmarkers.js",
            "raw_url": "https://github.com/nodejs/node/raw/2812759f9352e2d180aeea8c1999dd2c6ab36371/benchmark%2F_http-benchmarkers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2F_http-benchmarkers.js?ref=2812759f9352e2d180aeea8c1999dd2c6ab36371",
            "patch": "@@ -82,10 +82,12 @@ class WrkBenchmarker {\n  * works\n  */\n class TestDoubleBenchmarker {\n-  constructor() {\n-    this.name = 'test-double';\n+  constructor(type) {\n+    // `type` is the type ofbenchmarker. Possible values are 'http' and 'http2'.\n+    this.name = `test-double-${type}`;\n     this.executable = path.resolve(__dirname, '_test-double-benchmarker.js');\n     this.present = fs.existsSync(this.executable);\n+    this.type = type;\n   }\n \n   create(options) {\n@@ -94,10 +96,9 @@ class TestDoubleBenchmarker {\n       test_url: `http://127.0.0.1:${options.port}${options.path}`,\n     }, process.env);\n \n-    const child = child_process.fork(this.executable, {\n-      silent: true,\n-      env\n-    });\n+    const child = child_process.fork(this.executable,\n+                                     [this.type],\n+                                     { silent: true, env });\n     return child;\n   }\n \n@@ -167,7 +168,8 @@ class H2LoadBenchmarker {\n const http_benchmarkers = [\n   new WrkBenchmarker(),\n   new AutocannonBenchmarker(),\n-  new TestDoubleBenchmarker(),\n+  new TestDoubleBenchmarker('http'),\n+  new TestDoubleBenchmarker('http2'),\n   new H2LoadBenchmarker()\n ];\n "
        },
        {
            "sha": "b9379b907ffa07957c8c0a57f6d597f5c19cec0c",
            "filename": "benchmark/_test-double-benchmarker.js",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/2812759f9352e2d180aeea8c1999dd2c6ab36371/benchmark%2F_test-double-benchmarker.js",
            "raw_url": "https://github.com/nodejs/node/raw/2812759f9352e2d180aeea8c1999dd2c6ab36371/benchmark%2F_test-double-benchmarker.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2F_test-double-benchmarker.js?ref=2812759f9352e2d180aeea8c1999dd2c6ab36371",
            "patch": "@@ -1,15 +1,20 @@\n 'use strict';\n \n-const http = require('http');\n+const myModule = process.argv[2];\n+if (!['http', 'http2'].includes(myModule)) {\n+  throw new Error(`Invalid module for benchmark test double: ${myModule}`);\n+}\n+\n+const http = require(myModule);\n \n const duration = process.env.duration || 0;\n const url = process.env.test_url;\n \n const start = process.hrtime();\n let throughput = 0;\n \n-function request(res) {\n-  res.on('data', () => {});\n+function request(res, client) {\n+  res.resume();\n   res.on('error', () => {});\n   res.on('end', () => {\n     throughput++;\n@@ -18,12 +23,21 @@ function request(res) {\n       run();\n     } else {\n       console.log(JSON.stringify({ throughput }));\n+      if (client) {\n+        client.destroy();\n+      }\n     }\n   });\n }\n \n function run() {\n-  http.get(url, request);\n+  if (http.get) { // HTTP\n+    http.get(url, request);\n+  } else {        // HTTP/2\n+    const client = http.connect(url);\n+    client.on('error', (e) => { throw e; });\n+    request(client.request(), client);\n+  }\n }\n \n run();"
        },
        {
            "sha": "e2fad2ea02a0ee2974b7fe971df4b964a53d4fa6",
            "filename": "benchmark/http2/headers.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/2812759f9352e2d180aeea8c1999dd2c6ab36371/benchmark%2Fhttp2%2Fheaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/2812759f9352e2d180aeea8c1999dd2c6ab36371/benchmark%2Fhttp2%2Fheaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fhttp2%2Fheaders.js?ref=2812759f9352e2d180aeea8c1999dd2c6ab36371",
            "patch": "@@ -5,8 +5,7 @@ const PORT = common.PORT;\n \n const bench = common.createBenchmark(main, {\n   n: [1e3],\n-  nheaders: [0, 10, 100, 1000],\n-  benchmarker: ['h2load']\n+  nheaders: [0, 10, 100, 1000]\n }, { flags: ['--no-warnings'] });\n \n function main({ n, nheaders }) {"
        },
        {
            "sha": "7255e655c094e628b62ba23c4bde46fd314ab657",
            "filename": "test/sequential/test-benchmark-http.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/2812759f9352e2d180aeea8c1999dd2c6ab36371/test%2Fsequential%2Ftest-benchmark-http.js",
            "raw_url": "https://github.com/nodejs/node/raw/2812759f9352e2d180aeea8c1999dd2c6ab36371/test%2Fsequential%2Ftest-benchmark-http.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-benchmark-http.js?ref=2812759f9352e2d180aeea8c1999dd2c6ab36371",
            "patch": "@@ -13,7 +13,7 @@ const runBenchmark = require('../common/benchmark');\n \n runBenchmark('http',\n              [\n-               'benchmarker=test-double',\n+               'benchmarker=test-double-http',\n                'c=1',\n                'chunkedEnc=true',\n                'chunks=0',"
        },
        {
            "sha": "0abe490973b38da35eb95e994b34809d512ef64c",
            "filename": "test/sequential/test-benchmark-http2.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/2812759f9352e2d180aeea8c1999dd2c6ab36371/test%2Fsequential%2Ftest-benchmark-http2.js",
            "raw_url": "https://github.com/nodejs/node/raw/2812759f9352e2d180aeea8c1999dd2c6ab36371/test%2Fsequential%2Ftest-benchmark-http2.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-benchmark-http2.js?ref=2812759f9352e2d180aeea8c1999dd2c6ab36371",
            "patch": "@@ -0,0 +1,27 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+if (!common.enoughTestMem)\n+  common.skip('Insufficient memory for HTTP/2 benchmark test');\n+\n+// Because the http benchmarks use hardcoded ports, this should be in sequential\n+// rather than parallel to make sure it does not conflict with tests that choose\n+// random available ports.\n+\n+const runBenchmark = require('../common/benchmark');\n+\n+runBenchmark('http2',\n+             [\n+               'benchmarker=test-double-http2',\n+               'clients=1',\n+               'length=65536',\n+               'n=1',\n+               'nheaders=0',\n+               'requests=1',\n+               'streams=1'\n+             ],\n+             {\n+               NODEJS_BENCHMARK_ZERO_ALLOWED: 1,\n+               duration: 0\n+             });"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 56,
        "deletions": 14
    }
}