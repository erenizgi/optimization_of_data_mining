{
    "author": "addaleax",
    "message": "src: add convenience ctor for async trigger id scope\n\nPR-URL: https://github.com/nodejs/node/pull/19204\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "d3f174faab55662226ced53bef6bb2040352a825",
    "files": [
        {
            "sha": "21b1f9cee9f0e8c45e576a783059d38550b9faac",
            "filename": "src/async_wrap-inl.h",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/d3f174faab55662226ced53bef6bb2040352a825/src%2Fasync_wrap-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/d3f174faab55662226ced53bef6bb2040352a825/src%2Fasync_wrap-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap-inl.h?ref=d3f174faab55662226ced53bef6bb2040352a825",
            "patch": "@@ -64,6 +64,13 @@ inline v8::MaybeLocal<v8::Value> AsyncWrap::MakeCallback(\n   return MakeCallback(cb_v.As<v8::Function>(), argc, argv);\n }\n \n+\n+// Defined here to avoid a circular dependency with env-inl.h.\n+inline Environment::AsyncHooks::DefaultTriggerAsyncIdScope\n+  ::DefaultTriggerAsyncIdScope(AsyncWrap* async_wrap)\n+    : DefaultTriggerAsyncIdScope(async_wrap->env(),\n+                                 async_wrap->get_async_id()) {}\n+\n }  // namespace node\n \n #endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS"
        },
        {
            "sha": "b6776364a5301fc64eaa7832ba0308dac273f2b5",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d3f174faab55662226ced53bef6bb2040352a825/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d3f174faab55662226ced53bef6bb2040352a825/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=d3f174faab55662226ced53bef6bb2040352a825",
            "patch": "@@ -312,8 +312,7 @@ static void PromiseHook(PromiseHookType type, Local<Promise> promise,\n         parent_wrap = PromiseWrap::New(env, parent_promise, nullptr, true);\n       }\n \n-      AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(\n-        env, parent_wrap->get_async_id());\n+      AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(parent_wrap);\n       wrap = PromiseWrap::New(env, promise, parent_wrap, silent);\n     } else {\n       wrap = PromiseWrap::New(env, promise, nullptr, silent);"
        },
        {
            "sha": "31f2af402417dc84ac75b6b7c10467d14a6312d3",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d3f174faab55662226ced53bef6bb2040352a825/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/d3f174faab55662226ced53bef6bb2040352a825/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=d3f174faab55662226ced53bef6bb2040352a825",
            "patch": "@@ -179,6 +179,9 @@ inline void Environment::AsyncHooks::clear_async_id_stack() {\n   fields_[kStackLength] = 0;\n }\n \n+// The DefaultTriggerAsyncIdScope(AsyncWrap*) constructor is defined in\n+// async_wrap-inl.h to avoid a circular dependency.\n+\n inline Environment::AsyncHooks::DefaultTriggerAsyncIdScope\n   ::DefaultTriggerAsyncIdScope(Environment* env,\n                                double default_trigger_async_id)"
        },
        {
            "sha": "e6060b9e6faab928ec4fc1520cd468d02415a6f8",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/d3f174faab55662226ced53bef6bb2040352a825/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/d3f174faab55662226ced53bef6bb2040352a825/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=d3f174faab55662226ced53bef6bb2040352a825",
            "patch": "@@ -431,6 +431,7 @@ class Environment {\n       DefaultTriggerAsyncIdScope() = delete;\n       explicit DefaultTriggerAsyncIdScope(Environment* env,\n                                           double init_trigger_async_id);\n+      explicit DefaultTriggerAsyncIdScope(AsyncWrap* async_wrap);\n       ~DefaultTriggerAsyncIdScope();\n \n      private:"
        },
        {
            "sha": "14ac671b92b5bbc641241f0cfcdfc37a9e031fc8",
            "filename": "src/pipe_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/d3f174faab55662226ced53bef6bb2040352a825/src%2Fpipe_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d3f174faab55662226ced53bef6bb2040352a825/src%2Fpipe_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fpipe_wrap.cc?ref=d3f174faab55662226ced53bef6bb2040352a825",
            "patch": "@@ -54,8 +54,7 @@ Local<Object> PipeWrap::Instantiate(Environment* env,\n                                     AsyncWrap* parent,\n                                     PipeWrap::SocketType type) {\n   EscapableHandleScope handle_scope(env->isolate());\n-  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(env,\n-                                                       parent->get_async_id());\n+  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(parent);\n   CHECK_EQ(false, env->pipe_constructor_template().IsEmpty());\n   Local<Function> constructor = env->pipe_constructor_template()->GetFunction();\n   CHECK_EQ(false, constructor.IsEmpty());"
        },
        {
            "sha": "1534dcd1d5335996390bc7a72c67dc89e68d4e0f",
            "filename": "src/stream_base-inl.h",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/d3f174faab55662226ced53bef6bb2040352a825/src%2Fstream_base-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/d3f174faab55662226ced53bef6bb2040352a825/src%2Fstream_base-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base-inl.h?ref=d3f174faab55662226ced53bef6bb2040352a825",
            "patch": "@@ -164,8 +164,7 @@ inline int StreamBase::Shutdown(v8::Local<v8::Object> req_wrap_obj) {\n             ->NewInstance(env->context()).ToLocalChecked();\n   }\n \n-  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(\n-      env, GetAsyncWrap()->get_async_id());\n+  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(GetAsyncWrap());\n   ShutdownWrap* req_wrap = CreateShutdownWrap(req_wrap_obj);\n   int err = DoShutdown(req_wrap);\n \n@@ -202,8 +201,7 @@ inline StreamWriteResult StreamBase::Write(\n             ->NewInstance(env->context()).ToLocalChecked();\n   }\n \n-  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(\n-      env, GetAsyncWrap()->get_async_id());\n+  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(GetAsyncWrap());\n   WriteWrap* req_wrap = CreateWriteWrap(req_wrap_obj);\n \n   err = DoWrite(req_wrap, bufs, count, send_handle);\n@@ -383,8 +381,7 @@ void StreamBase::JSMethod(const FunctionCallbackInfo<Value>& args) {\n   if (!wrap->IsAlive())\n     return args.GetReturnValue().Set(UV_EINVAL);\n \n-  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(\n-    handle->env(), handle->get_async_id());\n+  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(handle);\n   args.GetReturnValue().Set((wrap->*Method)(args));\n }\n "
        },
        {
            "sha": "cd6ed3cef0a5bf611dbe69607df5f3221a15bb60",
            "filename": "src/tcp_wrap.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/d3f174faab55662226ced53bef6bb2040352a825/src%2Ftcp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d3f174faab55662226ced53bef6bb2040352a825/src%2Ftcp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.cc?ref=d3f174faab55662226ced53bef6bb2040352a825",
            "patch": "@@ -57,8 +57,7 @@ Local<Object> TCPWrap::Instantiate(Environment* env,\n                                    AsyncWrap* parent,\n                                    TCPWrap::SocketType type) {\n   EscapableHandleScope handle_scope(env->isolate());\n-  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(\n-    env, parent->get_async_id());\n+  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(parent);\n   CHECK_EQ(env->tcp_constructor_template().IsEmpty(), false);\n   Local<Function> constructor = env->tcp_constructor_template()->GetFunction();\n   CHECK_EQ(constructor.IsEmpty(), false);\n@@ -289,8 +288,7 @@ void TCPWrap::Connect(const FunctionCallbackInfo<Value>& args) {\n   int err = uv_ip4_addr(*ip_address, port, &addr);\n \n   if (err == 0) {\n-    AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(\n-      env, wrap->get_async_id());\n+    AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(wrap);\n     ConnectWrap* req_wrap =\n         new ConnectWrap(env, req_wrap_obj, AsyncWrap::PROVIDER_TCPCONNECTWRAP);\n     err = uv_tcp_connect(req_wrap->req(),\n@@ -326,8 +324,7 @@ void TCPWrap::Connect6(const FunctionCallbackInfo<Value>& args) {\n   int err = uv_ip6_addr(*ip_address, port, &addr);\n \n   if (err == 0) {\n-    AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(\n-      env, wrap->get_async_id());\n+    AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(wrap);\n     ConnectWrap* req_wrap =\n         new ConnectWrap(env, req_wrap_obj, AsyncWrap::PROVIDER_TCPCONNECTWRAP);\n     err = uv_tcp_connect(req_wrap->req(),"
        },
        {
            "sha": "e7d97dc484250c42fbc1e15f24464d1fab39fbce",
            "filename": "src/udp_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/d3f174faab55662226ced53bef6bb2040352a825/src%2Fudp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/d3f174faab55662226ced53bef6bb2040352a825/src%2Fudp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fudp_wrap.cc?ref=d3f174faab55662226ced53bef6bb2040352a825",
            "patch": "@@ -359,8 +359,7 @@ void UDPWrap::DoSend(const FunctionCallbackInfo<Value>& args, int family) {\n \n   SendWrap* req_wrap;\n   {\n-    AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(\n-      env, wrap->get_async_id());\n+    AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(wrap);\n     req_wrap = new SendWrap(env, req_wrap_obj, have_callback);\n   }\n   size_t msg_size = 0;\n@@ -511,8 +510,7 @@ Local<Object> UDPWrap::Instantiate(Environment* env,\n                                    AsyncWrap* parent,\n                                    UDPWrap::SocketType type) {\n   EscapableHandleScope scope(env->isolate());\n-  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(\n-    env, parent->get_async_id());\n+  AsyncHooks::DefaultTriggerAsyncIdScope trigger_scope(parent);\n \n   // If this assert fires then Initialize hasn't been called yet.\n   CHECK_EQ(env->udp_constructor_function().IsEmpty(), false);"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 21,
        "deletions": 20
    }
}