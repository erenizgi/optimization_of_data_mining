{
    "author": "apapirovski",
    "message": "src: store pointer to Environment on DestroyParam\n\nTo avoid a potential segfault when inside WeakCallback, store a\nreference to Environment inside DestroyParam.\n\nPR-URL: https://github.com/nodejs/node/pull/21099\nReviewed-By: Yang Guo <yangguo@chromium.org>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\n\nCo-authored-by: Yang Guo <yangguo@chromium.org>\nCo-authored-by: MichaÃ«l Zasso <targos@protonmail.com>",
    "sha": "0300f7c68cffa5de7f0099e3afa95093b0bbbe3c",
    "files": [
        {
            "sha": "87c50950faadccbc9ce1880c70ee0253d0ae4290",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/0300f7c68cffa5de7f0099e3afa95093b0bbbe3c/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/0300f7c68cffa5de7f0099e3afa95093b0bbbe3c/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=0300f7c68cffa5de7f0099e3afa95093b0bbbe3c",
            "patch": "@@ -398,6 +398,7 @@ static void DisablePromiseHook(const FunctionCallbackInfo<Value>& args) {\n class DestroyParam {\n  public:\n   double asyncId;\n+  Environment* env;\n   Persistent<Object> target;\n   Persistent<Object> propBag;\n };\n@@ -406,13 +407,12 @@ class DestroyParam {\n void AsyncWrap::WeakCallback(const v8::WeakCallbackInfo<DestroyParam>& info) {\n   HandleScope scope(info.GetIsolate());\n \n-  Environment* env = Environment::GetCurrent(info.GetIsolate());\n   std::unique_ptr<DestroyParam> p{info.GetParameter()};\n   Local<Object> prop_bag = PersistentToLocal(info.GetIsolate(), p->propBag);\n \n-  Local<Value> val = prop_bag->Get(env->destroyed_string());\n+  Local<Value> val = prop_bag->Get(p->env->destroyed_string());\n   if (val->IsFalse()) {\n-    AsyncWrap::EmitDestroy(env, p->asyncId);\n+    AsyncWrap::EmitDestroy(p->env, p->asyncId);\n   }\n   // unique_ptr goes out of scope here and pointer is deleted.\n }\n@@ -426,6 +426,7 @@ static void RegisterDestroyHook(const FunctionCallbackInfo<Value>& args) {\n   Isolate* isolate = args.GetIsolate();\n   DestroyParam* p = new DestroyParam();\n   p->asyncId = args[1].As<Number>()->Value();\n+  p->env = Environment::GetCurrent(args);\n   p->target.Reset(isolate, args[0].As<Object>());\n   p->propBag.Reset(isolate, args[2].As<Object>());\n   p->target.SetWeak("
        }
    ],
    "stats": {
        "total": 7,
        "additions": 4,
        "deletions": 3
    }
}