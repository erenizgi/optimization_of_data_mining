{
    "author": "mcollina",
    "message": "http2: fixes error handling\n\nThere should be no default error handling when using Http2Stream.\nAll errors will end up in `'streamError'` on the server anyway,\nbut they are emitted on `'stream'` as well, otherwise some error\nconditions are impossible to debug.\n\nSee: https://github.com/nodejs/node/pull/14991\n\nPR-URL: https://github.com/nodejs/node/pull/19232\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c",
    "files": [
        {
            "sha": "2a4ef0421f7c849dedcdf97d581f71107594a1c7",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c",
            "patch": "@@ -2073,19 +2073,12 @@ function afterOpen(session, options, headers, streamOptions, err, fd) {\n                              headers, streamOptions));\n }\n \n-function streamOnError(err) {\n-  // we swallow the error for parity with HTTP1\n-  // all the errors that ends here are not critical for the project\n-}\n-\n-\n class ServerHttp2Stream extends Http2Stream {\n   constructor(session, handle, id, options, headers) {\n     super(session, options);\n     this[kInit](id, handle);\n     this[kProtocol] = headers[HTTP2_HEADER_SCHEME];\n     this[kAuthority] = headers[HTTP2_HEADER_AUTHORITY];\n-    this.on('error', streamOnError);\n   }\n \n   // true if the remote peer accepts push streams"
        },
        {
            "sha": "4f59396e6acf3ee5b751a9c5df016be38e254da6",
            "filename": "test/parallel/test-http2-misbehaving-multiplex.js",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/test%2Fparallel%2Ftest-http2-misbehaving-multiplex.js",
            "raw_url": "https://github.com/nodejs/node/raw/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/test%2Fparallel%2Ftest-http2-misbehaving-multiplex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-misbehaving-multiplex.js?ref=8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c",
            "patch": "@@ -16,7 +16,15 @@ const server = h2.createServer();\n server.on('stream', common.mustCall((stream) => {\n   stream.respond();\n   stream.end('ok');\n+\n+  // the error will be emitted asynchronously\n+  stream.on('error', common.expectsError({\n+    type: NghttpError,\n+    code: 'ERR_HTTP2_ERROR',\n+    message: 'Stream was already closed or invalid'\n+  }));\n }, 2));\n+\n server.on('session', common.mustCall((session) => {\n   session.on('error', common.expectsError({\n     code: 'ERR_HTTP2_ERROR',"
        },
        {
            "sha": "bbdf312fc153d494e3a6f98c7086a5b6d82d06a1",
            "filename": "test/parallel/test-http2-server-errors.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/test%2Fparallel%2Ftest-http2-server-errors.js",
            "raw_url": "https://github.com/nodejs/node/raw/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/test%2Fparallel%2Ftest-http2-server-errors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-errors.js?ref=8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c",
            "patch": "@@ -54,12 +54,16 @@ const h2 = require('http2');\n \n   const server = h2.createServer();\n \n+  process.on('uncaughtException', common.mustCall(function(err) {\n+    assert.strictEqual(err.message, 'kaboom no handler');\n+  }));\n+\n   server.on('stream', common.mustCall(function(stream) {\n-    // there is no 'error'  handler, and this will not crash\n+    // there is no 'error'  handler, and this will crash\n     stream.write('hello');\n     stream.resume();\n \n-    expected = new Error('kaboom');\n+    expected = new Error('kaboom no handler');\n     stream.destroy(expected);\n     server.close();\n   }));"
        },
        {
            "sha": "35e22c0ce3b56125d63e63b7236b220665e70227",
            "filename": "test/parallel/test-http2-server-push-stream-head.js",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/test%2Fparallel%2Ftest-http2-server-push-stream-head.js",
            "raw_url": "https://github.com/nodejs/node/raw/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/test%2Fparallel%2Ftest-http2-server-push-stream-head.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-push-stream-head.js?ref=8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c",
            "patch": "@@ -21,6 +21,12 @@ server.on('stream', common.mustCall((stream, headers) => {\n     }, common.mustCall((err, push, headers) => {\n       assert.strictEqual(push._writableState.ended, true);\n       push.respond();\n+      // cannot write to push() anymore\n+      push.on('error', common.expectsError({\n+        type: Error,\n+        code: 'ERR_STREAM_WRITE_AFTER_END',\n+        message: 'write after end'\n+      }));\n       assert(!push.write('test'));\n       stream.end('test');\n     }));"
        },
        {
            "sha": "402ff07fa9d0a0a4b9542feb75d416508d28c456",
            "filename": "test/parallel/test-http2-server-rst-stream.js",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/test%2Fparallel%2Ftest-http2-server-rst-stream.js",
            "raw_url": "https://github.com/nodejs/node/raw/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/test%2Fparallel%2Ftest-http2-server-rst-stream.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-rst-stream.js?ref=8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c",
            "patch": "@@ -18,14 +18,22 @@ const {\n const tests = [\n   [NGHTTP2_NO_ERROR, false],\n   [NGHTTP2_NO_ERROR, false],\n-  [NGHTTP2_PROTOCOL_ERROR, true],\n+  [NGHTTP2_PROTOCOL_ERROR, true, 'NGHTTP2_PROTOCOL_ERROR'],\n   [NGHTTP2_CANCEL, false],\n-  [NGHTTP2_REFUSED_STREAM, true],\n-  [NGHTTP2_INTERNAL_ERROR, true]\n+  [NGHTTP2_REFUSED_STREAM, true, 'NGHTTP2_REFUSED_STREAM'],\n+  [NGHTTP2_INTERNAL_ERROR, true, 'NGHTTP2_INTERNAL_ERROR']\n ];\n \n const server = http2.createServer();\n server.on('stream', (stream, headers) => {\n+  const test = tests.find((t) => t[0] === Number(headers.rstcode));\n+  if (test[1]) {\n+    stream.on('error', common.expectsError({\n+      type: Error,\n+      code: 'ERR_HTTP2_STREAM_ERROR',\n+      message: `Stream closed with error code ${test[2]}`\n+    }));\n+  }\n   stream.close(headers.rstcode | 0);\n });\n "
        },
        {
            "sha": "989c72ec959679ab6f835bcc273af41c0297a779",
            "filename": "test/parallel/test-http2-server-stream-session-destroy.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/test%2Fparallel%2Ftest-http2-server-stream-session-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c/test%2Fparallel%2Ftest-http2-server-stream-session-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-server-stream-session-destroy.js?ref=8403f00dc3e8f1c3c5cae4c4aec2eb10733cc15c",
            "patch": "@@ -34,6 +34,11 @@ server.on('stream', common.mustCall((stream) => {\n       type: Error\n     }\n   );\n+  stream.on('error', common.expectsError({\n+    type: Error,\n+    code: 'ERR_STREAM_WRITE_AFTER_END',\n+    message: 'write after end'\n+  }));\n   assert.strictEqual(stream.write('data'), false);\n }));\n "
        }
    ],
    "stats": {
        "total": 48,
        "additions": 36,
        "deletions": 12
    }
}