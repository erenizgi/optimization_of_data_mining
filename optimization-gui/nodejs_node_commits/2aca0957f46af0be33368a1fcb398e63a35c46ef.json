{
    "author": "ide",
    "message": "http2: release request()'s \"connect\" event listener after it runs\n\nThe `Http2Session#request()` method internally listens to the \"connect\"\nevent if the session has not yet established a connection so that the\nactual request can be sent after the connection has been established.\n\nThis commit removes the event listener after it runs and carries out\nthe request and is no longer needed. In practice this shouldn't affect\nthe behavior of the session object since the \"connect\" event fires only\nonce anyway, but removing the listener releases its references. The\nrest of this class subscribes to the \"connect\" event with `once`\ninstead of `on` as well.\n\nTested by adding a new test that ensures `Http2Session#request()` is\ncalled before the connection is established, indicated by a \"connect\"\nlistener that is run. The test also ensures all \"connect\" listeners are\nremoved after the connection is established.\n\nPR-URL: https://github.com/nodejs/node/pull/21916\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "2aca0957f46af0be33368a1fcb398e63a35c46ef",
    "files": [
        {
            "sha": "18c0c4ce4c1fbdb353b9e3ff3fd49be1d6375e8e",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/2aca0957f46af0be33368a1fcb398e63a35c46ef/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/2aca0957f46af0be33368a1fcb398e63a35c46ef/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=2aca0957f46af0be33368a1fcb398e63a35c46ef",
            "patch": "@@ -1426,7 +1426,7 @@ class ClientHttp2Session extends Http2Session {\n \n     const onConnect = requestOnConnect.bind(stream, headersList, options);\n     if (this.connecting) {\n-      this.on('connect', onConnect);\n+      this.once('connect', onConnect);\n     } else {\n       onConnect();\n     }"
        },
        {
            "sha": "61de140c22514497c723d6e14960ac0cf4ac5201",
            "filename": "test/parallel/test-http2-request-remove-connect-listener.js",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/2aca0957f46af0be33368a1fcb398e63a35c46ef/test%2Fparallel%2Ftest-http2-request-remove-connect-listener.js",
            "raw_url": "https://github.com/nodejs/node/raw/2aca0957f46af0be33368a1fcb398e63a35c46ef/test%2Fparallel%2Ftest-http2-request-remove-connect-listener.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-request-remove-connect-listener.js?ref=2aca0957f46af0be33368a1fcb398e63a35c46ef",
            "patch": "@@ -0,0 +1,28 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const assert = require('assert');\n+const http2 = require('http2');\n+\n+\n+const server = http2.createServer();\n+server.on('stream', common.mustCall((stream) => {\n+  stream.respond();\n+  stream.end();\n+}));\n+\n+server.listen(0, common.mustCall(() => {\n+  const client = http2.connect(`http://localhost:${server.address().port}`);\n+  const req = client.request();\n+  client.once('connect', common.mustCall());\n+\n+  req.on('response', common.mustCall(() => {\n+    assert.strictEqual(client.listenerCount('connect'), 0);\n+  }));\n+  req.on('close', common.mustCall(() => {\n+    server.close();\n+    client.close();\n+  }));\n+}));"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 29,
        "deletions": 1
    }
}