{
    "author": "addaleax",
    "message": "src: clean up agent loop when exiting through destructor\n\nFixes: https://github.com/nodejs/node/issues/22042\n\nPR-URL: https://github.com/nodejs/node/pull/21867\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "281e5a3ceec1a0463d4572a048cff13ea4ade57f",
    "files": [
        {
            "sha": "886243fd5cdb50f7588cd6d3dc0de338e80b2965",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/281e5a3ceec1a0463d4572a048cff13ea4ade57f/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/281e5a3ceec1a0463d4572a048cff13ea4ade57f/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=281e5a3ceec1a0463d4572a048cff13ea4ade57f",
            "patch": "@@ -398,10 +398,10 @@ static struct {\n   }\n \n   void Dispose() {\n+    tracing_agent_.reset(nullptr);\n     platform_->Shutdown();\n     delete platform_;\n     platform_ = nullptr;\n-    tracing_agent_.reset(nullptr);\n   }\n \n   void DrainVMTasks(Isolate* isolate) {"
        },
        {
            "sha": "5a4d637bda0356091b2633e7cbdb493c1d6cf8f6",
            "filename": "src/tracing/agent.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/281e5a3ceec1a0463d4572a048cff13ea4ade57f/src%2Ftracing%2Fagent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/281e5a3ceec1a0463d4572a048cff13ea4ade57f/src%2Ftracing%2Fagent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.cc?ref=281e5a3ceec1a0463d4572a048cff13ea4ade57f",
            "patch": "@@ -59,6 +59,7 @@ Agent::Agent() {\n     Agent* agent = ContainerOf(&Agent::initialize_writer_async_, async);\n     agent->InitializeWritersOnThread();\n   }), 0);\n+  uv_unref(reinterpret_cast<uv_handle_t*>(&initialize_writer_async_));\n }\n \n void Agent::InitializeWritersOnThread() {\n@@ -72,6 +73,11 @@ void Agent::InitializeWritersOnThread() {\n }\n \n Agent::~Agent() {\n+  categories_.clear();\n+  writers_.clear();\n+\n+  StopTracing();\n+\n   uv_close(reinterpret_cast<uv_handle_t*>(&initialize_writer_async_), nullptr);\n   uv_run(&tracing_loop_, UV_RUN_ONCE);\n   CheckedUvLoopClose(&tracing_loop_);"
        }
    ],
    "stats": {
        "total": 8,
        "additions": 7,
        "deletions": 1
    }
}