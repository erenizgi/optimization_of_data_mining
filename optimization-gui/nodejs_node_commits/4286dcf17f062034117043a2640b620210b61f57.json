{
    "author": "addaleax",
    "message": "src: refactor `Environment::GetCurrent()` usage\n\nMake `Environment::GetCurrent()` return `nullptr` if the current\n`Context` is not a Node.js context, and for the relevant usage of\nthis function, either:\n\n- Switch to the better `GetCurrent(args)` variant\n- Turn functions in to no-ops where it makes sense\n- Make it a `CHECK`, i.e. an API requirement, where it make sense\n- Leave a `TODO` comment for verifying what, if anything, is to be done\n\nPR-URL: https://github.com/nodejs/node/pull/22819\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "4286dcf17f062034117043a2640b620210b61f57",
    "files": [
        {
            "sha": "f697679399b76e280c13e3e8f45487ebe5802263",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -687,12 +687,16 @@ MaybeLocal<Value> AsyncWrap::MakeCallback(const Local<Function> cb,\n \n \n async_id AsyncHooksGetExecutionAsyncId(Isolate* isolate) {\n-  return Environment::GetCurrent(isolate)->execution_async_id();\n+  Environment* env = Environment::GetCurrent(isolate);\n+  if (env == nullptr) return -1;\n+  return env->execution_async_id();\n }\n \n \n async_id AsyncHooksGetTriggerAsyncId(Isolate* isolate) {\n-  return Environment::GetCurrent(isolate)->trigger_async_id();\n+  Environment* env = Environment::GetCurrent(isolate);\n+  if (env == nullptr) return -1;\n+  return env->trigger_async_id();\n }\n \n \n@@ -711,6 +715,7 @@ async_context EmitAsyncInit(Isolate* isolate,\n                             v8::Local<v8::String> name,\n                             async_id trigger_async_id) {\n   Environment* env = Environment::GetCurrent(isolate);\n+  CHECK_NOT_NULL(env);\n \n   // Initialize async context struct\n   if (trigger_async_id == -1)"
        },
        {
            "sha": "b9d9218c59c30e613567b006e185e9eaa0970bd5",
            "filename": "src/bootstrapper.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fbootstrapper.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fbootstrapper.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fbootstrapper.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -67,6 +67,7 @@ void PromiseRejectCallback(PromiseRejectMessage message) {\n   PromiseRejectEvent event = message.GetEvent();\n \n   Environment* env = Environment::GetCurrent(isolate);\n+  if (env == nullptr) return;\n   Local<Function> callback;\n   Local<Value> value;\n "
        },
        {
            "sha": "1743d5576682bfe388793e73310849aad772c5ac",
            "filename": "src/callback_scope.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fcallback_scope.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fcallback_scope.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fcallback_scope.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -43,6 +43,7 @@ InternalCallbackScope::InternalCallbackScope(Environment* env,\n     object_(object),\n     callback_scope_(env) {\n   CHECK_IMPLIES(expect == kRequireResource, !object.IsEmpty());\n+  CHECK_NOT_NULL(env);\n \n   if (!env->can_call_into_js()) {\n     failed_ = true;"
        },
        {
            "sha": "3556458f9d7dc9dd15928275ee40a2dafe2fd95e",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -294,6 +294,15 @@ inline Environment* Environment::GetCurrent(v8::Isolate* isolate) {\n }\n \n inline Environment* Environment::GetCurrent(v8::Local<v8::Context> context) {\n+  if (UNLIKELY(context.IsEmpty() ||\n+      context->GetNumberOfEmbedderDataFields() <\n+          ContextEmbedderIndex::kContextTag ||\n+      context->GetAlignedPointerFromEmbedderData(\n+          ContextEmbedderIndex::kContextTag) !=\n+          Environment::kNodeContextTagPtr)) {\n+    return nullptr;\n+  }\n+\n   return static_cast<Environment*>(\n       context->GetAlignedPointerFromEmbedderData(\n           ContextEmbedderIndex::kEnvironment));"
        },
        {
            "sha": "a8c2ab63274baf2131b7678f1873f9ff1ea24e46",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 11,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -491,18 +491,9 @@ void Environment::EnvPromiseHook(v8::PromiseHookType type,\n                                  v8::Local<v8::Value> parent) {\n   Local<v8::Context> context = promise->CreationContext();\n \n-  // Grow the embedder data if necessary to make sure we are not out of bounds\n-  // when reading the magic number.\n-  context->SetAlignedPointerInEmbedderData(\n-      ContextEmbedderIndex::kContextTagBoundary, nullptr);\n-  int* magicNumberPtr = reinterpret_cast<int*>(\n-      context->GetAlignedPointerFromEmbedderData(\n-          ContextEmbedderIndex::kContextTag));\n-  if (magicNumberPtr != Environment::kNodeContextTagPtr) {\n-    return;\n-  }\n-\n   Environment* env = Environment::GetCurrent(context);\n+  if (env == nullptr) return;\n+\n   for (const PromiseHookCallback& hook : env->promise_hooks_) {\n     hook.cb_(type, promise, parent, hook.arg_);\n   }"
        },
        {
            "sha": "54b7c4d01c6d3b763b295dc84abb9c30339a767c",
            "filename": "src/inspector_js_api.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Finspector_js_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Finspector_js_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_js_api.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -149,12 +149,11 @@ void CallAndPauseOnStart(const FunctionCallbackInfo<v8::Value>& args) {\n }\n \n void InspectorConsoleCall(const FunctionCallbackInfo<Value>& info) {\n-  Isolate* isolate = info.GetIsolate();\n-  HandleScope handle_scope(isolate);\n+  Environment* env = Environment::GetCurrent(info);\n+  Isolate* isolate = env->isolate();\n   Local<Context> context = isolate->GetCurrentContext();\n   CHECK_LT(2, info.Length());\n   SlicedArguments call_args(info, /* start */ 3);\n-  Environment* env = Environment::GetCurrent(isolate);\n   if (InspectorEnabled(env)) {\n     Local<Value> inspector_method = info[0];\n     CHECK(inspector_method->IsFunction());"
        },
        {
            "sha": "d751b16de00395eb17fe286005fd0075ce3f7ea0",
            "filename": "src/module_wrap.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fmodule_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fmodule_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fmodule_wrap.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -362,6 +362,7 @@ MaybeLocal<Module> ModuleWrap::ResolveCallback(Local<Context> context,\n                                                Local<String> specifier,\n                                                Local<Module> referrer) {\n   Environment* env = Environment::GetCurrent(context);\n+  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n   Isolate* isolate = env->isolate();\n   if (env->module_map.count(referrer->GetIdentityHash()) == 0) {\n     env->ThrowError(\"linking error, unknown module\");\n@@ -700,6 +701,7 @@ static MaybeLocal<Promise> ImportModuleDynamically(\n     Local<String> specifier) {\n   Isolate* iso = context->GetIsolate();\n   Environment* env = Environment::GetCurrent(context);\n+  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n   v8::EscapableHandleScope handle_scope(iso);\n \n   if (env->context() != context) {\n@@ -750,8 +752,8 @@ void ModuleWrap::SetImportModuleDynamicallyCallback(\n \n void ModuleWrap::HostInitializeImportMetaObjectCallback(\n     Local<Context> context, Local<Module> module, Local<Object> meta) {\n-  Isolate* isolate = context->GetIsolate();\n   Environment* env = Environment::GetCurrent(context);\n+  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n   ModuleWrap* module_wrap = GetFromModule(env, module);\n \n   if (module_wrap == nullptr) {\n@@ -762,7 +764,7 @@ void ModuleWrap::HostInitializeImportMetaObjectCallback(\n   Local<Function> callback =\n       env->host_initialize_import_meta_object_callback();\n   Local<Value> args[] = { wrap, meta };\n-  callback->Call(context, Undefined(isolate), arraysize(args), args)\n+  callback->Call(context, Undefined(env->isolate()), arraysize(args), args)\n       .ToLocalChecked();\n }\n "
        },
        {
            "sha": "938f4c442b60e54f47a69d04c80d98ff934ebaa5",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -630,7 +630,8 @@ namespace {\n bool ShouldAbortOnUncaughtException(Isolate* isolate) {\n   HandleScope scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n-  return env->should_abort_on_uncaught_toggle()[0] &&\n+  return env != nullptr &&\n+         env->should_abort_on_uncaught_toggle()[0] &&\n          !env->inside_should_not_abort_on_uncaught_scope();\n }\n \n@@ -639,13 +640,15 @@ bool ShouldAbortOnUncaughtException(Isolate* isolate) {\n \n void AddPromiseHook(Isolate* isolate, promise_hook_func fn, void* arg) {\n   Environment* env = Environment::GetCurrent(isolate);\n+  CHECK_NOT_NULL(env);\n   env->AddPromiseHook(fn, arg);\n }\n \n void AddEnvironmentCleanupHook(Isolate* isolate,\n                                void (*fun)(void* arg),\n                                void* arg) {\n   Environment* env = Environment::GetCurrent(isolate);\n+  CHECK_NOT_NULL(env);\n   env->AddCleanupHook(fun, arg);\n }\n \n@@ -654,6 +657,7 @@ void RemoveEnvironmentCleanupHook(Isolate* isolate,\n                                   void (*fun)(void* arg),\n                                   void* arg) {\n   Environment* env = Environment::GetCurrent(isolate);\n+  CHECK_NOT_NULL(env);\n   env->RemoveCleanupHook(fun, arg);\n }\n \n@@ -738,6 +742,7 @@ MaybeLocal<Value> MakeCallback(Isolate* isolate,\n   // Because of the AssignToContext() call in src/node_contextify.cc,\n   // the two contexts need not be the same.\n   Environment* env = Environment::GetCurrent(callback->CreationContext());\n+  CHECK_NOT_NULL(env);\n   Context::Scope context_scope(env->context());\n   MaybeLocal<Value> ret = InternalMakeCallback(env, recv, callback,\n                                                argc, argv, asyncContext);\n@@ -1377,6 +1382,7 @@ void FatalException(Isolate* isolate,\n   HandleScope scope(isolate);\n \n   Environment* env = Environment::GetCurrent(isolate);\n+  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n   Local<Object> process_object = env->process_object();\n   Local<String> fatal_exception_string = env->fatal_exception_string();\n   Local<Value> fatal_exception_function =\n@@ -1602,7 +1608,7 @@ static void GetInternalBinding(const FunctionCallbackInfo<Value>& args) {\n }\n \n static void GetLinkedBinding(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args.GetIsolate());\n+  Environment* env = Environment::GetCurrent(args);\n \n   CHECK(args[0]->IsString());\n \n@@ -2706,10 +2712,13 @@ void RunAtExit(Environment* env) {\n \n uv_loop_t* GetCurrentEventLoop(Isolate* isolate) {\n   HandleScope handle_scope(isolate);\n-  auto context = isolate->GetCurrentContext();\n+  Local<Context> context = isolate->GetCurrentContext();\n   if (context.IsEmpty())\n     return nullptr;\n-  return Environment::GetCurrent(context)->event_loop();\n+  Environment* env = Environment::GetCurrent(context);\n+  if (env == nullptr)\n+    return nullptr;\n+  return env->event_loop();\n }\n \n "
        },
        {
            "sha": "3dd5b383310a038d02d45f885842a627e6e1a4b7",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -946,7 +946,7 @@ class ThreadSafeFunction : public node::AsyncResource {\n         return napi_ok;\n       }\n \n-      node::Environment::GetCurrent(env->isolate)->CloseHandle(\n+      NodeEnv()->CloseHandle(\n           reinterpret_cast<uv_handle_t*>(&async),\n           [](uv_handle_t* handle) -> void {\n             ThreadSafeFunction* ts_fn =\n@@ -1036,9 +1036,12 @@ class ThreadSafeFunction : public node::AsyncResource {\n   }\n \n   node::Environment* NodeEnv() {\n-    // For some reason grabbing the Node.js environment requires a handle scope.\n+    // Grabbing the Node.js environment requires a handle scope because it\n+    // looks up fields on the current context.\n     v8::HandleScope scope(env->isolate);\n-    return node::Environment::GetCurrent(env->isolate);\n+    node::Environment* node_env = node::Environment::GetCurrent(env->isolate);\n+    CHECK_NOT_NULL(node_env);\n+    return node_env;\n   }\n \n   void MaybeStartIdle() {\n@@ -1234,7 +1237,9 @@ void napi_module_register_by_symbol(v8::Local<v8::Object> exports,\n                                     v8::Local<v8::Context> context,\n                                     napi_addon_register_func init) {\n   if (init == nullptr) {\n-    node::Environment::GetCurrent(context)->ThrowError(\n+    node::Environment* node_env = node::Environment::GetCurrent(context);\n+    CHECK_NOT_NULL(node_env);\n+    node_env->ThrowError(\n         \"Module has no declared entry point.\");\n     return;\n   }"
        },
        {
            "sha": "dd285156b5644b4e0ce206bddd60187abd50820e",
            "filename": "src/node_buffer.cc",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_buffer.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -274,7 +274,9 @@ MaybeLocal<Object> New(Isolate* isolate,\n MaybeLocal<Object> New(Isolate* isolate, size_t length) {\n   EscapableHandleScope handle_scope(isolate);\n   Local<Object> obj;\n-  if (Buffer::New(Environment::GetCurrent(isolate), length).ToLocal(&obj))\n+  Environment* env = Environment::GetCurrent(isolate);\n+  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n+  if (Buffer::New(env, length).ToLocal(&obj))\n     return handle_scope.Escape(obj);\n   return Local<Object>();\n }\n@@ -316,6 +318,7 @@ MaybeLocal<Object> New(Environment* env, size_t length) {\n MaybeLocal<Object> Copy(Isolate* isolate, const char* data, size_t length) {\n   EscapableHandleScope handle_scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n+  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n   Local<Object> obj;\n   if (Buffer::Copy(env, data, length).ToLocal(&obj))\n     return handle_scope.Escape(obj);\n@@ -365,6 +368,7 @@ MaybeLocal<Object> New(Isolate* isolate,\n                        void* hint) {\n   EscapableHandleScope handle_scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n+  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n   Local<Object> obj;\n   if (Buffer::New(env, data, length, callback, hint).ToLocal(&obj))\n     return handle_scope.Escape(obj);\n@@ -403,6 +407,7 @@ MaybeLocal<Object> New(Environment* env,\n MaybeLocal<Object> New(Isolate* isolate, char* data, size_t length) {\n   EscapableHandleScope handle_scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n+  CHECK_NOT_NULL(env);  // TODO(addaleax): Handle nullptr here.\n   Local<Object> obj;\n   if (Buffer::New(env, data, length).ToLocal(&obj))\n     return handle_scope.Escape(obj);"
        },
        {
            "sha": "807ba56c7c69fbfc76ac888648305d1bae7b55a5",
            "filename": "src/node_context_data.h",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_context_data.h",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_context_data.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_context_data.h?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -25,16 +25,11 @@ namespace node {\n #define NODE_CONTEXT_TAG 35\n #endif\n \n-#ifndef NODE_CONTEXT_TAG_BOUNDARY\n-#define NODE_CONTEXT_TAG_BOUNDARY 36\n-#endif\n-\n enum ContextEmbedderIndex {\n   kEnvironment = NODE_CONTEXT_EMBEDDER_DATA_INDEX,\n   kSandboxObject = NODE_CONTEXT_SANDBOX_OBJECT_INDEX,\n   kAllowWasmCodeGeneration = NODE_CONTEXT_ALLOW_WASM_CODE_GENERATION_INDEX,\n   kContextTag = NODE_CONTEXT_TAG,\n-  kContextTagBoundary = NODE_CONTEXT_TAG_BOUNDARY,\n };\n \n }  // namespace node"
        },
        {
            "sha": "07d5966962bae852a5c2a75a99155ff411bcd74f",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -441,7 +441,7 @@ void FSReqCallback::SetReturnValue(const FunctionCallbackInfo<Value>& args) {\n \n void NewFSReqCallback(const FunctionCallbackInfo<Value>& args) {\n   CHECK(args.IsConstructCall());\n-  Environment* env = Environment::GetCurrent(args.GetIsolate());\n+  Environment* env = Environment::GetCurrent(args);\n   new FSReqCallback(env, args.This(), args[0]->IsTrue());\n }\n \n@@ -782,7 +782,7 @@ inline FSReqBase* GetReqWrap(Environment* env, Local<Value> value,\n }\n \n void Access(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args.GetIsolate());\n+  Environment* env = Environment::GetCurrent(args);\n   HandleScope scope(env->isolate());\n \n   const int argc = args.Length();\n@@ -2234,8 +2234,7 @@ void Initialize(Local<Object> target,\n   StatWatcher::Initialize(env, target);\n \n   // Create FunctionTemplate for FSReqCallback\n-  Local<FunctionTemplate> fst =\n-      FunctionTemplate::New(env->isolate(), NewFSReqCallback);\n+  Local<FunctionTemplate> fst = env->NewFunctionTemplate(NewFSReqCallback);\n   fst->InstanceTemplate()->SetInternalFieldCount(1);\n   AsyncWrap::AddWrapMethods(env, fst);\n   Local<String> wrapString ="
        },
        {
            "sha": "0bf08210a64f8e8344cdf4a475a1ab35dd5ff4da",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -501,7 +501,9 @@ class InternalCallbackScope {\n \n class ThreadPoolWork {\n  public:\n-  explicit inline ThreadPoolWork(Environment* env) : env_(env) {}\n+  explicit inline ThreadPoolWork(Environment* env) : env_(env) {\n+    CHECK_NOT_NULL(env);\n+  }\n   inline virtual ~ThreadPoolWork() = default;\n \n   inline void ScheduleWork();"
        },
        {
            "sha": "da6d571f208ad0d638aed6ef0a5ba1162fa48dc4",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -310,6 +310,7 @@ void TimerFunctionCall(const FunctionCallbackInfo<Value>& args) {\n   Isolate* isolate = args.GetIsolate();\n   HandleScope scope(isolate);\n   Environment* env = Environment::GetCurrent(isolate);\n+  CHECK_NOT_NULL(env);  // TODO(addaleax): Verify that this is correct.\n   Local<Context> context = env->context();\n   Local<Function> fn = args.Data().As<Function>();\n   size_t count = args.Length();"
        },
        {
            "sha": "fa0f94a5add9bd0ee0b4aa72867544e045bcfd71",
            "filename": "test/cctest/test_environment.cc",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/4286dcf17f062034117043a2640b620210b61f57/test%2Fcctest%2Ftest_environment.cc",
            "raw_url": "https://github.com/nodejs/node/raw/4286dcf17f062034117043a2640b620210b61f57/test%2Fcctest%2Ftest_environment.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_environment.cc?ref=4286dcf17f062034117043a2640b620210b61f57",
            "patch": "@@ -70,6 +70,26 @@ TEST_F(EnvironmentTest, MultipleEnvironmentsPerIsolate) {\n   EXPECT_TRUE(called_cb_2);\n }\n \n+TEST_F(EnvironmentTest, NonNodeJSContext) {\n+  const v8::HandleScope handle_scope(isolate_);\n+  const Argv argv;\n+  Env test_env {handle_scope, argv};\n+\n+  EXPECT_EQ(node::Environment::GetCurrent(v8::Local<v8::Context>()), nullptr);\n+\n+  node::Environment* env = *test_env;\n+  EXPECT_EQ(node::Environment::GetCurrent(isolate_), env);\n+  EXPECT_EQ(node::Environment::GetCurrent(env->context()), env);\n+\n+  v8::Local<v8::Context> context = v8::Context::New(isolate_);\n+  EXPECT_EQ(node::Environment::GetCurrent(context), nullptr);\n+  EXPECT_EQ(node::Environment::GetCurrent(isolate_), env);\n+\n+  v8::Context::Scope context_scope(context);\n+  EXPECT_EQ(node::Environment::GetCurrent(context), nullptr);\n+  EXPECT_EQ(node::Environment::GetCurrent(isolate_), nullptr);\n+}\n+\n static void at_exit_callback1(void* arg) {\n   called_cb_1 = true;\n   if (arg) {"
        }
    ],
    "stats": {
        "total": 118,
        "additions": 81,
        "deletions": 37
    }
}