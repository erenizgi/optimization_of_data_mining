{
    "author": "danbev",
    "message": "src: add incr/decr operators for Reference\n\nThis commit adds operator overloads for increment/decrement to\nAliasedBuffer::Reference.\nThe motivation for doing this is to hopefully make code that needs\nto increment/decrement a little simpler.\n\nPR-URL: https://github.com/nodejs/node/pull/19083\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>",
    "sha": "45277e23d5488dc11d705b850d310b4afb5085bb",
    "files": [
        {
            "sha": "8b103f4949030c5f9386cae2a5324d611f16d614",
            "filename": "src/aliased_buffer.h",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/45277e23d5488dc11d705b850d310b4afb5085bb/src%2Faliased_buffer.h",
            "raw_url": "https://github.com/nodejs/node/raw/45277e23d5488dc11d705b850d310b4afb5085bb/src%2Faliased_buffer.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Faliased_buffer.h?ref=45277e23d5488dc11d705b850d310b4afb5085bb",
            "patch": "@@ -141,6 +141,22 @@ class AliasedBuffer {\n       return aliased_buffer_->GetValue(index_);\n     }\n \n+    template <typename T>\n+    inline Reference& operator+=(const T& val) {\n+      const T current = aliased_buffer_->GetValue(index_);\n+      aliased_buffer_->SetValue(index_, current + val);\n+      return *this;\n+    }\n+\n+    inline Reference& operator+=(const Reference& val) {\n+      return this->operator+=(static_cast<NativeT>(val));\n+    }\n+\n+    template <typename T>\n+    inline Reference& operator-=(const T& val) {\n+      return this->operator+=(-val);\n+    }\n+\n    private:\n     AliasedBuffer<NativeT, V8T>* aliased_buffer_;\n     size_t index_;"
        },
        {
            "sha": "55649e8bc5f1f8785e515e20587673307a4748d6",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/45277e23d5488dc11d705b850d310b4afb5085bb/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/45277e23d5488dc11d705b850d310b4afb5085bb/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=45277e23d5488dc11d705b850d310b4afb5085bb",
            "patch": "@@ -112,8 +112,7 @@ inline v8::Local<v8::String> Environment::AsyncHooks::provider_string(int idx) {\n }\n \n inline void Environment::AsyncHooks::no_force_checks() {\n-  // fields_ does not have the -= operator defined\n-  fields_[kCheck] = fields_[kCheck] - 1;\n+  fields_[kCheck] -= 1;\n }\n \n inline Environment* Environment::AsyncHooks::env() {\n@@ -135,7 +134,7 @@ inline void Environment::AsyncHooks::push_async_ids(double async_id,\n     grow_async_ids_stack();\n   async_ids_stack_[2 * offset] = async_id_fields_[kExecutionAsyncId];\n   async_ids_stack_[2 * offset + 1] = async_id_fields_[kTriggerAsyncId];\n-  fields_[kStackLength] = fields_[kStackLength] + 1;\n+  fields_[kStackLength] += 1;\n   async_id_fields_[kExecutionAsyncId] = async_id;\n   async_id_fields_[kTriggerAsyncId] = trigger_async_id;\n }\n@@ -240,19 +239,19 @@ inline bool Environment::ImmediateInfo::has_outstanding() const {\n }\n \n inline void Environment::ImmediateInfo::count_inc(uint32_t increment) {\n-  fields_[kCount] = fields_[kCount] + increment;\n+  fields_[kCount] += increment;\n }\n \n inline void Environment::ImmediateInfo::count_dec(uint32_t decrement) {\n-  fields_[kCount] = fields_[kCount] - decrement;\n+  fields_[kCount] -= decrement;\n }\n \n inline void Environment::ImmediateInfo::ref_count_inc(uint32_t increment) {\n-  fields_[kRefCount] = fields_[kRefCount] + increment;\n+  fields_[kRefCount] += increment;\n }\n \n inline void Environment::ImmediateInfo::ref_count_dec(uint32_t decrement) {\n-  fields_[kRefCount] = fields_[kRefCount] - decrement;\n+  fields_[kRefCount] -= decrement;\n }\n \n inline Environment::TickInfo::TickInfo(v8::Isolate* isolate)\n@@ -478,8 +477,7 @@ inline std::vector<double>* Environment::destroy_async_id_list() {\n }\n \n inline double Environment::new_async_id() {\n-  async_hooks()->async_id_fields()[AsyncHooks::kAsyncIdCounter] =\n-    async_hooks()->async_id_fields()[AsyncHooks::kAsyncIdCounter] + 1;\n+  async_hooks()->async_id_fields()[AsyncHooks::kAsyncIdCounter] += 1;\n   return async_hooks()->async_id_fields()[AsyncHooks::kAsyncIdCounter];\n }\n "
        },
        {
            "sha": "7afa466133b757e6187a7132e98be58adc7060a6",
            "filename": "test/cctest/test_aliased_buffer.cc",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/45277e23d5488dc11d705b850d310b4afb5085bb/test%2Fcctest%2Ftest_aliased_buffer.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45277e23d5488dc11d705b850d310b4afb5085bb/test%2Fcctest%2Ftest_aliased_buffer.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Ftest_aliased_buffer.cc?ref=45277e23d5488dc11d705b850d310b4afb5085bb",
            "patch": "@@ -207,3 +207,33 @@ TEST_F(AliasBufferTest, SharedArrayBuffer4) {\n       int8_t, v8::Int8Array,\n       int32_t, v8::Int32Array>(isolate_, 1, 3, 1);\n }\n+\n+TEST_F(AliasBufferTest, OperatorOverloads) {\n+  v8::Isolate::Scope isolate_scope(isolate_);\n+  v8::HandleScope handle_scope(isolate_);\n+  v8::Local<v8::Context> context = v8::Context::New(isolate_);\n+  v8::Context::Scope context_scope(context);\n+  const size_t size = 10;\n+  AliasedBuffer<uint32_t, v8::Uint32Array> ab{isolate_, size};\n+\n+  EXPECT_EQ(static_cast<uint32_t>(1), ab[0] = 1);\n+  EXPECT_EQ(static_cast<uint32_t>(4), ab[0] += 3);\n+  EXPECT_EQ(static_cast<uint32_t>(2), ab[0] -= 2);\n+  EXPECT_EQ(static_cast<uint32_t>(-2), -ab[0]);\n+}\n+\n+TEST_F(AliasBufferTest, OperatorOverloadsRefs) {\n+  v8::Isolate::Scope isolate_scope(isolate_);\n+  v8::HandleScope handle_scope(isolate_);\n+  v8::Local<v8::Context> context = v8::Context::New(isolate_);\n+  v8::Context::Scope context_scope(context);\n+  AliasedBuffer<uint32_t, v8::Uint32Array> ab{isolate_, 2};\n+  using Reference = AliasedBuffer<uint32_t, v8::Uint32Array>::Reference;\n+  Reference ref = ab[0];\n+  Reference ref_value = ab[1] = 2;\n+\n+  EXPECT_EQ(static_cast<uint32_t>(2), ref = ref_value);\n+  EXPECT_EQ(static_cast<uint32_t>(4), ref += ref_value);\n+  EXPECT_EQ(static_cast<uint32_t>(2), ref -= ref_value);\n+  EXPECT_EQ(static_cast<uint32_t>(-2), -ref);\n+}"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 53,
        "deletions": 9
    }
}