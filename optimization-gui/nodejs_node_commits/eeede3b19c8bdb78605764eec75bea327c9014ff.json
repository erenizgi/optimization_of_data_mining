{
    "author": "apapirovski",
    "message": "domain: further abstract usage in C++\n\nMove the majority of C++ domain-related code into JS land by introducing\na top level domain callback which handles entering & exiting the domain.\n\nMove the rest of the domain necessities into their own file that creates\nan internal binding, to avoid exposing domain-related code on the\nprocess object.\n\nModify an existing test slightly to better test domain-related code.\n\nPR-URL: https://github.com/nodejs/node/pull/18291\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "eeede3b19c8bdb78605764eec75bea327c9014ff",
    "files": [
        {
            "sha": "08fbd207f171d327cefec0b4ed2a5db5db5bb51a",
            "filename": "lib/domain.js",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/eeede3b19c8bdb78605764eec75bea327c9014ff/lib%2Fdomain.js",
            "raw_url": "https://github.com/nodejs/node/raw/eeede3b19c8bdb78605764eec75bea327c9014ff/lib%2Fdomain.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fdomain.js?ref=eeede3b19c8bdb78605764eec75bea327c9014ff",
            "patch": "@@ -94,11 +94,21 @@ process.setUncaughtExceptionCaptureCallback = function(fn) {\n   throw err;\n };\n \n+function topLevelDomainCallback(cb, ...args) {\n+  const domain = this.domain;\n+  if (domain)\n+    domain.enter();\n+  const ret = Reflect.apply(cb, this, args);\n+  if (domain)\n+    domain.exit();\n+  return ret;\n+}\n+\n // It's possible to enter one domain while already inside\n // another one. The stack is each entered domain.\n const stack = [];\n exports._stack = stack;\n-process._setupDomainUse();\n+internalBinding('domain').enable(topLevelDomainCallback);\n \n function updateExceptionCapture() {\n   if (stack.every((domain) => domain.listenerCount('error') === 0)) {"
        },
        {
            "sha": "36efe80f7a210760c56110334f38770fdacb85cd",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/eeede3b19c8bdb78605764eec75bea327c9014ff/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/eeede3b19c8bdb78605764eec75bea327c9014ff/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=eeede3b19c8bdb78605764eec75bea327c9014ff",
            "patch": "@@ -300,6 +300,7 @@\n         'src/node_constants.cc',\n         'src/node_contextify.cc',\n         'src/node_debug_options.cc',\n+        'src/node_domain.cc',\n         'src/node_file.cc',\n         'src/node_http2.cc',\n         'src/node_http_parser.cc',"
        },
        {
            "sha": "202393f679e219707e5afaf9fc7d5d94917a4d9e",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/eeede3b19c8bdb78605764eec75bea327c9014ff/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/eeede3b19c8bdb78605764eec75bea327c9014ff/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=eeede3b19c8bdb78605764eec75bea327c9014ff",
            "patch": "@@ -310,7 +310,6 @@ inline Environment::Environment(IsolateData* isolate_data,\n       immediate_info_(context->GetIsolate()),\n       tick_info_(context->GetIsolate()),\n       timer_base_(uv_now(isolate_data->event_loop())),\n-      using_domains_(false),\n       printed_error_(false),\n       trace_sync_io_(false),\n       abort_on_uncaught_exception_(false),\n@@ -426,14 +425,6 @@ inline uint64_t Environment::timer_base() const {\n   return timer_base_;\n }\n \n-inline bool Environment::using_domains() const {\n-  return using_domains_;\n-}\n-\n-inline void Environment::set_using_domains(bool value) {\n-  using_domains_ = value;\n-}\n-\n inline bool Environment::printed_error() const {\n   return printed_error_;\n }"
        },
        {
            "sha": "b24ada5740dd7bee602fb1ae1d481a0b4cf6340e",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/eeede3b19c8bdb78605764eec75bea327c9014ff/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/eeede3b19c8bdb78605764eec75bea327c9014ff/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=eeede3b19c8bdb78605764eec75bea327c9014ff",
            "patch": "@@ -91,7 +91,6 @@ class ModuleWrap;\n   V(decorated_private_symbol, \"node:decorated\")                               \\\n   V(npn_buffer_private_symbol, \"node:npnBuffer\")                              \\\n   V(selected_npn_buffer_private_symbol, \"node:selectedNpnBuffer\")             \\\n-  V(domain_private_symbol, \"node:domain\")                                     \\\n \n // Strings are per-isolate primitives but Environment proxies them\n // for the sake of convenience.  Strings should be ASCII-only.\n@@ -128,7 +127,6 @@ class ModuleWrap;\n   V(dns_soa_string, \"SOA\")                                                    \\\n   V(dns_srv_string, \"SRV\")                                                    \\\n   V(dns_txt_string, \"TXT\")                                                    \\\n-  V(domain_string, \"domain\")                                                  \\\n   V(emit_warning_string, \"emitWarning\")                                       \\\n   V(exchange_string, \"exchange\")                                              \\\n   V(encoding_string, \"encoding\")                                              \\\n@@ -280,6 +278,7 @@ class ModuleWrap;\n   V(internal_binding_cache_object, v8::Object)                                \\\n   V(buffer_prototype_object, v8::Object)                                      \\\n   V(context, v8::Context)                                                     \\\n+  V(domain_callback, v8::Function)                                            \\\n   V(host_import_module_dynamically_callback, v8::Function)                    \\\n   V(http2ping_constructor_template, v8::ObjectTemplate)                       \\\n   V(http2stream_constructor_template, v8::ObjectTemplate)                     \\\n@@ -567,9 +566,6 @@ class Environment {\n \n   inline IsolateData* isolate_data() const;\n \n-  inline bool using_domains() const;\n-  inline void set_using_domains(bool value);\n-\n   inline bool printed_error() const;\n   inline void set_printed_error(bool value);\n \n@@ -745,7 +741,6 @@ class Environment {\n   ImmediateInfo immediate_info_;\n   TickInfo tick_info_;\n   const uint64_t timer_base_;\n-  bool using_domains_;\n   bool printed_error_;\n   bool trace_sync_io_;\n   bool abort_on_uncaught_exception_;"
        },
        {
            "sha": "c9af7c7dcd1efcb445f7adaf9bc05c522fbead31",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 68,
            "changes": 78,
            "blob_url": "https://github.com/nodejs/node/blob/eeede3b19c8bdb78605764eec75bea327c9014ff/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/eeede3b19c8bdb78605764eec75bea327c9014ff/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=eeede3b19c8bdb78605764eec75bea327c9014ff",
            "patch": "@@ -790,62 +790,6 @@ bool ShouldAbortOnUncaughtException(Isolate* isolate) {\n }\n \n \n-Local<Value> GetDomainProperty(Environment* env, Local<Object> object) {\n-  Local<Value> domain_v =\n-      object->GetPrivate(env->context(), env->domain_private_symbol())\n-          .ToLocalChecked();\n-  if (domain_v->IsObject()) {\n-    return domain_v;\n-  }\n-  return object->Get(env->context(), env->domain_string()).ToLocalChecked();\n-}\n-\n-\n-void DomainEnter(Environment* env, Local<Object> object) {\n-  Local<Value> domain_v = GetDomainProperty(env, object);\n-  if (domain_v->IsObject()) {\n-    Local<Object> domain = domain_v.As<Object>();\n-    Local<Value> enter_v = domain->Get(env->enter_string());\n-    if (enter_v->IsFunction()) {\n-      if (enter_v.As<Function>()->Call(domain, 0, nullptr).IsEmpty()) {\n-        FatalError(\"node::AsyncWrap::MakeCallback\",\n-                   \"domain enter callback threw, please report this\");\n-      }\n-    }\n-  }\n-}\n-\n-\n-void DomainExit(Environment* env, v8::Local<v8::Object> object) {\n-  Local<Value> domain_v = GetDomainProperty(env, object);\n-  if (domain_v->IsObject()) {\n-    Local<Object> domain = domain_v.As<Object>();\n-    Local<Value> exit_v = domain->Get(env->exit_string());\n-    if (exit_v->IsFunction()) {\n-      if (exit_v.As<Function>()->Call(domain, 0, nullptr).IsEmpty()) {\n-        FatalError(\"node::AsyncWrap::MakeCallback\",\n-                  \"domain exit callback threw, please report this\");\n-      }\n-    }\n-  }\n-}\n-\n-void SetupDomainUse(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-\n-  if (env->using_domains())\n-    return;\n-  env->set_using_domains(true);\n-\n-  HandleScope scope(env->isolate());\n-\n-  // Do a little housekeeping.\n-  env->process_object()->Delete(\n-      env->context(),\n-      FIXED_ONE_BYTE_STRING(args.GetIsolate(), \"_setupDomainUse\")).FromJust();\n-}\n-\n-\n void RunMicrotasks(const FunctionCallbackInfo<Value>& args) {\n   args.GetIsolate()->RunMicrotasks();\n }\n@@ -982,11 +926,6 @@ InternalCallbackScope::InternalCallbackScope(Environment* env,\n   // If you hit this assertion, you forgot to enter the v8::Context first.\n   CHECK_EQ(Environment::GetCurrent(env->isolate()), env);\n \n-  if (asyncContext.async_id == 0 && env->using_domains() &&\n-      !object_.IsEmpty()) {\n-    DomainEnter(env, object_);\n-  }\n-\n   if (asyncContext.async_id != 0) {\n     // No need to check a return value because the application will exit if\n     // an exception occurs.\n@@ -1016,11 +955,6 @@ void InternalCallbackScope::Close() {\n     AsyncWrap::EmitAfter(env_, async_context_.async_id);\n   }\n \n-  if (async_context_.async_id == 0 && env_->using_domains() &&\n-      !object_.IsEmpty()) {\n-    DomainExit(env_, object_);\n-  }\n-\n   if (IsInnerMakeCallback()) {\n     return;\n   }\n@@ -1061,7 +995,16 @@ MaybeLocal<Value> InternalMakeCallback(Environment* env,\n     return Undefined(env->isolate());\n   }\n \n-  MaybeLocal<Value> ret = callback->Call(env->context(), recv, argc, argv);\n+  Local<Function> domain_cb = env->domain_callback();\n+  MaybeLocal<Value> ret;\n+  if (asyncContext.async_id != 0 || domain_cb.IsEmpty() || recv.IsEmpty()) {\n+    ret = callback->Call(env->context(), recv, argc, argv);\n+  } else {\n+    std::vector<Local<Value>> args(1 + argc);\n+    args[0] = callback;\n+    std::copy(&argv[0], &argv[argc], &args[1]);\n+    ret = domain_cb->Call(env->context(), recv, args.size(), &args[0]);\n+  }\n \n   if (ret.IsEmpty()) {\n     // NOTE: For backwards compatibility with public API we return Undefined()\n@@ -3339,7 +3282,6 @@ void SetupProcessObject(Environment* env,\n   env->SetMethod(process, \"_setupProcessObject\", SetupProcessObject);\n   env->SetMethod(process, \"_setupNextTick\", SetupNextTick);\n   env->SetMethod(process, \"_setupPromises\", SetupPromises);\n-  env->SetMethod(process, \"_setupDomainUse\", SetupDomainUse);\n }\n \n "
        },
        {
            "sha": "f4f585ac4f43e25f0f7a17685688d4f2d60f2593",
            "filename": "src/node_domain.cc",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/nodejs/node/blob/eeede3b19c8bdb78605764eec75bea327c9014ff/src%2Fnode_domain.cc",
            "raw_url": "https://github.com/nodejs/node/raw/eeede3b19c8bdb78605764eec75bea327c9014ff/src%2Fnode_domain.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_domain.cc?ref=eeede3b19c8bdb78605764eec75bea327c9014ff",
            "patch": "@@ -0,0 +1,34 @@\n+#include \"v8.h\"\n+#include \"node_internals.h\"\n+\n+namespace node {\n+namespace domain {\n+\n+using v8::Context;\n+using v8::Function;\n+using v8::FunctionCallbackInfo;\n+using v8::Local;\n+using v8::Object;\n+using v8::Value;\n+\n+\n+void Enable(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+\n+  CHECK(args[0]->IsFunction());\n+\n+  env->set_domain_callback(args[0].As<Function>());\n+}\n+\n+void Initialize(Local<Object> target,\n+                Local<Value> unused,\n+                Local<Context> context) {\n+  Environment* env = Environment::GetCurrent(context);\n+\n+  env->SetMethod(target, \"enable\", Enable);\n+}\n+\n+}  // namespace domain\n+}  // namespace node\n+\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(domain, node::domain::Initialize)"
        },
        {
            "sha": "0001d15172f39e920f1d1440e896f06e44d5885a",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/eeede3b19c8bdb78605764eec75bea327c9014ff/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/eeede3b19c8bdb78605764eec75bea327c9014ff/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=eeede3b19c8bdb78605764eec75bea327c9014ff",
            "patch": "@@ -104,6 +104,7 @@ struct sockaddr;\n     V(cares_wrap)                                                             \\\n     V(config)                                                                 \\\n     V(contextify)                                                             \\\n+    V(domain)                                                                 \\\n     V(fs)                                                                     \\\n     V(fs_event_wrap)                                                          \\\n     V(http2)                                                                  \\"
        },
        {
            "sha": "d2f7560048fd46f0dacc2be014dcd2cd08c6fd4f",
            "filename": "test/addons/repl-domain-abort/binding.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/eeede3b19c8bdb78605764eec75bea327c9014ff/test%2Faddons%2Frepl-domain-abort%2Fbinding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/eeede3b19c8bdb78605764eec75bea327c9014ff/test%2Faddons%2Frepl-domain-abort%2Fbinding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Frepl-domain-abort%2Fbinding.cc?ref=eeede3b19c8bdb78605764eec75bea327c9014ff",
            "patch": "@@ -22,6 +22,7 @@\n #include <node.h>\n #include <v8.h>\n \n+using v8::Boolean;\n using v8::Function;\n using v8::FunctionCallbackInfo;\n using v8::Local;\n@@ -31,11 +32,16 @@ using v8::Value;\n \n void Method(const FunctionCallbackInfo<Value>& args) {\n   Isolate* isolate = args.GetIsolate();\n-  node::MakeCallback(isolate,\n-                     isolate->GetCurrentContext()->Global(),\n-                     args[0].As<Function>(),\n-                     0,\n-                     nullptr);\n+  Local<Value> params[] = {\n+    Boolean::New(isolate, true),\n+    Boolean::New(isolate, false)\n+  };\n+  Local<Value> ret = node::MakeCallback(isolate,\n+                                        isolate->GetCurrentContext()->Global(),\n+                                        args[0].As<Function>(),\n+                                        2,\n+                                        params);\n+  assert(ret->IsTrue());\n }\n \n void init(Local<Object> exports) {"
        },
        {
            "sha": "2049fe6e6a23f5961fcefe920c19db6ecb2ab5cf",
            "filename": "test/addons/repl-domain-abort/test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/eeede3b19c8bdb78605764eec75bea327c9014ff/test%2Faddons%2Frepl-domain-abort%2Ftest.js",
            "raw_url": "https://github.com/nodejs/node/raw/eeede3b19c8bdb78605764eec75bea327c9014ff/test%2Faddons%2Frepl-domain-abort%2Ftest.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Faddons%2Frepl-domain-abort%2Ftest.js?ref=eeede3b19c8bdb78605764eec75bea327c9014ff",
            "patch": "@@ -40,7 +40,8 @@ const lines = [\n   // This line shouldn't cause an assertion error.\n   `require('${buildPath}')` +\n   // Log output to double check callback ran.\n-  '.method(function() { console.log(\\'cb_ran\\'); });',\n+  '.method(function(v1, v2) {' +\n+  'console.log(\\'cb_ran\\'); return v1 === true && v2 === false; });',\n ];\n \n const dInput = new stream.Readable();"
        },
        {
            "sha": "bd4f20bc9f823d446d9450c4c90c6058ca39d0e9",
            "filename": "test/cctest/node_module_reg.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/eeede3b19c8bdb78605764eec75bea327c9014ff/test%2Fcctest%2Fnode_module_reg.cc",
            "raw_url": "https://github.com/nodejs/node/raw/eeede3b19c8bdb78605764eec75bea327c9014ff/test%2Fcctest%2Fnode_module_reg.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcctest%2Fnode_module_reg.cc?ref=eeede3b19c8bdb78605764eec75bea327c9014ff",
            "patch": "@@ -5,6 +5,7 @@\n void _register_cares_wrap() {}\n void _register_config() {}\n void _register_contextify() {}\n+void _register_domain() {}\n void _register_fs() {}\n void _register_fs_event_wrap() {}\n void _register_http2() {}"
        }
    ],
    "stats": {
        "total": 162,
        "additions": 72,
        "deletions": 90
    }
}