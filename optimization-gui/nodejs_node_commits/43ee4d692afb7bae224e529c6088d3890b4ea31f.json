{
    "author": "BridgeAR",
    "message": "assert: improve simple assert\n\n1) If simple assert is called in the very first line of a file and\nit causes an error, it used to report the wrong code. The reason\nis that the column that is reported is faulty. This is fixed by\nsubtracting the offset from now on in such cases.\n\n2) The actual code read is now limited to the part that is actually\nrequired to visualize the call site. All other code in e.g. minified\nfiles will not cause a significant overhead anymore.\n\n3) The number of allocations is now significantly lower than it used\nto be. The buffer is reused until the correct line in the code is\nfound. In general the algorithm tries to safe operations where\npossible.\n\n4) The indentation is now corrected depending on where the statement\nactually beginns.\n\n5) It is now possible to handle `.call()` and `.apply()` properly.\n\n6) The user defined function name will now always be used instead of\nonly choosing either `assert.ok()` or `assert()`.\n\nPR-URL: https://github.com/nodejs/node/pull/21626\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ben Coe <bencoe@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "43ee4d692afb7bae224e529c6088d3890b4ea31f",
    "files": [
        {
            "sha": "555b38f39e59b9cc28f7ea332f19aabf0872aa32",
            "filename": "lib/assert.js",
            "status": "modified",
            "additions": 146,
            "deletions": 78,
            "changes": 224,
            "blob_url": "https://github.com/nodejs/node/blob/43ee4d692afb7bae224e529c6088d3890b4ea31f/lib%2Fassert.js",
            "raw_url": "https://github.com/nodejs/node/raw/43ee4d692afb7bae224e529c6088d3890b4ea31f/lib%2Fassert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fassert.js?ref=43ee4d692afb7bae224e529c6088d3890b4ea31f",
            "patch": "@@ -35,6 +35,10 @@ const { NativeModule } = require('internal/bootstrap/loaders');\n \n let isDeepEqual;\n let isDeepStrictEqual;\n+let parseExpressionAt;\n+let findNodeAround;\n+let columnOffset = 0;\n+let decoder;\n \n function lazyLoadComparison() {\n   const comparison = require('internal/util/comparisons');\n@@ -114,52 +118,141 @@ function fail(actual, expected, message, operator, stackStartFn) {\n assert.fail = fail;\n \n // The AssertionError is defined in internal/error.\n-// new assert.AssertionError({ message: message,\n-//                             actual: actual,\n-//                             expected: expected });\n assert.AssertionError = AssertionError;\n \n-function getBuffer(fd, assertLine) {\n+function findColumn(fd, column, code) {\n+  if (code.length > column + 100) {\n+    try {\n+      return parseCode(code, column);\n+    } catch {\n+      // End recursion in case no code could be parsed. The expression should\n+      // have been found after 2500 characters, so stop trying.\n+      if (code.length - column > 2500) {\n+        // eslint-disable-next-line no-throw-literal\n+        throw null;\n+      }\n+    }\n+  }\n+  // Read up to 2500 bytes more than necessary in columns. That way we address\n+  // multi byte characters and read enough data to parse the code.\n+  const bytesToRead = column - code.length + 2500;\n+  const buffer = Buffer.allocUnsafe(bytesToRead);\n+  const bytesRead = readSync(fd, buffer, 0, bytesToRead);\n+  code += decoder.write(buffer.slice(0, bytesRead));\n+  // EOF: fast path.\n+  if (bytesRead < bytesToRead) {\n+    return parseCode(code, column);\n+  }\n+  // Read potentially missing code.\n+  return findColumn(fd, column, code);\n+}\n+\n+function getCode(fd, line, column) {\n+  let bytesRead = 0;\n+  if (line === 0) {\n+    // Special handle line number one. This is more efficient and simplifies the\n+    // rest of the algorithm. Read more than the regular column number in bytes\n+    // to prevent multiple reads in case multi byte characters are used.\n+    return findColumn(fd, column, '');\n+  }\n   let lines = 0;\n   // Prevent blocking the event loop by limiting the maximum amount of\n   // data that may be read.\n   let maxReads = 64; // bytesPerRead * maxReads = 512 kb\n-  let bytesRead = 0;\n-  let startBuffer = 0; // Start reading from that char on\n   const bytesPerRead = 8192;\n-  const buffers = [];\n-  do {\n-    const buffer = Buffer.allocUnsafe(bytesPerRead);\n+  // Use a single buffer up front that is reused until the call site is found.\n+  let buffer = Buffer.allocUnsafe(bytesPerRead);\n+  while (maxReads-- !== 0) {\n+    // Only allocate a new buffer in case the needed line is found. All data\n+    // before that can be discarded.\n+    buffer = lines < line ? buffer : Buffer.allocUnsafe(bytesPerRead);\n     bytesRead = readSync(fd, buffer, 0, bytesPerRead);\n+    // Read the buffer until the required code line is found.\n     for (var i = 0; i < bytesRead; i++) {\n-      if (buffer[i] === 10) {\n-        lines++;\n-        if (lines === assertLine) {\n-          startBuffer = i + 1;\n-        // Read up to 15 more lines to make sure all code gets matched\n-        } else if (lines === assertLine + 16) {\n-          buffers.push(buffer.slice(startBuffer, i));\n-          return buffers;\n+      if (buffer[i] === 10 && ++lines === line) {\n+        // If the end of file is reached, directly parse the code and return.\n+        if (bytesRead < bytesPerRead) {\n+          return parseCode(buffer.toString('utf8', i + 1, bytesRead), column);\n         }\n+        // Check if the read code is sufficient or read more until the whole\n+        // expression is read. Make sure multi byte characters are preserved\n+        // properly by using the decoder.\n+        const code = decoder.write(buffer.slice(i + 1, bytesRead));\n+        return findColumn(fd, column, code);\n       }\n     }\n-    if (lines >= assertLine) {\n-      buffers.push(buffer.slice(startBuffer, bytesRead));\n-      // Reset the startBuffer in case we need more than one chunk\n-      startBuffer = 0;\n+  }\n+}\n+\n+function parseCode(code, offset) {\n+  // Lazy load acorn.\n+  if (parseExpressionAt === undefined) {\n+    ({ parseExpressionAt } = require('internal/deps/acorn/dist/acorn'));\n+    ({ findNodeAround } = require('internal/deps/acorn/dist/walk'));\n+  }\n+  let node;\n+  let start = 0;\n+  // Parse the read code until the correct expression is found.\n+  do {\n+    try {\n+      node = parseExpressionAt(code, start);\n+      start = node.end + 1 || start;\n+      // Find the CallExpression in the tree.\n+      node = findNodeAround(node, offset, 'CallExpression');\n+    } catch (err) {\n+      // Unexpected token error and the like.\n+      start += err.raisedAt || 1;\n+      if (start > offset) {\n+        // No matching expression found. This could happen if the assert\n+        // expression is bigger than the provided buffer.\n+        // eslint-disable-next-line no-throw-literal\n+        throw null;\n+      }\n     }\n-  } while (--maxReads !== 0 && bytesRead !== 0);\n-  return buffers;\n+  } while (node === undefined || node.node.end < offset);\n+\n+  return [\n+    node.node.start,\n+    code.slice(node.node.start, node.node.end)\n+        .replace(escapeSequencesRegExp, escapeFn)\n+  ];\n }\n \n-function getErrMessage(call) {\n+function getErrMessage(message, fn) {\n+  const tmpLimit = Error.stackTraceLimit;\n+  // Make sure the limit is set to 1. Otherwise it could fail (<= 0) or it\n+  // does to much work.\n+  Error.stackTraceLimit = 1;\n+  // We only need the stack trace. To minimize the overhead use an object\n+  // instead of an error.\n+  const err = {};\n+  Error.captureStackTrace(err, fn);\n+  Error.stackTraceLimit = tmpLimit;\n+\n+  const tmpPrepare = Error.prepareStackTrace;\n+  Error.prepareStackTrace = (_, stack) => stack;\n+  const call = err.stack[0];\n+  Error.prepareStackTrace = tmpPrepare;\n+\n   const filename = call.getFileName();\n+\n   if (!filename) {\n-    return;\n+    return message;\n   }\n \n   const line = call.getLineNumber() - 1;\n-  const column = call.getColumnNumber() - 1;\n+  let column = call.getColumnNumber() - 1;\n+\n+  // Line number one reports the wrong column due to being wrapped in a\n+  // function. Remove that offset to get the actual call.\n+  if (line === 0) {\n+    if (columnOffset === 0) {\n+      const { wrapper } = require('internal/modules/cjs/loader');\n+      columnOffset = wrapper[0].length;\n+    }\n+    column -= columnOffset;\n+  }\n+\n   const identifier = `${filename}${line}${column}`;\n \n   if (errorCache.has(identifier)) {\n@@ -172,57 +265,49 @@ function getErrMessage(call) {\n     return;\n   }\n \n-  let fd, message;\n+  let fd;\n   try {\n+    // Set the stack trace limit to zero. This makes sure unexpected token\n+    // errors are handled faster.\n+    Error.stackTraceLimit = 0;\n+\n+    if (decoder === undefined) {\n+      const { StringDecoder } = require('string_decoder');\n+      decoder = new StringDecoder('utf8');\n+    }\n+\n     fd = openSync(filename, 'r', 0o666);\n-    const buffers = getBuffer(fd, line);\n-    const code = Buffer.concat(buffers).toString('utf8');\n-    // Lazy load acorn.\n-    const { parseExpressionAt } = require('internal/deps/acorn/dist/acorn');\n-    const nodes = parseExpressionAt(code, column);\n-    // Node type should be \"CallExpression\" and some times\n-    // \"SequenceExpression\".\n-    const node = nodes.type === 'CallExpression' ? nodes : nodes.expressions[0];\n-    const name = node.callee.name;\n-    // Calling `ok` with .apply or .call is uncommon but we use a simple\n-    // safeguard nevertheless.\n-    if (name !== 'apply' && name !== 'call') {\n-    // Only use `assert` and `assert.ok` to reference the \"real API\" and\n-    // not user defined function names.\n-      const ok = name === 'ok' ? '.ok' : '';\n-      const args = node.arguments;\n-      message = code\n-        .slice(args[0].start, args[args.length - 1].end)\n-        .replace(escapeSequencesRegExp, escapeFn);\n+    // Reset column and message.\n+    [column, message] = getCode(fd, line, column);\n+    // Flush unfinished multi byte characters.\n+    decoder.end();\n+    // Always normalize indentation, otherwise the message could look weird.\n+    if (message.indexOf('\\n') !== -1) {\n       if (EOL === '\\r\\n') {\n         message = message.replace(/\\r\\n/g, '\\n');\n       }\n-      // Always normalize indentation, otherwise the message could look weird.\n-      if (message.indexOf('\\n') !== -1) {\n-        const tmp = message.split('\\n');\n-        message = tmp[0];\n-        for (var i = 1; i < tmp.length; i++) {\n-          let pos = 0;\n-          while (pos < column &&\n-              (tmp[i][pos] === ' ' || tmp[i][pos] === '\\t')) {\n-            pos++;\n-          }\n-          message += `\\n  ${tmp[i].slice(pos)}`;\n+      const frames = message.split('\\n');\n+      message = frames.shift();\n+      for (const frame of frames) {\n+        let pos = 0;\n+        while (pos < column && (frame[pos] === ' ' || frame[pos] === '\\t')) {\n+          pos++;\n         }\n+        message += `\\n  ${frame.slice(pos)}`;\n       }\n-      message = 'The expression evaluated to a falsy value:' +\n-        `\\n\\n  assert${ok}(${message})\\n`;\n     }\n+    message = `The expression evaluated to a falsy value:\\n\\n  ${message}\\n`;\n     // Make sure to always set the cache! No matter if the message is\n     // undefined or not\n     errorCache.set(identifier, message);\n \n     return message;\n-\n   } catch (e) {\n   // Invalidate cache to prevent trying to read this part again.\n     errorCache.set(identifier, undefined);\n   } finally {\n+    // Reset limit.\n+    Error.stackTraceLimit = tmpLimit;\n     if (fd !== undefined)\n       closeSync(fd);\n   }\n@@ -236,25 +321,8 @@ function innerOk(fn, argLen, value, message) {\n       generatedMessage = true;\n       message = 'No value argument passed to `assert.ok()`';\n     } else if (message == null) {\n-      // Use the call as error message if possible.\n-      // This does not work with e.g. the repl.\n-      // eslint-disable-next-line no-restricted-syntax\n-      const err = new Error();\n-      // Make sure the limit is set to 1. Otherwise it could fail (<= 0) or it\n-      // does to much work.\n-      const tmpLimit = Error.stackTraceLimit;\n-      Error.stackTraceLimit = 1;\n-      Error.captureStackTrace(err, fn);\n-      Error.stackTraceLimit = tmpLimit;\n-\n-      const tmpPrepare = Error.prepareStackTrace;\n-      Error.prepareStackTrace = (_, stack) => stack;\n-      const call = err.stack[0];\n-      Error.prepareStackTrace = tmpPrepare;\n-\n-      // Make sure it would be \"null\" in case that is used.\n-      message = getErrMessage(call) || message;\n       generatedMessage = true;\n+      message = getErrMessage(message, fn);\n     } else if (message instanceof Error) {\n       throw message;\n     }"
        },
        {
            "sha": "8a65113559c981514046e173768756a1b5ff2c37",
            "filename": "test/fixtures/assert-first-line.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/43ee4d692afb7bae224e529c6088d3890b4ea31f/test%2Ffixtures%2Fassert-first-line.js",
            "raw_url": "https://github.com/nodejs/node/raw/43ee4d692afb7bae224e529c6088d3890b4ea31f/test%2Ffixtures%2Fassert-first-line.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fassert-first-line.js?ref=43ee4d692afb7bae224e529c6088d3890b4ea31f",
            "patch": "@@ -0,0 +1,2 @@\n+'use strict'; const ässört = require('assert'); ässört(true); ässört.ok(''); ässört(null);\n+// aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa(false);"
        },
        {
            "sha": "cab3507ac8d7796d4233a882324fc35af9075e8b",
            "filename": "test/fixtures/assert-long-line.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/43ee4d692afb7bae224e529c6088d3890b4ea31f/test%2Ffixtures%2Fassert-long-line.js",
            "raw_url": "https://github.com/nodejs/node/raw/43ee4d692afb7bae224e529c6088d3890b4ea31f/test%2Ffixtures%2Fassert-long-line.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fassert-long-line.js?ref=43ee4d692afb7bae224e529c6088d3890b4ea31f",
            "patch": "@@ -0,0 +1 @@\n+'use strict'; /* aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa */ const assert = require('assert'); assert(true); assert.ok(''); assert(null);"
        },
        {
            "sha": "32eadbf74156c38bd087e78ee3ef4eee949fdfc7",
            "filename": "test/parallel/test-assert-first-line.js",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/43ee4d692afb7bae224e529c6088d3890b4ea31f/test%2Fparallel%2Ftest-assert-first-line.js",
            "raw_url": "https://github.com/nodejs/node/raw/43ee4d692afb7bae224e529c6088d3890b4ea31f/test%2Fparallel%2Ftest-assert-first-line.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert-first-line.js?ref=43ee4d692afb7bae224e529c6088d3890b4ea31f",
            "patch": "@@ -0,0 +1,23 @@\n+'use strict';\n+\n+// Verify that asserting in the very first line produces the expected result.\n+\n+require('../common');\n+const assert = require('assert');\n+const { path } = require('../common/fixtures');\n+\n+assert.throws(\n+  () => require(path('assert-first-line')),\n+  {\n+    name: 'AssertionError [ERR_ASSERTION]',\n+    message: \"The expression evaluated to a falsy value:\\n\\n  ässört.ok('')\\n\"\n+  }\n+);\n+\n+assert.throws(\n+  () => require(path('assert-long-line')),\n+  {\n+    name: 'AssertionError [ERR_ASSERTION]',\n+    message: \"The expression evaluated to a falsy value:\\n\\n  assert.ok('')\\n\"\n+  }\n+);"
        },
        {
            "sha": "bc96dc57bcd5c01a9da9ff921fb36d3e916f4af3",
            "filename": "test/parallel/test-assert.js",
            "status": "modified",
            "additions": 49,
            "deletions": 14,
            "changes": 63,
            "blob_url": "https://github.com/nodejs/node/blob/43ee4d692afb7bae224e529c6088d3890b4ea31f/test%2Fparallel%2Ftest-assert.js",
            "raw_url": "https://github.com/nodejs/node/raw/43ee4d692afb7bae224e529c6088d3890b4ea31f/test%2Fparallel%2Ftest-assert.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-assert.js?ref=43ee4d692afb7bae224e529c6088d3890b4ea31f",
            "patch": "@@ -457,7 +457,7 @@ assert.throws(\n       code: 'ERR_ASSERTION',\n       type: assert.AssertionError,\n       message: 'The expression evaluated to a falsy value:\\n\\n  ' +\n-               \"assert.ok(typeof 123 === 'string')\\n\"\n+               \"assert.ok(\\n    typeof 123 === 'string'\\n  )\\n\"\n     }\n   );\n   Error.stackTraceLimit = tmpLimit;\n@@ -661,7 +661,7 @@ common.expectsError(\n       code: 'ERR_ASSERTION',\n       type: assert.AssertionError,\n       message: 'The expression evaluated to a falsy value:\\n\\n  ' +\n-               \"assert(Buffer.from('test') instanceof Error)\\n\"\n+               \"assert(\\n    (Buffer.from('test') instanceof Error)\\n  )\\n\"\n     }\n   );\n   common.expectsError(\n@@ -670,7 +670,7 @@ common.expectsError(\n       code: 'ERR_ASSERTION',\n       type: assert.AssertionError,\n       message: 'The expression evaluated to a falsy value:\\n\\n  ' +\n-               \"assert(Buffer.from('test') instanceof Error)\\n\"\n+               \"assert(\\n    (Buffer.from('test') instanceof Error)\\n  )\\n\"\n     }\n   );\n   fs.close = tmp;\n@@ -690,11 +690,13 @@ common.expectsError(\n     code: 'ERR_ASSERTION',\n     type: assert.AssertionError,\n     message: 'The expression evaluated to a falsy value:\\n\\n' +\n-             '  assert((() => \\'string\\')()\\n' +\n+             '  a(\\n' +\n+             '    (() => \\'string\\')()\\n' +\n              '    // eslint-disable-next-line\\n' +\n              '    ===\\n' +\n              '    123 instanceof\\n' +\n-             '        Buffer)\\n'\n+             '        Buffer\\n' +\n+             '  )\\n'\n   }\n );\n \n@@ -712,11 +714,13 @@ common.expectsError(\n     code: 'ERR_ASSERTION',\n     type: assert.AssertionError,\n     message: 'The expression evaluated to a falsy value:\\n\\n' +\n-             '  assert((() => \\'string\\')()\\n' +\n+             '  a(\\n' +\n+             '    (() => \\'string\\')()\\n' +\n              '    // eslint-disable-next-line\\n' +\n              '    ===\\n' +\n              '  123 instanceof\\n' +\n-             '        Buffer)\\n'\n+             '        Buffer\\n' +\n+             '  )\\n'\n   }\n );\n \n@@ -731,16 +735,19 @@ Buffer\n   code: 'ERR_ASSERTION',\n   type: assert.AssertionError,\n   message: 'The expression evaluated to a falsy value:\\n\\n' +\n-           '  assert((\\n' +\n+           '  a((\\n' +\n            '    () => \\'string\\')() ===\\n' +\n            '  123 instanceof\\n' +\n-           '  Buffer)\\n'\n+           '  Buffer\\n' +\n+           '  )\\n'\n   }\n );\n /* eslint-enable indent */\n \n common.expectsError(\n-  () => assert(null, undefined),\n+  () => {\n+    assert(true); assert(null, undefined);\n+  },\n   {\n     code: 'ERR_ASSERTION',\n     type: assert.AssertionError,\n@@ -750,11 +757,38 @@ common.expectsError(\n );\n \n common.expectsError(\n-  () => assert.ok.apply(null, [0]),\n+  () => {\n+    assert\n+     .ok(null, undefined);\n+  },\n   {\n     code: 'ERR_ASSERTION',\n     type: assert.AssertionError,\n-    message: '0 == true'\n+    message: 'The expression evaluated to a falsy value:\\n\\n  ' +\n+             'ok(null, undefined)\\n'\n+  }\n+);\n+\n+common.expectsError(\n+  // eslint-disable-next-line dot-notation, quotes\n+  () => assert['ok'][\"apply\"](null, [0]),\n+  {\n+    code: 'ERR_ASSERTION',\n+    type: assert.AssertionError,\n+    message: 'The expression evaluated to a falsy value:\\n\\n  ' +\n+             'assert[\\'ok\\'][\"apply\"](null, [0])\\n'\n+  }\n+);\n+\n+common.expectsError(\n+  () => {\n+    const wrapper = (fn, value) => fn(value);\n+    wrapper(assert, false);\n+  },\n+  {\n+    code: 'ERR_ASSERTION',\n+    type: assert.AssertionError,\n+    message: 'The expression evaluated to a falsy value:\\n\\n  fn(value)\\n'\n   }\n );\n \n@@ -763,7 +797,8 @@ common.expectsError(\n   {\n     code: 'ERR_ASSERTION',\n     type: assert.AssertionError,\n-    message: '0 == true',\n+    message: 'The expression evaluated to a falsy value:\\n\\n  ' +\n+             'assert.ok.call(null, 0)\\n',\n     generatedMessage: true\n   }\n );\n@@ -778,7 +813,7 @@ common.expectsError(\n   }\n );\n \n-// works in eval\n+// Works in eval.\n common.expectsError(\n   () => new Function('assert', 'assert(1 === 2);')(assert),\n   {"
        }
    ],
    "stats": {
        "total": 313,
        "additions": 221,
        "deletions": 92
    }
}