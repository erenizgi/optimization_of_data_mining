{
    "author": "addaleax",
    "message": "src: remove StreamBase::kFlagHasWritev\n\nSince libuv 1.21.0, pipes on Windows support `writev` on the\nlibuv side.\n\nThis allows for some simplification, and makes the `StreamBase`\nAPI more uniform (multi-buffer `Write()` is always supported now,\nincluding when used by other non-JS consumers like HTTP/2).\n\nPR-URL: https://github.com/nodejs/node/pull/21527\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "64a3fadf7192485197b9695b7bb2165c7e7d762d",
    "files": [
        {
            "sha": "2393539737910aa5fb512697e0e257e9853f67b8",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -210,10 +210,6 @@ function initSocketHandle(self) {\n     self._handle.owner = self;\n     self._handle.onread = onread;\n     self[async_id_symbol] = getNewAsyncId(self._handle);\n-\n-    // If handle doesn't support writev - neither do we\n-    if (!self._handle.writev)\n-      self._writev = null;\n   }\n }\n "
        },
        {
            "sha": "902aff7abee43e8ae488a358d4cd94bb8b06f271",
            "filename": "src/js_stream.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fjs_stream.cc",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fjs_stream.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fjs_stream.cc?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -208,7 +208,7 @@ void JSStream::Initialize(Local<Object> target,\n   env->SetProtoMethod(t, \"readBuffer\", ReadBuffer);\n   env->SetProtoMethod(t, \"emitEOF\", EmitEOF);\n \n-  StreamBase::AddMethods<JSStream>(env, t, StreamBase::kFlagHasWritev);\n+  StreamBase::AddMethods<JSStream>(env, t);\n   target->Set(jsStreamString, t->GetFunction());\n }\n "
        },
        {
            "sha": "f08833b201b19db03a52ec406458b7c1625ca4e0",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -1997,7 +1997,7 @@ void Initialize(Local<Object> target,\n   Local<String> handleString =\n        FIXED_ONE_BYTE_STRING(env->isolate(), \"FileHandle\");\n   fd->SetClassName(handleString);\n-  StreamBase::AddMethods<FileHandle>(env, fd, StreamBase::kFlagNone);\n+  StreamBase::AddMethods<FileHandle>(env, fd);\n   target->Set(context, handleString, fd->GetFunction()).FromJust();\n   env->set_fd_constructor_template(fdt);\n "
        },
        {
            "sha": "0251777644115a1bf9d350af981584f5623f240a",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -2840,7 +2840,7 @@ void Initialize(Local<Object> target,\n   env->SetProtoMethod(stream, \"rstStream\", Http2Stream::RstStream);\n   env->SetProtoMethod(stream, \"refreshState\", Http2Stream::RefreshState);\n   AsyncWrap::AddWrapMethods(env, stream);\n-  StreamBase::AddMethods<Http2Stream>(env, stream, StreamBase::kFlagHasWritev);\n+  StreamBase::AddMethods<Http2Stream>(env, stream);\n   Local<ObjectTemplate> streamt = stream->InstanceTemplate();\n   streamt->SetInternalFieldCount(1);\n   env->set_http2stream_constructor_template(streamt);"
        },
        {
            "sha": "e2cc114479d5a17e630f40ed8882ab52901be63d",
            "filename": "src/pipe_wrap.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fpipe_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fpipe_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fpipe_wrap.cc?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -83,11 +83,7 @@ void PipeWrap::Initialize(Local<Object> target,\n   env->SetProtoMethod(t, \"ref\", HandleWrap::Ref);\n   env->SetProtoMethod(t, \"hasRef\", HandleWrap::HasRef);\n \n-#ifdef _WIN32\n   LibuvStreamWrap::AddMethods(env, t);\n-#else\n-  LibuvStreamWrap::AddMethods(env, t, StreamBase::kFlagHasWritev);\n-#endif\n \n   env->SetProtoMethod(t, \"bind\", Bind);\n   env->SetProtoMethod(t, \"listen\", Listen);"
        },
        {
            "sha": "027b938d30df1cfcdc421e3a2c3fe38a34c60c83",
            "filename": "src/stream_base-inl.h",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fstream_base-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fstream_base-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base-inl.h?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -266,9 +266,7 @@ inline WriteWrap* StreamBase::CreateWriteWrap(\n }\n \n template <class Base>\n-void StreamBase::AddMethods(Environment* env,\n-                            Local<FunctionTemplate> t,\n-                            int flags) {\n+void StreamBase::AddMethods(Environment* env, Local<FunctionTemplate> t) {\n   HandleScope scope(env->isolate());\n \n   enum PropertyAttribute attributes =\n@@ -325,8 +323,7 @@ void StreamBase::AddMethods(Environment* env,\n   env->SetProtoMethod(t, \"readStart\", JSMethod<Base, &StreamBase::ReadStartJS>);\n   env->SetProtoMethod(t, \"readStop\", JSMethod<Base, &StreamBase::ReadStopJS>);\n   env->SetProtoMethod(t, \"shutdown\", JSMethod<Base, &StreamBase::Shutdown>);\n-  if ((flags & kFlagHasWritev) != 0)\n-    env->SetProtoMethod(t, \"writev\", JSMethod<Base, &StreamBase::Writev>);\n+  env->SetProtoMethod(t, \"writev\", JSMethod<Base, &StreamBase::Writev>);\n   env->SetProtoMethod(t,\n                       \"writeBuffer\",\n                       JSMethod<Base, &StreamBase::WriteBuffer>);"
        },
        {
            "sha": "405780619856baaab1f5543e514a5dc8c9e6000d",
            "filename": "src/stream_base.h",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fstream_base.h",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fstream_base.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_base.h?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -255,15 +255,9 @@ class StreamResource {\n \n class StreamBase : public StreamResource {\n  public:\n-  enum Flags {\n-    kFlagNone = 0x0,\n-    kFlagHasWritev = 0x1\n-  };\n-\n   template <class Base>\n   static inline void AddMethods(Environment* env,\n-                                v8::Local<v8::FunctionTemplate> target,\n-                                int flags = kFlagNone);\n+                                v8::Local<v8::FunctionTemplate> target);\n \n   virtual bool IsAlive() = 0;\n   virtual bool IsClosing() = 0;"
        },
        {
            "sha": "2dea245fd1dddcbef087b9518befb6d47d834635",
            "filename": "src/stream_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fstream_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fstream_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_wrap.cc?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -97,8 +97,7 @@ LibuvStreamWrap::LibuvStreamWrap(Environment* env,\n \n \n void LibuvStreamWrap::AddMethods(Environment* env,\n-                                 v8::Local<v8::FunctionTemplate> target,\n-                                 int flags) {\n+                                 v8::Local<v8::FunctionTemplate> target) {\n   Local<FunctionTemplate> get_write_queue_size =\n       FunctionTemplate::New(env->isolate(),\n                             GetWriteQueueSize,\n@@ -110,7 +109,7 @@ void LibuvStreamWrap::AddMethods(Environment* env,\n       Local<FunctionTemplate>(),\n       static_cast<PropertyAttribute>(ReadOnly | DontDelete));\n   env->SetProtoMethod(target, \"setBlocking\", SetBlocking);\n-  StreamBase::AddMethods<LibuvStreamWrap>(env, target, flags);\n+  StreamBase::AddMethods<LibuvStreamWrap>(env, target);\n }\n \n "
        },
        {
            "sha": "487a40b7ffc7f988afc961eb44b3cf7f17263a4c",
            "filename": "src/stream_wrap.h",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fstream_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Fstream_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fstream_wrap.h?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -85,8 +85,7 @@ class LibuvStreamWrap : public HandleWrap, public StreamBase {\n   AsyncWrap* GetAsyncWrap() override;\n \n   static void AddMethods(Environment* env,\n-                         v8::Local<v8::FunctionTemplate> target,\n-                         int flags = StreamBase::kFlagNone);\n+                         v8::Local<v8::FunctionTemplate> target);\n \n  protected:\n   inline void set_fd(int fd) {"
        },
        {
            "sha": "aa130d22e02689600dae530f14478c7897ee4b9b",
            "filename": "src/tcp_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Ftcp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Ftcp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.cc?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -93,7 +93,7 @@ void TCPWrap::Initialize(Local<Object> target,\n   env->SetProtoMethod(t, \"unref\", HandleWrap::Unref);\n   env->SetProtoMethod(t, \"hasRef\", HandleWrap::HasRef);\n \n-  LibuvStreamWrap::AddMethods(env, t, StreamBase::kFlagHasWritev);\n+  LibuvStreamWrap::AddMethods(env, t);\n \n   env->SetProtoMethod(t, \"open\", Open);\n   env->SetProtoMethod(t, \"bind\", Bind);"
        },
        {
            "sha": "e731c0c130216b9d3bd87757cdbd27fc6e605f53",
            "filename": "src/tls_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Ftls_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/src%2Ftls_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftls_wrap.cc?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -895,7 +895,7 @@ void TLSWrap::Initialize(Local<Object> target,\n   env->SetProtoMethod(t, \"destroySSL\", DestroySSL);\n   env->SetProtoMethod(t, \"enableCertCb\", EnableCertCb);\n \n-  StreamBase::AddMethods<TLSWrap>(env, t, StreamBase::kFlagHasWritev);\n+  StreamBase::AddMethods<TLSWrap>(env, t);\n   SSLWrap<TLSWrap>::AddMethods(env, t);\n \n   env->SetProtoMethod(t, \"getServername\", GetServername);"
        },
        {
            "sha": "49fc142961d9194ff7e827888b669a60554021cf",
            "filename": "test/parallel/test-http2-pipe-named-pipe.js",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/nodejs/node/blob/64a3fadf7192485197b9695b7bb2165c7e7d762d/test%2Fparallel%2Ftest-http2-pipe-named-pipe.js",
            "raw_url": "https://github.com/nodejs/node/raw/64a3fadf7192485197b9695b7bb2165c7e7d762d/test%2Fparallel%2Ftest-http2-pipe-named-pipe.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-pipe-named-pipe.js?ref=64a3fadf7192485197b9695b7bb2165c7e7d762d",
            "patch": "@@ -0,0 +1,52 @@\n+'use strict';\n+\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const fixtures = require('../common/fixtures');\n+const assert = require('assert');\n+const http2 = require('http2');\n+const fs = require('fs');\n+const net = require('net');\n+const path = require('path');\n+\n+// HTTP/2 servers can listen on a named pipe.\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+const loc = fixtures.path('url-tests.js');\n+const fn = path.join(tmpdir.path, 'http2-url-tests.js');\n+\n+const server = http2.createServer();\n+\n+server.on('stream', common.mustCall((stream) => {\n+  const dest = stream.pipe(fs.createWriteStream(fn));\n+\n+  dest.on('finish', () => {\n+    assert.strictEqual(fs.readFileSync(loc).length,\n+                       fs.readFileSync(fn).length);\n+  });\n+  stream.respond();\n+  stream.end();\n+}));\n+\n+server.listen(common.PIPE, common.mustCall(() => {\n+  const client = http2.connect('http://localhost', {\n+    createConnection(url) {\n+      return net.connect(server.address());\n+    }\n+  });\n+\n+  const req = client.request({ ':method': 'POST' });\n+  req.on('response', common.mustCall());\n+  req.resume();\n+\n+  req.on('close', common.mustCall(() => {\n+    server.close();\n+    client.close();\n+  }));\n+\n+  const str = fs.createReadStream(loc);\n+  str.on('end', common.mustCall());\n+  str.pipe(req);\n+}));"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 63,
        "deletions": 30
    }
}