{
    "author": "danbev",
    "message": "crypto: add createCipher/WithIV functions\n\nThis commit extracts the common code from the Cipher/Cipheriv and\nDecipher/Decipheriv constructors into a separate function to avoid\ncode duplication.\n\nPR-URL: https://github.com/nodejs/node/pull/20164\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tobias Nie√üen <tniessen@tnie.de>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "c85126302393b0f460268f6cc6fb73631f5bea1c",
    "files": [
        {
            "sha": "0970d27c7662e03706ecf1ab9131a74ee6e6a29b",
            "filename": "lib/internal/crypto/cipher.js",
            "status": "modified",
            "additions": 46,
            "deletions": 83,
            "changes": 129,
            "blob_url": "https://github.com/nodejs/node/blob/c85126302393b0f460268f6cc6fb73631f5bea1c/lib%2Finternal%2Fcrypto%2Fcipher.js",
            "raw_url": "https://github.com/nodejs/node/raw/c85126302393b0f460268f6cc6fb73631f5bea1c/lib%2Finternal%2Fcrypto%2Fcipher.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcrypto%2Fcipher.js?ref=c85126302393b0f460268f6cc6fb73631f5bea1c",
            "patch": "@@ -73,10 +73,21 @@ function getUIntOption(options, key) {\n   return -1;\n }\n \n-function Cipher(cipher, password, options) {\n-  if (!(this instanceof Cipher))\n-    return new Cipher(cipher, password, options);\n+function createCipherBase(cipher, credential, options, decipher, iv) {\n+  const authTagLength = getUIntOption(options, 'authTagLength');\n+\n+  this._handle = new CipherBase(decipher);\n+  if (iv === undefined) {\n+    this._handle.init(cipher, credential, authTagLength);\n+  } else {\n+    this._handle.initiv(cipher, credential, iv, authTagLength);\n+  }\n+  this._decoder = null;\n \n+  LazyTransform.call(this, options);\n+}\n+\n+function createCipher(cipher, password, options, decipher) {\n   if (typeof cipher !== 'string')\n     throw new ERR_INVALID_ARG_TYPE('cipher', 'string', cipher);\n \n@@ -89,14 +100,38 @@ function Cipher(cipher, password, options) {\n     );\n   }\n \n-  const authTagLength = getUIntOption(options, 'authTagLength');\n+  createCipherBase.call(this, cipher, password, options, decipher);\n+}\n \n-  this._handle = new CipherBase(true);\n+function createCipherWithIV(cipher, key, options, decipher, iv) {\n+  if (typeof cipher !== 'string')\n+    throw new ERR_INVALID_ARG_TYPE('cipher', 'string', cipher);\n \n-  this._handle.init(cipher, password, authTagLength);\n-  this._decoder = null;\n+  key = toBuf(key);\n+  if (!isArrayBufferView(key)) {\n+    throw new ERR_INVALID_ARG_TYPE(\n+      'key',\n+      ['string', 'Buffer', 'TypedArray', 'DataView'],\n+      key\n+    );\n+  }\n \n-  LazyTransform.call(this, options);\n+  iv = toBuf(iv);\n+  if (iv !== null && !isArrayBufferView(iv)) {\n+    throw new ERR_INVALID_ARG_TYPE(\n+      'iv',\n+      ['string', 'Buffer', 'TypedArray', 'DataView'],\n+      iv\n+    );\n+  }\n+  createCipherBase.call(this, cipher, key, options, decipher, iv);\n+}\n+\n+function Cipher(cipher, password, options) {\n+  if (!(this instanceof Cipher))\n+    return new Cipher(cipher, password, options);\n+\n+  createCipher.call(this, cipher, password, options, true);\n }\n \n inherits(Cipher, LazyTransform);\n@@ -198,34 +233,7 @@ function Cipheriv(cipher, key, iv, options) {\n   if (!(this instanceof Cipheriv))\n     return new Cipheriv(cipher, key, iv, options);\n \n-  if (typeof cipher !== 'string')\n-    throw new ERR_INVALID_ARG_TYPE('cipher', 'string', cipher);\n-\n-  key = toBuf(key);\n-  if (!isArrayBufferView(key)) {\n-    throw new ERR_INVALID_ARG_TYPE(\n-      'key',\n-      ['string', 'Buffer', 'TypedArray', 'DataView'],\n-      key\n-    );\n-  }\n-\n-  iv = toBuf(iv);\n-  if (iv !== null && !isArrayBufferView(iv)) {\n-    throw new ERR_INVALID_ARG_TYPE(\n-      'iv',\n-      ['string', 'Buffer', 'TypedArray', 'DataView'],\n-      iv\n-    );\n-  }\n-\n-  const authTagLength = getUIntOption(options, 'authTagLength');\n-\n-  this._handle = new CipherBase(true);\n-  this._handle.initiv(cipher, key, iv, authTagLength);\n-  this._decoder = null;\n-\n-  LazyTransform.call(this, options);\n+  createCipherWithIV.call(this, cipher, key, options, true, iv);\n }\n \n inherits(Cipheriv, LazyTransform);\n@@ -244,25 +252,7 @@ function Decipher(cipher, password, options) {\n   if (!(this instanceof Decipher))\n     return new Decipher(cipher, password, options);\n \n-  if (typeof cipher !== 'string')\n-    throw new ERR_INVALID_ARG_TYPE('cipher', 'string', cipher);\n-\n-  password = toBuf(password);\n-  if (!isArrayBufferView(password)) {\n-    throw new ERR_INVALID_ARG_TYPE(\n-      'password',\n-      ['string', 'Buffer', 'TypedArray', 'DataView'],\n-      password\n-    );\n-  }\n-\n-  const authTagLength = getUIntOption(options, 'authTagLength');\n-\n-  this._handle = new CipherBase(false);\n-  this._handle.init(cipher, password, authTagLength);\n-  this._decoder = null;\n-\n-  LazyTransform.call(this, options);\n+  createCipher.call(this, cipher, password, options, false);\n }\n \n inherits(Decipher, LazyTransform);\n@@ -281,34 +271,7 @@ function Decipheriv(cipher, key, iv, options) {\n   if (!(this instanceof Decipheriv))\n     return new Decipheriv(cipher, key, iv, options);\n \n-  if (typeof cipher !== 'string')\n-    throw new ERR_INVALID_ARG_TYPE('cipher', 'string', cipher);\n-\n-  key = toBuf(key);\n-  if (!isArrayBufferView(key)) {\n-    throw new ERR_INVALID_ARG_TYPE(\n-      'key',\n-      ['string', 'Buffer', 'TypedArray', 'DataView'],\n-      key\n-    );\n-  }\n-\n-  iv = toBuf(iv);\n-  if (iv !== null && !isArrayBufferView(iv)) {\n-    throw new ERR_INVALID_ARG_TYPE(\n-      'iv',\n-      ['string', 'Buffer', 'TypedArray', 'DataView'],\n-      iv\n-    );\n-  }\n-\n-  const authTagLength = getUIntOption(options, 'authTagLength');\n-\n-  this._handle = new CipherBase(false);\n-  this._handle.initiv(cipher, key, iv, authTagLength);\n-  this._decoder = null;\n-\n-  LazyTransform.call(this, options);\n+  createCipherWithIV.call(this, cipher, key, options, false, iv);\n }\n \n inherits(Decipheriv, LazyTransform);"
        }
    ],
    "stats": {
        "total": 129,
        "additions": 46,
        "deletions": 83
    }
}