{
    "author": "apapirovski",
    "message": "async_hooks: clean up usage in internal code\n\nInstead of exposing internals of async_hooks & async_wrap throughout\nthe code base, create necessary helper methods within the internal\nasync_hooks that allows easy usage by Node.js internals. This stops\nevery single internal user of async_hooks from importing a ton of\nfunctions, constants and internal Aliased Buffers from C++ async_wrap.\n\nAdds functions initHooksExist, afterHooksExist, and destroyHooksExist\nto determine whether the related emit methods need to be triggered.\n\nAdds clearDefaultTriggerAsyncId and clearAsyncIdStack on the JS side\nas an alternative to always calling C++.\n\nMoves async_id_symbol and trigger_async_id_symbol to internal\nasync_hooks as they are never used in C++.\n\nRenames newUid to newAsyncId for added clarity of its purpose.\n\nAdjusts usage throughout the codebase, as well as in a couple of tests.\n\nPR-URL: https://github.com/nodejs/node/pull/18720\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "e9ac80bb397293feef3b47f3ed609c86edb48681",
    "files": [
        {
            "sha": "13abe9c210d55d8b836854e737cec7c766cff4be",
            "filename": "lib/_http_agent.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2F_http_agent.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2F_http_agent.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_agent.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -25,7 +25,7 @@ const net = require('net');\n const util = require('util');\n const EventEmitter = require('events');\n const debug = util.debuglog('http');\n-const { async_id_symbol } = process.binding('async_wrap');\n+const { async_id_symbol } = require('internal/async_hooks').symbols;\n const { nextTick } = require('internal/process/next_tick');\n \n // New Agent code."
        },
        {
            "sha": "f513315b7cd421b2fed66562e3bb34e9607b5c56",
            "filename": "lib/_http_outgoing.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2F_http_outgoing.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2F_http_outgoing.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_outgoing.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -31,7 +31,7 @@ const common = require('_http_common');\n const checkIsHttpToken = common._checkIsHttpToken;\n const checkInvalidHeaderChar = common._checkInvalidHeaderChar;\n const { outHeadersKey } = require('internal/http');\n-const { async_id_symbol } = process.binding('async_wrap');\n+const { async_id_symbol } = require('internal/async_hooks').symbols;\n const { nextTick } = require('internal/process/next_tick');\n const errors = require('internal/errors');\n "
        },
        {
            "sha": "babb705aad6851435598c40314a92789d048ef9d",
            "filename": "lib/async_hooks.js",
            "status": "modified",
            "additions": 5,
            "deletions": 18,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Fasync_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Fasync_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fasync_hooks.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -9,34 +9,31 @@ const internal_async_hooks = require('internal/async_hooks');\n // resource gets gced.\n const { registerDestroyHook } = async_wrap;\n const {\n+  executionAsyncId,\n+  triggerAsyncId,\n   // Private API\n   getHookArrays,\n   enableHooks,\n   disableHooks,\n   // Internal Embedder API\n-  newUid,\n+  newAsyncId,\n   getDefaultTriggerAsyncId,\n   emitInit,\n   emitBefore,\n   emitAfter,\n   emitDestroy,\n } = internal_async_hooks;\n \n-// Get fields\n-const { async_id_fields } = async_wrap;\n-\n // Get symbols\n const {\n+  async_id_symbol, trigger_async_id_symbol,\n   init_symbol, before_symbol, after_symbol, destroy_symbol,\n   promise_resolve_symbol\n } = internal_async_hooks.symbols;\n \n-const { async_id_symbol, trigger_async_id_symbol } = async_wrap;\n-\n // Get constants\n const {\n   kInit, kBefore, kAfter, kDestroy, kTotals, kPromiseResolve,\n-  kExecutionAsyncId, kTriggerAsyncId\n } = async_wrap.constants;\n \n // Listener API //\n@@ -125,16 +122,6 @@ function createHook(fns) {\n }\n \n \n-function executionAsyncId() {\n-  return async_id_fields[kExecutionAsyncId];\n-}\n-\n-\n-function triggerAsyncId() {\n-  return async_id_fields[kTriggerAsyncId];\n-}\n-\n-\n // Embedder API //\n \n const destroyedSymbol = Symbol('destroyed');\n@@ -170,7 +157,7 @@ class AsyncResource {\n                                   triggerAsyncId);\n     }\n \n-    this[async_id_symbol] = newUid();\n+    this[async_id_symbol] = newAsyncId();\n     this[trigger_async_id_symbol] = triggerAsyncId;\n     // this prop name (destroyed) has to be synchronized with C++\n     this[destroyedSymbol] = { destroyed: false };"
        },
        {
            "sha": "a31384a586f4c18967eb4c814b4d844587ba6e50",
            "filename": "lib/dgram.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Fdgram.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Fdgram.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fdgram.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -28,9 +28,11 @@ const dns = require('dns');\n const util = require('util');\n const { isUint8Array } = require('internal/util/types');\n const EventEmitter = require('events');\n-const { defaultTriggerAsyncIdScope } = require('internal/async_hooks');\n+const {\n+  defaultTriggerAsyncIdScope,\n+  symbols: { async_id_symbol }\n+} = require('internal/async_hooks');\n const { UV_UDP_REUSEADDR } = process.binding('constants').os;\n-const { async_id_symbol } = process.binding('async_wrap');\n const { nextTick } = require('internal/process/next_tick');\n \n const { UDP, SendWrap } = process.binding('udp_wrap');"
        },
        {
            "sha": "dc720a223052bf20d7e32b49bfe52fe24e9012db",
            "filename": "lib/internal/async_hooks.js",
            "status": "modified",
            "additions": 56,
            "deletions": 4,
            "changes": 60,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Finternal%2Fasync_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Finternal%2Fasync_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fasync_hooks.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -27,7 +27,7 @@ const async_wrap = process.binding('async_wrap');\n  * It has a fixed size, so if that is exceeded, calls to the native\n  * side are used instead in pushAsyncIds() and popAsyncIds().\n  */\n-const { async_id_symbol, async_hook_fields, async_id_fields } = async_wrap;\n+const { async_hook_fields, async_id_fields } = async_wrap;\n // Store the pair executionAsyncId and triggerAsyncId in a std::stack on\n // Environment::AsyncHooks::async_ids_stack_ tracks the resource responsible for\n // the current execution stack. This is unwound as each resource exits. In the\n@@ -71,6 +71,8 @@ const { kInit, kBefore, kAfter, kDestroy, kPromiseResolve,\n         kDefaultTriggerAsyncId, kStackLength } = async_wrap.constants;\n \n // Used in AsyncHook and AsyncResource.\n+const async_id_symbol = Symbol('asyncId');\n+const trigger_async_id_symbol = Symbol('triggerAsyncId');\n const init_symbol = Symbol('init');\n const before_symbol = Symbol('before');\n const after_symbol = Symbol('after');\n@@ -245,7 +247,7 @@ function disableHooks() {\n // Increment the internal id counter and return the value. Important that the\n // counter increment first. Since it's done the same way in\n // Environment::new_async_uid()\n-function newUid() {\n+function newAsyncId() {\n   return ++async_id_fields[kAsyncIdCounter];\n }\n \n@@ -254,7 +256,7 @@ function getOrSetAsyncId(object) {\n     return object[async_id_symbol];\n   }\n \n-  return object[async_id_symbol] = newUid();\n+  return object[async_id_symbol] = newAsyncId();\n }\n \n \n@@ -270,6 +272,11 @@ function getDefaultTriggerAsyncId() {\n }\n \n \n+function clearDefaultTriggerAsyncId() {\n+  async_id_fields[kDefaultTriggerAsyncId] = -1;\n+}\n+\n+\n function defaultTriggerAsyncIdScope(triggerAsyncId, block, ...args) {\n   // CHECK(Number.isSafeInteger(triggerAsyncId))\n   // CHECK(triggerAsyncId > 0)\n@@ -287,6 +294,19 @@ function defaultTriggerAsyncIdScope(triggerAsyncId, block, ...args) {\n }\n \n \n+function initHooksExist() {\n+  return async_hook_fields[kInit] > 0;\n+}\n+\n+function afterHooksExist() {\n+  return async_hook_fields[kAfter] > 0;\n+}\n+\n+function destroyHooksExist() {\n+  return async_hook_fields[kDestroy] > 0;\n+}\n+\n+\n function emitInitScript(asyncId, type, triggerAsyncId, resource) {\n   validateAsyncId(asyncId, 'asyncId');\n   if (triggerAsyncId !== null)\n@@ -345,6 +365,20 @@ function emitDestroyScript(asyncId) {\n }\n \n \n+// Keep in sync with Environment::AsyncHooks::clear_async_id_stack\n+// in src/env-inl.h.\n+function clearAsyncIdStack() {\n+  async_id_fields[kExecutionAsyncId] = 0;\n+  async_id_fields[kTriggerAsyncId] = 0;\n+  async_hook_fields[kStackLength] = 0;\n+}\n+\n+\n+function hasAsyncIdStack() {\n+  return async_hook_fields[kStackLength] > 0;\n+}\n+\n+\n // This is the equivalent of the native push_async_ids() call.\n function pushAsyncIds(asyncId, triggerAsyncId) {\n   const offset = async_hook_fields[kStackLength];\n@@ -377,20 +411,38 @@ function popAsyncIds(asyncId) {\n }\n \n \n+function executionAsyncId() {\n+  return async_id_fields[kExecutionAsyncId];\n+}\n+\n+function triggerAsyncId() {\n+  return async_id_fields[kTriggerAsyncId];\n+}\n+\n+\n module.exports = {\n+  executionAsyncId,\n+  triggerAsyncId,\n   // Private API\n   getHookArrays,\n   symbols: {\n+    async_id_symbol, trigger_async_id_symbol,\n     init_symbol, before_symbol, after_symbol, destroy_symbol,\n     promise_resolve_symbol\n   },\n   enableHooks,\n   disableHooks,\n+  clearDefaultTriggerAsyncId,\n+  clearAsyncIdStack,\n+  hasAsyncIdStack,\n   // Internal Embedder API\n-  newUid,\n+  newAsyncId,\n   getOrSetAsyncId,\n   getDefaultTriggerAsyncId,\n   defaultTriggerAsyncIdScope,\n+  initHooksExist,\n+  afterHooksExist,\n+  destroyHooksExist,\n   emitInit: emitInitScript,\n   emitBefore: emitBeforeScript,\n   emitAfter: emitAfterScript,"
        },
        {
            "sha": "f85e557d5efdf8562b82d0263bbdc8307154ed3b",
            "filename": "lib/internal/bootstrap_node.js",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Finternal%2Fbootstrap_node.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Finternal%2Fbootstrap_node.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap_node.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -431,18 +431,19 @@\n   function noop() {}\n \n   function setupProcessFatal() {\n-    const async_wrap = process.binding('async_wrap');\n-    // Arrays containing hook flags and ids for async_hook calls.\n-    const { async_hook_fields, async_id_fields } = async_wrap;\n-    // Internal functions needed to manipulate the stack.\n-    const { clearAsyncIdStack } = async_wrap;\n-    const { kAfter, kExecutionAsyncId,\n-            kDefaultTriggerAsyncId, kStackLength } = async_wrap.constants;\n+    const {\n+      executionAsyncId,\n+      clearDefaultTriggerAsyncId,\n+      clearAsyncIdStack,\n+      hasAsyncIdStack,\n+      afterHooksExist,\n+      emitAfter\n+    } = NativeModule.require('internal/async_hooks');\n \n     process._fatalException = function(er) {\n-      // It's possible that kDefaultTriggerAsyncId was set for a constructor\n+      // It's possible that defaultTriggerAsyncId was set for a constructor\n       // call that threw and was never cleared. So clear it now.\n-      async_id_fields[kDefaultTriggerAsyncId] = -1;\n+      clearDefaultTriggerAsyncId();\n \n       if (exceptionHandlerState.captureFn !== null) {\n         exceptionHandlerState.captureFn(er);\n@@ -465,11 +466,10 @@\n       NativeModule.require('timers').setImmediate(noop);\n \n       // Emit the after() hooks now that the exception has been handled.\n-      if (async_hook_fields[kAfter] > 0) {\n-        const { emitAfter } = NativeModule.require('internal/async_hooks');\n+      if (afterHooksExist()) {\n         do {\n-          emitAfter(async_id_fields[kExecutionAsyncId]);\n-        } while (async_hook_fields[kStackLength] > 0);\n+          emitAfter(executionAsyncId());\n+        } while (hasAsyncIdStack());\n       // Or completely empty the id stack.\n       } else {\n         clearAsyncIdStack();"
        },
        {
            "sha": "b7a56850a308c8a208c726aaf9b73ddbb20ba146",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -4,7 +4,7 @@\n \n require('internal/util').assertCrypto();\n \n-const { async_id_symbol } = process.binding('async_wrap');\n+const { async_id_symbol } = require('internal/async_hooks').symbols;\n const http = require('http');\n const binding = process.binding('http2');\n const assert = require('assert');"
        },
        {
            "sha": "f95d9cc1b82ebfe38c765c76e6f7cba82209cb36",
            "filename": "lib/internal/process/next_tick.js",
            "status": "modified",
            "additions": 14,
            "deletions": 13,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Finternal%2Fprocess%2Fnext_tick.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Finternal%2Fprocess%2Fnext_tick.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fnext_tick.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -5,19 +5,20 @@ exports.setup = setupNextTick;\n exports.nextTick = null;\n \n function setupNextTick() {\n-  const async_wrap = process.binding('async_wrap');\n-  const async_hooks = require('internal/async_hooks');\n+  const {\n+    getDefaultTriggerAsyncId,\n+    newAsyncId,\n+    initHooksExist,\n+    destroyHooksExist,\n+    emitInit,\n+    emitBefore,\n+    emitAfter,\n+    emitDestroy,\n+    symbols: { async_id_symbol, trigger_async_id_symbol }\n+  } = require('internal/async_hooks');\n   const promises = require('internal/process/promises');\n   const errors = require('internal/errors');\n   const { emitPromiseRejectionWarnings } = promises;\n-  const getDefaultTriggerAsyncId = async_hooks.getDefaultTriggerAsyncId;\n-  // Two arrays that share state between C++ and JS.\n-  const { async_hook_fields, async_id_fields } = async_wrap;\n-  // Used to change the state of the async id stack.\n-  const { emitInit, emitBefore, emitAfter, emitDestroy } = async_hooks;\n-  // Grab the constants necessary for working with internal arrays.\n-  const { kInit, kDestroy, kAsyncIdCounter } = async_wrap.constants;\n-  const { async_id_symbol, trigger_async_id_symbol } = async_wrap;\n \n   // tickInfo is used so that the C++ code in src/node.cc can\n   // have easy access to our nextTick state, and avoid unnecessary\n@@ -104,7 +105,7 @@ function setupNextTick() {\n         // that nextTick() doesn't allow the event loop to proceed, but if\n         // any async hooks are enabled during the callback's execution then\n         // this tock's after hook will be called, but not its destroy hook.\n-        if (async_hook_fields[kDestroy] > 0)\n+        if (destroyHooksExist())\n           emitDestroy(asyncId);\n \n         const callback = tock.callback;\n@@ -128,11 +129,11 @@ function setupNextTick() {\n       this.callback = callback;\n       this.args = args;\n \n-      const asyncId = ++async_id_fields[kAsyncIdCounter];\n+      const asyncId = newAsyncId();\n       this[async_id_symbol] = asyncId;\n       this[trigger_async_id_symbol] = triggerAsyncId;\n \n-      if (async_hook_fields[kInit] > 0) {\n+      if (initHooksExist()) {\n         emitInit(asyncId,\n                  'TickObject',\n                  triggerAsyncId,"
        },
        {
            "sha": "0c140811f8ce88c70620d2e3a0c8f4e344f611cf",
            "filename": "lib/internal/timers.js",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Finternal%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Finternal%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ftimers.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -1,15 +1,11 @@\n 'use strict';\n \n-const async_wrap = process.binding('async_wrap');\n-// Two arrays that share state between C++ and JS.\n-const { async_hook_fields, async_id_fields } = async_wrap;\n const {\n   getDefaultTriggerAsyncId,\n-  // The needed emit*() functions.\n+  newAsyncId,\n+  initHooksExist,\n   emitInit\n } = require('internal/async_hooks');\n-// Grab the constants necessary for working with internal arrays.\n-const { kInit, kAsyncIdCounter } = async_wrap.constants;\n // Symbols for storing async id state.\n const async_id_symbol = Symbol('asyncId');\n const trigger_async_id_symbol = Symbol('triggerId');\n@@ -70,9 +66,9 @@ function Timeout(callback, after, args, isRepeat, isUnrefed) {\n \n   this[unrefedSymbol] = isUnrefed;\n \n-  this[async_id_symbol] = ++async_id_fields[kAsyncIdCounter];\n+  this[async_id_symbol] = newAsyncId();\n   this[trigger_async_id_symbol] = getDefaultTriggerAsyncId();\n-  if (async_hook_fields[kInit] > 0) {\n+  if (initHooksExist()) {\n     emitInit(this[async_id_symbol],\n              'Timeout',\n              this[trigger_async_id_symbol],"
        },
        {
            "sha": "9c7986ceb7086e97af68d35f3d3397b8ae522ba5",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -47,8 +47,11 @@ const { Pipe, constants: PipeConstants } = process.binding('pipe_wrap');\n const { TCPConnectWrap } = process.binding('tcp_wrap');\n const { PipeConnectWrap } = process.binding('pipe_wrap');\n const { ShutdownWrap, WriteWrap } = process.binding('stream_wrap');\n-const { async_id_symbol } = process.binding('async_wrap');\n-const { newUid, defaultTriggerAsyncIdScope } = require('internal/async_hooks');\n+const {\n+  newAsyncId,\n+  defaultTriggerAsyncIdScope,\n+  symbols: { async_id_symbol }\n+} = require('internal/async_hooks');\n const { nextTick } = require('internal/process/next_tick');\n const errors = require('internal/errors');\n const dns = require('dns');\n@@ -91,7 +94,7 @@ function createHandle(fd, is_server) {\n \n function getNewAsyncId(handle) {\n   return (!handle || typeof handle.getAsyncId !== 'function') ?\n-    newUid() : handle.getAsyncId();\n+    newAsyncId() : handle.getAsyncId();\n }\n \n "
        },
        {
            "sha": "145550b7b5666ba977910095c8d573e6f60899b0",
            "filename": "lib/timers.js",
            "status": "modified",
            "additions": 20,
            "deletions": 25,
            "changes": 45,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Ftimers.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/lib%2Ftimers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftimers.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -21,34 +21,34 @@\n \n 'use strict';\n \n-const async_wrap = process.binding('async_wrap');\n const {\n   Timer: TimerWrap,\n   setupTimers,\n } = process.binding('timer_wrap');\n const L = require('internal/linkedlist');\n-const timerInternals = require('internal/timers');\n+const {\n+  async_id_symbol,\n+  trigger_async_id_symbol,\n+  Timeout,\n+  validateTimerDuration\n+} = require('internal/timers');\n const internalUtil = require('internal/util');\n const { createPromise, promiseResolve } = process.binding('util');\n const assert = require('assert');\n const util = require('util');\n const errors = require('internal/errors');\n const debug = util.debuglog('timer');\n-// Two arrays that share state between C++ and JS.\n-const { async_hook_fields, async_id_fields } = async_wrap;\n const {\n   getDefaultTriggerAsyncId,\n+  newAsyncId,\n+  initHooksExist,\n+  destroyHooksExist,\n   // The needed emit*() functions.\n   emitInit,\n   emitBefore,\n   emitAfter,\n   emitDestroy\n } = require('internal/async_hooks');\n-// Grab the constants necessary for working with internal arrays.\n-const { kInit, kDestroy, kAsyncIdCounter } = async_wrap.constants;\n-// Symbols for storing async id state.\n-const async_id_symbol = timerInternals.async_id_symbol;\n-const trigger_async_id_symbol = timerInternals.trigger_async_id_symbol;\n \n // *Must* match Environment::ImmediateInfo::Fields in src/env.h.\n const kCount = 0;\n@@ -60,10 +60,6 @@ const [immediateInfo, toggleImmediateRef] =\n \n const kRefed = Symbol('refed');\n \n-// The Timeout class\n-const Timeout = timerInternals.Timeout;\n-\n-\n // HOW and WHY the timers implementation works the way it does.\n //\n // Timers are crucial to Node.js. Internally, any TCP I/O connection creates a\n@@ -192,9 +188,9 @@ function insert(item, unrefed, start) {\n \n   if (!item[async_id_symbol] || item._destroyed) {\n     item._destroyed = false;\n-    item[async_id_symbol] = ++async_id_fields[kAsyncIdCounter];\n+    item[async_id_symbol] = newAsyncId();\n     item[trigger_async_id_symbol] = getDefaultTriggerAsyncId();\n-    if (async_hook_fields[kInit] > 0) {\n+    if (initHooksExist()) {\n       emitInit(item[async_id_symbol],\n                'Timeout',\n                item[trigger_async_id_symbol],\n@@ -255,7 +251,7 @@ function listOnTimeout(handle, now) {\n     assert(timer !== L.peek(list));\n \n     if (!timer._onTimeout) {\n-      if (async_hook_fields[kDestroy] > 0 && !timer._destroyed &&\n+      if (destroyHooksExist() && !timer._destroyed &&\n             typeof timer[async_id_symbol] === 'number') {\n         emitDestroy(timer[async_id_symbol]);\n         timer._destroyed = true;\n@@ -306,7 +302,7 @@ function tryOnTimeout(timer, start) {\n     if (timerAsyncId !== null) {\n       if (!threw)\n         emitAfter(timerAsyncId);\n-      if (!timer._repeat && async_hook_fields[kDestroy] > 0 &&\n+      if (!timer._repeat && destroyHooksExist() &&\n           !timer._destroyed) {\n         emitDestroy(timerAsyncId);\n         timer._destroyed = true;\n@@ -341,8 +337,7 @@ function reuse(item) {\n // Remove a timer. Cancels the timeout and resets the relevant timer properties.\n function unenroll(item) {\n   // Fewer checks may be possible, but these cover everything.\n-  if (async_hook_fields[kDestroy] > 0 &&\n-      item &&\n+  if (destroyHooksExist() &&\n       typeof item[async_id_symbol] === 'number' &&\n       !item._destroyed) {\n     emitDestroy(item[async_id_symbol]);\n@@ -368,7 +363,7 @@ exports.unenroll = util.deprecate(unenroll,\n // This function does not start the timer, see `active()`.\n // Using existing objects as timers slightly reduces object overhead.\n function enroll(item, msecs) {\n-  item._idleTimeout = timerInternals.validateTimerDuration(msecs);\n+  item._idleTimeout = validateTimerDuration(msecs);\n \n   // if this item was already in a list somewhere\n   // then we should unenroll it from that\n@@ -574,7 +569,7 @@ Timeout.prototype.ref = function() {\n Timeout.prototype.close = function() {\n   this._onTimeout = null;\n   if (this._handle) {\n-    if (async_hook_fields[kDestroy] > 0 &&\n+    if (destroyHooksExist() &&\n         typeof this[async_id_symbol] === 'number' &&\n         !this._destroyed) {\n       emitDestroy(this[async_id_symbol]);\n@@ -684,7 +679,7 @@ function tryOnImmediate(immediate, oldTail, count, refCount) {\n   } finally {\n     immediate._onImmediate = null;\n \n-    if (async_hook_fields[kDestroy] > 0) {\n+    if (destroyHooksExist()) {\n       emitDestroy(immediate[async_id_symbol]);\n     }\n \n@@ -725,9 +720,9 @@ const Immediate = class Immediate {\n     this._destroyed = false;\n     this[kRefed] = false;\n \n-    this[async_id_symbol] = ++async_id_fields[kAsyncIdCounter];\n+    this[async_id_symbol] = newAsyncId();\n     this[trigger_async_id_symbol] = getDefaultTriggerAsyncId();\n-    if (async_hook_fields[kInit] > 0) {\n+    if (initHooksExist()) {\n       emitInit(this[async_id_symbol],\n                'Immediate',\n                this[trigger_async_id_symbol],\n@@ -807,7 +802,7 @@ exports.clearImmediate = function(immediate) {\n     toggleImmediateRef(false);\n   immediate[kRefed] = undefined;\n \n-  if (async_hook_fields[kDestroy] > 0) {\n+  if (destroyHooksExist()) {\n     emitDestroy(immediate[async_id_symbol]);\n   }\n "
        },
        {
            "sha": "7fa5f0ade9ade45fc8448ecbec8882b4f29e8887",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -47,7 +47,6 @@ using v8::PromiseHookType;\n using v8::PropertyCallbackInfo;\n using v8::RetainedObjectInfo;\n using v8::String;\n-using v8::Symbol;\n using v8::TryCatch;\n using v8::Undefined;\n using v8::Value;\n@@ -472,12 +471,6 @@ void AsyncWrap::PopAsyncIds(const FunctionCallbackInfo<Value>& args) {\n }\n \n \n-void AsyncWrap::ClearAsyncIdStack(const FunctionCallbackInfo<Value>& args) {\n-  Environment* env = Environment::GetCurrent(args);\n-  env->async_hooks()->clear_async_id_stack();\n-}\n-\n-\n void AsyncWrap::AsyncReset(const FunctionCallbackInfo<Value>& args) {\n   AsyncWrap* wrap;\n   ASSIGN_OR_RETURN_UNWRAP(&wrap, args.Holder());\n@@ -512,7 +505,6 @@ void AsyncWrap::Initialize(Local<Object> target,\n   env->SetMethod(target, \"setupHooks\", SetupHooks);\n   env->SetMethod(target, \"pushAsyncIds\", PushAsyncIds);\n   env->SetMethod(target, \"popAsyncIds\", PopAsyncIds);\n-  env->SetMethod(target, \"clearAsyncIdStack\", ClearAsyncIdStack);\n   env->SetMethod(target, \"queueDestroyAsyncId\", QueueDestroyAsyncId);\n   env->SetMethod(target, \"enablePromiseHook\", EnablePromiseHook);\n   env->SetMethod(target, \"disablePromiseHook\", DisablePromiseHook);\n@@ -581,17 +573,6 @@ void AsyncWrap::Initialize(Local<Object> target,\n #undef V\n   FORCE_SET_TARGET_FIELD(target, \"Providers\", async_providers);\n \n-  // These Symbols are used throughout node so the stored values on each object\n-  // can be accessed easily across files.\n-  FORCE_SET_TARGET_FIELD(\n-      target,\n-      \"async_id_symbol\",\n-      Symbol::New(isolate, FIXED_ONE_BYTE_STRING(isolate, \"asyncId\")));\n-  FORCE_SET_TARGET_FIELD(\n-      target,\n-      \"trigger_async_id_symbol\",\n-      Symbol::New(isolate, FIXED_ONE_BYTE_STRING(isolate, \"triggerAsyncId\")));\n-\n #undef FORCE_SET_TARGET_FIELD\n \n   env->set_async_hooks_init_function(Local<Function>());"
        },
        {
            "sha": "b7aed5d789754b6ec7c117403d02f4e74eebea40",
            "filename": "src/async_wrap.h",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/src%2Fasync_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/src%2Fasync_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.h?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -125,8 +125,6 @@ class AsyncWrap : public BaseObject {\n   static void GetAsyncId(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void PushAsyncIds(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void PopAsyncIds(const v8::FunctionCallbackInfo<v8::Value>& args);\n-  static void ClearAsyncIdStack(\n-    const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void AsyncReset(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void QueueDestroyAsyncId(\n     const v8::FunctionCallbackInfo<v8::Value>& args);"
        },
        {
            "sha": "2b2b0cba58cd2720e921db9dafe95372887f1c63",
            "filename": "src/env-inl.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/src%2Fenv-inl.h",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/src%2Fenv-inl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv-inl.h?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -172,6 +172,7 @@ inline bool Environment::AsyncHooks::pop_async_id(double async_id) {\n   return fields_[kStackLength] > 0;\n }\n \n+// Keep in sync with clearAsyncIdStack in lib/internal/async_hooks.js.\n inline void Environment::AsyncHooks::clear_async_id_stack() {\n   async_id_fields_[kExecutionAsyncId] = 0;\n   async_id_fields_[kTriggerAsyncId] = 0;"
        },
        {
            "sha": "e7744eb4b7bdf0e3aa6b28bb064d2002ef4bd335",
            "filename": "test/async-hooks/test-emit-before-after.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fasync-hooks%2Ftest-emit-before-after.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fasync-hooks%2Ftest-emit-before-after.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-emit-before-after.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -34,8 +34,8 @@ assert.strictEqual(\n   'RangeError [ERR_INVALID_ASYNC_ID]: Invalid triggerAsyncId value: -2');\n assert.strictEqual(c2.status, 1);\n \n-const expectedId = async_hooks.newUid();\n-const expectedTriggerId = async_hooks.newUid();\n+const expectedId = async_hooks.newAsyncId();\n+const expectedTriggerId = async_hooks.newAsyncId();\n const expectedType = 'test_emit_before_after_type';\n \n // Verify that if there is no registered hook, then nothing will happen."
        },
        {
            "sha": "f5d5687cb4d11dfd0a4a6736eee82a41a44d79b9",
            "filename": "test/async-hooks/test-emit-init.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fasync-hooks%2Ftest-emit-init.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fasync-hooks%2Ftest-emit-init.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-emit-init.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -7,8 +7,8 @@ const spawnSync = require('child_process').spawnSync;\n const async_hooks = require('internal/async_hooks');\n const initHooks = require('./init-hooks');\n \n-const expectedId = async_hooks.newUid();\n-const expectedTriggerId = async_hooks.newUid();\n+const expectedId = async_hooks.newAsyncId();\n+const expectedTriggerId = async_hooks.newAsyncId();\n const expectedType = 'test_emit_init_type';\n const expectedResource = { key: 'test_emit_init_resource' };\n "
        },
        {
            "sha": "a55858947337b27efad15df438d119b071cb9117",
            "filename": "test/parallel/test-async-hooks-http-agent.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fparallel%2Ftest-async-hooks-http-agent.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fparallel%2Ftest-async-hooks-http-agent.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-async-hooks-http-agent.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -1,7 +1,8 @@\n 'use strict';\n+// Flags: --expose-internals\n const common = require('../common');\n const assert = require('assert');\n-const async_id_symbol = process.binding('async_wrap').async_id_symbol;\n+const { async_id_symbol } = require('internal/async_hooks').symbols;\n const http = require('http');\n \n // Regression test for https://github.com/nodejs/node/issues/13325"
        },
        {
            "sha": "1c65d07ca50bfea893f92dbe1684d22544c62681",
            "filename": "test/parallel/test-http-client-immediate-error.js",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fparallel%2Ftest-http-client-immediate-error.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fparallel%2Ftest-http-client-immediate-error.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-client-immediate-error.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -9,8 +9,10 @@ const assert = require('assert');\n const net = require('net');\n const http = require('http');\n const uv = process.binding('uv');\n-const { async_id_symbol } = process.binding('async_wrap');\n-const { newUid } = require('internal/async_hooks');\n+const {\n+  newAsyncId,\n+  symbols: { async_id_symbol }\n+} = require('internal/async_hooks');\n \n const agent = new http.Agent();\n agent.createConnection = common.mustCall((cfg) => {\n@@ -26,7 +28,7 @@ agent.createConnection = common.mustCall((cfg) => {\n   };\n \n   // Simulate just enough socket handle initialization\n-  sock[async_id_symbol] = newUid();\n+  sock[async_id_symbol] = newAsyncId();\n \n   sock.connect(cfg);\n   return sock;"
        },
        {
            "sha": "e2daa1cf3651ed5c46e8dd02c73150609046cc52",
            "filename": "test/parallel/test-process-geteuid-getegid.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fparallel%2Ftest-process-geteuid-getegid.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fparallel%2Ftest-process-geteuid-getegid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-geteuid-getegid.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -44,5 +44,5 @@ assert.notStrictEqual(newgid, oldgid);\n \n const olduid = process.geteuid();\n process.seteuid('nobody');\n-const newuid = process.geteuid();\n-assert.notStrictEqual(newuid, olduid);\n+const newAsyncId = process.geteuid();\n+assert.notStrictEqual(newAsyncId, olduid);"
        },
        {
            "sha": "30640b277a2f8a4dff01357da888049408bda812",
            "filename": "test/parallel/test-process-setuid-setgid.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fparallel%2Ftest-process-setuid-setgid.js",
            "raw_url": "https://github.com/nodejs/node/raw/e9ac80bb397293feef3b47f3ed609c86edb48681/test%2Fparallel%2Ftest-process-setuid-setgid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-setuid-setgid.js?ref=e9ac80bb397293feef3b47f3ed609c86edb48681",
            "patch": "@@ -63,5 +63,5 @@ assert.notStrictEqual(newgid, oldgid);\n \n const olduid = process.getuid();\n process.setuid('nobody');\n-const newuid = process.getuid();\n-assert.notStrictEqual(newuid, olduid);\n+const newAsyncId = process.getuid();\n+assert.notStrictEqual(newAsyncId, olduid);"
        }
    ],
    "stats": {
        "total": 263,
        "additions": 141,
        "deletions": 122
    }
}