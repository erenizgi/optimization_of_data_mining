{
    "author": "vsemozhetbyt",
    "message": "tools: simplify HTML generation\n\nPR-URL: https://github.com/nodejs/node/pull/20307\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "ad6a65ba110932d5af187b8422ce2cdb808a4a2f",
    "files": [
        {
            "sha": "b3e65cec6030a90e8857a7f703c9cafcdce21be6",
            "filename": "Makefile",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/ad6a65ba110932d5af187b8422ce2cdb808a4a2f/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/ad6a65ba110932d5af187b8422ce2cdb808a4a2f/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=ad6a65ba110932d5af187b8422ce2cdb808a4a2f",
            "patch": "@@ -652,7 +652,7 @@ tools/doc/node_modules/js-yaml/package.json:\n \n gen-json = tools/doc/generate.js --format=json $< > $@\n gen-html = tools/doc/generate.js --node-version=$(FULLVERSION) --format=html \\\n-\t\t\t--template=doc/template.html --analytics=$(DOCS_ANALYTICS) $< > $@\n+\t\t\t--analytics=$(DOCS_ANALYTICS) $< > $@\n \n out/doc/api/%.json: doc/api/%.md\n \t$(call available-node, $(gen-json))"
        },
        {
            "sha": "91037bfd6501bc20e43c2109ea48d6097728b7af",
            "filename": "test/doctool/test-doctool-html.js",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/ad6a65ba110932d5af187b8422ce2cdb808a4a2f/test%2Fdoctool%2Ftest-doctool-html.js",
            "raw_url": "https://github.com/nodejs/node/raw/ad6a65ba110932d5af187b8422ce2cdb808a4a2f/test%2Fdoctool%2Ftest-doctool-html.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fdoctool%2Ftest-doctool-html.js?ref=ad6a65ba110932d5af187b8422ce2cdb808a4a2f",
            "patch": "@@ -10,7 +10,6 @@ try {\n \n const assert = require('assert');\n const fs = require('fs');\n-const path = require('path');\n const fixtures = require('../common/fixtures');\n const processIncludes = require('../../tools/doc/preprocess.js');\n const html = require('../../tools/doc/html.js');\n@@ -107,7 +106,6 @@ testData.forEach((item) => {\n         {\n           input: preprocessed,\n           filename: 'foo',\n-          template: path.resolve(__dirname, '../../doc/template.html'),\n           nodeVersion: process.version,\n           analytics: item.analyticsId,\n         },"
        },
        {
            "sha": "9f217b19c7225f1a6921a09a137bc57f78e51ed7",
            "filename": "tools/doc/generate.js",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/ad6a65ba110932d5af187b8422ce2cdb808a4a2f/tools%2Fdoc%2Fgenerate.js",
            "raw_url": "https://github.com/nodejs/node/raw/ad6a65ba110932d5af187b8422ce2cdb808a4a2f/tools%2Fdoc%2Fgenerate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fgenerate.js?ref=ad6a65ba110932d5af187b8422ce2cdb808a4a2f",
            "patch": "@@ -29,7 +29,6 @@ const fs = require('fs');\n \n const args = process.argv.slice(2);\n let format = 'json';\n-let template = null;\n let filename = null;\n let nodeVersion = null;\n let analytics = null;\n@@ -39,8 +38,6 @@ args.forEach(function(arg) {\n     filename = arg;\n   } else if (arg.startsWith('--format=')) {\n     format = arg.replace(/^--format=/, '');\n-  } else if (arg.startsWith('--template=')) {\n-    template = arg.replace(/^--template=/, '');\n   } else if (arg.startsWith('--node-version=')) {\n     nodeVersion = arg.replace(/^--node-version=/, '');\n   } else if (arg.startsWith('--analytics=')) {\n@@ -71,7 +68,7 @@ function next(er, input) {\n       break;\n \n     case 'html':\n-      require('./html')({ input, filename, template, nodeVersion, analytics },\n+      require('./html')({ input, filename, nodeVersion, analytics },\n                         (err, html) => {\n                           if (err) throw err;\n                           console.log(html);"
        },
        {
            "sha": "439fc057012ca7d9d8fc785b572c360180b939d9",
            "filename": "tools/doc/html.js",
            "status": "modified",
            "additions": 22,
            "deletions": 63,
            "changes": 85,
            "blob_url": "https://github.com/nodejs/node/blob/ad6a65ba110932d5af187b8422ce2cdb808a4a2f/tools%2Fdoc%2Fhtml.js",
            "raw_url": "https://github.com/nodejs/node/raw/ad6a65ba110932d5af187b8422ce2cdb808a4a2f/tools%2Fdoc%2Fhtml.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdoc%2Fhtml.js?ref=ad6a65ba110932d5af187b8422ce2cdb808a4a2f",
            "patch": "@@ -25,7 +25,6 @@ const common = require('./common.js');\n const fs = require('fs');\n const marked = require('marked');\n const path = require('path');\n-const preprocess = require('./preprocess.js');\n const typeParser = require('./type-parser.js');\n \n module.exports = toHTML;\n@@ -42,76 +41,36 @@ marked.setOptions({\n   renderer: renderer\n });\n \n-// TODO(chrisdickinson): never stop vomiting / fix this.\n-const gtocPath = path.resolve(path.join(\n-  __dirname,\n-  '..',\n-  '..',\n-  'doc',\n-  'api',\n-  '_toc.md'\n-));\n-var gtocLoading = null;\n-var gtocData = null;\n+const docPath = path.resolve(__dirname, '..', '..', 'doc');\n+\n+const gtocPath = path.join(docPath, 'api', '_toc.md');\n+const gtocMD = fs.readFileSync(gtocPath, 'utf8').replace(/^@\\/\\/.*$/gm, '');\n+const gtocHTML = marked(gtocMD).replace(\n+  /<a href=\"(.*?)\"/g,\n+  (all, href) => `<a class=\"nav-${toID(href)}\" href=\"${href}\"`\n+);\n+\n+const templatePath = path.join(docPath, 'template.html');\n+const template = fs.readFileSync(templatePath, 'utf8');\n+\n var docCreated = null;\n var nodeVersion = null;\n \n /**\n- * opts: input, filename, template, nodeVersion.\n+ * opts: input, filename, nodeVersion.\n  */\n function toHTML(opts, cb) {\n-  const template = opts.template;\n-\n   nodeVersion = opts.nodeVersion || process.version;\n   docCreated = opts.input.match(DOC_CREATED_REG_EXP);\n \n-  if (gtocData) {\n-    return onGtocLoaded();\n-  }\n-\n-  if (gtocLoading === null) {\n-    gtocLoading = [onGtocLoaded];\n-    return loadGtoc(function(err, data) {\n-      if (err) throw err;\n-      gtocData = data;\n-      gtocLoading.forEach(function(xs) {\n-        xs();\n-      });\n-    });\n-  }\n-\n-  if (gtocLoading) {\n-    return gtocLoading.push(onGtocLoaded);\n-  }\n-\n-  function onGtocLoaded() {\n-    const lexed = marked.lexer(opts.input);\n-    fs.readFile(template, 'utf8', function(er, template) {\n-      if (er) return cb(er);\n-      render({\n-        lexed: lexed,\n-        filename: opts.filename,\n-        template: template,\n-        nodeVersion: nodeVersion,\n-        analytics: opts.analytics,\n-      }, cb);\n-    });\n-  }\n-}\n-\n-function loadGtoc(cb) {\n-  fs.readFile(gtocPath, 'utf8', function(err, data) {\n-    if (err) return cb(err);\n-\n-    preprocess(gtocPath, data, function(err, data) {\n-      if (err) return cb(err);\n-\n-      data = marked(data).replace(/<a href=\"(.*?)\"/gm, function(a, m) {\n-        return `<a class=\"nav-${toID(m)}\" href=\"${m}\"`;\n-      });\n-      return cb(null, data);\n-    });\n-  });\n+  const lexed = marked.lexer(opts.input);\n+  render({\n+    lexed: lexed,\n+    filename: opts.filename,\n+    template: template,\n+    nodeVersion: nodeVersion,\n+    analytics: opts.analytics,\n+  }, cb);\n }\n \n function toID(filename) {\n@@ -150,7 +109,7 @@ function render(opts, cb) {\n     template = template.replace(/__TOC__/g, toc);\n     template = template.replace(\n       /__GTOC__/g,\n-      gtocData.replace(`class=\"nav-${id}`, `class=\"nav-${id} active`)\n+      gtocHTML.replace(`class=\"nav-${id}`, `class=\"nav-${id} active`)\n     );\n \n     if (opts.analytics) {"
        }
    ],
    "stats": {
        "total": 94,
        "additions": 24,
        "deletions": 70
    }
}