{
    "author": "addaleax",
    "message": "process: fix reading zero-length env vars on win32\n\nUp until now, Node did not clear the current error code\nattempting to read environment variables on Windows.\nSince checking the error code is the way we distinguish between\nmissing and zero-length environment variables, this could lead to a\nfalse positive when the error code was still tainted.\n\nIn the simplest case, accessing a missing variable and then a\nzero-length one would lead Node to believe that both calls yielded\nan error.\n\nBefore:\n\n    > process.env.I=''; process.env.Q; process.env.I\n    undefined\n    > process.env.I=''; /*process.env.Q;*/ process.env.I\n    ''\n\nAfter:\n\n    > process.env.I=''; process.env.Q; process.env.I\n    ''\n    > process.env.I=''; /*process.env.Q;*/ process.env.I\n    ''\n\nThis only affects Node 8 and above, since before\n1aa595e5bd64241451b3884d3029b9b9aa97c42d we always constructed a\n`v8::String::Value` instance for passing the lookup key to the OS,\nwhich in in turn always made a heap allocation and therefore\nreset the error code.\n\nPR-URL: https://github.com/nodejs/node/pull/18463\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: Fedor Indutny <fedor.indutny@gmail.com>\nReviewed-By: Tobias Nießen <tniessen@tnie.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Michaël Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "6acb1a3df59222ae44e2848b76c91a72f7942360",
    "files": [
        {
            "sha": "dfe4125bd092fe46636f02a9f62c18ed6cf7deee",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/6acb1a3df59222ae44e2848b76c91a72f7942360/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/6acb1a3df59222ae44e2848b76c91a72f7942360/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=6acb1a3df59222ae44e2848b76c91a72f7942360",
            "patch": "@@ -2603,6 +2603,7 @@ static void EnvGetter(Local<Name> property,\n #else  // _WIN32\n   node::TwoByteValue key(isolate, property);\n   WCHAR buffer[32767];  // The maximum size allowed for environment variables.\n+  SetLastError(ERROR_SUCCESS);\n   DWORD result = GetEnvironmentVariableW(reinterpret_cast<WCHAR*>(*key),\n                                          buffer,\n                                          arraysize(buffer));\n@@ -2651,6 +2652,7 @@ static void EnvQuery(Local<Name> property,\n #else  // _WIN32\n     node::TwoByteValue key(info.GetIsolate(), property);\n     WCHAR* key_ptr = reinterpret_cast<WCHAR*>(*key);\n+    SetLastError(ERROR_SUCCESS);\n     if (GetEnvironmentVariableW(key_ptr, nullptr, 0) > 0 ||\n         GetLastError() == ERROR_SUCCESS) {\n       rc = 0;"
        },
        {
            "sha": "59e5f287d823460e2cdaf76bde36e932f71ed994",
            "filename": "test/parallel/test-process-env-windows-error-reset.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/6acb1a3df59222ae44e2848b76c91a72f7942360/test%2Fparallel%2Ftest-process-env-windows-error-reset.js",
            "raw_url": "https://github.com/nodejs/node/raw/6acb1a3df59222ae44e2848b76c91a72f7942360/test%2Fparallel%2Ftest-process-env-windows-error-reset.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-env-windows-error-reset.js?ref=6acb1a3df59222ae44e2848b76c91a72f7942360",
            "patch": "@@ -0,0 +1,22 @@\n+'use strict';\n+require('../common');\n+const assert = require('assert');\n+\n+// This checks that after accessing a missing env var, a subsequent\n+// env read will succeed even for empty variables.\n+\n+{\n+  process.env.FOO = '';\n+  process.env.NONEXISTENT_ENV_VAR;\n+  const foo = process.env.FOO;\n+\n+  assert.strictEqual(foo, '');\n+}\n+\n+{\n+  process.env.FOO = '';\n+  process.env.NONEXISTENT_ENV_VAR;\n+  const hasFoo = 'FOO' in process.env;\n+\n+  assert.strictEqual(hasFoo, true);\n+}"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 24,
        "deletions": 0
    }
}