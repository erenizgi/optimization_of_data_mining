{
    "author": "mafintosh",
    "message": "stream: defer readable and flow when sync\n\nPR-URL: https://github.com/nodejs/node/pull/18515\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "563fff2938110065589a3dc1b34692670206e4e4",
    "files": [
        {
            "sha": "dd483adb4104983402e6e4b773fe5d0b47e6034f",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/563fff2938110065589a3dc1b34692670206e4e4/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/563fff2938110065589a3dc1b34692670206e4e4/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=563fff2938110065589a3dc1b34692670206e4e4",
            "patch": "@@ -486,11 +486,18 @@ function onEofChunk(stream, state) {\n   }\n   state.ended = true;\n \n-  // emit 'readable' now to make sure it gets picked up.\n-  state.needReadable = false;\n-  if (!state.emittedReadable) {\n-    state.emittedReadable = true;\n-    emitReadable_(stream);\n+  if (state.sync && state.length) {\n+    // if we are sync and have data in the buffer, wait until next tick\n+    // to emit the data. otherwise we risk emitting data in the flow()\n+    // the readable code triggers during a read() call\n+    emitReadable(stream);\n+  } else {\n+    // emit 'readable' now to make sure it gets picked up.\n+    state.needReadable = false;\n+    if (!state.emittedReadable) {\n+      state.emittedReadable = true;\n+      emitReadable_(stream);\n+    }\n   }\n }\n "
        },
        {
            "sha": "1f8564182a31072ee9d3c36ed6e8ca125ab2ada8",
            "filename": "test/parallel/test-stream-pipe-flow.js",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/nodejs/node/blob/563fff2938110065589a3dc1b34692670206e4e4/test%2Fparallel%2Ftest-stream-pipe-flow.js",
            "raw_url": "https://github.com/nodejs/node/raw/563fff2938110065589a3dc1b34692670206e4e4/test%2Fparallel%2Ftest-stream-pipe-flow.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-pipe-flow.js?ref=563fff2938110065589a3dc1b34692670206e4e4",
            "patch": "@@ -0,0 +1,67 @@\n+'use strict';\n+const common = require('../common');\n+const { Readable, Writable, PassThrough } = require('stream');\n+\n+{\n+  let ticks = 17;\n+\n+  const rs = new Readable({\n+    objectMode: true,\n+    read: () => {\n+      if (ticks-- > 0)\n+        return process.nextTick(() => rs.push({}));\n+      rs.push({});\n+      rs.push(null);\n+    }\n+  });\n+\n+  const ws = new Writable({\n+    highWaterMark: 0,\n+    objectMode: true,\n+    write: (data, end, cb) => setImmediate(cb)\n+  });\n+\n+  rs.on('end', common.mustCall());\n+  ws.on('finish', common.mustCall());\n+  rs.pipe(ws);\n+}\n+\n+{\n+  let missing = 8;\n+\n+  const rs = new Readable({\n+    objectMode: true,\n+    read: () => {\n+      if (missing--) rs.push({});\n+      else rs.push(null);\n+    }\n+  });\n+\n+  const pt = rs\n+    .pipe(new PassThrough({ objectMode: true, highWaterMark: 2 }))\n+    .pipe(new PassThrough({ objectMode: true, highWaterMark: 2 }));\n+\n+  pt.on('end', function() {\n+    wrapper.push(null);\n+  });\n+\n+  const wrapper = new Readable({\n+    objectMode: true,\n+    read: () => {\n+      process.nextTick(function() {\n+        let data = pt.read();\n+        if (data === null) {\n+          pt.once('readable', function() {\n+            data = pt.read();\n+            if (data !== null) wrapper.push(data);\n+          });\n+        } else {\n+          wrapper.push(data);\n+        }\n+      });\n+    }\n+  });\n+\n+  wrapper.resume();\n+  wrapper.on('end', common.mustCall());\n+}"
        },
        {
            "sha": "505327e247da38581192730c897c9b8413f049f1",
            "filename": "test/parallel/test-stream-readable-pause-and-resume.js",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/563fff2938110065589a3dc1b34692670206e4e4/test%2Fparallel%2Ftest-stream-readable-pause-and-resume.js",
            "raw_url": "https://github.com/nodejs/node/raw/563fff2938110065589a3dc1b34692670206e4e4/test%2Fparallel%2Ftest-stream-readable-pause-and-resume.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-pause-and-resume.js?ref=563fff2938110065589a3dc1b34692670206e4e4",
            "patch": "@@ -0,0 +1,40 @@\n+'use strict';\n+\n+const { Readable } = require('stream');\n+const common = require('../common');\n+\n+let ticks = 18;\n+let expectedData = 19;\n+\n+const rs = new Readable({\n+  objectMode: true,\n+  read: () => {\n+    if (ticks-- > 0)\n+      return process.nextTick(() => rs.push({}));\n+    rs.push({});\n+    rs.push(null);\n+  }\n+});\n+\n+rs.on('end', common.mustCall());\n+readAndPause();\n+\n+function readAndPause() {\n+  // Does a on(data) -> pause -> wait -> resume -> on(data) ... loop.\n+  // Expects on(data) to never fire if the stream is paused.\n+  const ondata = common.mustCall((data) => {\n+    rs.pause();\n+\n+    expectedData--;\n+    if (expectedData <= 0)\n+      return;\n+\n+    setImmediate(function() {\n+      rs.removeListener('data', ondata);\n+      readAndPause();\n+      rs.resume();\n+    });\n+  }, 1); // only call ondata once\n+\n+  rs.on('data', ondata);\n+}"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 119,
        "deletions": 5
    }
}