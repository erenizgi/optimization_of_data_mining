{
    "author": "BridgeAR",
    "message": "util: improve internal `isError()` validation\n\nThe current internal isError function checked the toString value\ninstead of using the more precise `util.types.isNativeError()` check.\nThe `instanceof` check is not removed due to possible errors that\nare not native but still an instance of Error.\n\nPR-URL: https://github.com/nodejs/node/pull/24746\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "2b5f2bc68b67621b42f6a698792532d1149e6196",
    "files": [
        {
            "sha": "ee550fad2e621cd243cae44117714e3e66754851",
            "filename": "lib/internal/util.js",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/2b5f2bc68b67621b42f6a698792532d1149e6196/lib%2Finternal%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b5f2bc68b67621b42f6a698792532d1149e6196/lib%2Finternal%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Futil.js?ref=2b5f2bc68b67621b42f6a698792532d1149e6196",
            "patch": "@@ -12,6 +12,9 @@ const {\n   arrow_message_private_symbol: kArrowMessagePrivateSymbolIndex,\n   decorated_private_symbol: kDecoratedPrivateSymbolIndex\n } = internalBinding('util');\n+const {\n+  isNativeError\n+} = internalBinding('types');\n \n const { errmap } = internalBinding('uv');\n \n@@ -26,7 +29,10 @@ function removeColors(str) {\n }\n \n function isError(e) {\n-  return objectToString(e) === '[object Error]' || e instanceof Error;\n+  // An error could be an instance of Error while not being a native error\n+  // or could be from a different realm and not be instance of Error but still\n+  // be a native error.\n+  return isNativeError(e) || e instanceof Error;\n }\n \n function objectToString(o) {"
        },
        {
            "sha": "8f7f3a92ddcf6f702908e09e808543be42747489",
            "filename": "lib/util.js",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/2b5f2bc68b67621b42f6a698792532d1149e6196/lib%2Futil.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b5f2bc68b67621b42f6a698792532d1149e6196/lib%2Futil.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Futil.js?ref=2b5f2bc68b67621b42f6a698792532d1149e6196",
            "patch": "@@ -42,10 +42,16 @@ const {\n const {\n   deprecate,\n   getSystemErrorName: internalErrorName,\n-  isError,\n   promisify,\n } = require('internal/util');\n \n+const ReflectApply = Reflect.apply;\n+\n+function uncurryThis(func) {\n+  return (thisArg, ...args) => ReflectApply(func, thisArg, args);\n+}\n+const objectToString = uncurryThis(Object.prototype.toString);\n+\n let CIRCULAR_ERROR_MESSAGE;\n let internalDeepEqual;\n \n@@ -443,7 +449,9 @@ module.exports = exports = {\n   isRegExp,\n   isObject,\n   isDate,\n-  isError,\n+  isError(e) {\n+    return objectToString(e) === '[object Error]' || e instanceof Error;\n+  },\n   isFunction,\n   isPrimitive,\n   log,"
        },
        {
            "sha": "bf60cff9bda4be1c6554aa68d3120c62e7b9a9f5",
            "filename": "test/parallel/test-internal-util-helpers.js",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/2b5f2bc68b67621b42f6a698792532d1149e6196/test%2Fparallel%2Ftest-internal-util-helpers.js",
            "raw_url": "https://github.com/nodejs/node/raw/2b5f2bc68b67621b42f6a698792532d1149e6196/test%2Fparallel%2Ftest-internal-util-helpers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-internal-util-helpers.js?ref=2b5f2bc68b67621b42f6a698792532d1149e6196",
            "patch": "@@ -0,0 +1,37 @@\n+// Flags: --expose-internals\n+'use strict';\n+\n+require('../common');\n+const assert = require('assert');\n+const { types } = require('util');\n+const { isError } = require('internal/util');\n+const vm = require('vm');\n+\n+// Special cased errors. Test the internal function which is used in\n+// `util.inspect()`, the `repl` and maybe more. This verifies that errors from\n+// different realms, and non native instances of error are properly detected as\n+// error while definitely false ones are not detected. This is different than\n+// the public `util.isError()` function which falsy detects the fake errors as\n+// actual errors.\n+{\n+  const fake = { [Symbol.toStringTag]: 'Error' };\n+  assert(!types.isNativeError(fake));\n+  assert(!(fake instanceof Error));\n+  assert(!isError(fake));\n+\n+  const err = new Error('test');\n+  const newErr = Object.create(\n+    Object.getPrototypeOf(err),\n+    Object.getOwnPropertyDescriptors(err));\n+  Object.defineProperty(err, 'message', { value: err.message });\n+  assert(types.isNativeError(err));\n+  assert(!types.isNativeError(newErr));\n+  assert(newErr instanceof Error);\n+  assert(isError(newErr));\n+\n+  const context = vm.createContext({});\n+  const differentRealmErr = vm.runInContext('new Error()', context);\n+  assert(types.isNativeError(differentRealmErr));\n+  assert(!(differentRealmErr instanceof Error));\n+  assert(isError(differentRealmErr));\n+}"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 54,
        "deletions": 3
    }
}