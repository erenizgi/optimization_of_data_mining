{
    "author": "lundibundi",
    "message": "stream: fix readable behavior for highWaterMark === 0\n\nAvoid trying to emit 'readable' due to the fact that\nstate.length is always >= state.highWaterMark if highWaterMark is 0.\nTherefore upon .read(0) call (through .on('readable')) stream assumed\nthat it has enough data to emit 'readable' even though\nstate.length === 0 instead of issuing _read(). Which led to the TTY\nnot recognizing that someone is waiting for the input.\n\nFixes: https://github.com/nodejs/node/issues/20503\nRefs: https://github.com/nodejs/node/pull/18372\n\nPR-URL: https://github.com/nodejs/node/pull/21690\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "fe47b8b6a529233ada74dfb979e6164111737fc2",
    "files": [
        {
            "sha": "029faaa6142d96208953b8a13ad82cb3ad350f18",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/fe47b8b6a529233ada74dfb979e6164111737fc2/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/fe47b8b6a529233ada74dfb979e6164111737fc2/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=fe47b8b6a529233ada74dfb979e6164111737fc2",
            "patch": "@@ -383,7 +383,10 @@ Readable.prototype.read = function(n) {\n   // the 'readable' event and move on.\n   if (n === 0 &&\n       state.needReadable &&\n-      (state.length >= state.highWaterMark || state.ended)) {\n+      ((state.highWaterMark !== 0 ?\n+        state.length >= state.highWaterMark :\n+        state.length > 0) ||\n+       state.ended)) {\n     debug('read: emitReadable', state.length, state.ended);\n     if (state.length === 0 && state.ended)\n       endReadable(this);\n@@ -808,6 +811,7 @@ Readable.prototype.on = function(ev, fn) {\n     if (!state.endEmitted && !state.readableListening) {\n       state.readableListening = state.needReadable = true;\n       state.emittedReadable = false;\n+      debug('on readable', state.length, state.reading);\n       if (state.length) {\n         emitReadable(this);\n       } else if (!state.reading) {"
        },
        {
            "sha": "0969d49aa48e9852379e0e2cd9f570631701b2e6",
            "filename": "test/parallel/test-readable-single-end.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/fe47b8b6a529233ada74dfb979e6164111737fc2/test%2Fparallel%2Ftest-readable-single-end.js",
            "raw_url": "https://github.com/nodejs/node/raw/fe47b8b6a529233ada74dfb979e6164111737fc2/test%2Fparallel%2Ftest-readable-single-end.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-readable-single-end.js?ref=fe47b8b6a529233ada74dfb979e6164111737fc2",
            "patch": "@@ -0,0 +1,16 @@\n+'use strict';\n+\n+const common = require('../common');\n+const { Readable } = require('stream');\n+\n+// This test ensures that there will not be an additional empty 'readable'\n+// event when stream has ended (only 1 event signalling about end)\n+\n+const r = new Readable({\n+  read: () => {},\n+});\n+\n+r.push(null);\n+\n+r.on('readable', common.mustCall());\n+r.on('end', common.mustCall());"
        },
        {
            "sha": "ecbc197d48208faf7906eb709fe3d8a2b02debe0",
            "filename": "test/parallel/test-stream-readable-hwm-0.js",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/fe47b8b6a529233ada74dfb979e6164111737fc2/test%2Fparallel%2Ftest-stream-readable-hwm-0.js",
            "raw_url": "https://github.com/nodejs/node/raw/fe47b8b6a529233ada74dfb979e6164111737fc2/test%2Fparallel%2Ftest-stream-readable-hwm-0.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-hwm-0.js?ref=fe47b8b6a529233ada74dfb979e6164111737fc2",
            "patch": "@@ -0,0 +1,30 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+// This test ensures that Readable stream will call _read() for streams\n+// with highWaterMark === 0 upon .read(0) instead of just trying to\n+// emit 'readable' event.\n+\n+const assert = require('assert');\n+const { Readable } = require('stream');\n+\n+const r = new Readable({\n+  // must be called only once upon setting 'readable' listener\n+  read: common.mustCall(),\n+  highWaterMark: 0,\n+});\n+\n+let pushedNull = false;\n+// this will trigger read(0) but must only be called after push(null)\n+// because the we haven't pushed any data\n+r.on('readable', common.mustCall(() => {\n+  assert.strictEqual(r.read(), null);\n+  assert.strictEqual(pushedNull, true);\n+}));\n+r.on('end', common.mustCall());\n+process.nextTick(() => {\n+  assert.strictEqual(r.read(), null);\n+  pushedNull = true;\n+  r.push(null);\n+});"
        },
        {
            "sha": "4cf0b9fb2963f9990b7e80fa7c345c633eed6744",
            "filename": "test/pseudo-tty/test-readable-tty-keepalive.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/fe47b8b6a529233ada74dfb979e6164111737fc2/test%2Fpseudo-tty%2Ftest-readable-tty-keepalive.js",
            "raw_url": "https://github.com/nodejs/node/raw/fe47b8b6a529233ada74dfb979e6164111737fc2/test%2Fpseudo-tty%2Ftest-readable-tty-keepalive.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-readable-tty-keepalive.js?ref=fe47b8b6a529233ada74dfb979e6164111737fc2",
            "patch": "@@ -0,0 +1,29 @@\n+'use strict';\n+\n+const common = require('../common');\n+const assert = require('assert');\n+\n+// This test ensures that Node.js will not ignore tty 'readable' subscribers\n+// when it's the only tty subscriber and the only thing keeping event loop alive\n+// https://github.com/nodejs/node/issues/20503\n+\n+process.stdin.setEncoding('utf8');\n+\n+const expectedInput = ['foo', 'bar', null];\n+\n+process.stdin.on('readable', common.mustCall(function() {\n+  const data = process.stdin.read();\n+  assert.strictEqual(data, expectedInput.shift());\n+}, 3)); // first 2 data, then end\n+\n+process.stdin.on('end', common.mustCall());\n+\n+setTimeout(() => {\n+  process.stdin.push('foo');\n+  process.nextTick(() => {\n+    process.stdin.push('bar');\n+    process.nextTick(() => {\n+      process.stdin.push(null);\n+    });\n+  });\n+}, 1);"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "test/pseudo-tty/test-readable-tty-keepalive.out",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/nodejs/node/blob/fe47b8b6a529233ada74dfb979e6164111737fc2/test%2Fpseudo-tty%2Ftest-readable-tty-keepalive.out",
            "raw_url": "https://github.com/nodejs/node/raw/fe47b8b6a529233ada74dfb979e6164111737fc2/test%2Fpseudo-tty%2Ftest-readable-tty-keepalive.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-readable-tty-keepalive.out?ref=fe47b8b6a529233ada74dfb979e6164111737fc2"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 80,
        "deletions": 1
    }
}