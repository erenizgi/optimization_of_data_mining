{
    "author": "mcollina",
    "message": "doc: make sure that calls to .read() are looped\n\nThe 'readable' event assumes that calls to readable.read() happens\nwithin that event handler until readable.read() returns null.\n\nFixes: https://github.com/nodejs/node/issues/20503\nPR-URL: https://github.com/nodejs/node/pull/25375\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "2d2f82c4139f43dc3a657903aa23a641779d6ed0",
    "files": [
        {
            "sha": "4f28095a927970fce62d53739a26db8d02eea830",
            "filename": "doc/api/buffer.md",
            "status": "modified",
            "additions": 16,
            "deletions": 14,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/2d2f82c4139f43dc3a657903aa23a641779d6ed0/doc%2Fapi%2Fbuffer.md",
            "raw_url": "https://github.com/nodejs/node/raw/2d2f82c4139f43dc3a657903aa23a641779d6ed0/doc%2Fapi%2Fbuffer.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fbuffer.md?ref=2d2f82c4139f43dc3a657903aa23a641779d6ed0",
            "patch": "@@ -641,15 +641,16 @@ then copying out the relevant bits.\n const store = [];\n \n socket.on('readable', () => {\n-  const data = socket.read();\n+  let data;\n+  while (null !== (data = readable.read())) {\n+    // Allocate for retained data\n+    const sb = Buffer.allocUnsafeSlow(10);\n \n-  // Allocate for retained data\n-  const sb = Buffer.allocUnsafeSlow(10);\n+    // Copy the data into the new allocation\n+    data.copy(sb, 0, 0, 10);\n \n-  // Copy the data into the new allocation\n-  data.copy(sb, 0, 0, 10);\n-\n-  store.push(sb);\n+    store.push(sb);\n+  }\n });\n ```\n \n@@ -2561,15 +2562,16 @@ un-pooled `Buffer` instance using `SlowBuffer` then copy out the relevant bits.\n const store = [];\n \n socket.on('readable', () => {\n-  const data = socket.read();\n+  let data;\n+  while (null !== (data = readable.read())) {\n+    // Allocate for retained data\n+    const sb = SlowBuffer(10);\n \n-  // Allocate for retained data\n-  const sb = SlowBuffer(10);\n+    // Copy the data into the new allocation\n+    data.copy(sb, 0, 0, 10);\n \n-  // Copy the data into the new allocation\n-  data.copy(sb, 0, 0, 10);\n-\n-  store.push(sb);\n+    store.push(sb);\n+  }\n });\n ```\n "
        },
        {
            "sha": "54bbf7794e17504d0a821c6d3ae45b6f0c3f7ed1",
            "filename": "doc/api/crypto.md",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/nodejs/node/blob/2d2f82c4139f43dc3a657903aa23a641779d6ed0/doc%2Fapi%2Fcrypto.md",
            "raw_url": "https://github.com/nodejs/node/raw/2d2f82c4139f43dc3a657903aa23a641779d6ed0/doc%2Fapi%2Fcrypto.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcrypto.md?ref=2d2f82c4139f43dc3a657903aa23a641779d6ed0",
            "patch": "@@ -200,9 +200,10 @@ const cipher = crypto.createCipheriv(algorithm, key, iv);\n \n let encrypted = '';\n cipher.on('readable', () => {\n-  const data = cipher.read();\n-  if (data)\n-    encrypted += data.toString('hex');\n+  let chunk;\n+  while (null !== (chunk = cipher.read())) {\n+    encrypted += chunk.toString('hex');\n+  }\n });\n cipher.on('end', () => {\n   console.log(encrypted);\n@@ -383,9 +384,9 @@ const decipher = crypto.createDecipheriv(algorithm, key, iv);\n \n let decrypted = '';\n decipher.on('readable', () => {\n-  const data = decipher.read();\n-  if (data)\n-    decrypted += data.toString('utf8');\n+  while (null !== (chunk = decipher.read())) {\n+    decrypted += chunk.toString('utf8');\n+  }\n });\n decipher.on('end', () => {\n   console.log(decrypted);\n@@ -941,6 +942,8 @@ const crypto = require('crypto');\n const hash = crypto.createHash('sha256');\n \n hash.on('readable', () => {\n+  // Only one element is going to be produced by the\n+  // hash stream.\n   const data = hash.read();\n   if (data) {\n     console.log(data.toString('hex'));\n@@ -1033,6 +1036,8 @@ const crypto = require('crypto');\n const hmac = crypto.createHmac('sha256', 'a secret');\n \n hmac.on('readable', () => {\n+  // Only one element is going to be produced by the\n+  // hash stream.\n   const data = hmac.read();\n   if (data) {\n     console.log(data.toString('hex'));\n@@ -1762,6 +1767,8 @@ const hash = crypto.createHash('sha256');\n \n const input = fs.createReadStream(filename);\n input.on('readable', () => {\n+  // Only one element is going to be produced by the\n+  // hash stream.\n   const data = input.read();\n   if (data)\n     hash.update(data);\n@@ -1807,6 +1814,8 @@ const hmac = crypto.createHmac('sha256', 'a secret');\n \n const input = fs.createReadStream(filename);\n input.on('readable', () => {\n+  // Only one element is going to be produced by the\n+  // hash stream.\n   const data = input.read();\n   if (data)\n     hmac.update(data);"
        },
        {
            "sha": "b8b456f043d36135118c9f28efcb7d3e42374742",
            "filename": "doc/api/stream.md",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2d2f82c4139f43dc3a657903aa23a641779d6ed0/doc%2Fapi%2Fstream.md",
            "raw_url": "https://github.com/nodejs/node/raw/2d2f82c4139f43dc3a657903aa23a641779d6ed0/doc%2Fapi%2Fstream.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fstream.md?ref=2d2f82c4139f43dc3a657903aa23a641779d6ed0",
            "patch": "@@ -1011,6 +1011,10 @@ readable.on('readable', () => {\n });\n ```\n \n+Note that the `while` loop is necessary when processing data with\n+`readable.read()`. Only after `readable.read()` returns `null`,\n+[`'readable'`]() will be emitted.\n+\n A `Readable` stream in object mode will always return a single item from\n a call to [`readable.read(size)`][stream-read], regardless of the value of the\n `size` argument."
        }
    ],
    "stats": {
        "total": 55,
        "additions": 35,
        "deletions": 20
    }
}