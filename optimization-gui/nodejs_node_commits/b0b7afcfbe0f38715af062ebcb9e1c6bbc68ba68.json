{
    "author": "rvagg",
    "message": "deps: upgrade to c-ares v1.14.0\n\n * Fix patch for CVE-2017-1000381 to not be overly aggressive.\n * win32: Preserve DNS server order returned by Windows when sorting and\n   exclude DNS servers in legacy subnets.\n * win32: Support most recent Visual Studio 2017.\n * gethostbyaddr should fail with ECANCELLED not ENOTFOUND when\n   ares_cancel is called.\n * win32: Exclude legacy ipv6 subnets.\n * android: Applications compiled for Oreo can no longer use\n   __system_property_get and must use Java calls to retrieve DNS\n   servers.\n * win32: Force use of ANSI functions.\n * CMake minimum version is now 3.1.\n * ares_gethostbyname.3: fix callback status values.\n * docs: Document WSAStartup requirement.\n * Fix a typo in init_by_resolv_conf.\n * Android JNI code leaks local references in some cases.\n * Force using the ANSI versions of WinAPI functions.\n\nThe most important changes have already been included via\n\n * 50e580df21 deps: cherry-pick 0ef4a0c64b6 from c-ares upstream\n * 9a0631dffe deps: cherry-pick 18ea996 from c-ares upstream\n\nPR-URL: https://github.com/nodejs/node/pull/19939\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
    "files": [
        {
            "sha": "fce52acb31f4952482ca3d80b6b67600af236465",
            "filename": "deps/cares/cares.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fcares.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fcares.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fcares.gyp?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -40,6 +40,7 @@\n         'include/ares_rules.h',\n         'include/ares_version.h',\n         'include/nameser.h',\n+        'src/ares_android.c',\n         'src/ares_cancel.c',\n         'src/ares__close_sockets.c',\n         'src/ares_create_query.c',"
        },
        {
            "sha": "65a82cb5b7eb47bbe533145cc18a729068af358f",
            "filename": "deps/cares/include/ares.h",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Finclude%2Fares.h",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Finclude%2Fares.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Finclude%2Fares.h?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -68,6 +68,10 @@\n #  include <netinet/in.h>\n #endif\n \n+#if defined(ANDROID) || defined(__ANDROID__)\n+#include <jni.h>\n+#endif\n+\n #ifdef  __cplusplus\n extern \"C\" {\n #endif\n@@ -307,6 +311,12 @@ CARES_EXTERN int ares_library_init_mem(int flags,\n                                        void (*afree)(void *ptr),\n                                        void *(*arealloc)(void *ptr, size_t size));\n \n+#if defined(ANDROID) || defined(__ANDROID__)\n+CARES_EXTERN void ares_library_init_jvm(JavaVM *jvm);\n+CARES_EXTERN int ares_library_init_android(jobject connectivity_manager);\n+CARES_EXTERN int ares_library_android_initialized(void);\n+#endif\n+\n CARES_EXTERN int ares_library_initialized(void);\n \n CARES_EXTERN void ares_library_cleanup(void);"
        },
        {
            "sha": "5e3ba9f0d8cb0cc0516f4f55a858203b4f0f4c2f",
            "filename": "deps/cares/include/ares_build.h",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Finclude%2Fares_build.h",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Finclude%2Fares_build.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Finclude%2Fares_build.h?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -194,16 +194,14 @@\n /* Data type definition of ares_ssize_t. */\n #ifdef _WIN32\n #  ifdef _WIN64\n-     typedef __int64 ares_ssize_t;\n+#    define CARES_TYPEOF_ARES_SSIZE_T __int64\n #  else\n-     typedef long ares_ssize_t;\n+#    define CARES_TYPEOF_ARES_SSIZE_T long\n #  endif\n #else\n-#  ifdef CARES_TYPEOF_ARES_SSIZE_T\n-     typedef CARES_TYPEOF_ARES_SSIZE_T ares_ssize_t;\n-#  else\n-     typedef ssize_t ares_ssize_t;\n-#  endif\n+#  define CARES_TYPEOF_ARES_SSIZE_T ssize_t\n #endif\n \n+typedef CARES_TYPEOF_ARES_SSIZE_T ares_ssize_t;\n+\n #endif /* __CARES_BUILD_H */"
        },
        {
            "sha": "61b2b98a8d3683b42049322d1d6f00b60a88b93a",
            "filename": "deps/cares/include/ares_version.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Finclude%2Fares_version.h",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Finclude%2Fares_version.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Finclude%2Fares_version.h?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -3,15 +3,15 @@\n #define ARES__VERSION_H\n \n /* This is the global package copyright */\n-#define ARES_COPYRIGHT \"2004 - 2016 Daniel Stenberg, <daniel@haxx.se>.\"\n+#define ARES_COPYRIGHT \"2004 - 2017 Daniel Stenberg, <daniel@haxx.se>.\"\n \n #define ARES_VERSION_MAJOR 1\n-#define ARES_VERSION_MINOR 13\n+#define ARES_VERSION_MINOR 14\n #define ARES_VERSION_PATCH 0\n #define ARES_VERSION ((ARES_VERSION_MAJOR<<16)|\\\n                        (ARES_VERSION_MINOR<<8)|\\\n                        (ARES_VERSION_PATCH))\n-#define ARES_VERSION_STR \"1.13.0\"\n+#define ARES_VERSION_STR \"1.14.0\"\n \n #if (ARES_VERSION >= 0x010700)\n #  define CARES_HAVE_ARES_LIBRARY_INIT 1"
        },
        {
            "sha": "7db6584c91f34f0402ec5199ad1009841756851f",
            "filename": "deps/cares/src/AUTHORS",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2FAUTHORS",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2FAUTHORS",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2FAUTHORS?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -37,6 +37,7 @@ Frederic Germain\n Geert Uytterhoeven\n George Neill\n Gisle Vanem\n+Google LLC\n Gregor Jasny\n Guenter Knauf\n Guilherme Balena Versiani\n@@ -45,6 +46,7 @@ Henrik Stoerner\n Jakub Hrozek\n James Bursa\n Jérémy Lal\n+John Schember\n Keith Shaw\n Lei Shi\n Marko Kreen"
        },
        {
            "sha": "93c1f5f812de4c6d8b7486339c3f3f98c168b06f",
            "filename": "deps/cares/src/README.md",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2FREADME.md",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2FREADME.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2FREADME.md?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -5,6 +5,7 @@ c-ares\n [![Windows Build Status](https://ci.appveyor.com/api/projects/status/03i7151772eq3wn3/branch/master?svg=true)](https://ci.appveyor.com/project/c-ares/c-ares)\n [![Coverage Status](https://coveralls.io/repos/c-ares/c-ares/badge.svg?branch=master&service=github)](https://coveralls.io/github/c-ares/c-ares?branch=master)\n [![CII Best Practices](https://bestpractices.coreinfrastructure.org/projects/291/badge)](https://bestpractices.coreinfrastructure.org/projects/291)\n+[![Releases](https://coderelease.io/badge/c-ares/c-ares)](https://coderelease.io/github/repository/c-ares/c-ares)\n \n This is c-ares, an asynchronous resolver library.  It is intended for\n applications which need to perform DNS queries without blocking, or need to"
        },
        {
            "sha": "91230a325b9a73079ad45416e1ef137d5df38740",
            "filename": "deps/cares/src/RELEASE-NOTES",
            "status": "modified",
            "additions": 35,
            "deletions": 41,
            "changes": 76,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2FRELEASE-NOTES",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2FRELEASE-NOTES",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2FRELEASE-NOTES?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -1,53 +1,47 @@\n-c-ares version 1.13.0\n+c-ares version 1.14.0\n \n Changes:\n-\n- o cmake build system support added\n- o Add virtual function set for socket IO: ares_set_socket_functions [5]\n+ o android: Introduce new ares_library_init_android() call for Oreo support. [5]\n \n Bug fixes:\n \n- o CVE-2017-1000381: c-ares NAPTR parser out of bounds access [1]\n- o macos: do not set HAVE_CLOCK_GETTIME_MONOTONIC\n- o test: check ares_create_query with too-long name\n- o dist: add ares_library_initialized.* to the tarball\n- o fix build on OpenBSD\n- o dist: ship msvc_ver.inc too [2]\n- o test: Add gTest/gMock files to SOURCES\n- o test: add fuzz entrypoint for ares_create_query()\n- o configure: clock_gettime workaround [3]\n- o docs: convert INSTALL to MarkDown & tweak [4]\n- o ares_process: fix return type of socket_create function (win32 warning)\n- o docs: fixed references to ares_set_local_ip4 and ares_set_local_ip6\n- o Windows DNS server sorting [6]\n- o Use ares_socklen_t instead of socket_t [7]\n- o ares_create_query: use ares_free not naked free\n- o msvc_ver.inc support most recent Visual Studio 2017 [8]\n- o acountry: Convert char from ISO-8859-1 to UTF-8 [9]\n- o ares_expand_name: limit number of indirections\n- o configure: do not check for ar if specified manually [10]\n- o Added support for Windows DNS Suffix Search List [11]\n- o ares.h: support compiling with QNX [12]\n+ o Fix patch for CVE-2017-1000381 to not be overly aggressive. [1]\n+ o win32: Preserve DNS server order returned by Windows when sorting and exclude\n+   DNS servers in legacy subnets. [2] [4]\n+ o win32: Support most recent Visual Studio 2017\n+ o gethostbyaddr should fail with ECANCELLED not ENOTFOUND when ares_cancel\n+   is called. [3]\n+ o win32: Exclude legacy ipv6 subnets [4]\n+ o android: Applications compiled for Oreo can no longer use\n+   __system_property_get and must use Java calls to retrieve DNS servers.\n+   [5] [7]\n+ o win32: Force use of ANSI functions [6]\n+ o CMake minimum version is now 3.1\n+ o ares_gethostbyname.3: fix callback status values [8]\n+ o docs: Document WSAStartup requirement [9]\n+ o Fix a typo in init_by_resolv_conf [10]\n+ o Android JNI code leaks local references in some cases [11]\n+ o Force using the ANSI versions of WinAPI functions [12]\n \n Thanks go to these friendly people for their efforts and contributions:\n \n-  Aaron Bieber, Andrew Sullivan, Brad House, Bruce Stephens, Calle Wilund,\n-  Chris Araman, Christian Ammer, Daniel Stenberg, David Drysdale, David Hotham,\n-  Dionna Glaze, Gregor Jasny, Michael Osei, Mulle kybernetiK, noiz at github,\n-  Sergii Pylypenko, Stephen Sorley, Thomas Köckerbauer,\n+  AC Thompson, Anna Henningsen, Antonio Tajuelo, Brad House, Brad Spencer,\n+  Christian Ammer, Daniel Stenberg, David Drysdale, David Hotham, Felix Yan,\n+  Gergely Nagy, Gregor Jasny, Jakub Hrozek, John Schember,\n+  Konstantinos Sofokleous, Roman Teterin, Sergey Kolomenkin, Sheel Bedi,\n   (18 contributors)\n \n References to bug reports and discussions on issues:\n \n- [1] = https://c-ares.haxx.se/adv_20170620.html\n- [2] = https://github.com/c-ares/c-ares/issues/69\n- [3] = https://github.com/c-ares/c-ares/issues/71\n- [4] = https://github.com/c-ares/c-ares/issues/83\n- [5] = https://github.com/c-ares/c-ares/issues/72\n- [6] = https://github.com/c-ares/c-ares/issues/81\n- [7] = https://github.com/c-ares/c-ares/issues/92\n- [8] = https://github.com/c-ares/c-ares/issues/101\n- [9] = https://github.com/c-ares/c-ares/issues/97\n- [10] = https://github.com/c-ares/c-ares/issues/62\n- [11] = https://github.com/c-ares/c-ares/issues/93\n- [12] = https://github.com/c-ares/c-ares/issues/113\n+ [1] = https://github.com/c-ares/c-ares/commit/18ea99\n+ [2] = https://github.com/c-ares/c-ares/issues/150\n+ [3] = https://github.com/c-ares/c-ares/pull/138\n+ [4] = https://github.com/c-ares/c-ares/pull/144\n+ [5] = https://github.com/c-ares/c-ares/pull/148\n+ [6] = https://github.com/c-ares/c-ares/pull/142\n+ [7] = https://github.com/c-ares/c-ares/pull/175\n+ [8] = https://c-ares.haxx.se/mail/c-ares-archive-2011-06/0012.shtml\n+ [9] = https://github.com/c-ares/c-ares/pull/180\n+ [10] = https://github.com/c-ares/c-ares/pull/160\n+ [11] = https://github.com/c-ares/c-ares/pull/175\n+ [12] = https://github.com/c-ares/c-ares/pull/142"
        },
        {
            "sha": "ab388110bdeff9e5308c1807ee653679522c5fb2",
            "filename": "deps/cares/src/ares_android.c",
            "status": "added",
            "additions": 347,
            "deletions": 0,
            "changes": 347,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_android.c",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_android.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2Fares_android.c?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -0,0 +1,347 @@\n+/* Copyright (C) 2017 by John Schember <john@nachtimwald.com>\n+ *\n+ * Permission to use, copy, modify, and distribute this\n+ * software and its documentation for any purpose and without\n+ * fee is hereby granted, provided that the above copyright\n+ * notice appear in all copies and that both that copyright\n+ * notice and this permission notice appear in supporting\n+ * documentation, and that the name of M.I.T. not be used in\n+ * advertising or publicity pertaining to distribution of the\n+ * software without specific, written prior permission.\n+ * M.I.T. makes no representations about the suitability of\n+ * this software for any purpose.  It is provided \"as is\"\n+ * without express or implied warranty.\n+ */\n+#if defined(ANDROID) || defined(__ANDROID__)\n+\n+#include <jni.h>\n+\n+#include \"ares_setup.h\"\n+#include \"ares.h\"\n+#include \"ares_android.h\"\n+#include \"ares_private.h\"\n+\n+static JavaVM *android_jvm = NULL;\n+static jobject android_connectivity_manager = NULL;\n+\n+/* ConnectivityManager.getActiveNetwork */\n+static jmethodID android_cm_active_net_mid = NULL;\n+/* ConnectivityManager.getLinkProperties */\n+static jmethodID android_cm_link_props_mid = NULL;\n+/* LinkProperties.getDnsServers */\n+static jmethodID android_lp_dns_servers_mid = NULL;\n+/* List.size */\n+static jmethodID android_list_size_mid = NULL;\n+/* List.get */\n+static jmethodID android_list_get_mid = NULL;\n+/* InetAddress.getHostAddress */\n+static jmethodID android_ia_host_addr_mid = NULL;\n+\n+static jclass jni_get_class(JNIEnv *env, const char *path)\n+{\n+  jclass cls = NULL;\n+\n+  if (env == NULL || path == NULL || *path == '\\0')\n+    return NULL;\n+\n+  cls = (*env)->FindClass(env, path);\n+  if ((*env)->ExceptionOccurred(env)) {\n+    (*env)->ExceptionClear(env);\n+    return NULL;\n+  }\n+  return cls;\n+}\n+\n+static jmethodID jni_get_method_id(JNIEnv *env, jclass cls,\n+                                   const char *func_name, const char *signature)\n+{\n+  jmethodID mid = NULL;\n+\n+  if (env == NULL || cls == NULL || func_name == NULL || *func_name == '\\0' ||\n+          signature == NULL || *signature == '\\0')\n+  {\n+    return NULL;\n+  }\n+\n+  mid = (*env)->GetMethodID(env, cls, func_name, signature);\n+  if ((*env)->ExceptionOccurred(env))\n+  {\n+    (*env)->ExceptionClear(env);\n+    return NULL;\n+  }\n+\n+  return mid;\n+}\n+\n+void ares_library_init_jvm(JavaVM *jvm)\n+{\n+  android_jvm = jvm;\n+}\n+\n+int ares_library_init_android(jobject connectivity_manager)\n+{\n+  JNIEnv *env = NULL;\n+  int need_detatch = 0;\n+  int res;\n+  int ret = ARES_ENOTINITIALIZED;\n+  jclass obj_cls = NULL;\n+\n+  if (android_jvm == NULL)\n+    goto cleanup;\n+\n+  res = (*android_jvm)->GetEnv(android_jvm, (void **)&env, JNI_VERSION_1_6);\n+  if (res == JNI_EDETACHED)\n+  {\n+    env = NULL;\n+    res = (*android_jvm)->AttachCurrentThread(android_jvm, &env, NULL);\n+    need_detatch = 1;\n+  }\n+  if (res != JNI_OK || env == NULL)\n+    goto cleanup;\n+\n+  android_connectivity_manager =\n+      (*env)->NewGlobalRef(env, connectivity_manager);\n+  if (android_connectivity_manager == NULL)\n+    goto cleanup;\n+\n+  /* Initialization has succeeded. Now attempt to cache the methods that will be\n+   * called by ares_get_android_server_list. */\n+  ret = ARES_SUCCESS;\n+\n+  /* ConnectivityManager in API 1. */\n+  obj_cls = jni_get_class(env, \"android/net/ConnectivityManager\");\n+  if (obj_cls == NULL)\n+    goto cleanup;\n+\n+  /* ConnectivityManager.getActiveNetwork in API 23. */\n+  android_cm_active_net_mid =\n+      jni_get_method_id(env, obj_cls, \"getActiveNetwork\",\n+                        \"()Landroid/net/Network;\");\n+  if (android_cm_active_net_mid == NULL)\n+    goto cleanup;\n+\n+  /* ConnectivityManager.getLinkProperties in API 21. */\n+  android_cm_link_props_mid =\n+      jni_get_method_id(env, obj_cls, \"getLinkProperties\",\n+                        \"(Landroid/net/Network;)Landroid/net/LinkProperties;\");\n+  if (android_cm_link_props_mid == NULL)\n+    goto cleanup;\n+\n+  /* LinkProperties in API 21. */\n+  (*env)->DeleteLocalRef(env, obj_cls);\n+  obj_cls = jni_get_class(env, \"android/net/LinkProperties\");\n+  if (obj_cls == NULL)\n+    goto cleanup;\n+\n+  /* getDnsServers in API 21. */\n+  android_lp_dns_servers_mid = jni_get_method_id(env, obj_cls, \"getDnsServers\",\n+                                                 \"()Ljava/util/List;\");\n+  if (android_lp_dns_servers_mid == NULL)\n+    goto cleanup;\n+\n+  (*env)->DeleteLocalRef(env, obj_cls);\n+  obj_cls = jni_get_class(env, \"java/util/List\");\n+  if (obj_cls == NULL)\n+    goto cleanup;\n+\n+  android_list_size_mid = jni_get_method_id(env, obj_cls, \"size\", \"()I\");\n+  if (android_list_size_mid == NULL)\n+    goto cleanup;\n+\n+  android_list_get_mid = jni_get_method_id(env, obj_cls, \"get\",\n+                                           \"(I)Ljava/lang/Object;\");\n+  if (android_list_get_mid == NULL)\n+    goto cleanup;\n+\n+  (*env)->DeleteLocalRef(env, obj_cls);\n+  obj_cls = jni_get_class(env, \"java/net/InetAddress\");\n+  if (obj_cls == NULL)\n+    goto cleanup;\n+\n+  android_ia_host_addr_mid = jni_get_method_id(env, obj_cls, \"getHostAddress\",\n+                                               \"()Ljava/lang/String;\");\n+  if (android_ia_host_addr_mid == NULL)\n+    goto cleanup;\n+\n+  (*env)->DeleteLocalRef(env, obj_cls);\n+  goto done;\n+\n+cleanup:\n+  if (obj_cls != NULL)\n+    (*env)->DeleteLocalRef(env, obj_cls);\n+\n+  android_cm_active_net_mid = NULL;\n+  android_cm_link_props_mid = NULL;\n+  android_lp_dns_servers_mid = NULL;\n+  android_list_size_mid = NULL;\n+  android_list_get_mid = NULL;\n+  android_ia_host_addr_mid = NULL;\n+\n+done:\n+  if (need_detatch)\n+    (*android_jvm)->DetachCurrentThread(android_jvm);\n+\n+  return ret;\n+}\n+\n+int ares_library_android_initialized(void)\n+{\n+  if (android_jvm == NULL || android_connectivity_manager == NULL)\n+    return ARES_ENOTINITIALIZED;\n+  return ARES_SUCCESS;\n+}\n+\n+void ares_library_cleanup_android(void)\n+{\n+  JNIEnv *env = NULL;\n+  int need_detatch = 0;\n+  int res;\n+\n+  if (android_jvm == NULL || android_connectivity_manager == NULL)\n+    return;\n+\n+  res = (*android_jvm)->GetEnv(android_jvm, (void **)&env, JNI_VERSION_1_6);\n+  if (res == JNI_EDETACHED)\n+  {\n+    env = NULL;\n+    res = (*android_jvm)->AttachCurrentThread(android_jvm, &env, NULL);\n+    need_detatch = 1;\n+  }\n+  if (res != JNI_OK || env == NULL)\n+    return;\n+\n+  android_cm_active_net_mid = NULL;\n+  android_cm_link_props_mid = NULL;\n+  android_lp_dns_servers_mid = NULL;\n+  android_list_size_mid = NULL;\n+  android_list_get_mid = NULL;\n+  android_ia_host_addr_mid = NULL;\n+\n+  (*env)->DeleteGlobalRef(env, android_connectivity_manager);\n+  android_connectivity_manager = NULL;\n+\n+  if (need_detatch)\n+    (*android_jvm)->DetachCurrentThread(android_jvm);\n+}\n+\n+char **ares_get_android_server_list(size_t max_servers,\n+                                    size_t *num_servers)\n+{\n+  JNIEnv *env = NULL;\n+  jobject active_network = NULL;\n+  jobject link_properties = NULL;\n+  jobject server_list = NULL;\n+  jobject server = NULL;\n+  jstring str = NULL;\n+  jint nserv;\n+  const char *ch_server_address;\n+  int res;\n+  size_t i;\n+  char **dns_list = NULL;\n+  int need_detatch = 0;\n+\n+  if (android_jvm == NULL || android_connectivity_manager == NULL ||\n+          max_servers == 0 || num_servers == NULL)\n+  {\n+    return NULL;\n+  }\n+\n+  if (android_cm_active_net_mid == NULL || android_cm_link_props_mid == NULL ||\n+      android_lp_dns_servers_mid == NULL || android_list_size_mid == NULL ||\n+      android_list_get_mid == NULL || android_ia_host_addr_mid == NULL)\n+  {\n+    return NULL;\n+  }\n+\n+  res = (*android_jvm)->GetEnv(android_jvm, (void **)&env, JNI_VERSION_1_6);\n+  if (res == JNI_EDETACHED)\n+  {\n+    env = NULL;\n+    res = (*android_jvm)->AttachCurrentThread(android_jvm, &env, NULL);\n+    need_detatch = 1;\n+  }\n+  if (res != JNI_OK || env == NULL)\n+    goto done;\n+\n+  /* JNI below is equivalent to this Java code.\n+     import android.content.Context;\n+     import android.net.ConnectivityManager;\n+     import android.net.LinkProperties;\n+     import android.net.Network;\n+     import java.net.InetAddress;\n+     import java.util.List;\n+\n+     ConnectivityManager cm = (ConnectivityManager)this.getApplicationContext()\n+       .getSystemService(Context.CONNECTIVITY_SERVICE);\n+     Network an = cm.getActiveNetwork();\n+     LinkProperties lp = cm.getLinkProperties(an);\n+     List<InetAddress> dns = lp.getDnsServers();\n+     for (InetAddress ia: dns) {\n+       String ha = ia.getHostAddress();\n+     }\n+\n+     Note: The JNI ConnectivityManager object and all method IDs were previously\n+           initialized in ares_library_init_android.\n+   */\n+\n+  active_network = (*env)->CallObjectMethod(env, android_connectivity_manager,\n+                                            android_cm_active_net_mid);\n+  if (active_network == NULL)\n+    goto done;\n+\n+  link_properties =\n+      (*env)->CallObjectMethod(env, android_connectivity_manager,\n+                               android_cm_link_props_mid, active_network);\n+  if (link_properties == NULL)\n+    goto done;\n+\n+  server_list = (*env)->CallObjectMethod(env, link_properties,\n+                                         android_lp_dns_servers_mid);\n+  if (server_list == NULL)\n+    goto done;\n+\n+  nserv = (*env)->CallIntMethod(env, server_list, android_list_size_mid);\n+  if (nserv > (jint)max_servers)\n+    nserv = (jint)max_servers;\n+  if (nserv <= 0)\n+    goto done;\n+  *num_servers = (size_t)nserv;\n+\n+  dns_list = ares_malloc(sizeof(*dns_list)*(*num_servers));\n+  for (i=0; i<*num_servers; i++)\n+  {\n+    server = (*env)->CallObjectMethod(env, server_list, android_list_get_mid,\n+                                      (jint)i);\n+    dns_list[i] = ares_malloc(64);\n+    dns_list[i][0] = 0;\n+    if (server == NULL)\n+    {\n+      continue;\n+    }\n+    str = (*env)->CallObjectMethod(env, server, android_ia_host_addr_mid);\n+    ch_server_address = (*env)->GetStringUTFChars(env, str, 0);\n+    strncpy(dns_list[i], ch_server_address, 64);\n+    (*env)->ReleaseStringUTFChars(env, str, ch_server_address);\n+    (*env)->DeleteLocalRef(env, str);\n+    (*env)->DeleteLocalRef(env, server);\n+  }\n+\n+done:\n+  if ((*env)->ExceptionOccurred(env))\n+    (*env)->ExceptionClear(env);\n+\n+  if (server_list != NULL)\n+    (*env)->DeleteLocalRef(env, server_list);\n+  if (link_properties != NULL)\n+    (*env)->DeleteLocalRef(env, link_properties);\n+  if (active_network != NULL)\n+    (*env)->DeleteLocalRef(env, active_network);\n+\n+  if (need_detatch)\n+    (*android_jvm)->DetachCurrentThread(android_jvm);\n+  return dns_list;\n+}\n+#else\n+/* warning: ISO C forbids an empty translation unit */\n+typedef int dummy_make_iso_compilers_happy;\n+#endif"
        },
        {
            "sha": "18dd650c7b91fb206307bd61c0b09dd79e57821f",
            "filename": "deps/cares/src/ares_data.c",
            "status": "modified",
            "additions": 74,
            "deletions": 73,
            "changes": 147,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_data.c",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_data.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2Fares_data.c?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -40,91 +40,92 @@\n \n void ares_free_data(void *dataptr)\n {\n-  struct ares_data *ptr;\n-\n-  if (!dataptr)\n-    return;\n+  while (dataptr != NULL) {\n+    struct ares_data *ptr;\n+    void *next_data = NULL;\n \n #ifdef __INTEL_COMPILER\n #  pragma warning(push)\n #  pragma warning(disable:1684)\n    /* 1684: conversion from pointer to same-sized integral type */\n #endif\n \n-  ptr = (void *)((char *)dataptr - offsetof(struct ares_data, data));\n+    ptr = (void *)((char *)dataptr - offsetof(struct ares_data, data));\n \n #ifdef __INTEL_COMPILER\n #  pragma warning(pop)\n #endif\n \n-  if (ptr->mark != ARES_DATATYPE_MARK)\n-    return;\n-\n-  switch (ptr->type)\n-    {\n-      case ARES_DATATYPE_MX_REPLY:\n-\n-        if (ptr->data.mx_reply.next)\n-          ares_free_data(ptr->data.mx_reply.next);\n-        if (ptr->data.mx_reply.host)\n-          ares_free(ptr->data.mx_reply.host);\n-        break;\n-\n-      case ARES_DATATYPE_SRV_REPLY:\n-\n-        if (ptr->data.srv_reply.next)\n-          ares_free_data(ptr->data.srv_reply.next);\n-        if (ptr->data.srv_reply.host)\n-          ares_free(ptr->data.srv_reply.host);\n-        break;\n-\n-      case ARES_DATATYPE_TXT_REPLY:\n-      case ARES_DATATYPE_TXT_EXT:\n-\n-        if (ptr->data.txt_reply.next)\n-          ares_free_data(ptr->data.txt_reply.next);\n-        if (ptr->data.txt_reply.txt)\n-          ares_free(ptr->data.txt_reply.txt);\n-        break;\n-\n-      case ARES_DATATYPE_ADDR_NODE:\n-\n-        if (ptr->data.addr_node.next)\n-          ares_free_data(ptr->data.addr_node.next);\n-        break;\n-\n-      case ARES_DATATYPE_ADDR_PORT_NODE:\n-\n-        if (ptr->data.addr_port_node.next)\n-          ares_free_data(ptr->data.addr_port_node.next);\n-        break;\n-\n-      case ARES_DATATYPE_NAPTR_REPLY:\n-\n-        if (ptr->data.naptr_reply.next)\n-          ares_free_data(ptr->data.naptr_reply.next);\n-        if (ptr->data.naptr_reply.flags)\n-          ares_free(ptr->data.naptr_reply.flags);\n-        if (ptr->data.naptr_reply.service)\n-          ares_free(ptr->data.naptr_reply.service);\n-        if (ptr->data.naptr_reply.regexp)\n-          ares_free(ptr->data.naptr_reply.regexp);\n-        if (ptr->data.naptr_reply.replacement)\n-          ares_free(ptr->data.naptr_reply.replacement);\n-        break;\n-\n-      case ARES_DATATYPE_SOA_REPLY:\n-        if (ptr->data.soa_reply.nsname)\n-          ares_free(ptr->data.soa_reply.nsname);\n-        if (ptr->data.soa_reply.hostmaster)\n-          ares_free(ptr->data.soa_reply.hostmaster);\n-\tbreak;\n-\n-      default:\n-        return;\n-    }\n-\n-  ares_free(ptr);\n+    if (ptr->mark != ARES_DATATYPE_MARK)\n+      return;\n+\n+    switch (ptr->type)\n+      {\n+        case ARES_DATATYPE_MX_REPLY:\n+\n+          if (ptr->data.mx_reply.next)\n+            next_data = ptr->data.mx_reply.next;\n+          if (ptr->data.mx_reply.host)\n+            ares_free(ptr->data.mx_reply.host);\n+          break;\n+\n+        case ARES_DATATYPE_SRV_REPLY:\n+\n+          if (ptr->data.srv_reply.next)\n+            next_data = ptr->data.srv_reply.next;\n+          if (ptr->data.srv_reply.host)\n+            ares_free(ptr->data.srv_reply.host);\n+          break;\n+\n+        case ARES_DATATYPE_TXT_REPLY:\n+        case ARES_DATATYPE_TXT_EXT:\n+\n+          if (ptr->data.txt_reply.next)\n+            next_data = ptr->data.txt_reply.next;\n+          if (ptr->data.txt_reply.txt)\n+            ares_free(ptr->data.txt_reply.txt);\n+          break;\n+\n+        case ARES_DATATYPE_ADDR_NODE:\n+\n+          if (ptr->data.addr_node.next)\n+            next_data = ptr->data.addr_node.next;\n+          break;\n+\n+        case ARES_DATATYPE_ADDR_PORT_NODE:\n+\n+          if (ptr->data.addr_port_node.next)\n+            next_data = ptr->data.addr_port_node.next;\n+          break;\n+\n+        case ARES_DATATYPE_NAPTR_REPLY:\n+\n+          if (ptr->data.naptr_reply.next)\n+            next_data = ptr->data.naptr_reply.next;\n+          if (ptr->data.naptr_reply.flags)\n+            ares_free(ptr->data.naptr_reply.flags);\n+          if (ptr->data.naptr_reply.service)\n+            ares_free(ptr->data.naptr_reply.service);\n+          if (ptr->data.naptr_reply.regexp)\n+            ares_free(ptr->data.naptr_reply.regexp);\n+          if (ptr->data.naptr_reply.replacement)\n+            ares_free(ptr->data.naptr_reply.replacement);\n+          break;\n+\n+        case ARES_DATATYPE_SOA_REPLY:\n+          if (ptr->data.soa_reply.nsname)\n+            ares_free(ptr->data.soa_reply.nsname);\n+          if (ptr->data.soa_reply.hostmaster)\n+            ares_free(ptr->data.soa_reply.hostmaster);\n+          break;\n+\n+        default:\n+          return;\n+      }\n+\n+    ares_free(ptr);\n+    dataptr = next_data;\n+  }\n }\n \n "
        },
        {
            "sha": "a8ca0f5744d3761775bd8ee5ad94021d9758e198",
            "filename": "deps/cares/src/ares_gethostbyaddr.c",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_gethostbyaddr.c",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_gethostbyaddr.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2Fares_gethostbyaddr.c?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -190,18 +190,18 @@ static int file_lookup(struct ares_addr *addr, struct hostent **host)\n     char tmp[MAX_PATH];\n     HKEY hkeyHosts;\n \n-    if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, WIN_NS_NT_KEY, 0, KEY_READ,\n+    if (RegOpenKeyExA(HKEY_LOCAL_MACHINE, WIN_NS_NT_KEY, 0, KEY_READ,\n                      &hkeyHosts) == ERROR_SUCCESS)\n     {\n       DWORD dwLength = MAX_PATH;\n-      RegQueryValueEx(hkeyHosts, DATABASEPATH, NULL, NULL, (LPBYTE)tmp,\n+      RegQueryValueExA(hkeyHosts, DATABASEPATH, NULL, NULL, (LPBYTE)tmp,\n                       &dwLength);\n-      ExpandEnvironmentStrings(tmp, PATH_HOSTS, MAX_PATH);\n+      ExpandEnvironmentStringsA(tmp, PATH_HOSTS, MAX_PATH);\n       RegCloseKey(hkeyHosts);\n     }\n   }\n   else if (platform == WIN_9X)\n-    GetWindowsDirectory(PATH_HOSTS, MAX_PATH);\n+    GetWindowsDirectoryA(PATH_HOSTS, MAX_PATH);\n   else\n     return ARES_ENOTFOUND;\n "
        },
        {
            "sha": "7c46d96ceaf2148ad9834fa848becf40f581729e",
            "filename": "deps/cares/src/ares_gethostbyname.c",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_gethostbyname.c",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_gethostbyname.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2Fares_gethostbyname.c?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -351,18 +351,18 @@ static int file_lookup(const char *name, int family, struct hostent **host)\n     char tmp[MAX_PATH];\n     HKEY hkeyHosts;\n \n-    if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, WIN_NS_NT_KEY, 0, KEY_READ,\n+    if (RegOpenKeyExA(HKEY_LOCAL_MACHINE, WIN_NS_NT_KEY, 0, KEY_READ,\n                      &hkeyHosts) == ERROR_SUCCESS)\n     {\n       DWORD dwLength = MAX_PATH;\n-      RegQueryValueEx(hkeyHosts, DATABASEPATH, NULL, NULL, (LPBYTE)tmp,\n+      RegQueryValueExA(hkeyHosts, DATABASEPATH, NULL, NULL, (LPBYTE)tmp,\n                       &dwLength);\n-      ExpandEnvironmentStrings(tmp, PATH_HOSTS, MAX_PATH);\n+      ExpandEnvironmentStringsA(tmp, PATH_HOSTS, MAX_PATH);\n       RegCloseKey(hkeyHosts);\n     }\n   }\n   else if (platform == WIN_9X)\n-    GetWindowsDirectory(PATH_HOSTS, MAX_PATH);\n+    GetWindowsDirectoryA(PATH_HOSTS, MAX_PATH);\n   else\n     return ARES_ENOTFOUND;\n "
        },
        {
            "sha": "4cc2c76dbda5ab89c2e4e935a537635e8626cae0",
            "filename": "deps/cares/src/ares_init.c",
            "status": "modified",
            "additions": 151,
            "deletions": 32,
            "changes": 183,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_init.c",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_init.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2Fares_init.c?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -44,6 +44,7 @@\n \n #if defined(ANDROID) || defined(__ANDROID__)\n #include <sys/system_properties.h>\n+#include \"ares_android.h\"\n /* From the Bionic sources */\n #define DNS_PROP_NAME_PREFIX  \"net.dns\"\n #define MAX_DNS_PROPERTIES    8\n@@ -585,7 +586,7 @@ static int get_REG_SZ(HKEY hKey, const char *leafKeyName, char **outptr)\n   *outptr = NULL;\n \n   /* Find out size of string stored in registry */\n-  res = RegQueryValueEx(hKey, leafKeyName, 0, NULL, NULL, &size);\n+  res = RegQueryValueExA(hKey, leafKeyName, 0, NULL, NULL, &size);\n   if ((res != ERROR_SUCCESS && res != ERROR_MORE_DATA) || !size)\n     return 0;\n \n@@ -596,7 +597,7 @@ static int get_REG_SZ(HKEY hKey, const char *leafKeyName, char **outptr)\n     return 0;\n \n   /* Get the value for real */\n-  res = RegQueryValueEx(hKey, leafKeyName, 0, NULL,\n+  res = RegQueryValueExA(hKey, leafKeyName, 0, NULL,\n                         (unsigned char *)*outptr, &size);\n   if ((res != ERROR_SUCCESS) || (size == 1))\n   {\n@@ -627,7 +628,7 @@ static int get_REG_SZ_9X(HKEY hKey, const char *leafKeyName, char **outptr)\n   *outptr = NULL;\n \n   /* Find out size of string stored in registry */\n-  res = RegQueryValueEx(hKey, leafKeyName, 0, &dataType, NULL, &size);\n+  res = RegQueryValueExA(hKey, leafKeyName, 0, &dataType, NULL, &size);\n   if ((res != ERROR_SUCCESS && res != ERROR_MORE_DATA) || !size)\n     return 0;\n \n@@ -638,7 +639,7 @@ static int get_REG_SZ_9X(HKEY hKey, const char *leafKeyName, char **outptr)\n     return 0;\n \n   /* Get the value for real */\n-  res = RegQueryValueEx(hKey, leafKeyName, 0, &dataType,\n+  res = RegQueryValueExA(hKey, leafKeyName, 0, &dataType,\n                         (unsigned char *)*outptr, &size);\n   if ((res != ERROR_SUCCESS) || (size == 1))\n   {\n@@ -683,11 +684,11 @@ static int get_enum_REG_SZ(HKEY hKeyParent, const char *leafKeyName,\n   for(;;)\n   {\n     enumKeyNameBuffSize = sizeof(enumKeyName);\n-    res = RegEnumKeyEx(hKeyParent, enumKeyIdx++, enumKeyName,\n+    res = RegEnumKeyExA(hKeyParent, enumKeyIdx++, enumKeyName,\n                        &enumKeyNameBuffSize, 0, NULL, NULL, NULL);\n     if (res != ERROR_SUCCESS)\n       break;\n-    res = RegOpenKeyEx(hKeyParent, enumKeyName, 0, KEY_QUERY_VALUE,\n+    res = RegOpenKeyExA(hKeyParent, enumKeyName, 0, KEY_QUERY_VALUE,\n                        &hKeyEnum);\n     if (res != ERROR_SUCCESS)\n       continue;\n@@ -718,7 +719,7 @@ static int get_DNS_Registry_9X(char **outptr)\n \n   *outptr = NULL;\n \n-  res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, WIN_NS_9X, 0, KEY_READ,\n+  res = RegOpenKeyExA(HKEY_LOCAL_MACHINE, WIN_NS_9X, 0, KEY_READ,\n                      &hKey_VxD_MStcp);\n   if (res != ERROR_SUCCESS)\n     return 0;\n@@ -750,7 +751,7 @@ static int get_DNS_Registry_NT(char **outptr)\n \n   *outptr = NULL;\n \n-  res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, WIN_NS_NT_KEY, 0, KEY_READ,\n+  res = RegOpenKeyExA(HKEY_LOCAL_MACHINE, WIN_NS_NT_KEY, 0, KEY_READ,\n                      &hKey_Tcpip_Parameters);\n   if (res != ERROR_SUCCESS)\n     return 0;\n@@ -772,7 +773,7 @@ static int get_DNS_Registry_NT(char **outptr)\n     goto done;\n \n   /* Try adapter specific parameters */\n-  res = RegOpenKeyEx(hKey_Tcpip_Parameters, \"Interfaces\", 0,\n+  res = RegOpenKeyExA(hKey_Tcpip_Parameters, \"Interfaces\", 0,\n                      KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS,\n                      &hKey_Interfaces);\n   if (res != ERROR_SUCCESS)\n@@ -949,9 +950,16 @@ static BOOL ares_IsWindowsVistaOrGreater(void)\n   OSVERSIONINFO vinfo;\n   memset(&vinfo, 0, sizeof(vinfo));\n   vinfo.dwOSVersionInfoSize = sizeof(vinfo);\n+#ifdef _MSC_VER\n+#pragma warning(push)\n+#pragma warning(disable:4996) /* warning C4996: 'GetVersionExW': was declared deprecated */\n+#endif\n   if (!GetVersionEx(&vinfo) || vinfo.dwMajorVersion < 6)\n     return FALSE;\n   return TRUE;\n+#ifdef _MSC_VER\n+#pragma warning(pop)\n+#endif\n }\n \n /* A structure to hold the string form of IPv4 and IPv6 addresses so we can\n@@ -962,6 +970,10 @@ typedef struct\n   /* The metric we sort them by. */\n   ULONG metric;\n \n+  /* Original index of the item, used as a secondary sort parameter to make\n+   * qsort() stable if the metrics are equal */\n+  size_t orig_idx;\n+\n   /* Room enough for the string form of any IPv4 or IPv6 address that\n    * ares_inet_ntop() will create.  Based on the existing c-ares practice.\n    */\n@@ -976,8 +988,69 @@ static int compareAddresses(const void *arg1,\n {\n   const Address * const left = arg1;\n   const Address * const right = arg2;\n+  /* Lower metric the more preferred */\n   if(left->metric < right->metric) return -1;\n   if(left->metric > right->metric) return 1;\n+  /* If metrics are equal, lower original index more preferred */\n+  if(left->orig_idx < right->orig_idx) return -1;\n+  if(left->orig_idx > right->orig_idx) return 1;\n+  return 0;\n+}\n+\n+/* Validate that the ip address matches the subnet (network base and network\n+ * mask) specified. Addresses are specified in standard Network Byte Order as\n+ * 16 bytes, and the netmask is 0 to 128 (bits).\n+ */\n+static int ares_ipv6_subnet_matches(const unsigned char netbase[16],\n+                                    unsigned char netmask,\n+                                    const unsigned char ipaddr[16])\n+{\n+  unsigned char mask[16] = { 0 };\n+  unsigned char i;\n+\n+  /* Misuse */\n+  if (netmask > 128)\n+    return 0;\n+\n+  /* Quickly set whole bytes */\n+  memset(mask, 0xFF, netmask / 8);\n+\n+  /* Set remaining bits */\n+  if(netmask % 8) {\n+    mask[netmask / 8] = (unsigned char)(0xff << (8 - (netmask % 8)));\n+  }\n+\n+  for (i=0; i<16; i++) {\n+    if ((netbase[i] & mask[i]) != (ipaddr[i] & mask[i]))\n+      return 0;\n+  }\n+\n+  return 1;\n+}\n+\n+static int ares_ipv6_server_blacklisted(const unsigned char ipaddr[16])\n+{\n+  const struct {\n+    const char   *netbase;\n+    unsigned char netmask;\n+  } blacklist[] = {\n+    /* Deprecated by [RFC3879] in September 2004. Formerly a Site-Local scoped\n+     * address prefix. Causes known issues on Windows as these are not valid DNS\n+     * servers. */\n+    { \"fec0::\", 10 },\n+    { NULL,     0  }\n+  };\n+  size_t i;\n+\n+  for (i=0; blacklist[i].netbase != NULL; i++) {\n+    unsigned char netbase[16];\n+\n+    if (ares_inet_pton(AF_INET6, blacklist[i].netbase, netbase) != 1)\n+      continue;\n+\n+    if (ares_ipv6_subnet_matches(netbase, blacklist[i].netmask, ipaddr))\n+      return 1;\n+  }\n   return 0;\n }\n \n@@ -1187,6 +1260,9 @@ static int get_DNS_AdaptersAddresses(char **outptr)\n           addresses[addressesIndex].metric = -1;\n         }\n \n+        /* Record insertion index to make qsort stable */\n+        addresses[addressesIndex].orig_idx = addressesIndex;\n+\n         if (! ares_inet_ntop(AF_INET, &namesrvr.sa4->sin_addr,\n                              addresses[addressesIndex].text,\n                              sizeof(addresses[0].text))) {\n@@ -1196,15 +1272,15 @@ static int get_DNS_AdaptersAddresses(char **outptr)\n       }\n       else if (namesrvr.sa->sa_family == AF_INET6)\n       {\n-        /* Windows apparently always reports some IPv6 DNS servers that\n-         * prefixed with fec0:0:0:ffff. These ususally do not point to\n-         * working DNS servers, so we ignore them. */\n-        if (strncmp(addresses[addressesIndex].text, \"fec0:0:0:ffff:\", 14) == 0)\n-          continue;\n         if (memcmp(&namesrvr.sa6->sin6_addr, &ares_in6addr_any,\n                    sizeof(namesrvr.sa6->sin6_addr)) == 0)\n           continue;\n \n+        if (ares_ipv6_server_blacklisted(\n+              (const unsigned char *)&namesrvr.sa6->sin6_addr)\n+           )\n+          continue;\n+\n         /* Allocate room for another address, if necessary, else skip. */\n         if(addressesIndex == addressesSize) {\n           const size_t newSize = addressesSize + 4;\n@@ -1231,6 +1307,9 @@ static int get_DNS_AdaptersAddresses(char **outptr)\n           addresses[addressesIndex].metric = -1;\n         }\n \n+        /* Record insertion index to make qsort stable */\n+        addresses[addressesIndex].orig_idx = addressesIndex;\n+\n         if (! ares_inet_ntop(AF_INET6, &namesrvr.sa6->sin6_addr,\n                              addresses[addressesIndex].text,\n                              sizeof(addresses[0].text))) {\n@@ -1245,7 +1324,8 @@ static int get_DNS_AdaptersAddresses(char **outptr)\n     }\n   }\n \n-  /* Sort all of the textual addresses by their metric. */\n+  /* Sort all of the textual addresses by their metric (and original index if\n+   * metrics are equal). */\n   qsort(addresses, addressesIndex, sizeof(*addresses), compareAddresses);\n \n   /* Join them all into a single string, removing duplicates. */\n@@ -1382,7 +1462,7 @@ static int get_SuffixList_Windows(char **outptr)\n   DWORD keyNameBuffSize;\n   DWORD keyIdx = 0;\n   char *p = NULL;\n-  char *pp;\n+  const char *pp;\n   size_t len = 0;\n \n   *outptr = NULL;\n@@ -1391,7 +1471,7 @@ static int get_SuffixList_Windows(char **outptr)\n     return 0;\n \n   /* 1. Global DNS Suffix Search List */\n-  if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, WIN_NS_NT_KEY, 0,\n+  if (RegOpenKeyExA(HKEY_LOCAL_MACHINE, WIN_NS_NT_KEY, 0,\n       KEY_READ, &hKey) == ERROR_SUCCESS)\n   {\n     if (get_REG_SZ(hKey, SEARCHLIST_KEY, outptr))\n@@ -1403,7 +1483,7 @@ static int get_SuffixList_Windows(char **outptr)\n \n   /* 2. Connection Specific Search List composed of:\n    *  a. Primary DNS Suffix */\n-  if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, WIN_DNSCLIENT, 0,\n+  if (RegOpenKeyExA(HKEY_LOCAL_MACHINE, WIN_DNSCLIENT, 0,\n       KEY_READ, &hKey) == ERROR_SUCCESS)\n   {\n     get_REG_SZ(hKey, PRIMARYDNSSUFFIX_KEY, outptr);\n@@ -1413,17 +1493,17 @@ static int get_SuffixList_Windows(char **outptr)\n     return 0;\n \n   /*  b. Interface SearchList, Domain, DhcpDomain */\n-  if (!RegOpenKeyEx(HKEY_LOCAL_MACHINE, WIN_NS_NT_KEY \"\\\\\" INTERFACES_KEY, 0,\n+  if (!RegOpenKeyExA(HKEY_LOCAL_MACHINE, WIN_NS_NT_KEY \"\\\\\" INTERFACES_KEY, 0,\n       KEY_READ, &hKey) == ERROR_SUCCESS)\n     return 0;\n   for(;;)\n   {\n     keyNameBuffSize = sizeof(keyName);\n-    if (RegEnumKeyEx(hKey, keyIdx++, keyName, &keyNameBuffSize,\n+    if (RegEnumKeyExA(hKey, keyIdx++, keyName, &keyNameBuffSize,\n         0, NULL, NULL, NULL)\n         != ERROR_SUCCESS)\n       break;\n-    if (RegOpenKeyEx(hKey, keyName, 0, KEY_QUERY_VALUE, &hKeyEnum)\n+    if (RegOpenKeyExA(hKey, keyName, 0, KEY_QUERY_VALUE, &hKeyEnum)\n         != ERROR_SUCCESS)\n       continue;\n     if (get_REG_SZ(hKeyEnum, SEARCHLIST_KEY, &p) ||\n@@ -1432,7 +1512,7 @@ static int get_SuffixList_Windows(char **outptr)\n     {\n       /* p can be comma separated (SearchList) */\n       pp = p;\n-      while (len = next_suffix(&pp, len))\n+      while ((len = next_suffix(&pp, len)) != 0)\n       {\n         if (!contains_suffix(*outptr, pp, len))\n           commanjoin(outptr, pp, len);\n@@ -1542,18 +1622,55 @@ static int init_by_resolv_conf(ares_channel channel)\n   unsigned int i;\n   char propname[PROP_NAME_MAX];\n   char propvalue[PROP_VALUE_MAX]=\"\";\n+  char **dns_servers;\n+  size_t num_servers;\n+\n+  /* Use the Android connectivity manager to get a list\n+   * of DNS servers. As of Android 8 (Oreo) net.dns#\n+   * system properties are no longer available. Google claims this\n+   * improves privacy. Apps now need the ACCESS_NETWORK_STATE\n+   * permission and must use the ConnectivityManager which\n+   * is Java only. */\n+  dns_servers = ares_get_android_server_list(MAX_DNS_PROPERTIES, &num_servers);\n+  if (dns_servers != NULL)\n+  {\n+    for (i = 0; i < num_servers; i++)\n+    {\n+      status = config_nameserver(&servers, &nservers, dns_servers[i]);\n+      if (status != ARES_SUCCESS)\n+        break;\n+      status = ARES_EOF;\n+    }\n+    for (i = 0; i < num_servers; i++)\n+    {\n+      ares_free(dns_servers[i]);\n+    }\n+    ares_free(dns_servers);\n+  }\n \n-  for (i = 1; i <= MAX_DNS_PROPERTIES; i++) {\n-    snprintf(propname, sizeof(propname), \"%s%u\", DNS_PROP_NAME_PREFIX, i);\n-    if (__system_property_get(propname, propvalue) < 1) {\n+#  ifdef HAVE___SYSTEM_PROPERTY_GET\n+  /* Old way using the system property still in place as\n+   * a fallback. Older android versions can still use this.\n+   * it's possible for older apps not not have added the new\n+   * permission and we want to try to avoid breaking those.\n+   *\n+   * We'll only run this if we don't have any dns servers\n+   * because this will get the same ones (if it works). */\n+  if (status != ARES_EOF) {\n+    for (i = 1; i <= MAX_DNS_PROPERTIES; i++) {\n+      snprintf(propname, sizeof(propname), \"%s%u\", DNS_PROP_NAME_PREFIX, i);\n+      if (__system_property_get(propname, propvalue) < 1) {\n+        status = ARES_EOF;\n+        break;\n+      }\n+\n+      status = config_nameserver(&servers, &nservers, propvalue);\n+      if (status != ARES_SUCCESS)\n+        break;\n       status = ARES_EOF;\n-      break;\n     }\n-    status = config_nameserver(&servers, &nservers, propvalue);\n-    if (status != ARES_SUCCESS)\n-      break;\n-    status = ARES_EOF;\n   }\n+#  endif /* HAVE___SYSTEM_PROPERTY_GET */\n #elif defined(CARES_USE_LIBRESOLV)\n   struct __res_state res;\n   memset(&res, 0, sizeof(res));\n@@ -1873,8 +1990,10 @@ static int init_by_defaults(ares_channel channel)\n         continue;\n       }\n       else if(res) {\n-        rc = ARES_EBADNAME;\n-        goto error;\n+        /* Lets not treat a gethostname failure as critical, since we\n+         * are ok if gethostname doesn't even exist */\n+        *hostname = '\\0';\n+        break;\n       }\n \n     } while (res != 0);"
        },
        {
            "sha": "88e7a537480813bc04170e0c0d3af0ef0fc5bfaf",
            "filename": "deps/cares/src/ares_library_init.c",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_library_init.c",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_library_init.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2Fares_library_init.c?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -30,6 +30,10 @@ fpGetAdaptersAddresses_t ares_fpGetAdaptersAddresses = ZERO_NULL;\n fpGetBestRoute2_t ares_fpGetBestRoute2 = ZERO_NULL;\n #endif\n \n+#if defined(ANDROID) || defined(__ANDROID__)\n+#include \"ares_android.h\"\n+#endif\n+\n /* library-private global vars with source visibility restricted to this file */\n \n static unsigned int ares_initialized;\n@@ -160,6 +164,10 @@ void ares_library_cleanup(void)\n   if (ares_init_flags & ARES_LIB_INIT_WIN32)\n     ares_win32_cleanup();\n \n+#if defined(ANDROID) || defined(__ANDROID__)\n+  ares_library_cleanup_android();\n+#endif\n+\n   ares_init_flags = ARES_LIB_INIT_NONE;\n   ares_malloc = malloc;\n   ares_realloc = realloc;"
        },
        {
            "sha": "6c749dccb24a123b529ae529f346c983c54df129",
            "filename": "deps/cares/src/ares_platform.c",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_platform.c",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Fares_platform.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2Fares_platform.c?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -36,13 +36,20 @@ win_platform ares__getplatform(void)\n \n   memset(&OsvEx, 0, sizeof(OsvEx));\n   OsvEx.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEX);\n+#ifdef _MSC_VER\n+#pragma warning(push)\n+#pragma warning(disable:4996) /* warning C4996: 'GetVersionExW': was declared deprecated */\n+#endif\n   if (!GetVersionEx((void *)&OsvEx))\n     {\n       memset(&OsvEx, 0, sizeof(OsvEx));\n       OsvEx.dwOSVersionInfoSize = sizeof(OSVERSIONINFO);\n       if (!GetVersionEx((void *)&OsvEx))\n         return WIN_UNKNOWN;\n     }\n+#ifdef _MSC_VER\n+#pragma warning(pop)\n+#endif\n \n   switch(OsvEx.dwPlatformId)\n     {"
        },
        {
            "sha": "ce3ce588d3c0bdc6af5d28963f7d26754a50849d",
            "filename": "deps/cares/src/inet_ntop.c",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Finet_ntop.c",
            "raw_url": "https://github.com/nodejs/node/raw/b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68/deps%2Fcares%2Fsrc%2Finet_ntop.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fcares%2Fsrc%2Finet_ntop.c?ref=b0b7afcfbe0f38715af062ebcb9e1c6bbc68ba68",
            "patch": "@@ -54,7 +54,7 @@ static const char *inet_ntop6(const unsigned char *src, char *dst, size_t size);\n  *     On Windows we store the error in the thread errno, not\n  *     in the winsock error code. This is to avoid loosing the\n  *     actual last winsock error. So use macro ERRNO to fetch the\n- *     errno this funtion sets when returning NULL, not SOCKERRNO.\n+ *     errno this function sets when returning NULL, not SOCKERRNO.\n  * author:\n  *     Paul Vixie, 1996.\n  */"
        }
    ],
    "stats": {
        "total": 818,
        "additions": 653,
        "deletions": 165
    }
}