{
    "author": "thefourtheye",
    "message": "fs: make writeFile consistent with readFile wrt fd\n\nAs it is, `readFile` always reads from the current position of the file,\nif a file descriptor is used. But `writeFile` always writes from the\nbeginning of the file.\n\nThis patch fixes this inconsistency by making `writeFile` also to write\nfrom the current position of the file when used with a file descriptor.\n\nPR-URL: https://github.com/nodejs/node/pull/23709\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Vse Mozhet Byt <vsemozhetbyt@gmail.com>\nReviewed-By: Sam Roberts <vieuxtech@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Rod Vagg <rod@vagg.org>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: Сковорода Никита Андреевич <chalkerx@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d",
    "files": [
        {
            "sha": "873e93d9cde828b2ff97c4611a732dd58aba0932",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d",
            "patch": "@@ -1229,7 +1229,7 @@ function writeFile(path, data, options, callback) {\n   function writeFd(fd, isUserFd) {\n     const buffer = isArrayBufferView(data) ?\n       data : Buffer.from('' + data, options.encoding || 'utf8');\n-    const position = /a/.test(flag) ? null : 0;\n+    const position = (/a/.test(flag) || isUserFd) ? null : 0;\n \n     writeAll(fd, isUserFd, buffer, 0, buffer.byteLength, position, callback);\n   }\n@@ -1247,7 +1247,7 @@ function writeFileSync(path, data, options) {\n   }\n   let offset = 0;\n   let length = data.byteLength;\n-  let position = /a/.test(flag) ? null : 0;\n+  let position = (/a/.test(flag) || isUserFd) ? null : 0;\n   try {\n     while (length > 0) {\n       const written = fs.writeSync(fd, data, offset, length, position);"
        },
        {
            "sha": "9bf4c18536494977e4f8c25983e1a0c3a96822ca",
            "filename": "test/parallel/test-fs-promises-readfile-with-fd.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/nodejs/node/blob/8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d/test%2Fparallel%2Ftest-fs-promises-readfile-with-fd.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d/test%2Fparallel%2Ftest-fs-promises-readfile-with-fd.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-readfile-with-fd.js?ref=8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d",
            "patch": "@@ -0,0 +1,35 @@\n+'use strict';\n+\n+/*\n+ * This test makes sure that `readFile()` always reads from the current\n+ * position of the file, instead of reading from the beginning of the file.\n+ */\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const path = require('path');\n+const { writeFileSync } = require('fs');\n+const { open } = require('fs').promises;\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+const fn = path.join(tmpdir.path, 'test.txt');\n+writeFileSync(fn, 'Hello World');\n+\n+async function readFileTest() {\n+  const handle = await open(fn, 'r');\n+\n+  /* Read only five bytes, so that the position moves to five. */\n+  const buf = Buffer.alloc(5);\n+  const { bytesRead } = await handle.read(buf, 0, 5, null);\n+  assert.strictEqual(bytesRead, 5);\n+  assert.deepStrictEqual(buf.toString(), 'Hello');\n+\n+  /* readFile() should read from position five, instead of zero. */\n+  assert.deepStrictEqual((await handle.readFile()).toString(), ' World');\n+}\n+\n+\n+readFileTest()\n+  .then(common.mustCall());"
        },
        {
            "sha": "a4cc31df7f4d5f58228eb9b62b9535852b75ec0f",
            "filename": "test/parallel/test-fs-promises-writefile-with-fd.js",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/nodejs/node/blob/8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d/test%2Fparallel%2Ftest-fs-promises-writefile-with-fd.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d/test%2Fparallel%2Ftest-fs-promises-writefile-with-fd.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-writefile-with-fd.js?ref=8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d",
            "patch": "@@ -0,0 +1,36 @@\n+'use strict';\n+\n+/*\n+ * This test makes sure that `writeFile()` always writes from the current\n+ * position of the file, instead of truncating the file.\n+ */\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const path = require('path');\n+const { readFileSync } = require('fs');\n+const { open } = require('fs').promises;\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+const fn = path.join(tmpdir.path, 'test.txt');\n+\n+async function writeFileTest() {\n+  const handle = await open(fn, 'w');\n+\n+  /* Write only five bytes, so that the position moves to five. */\n+  const buf = Buffer.from('Hello');\n+  const { bytesWritten } = await handle.write(buf, 0, 5, null);\n+  assert.strictEqual(bytesWritten, 5);\n+\n+  /* Write some more with writeFile(). */\n+  await handle.writeFile('World');\n+\n+  /* New content should be written at position five, instead of zero. */\n+  assert.deepStrictEqual(readFileSync(fn).toString(), 'HelloWorld');\n+}\n+\n+\n+writeFileTest()\n+  .then(common.mustCall());"
        },
        {
            "sha": "df0f428bf153c0739b3d3591992a7432d58fb0e4",
            "filename": "test/parallel/test-fs-readfile-fd.js",
            "status": "modified",
            "additions": 49,
            "deletions": 1,
            "changes": 50,
            "blob_url": "https://github.com/nodejs/node/blob/8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d/test%2Fparallel%2Ftest-fs-readfile-fd.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d/test%2Fparallel%2Ftest-fs-readfile-fd.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-readfile-fd.js?ref=8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d",
            "patch": "@@ -1,12 +1,15 @@\n 'use strict';\n-require('../common');\n+const common = require('../common');\n \n // Test fs.readFile using a file descriptor.\n \n const fixtures = require('../common/fixtures');\n const assert = require('assert');\n const fs = require('fs');\n const fn = fixtures.path('empty.txt');\n+const join = require('path').join;\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n \n tempFd(function(fd, close) {\n   fs.readFile(fd, function(err, data) {\n@@ -46,3 +49,48 @@ function tempFdSync(callback) {\n   callback(fd);\n   fs.closeSync(fd);\n }\n+\n+{\n+  /*\n+   * This test makes sure that `readFile()` always reads from the current\n+   * position of the file, instead of reading from the beginning of the file,\n+   * when used with file descriptors.\n+   */\n+\n+  const filename = join(tmpdir.path, 'test.txt');\n+  fs.writeFileSync(filename, 'Hello World');\n+\n+  {\n+    /* Tests the fs.readFileSync(). */\n+    const fd = fs.openSync(filename, 'r');\n+\n+    /* Read only five bytes, so that the position moves to five. */\n+    const buf = Buffer.alloc(5);\n+    assert.deepStrictEqual(fs.readSync(fd, buf, 0, 5), 5);\n+    assert.deepStrictEqual(buf.toString(), 'Hello');\n+\n+    /* readFileSync() should read from position five, instead of zero. */\n+    assert.deepStrictEqual(fs.readFileSync(fd).toString(), ' World');\n+  }\n+\n+  {\n+    /* Tests the fs.readFile(). */\n+    fs.open(filename, 'r', common.mustCall((err, fd) => {\n+      assert.ifError(err);\n+      const buf = Buffer.alloc(5);\n+\n+      /* Read only five bytes, so that the position moves to five. */\n+      fs.read(fd, buf, 0, 5, null, common.mustCall((err, bytes) => {\n+        assert.ifError(err);\n+        assert.strictEqual(bytes, 5);\n+        assert.deepStrictEqual(buf.toString(), 'Hello');\n+\n+        fs.readFile(fd, common.mustCall((err, data) => {\n+          assert.ifError(err);\n+          /* readFile() should read from position five, instead of zero. */\n+          assert.deepStrictEqual(data.toString(), ' World');\n+        }));\n+      }));\n+    }));\n+  }\n+}"
        },
        {
            "sha": "6851518d4dcc9a86cd426f7d7ced6a132e7a1c82",
            "filename": "test/parallel/test-fs-writefile-with-fd.js",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/nodejs/node/blob/8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d/test%2Fparallel%2Ftest-fs-writefile-with-fd.js",
            "raw_url": "https://github.com/nodejs/node/raw/8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d/test%2Fparallel%2Ftest-fs-writefile-with-fd.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-writefile-with-fd.js?ref=8f4b924f4a7b37bd16ddff65329c8e96fc5f0f2d",
            "patch": "@@ -0,0 +1,58 @@\n+'use strict';\n+\n+/*\n+ * This test makes sure that `writeFile()` always writes from the current\n+ * position of the file, instead of truncating the file, when used with file\n+ * descriptors.\n+ */\n+\n+const common = require('../common');\n+const assert = require('assert');\n+const fs = require('fs');\n+const join = require('path').join;\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+{\n+  /* writeFileSync() test. */\n+  const filename = join(tmpdir.path, 'test.txt');\n+\n+  /* Open the file descriptor. */\n+  const fd = fs.openSync(filename, 'w');\n+\n+  /* Write only five characters, so that the position moves to five. */\n+  assert.deepStrictEqual(fs.writeSync(fd, 'Hello'), 5);\n+  assert.deepStrictEqual(fs.readFileSync(filename).toString(), 'Hello');\n+\n+  /* Write some more with writeFileSync(). */\n+  fs.writeFileSync(fd, 'World');\n+\n+  /* New content should be written at position five, instead of zero. */\n+  assert.deepStrictEqual(fs.readFileSync(filename).toString(), 'HelloWorld');\n+}\n+\n+{\n+  /* writeFile() test. */\n+  const file = join(tmpdir.path, 'test1.txt');\n+\n+  /* Open the file descriptor. */\n+  fs.open(file, 'w', common.mustCall((err, fd) => {\n+    assert.ifError(err);\n+\n+    /* Write only five characters, so that the position moves to five. */\n+    fs.write(fd, 'Hello', common.mustCall((err, bytes) => {\n+      assert.ifError(err);\n+      assert.strictEqual(bytes, 5);\n+      assert.deepStrictEqual(fs.readFileSync(file).toString(), 'Hello');\n+\n+      /* Write some more with writeFile(). */\n+      fs.writeFile(fd, 'World', common.mustCall((err) => {\n+        assert.ifError(err);\n+\n+        /* New content should be written at position five, instead of zero. */\n+        assert.deepStrictEqual(fs.readFileSync(file).toString(), 'HelloWorld');\n+      }));\n+    }));\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 183,
        "additions": 180,
        "deletions": 3
    }
}