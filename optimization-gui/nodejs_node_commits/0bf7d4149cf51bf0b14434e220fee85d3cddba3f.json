{
    "author": "antsmartian",
    "message": "test: adding history regression test case\n\nPR-URL: https://github.com/nodejs/node/pull/24843\nRefs: https://github.com/nodejs/node/issues/24385\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "0bf7d4149cf51bf0b14434e220fee85d3cddba3f",
    "files": [
        {
            "sha": "562b79dae846d43992f9ad24e01abef68b53f99e",
            "filename": "test/parallel/test-repl-history-navigation.js",
            "status": "added",
            "additions": 139,
            "deletions": 0,
            "changes": 139,
            "blob_url": "https://github.com/nodejs/node/blob/0bf7d4149cf51bf0b14434e220fee85d3cddba3f/test%2Fparallel%2Ftest-repl-history-navigation.js",
            "raw_url": "https://github.com/nodejs/node/raw/0bf7d4149cf51bf0b14434e220fee85d3cddba3f/test%2Fparallel%2Ftest-repl-history-navigation.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-history-navigation.js?ref=0bf7d4149cf51bf0b14434e220fee85d3cddba3f",
            "patch": "@@ -0,0 +1,139 @@\n+'use strict';\n+\n+// Flags: --expose-internals\n+\n+const common = require('../common');\n+const stream = require('stream');\n+const REPL = require('internal/repl');\n+const assert = require('assert');\n+const fs = require('fs');\n+const path = require('path');\n+\n+const tmpdir = require('../common/tmpdir');\n+tmpdir.refresh();\n+\n+const defaultHistoryPath = path.join(tmpdir.path, '.node_repl_history');\n+\n+// Create an input stream specialized for testing an array of actions\n+class ActionStream extends stream.Stream {\n+  run(data) {\n+    const _iter = data[Symbol.iterator]();\n+    const doAction = () => {\n+      const next = _iter.next();\n+      if (next.done) {\n+        // Close the repl. Note that it must have a clean prompt to do so.\n+        this.emit('keypress', '', { ctrl: true, name: 'd' });\n+        return;\n+      }\n+      const action = next.value;\n+\n+      if (typeof action === 'object') {\n+        this.emit('keypress', '', action);\n+      } else {\n+        this.emit('data', `${action}`);\n+      }\n+      setImmediate(doAction);\n+    };\n+    setImmediate(doAction);\n+  }\n+  resume() {}\n+  pause() {}\n+}\n+ActionStream.prototype.readable = true;\n+\n+\n+// Mock keys\n+const ENTER = { name: 'enter' };\n+const UP = { name: 'up' };\n+const DOWN = { name: 'down' };\n+\n+const prompt = '> ';\n+\n+const tests = [\n+  { // creates few history to navigate for\n+    env: { NODE_REPL_HISTORY: defaultHistoryPath },\n+    test: [ 'let ab = 45', ENTER,\n+            '555 + 909', ENTER,\n+            '{key : {key2 :[] }}', ENTER],\n+    expected: [],\n+    clean: false\n+  },\n+  {\n+    env: { NODE_REPL_HISTORY: defaultHistoryPath },\n+    test: [UP, UP, UP, UP, DOWN, DOWN, DOWN],\n+    expected: [prompt,\n+               `${prompt}{key : {key2 :[] }}`,\n+               `${prompt}555 + 909`,\n+               `${prompt}let ab = 45`,\n+               `${prompt}555 + 909`,\n+               `${prompt}{key : {key2 :[] }}`,\n+               prompt],\n+    clean: true\n+  }\n+];\n+const numtests = tests.length;\n+\n+const runTestWrap = common.mustCall(runTest, numtests);\n+\n+function cleanupTmpFile() {\n+  try {\n+    // Write over the file, clearing any history\n+    fs.writeFileSync(defaultHistoryPath, '');\n+  } catch (err) {\n+    if (err.code === 'ENOENT') return true;\n+    throw err;\n+  }\n+  return true;\n+}\n+\n+function runTest() {\n+  const opts = tests.shift();\n+  if (!opts) return; // All done\n+\n+  const env = opts.env;\n+  const test = opts.test;\n+  const expected = opts.expected;\n+\n+  REPL.createInternalRepl(env, {\n+    input: new ActionStream(),\n+    output: new stream.Writable({\n+      write(chunk, _, next) {\n+        const output = chunk.toString();\n+\n+        if (output.charCodeAt(0) === 27 || /^[\\r\\n]+$/.test(output)) {\n+          return next();\n+        }\n+\n+        if (expected.length) {\n+          assert.strictEqual(output, expected[0]);\n+          expected.shift();\n+        }\n+\n+        next();\n+      }\n+    }),\n+    prompt: prompt,\n+    useColors: false,\n+    terminal: true\n+  }, function(err, repl) {\n+    if (err) {\n+      console.error(`Failed test # ${numtests - tests.length}`);\n+      throw err;\n+    }\n+\n+    repl.once('close', () => {\n+      if (opts.clean)\n+        cleanupTmpFile();\n+\n+      if (expected.length !== 0) {\n+        throw new Error(`Failed test # ${numtests - tests.length}`);\n+      }\n+      setImmediate(runTestWrap, true);\n+    });\n+\n+    repl.inputStream.run(test);\n+  });\n+}\n+\n+// run the tests\n+runTest();"
        }
    ],
    "stats": {
        "total": 139,
        "additions": 139,
        "deletions": 0
    }
}