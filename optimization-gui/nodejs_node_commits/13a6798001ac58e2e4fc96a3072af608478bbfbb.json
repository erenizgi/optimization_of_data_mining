{
    "author": "sam-github",
    "message": "test: confirm tls server suite default is its own\n\nWhen honorCipherOrder is not explicitly set, it defaults to true, cover\nthis condition in the test. Also, run all tests in parallel, instead of\nsequentially.\n\nPR-URL: https://github.com/nodejs/node/pull/24374\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Franziska Hinkelmann <franziska.hinkelmann@gmail.com>",
    "sha": "13a6798001ac58e2e4fc96a3072af608478bbfbb",
    "files": [
        {
            "sha": "8e7c4badcb269d1bc7ea8bdb08133a72d4d01714",
            "filename": "test/parallel/test-tls-honorcipherorder.js",
            "status": "modified",
            "additions": 47,
            "deletions": 54,
            "changes": 101,
            "blob_url": "https://github.com/nodejs/node/blob/13a6798001ac58e2e4fc96a3072af608478bbfbb/test%2Fparallel%2Ftest-tls-honorcipherorder.js",
            "raw_url": "https://github.com/nodejs/node/raw/13a6798001ac58e2e4fc96a3072af608478bbfbb/test%2Fparallel%2Ftest-tls-honorcipherorder.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-honorcipherorder.js?ref=13a6798001ac58e2e4fc96a3072af608478bbfbb",
            "patch": "@@ -1,41 +1,38 @@\n 'use strict';\n const common = require('../common');\n const fixtures = require('../common/fixtures');\n+\n+// Test the honorCipherOrder property\n+\n if (!common.hasCrypto)\n   common.skip('missing crypto');\n \n const assert = require('assert');\n+const mustCall = common.mustCall;\n const tls = require('tls');\n-\n-let nconns = 0;\n+const util = require('util');\n \n // We explicitly set TLS version to 1.2 so as to be safe when the\n // default method is updated in the future\n const SSL_Method = 'TLSv1_2_method';\n const localhost = '127.0.0.1';\n \n-process.on('exit', function() {\n-  assert.strictEqual(nconns, 6);\n-});\n-\n-function test(honorCipherOrder, clientCipher, expectedCipher, cb) {\n+function test(honorCipherOrder, clientCipher, expectedCipher, defaultCiphers) {\n   const soptions = {\n     secureProtocol: SSL_Method,\n     key: fixtures.readKey('agent2-key.pem'),\n     cert: fixtures.readKey('agent2-cert.pem'),\n     ciphers: 'AES256-SHA256:AES128-GCM-SHA256:AES128-SHA256:' +\n              'ECDHE-RSA-AES128-GCM-SHA256',\n-    honorCipherOrder: !!honorCipherOrder\n+    honorCipherOrder: honorCipherOrder,\n   };\n \n-  const server = tls.createServer(soptions, function(cleartextStream) {\n-    nconns++;\n-\n+  const server = tls.createServer(soptions, mustCall(function(clearTextStream) {\n     // End socket to send CLOSE_NOTIFY and TCP FIN packet, otherwise\n     // it may hang for ~30 seconds in FIN_WAIT_1 state (at least on OSX).\n-    cleartextStream.end();\n-  });\n-  server.listen(0, localhost, function() {\n+    clearTextStream.end();\n+  }));\n+  server.listen(0, localhost, mustCall(function() {\n     const coptions = {\n       rejectUnauthorized: false,\n       secureProtocol: SSL_Method\n@@ -44,54 +41,50 @@ function test(honorCipherOrder, clientCipher, expectedCipher, cb) {\n       coptions.ciphers = clientCipher;\n     }\n     const port = this.address().port;\n-    const client = tls.connect(port, localhost, coptions, function() {\n+    const savedDefaults = tls.DEFAULT_CIPHERS;\n+    tls.DEFAULT_CIPHERS = defaultCiphers || savedDefaults;\n+    const client = tls.connect(port, localhost, coptions, mustCall(function() {\n       const cipher = client.getCipher();\n       client.end();\n       server.close();\n-      assert.strictEqual(cipher.name, expectedCipher);\n-      if (cb) cb();\n-    });\n-  });\n+      const msg = util.format(\n+        'honorCipherOrder=%j, clientCipher=%j, expect=%j, got=%j',\n+        honorCipherOrder, clientCipher, expectedCipher, cipher.name);\n+      assert.strictEqual(cipher.name, expectedCipher, msg);\n+    }));\n+    tls.DEFAULT_CIPHERS = savedDefaults;\n+  }));\n }\n \n-test1();\n-\n-function test1() {\n-  // Client has the preference of cipher suites by default\n-  test(false, 'AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256',\n-       'AES128-GCM-SHA256', test2);\n-}\n+// Client explicitly has the preference of cipher suites, not the default.\n+test(false, 'AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256',\n+     'AES128-GCM-SHA256');\n \n-function test2() {\n-  // Server has the preference of cipher suites, and AES256-SHA256 is\n-  // the server's top choice.\n-  test(true, 'AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256',\n-       'AES256-SHA256', test3);\n-}\n+// Server has the preference of cipher suites, and AES256-SHA256 is\n+// the server's top choice.\n+test(true, 'AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256',\n+     'AES256-SHA256');\n+test(undefined, 'AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256',\n+     'AES256-SHA256');\n \n-function test3() {\n-  // Server has the preference of cipher suites. AES128-GCM-SHA256 is given\n-  // higher priority over AES128-SHA256 among client cipher suites.\n-  test(true, 'AES128-SHA256:AES128-GCM-SHA256', 'AES128-GCM-SHA256', test4);\n+// Server has the preference of cipher suites. AES128-GCM-SHA256 is given\n+// higher priority over AES128-SHA256 among client cipher suites.\n+test(true, 'AES128-SHA256:AES128-GCM-SHA256', 'AES128-GCM-SHA256');\n+test(undefined, 'AES128-SHA256:AES128-GCM-SHA256', 'AES128-GCM-SHA256');\n \n-}\n \n-function test4() {\n-  // As client has only one cipher, server has no choice, irrespective\n-  // of honorCipherOrder.\n-  test(true, 'AES128-SHA256', 'AES128-SHA256', test5);\n-}\n+// As client has only one cipher, server has no choice, irrespective\n+// of honorCipherOrder.\n+test(true, 'AES128-SHA256', 'AES128-SHA256');\n+test(undefined, 'AES128-SHA256', 'AES128-SHA256');\n \n-function test5() {\n-  // Client did not explicitly set ciphers and client offers\n-  // tls.DEFAULT_CIPHERS. All ciphers of the server are included in the\n-  // default list so the negotiated cipher is selected according to the\n-  // server's top preference of AES256-SHA256.\n-  test(true, null, 'AES256-SHA256', test6);\n-}\n+// Client did not explicitly set ciphers and client offers\n+// tls.DEFAULT_CIPHERS. All ciphers of the server are included in the\n+// default list so the negotiated cipher is selected according to the\n+// server's top preference of AES256-SHA256.\n+test(true, tls.DEFAULT_CIPHERS, 'AES256-SHA256');\n+test(true, null, 'AES256-SHA256');\n+test(undefined, null, 'AES256-SHA256');\n \n-function test6() {\n-  // Ensure that `tls.DEFAULT_CIPHERS` is used\n-  tls.DEFAULT_CIPHERS = 'ECDHE-RSA-AES128-GCM-SHA256';\n-  test(true, null, 'ECDHE-RSA-AES128-GCM-SHA256');\n-}\n+// Ensure that `tls.DEFAULT_CIPHERS` is used when its a limited cipher set.\n+test(true, null, 'ECDHE-RSA-AES128-GCM-SHA256', 'ECDHE-RSA-AES128-GCM-SHA256');"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 47,
        "deletions": 54
    }
}