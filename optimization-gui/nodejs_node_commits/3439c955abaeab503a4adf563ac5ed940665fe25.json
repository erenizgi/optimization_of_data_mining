{
    "author": "BridgeAR",
    "message": "process: improve `--redirect-warnings` handling\n\n1) Acquiring the file descriptor is not observable anymore when using\n   the `--redirect-warnings` flag.\n2) If `fs.appendFile` fails, the warning is now redirected to the\n   default output.\n3) The code is smaller and simpler.\n\nPR-URL: https://github.com/nodejs/node/pull/24965\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "3439c955abaeab503a4adf563ac5ed940665fe25",
    "files": [
        {
            "sha": "4d606b938949cf201c6ef253b20aaf887f6b9505",
            "filename": "lib/internal/process/warning.js",
            "status": "modified",
            "additions": 34,
            "deletions": 64,
            "changes": 98,
            "blob_url": "https://github.com/nodejs/node/blob/3439c955abaeab503a4adf563ac5ed940665fe25/lib%2Finternal%2Fprocess%2Fwarning.js",
            "raw_url": "https://github.com/nodejs/node/raw/3439c955abaeab503a4adf563ac5ed940665fe25/lib%2Finternal%2Fprocess%2Fwarning.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fwarning.js?ref=3439c955abaeab503a4adf563ac5ed940665fe25",
            "patch": "@@ -5,84 +5,50 @@ const { ERR_INVALID_ARG_TYPE } = require('internal/errors').codes;\n \n exports.setup = setupProcessWarnings;\n \n-let options;\n-function lazyOption(name) {\n-  if (!options) {\n-    options = require('internal/options');\n+// Lazily loaded\n+let fs;\n+let fd;\n+let warningFile;\n+\n+function lazyOption() {\n+  // This will load `warningFile` only once. If the flag is not set,\n+  // `warningFile` will be set to an empty string.\n+  if (warningFile === undefined) {\n+    warningFile = require('internal/options')\n+                  .getOptionValue('--redirect-warnings');\n   }\n-  return options.getOptionValue(name);\n+  return warningFile;\n }\n \n-var cachedFd;\n-var acquiringFd = false;\n-function nop() {}\n-\n-// Lazily loaded\n-var fs = null;\n-\n function writeOut(message) {\n   if (console && typeof console.error === 'function')\n     return console.error(message);\n   process._rawDebug(message);\n }\n \n-function onClose(fd) {\n-  return () => {\n-    if (fs === null) fs = require('fs');\n+function writeToFile(message) {\n+  if (fd === undefined) {\n+    fs = require('fs');\n     try {\n-      fs.closeSync(fd);\n-    } catch {}\n-  };\n-}\n-\n-function onOpen(cb) {\n-  return (err, fd) => {\n-    acquiringFd = false;\n-    if (fd !== undefined) {\n-      cachedFd = fd;\n-      process.on('exit', onClose(fd));\n-    }\n-    cb(err, fd);\n-    process.emit('_node_warning_fd_acquired', err, fd);\n-  };\n-}\n-\n-function onAcquired(message) {\n-  // make a best effort attempt at writing the message\n-  // to the fd. Errors are ignored at this point.\n-  return (err, fd) => {\n-    if (err)\n+      fd = fs.openSync(warningFile, 'a');\n+    } catch {\n       return writeOut(message);\n-    if (fs === null) fs = require('fs');\n-    fs.appendFile(fd, `${message}\\n`, nop);\n-  };\n-}\n-\n-function acquireFd(warningFile, cb) {\n-  if (cachedFd === undefined && !acquiringFd) {\n-    acquiringFd = true;\n-    if (fs === null) fs = require('fs');\n-    fs.open(warningFile, 'a', onOpen(cb));\n-  } else if (cachedFd !== undefined && !acquiringFd) {\n-    cb(null, cachedFd);\n-  } else {\n-    process.once('_node_warning_fd_acquired', cb);\n-  }\n-}\n-\n-function output(message) {\n-  const warningFile = lazyOption('--redirect-warnings');\n-  if (warningFile) {\n-    acquireFd(warningFile, onAcquired(message));\n-    return;\n+    }\n+    process.on('exit', () => {\n+      try {\n+        fs.closeSync(fd);\n+      } catch {}\n+    });\n   }\n-  writeOut(message);\n+  fs.appendFile(fd, `${message}\\n`, (err) => {\n+    if (err) {\n+      writeOut(message);\n+    }\n+  });\n }\n \n function doEmitWarning(warning) {\n-  return () => {\n-    process.emit('warning', warning);\n-  };\n+  return () => process.emit('warning', warning);\n }\n \n function setupProcessWarnings() {\n@@ -107,7 +73,11 @@ function setupProcessWarnings() {\n       if (typeof warning.detail === 'string') {\n         msg += `\\n${warning.detail}`;\n       }\n-      output(msg);\n+      const warningFile = lazyOption();\n+      if (warningFile) {\n+        return writeToFile(msg);\n+      }\n+      writeOut(msg);\n     });\n   }\n "
        }
    ],
    "stats": {
        "total": 98,
        "additions": 34,
        "deletions": 64
    }
}