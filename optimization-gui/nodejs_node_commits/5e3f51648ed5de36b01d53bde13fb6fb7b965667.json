{
    "author": "mafintosh",
    "message": "stream: updated streams error handling\n\nThis improves error handling for streams in a few ways.\n\n1. It ensures that no user defined methods (_read, _write, ...) are run\nafter .destroy has been called.\n2. It introduces an explicit error to tell the user if they are write to\nwrite, etc to the stream after it has been destroyed.\n3. It makes streams always emit close as the last thing after they have\nbeen destroyed\n4. Changes the default _destroy to not gracefully end streams.\n\nIt also updates net, http2, zlib and fs to the new error handling.\n\nPR-URL: https://github.com/nodejs/node/pull/18438\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "5e3f51648ed5de36b01d53bde13fb6fb7b965667",
    "files": [
        {
            "sha": "70ac01de610d6a88a06fb60d28ef8e8ba739605b",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -1449,6 +1449,12 @@ An unspecified or non-specific system error has occurred within the Node.js\n process. The error object will have an `err.info` object property with\n additional details.\n \n+<a id=\"ERR_STREAM_DESTROYED\"></a>\n+### ERR_STREAM_DESTROYED\n+\n+A stream method was called that cannot complete because the stream was\n+destroyed using `stream.destroy()`.\n+\n <a id=\"ERR_TLS_CERT_ALTNAME_INVALID\"></a>\n ### ERR_TLS_CERT_ALTNAME_INVALID\n \n@@ -1615,11 +1621,6 @@ The fulfilled value of a linking promise is not a `vm.Module` object.\n The current module's status does not allow for this operation. The specific\n meaning of the error depends on the specific function.\n \n-<a id=\"ERR_ZLIB_BINDING_CLOSED\"></a>\n-### ERR_ZLIB_BINDING_CLOSED\n-\n-An attempt was made to use a `zlib` object after it has already been closed.\n-\n <a id=\"ERR_ZLIB_INITIALIZATION_FAILED\"></a>\n ### ERR_ZLIB_INITIALIZATION_FAILED\n "
        },
        {
            "sha": "32e368f05f18750731e666448c6e826ac95fc2a7",
            "filename": "doc/api/stream.md",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/doc%2Fapi%2Fstream.md",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/doc%2Fapi%2Fstream.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fstream.md?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -543,8 +543,10 @@ added: v8.0.0\n \n * Returns: {this}\n \n-Destroy the stream, and emit the passed error. After this call, the\n-writable stream has ended. Implementors should not override this method,\n+Destroy the stream, and emit the passed `error` and a `close` event.\n+After this call, the writable stream has ended and subsequent calls\n+to `write` / `end` will give an `ERR_STREAM_DESTROYED` error.\n+Implementors should not override this method,\n but instead implement [`writable._destroy`][writable-_destroy].\n \n ### Readable Streams\n@@ -1167,8 +1169,9 @@ myReader.on('readable', () => {\n added: v8.0.0\n -->\n \n-Destroy the stream, and emit `'error'`. After this call, the\n-readable stream will release any internal resources.\n+Destroy the stream, and emit `'error'` and `close`. After this call, the\n+readable stream will release any internal resources and subsequent calls\n+to `push` will be ignored.\n Implementors should not override this method, but instead implement\n [`readable._destroy`][readable-_destroy].\n \n@@ -1382,6 +1385,12 @@ constructor and implement the `writable._write()` method. The\n `writable._writev()` method *may* also be implemented.\n \n #### Constructor: new stream.Writable([options])\n+<!-- YAML\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/18438\n+    description: Add `emitClose` option to specify if `close` is emitted on destroy\n+-->\n \n * `options` {Object}\n   * `highWaterMark` {number} Buffer level when\n@@ -1395,6 +1404,8 @@ constructor and implement the `writable._write()` method. The\n     it becomes possible to write JavaScript values other than string,\n     `Buffer` or `Uint8Array` if supported by the stream implementation.\n     Defaults to `false`\n+  * `emitClose` {boolean} Whether or not the stream should emit `close`\n+    after it has been destroyed. Defaults to `true`\n   * `write` {Function} Implementation for the\n     [`stream._write()`][stream-_write] method.\n   * `writev` {Function} Implementation for the"
        },
        {
            "sha": "1ccb931260ddbd1af2c48fb4d2303de11b065914",
            "filename": "lib/_stream_duplex.js",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2F_stream_duplex.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2F_stream_duplex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_duplex.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -135,10 +135,3 @@ Object.defineProperty(Duplex.prototype, 'destroyed', {\n     this._writableState.destroyed = value;\n   }\n });\n-\n-Duplex.prototype._destroy = function(err, cb) {\n-  this.push(null);\n-  this.end();\n-\n-  process.nextTick(cb, err);\n-};"
        },
        {
            "sha": "5781dfd471e72d3000ebc8ccde1d9a5c6235393e",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -106,6 +106,9 @@ function ReadableState(options, stream) {\n   this.readableListening = false;\n   this.resumeScheduled = false;\n \n+  // Should close be emitted on destroy. Defaults to true.\n+  this.emitClose = options.emitClose !== false;\n+\n   // has it been destroyed\n   this.destroyed = false;\n \n@@ -177,7 +180,6 @@ Object.defineProperty(Readable.prototype, 'destroyed', {\n Readable.prototype.destroy = destroyImpl.destroy;\n Readable.prototype._undestroy = destroyImpl.undestroy;\n Readable.prototype._destroy = function(err, cb) {\n-  this.push(null);\n   cb(err);\n };\n \n@@ -236,6 +238,8 @@ function readableAddChunk(stream, chunk, encoding, addToFront, skipChunkCheck) {\n           addChunk(stream, state, chunk, true);\n       } else if (state.ended) {\n         stream.emit('error', new errors.Error('ERR_STREAM_PUSH_AFTER_EOF'));\n+      } else if (state.destroyed) {\n+        return false;\n       } else {\n         state.reading = false;\n         if (state.decoder && !encoding) {"
        },
        {
            "sha": "b82114ecaecd1d81ce60e2aa43b8ef4c27f50a3f",
            "filename": "lib/_stream_transform.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2F_stream_transform.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2F_stream_transform.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_transform.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -132,7 +132,7 @@ function Transform(options) {\n }\n \n function prefinish() {\n-  if (typeof this._flush === 'function') {\n+  if (typeof this._flush === 'function' && !this._readableState.destroyed) {\n     this._flush((er, data) => {\n       done(this, er, data);\n     });\n@@ -194,7 +194,6 @@ Transform.prototype._read = function(n) {\n Transform.prototype._destroy = function(err, cb) {\n   Duplex.prototype._destroy.call(this, err, (err2) => {\n     cb(err2);\n-    this.emit('close');\n   });\n };\n "
        },
        {
            "sha": "d5cfe07f17132466b62f8fa2051c31164afb9df0",
            "filename": "lib/_stream_writable.js",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2F_stream_writable.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2F_stream_writable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_writable.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -134,6 +134,9 @@ function WritableState(options, stream) {\n   // True if the error was already emitted and should not be thrown again\n   this.errorEmitted = false;\n \n+  // Should close be emitted on destroy. Defaults to true.\n+  this.emitClose = options.emitClose !== false;\n+\n   // count buffered requests\n   this.bufferedRequestCount = 0;\n \n@@ -390,7 +393,9 @@ function doWrite(stream, state, writev, len, chunk, encoding, cb) {\n   state.writecb = cb;\n   state.writing = true;\n   state.sync = true;\n-  if (writev)\n+  if (state.destroyed)\n+    state.onwrite(new errors.Error('ERR_STREAM_DESTROYED', 'write'));\n+  else if (writev)\n     stream._writev(chunk, state.onwrite);\n   else\n     stream._write(chunk, encoding, state.onwrite);\n@@ -604,7 +609,7 @@ function callFinal(stream, state) {\n }\n function prefinish(stream, state) {\n   if (!state.prefinished && !state.finalCalled) {\n-    if (typeof stream._final === 'function') {\n+    if (typeof stream._final === 'function' && !state.destroyed) {\n       state.pendingcb++;\n       state.finalCalled = true;\n       process.nextTick(callFinal, stream, state);\n@@ -681,6 +686,5 @@ Object.defineProperty(Writable.prototype, 'destroyed', {\n Writable.prototype.destroy = destroyImpl.destroy;\n Writable.prototype._undestroy = destroyImpl.undestroy;\n Writable.prototype._destroy = function(err, cb) {\n-  this.end();\n   cb(err);\n };"
        },
        {
            "sha": "917c3eb3a9f640e2b66483844dc9a696ee605de8",
            "filename": "lib/fs.js",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Ffs.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Ffs.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ffs.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -1929,6 +1929,9 @@ function ReadStream(path, options) {\n   if (options.highWaterMark === undefined)\n     options.highWaterMark = 64 * 1024;\n \n+  // for backwards compat do not emit close on destroy.\n+  options.emitClose = false;\n+\n   Readable.call(this, options);\n \n   // path will be ignored when fd is specified, so it can be falsy\n@@ -2084,6 +2087,9 @@ function WriteStream(path, options) {\n \n   options = copyObject(getOptions(options, {}));\n \n+  // for backwards compat do not emit close on destroy.\n+  options.emitClose = false;\n+\n   Writable.call(this, options);\n \n   // path will be ignored when fd is specified, so it can be falsy"
        },
        {
            "sha": "11f32ccdc17dc95562fcda3297c92d18cf679728",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -843,6 +843,7 @@ E('ERR_SOCKET_DGRAM_NOT_RUNNING', 'Not running', Error);\n E('ERR_STDERR_CLOSE', 'process.stderr cannot be closed', Error);\n E('ERR_STDOUT_CLOSE', 'process.stdout cannot be closed', Error);\n E('ERR_STREAM_CANNOT_PIPE', 'Cannot pipe, not readable', Error);\n+E('ERR_STREAM_DESTROYED', 'Cannot call %s after a stream was destroyed');\n E('ERR_STREAM_NULL_VALUES', 'May not write null values to stream', TypeError);\n E('ERR_STREAM_PUSH_AFTER_EOF', 'stream.push() after EOF', Error);\n E('ERR_STREAM_READ_NOT_IMPLEMENTED', '_read() is not implemented', Error);\n@@ -908,7 +909,6 @@ E('ERR_VM_MODULE_NOT_LINKED',\n E('ERR_VM_MODULE_NOT_MODULE',\n   'Provided module is not an instance of Module', Error);\n E('ERR_VM_MODULE_STATUS', 'Module status %s', Error);\n-E('ERR_ZLIB_BINDING_CLOSED', 'zlib binding closed', Error);\n E('ERR_ZLIB_INITIALIZATION_FAILED', 'Initialization failed', Error);\n \n function sysError(code, syscall, path, dest,"
        },
        {
            "sha": "f60c6388af6ceca3e71d248ba27b3605ac0ded81",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -1475,6 +1475,7 @@ class Http2Stream extends Duplex {\n   constructor(session, options) {\n     options.allowHalfOpen = true;\n     options.decodeStrings = false;\n+    options.emitClose = false;\n     super(options);\n     this[async_id_symbol] = -1;\n "
        },
        {
            "sha": "5d29e182041cdc996a700d4dfb503768d1a203b4",
            "filename": "lib/internal/streams/destroy.js",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Finternal%2Fstreams%2Fdestroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Finternal%2Fstreams%2Fdestroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstreams%2Fdestroy.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -30,6 +30,7 @@ function destroy(err, cb) {\n   }\n \n   this._destroy(err || null, (err) => {\n+    process.nextTick(emitCloseNT, this);\n     if (!cb && err) {\n       process.nextTick(emitErrorNT, this, err);\n       if (this._writableState) {\n@@ -43,6 +44,14 @@ function destroy(err, cb) {\n   return this;\n }\n \n+function emitCloseNT(self) {\n+  if (self._writableState && !self._writableState.emitClose)\n+    return;\n+  if (self._readableState && !self._readableState.emitClose)\n+    return;\n+  self.emit('close');\n+}\n+\n function undestroy() {\n   if (this._readableState) {\n     this._readableState.destroyed = false;"
        },
        {
            "sha": "f2cb423f3003ea981ece59a7a37dd06da908d67e",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -232,6 +232,11 @@ function Socket(options) {\n     options = { fd: options }; // Legacy interface.\n   else if (options === undefined)\n     options = {};\n+  else\n+    options = util._extend({}, options);\n+\n+  // For backwards compat do not emit close on destroy.\n+  options.emitClose = false;\n \n   stream.Duplex.call(this, options);\n "
        },
        {
            "sha": "4adfd1ffa289fb05c01afd892b421ad87d1bf36a",
            "filename": "lib/zlib.js",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Fzlib.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/lib%2Fzlib.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fzlib.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -25,7 +25,6 @@ const {\n   ERR_BUFFER_TOO_LARGE,\n   ERR_INVALID_ARG_TYPE,\n   ERR_OUT_OF_RANGE,\n-  ERR_ZLIB_BINDING_CLOSED,\n   ERR_ZLIB_INITIALIZATION_FAILED\n } = require('internal/errors').codes;\n const Transform = require('_stream_transform');\n@@ -392,7 +391,7 @@ Zlib.prototype.flush = function flush(kind, callback) {\n \n Zlib.prototype.close = function close(callback) {\n   _close(this, callback);\n-  process.nextTick(emitCloseNT, this);\n+  this.destroy();\n };\n \n Zlib.prototype._transform = function _transform(chunk, encoding, cb) {\n@@ -510,7 +509,7 @@ function processChunkSync(self, chunk, flushFlag) {\n function processChunk(self, chunk, flushFlag, cb) {\n   var handle = self._handle;\n   if (!handle)\n-    return cb(new ERR_ZLIB_BINDING_CLOSED());\n+    assert(false, 'zlib binding closed');\n \n   handle.buffer = chunk;\n   handle.cb = cb;\n@@ -603,10 +602,6 @@ function _close(engine, callback) {\n   engine._handle = null;\n }\n \n-function emitCloseNT(self) {\n-  self.emit('close');\n-}\n-\n // generic zlib\n // minimal 2-byte header\n function Deflate(opts) {"
        },
        {
            "sha": "aa587fc2e16896e69113ad7401bc3d14912c7474",
            "filename": "test/parallel/test-net-socket-destroy-send.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-net-socket-destroy-send.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-net-socket-destroy-send.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-net-socket-destroy-send.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -13,14 +13,14 @@ server.listen(0, common.mustCall(function() {\n     // Test destroy returns this, even on multiple calls when it short-circuits.\n     assert.strictEqual(conn, conn.destroy().destroy());\n     conn.on('error', common.expectsError({\n-      code: 'ERR_SOCKET_CLOSED',\n-      message: 'Socket is closed',\n+      code: 'ERR_STREAM_DESTROYED',\n+      message: 'Cannot call write after a stream was destroyed',\n       type: Error\n     }));\n \n     conn.write(Buffer.from('kaboom'), common.expectsError({\n-      code: 'ERR_SOCKET_CLOSED',\n-      message: 'Socket is closed',\n+      code: 'ERR_STREAM_DESTROYED',\n+      message: 'Cannot call write after a stream was destroyed',\n       type: Error\n     }));\n     server.close();"
        },
        {
            "sha": "854d29ffc130492fd1b4fa745ae3edf96e93227e",
            "filename": "test/parallel/test-stream-duplex-destroy.js",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-stream-duplex-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-stream-duplex-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-duplex-destroy.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -13,8 +13,9 @@ const { inherits } = require('util');\n \n   duplex.resume();\n \n-  duplex.on('end', common.mustCall());\n-  duplex.on('finish', common.mustCall());\n+  duplex.on('end', common.mustNotCall());\n+  duplex.on('finish', common.mustNotCall());\n+  duplex.on('close', common.mustCall());\n \n   duplex.destroy();\n   assert.strictEqual(duplex.destroyed, true);\n@@ -29,8 +30,8 @@ const { inherits } = require('util');\n \n   const expected = new Error('kaboom');\n \n-  duplex.on('end', common.mustCall());\n-  duplex.on('finish', common.mustCall());\n+  duplex.on('end', common.mustNotCall());\n+  duplex.on('finish', common.mustNotCall());\n   duplex.on('error', common.mustCall((err) => {\n     assert.strictEqual(err, expected);\n   }));\n@@ -78,6 +79,7 @@ const { inherits } = require('util');\n \n   // error is swallowed by the custom _destroy\n   duplex.on('error', common.mustNotCall('no error event'));\n+  duplex.on('close', common.mustCall());\n \n   duplex.destroy(expected);\n   assert.strictEqual(duplex.destroyed, true);\n@@ -159,8 +161,8 @@ const { inherits } = require('util');\n   });\n   duplex.resume();\n \n-  duplex.on('finish', common.mustCall());\n-  duplex.on('end', common.mustCall());\n+  duplex.on('finish', common.mustNotCall());\n+  duplex.on('end', common.mustNotCall());\n \n   duplex.destroy();\n   assert.strictEqual(duplex.destroyed, true);"
        },
        {
            "sha": "026aa8ca1603b85fd2593ca43079b4367a9430eb",
            "filename": "test/parallel/test-stream-readable-destroy.js",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-stream-readable-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-stream-readable-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-destroy.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -11,7 +11,7 @@ const { inherits } = require('util');\n   });\n   read.resume();\n \n-  read.on('end', common.mustCall());\n+  read.on('close', common.mustCall());\n \n   read.destroy();\n   assert.strictEqual(read.destroyed, true);\n@@ -25,7 +25,8 @@ const { inherits } = require('util');\n \n   const expected = new Error('kaboom');\n \n-  read.on('end', common.mustCall());\n+  read.on('end', common.mustNotCall('no end event'));\n+  read.on('close', common.mustCall());\n   read.on('error', common.mustCall((err) => {\n     assert.strictEqual(err, expected);\n   }));\n@@ -47,6 +48,7 @@ const { inherits } = require('util');\n   const expected = new Error('kaboom');\n \n   read.on('end', common.mustNotCall('no end event'));\n+  read.on('close', common.mustCall());\n   read.on('error', common.mustCall((err) => {\n     assert.strictEqual(err, expected);\n   }));\n@@ -70,6 +72,7 @@ const { inherits } = require('util');\n \n   // error is swallowed by the custom _destroy\n   read.on('error', common.mustNotCall('no error event'));\n+  read.on('close', common.mustCall());\n \n   read.destroy(expected);\n   assert.strictEqual(read.destroyed, true);\n@@ -106,6 +109,7 @@ const { inherits } = require('util');\n   const fail = common.mustNotCall('no end event');\n \n   read.on('end', fail);\n+  read.on('close', common.mustCall());\n \n   read.destroy();\n \n@@ -170,7 +174,18 @@ const { inherits } = require('util');\n \n   const expected = new Error('kaboom');\n \n+  read.on('close', common.mustCall());\n   read.destroy(expected, common.mustCall(function(err) {\n     assert.strictEqual(expected, err);\n   }));\n }\n+\n+{\n+  const read = new Readable({\n+    read() {}\n+  });\n+\n+  read.destroy();\n+  read.push('hi');\n+  read.on('data', common.mustNotCall());\n+}"
        },
        {
            "sha": "47cce87264b5c1d204972fffb855d250f384575e",
            "filename": "test/parallel/test-stream-transform-destroy.js",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-stream-transform-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-stream-transform-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-transform-destroy.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -11,9 +11,9 @@ const assert = require('assert');\n \n   transform.resume();\n \n-  transform.on('end', common.mustCall());\n+  transform.on('end', common.mustNotCall());\n   transform.on('close', common.mustCall());\n-  transform.on('finish', common.mustCall());\n+  transform.on('finish', common.mustNotCall());\n \n   transform.destroy();\n }\n@@ -26,8 +26,8 @@ const assert = require('assert');\n \n   const expected = new Error('kaboom');\n \n-  transform.on('end', common.mustCall());\n-  transform.on('finish', common.mustCall());\n+  transform.on('end', common.mustNotCall());\n+  transform.on('finish', common.mustNotCall());\n   transform.on('close', common.mustCall());\n   transform.on('error', common.mustCall((err) => {\n     assert.strictEqual(err, expected);\n@@ -49,7 +49,7 @@ const assert = require('assert');\n   const expected = new Error('kaboom');\n \n   transform.on('finish', common.mustNotCall('no finish event'));\n-  transform.on('close', common.mustNotCall('no close event'));\n+  transform.on('close', common.mustCall());\n   transform.on('error', common.mustCall((err) => {\n     assert.strictEqual(err, expected);\n   }));\n@@ -69,7 +69,7 @@ const assert = require('assert');\n   transform.resume();\n \n   transform.on('end', common.mustNotCall('no end event'));\n-  transform.on('close', common.mustNotCall('no close event'));\n+  transform.on('close', common.mustCall());\n   transform.on('finish', common.mustNotCall('no finish event'));\n \n   // error is swallowed by the custom _destroy\n@@ -110,7 +110,7 @@ const assert = require('assert');\n \n   transform.on('finish', fail);\n   transform.on('end', fail);\n-  transform.on('close', fail);\n+  transform.on('close', common.mustCall());\n \n   transform.destroy();\n \n@@ -132,7 +132,7 @@ const assert = require('assert');\n     cb(expected);\n   }, 1);\n \n-  transform.on('close', common.mustNotCall('no close event'));\n+  transform.on('close', common.mustCall());\n   transform.on('finish', common.mustNotCall('no finish event'));\n   transform.on('end', common.mustNotCall('no end event'));\n   transform.on('error', common.mustCall((err) => {"
        },
        {
            "sha": "565a5564e2bc29e648b1eaee733502a839a79f42",
            "filename": "test/parallel/test-stream-writable-destroy.js",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-stream-writable-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-stream-writable-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-writable-destroy.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -10,7 +10,8 @@ const { inherits } = require('util');\n     write(chunk, enc, cb) { cb(); }\n   });\n \n-  write.on('finish', common.mustCall());\n+  write.on('finish', common.mustNotCall());\n+  write.on('close', common.mustCall());\n \n   write.destroy();\n   assert.strictEqual(write.destroyed, true);\n@@ -23,7 +24,8 @@ const { inherits } = require('util');\n \n   const expected = new Error('kaboom');\n \n-  write.on('finish', common.mustCall());\n+  write.on('finish', common.mustNotCall());\n+  write.on('close', common.mustCall());\n   write.on('error', common.mustCall((err) => {\n     assert.strictEqual(err, expected);\n   }));\n@@ -45,6 +47,7 @@ const { inherits } = require('util');\n   const expected = new Error('kaboom');\n \n   write.on('finish', common.mustNotCall('no finish event'));\n+  write.on('close', common.mustCall());\n   write.on('error', common.mustCall((err) => {\n     assert.strictEqual(err, expected);\n   }));\n@@ -65,6 +68,7 @@ const { inherits } = require('util');\n   const expected = new Error('kaboom');\n \n   write.on('finish', common.mustNotCall('no finish event'));\n+  write.on('close', common.mustCall());\n \n   // error is swallowed by the custom _destroy\n   write.on('error', common.mustNotCall('no error event'));\n@@ -103,6 +107,7 @@ const { inherits } = require('util');\n   const fail = common.mustNotCall('no finish event');\n \n   write.on('finish', fail);\n+  write.on('close', common.mustCall());\n \n   write.destroy();\n \n@@ -123,6 +128,7 @@ const { inherits } = require('util');\n     cb(expected);\n   });\n \n+  write.on('close', common.mustCall());\n   write.on('finish', common.mustNotCall('no finish event'));\n   write.on('error', common.mustCall((err) => {\n     assert.strictEqual(err, expected);\n@@ -138,6 +144,7 @@ const { inherits } = require('util');\n     write(chunk, enc, cb) { cb(); }\n   });\n \n+  write.on('close', common.mustCall());\n   write.on('error', common.mustCall());\n \n   write.destroy(new Error('kaboom 1'));\n@@ -155,7 +162,7 @@ const { inherits } = require('util');\n   assert.strictEqual(write.destroyed, true);\n \n   // the internal destroy() mechanism should not be triggered\n-  write.on('finish', common.mustNotCall());\n+  write.on('close', common.mustNotCall());\n   write.destroy();\n }\n "
        },
        {
            "sha": "160971b16bc30c294eb3cd6af63fba4c1fcffa10",
            "filename": "test/parallel/test-zlib-write-after-close.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-zlib-write-after-close.js",
            "raw_url": "https://github.com/nodejs/node/raw/5e3f51648ed5de36b01d53bde13fb6fb7b965667/test%2Fparallel%2Ftest-zlib-write-after-close.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-write-after-close.js?ref=5e3f51648ed5de36b01d53bde13fb6fb7b965667",
            "patch": "@@ -29,9 +29,9 @@ zlib.gzip('hello', common.mustCall(function(err, out) {\n   common.expectsError(\n     () => unzip.write(out),\n     {\n-      code: 'ERR_ZLIB_BINDING_CLOSED',\n+      code: 'ERR_STREAM_DESTROYED',\n       type: Error,\n-      message: 'zlib binding closed'\n+      message: 'Cannot call write after a stream was destroyed'\n     }\n   );\n }));"
        }
    ],
    "stats": {
        "total": 162,
        "additions": 107,
        "deletions": 55
    }
}