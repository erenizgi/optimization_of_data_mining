{
    "author": "unknown",
    "message": "deps: cherry-pick b20faff from upstream V8\n\nOriginal commit message:\n\n    [log] fix ExistingCodeLogger behavior on edge case\n\n    ExistingCodeLogger was behaving incorrectly when the\n    CodeEventHandler API was used in combination with\n    --interpreted-frames-native-stack.  Instead of collecting copied\n    trampolines as InterpretedFunction:functionName, they were being\n    collected as Builtin:IntepreterEntryTrampolines.  This patch adds\n    special handling for copied trampolines when using\n    ExistingCodeLogger.\n\n    R=yangguo@google.com\n\n    Change-Id: I3ee4be03800122d28d53b51b20c60dcf6263e4c1\n    Reviewed-on: https://chromium-review.googlesource.com/1087813\n    Reviewed-by: Yang Guo <yangguo@chromium.org>\n    Commit-Queue: Yang Guo <yangguo@chromium.org>\n    Cr-Commit-Position: refs/heads/master@{#53624}\n\nRefs: https://github.com/v8/v8/commit/b20faffb07bc97b869a00b935c639bd1c\n\nPR-URL: https://github.com/nodejs/node/pull/21126\nRefs: https://github.com/v8/v8/commit/aa6ce3e\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: Michael Dawson <michael_dawson@ca.ibm.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "76f4a5e055c1b457b44a6dc1eae4cc759aa679f1",
    "files": [
        {
            "sha": "dce4d664a8d3ebb4a02a8bd46d7ba20d87960770",
            "filename": "common.gypi",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/76f4a5e055c1b457b44a6dc1eae4cc759aa679f1/common.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/76f4a5e055c1b457b44a6dc1eae4cc759aa679f1/common.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/common.gypi?ref=76f4a5e055c1b457b44a6dc1eae4cc759aa679f1",
            "patch": "@@ -28,7 +28,7 @@\n \n     # Reset this number to 0 on major V8 upgrades.\n     # Increment by one for each non-official patch applied to deps/v8.\n-    'v8_embedder_string': '-node.3',\n+    'v8_embedder_string': '-node.4',\n \n     # Enable disassembler for `--print-code` v8 options\n     'v8_enable_disassembler': 1,"
        },
        {
            "sha": "8ed6f43ba6b34fe12de586439cae0c1b05d157b4",
            "filename": "deps/v8/src/log.cc",
            "status": "modified",
            "additions": 26,
            "deletions": 18,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/76f4a5e055c1b457b44a6dc1eae4cc759aa679f1/deps%2Fv8%2Fsrc%2Flog.cc",
            "raw_url": "https://github.com/nodejs/node/raw/76f4a5e055c1b457b44a6dc1eae4cc759aa679f1/deps%2Fv8%2Fsrc%2Flog.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Flog.cc?ref=76f4a5e055c1b457b44a6dc1eae4cc759aa679f1",
            "patch": "@@ -2012,18 +2012,18 @@ FILE* Logger::TearDown() {\n }\n \n void ExistingCodeLogger::LogCodeObject(Object* object) {\n-  AbstractCode* code_object = AbstractCode::cast(object);\n+  AbstractCode* abstract_code = AbstractCode::cast(object);\n   CodeEventListener::LogEventsAndTags tag = CodeEventListener::STUB_TAG;\n   const char* description = \"Unknown code from before profiling\";\n-  switch (code_object->kind()) {\n+  switch (abstract_code->kind()) {\n     case AbstractCode::INTERPRETED_FUNCTION:\n     case AbstractCode::OPTIMIZED_FUNCTION:\n       return;  // We log this later using LogCompiledFunctions.\n     case AbstractCode::BYTECODE_HANDLER:\n       return;  // We log it later by walking the dispatch table.\n     case AbstractCode::STUB:\n       description =\n-          CodeStub::MajorName(CodeStub::GetMajorKey(code_object->GetCode()));\n+          CodeStub::MajorName(CodeStub::GetMajorKey(abstract_code->GetCode()));\n       if (description == nullptr) description = \"A stub from before profiling\";\n       tag = CodeEventListener::STUB_TAG;\n       break;\n@@ -2032,8 +2032,13 @@ void ExistingCodeLogger::LogCodeObject(Object* object) {\n       tag = CodeEventListener::REG_EXP_TAG;\n       break;\n     case AbstractCode::BUILTIN:\n+      if (Code::cast(object)->is_interpreter_trampoline_builtin() &&\n+          Code::cast(object) ==\n+              *BUILTIN_CODE(isolate_, InterpreterEntryTrampoline)) {\n+        return;\n+      }\n       description =\n-          isolate_->builtins()->name(code_object->GetCode()->builtin_index());\n+          isolate_->builtins()->name(abstract_code->GetCode()->builtin_index());\n       tag = CodeEventListener::BUILTIN_TAG;\n       break;\n     case AbstractCode::WASM_FUNCTION:\n@@ -2059,7 +2064,7 @@ void ExistingCodeLogger::LogCodeObject(Object* object) {\n     case AbstractCode::NUMBER_OF_KINDS:\n       UNIMPLEMENTED();\n   }\n-  CALL_CODE_EVENT_HANDLER(CodeCreateEvent(tag, code_object, description))\n+  CALL_CODE_EVENT_HANDLER(CodeCreateEvent(tag, abstract_code, description))\n }\n \n void ExistingCodeLogger::LogCodeObjects() {\n@@ -2085,6 +2090,12 @@ void ExistingCodeLogger::LogCompiledFunctions() {\n   // During iteration, there can be heap allocation due to\n   // GetScriptLineNumber call.\n   for (int i = 0; i < compiled_funcs_count; ++i) {\n+    if (sfis[i]->function_data()->IsInterpreterData()) {\n+      LogExistingFunction(sfis[i],\n+                          Handle<AbstractCode>(AbstractCode::cast(\n+                              sfis[i]->InterpreterTrampoline())),\n+                          CodeEventListener::INTERPRETED_FUNCTION_TAG);\n+    }\n     if (code_objects[i].is_identical_to(BUILTIN_CODE(isolate_, CompileLazy)))\n       continue;\n     LogExistingFunction(sfis[i], code_objects[i]);\n@@ -2129,8 +2140,9 @@ void ExistingCodeLogger::LogBytecodeHandlers() {\n   }\n }\n \n-void ExistingCodeLogger::LogExistingFunction(Handle<SharedFunctionInfo> shared,\n-                                             Handle<AbstractCode> code) {\n+void ExistingCodeLogger::LogExistingFunction(\n+    Handle<SharedFunctionInfo> shared, Handle<AbstractCode> code,\n+    CodeEventListener::LogEventsAndTags tag) {\n   if (shared->script()->IsScript()) {\n     Handle<Script> script(Script::cast(shared->script()));\n     int line_num = Script::GetLineNumber(script, shared->StartPosition()) + 1;\n@@ -2140,21 +2152,18 @@ void ExistingCodeLogger::LogExistingFunction(Handle<SharedFunctionInfo> shared,\n       Handle<String> script_name(String::cast(script->name()));\n       if (line_num > 0) {\n         CALL_CODE_EVENT_HANDLER(\n-            CodeCreateEvent(Logger::ToNativeByScript(\n-                                CodeEventListener::LAZY_COMPILE_TAG, *script),\n-                            *code, *shared, *script_name, line_num, column_num))\n+            CodeCreateEvent(Logger::ToNativeByScript(tag, *script), *code,\n+                            *shared, *script_name, line_num, column_num))\n       } else {\n         // Can't distinguish eval and script here, so always use Script.\n         CALL_CODE_EVENT_HANDLER(CodeCreateEvent(\n             Logger::ToNativeByScript(CodeEventListener::SCRIPT_TAG, *script),\n             *code, *shared, *script_name))\n       }\n     } else {\n-      CALL_CODE_EVENT_HANDLER(\n-          CodeCreateEvent(Logger::ToNativeByScript(\n-                              CodeEventListener::LAZY_COMPILE_TAG, *script),\n-                          *code, *shared, isolate_->heap()->empty_string(),\n-                          line_num, column_num))\n+      CALL_CODE_EVENT_HANDLER(CodeCreateEvent(\n+          Logger::ToNativeByScript(tag, *script), *code, *shared,\n+          isolate_->heap()->empty_string(), line_num, column_num))\n     }\n   } else if (shared->IsApiFunction()) {\n     // API function.\n@@ -2170,9 +2179,8 @@ void ExistingCodeLogger::LogExistingFunction(Handle<SharedFunctionInfo> shared,\n       CALL_CODE_EVENT_HANDLER(CallbackEvent(shared->DebugName(), entry_point))\n     }\n   } else {\n-    CALL_CODE_EVENT_HANDLER(CodeCreateEvent(CodeEventListener::LAZY_COMPILE_TAG,\n-                                            *code, *shared,\n-                                            isolate_->heap()->empty_string()))\n+    CALL_CODE_EVENT_HANDLER(\n+        CodeCreateEvent(tag, *code, *shared, isolate_->heap()->empty_string()))\n   }\n }\n "
        },
        {
            "sha": "ad254097e6659c709993decf72d439614110c740",
            "filename": "deps/v8/src/log.h",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/76f4a5e055c1b457b44a6dc1eae4cc759aa679f1/deps%2Fv8%2Fsrc%2Flog.h",
            "raw_url": "https://github.com/nodejs/node/raw/76f4a5e055c1b457b44a6dc1eae4cc759aa679f1/deps%2Fv8%2Fsrc%2Flog.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Fsrc%2Flog.h?ref=76f4a5e055c1b457b44a6dc1eae4cc759aa679f1",
            "patch": "@@ -109,7 +109,9 @@ class ExistingCodeLogger {\n \n   void LogCompiledFunctions();\n   void LogExistingFunction(Handle<SharedFunctionInfo> shared,\n-                           Handle<AbstractCode> code);\n+                           Handle<AbstractCode> code,\n+                           CodeEventListener::LogEventsAndTags tag =\n+                               CodeEventListener::LAZY_COMPILE_TAG);\n   void LogCodeObject(Object* object);\n   void LogBytecodeHandler(interpreter::Bytecode bytecode,\n                           interpreter::OperandScale operand_scale, Code* code);"
        },
        {
            "sha": "c7864034c96ea76ad2fa8301249a28f056a47eb6",
            "filename": "deps/v8/test/cctest/test-log.cc",
            "status": "modified",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/76f4a5e055c1b457b44a6dc1eae4cc759aa679f1/deps%2Fv8%2Ftest%2Fcctest%2Ftest-log.cc",
            "raw_url": "https://github.com/nodejs/node/raw/76f4a5e055c1b457b44a6dc1eae4cc759aa679f1/deps%2Fv8%2Ftest%2Fcctest%2Ftest-log.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/deps%2Fv8%2Ftest%2Fcctest%2Ftest-log.cc?ref=76f4a5e055c1b457b44a6dc1eae4cc759aa679f1",
            "patch": "@@ -875,6 +875,49 @@ TEST(ExternalCodeEventListener) {\n   isolate->Dispose();\n }\n \n+TEST(ExternalCodeEventListenerWithInterpretedFramesNativeStack) {\n+  i::FLAG_log = false;\n+  i::FLAG_prof = false;\n+  i::FLAG_interpreted_frames_native_stack = true;\n+\n+  v8::Isolate::CreateParams create_params;\n+  create_params.array_buffer_allocator = CcTest::array_buffer_allocator();\n+  v8::Isolate* isolate = v8::Isolate::New(create_params);\n+\n+  {\n+    v8::HandleScope scope(isolate);\n+    v8::Isolate::Scope isolate_scope(isolate);\n+    v8::Local<v8::Context> context = v8::Context::New(isolate);\n+    context->Enter();\n+\n+    TestCodeEventHandler code_event_handler(isolate);\n+\n+    const char* source_text_before_start =\n+        \"function testCodeEventListenerBeforeStart(a,b) { return a + b };\"\n+        \"testCodeEventListenerBeforeStart('1', 1);\";\n+    CompileRun(source_text_before_start);\n+\n+    CHECK_NULL(code_event_handler.FindLine(\"InterpretedFunction\",\n+                                           \"testCodeEventListenerBeforeStart\"));\n+\n+    code_event_handler.Enable();\n+\n+    CHECK_NOT_NULL(code_event_handler.FindLine(\n+        \"InterpretedFunction\", \"testCodeEventListenerBeforeStart\"));\n+\n+    const char* source_text_after_start =\n+        \"function testCodeEventListenerAfterStart(a,b) { return a + b };\"\n+        \"testCodeEventListenerAfterStart('1', 1);\";\n+    CompileRun(source_text_after_start);\n+\n+    CHECK_NOT_NULL(code_event_handler.FindLine(\n+        \"InterpretedFunction\", \"testCodeEventListenerAfterStart\"));\n+\n+    context->Exit();\n+  }\n+  isolate->Dispose();\n+}\n+\n TEST(TraceMaps) {\n   SETUP_FLAGS();\n   i::FLAG_trace_maps = true;"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 73,
        "deletions": 20
    }
}