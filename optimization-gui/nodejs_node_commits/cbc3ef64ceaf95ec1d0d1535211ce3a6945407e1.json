{
    "author": "addaleax",
    "message": "process: allow reading from stdout/stderr sockets\n\nAllow reading from stdio streams that are conventionally\nassociated with process output, since this is only convention.\n\nThis involves disabling the oddness around closing stdio\nstreams. Its purpose is to prevent the file descriptors\n0 through 2 from being closed, since doing so can lead\nto information leaks when new file descriptors are being\nopened; instead, not doing anything seems like a more\nreasonable choice.\n\nFixes: https://github.com/nodejs/node/issues/21203\n\nPR-URL: https://github.com/nodejs/node/pull/23053\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1",
    "files": [
        {
            "sha": "75146c24c359f10c737dc2bad25080604fbadfac",
            "filename": "doc/api/errors.md",
            "status": "modified",
            "additions": 31,
            "deletions": 12,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/doc%2Fapi%2Ferrors.md",
            "raw_url": "https://github.com/nodejs/node/raw/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/doc%2Fapi%2Ferrors.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ferrors.md?ref=cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1",
            "patch": "@@ -1545,18 +1545,6 @@ An attempt was made to operate on an already closed socket.\n \n A call was made and the UDP subsystem was not running.\n \n-<a id=\"ERR_STDERR_CLOSE\"></a>\n-### ERR_STDERR_CLOSE\n-\n-An attempt was made to close the `process.stderr` stream. By design, Node.js\n-does not allow `stdout` or `stderr` streams to be closed by user code.\n-\n-<a id=\"ERR_STDOUT_CLOSE\"></a>\n-### ERR_STDOUT_CLOSE\n-\n-An attempt was made to close the `process.stdout` stream. By design, Node.js\n-does not allow `stdout` or `stderr` streams to be closed by user code.\n-\n <a id=\"ERR_STREAM_CANNOT_PIPE\"></a>\n ### ERR_STREAM_CANNOT_PIPE\n \n@@ -1955,6 +1943,37 @@ removed: v10.0.0\n \n The `repl` module was unable to parse data from the REPL history file.\n \n+\n+<a id=\"ERR_STDERR_CLOSE\"></a>\n+### ERR_STDERR_CLOSE\n+<!-- YAML\n+removed: REPLACEME\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/23053\n+    description: Rather than emitting an error, `process.stderr.end()` now\n+                 only closes the stream side but not the underlying resource,\n+                 making this error obsolete.\n+-->\n+\n+An attempt was made to close the `process.stderr` stream. By design, Node.js\n+does not allow `stdout` or `stderr` streams to be closed by user code.\n+\n+<a id=\"ERR_STDOUT_CLOSE\"></a>\n+### ERR_STDOUT_CLOSE\n+<!-- YAML\n+removed: REPLACEME\n+changes:\n+  - version: REPLACEME\n+    pr-url: https://github.com/nodejs/node/pull/23053\n+    description: Rather than emitting an error, `process.stderr.end()` now\n+                 only closes the stream side but not the underlying resource,\n+                 making this error obsolete.\n+-->\n+\n+An attempt was made to close the `process.stdout` stream. By design, Node.js\n+does not allow `stdout` or `stderr` streams to be closed by user code.\n+\n <a id=\"ERR_STREAM_READ_NOT_IMPLEMENTED\"></a>\n ### ERR_STREAM_READ_NOT_IMPLEMENTED\n <!-- YAML"
        },
        {
            "sha": "0eaeef8ba3e4f63803f2e86694bbb3cbf080fb57",
            "filename": "doc/api/process.md",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/doc%2Fapi%2Fprocess.md",
            "raw_url": "https://github.com/nodejs/node/raw/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/doc%2Fapi%2Fprocess.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fprocess.md?ref=cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1",
            "patch": "@@ -1907,9 +1907,7 @@ important ways:\n \n 1. They are used internally by [`console.log()`][] and [`console.error()`][],\n    respectively.\n-2. They cannot be closed ([`end()`][] will throw).\n-3. They will never emit the [`'finish'`][] event.\n-4. Writes may be synchronous depending on what the stream is connected to\n+2. Writes may be synchronous depending on what the stream is connected to\n    and whether the system is Windows or POSIX:\n    - Files: *synchronous* on Windows and POSIX\n    - TTYs (Terminals): *asynchronous* on Windows, *synchronous* on POSIX\n@@ -2134,7 +2132,6 @@ cases:\n   code will be `128` + `6`, or `134`.\n \n [`'exit'`]: #process_event_exit\n-[`'finish'`]: stream.html#stream_event_finish\n [`'message'`]: child_process.html#child_process_event_message\n [`'rejectionHandled'`]: #process_event_rejectionhandled\n [`'uncaughtException'`]: #process_event_uncaughtexception\n@@ -2148,7 +2145,6 @@ cases:\n [`console.error()`]: console.html#console_console_error_data_args\n [`console.log()`]: console.html#console_console_log_data_args\n [`domain`]: domain.html\n-[`end()`]: stream.html#stream_writable_end_chunk_encoding_callback\n [`net.Server`]: net.html#net_class_net_server\n [`net.Socket`]: net.html#net_class_net_socket\n [`NODE_OPTIONS`]: cli.html#cli_node_options_options"
        },
        {
            "sha": "43124cc66b452c2d6da3a04794cc31dffbfb8e9c",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1",
            "patch": "@@ -808,8 +808,6 @@ E('ERR_SOCKET_BUFFER_SIZE',\n E('ERR_SOCKET_CANNOT_SEND', 'Unable to send data', Error);\n E('ERR_SOCKET_CLOSED', 'Socket is closed', Error);\n E('ERR_SOCKET_DGRAM_NOT_RUNNING', 'Not running', Error);\n-E('ERR_STDERR_CLOSE', 'process.stderr cannot be closed', Error);\n-E('ERR_STDOUT_CLOSE', 'process.stdout cannot be closed', Error);\n E('ERR_STREAM_CANNOT_PIPE', 'Cannot pipe, not readable', Error);\n E('ERR_STREAM_DESTROYED', 'Cannot call %s after a stream was destroyed', Error);\n E('ERR_STREAM_NULL_VALUES', 'May not write null values to stream', TypeError);"
        },
        {
            "sha": "826a2a9916e297bd69fc0817d10be3930696e6e0",
            "filename": "lib/internal/process/stdio.js",
            "status": "modified",
            "additions": 6,
            "deletions": 12,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/lib%2Finternal%2Fprocess%2Fstdio.js",
            "raw_url": "https://github.com/nodejs/node/raw/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/lib%2Finternal%2Fprocess%2Fstdio.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fstdio.js?ref=cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1",
            "patch": "@@ -1,15 +1,15 @@\n 'use strict';\n \n const {\n-  ERR_STDERR_CLOSE,\n-  ERR_STDOUT_CLOSE,\n   ERR_UNKNOWN_STDIN_TYPE,\n   ERR_UNKNOWN_STREAM_TYPE\n } = require('internal/errors').codes;\n \n exports.setupProcessStdio = setupProcessStdio;\n exports.getMainThreadStdio = getMainThreadStdio;\n \n+function dummyDestroy(err, cb) { cb(err); }\n+\n function getMainThreadStdio() {\n   var stdin;\n   var stdout;\n@@ -19,11 +19,8 @@ function getMainThreadStdio() {\n     if (stdout) return stdout;\n     stdout = createWritableStdioStream(1);\n     stdout.destroySoon = stdout.destroy;\n-    stdout._destroy = function(er, cb) {\n-      // Avoid errors if we already emitted\n-      er = er || new ERR_STDOUT_CLOSE();\n-      cb(er);\n-    };\n+    // Override _destroy so that the fd is never actually closed.\n+    stdout._destroy = dummyDestroy;\n     if (stdout.isTTY) {\n       process.on('SIGWINCH', () => stdout._refreshSize());\n     }\n@@ -34,11 +31,8 @@ function getMainThreadStdio() {\n     if (stderr) return stderr;\n     stderr = createWritableStdioStream(2);\n     stderr.destroySoon = stderr.destroy;\n-    stderr._destroy = function(er, cb) {\n-      // Avoid errors if we already emitted\n-      er = er || new ERR_STDERR_CLOSE();\n-      cb(er);\n-    };\n+    // Override _destroy so that the fd is never actually closed.\n+    stdout._destroy = dummyDestroy;\n     if (stderr.isTTY) {\n       process.on('SIGWINCH', () => stderr._refreshSize());\n     }"
        },
        {
            "sha": "7cd4b90c008a2f3f1332a464a162d565902c6153",
            "filename": "test/parallel/test-stdout-cannot-be-closed-child-process-pipe.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/test%2Fparallel%2Ftest-stdout-cannot-be-closed-child-process-pipe.js",
            "raw_url": "https://github.com/nodejs/node/raw/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/test%2Fparallel%2Ftest-stdout-cannot-be-closed-child-process-pipe.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stdout-cannot-be-closed-child-process-pipe.js?ref=cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1",
            "patch": "@@ -24,9 +24,9 @@ function parent() {\n   });\n \n   child.on('close', function(code, signal) {\n-    assert(code);\n+    assert.strictEqual(code, 0);\n+    assert.strictEqual(err, '');\n     assert.strictEqual(out, 'foo');\n-    assert(/process\\.stdout cannot be closed/.test(err));\n     console.log('ok');\n   });\n }"
        },
        {
            "sha": "10ddd6d257e01349d514541981aeecea6b2e741d",
            "filename": "test/pseudo-tty/test-stdout-read.in",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/test%2Fpseudo-tty%2Ftest-stdout-read.in",
            "raw_url": "https://github.com/nodejs/node/raw/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/test%2Fpseudo-tty%2Ftest-stdout-read.in",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-stdout-read.in?ref=cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1",
            "patch": "@@ -0,0 +1 @@\n+Hello!"
        },
        {
            "sha": "90f017ed77b7be16288a186b48a1c0cefe128ed6",
            "filename": "test/pseudo-tty/test-stdout-read.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/test%2Fpseudo-tty%2Ftest-stdout-read.js",
            "raw_url": "https://github.com/nodejs/node/raw/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/test%2Fpseudo-tty%2Ftest-stdout-read.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-stdout-read.js?ref=cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1",
            "patch": "@@ -0,0 +1,3 @@\n+'use strict';\n+const common = require('../common');\n+process.stderr.on('data', common.mustCall(console.log));"
        },
        {
            "sha": "3b7fda223d0e6c9ea3aa368a6308c82b335c4123",
            "filename": "test/pseudo-tty/test-stdout-read.out",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/test%2Fpseudo-tty%2Ftest-stdout-read.out",
            "raw_url": "https://github.com/nodejs/node/raw/cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1/test%2Fpseudo-tty%2Ftest-stdout-read.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fpseudo-tty%2Ftest-stdout-read.out?ref=cbc3ef64ceaf95ec1d0d1535211ce3a6945407e1",
            "patch": "@@ -0,0 +1 @@\n+<Buffer 48 65 6c 6c 6f 21 0a>"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 45,
        "deletions": 33
    }
}