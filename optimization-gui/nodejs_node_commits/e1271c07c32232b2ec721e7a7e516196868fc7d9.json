{
    "author": "addaleax",
    "message": "src: only set JSStreamWrap write req after `write()`\n\nOtherwise `this[kCurrentWriteRequest]` is set to a value even\nif one of the `write` calls throws.\n\nThis is needed in order not to break tests in a later commit.\n\nPR-URL: https://github.com/nodejs/node/pull/18676\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Anatoli Papirovski <apapirovski@mac.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "e1271c07c32232b2ec721e7a7e516196868fc7d9",
    "files": [
        {
            "sha": "aed26ed8c6976ae291850f33c36a1fedce10fab5",
            "filename": "lib/internal/wrap_js_stream.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/e1271c07c32232b2ec721e7a7e516196868fc7d9/lib%2Finternal%2Fwrap_js_stream.js",
            "raw_url": "https://github.com/nodejs/node/raw/e1271c07c32232b2ec721e7a7e516196868fc7d9/lib%2Finternal%2Fwrap_js_stream.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fwrap_js_stream.js?ref=e1271c07c32232b2ec721e7a7e516196868fc7d9",
            "patch": "@@ -137,7 +137,6 @@ class JSStreamWrap extends Socket {\n   doWrite(req, bufs) {\n     assert.strictEqual(this[kCurrentWriteRequest], null);\n     assert.strictEqual(this[kCurrentShutdownRequest], null);\n-    this[kCurrentWriteRequest] = req;\n \n     const handle = this._handle;\n     const self = this;\n@@ -149,6 +148,9 @@ class JSStreamWrap extends Socket {\n       this.stream.write(bufs[i], done);\n     this.stream.uncork();\n \n+    // Only set the request here, because the `write()` calls could throw.\n+    this[kCurrentWriteRequest] = req;\n+\n     function done(err) {\n       if (!err && --pending !== 0)\n         return;"
        }
    ],
    "stats": {
        "total": 4,
        "additions": 3,
        "deletions": 1
    }
}