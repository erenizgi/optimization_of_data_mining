{
    "author": "joyeecheung",
    "message": "lib: make the global console [[Prototype]] an empty object\n\nFrom the WHATWG console spec:\n\n> For historical web-compatibility reasons, the namespace object for\n> console must have as its [[Prototype]] an empty object, created as\n> if by ObjectCreate(%ObjectPrototype%), instead of %ObjectPrototype%.\n\nSince in Node.js, the Console constructor has been exposed through\nrequire('console'), we need to keep the Console constructor but\nwe cannot actually use `new Console` to construct the global console.\n\nThis patch changes the prototype chain of the global console object,\nso the console.Console.prototype is not in the global console prototype\nchain anymore.\n\n```\nconst proto = Object.getPrototypeOf(global.console);\n// Before this patch\nproto.constructor === global.console.Console\n// After this patch\nproto.constructor === Object\n```\n\nBut, we still maintain that\n\n```\nglobal.console instanceof global.console.Console\n```\n\nthrough a custom Symbol.hasInstance function of Console that tests\nfor a special symbol kIsConsole for backwards compatibility.\n\nThis fixes a case in the console Web Platform Test that we commented\nout.\n\nPR-URL: https://github.com/nodejs/node/pull/23509\nRefs: https://github.com/whatwg/console/issues/3\nRefs: https://console.spec.whatwg.org/#console-namespace\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Denys Otrishko <shishugi@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>",
    "sha": "6223236151f25975e380eef8470243ff8cf3f61d",
    "files": [
        {
            "sha": "2e56f7bbba5ad80ab0ee4108bba8f9216a0add8d",
            "filename": "lib/console.js",
            "status": "modified",
            "additions": 50,
            "deletions": 6,
            "changes": 56,
            "blob_url": "https://github.com/nodejs/node/blob/6223236151f25975e380eef8470243ff8cf3f61d/lib%2Fconsole.js",
            "raw_url": "https://github.com/nodejs/node/raw/6223236151f25975e380eef8470243ff8cf3f61d/lib%2Fconsole.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fconsole.js?ref=6223236151f25975e380eef8470243ff8cf3f61d",
            "patch": "@@ -60,17 +60,21 @@ let cliTable;\n \n // Track amount of indentation required via `console.group()`.\n const kGroupIndent = Symbol('kGroupIndent');\n-\n const kFormatForStderr = Symbol('kFormatForStderr');\n const kFormatForStdout = Symbol('kFormatForStdout');\n const kGetInspectOptions = Symbol('kGetInspectOptions');\n const kColorMode = Symbol('kColorMode');\n+const kIsConsole = Symbol('kIsConsole');\n \n function Console(options /* or: stdout, stderr, ignoreErrors = true */) {\n-  if (!(this instanceof Console)) {\n+  // We have to test new.target here to see if this function is called\n+  // with new, because we need to define a custom instanceof to accommodate\n+  // the global console.\n+  if (!new.target) {\n     return new Console(...arguments);\n   }\n \n+  this[kIsConsole] = true;\n   if (!options || typeof options.write === 'function') {\n     options = {\n       stdout: options,\n@@ -125,7 +129,7 @@ function Console(options /* or: stdout, stderr, ignoreErrors = true */) {\n   var keys = Object.keys(Console.prototype);\n   for (var v = 0; v < keys.length; v++) {\n     var k = keys[v];\n-    this[k] = this[k].bind(this);\n+    this[k] = Console.prototype[k].bind(this);\n   }\n }\n \n@@ -465,10 +469,50 @@ Console.prototype.table = function(tabularData, properties) {\n   return final(keys, values);\n };\n \n-module.exports = new Console({\n+function noop() {}\n+\n+// See https://console.spec.whatwg.org/#console-namespace\n+// > For historical web-compatibility reasons, the namespace object\n+// > for console must have as its [[Prototype]] an empty object,\n+// > created as if by ObjectCreate(%ObjectPrototype%),\n+// > instead of %ObjectPrototype%.\n+\n+// Since in Node.js, the Console constructor has been exposed through\n+// require('console'), we need to keep the Console constructor but\n+// we cannot actually use `new Console` to construct the global console.\n+// Therefore, the console.Console.prototype is not\n+// in the global console prototype chain anymore.\n+const globalConsole = Object.create({});\n+const tempConsole = new Console({\n   stdout: process.stdout,\n   stderr: process.stderr\n });\n-module.exports.Console = Console;\n \n-function noop() {}\n+// Since Console is not on the prototype chain of the global console,\n+// the symbol properties on Console.prototype have to be looked up from\n+// the global console itself.\n+for (const prop of Object.getOwnPropertySymbols(Console.prototype)) {\n+  globalConsole[prop] = Console.prototype[prop];\n+}\n+\n+// Reflect.ownKeys() is used here for retrieving Symbols\n+for (const prop of Reflect.ownKeys(tempConsole)) {\n+  const desc = { ...(Reflect.getOwnPropertyDescriptor(tempConsole, prop)) };\n+  // Since Console would bind method calls onto the instance,\n+  // make sure the methods are called on globalConsole instead of\n+  // tempConsole.\n+  if (typeof Console.prototype[prop] === 'function') {\n+    desc.value = Console.prototype[prop].bind(globalConsole);\n+  }\n+  Reflect.defineProperty(globalConsole, prop, desc);\n+}\n+\n+globalConsole.Console = Console;\n+\n+Object.defineProperty(Console, Symbol.hasInstance, {\n+  value(instance) {\n+    return instance[kIsConsole];\n+  }\n+});\n+\n+module.exports = globalConsole;"
        },
        {
            "sha": "87708808a8652cf0b50e0460581720d1c3d73557",
            "filename": "test/parallel/test-console-instance.js",
            "status": "modified",
            "additions": 48,
            "deletions": 31,
            "changes": 79,
            "blob_url": "https://github.com/nodejs/node/blob/6223236151f25975e380eef8470243ff8cf3f61d/test%2Fparallel%2Ftest-console-instance.js",
            "raw_url": "https://github.com/nodejs/node/raw/6223236151f25975e380eef8470243ff8cf3f61d/test%2Fparallel%2Ftest-console-instance.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-console-instance.js?ref=6223236151f25975e380eef8470243ff8cf3f61d",
            "patch": "@@ -23,7 +23,8 @@\n const common = require('../common');\n const assert = require('assert');\n const Stream = require('stream');\n-const Console = require('console').Console;\n+const requiredConsole = require('console');\n+const Console = requiredConsole.Console;\n \n const out = new Stream();\n const err = new Stream();\n@@ -35,6 +36,11 @@ process.stdout.write = process.stderr.write = common.mustNotCall();\n // Make sure that the \"Console\" function exists.\n assert.strictEqual('function', typeof Console);\n \n+assert.strictEqual(requiredConsole, global.console);\n+// Make sure the custom instanceof of Console works\n+assert.ok(global.console instanceof Console);\n+assert.ok(!({} instanceof Console));\n+\n // Make sure that the Console constructor throws\n // when not given a writable stream instance.\n common.expectsError(\n@@ -62,46 +68,57 @@ common.expectsError(\n \n out.write = err.write = (d) => {};\n \n-const c = new Console(out, err);\n+{\n+  const c = new Console(out, err);\n+  assert.ok(c instanceof Console);\n \n-out.write = err.write = common.mustCall((d) => {\n-  assert.strictEqual(d, 'test\\n');\n-}, 2);\n+  out.write = err.write = common.mustCall((d) => {\n+    assert.strictEqual(d, 'test\\n');\n+  }, 2);\n \n-c.log('test');\n-c.error('test');\n+  c.log('test');\n+  c.error('test');\n \n-out.write = common.mustCall((d) => {\n-  assert.strictEqual(d, '{ foo: 1 }\\n');\n-});\n+  out.write = common.mustCall((d) => {\n+    assert.strictEqual(d, '{ foo: 1 }\\n');\n+  });\n \n-c.dir({ foo: 1 });\n+  c.dir({ foo: 1 });\n \n-// Ensure that the console functions are bound to the console instance.\n-let called = 0;\n-out.write = common.mustCall((d) => {\n-  called++;\n-  assert.strictEqual(d, `${called} ${called - 1} [ 1, 2, 3 ]\\n`);\n-}, 3);\n+  // Ensure that the console functions are bound to the console instance.\n+  let called = 0;\n+  out.write = common.mustCall((d) => {\n+    called++;\n+    assert.strictEqual(d, `${called} ${called - 1} [ 1, 2, 3 ]\\n`);\n+  }, 3);\n \n-[1, 2, 3].forEach(c.log);\n+  [1, 2, 3].forEach(c.log);\n+}\n \n-// Console() detects if it is called without `new` keyword.\n-Console(out, err);\n+// Test calling Console without the `new` keyword.\n+{\n+  const withoutNew = Console(out, err);\n+  assert.ok(withoutNew instanceof Console);\n+}\n \n-// Extending Console works.\n-class MyConsole extends Console {\n-  hello() {}\n+// Test extending Console\n+{\n+  class MyConsole extends Console {\n+    hello() {}\n+  }\n+  const myConsole = new MyConsole(process.stdout);\n+  assert.strictEqual(typeof myConsole.hello, 'function');\n+  assert.ok(myConsole instanceof Console);\n }\n-const myConsole = new MyConsole(process.stdout);\n-assert.strictEqual(typeof myConsole.hello, 'function');\n \n // Instance that does not ignore the stream errors.\n-const c2 = new Console(out, err, false);\n+{\n+  const c2 = new Console(out, err, false);\n \n-out.write = () => { throw new Error('out'); };\n-err.write = () => { throw new Error('err'); };\n+  out.write = () => { throw new Error('out'); };\n+  err.write = () => { throw new Error('err'); };\n \n-assert.throws(() => c2.log('foo'), /^Error: out$/);\n-assert.throws(() => c2.warn('foo'), /^Error: err$/);\n-assert.throws(() => c2.dir('foo'), /^Error: out$/);\n+  assert.throws(() => c2.log('foo'), /^Error: out$/);\n+  assert.throws(() => c2.warn('foo'), /^Error: err$/);\n+  assert.throws(() => c2.dir('foo'), /^Error: out$/);\n+}"
        },
        {
            "sha": "8d6569ad6d6521352c8b4a22535c59a5fc5efe91",
            "filename": "test/parallel/test-whatwg-console-is-a-namespace.js",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/6223236151f25975e380eef8470243ff8cf3f61d/test%2Fparallel%2Ftest-whatwg-console-is-a-namespace.js",
            "raw_url": "https://github.com/nodejs/node/raw/6223236151f25975e380eef8470243ff8cf3f61d/test%2Fparallel%2Ftest-whatwg-console-is-a-namespace.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-whatwg-console-is-a-namespace.js?ref=6223236151f25975e380eef8470243ff8cf3f61d",
            "patch": "@@ -38,9 +38,7 @@ test(() => {\n   const prototype1 = Object.getPrototypeOf(console);\n   const prototype2 = Object.getPrototypeOf(prototype1);\n \n-  // This got commented out from the original test because in Node.js all\n-  // functions are declared on the prototype.\n-  // assert_equals(Object.getOwnPropertyNames(prototype1).length, 0, \"The [[Prototype]] must have no properties\");\n+  assert_equals(Object.getOwnPropertyNames(prototype1).length, 0, \"The [[Prototype]] must have no properties\");\n   assert_equals(prototype2, Object.prototype, \"The [[Prototype]]'s [[Prototype]] must be %ObjectPrototype%\");\n }, \"The prototype chain must be correct\");\n "
        }
    ],
    "stats": {
        "total": 139,
        "additions": 99,
        "deletions": 40
    }
}