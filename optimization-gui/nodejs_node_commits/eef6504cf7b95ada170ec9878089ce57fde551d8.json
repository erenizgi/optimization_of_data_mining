{
    "author": "joyeecheung",
    "message": "src: schedule destroy hooks in BeforeExit early during bootstrap\n\nInstead of doing it in the `internalBinding('async_wrap')`\ninitialization whose first call is uncertain depending on how\nthe native modules are loaded in JS land during bootstrap.\n\nPR-URL: https://github.com/nodejs/node/pull/25020\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "eef6504cf7b95ada170ec9878089ce57fde551d8",
    "files": [
        {
            "sha": "47a99551275e1789c6f358135eeaee9a17b45b7e",
            "filename": "src/async_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 11,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/eef6504cf7b95ada170ec9878089ce57fde551d8/src%2Fasync_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/eef6504cf7b95ada170ec9878089ce57fde551d8/src%2Fasync_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.cc?ref=eef6504cf7b95ada170ec9878089ce57fde551d8",
            "patch": "@@ -88,8 +88,7 @@ struct AsyncWrapObject : public AsyncWrap {\n   SET_SELF_SIZE(AsyncWrapObject)\n };\n \n-\n-static void DestroyAsyncIdsCallback(Environment* env, void* data) {\n+void AsyncWrap::DestroyAsyncIdsCallback(Environment* env, void* data) {\n   Local<Function> fn = env->async_hooks_destroy_function();\n \n   TryCatchScope try_catch(env, TryCatchScope::CatchMode::kFatal);\n@@ -112,13 +111,6 @@ static void DestroyAsyncIdsCallback(Environment* env, void* data) {\n   } while (!env->destroy_async_id_list()->empty());\n }\n \n-static void DestroyAsyncIdsCallback(void* arg) {\n-  Environment* env = static_cast<Environment*>(arg);\n-  if (!env->destroy_async_id_list()->empty())\n-    DestroyAsyncIdsCallback(env, nullptr);\n-}\n-\n-\n void Emit(Environment* env, double async_id, AsyncHooks::Fields type,\n           Local<Function> fn) {\n   AsyncHooks* async_hooks = env->async_hooks();\n@@ -446,8 +438,6 @@ void AsyncWrap::Initialize(Local<Object> target,\n   Isolate* isolate = env->isolate();\n   HandleScope scope(isolate);\n \n-  env->BeforeExit(DestroyAsyncIdsCallback, env);\n-\n   env->SetMethod(target, \"setupHooks\", SetupHooks);\n   env->SetMethod(target, \"pushAsyncIds\", PushAsyncIds);\n   env->SetMethod(target, \"popAsyncIds\", PopAsyncIds);"
        },
        {
            "sha": "f7fc149c941ef03086c003c2689cda70aa4c3f12",
            "filename": "src/async_wrap.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/eef6504cf7b95ada170ec9878089ce57fde551d8/src%2Fasync_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/eef6504cf7b95ada170ec9878089ce57fde551d8/src%2Fasync_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fasync_wrap.h?ref=eef6504cf7b95ada170ec9878089ce57fde551d8",
            "patch": "@@ -141,6 +141,7 @@ class AsyncWrap : public BaseObject {\n   static void EmitTraceEventAfter(ProviderType type, double async_id);\n   void EmitTraceEventDestroy();\n \n+  static void DestroyAsyncIdsCallback(Environment* env, void* data);\n \n   inline ProviderType provider_type() const;\n "
        },
        {
            "sha": "4b05a8b4a96cedf5a4530e4005bd15c3faf241b3",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/eef6504cf7b95ada170ec9878089ce57fde551d8/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/eef6504cf7b95ada170ec9878089ce57fde551d8/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=eef6504cf7b95ada170ec9878089ce57fde551d8",
            "patch": "@@ -211,6 +211,14 @@ Environment::Environment(IsolateData* isolate_data,\n   }\n \n   destroy_async_id_list_.reserve(512);\n+  BeforeExit(\n+      [](void* arg) {\n+        Environment* env = static_cast<Environment*>(arg);\n+        if (!env->destroy_async_id_list()->empty())\n+          AsyncWrap::DestroyAsyncIdsCallback(env, nullptr);\n+      },\n+      this);\n+\n   performance_state_.reset(new performance::performance_state(isolate()));\n   performance_state_->Mark(\n       performance::NODE_PERFORMANCE_MILESTONE_ENVIRONMENT);"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 10,
        "deletions": 11
    }
}