{
    "author": "ofrobots",
    "message": "src: trace_events: fix race with metadata events\n\nMultiple threads may be concurrently adding to the metadata_events list.\nProtect access with a mutex.\n\nFixes: https://github.com/nodejs/node/issues/24129\n\nPR-URL: https://github.com/nodejs/node/pull/25235\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "f39b3e33719cdb7102e9ae7b67a13de4dd681949",
    "files": [
        {
            "sha": "3d19c6c75844fc8ad7158b15142fd3ed5b824dca",
            "filename": "src/tracing/agent.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/f39b3e33719cdb7102e9ae7b67a13de4dd681949/src%2Ftracing%2Fagent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/f39b3e33719cdb7102e9ae7b67a13de4dd681949/src%2Ftracing%2Fagent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.cc?ref=f39b3e33719cdb7102e9ae7b67a13de4dd681949",
            "patch": "@@ -207,9 +207,17 @@ void Agent::AppendTraceEvent(TraceObject* trace_event) {\n     id_writer.second->AppendTraceEvent(trace_event);\n }\n \n+void Agent::AddMetadataEvent(std::unique_ptr<TraceObject> event) {\n+  Mutex::ScopedLock lock(metadata_events_mutex_);\n+  metadata_events_.push_back(std::move(event));\n+}\n+\n void Agent::Flush(bool blocking) {\n-  for (const auto& event : metadata_events_)\n-    AppendTraceEvent(event.get());\n+  {\n+    Mutex::ScopedLock lock(metadata_events_mutex_);\n+    for (const auto& event : metadata_events_)\n+      AppendTraceEvent(event.get());\n+  }\n \n   for (const auto& id_writer : writers_)\n     id_writer.second->Flush(blocking);"
        },
        {
            "sha": "62073ba6b214ef362925ee7158fb912978c5631d",
            "filename": "src/tracing/agent.h",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/f39b3e33719cdb7102e9ae7b67a13de4dd681949/src%2Ftracing%2Fagent.h",
            "raw_url": "https://github.com/nodejs/node/raw/f39b3e33719cdb7102e9ae7b67a13de4dd681949/src%2Ftracing%2Fagent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftracing%2Fagent.h?ref=f39b3e33719cdb7102e9ae7b67a13de4dd681949",
            "patch": "@@ -104,9 +104,7 @@ class Agent {\n   // Writes to all writers registered through AddClient().\n   void AppendTraceEvent(TraceObject* trace_event);\n \n-  void AddMetadataEvent(std::unique_ptr<TraceObject> event) {\n-    metadata_events_.push_back(std::move(event));\n-  }\n+  void AddMetadataEvent(std::unique_ptr<TraceObject> event);\n   // Flushes all writers registered through AddClient().\n   void Flush(bool blocking);\n \n@@ -145,6 +143,8 @@ class Agent {\n   ConditionVariable initialize_writer_condvar_;\n   uv_async_t initialize_writer_async_;\n   std::set<AsyncTraceWriter*> to_be_initialized_;\n+\n+  Mutex metadata_events_mutex_;\n   std::list<std::unique_ptr<TraceObject>> metadata_events_;\n };\n "
        }
    ],
    "stats": {
        "total": 18,
        "additions": 13,
        "deletions": 5
    }
}