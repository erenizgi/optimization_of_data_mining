{
    "author": "willhayslett",
    "message": "test: add tests for fs/promises.js fileHandle methods\n\nWorking to increase test code coverage for fs/promises.js.\nAdded tests for fileHandle.appendFile and fileHandle.chmod.\n\nPR-URL: https://github.com/nodejs/node/pull/19605\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Rich Trott <rtrott@gmail.com>",
    "sha": "126b03e2f9e5a695b025a1a70eb49b88de43d080",
    "files": [
        {
            "sha": "38336a2b43a57e83db2db916d44e03f2763250e3",
            "filename": "test/parallel/test-fs-promises-file-handle-append-file.js",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-append-file.js",
            "raw_url": "https://github.com/nodejs/node/raw/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-append-file.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-file-handle-append-file.js?ref=126b03e2f9e5a695b025a1a70eb49b88de43d080",
            "patch": "@@ -0,0 +1,41 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+// The following tests validate base functionality for the fs/promises\n+// FileHandle.appendFile method.\n+\n+const fs = require('fs');\n+const { open } = require('fs/promises');\n+const path = require('path');\n+const tmpdir = require('../common/tmpdir');\n+const assert = require('assert');\n+const tmpDir = tmpdir.path;\n+\n+tmpdir.refresh();\n+common.crashOnUnhandledRejection();\n+\n+async function validateAppendBuffer() {\n+  const filePath = path.resolve(tmpDir, 'tmp-append-file-buffer.txt');\n+  const fileHandle = await open(filePath, 'a');\n+  const buffer = Buffer.from('a&Dp'.repeat(100), 'utf8');\n+\n+  await fileHandle.appendFile(buffer);\n+  const appendedFileData = fs.readFileSync(filePath);\n+  assert.deepStrictEqual(appendedFileData, buffer);\n+}\n+\n+async function validateAppendString() {\n+  const filePath = path.resolve(tmpDir, 'tmp-append-file-string.txt');\n+  const fileHandle = await open(filePath, 'a');\n+  const string = 'x~yz'.repeat(100);\n+\n+  await fileHandle.appendFile(string);\n+  const stringAsBuffer = Buffer.from(string, 'utf8');\n+  const appendedFileData = fs.readFileSync(filePath);\n+  assert.deepStrictEqual(appendedFileData, stringAsBuffer);\n+}\n+\n+validateAppendBuffer()\n+  .then(validateAppendString)\n+  .then(common.mustCall());"
        },
        {
            "sha": "c2a44fba7bd32c557aff3d1869f20dc38cafeb01",
            "filename": "test/parallel/test-fs-promises-file-handle-chmod.js",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/nodejs/node/blob/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-chmod.js",
            "raw_url": "https://github.com/nodejs/node/raw/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-chmod.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-file-handle-chmod.js?ref=126b03e2f9e5a695b025a1a70eb49b88de43d080",
            "patch": "@@ -0,0 +1,44 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+// The following tests validate base functionality for the fs/promises\n+// FileHandle.chmod method.\n+\n+const fs = require('fs');\n+const { open } = require('fs/promises');\n+const path = require('path');\n+const tmpdir = require('../common/tmpdir');\n+const assert = require('assert');\n+const tmpDir = tmpdir.path;\n+\n+tmpdir.refresh();\n+common.crashOnUnhandledRejection();\n+\n+async function validateFilePermission() {\n+  const filePath = path.resolve(tmpDir, 'tmp-chmod.txt');\n+  const fileHandle = await open(filePath, 'w+', 0o444);\n+  // file created with r--r--r-- 444\n+  const statsBeforeMod = fs.statSync(filePath);\n+  assert.deepStrictEqual(statsBeforeMod.mode & 0o444, 0o444);\n+\n+  let expectedAccess;\n+  const newPermissions = 0o765;\n+\n+  if (common.isWindows) {\n+    // chmod in Windows will only toggle read only/write access. the\n+    // fs.Stats.mode in Windows is computed using read/write\n+    // bits (not exec). read only at best returns 444; r/w 666.\n+    // refer: /deps/uv/src/win/fs.cfs;\n+    expectedAccess = 0o664;\n+  } else {\n+    expectedAccess = newPermissions;\n+  }\n+\n+  // change the permissions to rwxr--r-x\n+  await fileHandle.chmod(newPermissions);\n+  const statsAfterMod = fs.statSync(filePath);\n+  assert.deepStrictEqual(statsAfterMod.mode & expectedAccess, expectedAccess);\n+}\n+\n+validateFilePermission().then(common.mustCall());"
        },
        {
            "sha": "5a9bc4558cf15f55b64c3295fa5a0297f30dec11",
            "filename": "test/parallel/test-fs-promises-file-handle-read.js",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/nodejs/node/blob/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-read.js",
            "raw_url": "https://github.com/nodejs/node/raw/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-read.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-file-handle-read.js?ref=126b03e2f9e5a695b025a1a70eb49b88de43d080",
            "patch": "@@ -0,0 +1,45 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+// The following tests validate base functionality for the fs/promises\n+// FileHandle.read method.\n+\n+const fs = require('fs');\n+const { open } = require('fs/promises');\n+const path = require('path');\n+const tmpdir = require('../common/tmpdir');\n+const assert = require('assert');\n+const tmpDir = tmpdir.path;\n+\n+tmpdir.refresh();\n+common.crashOnUnhandledRejection();\n+\n+async function validateRead() {\n+  const filePath = path.resolve(tmpDir, 'tmp-read-file.txt');\n+  const fileHandle = await open(filePath, 'w+');\n+  const buffer = Buffer.from('Hello world', 'utf8');\n+\n+  const fd = fs.openSync(filePath, 'w+');\n+  fs.writeSync(fd, buffer, 0, buffer.length);\n+  fs.closeSync(fd);\n+  const readAsyncHandle = await fileHandle.read(Buffer.alloc(11), 0, 11, 0);\n+  assert.deepStrictEqual(buffer.length, readAsyncHandle.bytesRead);\n+  assert.deepStrictEqual(buffer, readAsyncHandle.buffer);\n+}\n+\n+async function validateEmptyRead() {\n+  const filePath = path.resolve(tmpDir, 'tmp-read-empty-file.txt');\n+  const fileHandle = await open(filePath, 'w+');\n+  const buffer = Buffer.from('', 'utf8');\n+\n+  const fd = fs.openSync(filePath, 'w+');\n+  fs.writeSync(fd, buffer, 0, buffer.length);\n+  fs.closeSync(fd);\n+  const readAsyncHandle = await fileHandle.read(Buffer.alloc(11), 0, 11, 0);\n+  assert.deepStrictEqual(buffer.length, readAsyncHandle.bytesRead);\n+}\n+\n+validateRead()\n+  .then(validateEmptyRead)\n+  .then(common.mustCall());"
        },
        {
            "sha": "9308c299092714ad7a9df8d3027317a4f7525794",
            "filename": "test/parallel/test-fs-promises-file-handle-readFile.js",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/nodejs/node/blob/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-readFile.js",
            "raw_url": "https://github.com/nodejs/node/raw/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-readFile.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-file-handle-readFile.js?ref=126b03e2f9e5a695b025a1a70eb49b88de43d080",
            "patch": "@@ -0,0 +1,32 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+// The following tests validate base functionality for the fs/promises\n+// FileHandle.readFile method.\n+\n+const fs = require('fs');\n+const { open } = require('fs/promises');\n+const path = require('path');\n+const tmpdir = require('../common/tmpdir');\n+const assert = require('assert');\n+const tmpDir = tmpdir.path;\n+\n+tmpdir.refresh();\n+common.crashOnUnhandledRejection();\n+\n+async function validateReadFile() {\n+  const filePath = path.resolve(tmpDir, 'tmp-read-file.txt');\n+  const fileHandle = await open(filePath, 'w+');\n+  const buffer = Buffer.from('Hello world'.repeat(100), 'utf8');\n+\n+  const fd = fs.openSync(filePath, 'w+');\n+  fs.writeSync(fd, buffer, 0, buffer.length);\n+  fs.closeSync(fd);\n+\n+  const readFileData = await fileHandle.readFile();\n+  assert.deepStrictEqual(buffer, readFileData);\n+}\n+\n+validateReadFile()\n+  .then(common.mustCall());"
        },
        {
            "sha": "842095a214c2ef08909903132b3c3584bf275a45",
            "filename": "test/parallel/test-fs-promises-file-handle-write.js",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/nodejs/node/blob/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-write.js",
            "raw_url": "https://github.com/nodejs/node/raw/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-write.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-file-handle-write.js?ref=126b03e2f9e5a695b025a1a70eb49b88de43d080",
            "patch": "@@ -0,0 +1,40 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+// The following tests validate base functionality for the fs/promises\n+// FileHandle.read method.\n+\n+const fs = require('fs');\n+const { open } = require('fs/promises');\n+const path = require('path');\n+const tmpdir = require('../common/tmpdir');\n+const assert = require('assert');\n+const tmpDir = tmpdir.path;\n+\n+tmpdir.refresh();\n+common.crashOnUnhandledRejection();\n+\n+async function validateWrite() {\n+  const filePathForHandle = path.resolve(tmpDir, 'tmp-write.txt');\n+  const fileHandle = await open(filePathForHandle, 'w+');\n+  const buffer = Buffer.from('Hello world'.repeat(100), 'utf8');\n+\n+  await fileHandle.write(buffer, 0, buffer.length);\n+  const readFileData = fs.readFileSync(filePathForHandle);\n+  assert.deepStrictEqual(buffer, readFileData);\n+}\n+\n+async function validateEmptyWrite() {\n+  const filePathForHandle = path.resolve(tmpDir, 'tmp-empty-write.txt');\n+  const fileHandle = await open(filePathForHandle, 'w+');\n+  const buffer = Buffer.from(''); // empty buffer\n+\n+  await fileHandle.write(buffer, 0, buffer.length);\n+  const readFileData = fs.readFileSync(filePathForHandle);\n+  assert.deepStrictEqual(buffer, readFileData);\n+}\n+\n+validateWrite()\n+  .then(validateEmptyWrite)\n+  .then(common.mustCall());"
        },
        {
            "sha": "196b6f8db8cd58257dcd481aa0bb32c0879fad5a",
            "filename": "test/parallel/test-fs-promises-file-handle-writeFile.js",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-writeFile.js",
            "raw_url": "https://github.com/nodejs/node/raw/126b03e2f9e5a695b025a1a70eb49b88de43d080/test%2Fparallel%2Ftest-fs-promises-file-handle-writeFile.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-file-handle-writeFile.js?ref=126b03e2f9e5a695b025a1a70eb49b88de43d080",
            "patch": "@@ -0,0 +1,29 @@\n+'use strict';\n+\n+const common = require('../common');\n+\n+// The following tests validate base functionality for the fs/promises\n+// FileHandle.readFile method.\n+\n+const fs = require('fs');\n+const { open } = require('fs/promises');\n+const path = require('path');\n+const tmpdir = require('../common/tmpdir');\n+const assert = require('assert');\n+const tmpDir = tmpdir.path;\n+\n+tmpdir.refresh();\n+common.crashOnUnhandledRejection();\n+\n+async function validateWriteFile() {\n+  const filePathForHandle = path.resolve(tmpDir, 'tmp-write-file2.txt');\n+  const fileHandle = await open(filePathForHandle, 'w+');\n+  const buffer = Buffer.from('Hello world'.repeat(100), 'utf8');\n+\n+  await fileHandle.writeFile(buffer);\n+  const readFileData = fs.readFileSync(filePathForHandle);\n+  assert.deepStrictEqual(buffer, readFileData);\n+}\n+\n+validateWriteFile()\n+  .then(common.mustCall());"
        }
    ],
    "stats": {
        "total": 231,
        "additions": 231,
        "deletions": 0
    }
}