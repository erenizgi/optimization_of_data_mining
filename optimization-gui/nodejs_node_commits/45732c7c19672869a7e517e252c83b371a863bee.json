{
    "author": "maclover7",
    "message": "src: add HandleWrap::AddWrapMethods\n\nExtracts common setters to a single location\n\nPR-URL: https://github.com/nodejs/node/pull/21769\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Minwoo Jung <minwoo@nodesource.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>",
    "sha": "45732c7c19672869a7e517e252c83b371a863bee",
    "files": [
        {
            "sha": "9281300146c4f3e9c5e092ad753bc5473161b538",
            "filename": "src/handle_wrap.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Fhandle_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Fhandle_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fhandle_wrap.cc?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -29,6 +29,7 @@ namespace node {\n \n using v8::Context;\n using v8::FunctionCallbackInfo;\n+using v8::FunctionTemplate;\n using v8::HandleScope;\n using v8::Local;\n using v8::Object;\n@@ -130,4 +131,13 @@ void HandleWrap::OnClose(uv_handle_t* handle) {\n }\n \n \n+void HandleWrap::AddWrapMethods(Environment* env,\n+                                Local<FunctionTemplate> t) {\n+  env->SetProtoMethod(t, \"close\", HandleWrap::Close);\n+  env->SetProtoMethodNoSideEffect(t, \"hasRef\", HandleWrap::HasRef);\n+  env->SetProtoMethod(t, \"ref\", HandleWrap::Ref);\n+  env->SetProtoMethod(t, \"unref\", HandleWrap::Unref);\n+}\n+\n+\n }  // namespace node"
        },
        {
            "sha": "443d28bf523933064b7f049efae6ccabc59628e3",
            "filename": "src/handle_wrap.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Fhandle_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Fhandle_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fhandle_wrap.h?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -73,6 +73,9 @@ class HandleWrap : public AsyncWrap {\n   virtual void Close(\n       v8::Local<v8::Value> close_callback = v8::Local<v8::Value>());\n \n+  static void AddWrapMethods(Environment* env,\n+                             v8::Local<v8::FunctionTemplate> constructor);\n+\n  protected:\n   HandleWrap(Environment* env,\n              v8::Local<v8::Object> object,"
        },
        {
            "sha": "24a99c8bc663580fb9f654395dd3daa4c56e4de2",
            "filename": "src/node_messaging.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Fnode_messaging.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Fnode_messaging.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_messaging.cc?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -718,15 +718,12 @@ MaybeLocal<Function> GetMessagePortConstructor(\n     m->InstanceTemplate()->SetInternalFieldCount(1);\n \n     AsyncWrap::AddWrapMethods(env, m);\n+    HandleWrap::AddWrapMethods(env, m);\n \n     env->SetProtoMethod(m, \"postMessage\", MessagePort::PostMessage);\n     env->SetProtoMethod(m, \"start\", MessagePort::Start);\n     env->SetProtoMethod(m, \"stop\", MessagePort::Stop);\n     env->SetProtoMethod(m, \"drain\", MessagePort::Drain);\n-    env->SetProtoMethod(m, \"close\", HandleWrap::Close);\n-    env->SetProtoMethod(m, \"unref\", HandleWrap::Unref);\n-    env->SetProtoMethod(m, \"ref\", HandleWrap::Ref);\n-    env->SetProtoMethod(m, \"hasRef\", HandleWrap::HasRef);\n \n     env->set_message_port_constructor_template(m);\n   }"
        },
        {
            "sha": "5e47476fd97a0c81e09782c4fcc46e6f39686014",
            "filename": "src/node_stat_watcher.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Fnode_stat_watcher.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Fnode_stat_watcher.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_stat_watcher.cc?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -52,11 +52,9 @@ void StatWatcher::Initialize(Environment* env, Local<Object> target) {\n   t->SetClassName(statWatcherString);\n \n   AsyncWrap::AddWrapMethods(env, t);\n+  HandleWrap::AddWrapMethods(env, t);\n+\n   env->SetProtoMethod(t, \"start\", StatWatcher::Start);\n-  env->SetProtoMethod(t, \"close\", HandleWrap::Close);\n-  env->SetProtoMethod(t, \"ref\", HandleWrap::Ref);\n-  env->SetProtoMethod(t, \"unref\", HandleWrap::Unref);\n-  env->SetProtoMethod(t, \"hasRef\", HandleWrap::HasRef);\n \n   target->Set(statWatcherString, t->GetFunction());\n }"
        },
        {
            "sha": "a6044b6b267e472191e1abf95605b216e68afffa",
            "filename": "src/pipe_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Fpipe_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Fpipe_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fpipe_wrap.cc?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -77,12 +77,7 @@ void PipeWrap::Initialize(Local<Object> target,\n   t->InstanceTemplate()->SetInternalFieldCount(1);\n \n   AsyncWrap::AddWrapMethods(env, t);\n-\n-  env->SetProtoMethod(t, \"close\", HandleWrap::Close);\n-  env->SetProtoMethod(t, \"unref\", HandleWrap::Unref);\n-  env->SetProtoMethod(t, \"ref\", HandleWrap::Ref);\n-  env->SetProtoMethod(t, \"hasRef\", HandleWrap::HasRef);\n-\n+  HandleWrap::AddWrapMethods(env, t);\n   LibuvStreamWrap::AddMethods(env, t);\n \n   env->SetProtoMethod(t, \"bind\", Bind);"
        },
        {
            "sha": "1931e8107ff67ece9c5b72d29597b69fcff9e752",
            "filename": "src/process_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Fprocess_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Fprocess_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fprocess_wrap.cc?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -58,16 +58,11 @@ class ProcessWrap : public HandleWrap {\n     constructor->SetClassName(processString);\n \n     AsyncWrap::AddWrapMethods(env, constructor);\n-\n-    env->SetProtoMethod(constructor, \"close\", HandleWrap::Close);\n+    HandleWrap::AddWrapMethods(env, constructor);\n \n     env->SetProtoMethod(constructor, \"spawn\", Spawn);\n     env->SetProtoMethod(constructor, \"kill\", Kill);\n \n-    env->SetProtoMethod(constructor, \"ref\", HandleWrap::Ref);\n-    env->SetProtoMethod(constructor, \"unref\", HandleWrap::Unref);\n-    env->SetProtoMethod(constructor, \"hasRef\", HandleWrap::HasRef);\n-\n     target->Set(processString, constructor->GetFunction());\n   }\n "
        },
        {
            "sha": "e245ad924c61fc1ebaf66e41525e2f8092ae2b8f",
            "filename": "src/signal_wrap.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Fsignal_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Fsignal_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fsignal_wrap.cc?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -52,10 +52,8 @@ class SignalWrap : public HandleWrap {\n     constructor->SetClassName(signalString);\n \n     AsyncWrap::AddWrapMethods(env, constructor);\n-    env->SetProtoMethod(constructor, \"close\", HandleWrap::Close);\n-    env->SetProtoMethod(constructor, \"ref\", HandleWrap::Ref);\n-    env->SetProtoMethod(constructor, \"unref\", HandleWrap::Unref);\n-    env->SetProtoMethod(constructor, \"hasRef\", HandleWrap::HasRef);\n+    HandleWrap::AddWrapMethods(env, constructor);\n+\n     env->SetProtoMethod(constructor, \"start\", Start);\n     env->SetProtoMethod(constructor, \"stop\", Stop);\n "
        },
        {
            "sha": "805e566bfab08ba7aa8b7a0e6d850df2cfaf524c",
            "filename": "src/tcp_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Ftcp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Ftcp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftcp_wrap.cc?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -86,13 +86,7 @@ void TCPWrap::Initialize(Local<Object> target,\n   t->InstanceTemplate()->Set(env->onconnection_string(), Null(env->isolate()));\n \n   AsyncWrap::AddWrapMethods(env, t, AsyncWrap::kFlagHasReset);\n-\n-  env->SetProtoMethod(t, \"close\", HandleWrap::Close);\n-\n-  env->SetProtoMethod(t, \"ref\", HandleWrap::Ref);\n-  env->SetProtoMethod(t, \"unref\", HandleWrap::Unref);\n-  env->SetProtoMethod(t, \"hasRef\", HandleWrap::HasRef);\n-\n+  HandleWrap::AddWrapMethods(env, t);\n   LibuvStreamWrap::AddMethods(env, t);\n \n   env->SetProtoMethod(t, \"open\", Open);"
        },
        {
            "sha": "9da209bef48577dfdd1e1b1dfaf851f1e31937b1",
            "filename": "src/timer_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Ftimer_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Ftimer_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftimer_wrap.cc?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -55,11 +55,7 @@ class TimerWrap : public HandleWrap {\n     env->SetTemplateMethod(constructor, \"now\", Now);\n \n     AsyncWrap::AddWrapMethods(env, constructor);\n-\n-    env->SetProtoMethod(constructor, \"close\", HandleWrap::Close);\n-    env->SetProtoMethod(constructor, \"ref\", HandleWrap::Ref);\n-    env->SetProtoMethod(constructor, \"unref\", HandleWrap::Unref);\n-    env->SetProtoMethod(constructor, \"hasRef\", HandleWrap::HasRef);\n+    HandleWrap::AddWrapMethods(env, constructor);\n \n     env->SetProtoMethod(constructor, \"start\", Start);\n "
        },
        {
            "sha": "39d7ca1474ff8a9c736484e72d3b77a185143c5e",
            "filename": "src/tty_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Ftty_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Ftty_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Ftty_wrap.cc?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -54,12 +54,7 @@ void TTYWrap::Initialize(Local<Object> target,\n   t->InstanceTemplate()->SetInternalFieldCount(1);\n \n   AsyncWrap::AddWrapMethods(env, t);\n-\n-  env->SetProtoMethod(t, \"close\", HandleWrap::Close);\n-  env->SetProtoMethod(t, \"unref\", HandleWrap::Unref);\n-  env->SetProtoMethod(t, \"ref\", HandleWrap::Ref);\n-  env->SetProtoMethodNoSideEffect(t, \"hasRef\", HandleWrap::HasRef);\n-\n+  HandleWrap::AddWrapMethods(env, t);\n   LibuvStreamWrap::AddMethods(env, t);\n \n   env->SetProtoMethodNoSideEffect(t, \"getWindowSize\", TTYWrap::GetWindowSize);"
        },
        {
            "sha": "2ef6732213ca36fd8c2275140bd95c189e39187d",
            "filename": "src/udp_wrap.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/45732c7c19672869a7e517e252c83b371a863bee/src%2Fudp_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/45732c7c19672869a7e517e252c83b371a863bee/src%2Fudp_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fudp_wrap.cc?ref=45732c7c19672869a7e517e252c83b371a863bee",
            "patch": "@@ -115,7 +115,6 @@ void UDPWrap::Initialize(Local<Object> target,\n   env->SetProtoMethod(t, \"send\", Send);\n   env->SetProtoMethod(t, \"bind6\", Bind6);\n   env->SetProtoMethod(t, \"send6\", Send6);\n-  env->SetProtoMethod(t, \"close\", Close);\n   env->SetProtoMethod(t, \"recvStart\", RecvStart);\n   env->SetProtoMethod(t, \"recvStop\", RecvStop);\n   env->SetProtoMethod(t, \"getsockname\",\n@@ -129,11 +128,8 @@ void UDPWrap::Initialize(Local<Object> target,\n   env->SetProtoMethod(t, \"setTTL\", SetTTL);\n   env->SetProtoMethod(t, \"bufferSize\", BufferSize);\n \n-  env->SetProtoMethod(t, \"ref\", HandleWrap::Ref);\n-  env->SetProtoMethod(t, \"unref\", HandleWrap::Unref);\n-  env->SetProtoMethod(t, \"hasRef\", HandleWrap::HasRef);\n-\n   AsyncWrap::AddWrapMethods(env, t);\n+  HandleWrap::AddWrapMethods(env, t);\n \n   target->Set(udpString, t->GetFunction());\n   env->set_udp_constructor_function(t->GetFunction());"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 24,
        "deletions": 47
    }
}