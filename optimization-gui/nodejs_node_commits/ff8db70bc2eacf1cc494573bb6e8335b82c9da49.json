{
    "author": "cjihrig",
    "message": "benchmark: add common.binding()\n\nRecently, process.binding() was replaced with internalBinding().\nHowever, internalBinding() is not available on older builds of\nNode, which are often used for benchmarking purposes. This commit\nadds a common.binding() to the benchmarks to work around the\nissue. Hopefully, this can be removed in the not too distant\nfuture.\n\nPR-URL: https://github.com/nodejs/node/pull/23460\nFixes: https://github.com/nodejs/node/issues/23436\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Weijia Wang <starkwang@126.com>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>",
    "sha": "ff8db70bc2eacf1cc494573bb6e8335b82c9da49",
    "files": [
        {
            "sha": "79aef5a55f9bcd55ff7f98116d9890cc3e426644",
            "filename": "benchmark/common.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fcommon.js",
            "raw_url": "https://github.com/nodejs/node/raw/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fcommon.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fcommon.js?ref=ff8db70bc2eacf1cc494573bb6e8335b82c9da49",
            "patch": "@@ -242,3 +242,13 @@ Benchmark.prototype.report = function(rate, elapsed) {\n     type: 'report'\n   });\n };\n+\n+exports.binding = function(bindingName) {\n+  try {\n+    const { internalBinding } = require('internal/test/binding');\n+\n+    return internalBinding(bindingName);\n+  } catch {\n+    return process.binding(bindingName);\n+  }\n+};"
        },
        {
            "sha": "a54f0efa75e3c16244f92fe33aefd9eec7e92b4e",
            "filename": "benchmark/http/bench-parser.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fhttp%2Fbench-parser.js",
            "raw_url": "https://github.com/nodejs/node/raw/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fhttp%2Fbench-parser.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fhttp%2Fbench-parser.js?ref=ff8db70bc2eacf1cc494573bb6e8335b82c9da49",
            "patch": "@@ -10,8 +10,7 @@ const bench = common.createBenchmark(main, {\n });\n \n function main({ len, n }) {\n-  const { internalBinding } = require('internal/test/binding');\n-  const { HTTPParser } = internalBinding('http_parser');\n+  const { HTTPParser } = common.binding('http_parser');\n   const REQUEST = HTTPParser.REQUEST;\n   const kOnHeaders = HTTPParser.kOnHeaders | 0;\n   const kOnHeadersComplete = HTTPParser.kOnHeadersComplete | 0;"
        },
        {
            "sha": "a55660fbc072475afb492faed39f856bd4523c17",
            "filename": "benchmark/misc/punycode.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fmisc%2Fpunycode.js",
            "raw_url": "https://github.com/nodejs/node/raw/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fmisc%2Fpunycode.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fmisc%2Fpunycode.js?ref=ff8db70bc2eacf1cc494573bb6e8335b82c9da49",
            "patch": "@@ -3,7 +3,7 @@\n const common = require('../common.js');\n let icu;\n try {\n-  icu = process.binding('icu');\n+  icu = common.binding('icu');\n } catch (err) {}\n const punycode = require('punycode');\n "
        },
        {
            "sha": "d76f53cf04e82d9b45a2ef986823411126a37a33",
            "filename": "benchmark/misc/trace.js",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fmisc%2Ftrace.js",
            "raw_url": "https://github.com/nodejs/node/raw/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fmisc%2Ftrace.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fmisc%2Ftrace.js?ref=ff8db70bc2eacf1cc494573bb6e8335b82c9da49",
            "patch": "@@ -11,7 +11,7 @@ const bench = common.createBenchmark(main, {\n \n const {\n   TRACE_EVENT_PHASE_NESTABLE_ASYNC_BEGIN: kBeforeEvent\n-} = process.binding('constants').trace;\n+} = common.binding('constants').trace;\n \n function doTrace(n, trace) {\n   bench.start();\n@@ -31,12 +31,10 @@ function doIsTraceCategoryEnabled(n, isTraceCategoryEnabled) {\n }\n \n function main({ n, method }) {\n-  const { internalBinding } = require('internal/test/binding');\n-\n   const {\n     trace,\n     isTraceCategoryEnabled\n-  } = internalBinding('trace_events');\n+  } = common.binding('trace_events');\n \n   switch (method) {\n     case '':"
        },
        {
            "sha": "1f10ae7c839d878d284cc7b4668342dde21d8ba3",
            "filename": "benchmark/net/tcp-raw-c2s.js",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fnet%2Ftcp-raw-c2s.js",
            "raw_url": "https://github.com/nodejs/node/raw/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fnet%2Ftcp-raw-c2s.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnet%2Ftcp-raw-c2s.js?ref=ff8db70bc2eacf1cc494573bb6e8335b82c9da49",
            "patch": "@@ -15,10 +15,12 @@ const bench = common.createBenchmark(main, {\n }, { flags: [ '--expose-internals', '--no-warnings' ] });\n \n function main({ dur, len, type }) {\n-  const { internalBinding } = require('internal/test/binding');\n-  const { TCP, constants: TCPConstants } = process.binding('tcp_wrap');\n-  const { TCPConnectWrap } = process.binding('tcp_wrap');\n-  const { WriteWrap } = internalBinding('stream_wrap');\n+  const {\n+    TCP,\n+    TCPConnectWrap,\n+    constants: TCPConstants\n+  } = common.binding('tcp_wrap');\n+  const { WriteWrap } = common.binding('stream_wrap');\n   const PORT = common.PORT;\n \n   const serverHandle = new TCP(TCPConstants.SERVER);"
        },
        {
            "sha": "16dc6955c462402ab0ac31a66fb0726a1e0bddcb",
            "filename": "benchmark/net/tcp-raw-pipe.js",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fnet%2Ftcp-raw-pipe.js",
            "raw_url": "https://github.com/nodejs/node/raw/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fnet%2Ftcp-raw-pipe.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnet%2Ftcp-raw-pipe.js?ref=ff8db70bc2eacf1cc494573bb6e8335b82c9da49",
            "patch": "@@ -17,10 +17,12 @@ const bench = common.createBenchmark(main, {\n });\n \n function main({ dur, len, type }) {\n-  const { internalBinding } = require('internal/test/binding');\n-  const { TCP, constants: TCPConstants } = process.binding('tcp_wrap');\n-  const { TCPConnectWrap } = process.binding('tcp_wrap');\n-  const { WriteWrap } = internalBinding('stream_wrap');\n+  const {\n+    TCP,\n+    TCPConnectWrap,\n+    constants: TCPConstants\n+  } = common.binding('tcp_wrap');\n+  const { WriteWrap } = common.binding('stream_wrap');\n   const PORT = common.PORT;\n \n   function fail(err, syscall) {"
        },
        {
            "sha": "1700d23890a3b551e72a208949f703892735fac9",
            "filename": "benchmark/net/tcp-raw-s2c.js",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fnet%2Ftcp-raw-s2c.js",
            "raw_url": "https://github.com/nodejs/node/raw/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Fnet%2Ftcp-raw-s2c.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fnet%2Ftcp-raw-s2c.js?ref=ff8db70bc2eacf1cc494573bb6e8335b82c9da49",
            "patch": "@@ -17,10 +17,12 @@ const bench = common.createBenchmark(main, {\n });\n \n function main({ dur, len, type }) {\n-  const { internalBinding } = require('internal/test/binding');\n-  const { TCP, constants: TCPConstants } = process.binding('tcp_wrap');\n-  const { TCPConnectWrap } = process.binding('tcp_wrap');\n-  const { WriteWrap } = internalBinding('stream_wrap');\n+  const {\n+    TCP,\n+    TCPConnectWrap,\n+    constants: TCPConstants\n+  } = common.binding('tcp_wrap');\n+  const { WriteWrap } = common.binding('stream_wrap');\n   const PORT = common.PORT;\n \n   const serverHandle = new TCP(TCPConstants.SERVER);"
        },
        {
            "sha": "f11471980d9216f96196059597736ee35cc4f27e",
            "filename": "benchmark/util/type-check.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Futil%2Ftype-check.js",
            "raw_url": "https://github.com/nodejs/node/raw/ff8db70bc2eacf1cc494573bb6e8335b82c9da49/benchmark%2Futil%2Ftype-check.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Futil%2Ftype-check.js?ref=ff8db70bc2eacf1cc494573bb6e8335b82c9da49",
            "patch": "@@ -38,8 +38,7 @@ function main({ type, argument, version, n }) {\n   // For testing, if supplied with an empty type, default to ArrayBufferView.\n   type = type || 'ArrayBufferView';\n \n-  const { internalBinding } = require('internal/test/binding');\n-  const util = internalBinding('util');\n+  const util = common.binding('util');\n   const types = require('internal/util/types');\n \n   const func = { native: util, js: types }[version][`is${type}`];"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 33,
        "deletions": 21
    }
}