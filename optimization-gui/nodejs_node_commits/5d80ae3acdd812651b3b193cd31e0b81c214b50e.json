{
    "author": "addaleax",
    "message": "trace_events: forbid tracing modifications from worker threads\n\nForbid modifying tracing state from worker threads, either\nthrough the built-in module or inspector sessions, since\nthe main thread owns all global state, and at least\nthe `async_hooks` integration is definitely not thread\nsafe in its current state.\n\nPR-URL: https://github.com/nodejs/node/pull/23781\nFixes: https://github.com/nodejs/node/issues/22767\nRefs: https://github.com/nodejs/node/issues/22513\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Richard Lau <riclau@uk.ibm.com>\nReviewed-By: Matheus Marchini <mat@mmarchini.me>",
    "sha": "5d80ae3acdd812651b3b193cd31e0b81c214b50e",
    "files": [
        {
            "sha": "10b2f61ea5a5b9f6136ceb24c35f025e3f2359c5",
            "filename": "doc/api/tracing.md",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/5d80ae3acdd812651b3b193cd31e0b81c214b50e/doc%2Fapi%2Ftracing.md",
            "raw_url": "https://github.com/nodejs/node/raw/5d80ae3acdd812651b3b193cd31e0b81c214b50e/doc%2Fapi%2Ftracing.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftracing.md?ref=5d80ae3acdd812651b3b193cd31e0b81c214b50e",
            "patch": "@@ -82,6 +82,8 @@ as the one used by `process.hrtime()`\n however the trace-event timestamps are expressed in microseconds,\n unlike `process.hrtime()` which returns nanoseconds.\n \n+The features from this module are not available in [`Worker`][] threads.\n+\n ## The `trace_events` module\n <!-- YAML\n added: v10.0.0\n@@ -205,3 +207,4 @@ console.log(trace_events.getEnabledCategories());\n [Performance API]: perf_hooks.html\n [V8]: v8.html\n [`async_hooks`]: async_hooks.html\n+[`Worker`]: worker_threads.html#worker_threads_class_worker"
        },
        {
            "sha": "328bb55c88f3c9bf3230ee85c5b3e0e9b1e1706a",
            "filename": "doc/api/worker_threads.md",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5d80ae3acdd812651b3b193cd31e0b81c214b50e/doc%2Fapi%2Fworker_threads.md",
            "raw_url": "https://github.com/nodejs/node/raw/5d80ae3acdd812651b3b193cd31e0b81c214b50e/doc%2Fapi%2Fworker_threads.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fworker_threads.md?ref=5d80ae3acdd812651b3b193cd31e0b81c214b50e",
            "patch": "@@ -253,6 +253,7 @@ Notable differences inside a Worker environment are:\n - Execution may stop at any point as a result of [`worker.terminate()`][]\n   being invoked.\n - IPC channels from parent processes are not accessible.\n+- The [`trace_events`][] module is not supported.\n \n Currently, the following differences also exist until they are addressed:\n \n@@ -489,6 +490,7 @@ active handle in the event system. If the worker is already `unref()`ed calling\n [`SharedArrayBuffer`]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer\n [Signals events]: process.html#process_signal_events\n [`Uint8Array`]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array\n+[`trace_events`]: tracing.html\n [browser `MessagePort`]: https://developer.mozilla.org/en-US/docs/Web/API/MessagePort\n [child processes]: child_process.html\n [HTML structured clone algorithm]: https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm"
        },
        {
            "sha": "878580c67f5a2fd6d88a4b994f8b58711a7b2445",
            "filename": "lib/trace_events.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/5d80ae3acdd812651b3b193cd31e0b81c214b50e/lib%2Ftrace_events.js",
            "raw_url": "https://github.com/nodejs/node/raw/5d80ae3acdd812651b3b193cd31e0b81c214b50e/lib%2Ftrace_events.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Ftrace_events.js?ref=5d80ae3acdd812651b3b193cd31e0b81c214b50e",
            "patch": "@@ -13,7 +13,8 @@ const {\n   ERR_INVALID_ARG_TYPE\n } = require('internal/errors').codes;\n \n-if (!hasTracing)\n+const { isMainThread } = require('internal/worker');\n+if (!hasTracing || !isMainThread)\n   throw new ERR_TRACE_EVENTS_UNAVAILABLE();\n \n const { CategorySet, getEnabledCategories } = internalBinding('trace_events');"
        },
        {
            "sha": "383df37aab88bdad5dfcb6da809a7a6df966d57f",
            "filename": "src/env.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/5d80ae3acdd812651b3b193cd31e0b81c214b50e/src%2Fenv.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5d80ae3acdd812651b3b193cd31e0b81c214b50e/src%2Fenv.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.cc?ref=5d80ae3acdd812651b3b193cd31e0b81c214b50e",
            "patch": "@@ -128,11 +128,22 @@ void InitThreadLocalOnce() {\n }\n \n void Environment::TrackingTraceStateObserver::UpdateTraceCategoryState() {\n+  if (!env_->is_main_thread()) {\n+    // Ideally, weâ€™d have a consistent story that treats all threads/Environment\n+    // instances equally here. However, tracing is essentially global, and this\n+    // callback is called from whichever thread calls `StartTracing()` or\n+    // `StopTracing()`. The only way to do this in a threadsafe fashion\n+    // seems to be only tracking this from the main thread, and only allowing\n+    // these state modifications from the main thread.\n+    return;\n+  }\n+\n   env_->trace_category_state()[0] =\n       *TRACE_EVENT_API_GET_CATEGORY_GROUP_ENABLED(\n           TRACING_CATEGORY_NODE1(async_hooks));\n \n   Isolate* isolate = env_->isolate();\n+  HandleScope handle_scope(isolate);\n   Local<Function> cb = env_->trace_category_state_function();\n   if (cb.IsEmpty())\n     return;\n@@ -182,7 +193,7 @@ Environment::Environment(IsolateData* isolate_data,\n   AssignToContext(context, ContextInfo(\"\"));\n \n   if (tracing::AgentWriterHandle* writer = GetTracingAgentWriter()) {\n-    trace_state_observer_.reset(new TrackingTraceStateObserver(this));\n+    trace_state_observer_ = std::make_unique<TrackingTraceStateObserver>(this);\n     v8::TracingController* tracing_controller = writer->GetTracingController();\n     if (tracing_controller != nullptr)\n       tracing_controller->AddTraceStateObserver(trace_state_observer_.get());"
        },
        {
            "sha": "64bf7457d9f7289d09a710579678a6bf1fa3e5df",
            "filename": "src/inspector/tracing_agent.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/5d80ae3acdd812651b3b193cd31e0b81c214b50e/src%2Finspector%2Ftracing_agent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5d80ae3acdd812651b3b193cd31e0b81c214b50e/src%2Finspector%2Ftracing_agent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector%2Ftracing_agent.cc?ref=5d80ae3acdd812651b3b193cd31e0b81c214b50e",
            "patch": "@@ -65,6 +65,10 @@ DispatchResponse TracingAgent::start(\n     return DispatchResponse::Error(\n         \"Call NodeTracing::end to stop tracing before updating the config\");\n   }\n+  if (!env_->is_main_thread()) {\n+    return DispatchResponse::Error(\n+        \"Tracing properties can only be changed through main thread sessions\");\n+  }\n \n   std::set<std::string> categories_set;\n   protocol::Array<std::string>* categories ="
        },
        {
            "sha": "6140d3a83c5339db2fc8c1b999536b1d05c380e1",
            "filename": "test/parallel/test-trace-events-api-worker-disabled.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/5d80ae3acdd812651b3b193cd31e0b81c214b50e/test%2Fparallel%2Ftest-trace-events-api-worker-disabled.js",
            "raw_url": "https://github.com/nodejs/node/raw/5d80ae3acdd812651b3b193cd31e0b81c214b50e/test%2Fparallel%2Ftest-trace-events-api-worker-disabled.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-api-worker-disabled.js?ref=5d80ae3acdd812651b3b193cd31e0b81c214b50e",
            "patch": "@@ -0,0 +1,11 @@\n+// Flags: --experimental-worker\n+'use strict';\n+\n+const common = require('../common');\n+const { Worker } = require('worker_threads');\n+\n+new Worker(\"require('trace_events')\", { eval: true })\n+  .on('error', common.expectsError({\n+    code: 'ERR_TRACE_EVENTS_UNAVAILABLE',\n+    type: Error\n+  }));"
        },
        {
            "sha": "adae50057e8a4ec4439a08ef407a8169e0a544ba",
            "filename": "test/parallel/test-trace-events-dynamic-enable-workers-disabled.js",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/5d80ae3acdd812651b3b193cd31e0b81c214b50e/test%2Fparallel%2Ftest-trace-events-dynamic-enable-workers-disabled.js",
            "raw_url": "https://github.com/nodejs/node/raw/5d80ae3acdd812651b3b193cd31e0b81c214b50e/test%2Fparallel%2Ftest-trace-events-dynamic-enable-workers-disabled.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-dynamic-enable-workers-disabled.js?ref=5d80ae3acdd812651b3b193cd31e0b81c214b50e",
            "patch": "@@ -0,0 +1,28 @@\n+// Flags: --experimental-worker\n+'use strict';\n+\n+const common = require('../common');\n+const { Worker } = require('worker_threads');\n+\n+common.skipIfInspectorDisabled();\n+\n+if (!process.env.HAS_STARTED_WORKER) {\n+  process.env.HAS_STARTED_WORKER = 1;\n+  new Worker(__filename);\n+  return;\n+}\n+\n+const assert = require('assert');\n+const { Session } = require('inspector');\n+\n+const session = new Session();\n+session.connect();\n+session.post('NodeTracing.start', {\n+  traceConfig: { includedCategories: ['node.perf'] }\n+}, common.mustCall((err) => {\n+  assert.deepStrictEqual(err, {\n+    code: -32000,\n+    message:\n+      'Tracing properties can only be changed through main thread sessions'\n+  });\n+}));"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 62,
        "deletions": 2
    }
}