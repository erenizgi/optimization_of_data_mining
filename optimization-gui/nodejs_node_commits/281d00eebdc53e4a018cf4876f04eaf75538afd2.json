{
    "author": "addaleax",
    "message": "net: inline and simplify onSocketEnd\n\nPR-URL: https://github.com/nodejs/node/pull/18607\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "281d00eebdc53e4a018cf4876f04eaf75538afd2",
    "files": [
        {
            "sha": "7095a5190a17eae5d3cb67b2e081ad115fea43e9",
            "filename": "lib/net.js",
            "status": "modified",
            "additions": 11,
            "deletions": 30,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/281d00eebdc53e4a018cf4876f04eaf75538afd2/lib%2Fnet.js",
            "raw_url": "https://github.com/nodejs/node/raw/281d00eebdc53e4a018cf4876f04eaf75538afd2/lib%2Fnet.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fnet.js?ref=281d00eebdc53e4a018cf4876f04eaf75538afd2",
            "patch": "@@ -256,7 +256,7 @@ function Socket(options) {\n   }\n \n   // shut down the socket when we're finished with it.\n-  this.on('_socketEnd', onSocketEnd);\n+  this.on('end', onReadableStreamEnd);\n \n   initSocketHandle(this);\n \n@@ -360,32 +360,6 @@ function afterShutdown(status, handle) {\n   }\n }\n \n-// the EOF has been received, and no more bytes are coming.\n-// if the writable side has ended already, then clean everything\n-// up.\n-function onSocketEnd() {\n-  // XXX Should not have to do as much in this function.\n-  // ended should already be true, since this is called *after*\n-  // the EOF errno and onread has eof'ed\n-  debug('onSocketEnd', this._readableState);\n-  this._readableState.ended = true;\n-  if (this._readableState.endEmitted) {\n-    this.readable = false;\n-    maybeDestroy(this);\n-  } else {\n-    this.once('end', function end() {\n-      this.readable = false;\n-      maybeDestroy(this);\n-    });\n-    this.read(0);\n-  }\n-\n-  if (!this.allowHalfOpen) {\n-    this.write = writeAfterFIN;\n-    this.destroySoon();\n-  }\n-}\n-\n // Provide a better error message when we call end() as a result\n // of the other side sending a FIN.  The standard 'write after end'\n // is overly vague, and makes it seem like the user's code is to blame.\n@@ -537,6 +511,12 @@ Socket.prototype.end = function(data, encoding, callback) {\n };\n \n \n+// Called when the 'end' event is emitted.\n+function onReadableStreamEnd() {\n+  maybeDestroy(this);\n+}\n+\n+\n // Call whenever we set writable=false or readable=false\n function maybeDestroy(socket) {\n   if (!socket.readable &&\n@@ -651,10 +631,11 @@ function onread(nread, buffer) {\n   // Do it before `maybeDestroy` for correct order of events:\n   // `end` -> `close`\n   self.push(null);\n+  self.read(0);\n \n-  if (self.readableLength === 0) {\n-    self.readable = false;\n-    maybeDestroy(self);\n+  if (!self.allowHalfOpen) {\n+    self.write = writeAfterFIN;\n+    self.destroySoon();\n   }\n \n   // internal end event so that we know that the actual socket"
        },
        {
            "sha": "06f855db9a0702382d67fc35613b9347ca533d3d",
            "filename": "test/parallel/test-http-connect.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/281d00eebdc53e4a018cf4876f04eaf75538afd2/test%2Fparallel%2Ftest-http-connect.js",
            "raw_url": "https://github.com/nodejs/node/raw/281d00eebdc53e4a018cf4876f04eaf75538afd2/test%2Fparallel%2Ftest-http-connect.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-connect.js?ref=281d00eebdc53e4a018cf4876f04eaf75538afd2",
            "patch": "@@ -65,7 +65,8 @@ server.listen(0, common.mustCall(() => {\n \n     // the stream.Duplex onend listener\n     // allow 0 here, so that i can run the same test on streams1 impl\n-    assert(socket.listeners('end').length <= 1);\n+    assert(socket.listenerCount('end') <= 2,\n+           `Found ${socket.listenerCount('end')} end listeners`);\n \n     assert.strictEqual(socket.listeners('free').length, 0);\n     assert.strictEqual(socket.listeners('close').length, 0);"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 13,
        "deletions": 31
    }
}