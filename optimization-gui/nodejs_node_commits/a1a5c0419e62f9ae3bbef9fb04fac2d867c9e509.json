{
    "author": "BridgeAR",
    "message": "lib: improve error creation performance\n\nIn case of an error where we only care about a cleaned up stack\ntrace it is cheaper to reset the stack trace limit for the error\nthat is created. That way the stack frames do not have to be\ncomputed twice.\n\nPR-URL: https://github.com/nodejs/node/pull/24747\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Jeremiah Senkpiel <fishrock123@rocketmail.com>",
    "sha": "a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509",
    "files": [
        {
            "sha": "80125f8c24f04bf244051f44fbd1c245011cbc6c",
            "filename": "lib/_http_outgoing.js",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509/lib%2F_http_outgoing.js",
            "raw_url": "https://github.com/nodejs/node/raw/a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509/lib%2F_http_outgoing.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_outgoing.js?ref=a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509",
            "patch": "@@ -446,20 +446,32 @@ function matchHeader(self, state, field, value) {\n \n function validateHeaderName(name) {\n   if (typeof name !== 'string' || !name || !checkIsHttpToken(name)) {\n+    // Reducing the limit improves the performance significantly. We do not\n+    // lose the stack frames due to the `captureStackTrace()` function that is\n+    // called later.\n+    const tmpLimit = Error.stackTraceLimit;\n+    Error.stackTraceLimit = 0;\n     const err = new ERR_INVALID_HTTP_TOKEN('Header name', name);\n+    Error.stackTraceLimit = tmpLimit;\n     Error.captureStackTrace(err, validateHeaderName);\n     throw err;\n   }\n }\n \n function validateHeaderValue(name, value) {\n   let err;\n+  // Reducing the limit improves the performance significantly. We do not loose\n+  // the stack frames due to the `captureStackTrace()` function that is called\n+  // later.\n+  const tmpLimit = Error.stackTraceLimit;\n+  Error.stackTraceLimit = 0;\n   if (value === undefined) {\n     err = new ERR_HTTP_INVALID_HEADER_VALUE(value, name);\n   } else if (checkInvalidHeaderChar(value)) {\n     debug('Header \"%s\" contains invalid characters', name);\n     err = new ERR_INVALID_CHAR('header content', name);\n   }\n+  Error.stackTraceLimit = tmpLimit;\n   if (err !== undefined) {\n     Error.captureStackTrace(err, validateHeaderValue);\n     throw err;"
        },
        {
            "sha": "b8f8b4cfa2d7252956d1c846bf022d712ef4257d",
            "filename": "lib/internal/errors.js",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/nodejs/node/blob/a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509/lib%2Finternal%2Ferrors.js",
            "raw_url": "https://github.com/nodejs/node/raw/a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509/lib%2Finternal%2Ferrors.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ferrors.js?ref=a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509",
            "patch": "@@ -261,10 +261,16 @@ function uvException(ctx) {\n     message += ` -> '${dest}'`;\n   }\n \n+  // Reducing the limit improves the performance significantly. We do not loose\n+  // the stack frames due to the `captureStackTrace()` function that is called\n+  // later.\n+  const tmpLimit = Error.stackTraceLimit;\n+  Error.stackTraceLimit = 0;\n   // Pass the message to the constructor instead of setting it on the object\n   // to make sure it is the same as the one created in C++\n   // eslint-disable-next-line no-restricted-syntax\n   const err = new Error(message);\n+  Error.stackTraceLimit = tmpLimit;\n \n   for (const prop of Object.keys(ctx)) {\n     if (prop === 'message' || prop === 'path' || prop === 'dest') {\n@@ -307,8 +313,14 @@ function uvExceptionWithHostPort(err, syscall, address, port) {\n     details = ` ${address}`;\n   }\n \n+  // Reducing the limit improves the performance significantly. We do not loose\n+  // the stack frames due to the `captureStackTrace()` function that is called\n+  // later.\n+  const tmpLimit = Error.stackTraceLimit;\n+  Error.stackTraceLimit = 0;\n   // eslint-disable-next-line no-restricted-syntax\n   const ex = new Error(`${message}${details}`);\n+  Error.stackTraceLimit = tmpLimit;\n   ex.code = code;\n   ex.errno = code;\n   ex.syscall = syscall;\n@@ -377,9 +389,15 @@ function exceptionWithHostPort(err, syscall, address, port, additional) {\n     details += ` - Local (${additional})`;\n   }\n \n+  // Reducing the limit improves the performance significantly. We do not loose\n+  // the stack frames due to the `captureStackTrace()` function that is called\n+  // later.\n+  const tmpLimit = Error.stackTraceLimit;\n+  Error.stackTraceLimit = 0;\n   // eslint-disable-next-line no-restricted-syntax\n   const ex = new Error(`${syscall} ${code}${details}`);\n   // TODO(joyeecheung): errno is supposed to err, like in uvException\n+  Error.stackTraceLimit = tmpLimit;\n   ex.code = ex.errno = code;\n   ex.syscall = syscall;\n   ex.address = address;\n@@ -410,9 +428,15 @@ function dnsException(code, syscall, hostname) {\n     }\n   }\n   const message = `${syscall} ${code}${hostname ? ` ${hostname}` : ''}`;\n+  // Reducing the limit improves the performance significantly. We do not loose\n+  // the stack frames due to the `captureStackTrace()` function that is called\n+  // later.\n+  const tmpLimit = Error.stackTraceLimit;\n+  Error.stackTraceLimit = 0;\n   // eslint-disable-next-line no-restricted-syntax\n   const ex = new Error(message);\n   // TODO(joyeecheung): errno is supposed to be a number / err, like in\n+  Error.stackTraceLimit = tmpLimit;\n   // uvException.\n   ex.errno = code;\n   ex.code = code;"
        },
        {
            "sha": "4db4fb536c0b6a00ed745235a5266ed75b4b4697",
            "filename": "lib/internal/fs/utils.js",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509/lib%2Finternal%2Ffs%2Futils.js",
            "raw_url": "https://github.com/nodejs/node/raw/a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509/lib%2Finternal%2Ffs%2Futils.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs%2Futils.js?ref=a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509",
            "patch": "@@ -190,23 +190,27 @@ function nullCheck(path, propName, throwError = true) {\n   const pathIsUint8Array = isUint8Array(path);\n \n   // We can only perform meaningful checks on strings and Uint8Arrays.\n-  if (!pathIsString && !pathIsUint8Array) {\n+  if (!pathIsString && !pathIsUint8Array ||\n+      pathIsString && path.indexOf('\\u0000') === -1 ||\n+      pathIsUint8Array && path.indexOf(0) === -1) {\n     return;\n   }\n \n-  if (pathIsString && path.indexOf('\\u0000') === -1) {\n-    return;\n-  } else if (pathIsUint8Array && path.indexOf(0) === -1) {\n-    return;\n+  // Reducing the limit improves the performance significantly. We do not loose\n+  // the stack frames due to the `captureStackTrace()` function that is called\n+  // later.\n+  const tmpLimit = Error.stackTraceLimit;\n+  if (throwError) {\n+    Error.stackTraceLimit = 0;\n   }\n-\n   const err = new ERR_INVALID_ARG_VALUE(\n     propName,\n     path,\n     'must be a string or Uint8Array without null bytes'\n   );\n \n   if (throwError) {\n+    Error.stackTraceLimit = tmpLimit;\n     Error.captureStackTrace(err, nullCheck);\n     throw err;\n   }"
        },
        {
            "sha": "2238bc2577bb50c829e81c801b098649e84f6bfe",
            "filename": "lib/internal/process/warning.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509/lib%2Finternal%2Fprocess%2Fwarning.js",
            "raw_url": "https://github.com/nodejs/node/raw/a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509/lib%2Finternal%2Fprocess%2Fwarning.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fprocess%2Fwarning.js?ref=a1a5c0419e62f9ae3bbef9fb04fac2d867c9e509",
            "patch": "@@ -127,8 +127,13 @@ function setupProcessWarnings() {\n       throw new ERR_INVALID_ARG_TYPE('code', 'string', code);\n     }\n     if (typeof warning === 'string') {\n+      // Improve error creation performance by skipping the error frames.\n+      // They are added in the `captureStackTrace()` function below.\n+      const tmpStackLimit = Error.stackTraceLimit;\n+      Error.stackTraceLimit = 0;\n       // eslint-disable-next-line no-restricted-syntax\n       warning = new Error(warning);\n+      Error.stackTraceLimit = tmpStackLimit;\n       warning.name = String(type || 'Warning');\n       if (code !== undefined) warning.code = code;\n       if (detail !== undefined) warning.detail = detail;"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 51,
        "deletions": 6
    }
}