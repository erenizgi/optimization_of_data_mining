{
    "author": "TimothyGu",
    "message": "repl: hide top-level await feature behind a flag\n\nPR-URL: https://github.com/nodejs/node/pull/19604\nRefs: https://github.com/nodejs/node/pull/17807\nRefs: https://github.com/nodejs/node/pull/15566#issuecomment-353428430\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "be92eab92a185fdd954da85bc41ab85af0f16690",
    "files": [
        {
            "sha": "3a5134d1e24c0e22ce05dd980299fc2806b1bcdd",
            "filename": "doc/api/repl.md",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/be92eab92a185fdd954da85bc41ab85af0f16690/doc%2Fapi%2Frepl.md",
            "raw_url": "https://github.com/nodejs/node/raw/be92eab92a185fdd954da85bc41ab85af0f16690/doc%2Fapi%2Frepl.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Frepl.md?ref=be92eab92a185fdd954da85bc41ab85af0f16690",
            "patch": "@@ -179,6 +179,25 @@ Error: foo\n 'foo'\n ```\n \n+#### `await` keyword\n+\n+With the `--experimental-repl-await` command line option specified,\n+experimental support for the `await` keyword is enabled.\n+\n+<!-- eslint-skip -->\n+```js\n+> await Promise.resolve(123)\n+123\n+> await Promise.reject(new Error('REPL await'))\n+Error: REPL await\n+    at repl:1:45\n+> const timeout = util.promisify(setTimeout);\n+undefined\n+> const old = Date.now(); await timeout(1000); console.log(Date.now() - old);\n+1002\n+undefined\n+```\n+\n ### Custom Evaluation Functions\n \n When a new `repl.REPLServer` is created, a custom evaluation function may be"
        },
        {
            "sha": "a7977dc72fb7817e900fe403831a68dc0d620744",
            "filename": "lib/repl.js",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/be92eab92a185fdd954da85bc41ab85af0f16690/lib%2Frepl.js",
            "raw_url": "https://github.com/nodejs/node/raw/be92eab92a185fdd954da85bc41ab85af0f16690/lib%2Frepl.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Frepl.js?ref=be92eab92a185fdd954da85bc41ab85af0f16690",
            "patch": "@@ -47,7 +47,6 @@ const {\n   makeRequireFunction,\n   addBuiltinLibsToObject\n } = require('internal/modules/cjs/helpers');\n-const { processTopLevelAwait } = require('internal/repl/await');\n const internalUtil = require('internal/util');\n const { isTypedArray } = require('internal/util/types');\n const util = require('util');\n@@ -69,6 +68,10 @@ const {\n   ERR_SCRIPT_EXECUTION_INTERRUPTED\n } = require('internal/errors').codes;\n const { sendInspectorCommand } = require('internal/util/inspector');\n+const { experimentalREPLAwait } = process.binding('config');\n+\n+// Lazy-loaded.\n+let processTopLevelAwait;\n \n const parentModule = module;\n const replMap = new WeakMap();\n@@ -226,7 +229,11 @@ function REPLServer(prompt,\n       wrappedCmd = true;\n     }\n \n-    if (code.includes('await')) {\n+    if (experimentalREPLAwait && code.includes('await')) {\n+      if (processTopLevelAwait === undefined) {\n+        ({ processTopLevelAwait } = require('internal/repl/await'));\n+      }\n+\n       const potentialWrappedCode = processTopLevelAwait(code);\n       if (potentialWrappedCode !== null) {\n         code = potentialWrappedCode;"
        },
        {
            "sha": "6acad6870d81da8a8ed1183ced745033ca9adaa0",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/be92eab92a185fdd954da85bc41ab85af0f16690/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/be92eab92a185fdd954da85bc41ab85af0f16690/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=be92eab92a185fdd954da85bc41ab85af0f16690",
            "patch": "@@ -243,6 +243,11 @@ bool config_experimental_modules = false;\n // that is used by lib/vm.js\n bool config_experimental_vm_modules = false;\n \n+// Set in node.cc by ParseArgs when --experimental-repl-await is used.\n+// Used in node_config.cc to set a constant on process.binding('config')\n+// that is used by lib/repl.js.\n+bool config_experimental_repl_await = false;\n+\n // Set in node.cc by ParseArgs when --loader is used.\n // Used in node_config.cc to set a constant on process.binding('config')\n // that is used by lib/internal/bootstrap/node.js\n@@ -3463,6 +3468,10 @@ static void PrintHelp() {\n #if defined(NODE_HAVE_I18N_SUPPORT)\n          \"  --experimental-modules     experimental ES Module support\\n\"\n          \"                             and caching modules\\n\"\n+#endif  // defined(NODE_HAVE_I18N_SUPPORT)\n+         \"  --experimental-repl-await  experimental await keyword support\\n\"\n+         \"                             in REPL\\n\"\n+#if defined(NODE_HAVE_I18N_SUPPORT)\n          \"  --experimental-vm-modules  experimental ES Module support\\n\"\n          \"                             in vm module\\n\"\n #endif  // defined(NODE_HAVE_I18N_SUPPORT)\n@@ -3622,6 +3631,7 @@ static void CheckIfAllowedInEnv(const char* exe, bool is_env,\n     // Node options, sorted in `node --help` order for ease of comparison.\n     \"--enable-fips\",\n     \"--experimental-modules\",\n+    \"--experimental-repl-await\",\n     \"--experimental-vm-modules\",\n     \"--expose-http2\",   // keep as a non-op through v9.x\n     \"--force-fips\",\n@@ -3819,6 +3829,8 @@ static void ParseArgs(int* argc,\n       new_v8_argc += 1;\n     } else if (strcmp(arg, \"--experimental-vm-modules\") == 0) {\n       config_experimental_vm_modules = true;\n+    } else if (strcmp(arg, \"--experimental-repl-await\") == 0) {\n+      config_experimental_repl_await = true;\n     }  else if (strcmp(arg, \"--loader\") == 0) {\n       const char* module = argv[index + 1];\n       if (!config_experimental_modules) {"
        },
        {
            "sha": "e2b2662abd0e8043d29a511ef7ec8932854f2b8a",
            "filename": "src/node_config.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/be92eab92a185fdd954da85bc41ab85af0f16690/src%2Fnode_config.cc",
            "raw_url": "https://github.com/nodejs/node/raw/be92eab92a185fdd954da85bc41ab85af0f16690/src%2Fnode_config.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_config.cc?ref=be92eab92a185fdd954da85bc41ab85af0f16690",
            "patch": "@@ -89,6 +89,9 @@ static void Initialize(Local<Object> target,\n   if (config_experimental_vm_modules)\n     READONLY_BOOLEAN_PROPERTY(\"experimentalVMModules\");\n \n+  if (config_experimental_repl_await)\n+    READONLY_BOOLEAN_PROPERTY(\"experimentalREPLAwait\");\n+\n   if (config_pending_deprecation)\n     READONLY_BOOLEAN_PROPERTY(\"pendingDeprecation\");\n "
        },
        {
            "sha": "492a36296fb498fdd77dc373f662e51300d89a92",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/be92eab92a185fdd954da85bc41ab85af0f16690/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/be92eab92a185fdd954da85bc41ab85af0f16690/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=be92eab92a185fdd954da85bc41ab85af0f16690",
            "patch": "@@ -181,6 +181,11 @@ extern bool config_experimental_modules;\n // that is used by lib/vm.js\n extern bool config_experimental_vm_modules;\n \n+// Set in node.cc by ParseArgs when --experimental-repl-await is used.\n+// Used in node_config.cc to set a constant on process.binding('config')\n+// that is used by lib/repl.js.\n+extern bool config_experimental_repl_await;\n+\n // Set in node.cc by ParseArgs when --loader is used.\n // Used in node_config.cc to set a constant on process.binding('config')\n // that is used by lib/internal/bootstrap/node.js"
        },
        {
            "sha": "91f5758c210a367673bc4da2e227c5cc0d81dffd",
            "filename": "test/parallel/test-repl-top-level-await.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/be92eab92a185fdd954da85bc41ab85af0f16690/test%2Fparallel%2Ftest-repl-top-level-await.js",
            "raw_url": "https://github.com/nodejs/node/raw/be92eab92a185fdd954da85bc41ab85af0f16690/test%2Fparallel%2Ftest-repl-top-level-await.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-repl-top-level-await.js?ref=be92eab92a185fdd954da85bc41ab85af0f16690",
            "patch": "@@ -7,7 +7,7 @@ const repl = require('repl');\n \n common.crashOnUnhandledRejection();\n \n-// Flags: --expose-internals\n+// Flags: --expose-internals --experimental-repl-await\n \n const PROMPT = 'await repl > ';\n "
        }
    ],
    "stats": {
        "total": 52,
        "additions": 49,
        "deletions": 3
    }
}