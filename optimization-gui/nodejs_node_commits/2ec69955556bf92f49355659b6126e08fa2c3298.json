{
    "author": "jasnell",
    "message": "perf_hooks: simplify perf_hooks\n\nRemove the `performance.getEntries()` and `performance.clear*()`\nvariants and eliminate the accumulation of the global timeline\nentries. The design of this particular bit of the API is a memory\nleak and performance footgun. The `PerformanceObserver` API is\na better approach to consuming the data in a more transient way.\n\nPR-URL: https://github.com/nodejs/node/pull/19563\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "2ec69955556bf92f49355659b6126e08fa2c3298",
    "files": [
        {
            "sha": "3e05ba285fd3cf0e89c010c5de4de2e232d83786",
            "filename": "doc/api/perf_hooks.md",
            "status": "modified",
            "additions": 8,
            "deletions": 98,
            "changes": 106,
            "blob_url": "https://github.com/nodejs/node/blob/2ec69955556bf92f49355659b6126e08fa2c3298/doc%2Fapi%2Fperf_hooks.md",
            "raw_url": "https://github.com/nodejs/node/raw/2ec69955556bf92f49355659b6126e08fa2c3298/doc%2Fapi%2Fperf_hooks.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fperf_hooks.md?ref=2ec69955556bf92f49355659b6126e08fa2c3298",
            "patch": "@@ -10,14 +10,18 @@ is to support collection of high resolution performance metrics.\n This is the same Performance API as implemented in modern Web browsers.\n \n ```js\n-const { performance } = require('perf_hooks');\n+const { PerformanceObserver, performance } = require('perf_hooks');\n+\n+const obs = new PerformanceObserver((items) => {\n+  console.log(items.getEntries()[0].duration);\n+  performance.clearMarks();\n+});\n+obs.observe({ entryTypes: ['measure'] });\n+\n performance.mark('A');\n doSomeLongRunningProcess(() => {\n   performance.mark('B');\n   performance.measure('A to B', 'A', 'B');\n-  const measure = performance.getEntriesByName('A to B')[0];\n-  console.log(measure.duration);\n-  // Prints the number of milliseconds between Mark 'A' and Mark 'B'\n });\n ```\n \n@@ -26,35 +30,6 @@ doSomeLongRunningProcess(() => {\n added: v8.5.0\n -->\n \n-The `Performance` provides access to performance metric data. A single\n-instance of this class is provided via the `performance` property.\n-\n-### performance.clearEntries(name)\n-<!-- YAML\n-added: v9.5.0\n--->\n-\n-Remove all performance entry objects with `entryType` equal to `name` from the\n-Performance Timeline.\n-\n-### performance.clearFunctions([name])\n-<!-- YAML\n-added: v8.5.0\n--->\n-\n-* `name` {string}\n-\n-If `name` is not provided, removes all `PerformanceFunction` objects from the\n-Performance Timeline. If `name` is provided, removes entries with `name`.\n-\n-### performance.clearGC()\n-<!-- YAML\n-added: v8.5.0\n--->\n-\n-Remove all performance entry objects with `entryType` equal to `gc` from the\n-Performance Timeline.\n-\n ### performance.clearMarks([name])\n <!-- YAML\n added: v8.5.0\n@@ -65,53 +40,6 @@ added: v8.5.0\n If `name` is not provided, removes all `PerformanceMark` objects from the\n Performance Timeline. If `name` is provided, removes only the named mark.\n \n-### performance.clearMeasures([name])\n-<!-- YAML\n-added: v8.5.0\n--->\n-\n-* `name` {string}\n-\n-If `name` is not provided, removes all `PerformanceMeasure` objects from the\n-Performance Timeline. If `name` is provided, removes only objects whose\n-`performanceEntry.name` matches `name`.\n-\n-### performance.getEntries()\n-<!-- YAML\n-added: v8.5.0\n--->\n-\n-* Returns: {Array}\n-\n-Returns a list of all `PerformanceEntry` objects in chronological order\n-with respect to `performanceEntry.startTime`.\n-\n-### performance.getEntriesByName(name[, type])\n-<!-- YAML\n-added: v8.5.0\n--->\n-\n-* `name` {string}\n-* `type` {string}\n-* Returns: {Array}\n-\n-Returns a list of all `PerformanceEntry` objects in chronological order\n-with respect to `performanceEntry.startTime` whose `performanceEntry.name` is\n-equal to `name`, and optionally, whose `performanceEntry.entryType` is equal to\n-`type`.\n-\n-### performance.getEntriesByType(type)\n-<!-- YAML\n-added: v8.5.0\n--->\n-\n-* `type` {string}\n-* Returns: {Array}\n-\n-Returns a list of all `PerformanceEntry` objects in chronological order\n-with respect to `performanceEntry.startTime` whose `performanceEntry.entryType`\n-is equal to `type`.\n-\n ### performance.mark([name])\n <!-- YAML\n added: v8.5.0\n@@ -125,20 +53,6 @@ Creates a new `PerformanceMark` entry in the Performance Timeline. A\n `performanceEntry.duration` is always `0`. Performance marks are used\n to mark specific significant moments in the Performance Timeline.\n \n-### performance.maxEntries\n-<!-- YAML\n-added: v9.6.0\n--->\n-\n-Value: {number}\n-\n-The maximum number of Performance Entry items that should be added to the\n-Performance Timeline. This limit is not strictly enforced, but a process\n-warning will be emitted if the number of entries in the timeline exceeds\n-this limit.\n-\n-Defaults to 150.\n-\n ### performance.measure(name, startMark, endMark)\n <!-- YAML\n added: v8.5.0\n@@ -220,7 +134,6 @@ const wrapped = performance.timerify(someFunction);\n const obs = new PerformanceObserver((list) => {\n   console.log(list.getEntries()[0].duration);\n   obs.disconnect();\n-  performance.clearFunctions();\n });\n obs.observe({ entryTypes: ['function'] });\n \n@@ -608,7 +521,6 @@ hook.enable();\n const obs = new PerformanceObserver((list, observer) => {\n   console.log(list.getEntries()[0]);\n   performance.clearMarks();\n-  performance.clearMeasures();\n   observer.disconnect();\n });\n obs.observe({ entryTypes: ['measure'], buffered: true });\n@@ -642,8 +554,6 @@ const obs = new PerformanceObserver((list) => {\n     console.log(`require('${entry[0]}')`, entry.duration);\n   });\n   obs.disconnect();\n-  // Free memory\n-  performance.clearFunctions();\n });\n obs.observe({ entryTypes: ['function'], buffered: true });\n "
        },
        {
            "sha": "9080cc7f26ca295a180568a0c60c39589096a820",
            "filename": "lib/perf_hooks.js",
            "status": "modified",
            "additions": 7,
            "deletions": 94,
            "changes": 101,
            "blob_url": "https://github.com/nodejs/node/blob/2ec69955556bf92f49355659b6126e08fa2c3298/lib%2Fperf_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/2ec69955556bf92f49355659b6126e08fa2c3298/lib%2Fperf_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fperf_hooks.js?ref=2ec69955556bf92f49355659b6126e08fa2c3298",
            "patch": "@@ -3,6 +3,7 @@\n const {\n   PerformanceEntry,\n   mark: _mark,\n+  clearMark: _clearMark,\n   measure: _measure,\n   milestones,\n   observerCounts,\n@@ -50,17 +51,11 @@ const kBuffering = Symbol('buffering');\n const kQueued = Symbol('queued');\n const kTimerified = Symbol('timerified');\n const kInsertEntry = Symbol('insert-entry');\n-const kIndexEntry = Symbol('index-entry');\n-const kClearEntry = Symbol('clear-entry');\n const kGetEntries = Symbol('get-entries');\n const kIndex = Symbol('index');\n const kMarks = Symbol('marks');\n const kCount = Symbol('count');\n-const kMaxCount = Symbol('max-count');\n-const kDefaultMaxCount = 150;\n \n-observerCounts[NODE_PERFORMANCE_ENTRY_TYPE_MARK] = 1;\n-observerCounts[NODE_PERFORMANCE_ENTRY_TYPE_MEASURE] = 1;\n const observers = {};\n const observerableTypes = [\n   'node',\n@@ -286,17 +281,12 @@ class PerformanceObserverEntryList {\n     const item = { entry };\n     L.append(this[kEntries], item);\n     this[kCount]++;\n-    this[kIndexEntry](item);\n   }\n \n   get length() {\n     return this[kCount];\n   }\n \n-  [kIndexEntry](entry) {\n-    // Default implementation does nothing\n-  }\n-\n   [kGetEntries](name, type) {\n     const ret = [];\n     const list = this[kEntries];\n@@ -407,72 +397,11 @@ class PerformanceObserver extends AsyncResource {\n   }\n }\n \n-class Performance extends PerformanceObserverEntryList {\n+class Performance {\n   constructor() {\n-    super();\n     this[kIndex] = {\n       [kMarks]: new Set()\n     };\n-    this[kMaxCount] = kDefaultMaxCount;\n-    this[kInsertEntry](nodeTiming);\n-  }\n-\n-  set maxEntries(val) {\n-    if (typeof val !== 'number' || val >>> 0 !== val) {\n-      const errors = lazyErrors();\n-      throw new errors.ERR_INVALID_ARG_TYPE('val', 'number', val);\n-    }\n-    this[kMaxCount] = Math.max(1, val >>> 0);\n-  }\n-\n-  get maxEntries() {\n-    return this[kMaxCount];\n-  }\n-\n-  [kIndexEntry](item) {\n-    const index = this[kIndex];\n-    const type = item.entry.entryType;\n-    let items = index[type];\n-    if (!items) {\n-      items = index[type] = {};\n-      L.init(items);\n-    }\n-    const entry = item.entry;\n-    L.append(items, { entry, item });\n-    const count = this[kCount];\n-    if (count > this[kMaxCount]) {\n-      const text = count === 1 ? 'is 1 entry' : `are ${count} entries`;\n-      process.emitWarning('Possible perf_hooks memory leak detected. ' +\n-                          `There ${text} in the ` +\n-                          'Performance Timeline. Use the clear methods ' +\n-                          'to remove entries that are no longer needed or ' +\n-                          'set performance.maxEntries equal to a higher ' +\n-                          'value (currently the maxEntries is ' +\n-                          `${this[kMaxCount]}).`);\n-    }\n-  }\n-\n-  [kClearEntry](type, name) {\n-    const index = this[kIndex];\n-    const items = index[type];\n-    if (!items) return;\n-    let item = L.peek(items);\n-    while (item && item !== items) {\n-      const entry = item.entry;\n-      const next = item._idlePrev;\n-      if (name !== undefined) {\n-        if (entry.name === `${name}`) {\n-          L.remove(item); // remove from the index\n-          L.remove(item.item); // remove from the master\n-          this[kCount]--;\n-        }\n-      } else {\n-        L.remove(item); // remove from the index\n-        L.remove(item.item); // remove from the master\n-        this[kCount]--;\n-      }\n-      item = next;\n-    }\n   }\n \n   get nodeTiming() {\n@@ -507,27 +436,13 @@ class Performance extends PerformanceObserverEntryList {\n \n   clearMarks(name) {\n     name = name !== undefined ? `${name}` : name;\n-    this[kClearEntry]('mark', name);\n-    if (name !== undefined)\n+    if (name !== undefined) {\n       this[kIndex][kMarks].delete(name);\n-    else\n+      _clearMark(name);\n+    } else {\n       this[kIndex][kMarks].clear();\n-  }\n-\n-  clearMeasures(name) {\n-    this[kClearEntry]('measure', name);\n-  }\n-\n-  clearGC() {\n-    this[kClearEntry]('gc');\n-  }\n-\n-  clearFunctions(name) {\n-    this[kClearEntry]('function', name);\n-  }\n-\n-  clearEntries(name) {\n-    this[kClearEntry](name);\n+      _clearMark();\n+    }\n   }\n \n   timerify(fn) {\n@@ -563,7 +478,6 @@ class Performance extends PerformanceObserverEntryList {\n \n   [kInspect]() {\n     return {\n-      maxEntries: this.maxEntries,\n       nodeTiming: this.nodeTiming,\n       timeOrigin: this.timeOrigin\n     };\n@@ -595,7 +509,6 @@ function observersCallback(entry) {\n   if (type === NODE_PERFORMANCE_ENTRY_TYPE_HTTP2)\n     collectHttp2Stats(entry);\n \n-  performance[kInsertEntry](entry);\n   const list = getObserversList(type);\n \n   let current = L.peek(list);"
        },
        {
            "sha": "521492e589a2c08a48b0d37f7a047ffb8699602c",
            "filename": "src/node_perf.cc",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/2ec69955556bf92f49355659b6126e08fa2c3298/src%2Fnode_perf.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2ec69955556bf92f49355659b6126e08fa2c3298/src%2Fnode_perf.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_perf.cc?ref=2ec69955556bf92f49355659b6126e08fa2c3298",
            "patch": "@@ -130,7 +130,7 @@ void PerformanceEntry::Notify(Environment* env,\n                        object.As<Object>(),\n                        env->performance_entry_callback(),\n                        1, &object,\n-                       node::async_context{0, 0}).ToLocalChecked();\n+                       node::async_context{0, 0});\n   }\n }\n \n@@ -153,6 +153,17 @@ void Mark(const FunctionCallbackInfo<Value>& args) {\n   args.GetReturnValue().Set(obj);\n }\n \n+void ClearMark(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  auto marks = env->performance_marks();\n+\n+  if (args.Length() == 0) {\n+    marks->clear();\n+  } else {\n+    Utf8Value name(env->isolate(), args[0]);\n+    marks->erase(*name);\n+  }\n+}\n \n inline uint64_t GetPerformanceMark(Environment* env, std::string name) {\n   auto marks = env->performance_marks();\n@@ -395,6 +406,7 @@ void Initialize(Local<Object> target,\n   target->Set(context, performanceEntryString, fn).FromJust();\n   env->set_performance_entry_template(fn);\n \n+  env->SetMethod(target, \"clearMark\", ClearMark);\n   env->SetMethod(target, \"mark\", Mark);\n   env->SetMethod(target, \"measure\", Measure);\n   env->SetMethod(target, \"markMilestone\", MarkMilestone);"
        },
        {
            "sha": "07d9c55ed7e0d286153eb5122a6fae119bfc27fc",
            "filename": "test/parallel/test-http2-perf_hooks.js",
            "status": "modified",
            "additions": 1,
            "deletions": 9,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/2ec69955556bf92f49355659b6126e08fa2c3298/test%2Fparallel%2Ftest-http2-perf_hooks.js",
            "raw_url": "https://github.com/nodejs/node/raw/2ec69955556bf92f49355659b6126e08fa2c3298/test%2Fparallel%2Ftest-http2-perf_hooks.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-perf_hooks.js?ref=2ec69955556bf92f49355659b6126e08fa2c3298",
            "patch": "@@ -6,7 +6,7 @@ if (!common.hasCrypto)\n const assert = require('assert');\n const h2 = require('http2');\n \n-const { PerformanceObserver, performance } = require('perf_hooks');\n+const { PerformanceObserver } = require('perf_hooks');\n \n const obs = new PerformanceObserver(common.mustCall((items) => {\n   const entry = items.getEntries()[0];\n@@ -46,7 +46,6 @@ const obs = new PerformanceObserver(common.mustCall((items) => {\n     default:\n       assert.fail('invalid entry name');\n   }\n-  performance.clearEntries('http2');\n }, 4));\n obs.observe({ entryTypes: ['http2'] });\n \n@@ -101,10 +100,3 @@ server.on('listening', common.mustCall(() => {\n   }));\n \n }));\n-\n-process.on('exit', () => {\n-  const entries = performance.getEntries();\n-  // There shouldn't be any http2 entries left over.\n-  assert.strictEqual(entries.length, 1);\n-  assert.strictEqual(entries[0], performance.nodeTiming);\n-});"
        },
        {
            "sha": "98b381e649b203ae29f92e2827548934b3cea0ed",
            "filename": "test/parallel/test-performance-function.js",
            "status": "modified",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/2ec69955556bf92f49355659b6126e08fa2c3298/test%2Fparallel%2Ftest-performance-function.js",
            "raw_url": "https://github.com/nodejs/node/raw/2ec69955556bf92f49355659b6126e08fa2c3298/test%2Fparallel%2Ftest-performance-function.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-performance-function.js?ref=2ec69955556bf92f49355659b6126e08fa2c3298",
            "patch": "@@ -11,9 +11,6 @@ const {\n {\n   // Intentional non-op. Do not wrap in common.mustCall();\n   const n = performance.timerify(() => {});\n-  n();\n-  const entries = performance.getEntriesByType('function');\n-  assert.strictEqual(entries.length, 0);\n \n   const obs = new PerformanceObserver(common.mustCall((list) => {\n     const entries = list.getEntries();\n@@ -24,7 +21,6 @@ const {\n     assert.strictEqual(typeof entry.duration, 'number');\n     assert.strictEqual(typeof entry.startTime, 'number');\n     obs.disconnect();\n-    performance.clearFunctions();\n   }));\n   obs.observe({ entryTypes: ['function'] });\n   n();\n@@ -39,17 +35,12 @@ const {\n     throw new Error('test');\n   });\n   assert.throws(() => n(), /^Error: test$/);\n-  const entries = performance.getEntriesByType('function');\n-  assert.strictEqual(entries.length, 0);\n   obs.disconnect();\n }\n \n {\n   class N {}\n   const n = performance.timerify(N);\n-  new n();\n-  const entries = performance.getEntriesByType('function');\n-  assert.strictEqual(entries.length, 0);\n \n   const obs = new PerformanceObserver(common.mustCall((list) => {\n     const entries = list.getEntries();\n@@ -62,7 +53,6 @@ const {\n     assert.strictEqual(typeof entry.duration, 'number');\n     assert.strictEqual(typeof entry.startTime, 'number');\n     obs.disconnect();\n-    performance.clearFunctions();\n   }));\n   obs.observe({ entryTypes: ['function'] });\n "
        },
        {
            "sha": "f4ff88a6378be1acb90d0b59a15894a8a6065b64",
            "filename": "test/parallel/test-performance-gc.js",
            "status": "modified",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/2ec69955556bf92f49355659b6126e08fa2c3298/test%2Fparallel%2Ftest-performance-gc.js",
            "raw_url": "https://github.com/nodejs/node/raw/2ec69955556bf92f49355659b6126e08fa2c3298/test%2Fparallel%2Ftest-performance-gc.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-performance-gc.js?ref=2ec69955556bf92f49355659b6126e08fa2c3298",
            "patch": "@@ -4,7 +4,6 @@\n const common = require('../common');\n const assert = require('assert');\n const {\n-  performance,\n   PerformanceObserver\n } = require('perf_hooks');\n \n@@ -22,13 +21,6 @@ const kinds = [\n   NODE_PERFORMANCE_GC_WEAKCB\n ];\n \n-// No observers for GC events, no entries should appear\n-{\n-  global.gc();\n-  const entries = performance.getEntriesByType('gc');\n-  assert.strictEqual(entries.length, 0);\n-}\n-\n // Adding an observer should force at least one gc to appear\n {\n   const obs = new PerformanceObserver(common.mustCallAtLeast((list) => {\n@@ -39,11 +31,6 @@ const kinds = [\n     assert(kinds.includes(entry.kind));\n     assert.strictEqual(typeof entry.startTime, 'number');\n     assert.strictEqual(typeof entry.duration, 'number');\n-\n-    performance.clearGC();\n-\n-    const entries = performance.getEntriesByType('gc');\n-    assert.strictEqual(entries.length, 0);\n     obs.disconnect();\n   }));\n   obs.observe({ entryTypes: ['gc'] });"
        },
        {
            "sha": "6a7d6f7b944cf63c091e6374dce2fa9fc072ceac",
            "filename": "test/parallel/test-performance-warning.js",
            "status": "removed",
            "additions": 0,
            "deletions": 29,
            "changes": 29,
            "blob_url": "https://github.com/nodejs/node/blob/d54f651910ffca2e50fad42dfec825d2339b1b6b/test%2Fparallel%2Ftest-performance-warning.js",
            "raw_url": "https://github.com/nodejs/node/raw/d54f651910ffca2e50fad42dfec825d2339b1b6b/test%2Fparallel%2Ftest-performance-warning.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-performance-warning.js?ref=d54f651910ffca2e50fad42dfec825d2339b1b6b",
            "patch": "@@ -1,29 +0,0 @@\n-// Flags: --no-warnings\n-'use strict';\n-\n-const common = require('../common');\n-const { performance } = require('perf_hooks');\n-const assert = require('assert');\n-\n-assert.strictEqual(performance.length, 1);\n-assert.strictEqual(performance.maxEntries, 150);\n-\n-performance.maxEntries = 1;\n-\n-[-1, 0xffffffff + 1, '', null, undefined, Infinity].forEach((i) => {\n-  common.expectsError(\n-    () => performance.maxEntries = i,\n-    {\n-      code: 'ERR_INVALID_ARG_TYPE',\n-      type: TypeError\n-    }\n-  );\n-});\n-\n-common.expectWarning('Warning', 'Possible perf_hooks memory leak detected. ' +\n-  'There are 2 entries in the ' +\n-  'Performance Timeline. Use the clear methods to remove entries that are no ' +\n-  'longer needed or set performance.maxEntries equal to a higher value ' +\n-  '(currently the maxEntries is 1).', common.noWarnCode);\n-\n-performance.mark('test');"
        },
        {
            "sha": "5d6029fc0d5055307924f804d7e9f513b4147599",
            "filename": "test/parallel/test-performanceobserver.js",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/2ec69955556bf92f49355659b6126e08fa2c3298/test%2Fparallel%2Ftest-performanceobserver.js",
            "raw_url": "https://github.com/nodejs/node/raw/2ec69955556bf92f49355659b6126e08fa2c3298/test%2Fparallel%2Ftest-performanceobserver.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-performanceobserver.js?ref=2ec69955556bf92f49355659b6126e08fa2c3298",
            "patch": "@@ -21,8 +21,8 @@ const {\n } = constants;\n \n assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_NODE], 0);\n-assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 1);\n-assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MEASURE], 1);\n+assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 0);\n+assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MEASURE], 0);\n assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_GC], 0);\n assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_FUNCTION], 0);\n \n@@ -67,7 +67,7 @@ assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_FUNCTION], 0);\n   const countdown =\n     new Countdown(3, () => {\n       observer.disconnect();\n-      assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 1);\n+      assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 0);\n     });\n \n   function callback(list, obs) {\n@@ -76,9 +76,9 @@ assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_FUNCTION], 0);\n     assert.strictEqual(entries.length, 1);\n     countdown.dec();\n   }\n-  assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 1);\n+  assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 0);\n   observer.observe({ entryTypes: ['mark'] });\n-  assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 2);\n+  assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 1);\n   performance.mark('test1');\n   performance.mark('test2');\n   performance.mark('test3');\n@@ -89,14 +89,14 @@ assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_FUNCTION], 0);\n {\n   const observer =\n     new PerformanceObserver(common.mustCall(callback, 1));\n-  assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 1);\n+  assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 0);\n \n   function callback(list, obs) {\n     assert.strictEqual(obs, observer);\n     const entries = list.getEntries();\n     assert.strictEqual(entries.length, 3);\n     observer.disconnect();\n-    assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 1);\n+    assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 0);\n \n     {\n       const entriesByName = list.getEntriesByName('test1');\n@@ -129,7 +129,7 @@ assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_FUNCTION], 0);\n   // Do this twice to make sure it doesn't throw\n   observer.observe({ entryTypes: ['mark', 'measure'], buffered: true });\n   // Even tho we called twice, count should be 1\n-  assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 2);\n+  assert.strictEqual(counts[NODE_PERFORMANCE_ENTRY_TYPE_MARK], 1);\n   performance.mark('test1');\n   performance.mark('test2');\n   performance.measure('test3', 'test1', 'test2');"
        },
        {
            "sha": "ea7e17e18dbe999f02678d81c3c81aa916cf2fc4",
            "filename": "test/sequential/test-performance.js",
            "status": "modified",
            "additions": 1,
            "deletions": 58,
            "changes": 59,
            "blob_url": "https://github.com/nodejs/node/blob/2ec69955556bf92f49355659b6126e08fa2c3298/test%2Fsequential%2Ftest-performance.js",
            "raw_url": "https://github.com/nodejs/node/raw/2ec69955556bf92f49355659b6126e08fa2c3298/test%2Fsequential%2Ftest-performance.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-performance.js?ref=2ec69955556bf92f49355659b6126e08fa2c3298",
            "patch": "@@ -15,56 +15,12 @@ const inited = performance.now();\n assert(inited < 20000);\n \n {\n-  const entries = performance.getEntries();\n-  assert(Array.isArray(entries));\n-  assert.strictEqual(entries.length, 1);\n-  assert.strictEqual(entries[0], performance.nodeTiming);\n-}\n-\n-{\n-  const entries = performance.getEntriesByName('node');\n-  assert(Array.isArray(entries));\n-  assert.strictEqual(entries.length, 1);\n-  assert.strictEqual(entries[0], performance.nodeTiming);\n-}\n-\n-{\n-  let n;\n-  let entries = performance.getEntries();\n-  for (n = 0; n < entries.length; n++) {\n-    const entry = entries[n];\n-    assert.notStrictEqual(entry.name, 'A');\n-    assert.notStrictEqual(entry.entryType, 'mark');\n-  }\n+  // Should work without throwing any errors\n   performance.mark('A');\n-  entries = performance.getEntries();\n-  const markA = entries[1];\n-  assert.strictEqual(markA.name, 'A');\n-  assert.strictEqual(markA.entryType, 'mark');\n   performance.clearMarks('A');\n-  entries = performance.getEntries();\n-  for (n = 0; n < entries.length; n++) {\n-    const entry = entries[n];\n-    assert.notStrictEqual(entry.name, 'A');\n-    assert.notStrictEqual(entry.entryType, 'mark');\n-  }\n-}\n \n-{\n-  let entries = performance.getEntries();\n-  for (let n = 0; n < entries.length; n++) {\n-    const entry = entries[n];\n-    assert.notStrictEqual(entry.name, 'B');\n-    assert.notStrictEqual(entry.entryType, 'mark');\n-  }\n   performance.mark('B');\n-  entries = performance.getEntries();\n-  const markB = entries[1];\n-  assert.strictEqual(markB.name, 'B');\n-  assert.strictEqual(markB.entryType, 'mark');\n   performance.clearMarks();\n-  entries = performance.getEntries();\n-  assert.strictEqual(entries.length, 1);\n }\n \n {\n@@ -83,27 +39,14 @@ assert(inited < 20000);\n       });\n   });\n \n-  performance.clearMeasures();\n   performance.clearMarks();\n-\n-  const entries = performance.getEntries();\n-  assert.strictEqual(entries.length, 1);\n }\n \n {\n   performance.mark('A');\n   setImmediate(() => {\n     performance.mark('B');\n     performance.measure('foo', 'A', 'B');\n-    const entry = performance.getEntriesByName('foo')[0];\n-    const markA = performance.getEntriesByName('A', 'mark')[0];\n-    performance.getEntriesByName('B', 'mark')[0];\n-    assert.strictEqual(entry.name, 'foo');\n-    assert.strictEqual(entry.entryType, 'measure');\n-    assert.strictEqual(entry.startTime, markA.startTime);\n-    // TODO(jasnell): This comparison is too imprecise on some systems\n-    // assert.strictEqual(entry.duration.toPrecision(3),\n-    //                   (markB.startTime - markA.startTime).toPrecision(3));\n   });\n }\n "
        }
    ],
    "stats": {
        "total": 358,
        "additions": 38,
        "deletions": 320
    }
}