{
    "author": "joyeecheung",
    "message": "http: remove pushValueToArray in Parser::CreateHeaders()\n\nInstead of calling into JS from C++ to push values into an array,\nuse the new Array::New API that takes a pointer and a length\ndirectly.\n\nPR-URL: https://github.com/nodejs/node/pull/24264\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "83c6067ac6f20aa81f00fa020fe528ca27980b7d",
    "files": [
        {
            "sha": "f752a003a25d6da8e5685f126c0b763f4ec00766",
            "filename": "src/node_http_parser.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 23,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/83c6067ac6f20aa81f00fa020fe528ca27980b7d/src%2Fnode_http_parser.cc",
            "raw_url": "https://github.com/nodejs/node/raw/83c6067ac6f20aa81f00fa020fe528ca27980b7d/src%2Fnode_http_parser.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser.cc?ref=83c6067ac6f20aa81f00fa020fe528ca27980b7d",
            "patch": "@@ -73,7 +73,8 @@ const uint32_t kOnHeadersComplete = 1;\n const uint32_t kOnBody = 2;\n const uint32_t kOnMessageComplete = 3;\n const uint32_t kOnExecute = 4;\n-\n+// Any more fields than this will be flushed into JS\n+const size_t kMaxHeaderFieldsCount = 32;\n \n // helper class for the Parser\n struct StringPtr {\n@@ -203,7 +204,7 @@ class Parser : public AsyncWrap, public StreamListener {\n     if (num_fields_ == num_values_) {\n       // start of new field name\n       num_fields_++;\n-      if (num_fields_ == arraysize(fields_)) {\n+      if (num_fields_ == kMaxHeaderFieldsCount) {\n         // ran out of space - flush to javascript land\n         Flush();\n         num_fields_ = 1;\n@@ -212,7 +213,7 @@ class Parser : public AsyncWrap, public StreamListener {\n       fields_[num_fields_ - 1].Reset();\n     }\n \n-    CHECK_LT(num_fields_, arraysize(fields_));\n+    CHECK_LT(num_fields_, kMaxHeaderFieldsCount);\n     CHECK_EQ(num_fields_, num_values_ + 1);\n \n     fields_[num_fields_ - 1].Update(at, length);\n@@ -731,25 +732,15 @@ class Parser : public AsyncWrap, public StreamListener {\n   }\n \n   Local<Array> CreateHeaders() {\n-    Local<Array> headers = Array::New(env()->isolate());\n-    Local<Function> fn = env()->push_values_to_array_function();\n-    Local<Value> argv[NODE_PUSH_VAL_TO_ARRAY_MAX * 2];\n-    size_t i = 0;\n-\n-    do {\n-      size_t j = 0;\n-      while (i < num_values_ && j < arraysize(argv) / 2) {\n-        argv[j * 2] = fields_[i].ToString(env());\n-        argv[j * 2 + 1] = values_[i].ToString(env());\n-        i++;\n-        j++;\n-      }\n-      if (j > 0) {\n-        fn->Call(env()->context(), headers, j * 2, argv).ToLocalChecked();\n-      }\n-    } while (i < num_values_);\n+    // There could be extra entries but the max size should be fixed\n+    Local<Value> headers_v[kMaxHeaderFieldsCount * 2];\n+\n+    for (size_t i = 0; i < num_values_; ++i) {\n+      headers_v[i * 2] = fields_[i].ToString(env());\n+      headers_v[i * 2 + 1] = values_[i].ToString(env());\n+    }\n \n-    return headers;\n+    return Array::New(env()->isolate(), headers_v, num_values_ * 2);\n   }\n \n \n@@ -824,8 +815,8 @@ class Parser : public AsyncWrap, public StreamListener {\n   }\n \n   parser_t parser_;\n-  StringPtr fields_[32];  // header fields\n-  StringPtr values_[32];  // header values\n+  StringPtr fields_[kMaxHeaderFieldsCount];  // header fields\n+  StringPtr values_[kMaxHeaderFieldsCount];  // header values\n   StringPtr url_;\n   StringPtr status_message_;\n   size_t num_fields_;"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 14,
        "deletions": 23
    }
}