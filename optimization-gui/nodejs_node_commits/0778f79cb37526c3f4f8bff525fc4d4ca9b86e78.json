{
    "author": "mafintosh",
    "message": "stream: do not emit readable if the stream ended\n\nFixes a regression introduced by the once-per-microtick 'readable'\nevent emission.\n\nSee: https://github.com/nodejs/node/pull/17979\nPR-URL: https://github.com/nodejs/node/pull/18372\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "0778f79cb37526c3f4f8bff525fc4d4ca9b86e78",
    "files": [
        {
            "sha": "364f2ba7444bb4596ab0efc7077aba12a6685ead",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/0778f79cb37526c3f4f8bff525fc4d4ca9b86e78/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/0778f79cb37526c3f4f8bff525fc4d4ca9b86e78/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=0778f79cb37526c3f4f8bff525fc4d4ca9b86e78",
            "patch": "@@ -520,7 +520,9 @@ function emitReadable(stream) {\n function emitReadable_(stream) {\n   var state = stream._readableState;\n   debug('emit readable');\n-  stream.emit('readable');\n+  if (!state.destroyed && (state.length || state.ended)) {\n+    stream.emit('readable');\n+  }\n   state.needReadable = !state.flowing && !state.ended;\n   flow(stream);\n }"
        },
        {
            "sha": "bd3e06e5f7d55cb6835a3a6bf71b389edc006bba",
            "filename": "test/parallel/test-stream-readable-no-unneeded-readable.js",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/nodejs/node/blob/0778f79cb37526c3f4f8bff525fc4d4ca9b86e78/test%2Fparallel%2Ftest-stream-readable-no-unneeded-readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/0778f79cb37526c3f4f8bff525fc4d4ca9b86e78/test%2Fparallel%2Ftest-stream-readable-no-unneeded-readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-readable-no-unneeded-readable.js?ref=0778f79cb37526c3f4f8bff525fc4d4ca9b86e78",
            "patch": "@@ -0,0 +1,39 @@\n+'use strict';\n+const common = require('../common');\n+const { Readable, PassThrough } = require('stream');\n+\n+const source = new Readable({\n+  read: () => {}\n+});\n+\n+source.push('foo');\n+source.push('bar');\n+source.push(null);\n+\n+const pt = source.pipe(new PassThrough());\n+\n+const wrapper = new Readable({\n+  read: () => {\n+    let data = pt.read();\n+\n+    if (data) {\n+      wrapper.push(data);\n+      return;\n+    }\n+\n+    pt.once('readable', function() {\n+      data = pt.read();\n+      if (data) {\n+        wrapper.push(data);\n+      }\n+      // else the end event should fire\n+    });\n+  }\n+});\n+\n+pt.once('end', function() {\n+  wrapper.push(null);\n+});\n+\n+wrapper.resume();\n+wrapper.once('end', common.mustCall());"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 42,
        "deletions": 1
    }
}