{
    "author": "kenny-y",
    "message": "n-api: improve runtime perf of n-api func call\n\nAdded a new struct CallbackBundle to eliminate all\nGetInternalField() calls.\n\nThe principle is to store all required data inside a C++ struct,\nand then store the pointer in the JavaScript object. Before this\nchange, the required data are stored in the JavaScript object in\n3 or 4 seperate pointers. For every napi fun call, 3 of them\nhave to be fetched out, which are 3 GetInternalField() calls;\nafter this change, the C++ struct will be directly fetched out\nby using v8::External::Value(), which is faster.\n\nProfiling data show that GetInternalField() is slow.\nOn an i7-4770K (3.50GHz) box, a C++ V8-binding fun call is 8 ns,\nbefore this change, napi fun call is 36 ns; after this change,\nnapi fun call is 20 ns.\n\nThe above data are measured using a modified benchmark in\n'benchmark/misc/function_call'. The modification adds an indicator\nof the average time of a \"chatty\" napi fun call (max 50M runs).\nThis change will speed up chatty case 1.8x (overall), and will cut\ndown the delay of napi mechanism to approx. 0.5x.\n\nBackground: a simple C++ binding function (e.g. receiving little\nfrom JS, doing little and returning little to JS) is called\n'chatty' case for JS<-->C++ fun call routine.\n\nThis improvement also applies to getter/setter fun calls.\n\nPR-URL: https://github.com/nodejs/node/pull/21072\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Gabriel Schulhof <gabriel.schulhof@intel.com>",
    "sha": "e41ccd4e2de6deb03e277fa9d6baff685ab31689",
    "files": [
        {
            "sha": "f9b35e714bb641836558bbf9f3fdb3365472e66c",
            "filename": "Makefile",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/e41ccd4e2de6deb03e277fa9d6baff685ab31689/Makefile",
            "raw_url": "https://github.com/nodejs/node/raw/e41ccd4e2de6deb03e277fa9d6baff685ab31689/Makefile",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/Makefile?ref=e41ccd4e2de6deb03e277fa9d6baff685ab31689",
            "patch": "@@ -276,6 +276,7 @@ test-check-deopts: all\n \t$(PYTHON) tools/test.py $(PARALLEL_ARGS) --mode=$(BUILDTYPE_LOWER) --check-deopts parallel sequential\n \n benchmark/misc/function_call/build/Release/binding.node: all \\\n+\t\tbenchmark/misc/function_call/napi_binding.c \\\n \t\tbenchmark/misc/function_call/binding.cc \\\n \t\tbenchmark/misc/function_call/binding.gyp\n \t$(NODE) deps/npm/node_modules/node-gyp/bin/node-gyp rebuild \\"
        },
        {
            "sha": "ac122ed1a07962a116f6c41ce5f13184802632f7",
            "filename": "benchmark/misc/function_call/binding.gyp",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/e41ccd4e2de6deb03e277fa9d6baff685ab31689/benchmark%2Fmisc%2Ffunction_call%2Fbinding.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/e41ccd4e2de6deb03e277fa9d6baff685ab31689/benchmark%2Fmisc%2Ffunction_call%2Fbinding.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fmisc%2Ffunction_call%2Fbinding.gyp?ref=e41ccd4e2de6deb03e277fa9d6baff685ab31689",
            "patch": "@@ -1,5 +1,9 @@\n {\n   'targets': [\n+    {\n+      'target_name': 'napi_binding',\n+      'sources': [ 'napi_binding.c' ]\n+    },\n     {\n       'target_name': 'binding',\n       'sources': [ 'binding.cc' ]"
        },
        {
            "sha": "cbc512c9729137b3734b543ed69c803f976db582",
            "filename": "benchmark/misc/function_call/index.js",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/e41ccd4e2de6deb03e277fa9d6baff685ab31689/benchmark%2Fmisc%2Ffunction_call%2Findex.js",
            "raw_url": "https://github.com/nodejs/node/raw/e41ccd4e2de6deb03e277fa9d6baff685ab31689/benchmark%2Fmisc%2Ffunction_call%2Findex.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fmisc%2Ffunction_call%2Findex.js?ref=e41ccd4e2de6deb03e277fa9d6baff685ab31689",
            "patch": "@@ -19,6 +19,15 @@ try {\n }\n const cxx = binding.hello;\n \n+let napi_binding;\n+try {\n+  napi_binding = require('./build/Release/napi_binding');\n+} catch (er) {\n+  console.error('misc/function_call/index.js NAPI-Binding failed to load');\n+  process.exit(0);\n+}\n+const napi = napi_binding.hello;\n+\n var c = 0;\n function js() {\n   return c++;\n@@ -27,12 +36,12 @@ function js() {\n assert(js() === cxx());\n \n const bench = common.createBenchmark(main, {\n-  type: ['js', 'cxx'],\n+  type: ['js', 'cxx', 'napi'],\n   n: [1e6, 1e7, 5e7]\n });\n \n function main({ n, type }) {\n-  const fn = type === 'cxx' ? cxx : js;\n+  const fn = type === 'cxx' ? cxx : type === 'napi' ? napi : js;\n   bench.start();\n   for (var i = 0; i < n; i++) {\n     fn();"
        },
        {
            "sha": "d97170e0fcd9c5c0948a74bbe5f8df5cba336df2",
            "filename": "benchmark/misc/function_call/napi_binding.c",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/e41ccd4e2de6deb03e277fa9d6baff685ab31689/benchmark%2Fmisc%2Ffunction_call%2Fnapi_binding.c",
            "raw_url": "https://github.com/nodejs/node/raw/e41ccd4e2de6deb03e277fa9d6baff685ab31689/benchmark%2Fmisc%2Ffunction_call%2Fnapi_binding.c",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/benchmark%2Fmisc%2Ffunction_call%2Fnapi_binding.c?ref=e41ccd4e2de6deb03e277fa9d6baff685ab31689",
            "patch": "@@ -0,0 +1,26 @@\n+#include <assert.h>\n+#include <node_api.h>\n+\n+static int32_t increment = 0;\n+\n+static napi_value Hello(napi_env env, napi_callback_info info) {\n+  napi_value result;\n+  napi_status status = napi_create_int32(env, increment++, &result);\n+  assert(status == napi_ok);\n+  return result;\n+}\n+\n+NAPI_MODULE_INIT() {\n+  napi_value hello;\n+  napi_status status =\n+      napi_create_function(env,\n+                           \"hello\",\n+                           NAPI_AUTO_LENGTH,\n+                           Hello,\n+                           NULL,\n+                           &hello);\n+  assert(status == napi_ok);\n+  status = napi_set_named_property(env, exports, \"hello\", hello);\n+  assert(status == napi_ok);\n+  return exports;\n+}"
        },
        {
            "sha": "149cb8731d44f76aff24cb685b8fe33d2def7c8a",
            "filename": "src/node_api.cc",
            "status": "modified",
            "additions": 72,
            "deletions": 87,
            "changes": 159,
            "blob_url": "https://github.com/nodejs/node/blob/e41ccd4e2de6deb03e277fa9d6baff685ab31689/src%2Fnode_api.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e41ccd4e2de6deb03e277fa9d6baff685ab31689/src%2Fnode_api.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_api.cc?ref=e41ccd4e2de6deb03e277fa9d6baff685ab31689",
            "patch": "@@ -23,8 +23,6 @@ struct napi_env__ {\n         loop(_loop) {}\n   v8::Isolate* isolate;\n   node::Persistent<v8::Value> last_exception;\n-  node::Persistent<v8::ObjectTemplate> function_data_template;\n-  node::Persistent<v8::ObjectTemplate> accessor_data_template;\n   napi_extended_error_info last_error;\n   int open_handle_scopes = 0;\n   int open_callback_scopes = 0;\n@@ -34,19 +32,6 @@ struct napi_env__ {\n #define NAPI_PRIVATE_KEY(context, suffix) \\\n   (node::Environment::GetCurrent((context))->napi_ ## suffix())\n \n-#define ENV_OBJECT_TEMPLATE(env, prefix, destination, field_count) \\\n-  do {                                                             \\\n-    if ((env)->prefix ## _template.IsEmpty()) {                    \\\n-      (destination) = v8::ObjectTemplate::New(isolate);            \\\n-      (destination)->SetInternalFieldCount((field_count));         \\\n-      (env)->prefix ## _template.Reset(isolate, (destination));    \\\n-    } else {                                                       \\\n-      (destination) = v8::Local<v8::ObjectTemplate>::New(          \\\n-          isolate, env->prefix ## _template);                      \\\n-    }                                                              \\\n-  } while (0)\n-\n-\n #define RETURN_STATUS_IF_FALSE(env, condition, status)                  \\\n   do {                                                                  \\\n     if (!(condition)) {                                                 \\\n@@ -491,15 +476,45 @@ class TryCatch : public v8::TryCatch {\n \n //=== Function napi_callback wrapper =================================\n \n-static const int kDataIndex = 0;\n-static const int kEnvIndex = 1;\n+// TODO(somebody): these constants can be removed with relevant changes\n+// in CallbackWrapperBase<> and CallbackBundle.\n+// Leave them for now just to keep the change set and cognitive load minimal.\n+static const int kFunctionIndex = 0;  // Used in CallbackBundle::cb[]\n+static const int kGetterIndex = 0;    // Used in CallbackBundle::cb[]\n+static const int kSetterIndex = 1;    // Used in CallbackBundle::cb[]\n+static const int kCallbackCount = 2;  // Used in CallbackBundle::cb[]\n+                                      // Max is \"getter + setter\" case\n+\n+// Use this data structure to associate callback data with each N-API function\n+// exposed to JavaScript. The structure is stored in a v8::External which gets\n+// passed into our callback wrapper. This reduces the performance impact of\n+// calling through N-API.\n+// Ref: benchmark/misc/function_call\n+// Discussion (incl. perf. data): https://github.com/nodejs/node/pull/21072\n+struct CallbackBundle {\n+  // Bind the lifecycle of `this` C++ object to a JavaScript object.\n+  // We never delete a CallbackBundle C++ object directly.\n+  void BindLifecycleTo(v8::Isolate* isolate, v8::Local<v8::Value> target) {\n+    handle.Reset(isolate, target);\n+    handle.SetWeak(this, WeakCallback, v8::WeakCallbackType::kParameter);\n+  }\n+\n+  napi_env       env;      // Necessary to invoke C++ NAPI callback\n+  void*          cb_data;  // The user provided callback data\n+  napi_callback  cb[kCallbackCount];   // Max capacity is 2 (getter + setter)\n+  node::Persistent<v8::Value> handle;  // Die with this JavaScript object\n \n-static const int kFunctionIndex = 2;\n-static const int kFunctionFieldCount = 3;\n-\n-static const int kGetterIndex = 2;\n-static const int kSetterIndex = 3;\n-static const int kAccessorFieldCount = 4;\n+ private:\n+  static void WeakCallback(v8::WeakCallbackInfo<CallbackBundle> const& info) {\n+    // Use the \"WeakCallback mechanism\" to delete the C++ `bundle` object.\n+    // This will be called when the v8::External containing `this` pointer\n+    // is being GC-ed.\n+    CallbackBundle* bundle = info.GetParameter();\n+    if (bundle != nullptr) {\n+      delete bundle;\n+    }\n+  }\n+};\n \n // Base class extended by classes that wrap V8 function and property callback\n // info.\n@@ -531,10 +546,10 @@ class CallbackWrapperBase : public CallbackWrapper {\n       : CallbackWrapper(JsValueFromV8LocalValue(cbinfo.This()),\n                         args_length,\n                         nullptr),\n-        _cbinfo(cbinfo),\n-        _cbdata(v8::Local<v8::Object>::Cast(cbinfo.Data())) {\n-    _data = v8::Local<v8::External>::Cast(_cbdata->GetInternalField(kDataIndex))\n-                ->Value();\n+        _cbinfo(cbinfo) {\n+    _bundle = reinterpret_cast<CallbackBundle*>(\n+        v8::Local<v8::External>::Cast(cbinfo.Data())->Value());\n+    _data = _bundle->cb_data;\n   }\n \n   napi_value GetNewTarget() override { return nullptr; }\n@@ -543,13 +558,10 @@ class CallbackWrapperBase : public CallbackWrapper {\n   void InvokeCallback() {\n     napi_callback_info cbinfo_wrapper = reinterpret_cast<napi_callback_info>(\n         static_cast<CallbackWrapper*>(this));\n-    napi_callback cb = reinterpret_cast<napi_callback>(\n-        v8::Local<v8::External>::Cast(\n-            _cbdata->GetInternalField(kInternalFieldIndex))->Value());\n \n-    napi_env env = static_cast<napi_env>(\n-        v8::Local<v8::External>::Cast(\n-            _cbdata->GetInternalField(kEnvIndex))->Value());\n+    // All other pointers we need are stored in `_bundle`\n+    napi_env env = _bundle->env;\n+    napi_callback cb = _bundle->cb[kInternalFieldIndex];\n \n     napi_value result;\n     NAPI_CALL_INTO_MODULE_THROW(env, result = cb(env, cbinfo_wrapper));\n@@ -560,7 +572,7 @@ class CallbackWrapperBase : public CallbackWrapper {\n   }\n \n   const Info& _cbinfo;\n-  const v8::Local<v8::Object> _cbdata;\n+  CallbackBundle* _bundle;\n };\n \n class FunctionCallbackWrapper\n@@ -682,62 +694,35 @@ class SetterCallbackWrapper\n // Creates an object to be made available to the static function callback\n // wrapper, used to retrieve the native callback function and data pointer.\n static\n-v8::Local<v8::Object> CreateFunctionCallbackData(napi_env env,\n-                                                 napi_callback cb,\n-                                                 void* data) {\n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n+v8::Local<v8::Value> CreateFunctionCallbackData(napi_env env,\n+                                                napi_callback cb,\n+                                                void* data) {\n+  CallbackBundle* bundle = new CallbackBundle();\n+  bundle->cb[kFunctionIndex] = cb;\n+  bundle->cb_data = data;\n+  bundle->env = env;\n+  v8::Local<v8::Value> cbdata = v8::External::New(env->isolate, bundle);\n+  bundle->BindLifecycleTo(env->isolate, cbdata);\n \n-  v8::Local<v8::ObjectTemplate> otpl;\n-  ENV_OBJECT_TEMPLATE(env, function_data, otpl, v8impl::kFunctionFieldCount);\n-  v8::Local<v8::Object> cbdata = otpl->NewInstance(context).ToLocalChecked();\n-\n-  cbdata->SetInternalField(\n-      v8impl::kEnvIndex,\n-      v8::External::New(isolate, static_cast<void*>(env)));\n-  cbdata->SetInternalField(\n-      v8impl::kFunctionIndex,\n-      v8::External::New(isolate, reinterpret_cast<void*>(cb)));\n-  cbdata->SetInternalField(\n-      v8impl::kDataIndex,\n-      v8::External::New(isolate, data));\n   return cbdata;\n }\n \n // Creates an object to be made available to the static getter/setter\n // callback wrapper, used to retrieve the native getter/setter callback\n // function and data pointer.\n static\n-v8::Local<v8::Object> CreateAccessorCallbackData(napi_env env,\n-                                                 napi_callback getter,\n-                                                 napi_callback setter,\n-                                                 void* data) {\n-  v8::Isolate* isolate = env->isolate;\n-  v8::Local<v8::Context> context = isolate->GetCurrentContext();\n-\n-  v8::Local<v8::ObjectTemplate> otpl;\n-  ENV_OBJECT_TEMPLATE(env, accessor_data, otpl, v8impl::kAccessorFieldCount);\n-  v8::Local<v8::Object> cbdata = otpl->NewInstance(context).ToLocalChecked();\n-\n-  cbdata->SetInternalField(\n-      v8impl::kEnvIndex,\n-      v8::External::New(isolate, static_cast<void*>(env)));\n-\n-  if (getter != nullptr) {\n-    cbdata->SetInternalField(\n-        v8impl::kGetterIndex,\n-        v8::External::New(isolate, reinterpret_cast<void*>(getter)));\n-  }\n-\n-  if (setter != nullptr) {\n-    cbdata->SetInternalField(\n-        v8impl::kSetterIndex,\n-        v8::External::New(isolate, reinterpret_cast<void*>(setter)));\n-  }\n+v8::Local<v8::Value> CreateAccessorCallbackData(napi_env env,\n+                                                napi_callback getter,\n+                                                napi_callback setter,\n+                                                void* data) {\n+  CallbackBundle* bundle = new CallbackBundle();\n+  bundle->cb[kGetterIndex] = getter;\n+  bundle->cb[kSetterIndex] = setter;\n+  bundle->cb_data = data;\n+  bundle->env = env;\n+  v8::Local<v8::Value> cbdata = v8::External::New(env->isolate, bundle);\n+  bundle->BindLifecycleTo(env->isolate, cbdata);\n \n-  cbdata->SetInternalField(\n-      v8impl::kDataIndex,\n-      v8::External::New(isolate, data));\n   return cbdata;\n }\n \n@@ -1038,7 +1023,7 @@ napi_status napi_create_function(napi_env env,\n   v8::Isolate* isolate = env->isolate;\n   v8::Local<v8::Function> return_value;\n   v8::EscapableHandleScope scope(isolate);\n-  v8::Local<v8::Object> cbdata =\n+  v8::Local<v8::Value> cbdata =\n       v8impl::CreateFunctionCallbackData(env, cb, callback_data);\n \n   RETURN_STATUS_IF_FALSE(env, !cbdata.IsEmpty(), napi_generic_failure);\n@@ -1078,7 +1063,7 @@ napi_status napi_define_class(napi_env env,\n   v8::Isolate* isolate = env->isolate;\n \n   v8::EscapableHandleScope scope(isolate);\n-  v8::Local<v8::Object> cbdata =\n+  v8::Local<v8::Value> cbdata =\n       v8impl::CreateFunctionCallbackData(env, constructor, callback_data);\n \n   RETURN_STATUS_IF_FALSE(env, !cbdata.IsEmpty(), napi_generic_failure);\n@@ -1114,7 +1099,7 @@ napi_status napi_define_class(napi_env env,\n     // This code is similar to that in napi_define_properties(); the\n     // difference is it applies to a template instead of an object.\n     if (p->getter != nullptr || p->setter != nullptr) {\n-      v8::Local<v8::Object> cbdata = v8impl::CreateAccessorCallbackData(\n+      v8::Local<v8::Value> cbdata = v8impl::CreateAccessorCallbackData(\n         env, p->getter, p->setter, p->data);\n \n       tpl->PrototypeTemplate()->SetAccessor(\n@@ -1125,7 +1110,7 @@ napi_status napi_define_class(napi_env env,\n         v8::AccessControl::DEFAULT,\n         attributes);\n     } else if (p->method != nullptr) {\n-      v8::Local<v8::Object> cbdata =\n+      v8::Local<v8::Value> cbdata =\n           v8impl::CreateFunctionCallbackData(env, p->method, p->data);\n \n       RETURN_STATUS_IF_FALSE(env, !cbdata.IsEmpty(), napi_generic_failure);\n@@ -1487,7 +1472,7 @@ napi_status napi_define_properties(napi_env env,\n         v8impl::V8PropertyAttributesFromDescriptor(p);\n \n     if (p->getter != nullptr || p->setter != nullptr) {\n-      v8::Local<v8::Object> cbdata = v8impl::CreateAccessorCallbackData(\n+      v8::Local<v8::Value> cbdata = v8impl::CreateAccessorCallbackData(\n         env,\n         p->getter,\n         p->setter,\n@@ -1506,7 +1491,7 @@ napi_status napi_define_properties(napi_env env,\n         return napi_set_last_error(env, napi_invalid_arg);\n       }\n     } else if (p->method != nullptr) {\n-      v8::Local<v8::Object> cbdata =\n+      v8::Local<v8::Value> cbdata =\n           v8impl::CreateFunctionCallbackData(env, p->method, p->data);\n \n       RETURN_STATUS_IF_FALSE(env, !cbdata.IsEmpty(), napi_generic_failure);"
        }
    ],
    "stats": {
        "total": 203,
        "additions": 114,
        "deletions": 89
    }
}