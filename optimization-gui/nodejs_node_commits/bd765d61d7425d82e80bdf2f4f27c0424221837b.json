{
    "author": "joyeecheung",
    "message": "src: compile native modules and their code cache in C++\n\nThis patch refactors out a part of NativeModule.prototype.compile\n(in JS land) into a C++ NativeModule class, this enables a\ncouple of possibilities:\n\n1. By moving the code to the C++ land, we have more opportunity\n  to specialize the compilation process of the native modules\n  (e.g. compilation options, code cache) that is orthogonal to\n  how user land modules are compiled\n2. We can reuse the code to compile bootstrappers and context\n  fixers and enable them to be compiled with the code cache later,\n  since they are not loaded by NativeModule in the JS land their\n  caching must be done in C++.\n3. Since there is no need to pass the static data to JS for\n  compilation anymore, this enables us to use\n  (std::map<std::string, const char*>) in the generated\n  node_code_cache.cc and node_javascript.cc later, and scope\n  every actual access to the source of native modules to a\n  std::map lookup instead of a lookup on a v8::Object in\n  dictionary mode.\n\nThis patch also refactor the code cache generator and tests\na bit and trace the `withCodeCache` and `withoutCodeCache`\nin a Set instead of an Array, and makes sure that all the cachable\nbuiltins are tested.\n\nPR-URL: https://github.com/nodejs/node/pull/24221\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "bd765d61d7425d82e80bdf2f4f27c0424221837b",
    "files": [
        {
            "sha": "ff6c4422c1148c76ae5659fe0a967e53d055cdd8",
            "filename": "lib/internal/bootstrap/cache.js",
            "status": "modified",
            "additions": 8,
            "deletions": 22,
            "changes": 30,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/lib%2Finternal%2Fbootstrap%2Fcache.js",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/lib%2Finternal%2Fbootstrap%2Fcache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Fcache.js?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -8,20 +8,13 @@\n const {\n   NativeModule\n } = require('internal/bootstrap/loaders');\n+const {\n+  source,\n+  compileCodeCache\n+} = internalBinding('native_module');\n const { hasTracing } = process.binding('config');\n \n-function getCodeCache(id) {\n-  const cached = NativeModule.getCached(id);\n-  if (cached && (cached.loaded || cached.loading)) {\n-    return cached.script.createCachedData();\n-  }\n-\n-  // The script has not been compiled and run\n-  NativeModule.require(id);\n-  return getCodeCache(id);\n-}\n-\n-const depsModule = Object.keys(NativeModule._source).filter(\n+const depsModule = Object.keys(source).filter(\n   (key) => NativeModule.isDepsModule(key) || key.startsWith('internal/deps')\n );\n \n@@ -75,17 +68,10 @@ if (!process.versions.openssl) {\n }\n \n module.exports = {\n-  cachableBuiltins: Object.keys(NativeModule._source).filter(\n+  cachableBuiltins: Object.keys(source).filter(\n     (key) => !cannotUseCache.includes(key)\n   ),\n-  builtinSource: Object.assign({}, NativeModule._source),\n-  getCodeCache,\n-  getSource: NativeModule.getSource,\n-  codeCache: internalBinding('code_cache'),\n-  compiledWithoutCache: NativeModule.compiledWithoutCache,\n-  compiledWithCache: NativeModule.compiledWithCache,\n-  nativeModuleWrap(script) {\n-    return NativeModule.wrap(script);\n-  },\n+  getSource(id) { return source[id]; },\n+  getCodeCache: compileCodeCache,\n   cannotUseCache\n };"
        },
        {
            "sha": "78e1180dde2af2033ff484c8354471e9398d87a9",
            "filename": "lib/internal/bootstrap/loaders.js",
            "status": "modified",
            "additions": 3,
            "deletions": 60,
            "changes": 63,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/lib%2Finternal%2Fbootstrap%2Floaders.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fbootstrap%2Floaders.js?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -149,7 +149,6 @@\n \n   // Create this WeakMap in js-land because V8 has no C++ API for WeakMap\n   internalBinding('module_wrap').callbackMap = new WeakMap();\n-  const { ContextifyScript } = internalBinding('contextify');\n \n   // Set up NativeModule\n   function NativeModule(id) {\n@@ -160,20 +159,13 @@\n     this.exportKeys = undefined;\n     this.loaded = false;\n     this.loading = false;\n-    this.script = null;  // The ContextifyScript of the module\n   }\n \n   NativeModule._source = getInternalBinding('natives');\n   NativeModule._cache = {};\n \n   const config = getBinding('config');\n \n-  const codeCache = getInternalBinding('code_cache');\n-  const codeCacheHash = getInternalBinding('code_cache_hash');\n-  const sourceHash = getInternalBinding('natives_hash');\n-  const compiledWithoutCache = NativeModule.compiledWithoutCache = [];\n-  const compiledWithCache = NativeModule.compiledWithCache = [];\n-\n   // Think of this as module.exports in this file even though it is not\n   // written in CommonJS style.\n   const loaderExports = { internalBinding, NativeModule };\n@@ -332,67 +324,18 @@\n     this.exports = new Proxy(this.exports, handler);\n   };\n \n+  const { compileFunction } = getInternalBinding('native_module');\n   NativeModule.prototype.compile = function() {\n     const id = this.id;\n-    let source = NativeModule.getSource(id);\n-    source = NativeModule.wrap(source);\n \n     this.loading = true;\n \n     try {\n-      // Currently V8 only checks that the length of the source code is the\n-      // same as the code used to generate the hash, so we add an additional\n-      // check here:\n-      // 1. During compile time, when generating node_javascript.cc and\n-      //    node_code_cache.cc, we compute and include the hash of the\n-      //   (unwrapped) JavaScript source in both.\n-      // 2. At runtime, we check that the hash of the code being compiled\n-      //   and the hash of the code used to generate the cache\n-      //   (inside the wrapper) is the same.\n-      // This is based on the assumptions:\n-      // 1. `internalBinding('code_cache_hash')` must be in sync with\n-      //    `internalBinding('code_cache')` (same C++ file)\n-      // 2. `internalBinding('natives_hash')` must be in sync with\n-      //    `internalBinding('natives')` (same C++ file)\n-      // 3. If `internalBinding('natives_hash')` is in sync with\n-      //    `internalBinding('natives_hash')`, then the (unwrapped)\n-      //    code used to generate `internalBinding('code_cache')`\n-      //    should be in sync with the (unwrapped) code in\n-      //    `internalBinding('natives')`\n-      // There will be, however, false positives if the wrapper used\n-      // to generate the cache is different from the one used at run time,\n-      // and the length of the wrapper somehow stays the same.\n-      // But that should be rare and can be eased once we make the\n-      // two bootstrappers cached and checked as well.\n-      const cache = codeCacheHash[id] &&\n-        (codeCacheHash[id] === sourceHash[id]) ? codeCache[id] : undefined;\n-\n-      // (code, filename, lineOffset, columnOffset\n-      // cachedData, produceCachedData, parsingContext)\n-      const script = new ContextifyScript(\n-        source, this.filename, 0, 0,\n-        cache, false, undefined\n-      );\n-\n-      // This will be used to create code cache in tools/generate_code_cache.js\n-      this.script = script;\n-\n-      // One of these conditions may be false when any of the inputs\n-      // of the `node_js2c` target in node.gyp is modified.\n-      // FIXME(joyeecheung): Figure out how to resolve the dependency issue.\n-      // When the code cache was introduced we were at a point where refactoring\n-      // node.gyp may not be worth the effort.\n-      if (!cache || script.cachedDataRejected) {\n-        compiledWithoutCache.push(this.id);\n-      } else {\n-        compiledWithCache.push(this.id);\n-      }\n-\n-      // Arguments: timeout, displayErrors, breakOnSigint\n-      const fn = script.runInThisContext(-1, true, false);\n       const requireFn = this.id.startsWith('internal/deps/') ?\n         NativeModule.requireForDeps :\n         NativeModule.require;\n+\n+      const fn = compileFunction(id);\n       fn(this.exports, requireFn, this, process, internalBinding);\n \n       if (config.experimentalModules && !NativeModule.isInternal(this.id)) {"
        },
        {
            "sha": "5b68281de457901107f5067f1b60c309f627b1a6",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -416,6 +416,8 @@\n         'src/node_javascript.h',\n         'src/node_messaging.h',\n         'src/node_mutex.h',\n+        'src/node_native_module.h',\n+        'src/node_native_module.cc',\n         'src/node_options.h',\n         'src/node_options-inl.h',\n         'src/node_perf.h',"
        },
        {
            "sha": "3ed76ac49d4b02209e81fe5d653800bb623a6647",
            "filename": "src/env.h",
            "status": "modified",
            "additions": 250,
            "deletions": 240,
            "changes": 490,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fenv.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fenv.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fenv.h?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -120,248 +120,258 @@ constexpr size_t kFsStatsBufferLength = kFsStatsFieldsNumber * 2;\n \n // Strings are per-isolate primitives but Environment proxies them\n // for the sake of convenience.  Strings should be ASCII-only.\n-#define PER_ISOLATE_STRING_PROPERTIES(V)                                      \\\n-  V(address_string, \"address\")                                                \\\n-  V(aliases_string, \"aliases\")                                                \\\n-  V(args_string, \"args\")                                                      \\\n-  V(async_ids_stack_string, \"async_ids_stack\")                                \\\n-  V(buffer_string, \"buffer\")                                                  \\\n-  V(bytes_parsed_string, \"bytesParsed\")                                       \\\n-  V(bytes_read_string, \"bytesRead\")                                           \\\n-  V(bytes_written_string, \"bytesWritten\")                                     \\\n-  V(cached_data_string, \"cachedData\")                                         \\\n-  V(cached_data_produced_string, \"cachedDataProduced\")                        \\\n-  V(cached_data_rejected_string, \"cachedDataRejected\")                        \\\n-  V(change_string, \"change\")                                                  \\\n-  V(channel_string, \"channel\")                                                \\\n-  V(chunks_sent_since_last_write_string, \"chunksSentSinceLastWrite\")          \\\n-  V(constants_string, \"constants\")                                            \\\n-  V(oncertcb_string, \"oncertcb\")                                              \\\n-  V(code_string, \"code\")                                                      \\\n-  V(cwd_string, \"cwd\")                                                        \\\n-  V(dest_string, \"dest\")                                                      \\\n-  V(destroyed_string, \"destroyed\")                                            \\\n-  V(detached_string, \"detached\")                                              \\\n-  V(dns_a_string, \"A\")                                                        \\\n-  V(dns_aaaa_string, \"AAAA\")                                                  \\\n-  V(dns_cname_string, \"CNAME\")                                                \\\n-  V(dns_mx_string, \"MX\")                                                      \\\n-  V(dns_naptr_string, \"NAPTR\")                                                \\\n-  V(dns_ns_string, \"NS\")                                                      \\\n-  V(dns_ptr_string, \"PTR\")                                                    \\\n-  V(dns_soa_string, \"SOA\")                                                    \\\n-  V(dns_srv_string, \"SRV\")                                                    \\\n-  V(dns_txt_string, \"TXT\")                                                    \\\n-  V(duration_string, \"duration\")                                              \\\n-  V(emit_warning_string, \"emitWarning\")                                       \\\n-  V(exchange_string, \"exchange\")                                              \\\n-  V(encoding_string, \"encoding\")                                              \\\n-  V(entries_string, \"entries\")                                                \\\n-  V(entry_type_string, \"entryType\")                                           \\\n-  V(env_pairs_string, \"envPairs\")                                             \\\n-  V(env_var_settings_string, \"envVarSettings\")                                \\\n-  V(errno_string, \"errno\")                                                    \\\n-  V(error_string, \"error\")                                                    \\\n-  V(exit_code_string, \"exitCode\")                                             \\\n-  V(expire_string, \"expire\")                                                  \\\n-  V(exponent_string, \"exponent\")                                              \\\n-  V(exports_string, \"exports\")                                                \\\n-  V(ext_key_usage_string, \"ext_key_usage\")                                    \\\n-  V(external_stream_string, \"_externalStream\")                                \\\n-  V(family_string, \"family\")                                                  \\\n-  V(fatal_exception_string, \"_fatalException\")                                \\\n-  V(fd_string, \"fd\")                                                          \\\n-  V(file_string, \"file\")                                                      \\\n-  V(fingerprint_string, \"fingerprint\")                                        \\\n-  V(fingerprint256_string, \"fingerprint256\")                                  \\\n-  V(flags_string, \"flags\")                                                    \\\n-  V(fragment_string, \"fragment\")                                              \\\n-  V(get_data_clone_error_string, \"_getDataCloneError\")                        \\\n-  V(get_shared_array_buffer_id_string, \"_getSharedArrayBufferId\")             \\\n-  V(gid_string, \"gid\")                                                        \\\n-  V(handle_string, \"handle\")                                                  \\\n-  V(help_text_string, \"helpText\")                                             \\\n-  V(homedir_string, \"homedir\")                                                \\\n-  V(host_string, \"host\")                                                      \\\n-  V(hostmaster_string, \"hostmaster\")                                          \\\n-  V(ignore_string, \"ignore\")                                                  \\\n-  V(infoaccess_string, \"infoAccess\")                                          \\\n-  V(inherit_string, \"inherit\")                                                \\\n-  V(input_string, \"input\")                                                    \\\n-  V(internal_string, \"internal\")                                              \\\n-  V(ipv4_string, \"IPv4\")                                                      \\\n-  V(ipv6_string, \"IPv6\")                                                      \\\n-  V(isclosing_string, \"isClosing\")                                            \\\n-  V(issuer_string, \"issuer\")                                                  \\\n-  V(issuercert_string, \"issuerCertificate\")                                   \\\n-  V(kill_signal_string, \"killSignal\")                                         \\\n-  V(kind_string, \"kind\")                                                      \\\n-  V(mac_string, \"mac\")                                                        \\\n-  V(main_string, \"main\")                                                      \\\n-  V(max_buffer_string, \"maxBuffer\")                                           \\\n-  V(message_string, \"message\")                                                \\\n-  V(message_port_string, \"messagePort\")                                       \\\n-  V(message_port_constructor_string, \"MessagePort\")                           \\\n-  V(minttl_string, \"minttl\")                                                  \\\n-  V(modulus_string, \"modulus\")                                                \\\n-  V(name_string, \"name\")                                                      \\\n-  V(netmask_string, \"netmask\")                                                \\\n-  V(nsname_string, \"nsname\")                                                  \\\n-  V(ocsp_request_string, \"OCSPRequest\")                                       \\\n-  V(onaltsvc_string, \"onaltsvc\")                                              \\\n-  V(onchange_string, \"onchange\")                                              \\\n-  V(onclienthello_string, \"onclienthello\")                                    \\\n-  V(oncomplete_string, \"oncomplete\")                                          \\\n-  V(onconnection_string, \"onconnection\")                                      \\\n-  V(ondone_string, \"ondone\")                                                  \\\n-  V(onerror_string, \"onerror\")                                                \\\n-  V(onexit_string, \"onexit\")                                                  \\\n-  V(onframeerror_string, \"onframeerror\")                                      \\\n-  V(ongetpadding_string, \"ongetpadding\")                                      \\\n-  V(onhandshakedone_string, \"onhandshakedone\")                                \\\n-  V(onhandshakestart_string, \"onhandshakestart\")                              \\\n-  V(onheaders_string, \"onheaders\")                                            \\\n-  V(onmessage_string, \"onmessage\")                                            \\\n-  V(onnewsession_string, \"onnewsession\")                                      \\\n-  V(onocspresponse_string, \"onocspresponse\")                                  \\\n-  V(ongoawaydata_string, \"ongoawaydata\")                                      \\\n-  V(onorigin_string, \"onorigin\")                                              \\\n-  V(onpriority_string, \"onpriority\")                                          \\\n-  V(onread_string, \"onread\")                                                  \\\n-  V(onreadstart_string, \"onreadstart\")                                        \\\n-  V(onreadstop_string, \"onreadstop\")                                          \\\n-  V(onping_string, \"onping\")                                                  \\\n-  V(onsettings_string, \"onsettings\")                                          \\\n-  V(onshutdown_string, \"onshutdown\")                                          \\\n-  V(onsignal_string, \"onsignal\")                                              \\\n-  V(onstreamclose_string, \"onstreamclose\")                                    \\\n-  V(ontrailers_string, \"ontrailers\")                                          \\\n-  V(onunpipe_string, \"onunpipe\")                                              \\\n-  V(onwrite_string, \"onwrite\")                                                \\\n-  V(openssl_error_stack, \"opensslErrorStack\")                                 \\\n-  V(options_string, \"options\")                                                \\\n-  V(output_string, \"output\")                                                  \\\n-  V(order_string, \"order\")                                                    \\\n-  V(parse_error_string, \"Parse Error\")                                        \\\n-  V(password_string, \"password\")                                              \\\n-  V(path_string, \"path\")                                                      \\\n-  V(pending_handle_string, \"pendingHandle\")                                   \\\n-  V(pid_string, \"pid\")                                                        \\\n-  V(pipe_string, \"pipe\")                                                      \\\n-  V(pipe_target_string, \"pipeTarget\")                                         \\\n-  V(pipe_source_string, \"pipeSource\")                                         \\\n-  V(port_string, \"port\")                                                      \\\n-  V(port1_string, \"port1\")                                                    \\\n-  V(port2_string, \"port2\")                                                    \\\n-  V(preference_string, \"preference\")                                          \\\n-  V(priority_string, \"priority\")                                              \\\n-  V(promise_string, \"promise\")                                                \\\n-  V(pubkey_string, \"pubkey\")                                                  \\\n-  V(query_string, \"query\")                                                    \\\n-  V(raw_string, \"raw\")                                                        \\\n-  V(read_host_object_string, \"_readHostObject\")                               \\\n-  V(readable_string, \"readable\")                                              \\\n-  V(reason_string, \"reason\")                                                  \\\n-  V(refresh_string, \"refresh\")                                                \\\n-  V(regexp_string, \"regexp\")                                                  \\\n-  V(rename_string, \"rename\")                                                  \\\n-  V(replacement_string, \"replacement\")                                        \\\n-  V(retry_string, \"retry\")                                                    \\\n-  V(scheme_string, \"scheme\")                                                  \\\n-  V(serial_string, \"serial\")                                                  \\\n-  V(scopeid_string, \"scopeid\")                                                \\\n-  V(serial_number_string, \"serialNumber\")                                     \\\n-  V(service_string, \"service\")                                                \\\n-  V(servername_string, \"servername\")                                          \\\n-  V(session_id_string, \"sessionId\")                                           \\\n-  V(shell_string, \"shell\")                                                    \\\n-  V(signal_string, \"signal\")                                                  \\\n-  V(sink_string, \"sink\")                                                      \\\n-  V(size_string, \"size\")                                                      \\\n-  V(sni_context_err_string, \"Invalid SNI context\")                            \\\n-  V(sni_context_string, \"sni_context\")                                        \\\n-  V(source_string, \"source\")                                                  \\\n-  V(stack_string, \"stack\")                                                    \\\n-  V(start_time_string, \"startTime\")                                           \\\n-  V(status_string, \"status\")                                                  \\\n-  V(stdio_string, \"stdio\")                                                    \\\n-  V(subject_string, \"subject\")                                                \\\n-  V(subjectaltname_string, \"subjectaltname\")                                  \\\n-  V(syscall_string, \"syscall\")                                                \\\n-  V(thread_id_string, \"threadId\")                                             \\\n-  V(ticketkeycallback_string, \"onticketkeycallback\")                          \\\n-  V(timeout_string, \"timeout\")                                                \\\n-  V(tls_ticket_string, \"tlsTicket\")                                           \\\n-  V(ttl_string, \"ttl\")                                                        \\\n-  V(type_string, \"type\")                                                      \\\n-  V(uid_string, \"uid\")                                                        \\\n-  V(unknown_string, \"<unknown>\")                                              \\\n-  V(url_string, \"url\")                                                        \\\n-  V(username_string, \"username\")                                              \\\n-  V(valid_from_string, \"valid_from\")                                          \\\n-  V(valid_to_string, \"valid_to\")                                              \\\n-  V(value_string, \"value\")                                                    \\\n-  V(verify_error_string, \"verifyError\")                                       \\\n-  V(version_string, \"version\")                                                \\\n-  V(weight_string, \"weight\")                                                  \\\n-  V(windows_hide_string, \"windowsHide\")                                       \\\n-  V(windows_verbatim_arguments_string, \"windowsVerbatimArguments\")            \\\n-  V(wrap_string, \"wrap\")                                                      \\\n-  V(writable_string, \"writable\")                                              \\\n-  V(write_host_object_string, \"_writeHostObject\")                             \\\n-  V(write_queue_size_string, \"writeQueueSize\")                                \\\n-  V(x_forwarded_string, \"x-forwarded-for\")                                    \\\n+#define PER_ISOLATE_STRING_PROPERTIES(V)                                       \\\n+  V(address_string, \"address\")                                                 \\\n+  V(aliases_string, \"aliases\")                                                 \\\n+  V(args_string, \"args\")                                                       \\\n+  V(async_ids_stack_string, \"async_ids_stack\")                                 \\\n+  V(buffer_string, \"buffer\")                                                   \\\n+  V(bytes_parsed_string, \"bytesParsed\")                                        \\\n+  V(bytes_read_string, \"bytesRead\")                                            \\\n+  V(bytes_written_string, \"bytesWritten\")                                      \\\n+  V(cached_data_string, \"cachedData\")                                          \\\n+  V(cached_data_produced_string, \"cachedDataProduced\")                         \\\n+  V(cached_data_rejected_string, \"cachedDataRejected\")                         \\\n+  V(change_string, \"change\")                                                   \\\n+  V(channel_string, \"channel\")                                                 \\\n+  V(chunks_sent_since_last_write_string, \"chunksSentSinceLastWrite\")           \\\n+  V(constants_string, \"constants\")                                             \\\n+  V(oncertcb_string, \"oncertcb\")                                               \\\n+  V(code_string, \"code\")                                                       \\\n+  V(cwd_string, \"cwd\")                                                         \\\n+  V(dest_string, \"dest\")                                                       \\\n+  V(destroyed_string, \"destroyed\")                                             \\\n+  V(detached_string, \"detached\")                                               \\\n+  V(dns_a_string, \"A\")                                                         \\\n+  V(dns_aaaa_string, \"AAAA\")                                                   \\\n+  V(dns_cname_string, \"CNAME\")                                                 \\\n+  V(dns_mx_string, \"MX\")                                                       \\\n+  V(dns_naptr_string, \"NAPTR\")                                                 \\\n+  V(dns_ns_string, \"NS\")                                                       \\\n+  V(dns_ptr_string, \"PTR\")                                                     \\\n+  V(dns_soa_string, \"SOA\")                                                     \\\n+  V(dns_srv_string, \"SRV\")                                                     \\\n+  V(dns_txt_string, \"TXT\")                                                     \\\n+  V(duration_string, \"duration\")                                               \\\n+  V(emit_warning_string, \"emitWarning\")                                        \\\n+  V(exchange_string, \"exchange\")                                               \\\n+  V(encoding_string, \"encoding\")                                               \\\n+  V(entries_string, \"entries\")                                                 \\\n+  V(entry_type_string, \"entryType\")                                            \\\n+  V(env_pairs_string, \"envPairs\")                                              \\\n+  V(env_var_settings_string, \"envVarSettings\")                                 \\\n+  V(errno_string, \"errno\")                                                     \\\n+  V(error_string, \"error\")                                                     \\\n+  V(exit_code_string, \"exitCode\")                                              \\\n+  V(expire_string, \"expire\")                                                   \\\n+  V(exponent_string, \"exponent\")                                               \\\n+  V(exports_string, \"exports\")                                                 \\\n+  V(ext_key_usage_string, \"ext_key_usage\")                                     \\\n+  V(external_stream_string, \"_externalStream\")                                 \\\n+  V(family_string, \"family\")                                                   \\\n+  V(fatal_exception_string, \"_fatalException\")                                 \\\n+  V(fd_string, \"fd\")                                                           \\\n+  V(file_string, \"file\")                                                       \\\n+  V(fingerprint_string, \"fingerprint\")                                         \\\n+  V(fingerprint256_string, \"fingerprint256\")                                   \\\n+  V(flags_string, \"flags\")                                                     \\\n+  V(fragment_string, \"fragment\")                                               \\\n+  V(get_data_clone_error_string, \"_getDataCloneError\")                         \\\n+  V(get_shared_array_buffer_id_string, \"_getSharedArrayBufferId\")              \\\n+  V(gid_string, \"gid\")                                                         \\\n+  V(handle_string, \"handle\")                                                   \\\n+  V(help_text_string, \"helpText\")                                              \\\n+  V(homedir_string, \"homedir\")                                                 \\\n+  V(host_string, \"host\")                                                       \\\n+  V(hostmaster_string, \"hostmaster\")                                           \\\n+  V(ignore_string, \"ignore\")                                                   \\\n+  V(infoaccess_string, \"infoAccess\")                                           \\\n+  V(inherit_string, \"inherit\")                                                 \\\n+  V(input_string, \"input\")                                                     \\\n+  V(internal_string, \"internal\")                                               \\\n+  V(internal_binding_string, \"internalBinding\")                                \\\n+  V(ipv4_string, \"IPv4\")                                                       \\\n+  V(ipv6_string, \"IPv6\")                                                       \\\n+  V(isclosing_string, \"isClosing\")                                             \\\n+  V(issuer_string, \"issuer\")                                                   \\\n+  V(issuercert_string, \"issuerCertificate\")                                    \\\n+  V(kill_signal_string, \"killSignal\")                                          \\\n+  V(kind_string, \"kind\")                                                       \\\n+  V(mac_string, \"mac\")                                                         \\\n+  V(main_string, \"main\")                                                       \\\n+  V(max_buffer_string, \"maxBuffer\")                                            \\\n+  V(message_string, \"message\")                                                 \\\n+  V(message_port_string, \"messagePort\")                                        \\\n+  V(message_port_constructor_string, \"MessagePort\")                            \\\n+  V(minttl_string, \"minttl\")                                                   \\\n+  V(module_string, \"module\")                                                   \\\n+  V(modulus_string, \"modulus\")                                                 \\\n+  V(name_string, \"name\")                                                       \\\n+  V(netmask_string, \"netmask\")                                                 \\\n+  V(nsname_string, \"nsname\")                                                   \\\n+  V(ocsp_request_string, \"OCSPRequest\")                                        \\\n+  V(onaltsvc_string, \"onaltsvc\")                                               \\\n+  V(onchange_string, \"onchange\")                                               \\\n+  V(onclienthello_string, \"onclienthello\")                                     \\\n+  V(oncomplete_string, \"oncomplete\")                                           \\\n+  V(onconnection_string, \"onconnection\")                                       \\\n+  V(ondone_string, \"ondone\")                                                   \\\n+  V(onerror_string, \"onerror\")                                                 \\\n+  V(onexit_string, \"onexit\")                                                   \\\n+  V(onframeerror_string, \"onframeerror\")                                       \\\n+  V(ongetpadding_string, \"ongetpadding\")                                       \\\n+  V(onhandshakedone_string, \"onhandshakedone\")                                 \\\n+  V(onhandshakestart_string, \"onhandshakestart\")                               \\\n+  V(onheaders_string, \"onheaders\")                                             \\\n+  V(onmessage_string, \"onmessage\")                                             \\\n+  V(onnewsession_string, \"onnewsession\")                                       \\\n+  V(onocspresponse_string, \"onocspresponse\")                                   \\\n+  V(ongoawaydata_string, \"ongoawaydata\")                                       \\\n+  V(onorigin_string, \"onorigin\")                                               \\\n+  V(onpriority_string, \"onpriority\")                                           \\\n+  V(onread_string, \"onread\")                                                   \\\n+  V(onreadstart_string, \"onreadstart\")                                         \\\n+  V(onreadstop_string, \"onreadstop\")                                           \\\n+  V(onping_string, \"onping\")                                                   \\\n+  V(onsettings_string, \"onsettings\")                                           \\\n+  V(onshutdown_string, \"onshutdown\")                                           \\\n+  V(onsignal_string, \"onsignal\")                                               \\\n+  V(onstreamclose_string, \"onstreamclose\")                                     \\\n+  V(ontrailers_string, \"ontrailers\")                                           \\\n+  V(onunpipe_string, \"onunpipe\")                                               \\\n+  V(onwrite_string, \"onwrite\")                                                 \\\n+  V(openssl_error_stack, \"opensslErrorStack\")                                  \\\n+  V(options_string, \"options\")                                                 \\\n+  V(output_string, \"output\")                                                   \\\n+  V(order_string, \"order\")                                                     \\\n+  V(parse_error_string, \"Parse Error\")                                         \\\n+  V(password_string, \"password\")                                               \\\n+  V(path_string, \"path\")                                                       \\\n+  V(pending_handle_string, \"pendingHandle\")                                    \\\n+  V(pid_string, \"pid\")                                                         \\\n+  V(pipe_string, \"pipe\")                                                       \\\n+  V(pipe_target_string, \"pipeTarget\")                                          \\\n+  V(pipe_source_string, \"pipeSource\")                                          \\\n+  V(port_string, \"port\")                                                       \\\n+  V(port1_string, \"port1\")                                                     \\\n+  V(port2_string, \"port2\")                                                     \\\n+  V(preference_string, \"preference\")                                           \\\n+  V(priority_string, \"priority\")                                               \\\n+  V(process_string, \"process\")                                                 \\\n+  V(promise_string, \"promise\")                                                 \\\n+  V(pubkey_string, \"pubkey\")                                                   \\\n+  V(query_string, \"query\")                                                     \\\n+  V(raw_string, \"raw\")                                                         \\\n+  V(read_host_object_string, \"_readHostObject\")                                \\\n+  V(readable_string, \"readable\")                                               \\\n+  V(reason_string, \"reason\")                                                   \\\n+  V(refresh_string, \"refresh\")                                                 \\\n+  V(regexp_string, \"regexp\")                                                   \\\n+  V(rename_string, \"rename\")                                                   \\\n+  V(replacement_string, \"replacement\")                                         \\\n+  V(require_string, \"require\")                                                 \\\n+  V(retry_string, \"retry\")                                                     \\\n+  V(scheme_string, \"scheme\")                                                   \\\n+  V(serial_string, \"serial\")                                                   \\\n+  V(scopeid_string, \"scopeid\")                                                 \\\n+  V(serial_number_string, \"serialNumber\")                                      \\\n+  V(service_string, \"service\")                                                 \\\n+  V(servername_string, \"servername\")                                           \\\n+  V(session_id_string, \"sessionId\")                                            \\\n+  V(shell_string, \"shell\")                                                     \\\n+  V(signal_string, \"signal\")                                                   \\\n+  V(sink_string, \"sink\")                                                       \\\n+  V(size_string, \"size\")                                                       \\\n+  V(sni_context_err_string, \"Invalid SNI context\")                             \\\n+  V(sni_context_string, \"sni_context\")                                         \\\n+  V(source_string, \"source\")                                                   \\\n+  V(stack_string, \"stack\")                                                     \\\n+  V(start_time_string, \"startTime\")                                            \\\n+  V(status_string, \"status\")                                                   \\\n+  V(stdio_string, \"stdio\")                                                     \\\n+  V(subject_string, \"subject\")                                                 \\\n+  V(subjectaltname_string, \"subjectaltname\")                                   \\\n+  V(syscall_string, \"syscall\")                                                 \\\n+  V(thread_id_string, \"threadId\")                                              \\\n+  V(ticketkeycallback_string, \"onticketkeycallback\")                           \\\n+  V(timeout_string, \"timeout\")                                                 \\\n+  V(tls_ticket_string, \"tlsTicket\")                                            \\\n+  V(ttl_string, \"ttl\")                                                         \\\n+  V(type_string, \"type\")                                                       \\\n+  V(uid_string, \"uid\")                                                         \\\n+  V(unknown_string, \"<unknown>\")                                               \\\n+  V(url_string, \"url\")                                                         \\\n+  V(username_string, \"username\")                                               \\\n+  V(valid_from_string, \"valid_from\")                                           \\\n+  V(valid_to_string, \"valid_to\")                                               \\\n+  V(value_string, \"value\")                                                     \\\n+  V(verify_error_string, \"verifyError\")                                        \\\n+  V(version_string, \"version\")                                                 \\\n+  V(weight_string, \"weight\")                                                   \\\n+  V(windows_hide_string, \"windowsHide\")                                        \\\n+  V(windows_verbatim_arguments_string, \"windowsVerbatimArguments\")             \\\n+  V(wrap_string, \"wrap\")                                                       \\\n+  V(writable_string, \"writable\")                                               \\\n+  V(write_host_object_string, \"_writeHostObject\")                              \\\n+  V(write_queue_size_string, \"writeQueueSize\")                                 \\\n+  V(x_forwarded_string, \"x-forwarded-for\")                                     \\\n   V(zero_return_string, \"ZERO_RETURN\")\n \n-#define ENVIRONMENT_STRONG_PERSISTENT_PROPERTIES(V)                           \\\n-  V(as_external, v8::External)                                                \\\n-  V(async_hooks_after_function, v8::Function)                                 \\\n-  V(async_hooks_before_function, v8::Function)                                \\\n-  V(async_hooks_binding, v8::Object)                                          \\\n-  V(async_hooks_destroy_function, v8::Function)                               \\\n-  V(async_hooks_init_function, v8::Function)                                  \\\n-  V(async_hooks_promise_resolve_function, v8::Function)                       \\\n-  V(async_wrap_object_ctor_template, v8::FunctionTemplate)                    \\\n-  V(async_wrap_ctor_template, v8::FunctionTemplate)                           \\\n-  V(buffer_prototype_object, v8::Object)                                      \\\n-  V(context, v8::Context)                                                     \\\n-  V(domain_callback, v8::Function)                                            \\\n-  V(domexception_function, v8::Function)                                      \\\n-  V(fdclose_constructor_template, v8::ObjectTemplate)                         \\\n-  V(fd_constructor_template, v8::ObjectTemplate)                              \\\n-  V(filehandlereadwrap_template, v8::ObjectTemplate)                          \\\n-  V(fsreqpromise_constructor_template, v8::ObjectTemplate)                    \\\n-  V(fs_use_promises_symbol, v8::Symbol)                                       \\\n-  V(handle_wrap_ctor_template, v8::FunctionTemplate)                          \\\n-  V(host_import_module_dynamically_callback, v8::Function)                    \\\n-  V(host_initialize_import_meta_object_callback, v8::Function)                \\\n-  V(http2ping_constructor_template, v8::ObjectTemplate)                       \\\n-  V(http2settings_constructor_template, v8::ObjectTemplate)                   \\\n-  V(http2stream_constructor_template, v8::ObjectTemplate)                     \\\n-  V(immediate_callback_function, v8::Function)                                \\\n-  V(inspector_console_api_object, v8::Object)                                 \\\n-  V(libuv_stream_wrap_ctor_template, v8::FunctionTemplate)                    \\\n-  V(message_port, v8::Object)                                                 \\\n-  V(message_port_constructor_template, v8::FunctionTemplate)                  \\\n-  V(pipe_constructor_template, v8::FunctionTemplate)                          \\\n-  V(performance_entry_callback, v8::Function)                                 \\\n-  V(performance_entry_template, v8::Function)                                 \\\n-  V(process_object, v8::Object)                                               \\\n-  V(promise_handler_function, v8::Function)                                   \\\n-  V(promise_wrap_template, v8::ObjectTemplate)                                \\\n-  V(sab_lifetimepartner_constructor_template, v8::FunctionTemplate)           \\\n-  V(script_context_constructor_template, v8::FunctionTemplate)                \\\n-  V(script_data_constructor_function, v8::Function)                           \\\n-  V(secure_context_constructor_template, v8::FunctionTemplate)                \\\n-  V(shutdown_wrap_template, v8::ObjectTemplate)                               \\\n-  V(tcp_constructor_template, v8::FunctionTemplate)                           \\\n-  V(tick_callback_function, v8::Function)                                     \\\n-  V(timers_callback_function, v8::Function)                                   \\\n-  V(tls_wrap_constructor_function, v8::Function)                              \\\n-  V(trace_category_state_function, v8::Function)                              \\\n-  V(tty_constructor_template, v8::FunctionTemplate)                           \\\n-  V(udp_constructor_function, v8::Function)                                   \\\n-  V(url_constructor_function, v8::Function)                                   \\\n+#define ENVIRONMENT_STRONG_PERSISTENT_PROPERTIES(V)                            \\\n+  V(as_external, v8::External)                                                 \\\n+  V(async_hooks_after_function, v8::Function)                                  \\\n+  V(async_hooks_before_function, v8::Function)                                 \\\n+  V(async_hooks_binding, v8::Object)                                           \\\n+  V(async_hooks_destroy_function, v8::Function)                                \\\n+  V(async_hooks_init_function, v8::Function)                                   \\\n+  V(async_hooks_promise_resolve_function, v8::Function)                        \\\n+  V(async_wrap_object_ctor_template, v8::FunctionTemplate)                     \\\n+  V(async_wrap_ctor_template, v8::FunctionTemplate)                            \\\n+  V(buffer_prototype_object, v8::Object)                                       \\\n+  V(context, v8::Context)                                                      \\\n+  V(domain_callback, v8::Function)                                             \\\n+  V(domexception_function, v8::Function)                                       \\\n+  V(fdclose_constructor_template, v8::ObjectTemplate)                          \\\n+  V(fd_constructor_template, v8::ObjectTemplate)                               \\\n+  V(filehandlereadwrap_template, v8::ObjectTemplate)                           \\\n+  V(fsreqpromise_constructor_template, v8::ObjectTemplate)                     \\\n+  V(fs_use_promises_symbol, v8::Symbol)                                        \\\n+  V(handle_wrap_ctor_template, v8::FunctionTemplate)                           \\\n+  V(host_import_module_dynamically_callback, v8::Function)                     \\\n+  V(host_initialize_import_meta_object_callback, v8::Function)                 \\\n+  V(http2ping_constructor_template, v8::ObjectTemplate)                        \\\n+  V(http2settings_constructor_template, v8::ObjectTemplate)                    \\\n+  V(http2stream_constructor_template, v8::ObjectTemplate)                      \\\n+  V(immediate_callback_function, v8::Function)                                 \\\n+  V(inspector_console_api_object, v8::Object)                                  \\\n+  V(libuv_stream_wrap_ctor_template, v8::FunctionTemplate)                     \\\n+  V(message_port, v8::Object)                                                  \\\n+  V(message_port_constructor_template, v8::FunctionTemplate)                   \\\n+  V(native_modules_code_cache, v8::Object)                                     \\\n+  V(native_modules_code_cache_hash, v8::Object)                                \\\n+  V(native_modules_source, v8::Object)                                         \\\n+  V(native_modules_source_hash, v8::Object)                                    \\\n+  V(native_modules_with_cache, v8::Set)                                        \\\n+  V(native_modules_without_cache, v8::Set)                                     \\\n+  V(pipe_constructor_template, v8::FunctionTemplate)                           \\\n+  V(performance_entry_callback, v8::Function)                                  \\\n+  V(performance_entry_template, v8::Function)                                  \\\n+  V(process_object, v8::Object)                                                \\\n+  V(promise_handler_function, v8::Function)                                    \\\n+  V(promise_wrap_template, v8::ObjectTemplate)                                 \\\n+  V(sab_lifetimepartner_constructor_template, v8::FunctionTemplate)            \\\n+  V(script_context_constructor_template, v8::FunctionTemplate)                 \\\n+  V(script_data_constructor_function, v8::Function)                            \\\n+  V(secure_context_constructor_template, v8::FunctionTemplate)                 \\\n+  V(shutdown_wrap_template, v8::ObjectTemplate)                                \\\n+  V(tcp_constructor_template, v8::FunctionTemplate)                            \\\n+  V(tick_callback_function, v8::Function)                                      \\\n+  V(timers_callback_function, v8::Function)                                    \\\n+  V(tls_wrap_constructor_function, v8::Function)                               \\\n+  V(trace_category_state_function, v8::Function)                               \\\n+  V(tty_constructor_template, v8::FunctionTemplate)                            \\\n+  V(udp_constructor_function, v8::Function)                                    \\\n+  V(url_constructor_function, v8::Function)                                    \\\n   V(write_wrap_template, v8::ObjectTemplate)\n \n class Environment;"
        },
        {
            "sha": "48e8f0a2497700a5981eb55f9fb23f0b82890ef5",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 11,
            "deletions": 16,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -25,10 +25,9 @@\n #include \"node_errors.h\"\n #include \"node_internals.h\"\n #include \"node_javascript.h\"\n-#include \"node_code_cache.h\"\n+#include \"node_native_module.h\"\n+#include \"node_perf.h\"\n #include \"node_platform.h\"\n-#include \"node_version.h\"\n-#include \"node_internals.h\"\n #include \"node_revert.h\"\n #include \"node_version.h\"\n #include \"tracing/traced_value.h\"\n@@ -131,6 +130,7 @@ typedef int mode_t;\n \n namespace node {\n \n+using native_module::NativeModule;\n using options_parser::kAllowedInEnvironment;\n using options_parser::kDisallowedInEnvironment;\n using v8::Array;\n@@ -775,6 +775,7 @@ static MaybeLocal<Value> ExecuteString(Environment* env,\n   try_catch.SetVerbose(false);\n \n   ScriptOrigin origin(filename);\n+\n   MaybeLocal<Script> script =\n       Script::Compile(env->context(), source, &origin);\n   if (script.IsEmpty()) {\n@@ -1222,19 +1223,7 @@ static void GetInternalBinding(const FunctionCallbackInfo<Value>& args) {\n     DefineConstants(env->isolate(), exports);\n   } else if (!strcmp(*module_v, \"natives\")) {\n     exports = Object::New(env->isolate());\n-    DefineJavaScript(env, exports);\n-  } else if (!strcmp(*module_v, \"code_cache\")) {\n-    // internalBinding('code_cache')\n-    exports = Object::New(env->isolate());\n-    DefineCodeCache(env, exports);\n-  } else if (!strcmp(*module_v, \"code_cache_hash\")) {\n-    // internalBinding('code_cache_hash')\n-    exports = Object::New(env->isolate());\n-    DefineCodeCacheHash(env, exports);\n-  } else if (!strcmp(*module_v, \"natives_hash\")) {\n-    // internalBinding('natives_hash')\n-    exports = Object::New(env->isolate());\n-    DefineJavaScriptHash(env, exports);\n+    NativeModule::GetNatives(env, exports);\n   } else {\n     return ThrowIfNoSuchModule(env, *module_v);\n   }\n@@ -1772,6 +1761,8 @@ void LoadEnvironment(Environment* env) {\n   // lib/internal/bootstrap/node.js, each included as a static C string\n   // defined in node_javascript.h, generated in node_javascript.cc by\n   // node_js2c.\n+\n+  // TODO(joyeecheung): use NativeModule::Compile\n   Local<String> loaders_name =\n       FIXED_ONE_BYTE_STRING(env->isolate(), \"internal/bootstrap/loaders.js\");\n   MaybeLocal<Function> loaders_bootstrapper =\n@@ -1831,6 +1822,8 @@ void LoadEnvironment(Environment* env) {\n                  env->options()->debug_options->break_node_first_line)\n   };\n \n+  NativeModule::LoadBindings(env);\n+\n   // Bootstrap internal loaders\n   Local<Value> bootstrapped_loaders;\n   if (!ExecuteBootstrapper(env, loaders_bootstrapper.ToLocalChecked(),\n@@ -2484,6 +2477,8 @@ Local<Context> NewContext(Isolate* isolate,\n   {\n     // Run lib/internal/per_context.js\n     Context::Scope context_scope(context);\n+\n+    // TODO(joyeecheung): use NativeModule::Compile\n     Local<String> per_context = NodePerContextSource(isolate);\n     ScriptCompiler::Source per_context_src(per_context, nullptr);\n     Local<Script> s = ScriptCompiler::Compile("
        },
        {
            "sha": "8054279d55ba96cf42ccb396079805f8f9d023b5",
            "filename": "src/node_code_cache.h",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode_code_cache.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode_code_cache.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_code_cache.h?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -7,6 +7,8 @@\n \n namespace node {\n \n+extern const bool native_module_has_code_cache;\n+\n void DefineCodeCache(Environment* env, v8::Local<v8::Object> target);\n void DefineCodeCacheHash(Environment* env, v8::Local<v8::Object> target);\n "
        },
        {
            "sha": "2fb86c5bf769f5837c4147e0d445a50932abc4d8",
            "filename": "src/node_code_cache_stub.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode_code_cache_stub.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode_code_cache_stub.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_code_cache_stub.cc?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -5,6 +5,9 @@\n // The stub here is used when configure is run without `--code-cache-path`\n \n namespace node {\n+\n+const bool native_module_has_code_cache = false;\n+\n void DefineCodeCache(Environment* env, v8::Local<v8::Object> target) {\n   // When we do not produce code cache for builtin modules,\n   // `internalBinding('code_cache')` returns an empty object"
        },
        {
            "sha": "b6cd628086dcb23fec1300ac302cf6af06fc6235",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -118,6 +118,7 @@ struct sockaddr;\n   V(js_stream)                                                                 \\\n   V(messaging)                                                                 \\\n   V(module_wrap)                                                               \\\n+  V(native_module)                                                             \\\n   V(options)                                                                   \\\n   V(os)                                                                        \\\n   V(performance)                                                               \\"
        },
        {
            "sha": "ea7fe9189a68574484c52dae6e73a294cc63cdf9",
            "filename": "src/node_native_module.cc",
            "status": "added",
            "additions": 326,
            "deletions": 0,
            "changes": 326,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode_native_module.cc",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode_native_module.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_native_module.cc?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -0,0 +1,326 @@\n+#include \"node_native_module.h\"\n+#include \"node_code_cache.h\"\n+#include \"node_errors.h\"\n+#include \"node_javascript.h\"\n+\n+namespace node {\n+namespace native_module {\n+\n+using v8::Array;\n+using v8::ArrayBuffer;\n+using v8::Context;\n+using v8::EscapableHandleScope;\n+using v8::Function;\n+using v8::FunctionCallbackInfo;\n+using v8::HandleScope;\n+using v8::Integer;\n+using v8::IntegrityLevel;\n+using v8::Isolate;\n+using v8::Local;\n+using v8::Maybe;\n+using v8::MaybeLocal;\n+using v8::Object;\n+using v8::Script;\n+using v8::ScriptCompiler;\n+using v8::ScriptOrigin;\n+using v8::Set;\n+using v8::String;\n+using v8::TryCatch;\n+using v8::Uint8Array;\n+using v8::Value;\n+\n+void NativeModule::GetNatives(Environment* env, Local<Object> exports) {\n+  DefineJavaScript(env, exports);\n+}\n+\n+void NativeModule::LoadBindings(Environment* env) {\n+  // TODO(joyeecheung): put the static values into a\n+  // std::map<std::string, const uint8_t*> instead of a v8::Object,\n+  // because here they are only looked up from the C++ side\n+  // (except in process.binding('natives') which we don't use)\n+  // so there is little value to put them in a v8::Object upfront.\n+  // Moreover, a std::map lookup should be faster than a lookup on\n+  // an V8 Object in dictionary mode.\n+  Isolate* isolate = env->isolate();\n+  Local<Context> context = env->context();\n+  Local<Value> null = Null(isolate);\n+\n+  Local<Object> native_modules_source = Object::New(isolate);\n+  CHECK(native_modules_source->SetPrototype(context, null).FromJust());\n+  DefineJavaScript(env, native_modules_source);\n+  native_modules_source->SetIntegrityLevel(context, IntegrityLevel::kFrozen)\n+      .FromJust();\n+  env->set_native_modules_source(native_modules_source);\n+\n+  Local<Object> native_modules_source_hash = Object::New(isolate);\n+  CHECK(native_modules_source_hash->SetPrototype(context, null).FromJust());\n+  DefineJavaScriptHash(env, native_modules_source_hash);\n+  native_modules_source_hash\n+      ->SetIntegrityLevel(context, IntegrityLevel::kFrozen)\n+      .FromJust();\n+  env->set_native_modules_source_hash(native_modules_source_hash);\n+\n+  Local<Object> native_modules_code_cache = Object::New(isolate);\n+  CHECK(native_modules_code_cache->SetPrototype(context, null).FromJust());\n+  DefineCodeCache(env, native_modules_code_cache);\n+  native_modules_code_cache->SetIntegrityLevel(context, IntegrityLevel::kFrozen)\n+      .FromJust();\n+  env->set_native_modules_code_cache(native_modules_code_cache);\n+\n+  Local<Object> native_modules_code_cache_hash = Object::New(isolate);\n+  CHECK(native_modules_code_cache_hash->SetPrototype(context, null).FromJust());\n+  DefineCodeCacheHash(env, native_modules_code_cache_hash);\n+  native_modules_code_cache_hash\n+      ->SetIntegrityLevel(context, IntegrityLevel::kFrozen)\n+      .FromJust();\n+  env->set_native_modules_code_cache_hash(native_modules_code_cache_hash);\n+\n+  env->set_native_modules_with_cache(Set::New(isolate));\n+  env->set_native_modules_without_cache(Set::New(isolate));\n+}\n+\n+void NativeModule::CompileCodeCache(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+  CHECK(args[0]->IsString());\n+  Local<String> id = args[0].As<String>();\n+\n+  Local<Value> result = CompileAsModule(env, id, true);\n+  if (!result.IsEmpty()) {\n+    args.GetReturnValue().Set(result);\n+  }\n+}\n+\n+void NativeModule::CompileFunction(const FunctionCallbackInfo<Value>& args) {\n+  Environment* env = Environment::GetCurrent(args);\n+\n+  CHECK(args[0]->IsString());\n+  Local<String> id = args[0].As<String>();\n+\n+  Local<Value> result = CompileAsModule(env, id, false);\n+  if (!result.IsEmpty()) {\n+    args.GetReturnValue().Set(result);\n+  }\n+}\n+\n+Local<Value> NativeModule::CompileAsModule(Environment* env,\n+                                           Local<String> id,\n+                                           bool produce_code_cache) {\n+  Local<String> parameters[] = {env->exports_string(),\n+                                env->require_string(),\n+                                env->module_string(),\n+                                env->process_string(),\n+                                env->internal_binding_string()};\n+\n+  return Compile(\n+      env, id, parameters, arraysize(parameters), produce_code_cache);\n+}\n+\n+// Currently V8 only checks that the length of the source code is the\n+// same as the code used to generate the hash, so we add an additional\n+// check here:\n+// 1. During compile time, when generating node_javascript.cc and\n+//    node_code_cache.cc, we compute and include the hash of the\n+//    JavaScript source in both.\n+// 2. At runtime, we check that the hash of the code being compiled\n+//   and the hash of the code used to generate the cache\n+//   (without the parameters) is the same.\n+// This is based on the assumptions:\n+// 1. `code_cache_hash` must be in sync with `code_cache`\n+//     (both defined in node_code_cache.cc)\n+// 2. `source_hash` must be in sync with `source`\n+//     (both defined in node_javascript.cc)\n+// 3. If `source_hash` is in sync with `code_cache_hash`,\n+//    then the source code used to generate `code_cache`\n+//    should be in sync with the source code in `source`\n+// The only variable left, then, are the parameters passed to the\n+// CompileFunctionInContext. If the parameters used generate the cache\n+// is different from the one used to compile modules at run time, then\n+// there could be false postivies, but that should be rare and should fail\n+// early in the bootstrap process so it should be easy to detect and fix.\n+\n+// Returns nullptr if there is no code cache corresponding to the id\n+ScriptCompiler::CachedData* GetCachedData(Environment* env, Local<String> id) {\n+  HandleScope scope(env->isolate());\n+  Local<Context> context = env->context();\n+\n+  Local<Value> result =\n+      env->native_modules_code_cache()->Get(context, id).ToLocalChecked();\n+  // This could be false if the module cannot be cached somehow.\n+  // See lib/internal/bootstrap/cache.js on the modules that cannot be cached\n+  if (result->IsUndefined()) {\n+    return nullptr;\n+  }\n+\n+  CHECK(result->IsUint8Array());\n+  Local<Uint8Array> code_cache = result.As<Uint8Array>();\n+\n+  result =\n+      env->native_modules_code_cache_hash()->Get(context, id).ToLocalChecked();\n+  CHECK(result->IsString());\n+  Local<String> code_cache_hash = result.As<String>();\n+\n+  result =\n+      env->native_modules_source_hash()->Get(context, id).ToLocalChecked();\n+  CHECK(result->IsString());\n+  Local<String> source_hash = result.As<String>();\n+\n+  // It may fail when any of the inputs of the `node_js2c` target in\n+  // node.gyp is modified but the tools/generate_code_cache.js\n+  // is not re run.\n+  // FIXME(joyeecheung): Figure out how to resolve the dependency issue.\n+  // When the code cache was introduced we were at a point where refactoring\n+  // node.gyp may not be worth the effort.\n+  CHECK(code_cache_hash->StrictEquals(source_hash));\n+\n+  ArrayBuffer::Contents contents = code_cache->Buffer()->GetContents();\n+  uint8_t* data = static_cast<uint8_t*>(contents.Data());\n+  return new ScriptCompiler::CachedData(data + code_cache->ByteOffset(),\n+                                        code_cache->ByteLength());\n+}\n+\n+// Returns Local<Function> of the compiled module if produce_code_cache\n+// is false (we are only compiling the function).\n+// Otherwise return a Local<Object> containing the cache.\n+Local<Value> NativeModule::Compile(Environment* env,\n+                                   Local<String> id,\n+                                   Local<String> parameters[],\n+                                   size_t parameters_count,\n+                                   bool produce_code_cache) {\n+  EscapableHandleScope scope(env->isolate());\n+  Local<Context> context = env->context();\n+  Isolate* isolate = env->isolate();\n+\n+  Local<Value> result =\n+      env->native_modules_source()->Get(context, id).ToLocalChecked();\n+  CHECK(result->IsString());\n+  Local<String> source = result.As<String>();\n+\n+  Local<String> filename =\n+      String::Concat(isolate, id, FIXED_ONE_BYTE_STRING(isolate, \".js\"));\n+  Local<Integer> line_offset = Integer::New(isolate, 0);\n+  Local<Integer> column_offset = Integer::New(isolate, 0);\n+  ScriptOrigin origin(filename, line_offset, column_offset);\n+\n+  bool use_cache = false;\n+  ScriptCompiler::CachedData* cached_data = nullptr;\n+\n+  // 1. We won't even check the existence of the cache if the binary is not\n+  //    built with them.\n+  // 2. If we are generating code cache for tools/general_code_cache.js, we\n+  //    are not going to use any cache ourselves.\n+  if (native_module_has_code_cache && !produce_code_cache) {\n+    cached_data = GetCachedData(env, id);\n+    if (cached_data != nullptr) {\n+      use_cache = true;\n+    }\n+  }\n+\n+  ScriptCompiler::Source script_source(source, origin, cached_data);\n+\n+  ScriptCompiler::CompileOptions options;\n+  if (produce_code_cache) {\n+    options = ScriptCompiler::kEagerCompile;\n+  } else if (use_cache) {\n+    options = ScriptCompiler::kConsumeCodeCache;\n+  } else {\n+    options = ScriptCompiler::kNoCompileOptions;\n+  }\n+\n+  MaybeLocal<Function> maybe_fun =\n+      ScriptCompiler::CompileFunctionInContext(context,\n+                                               &script_source,\n+                                               parameters_count,\n+                                               parameters,\n+                                               0,\n+                                               nullptr,\n+                                               options);\n+\n+  TryCatch try_catch(isolate);\n+  Local<Function> fun;\n+  // This could fail when there are early errors in the native modules,\n+  // e.g. the syntax errors\n+  if (maybe_fun.IsEmpty() || !maybe_fun.ToLocal(&fun)) {\n+    DecorateErrorStack(env, try_catch);\n+    try_catch.ReThrow();\n+    return scope.Escape(Local<Value>());\n+  }\n+\n+  if (use_cache) {\n+    // If the cache is rejected, something must be wrong with the build\n+    // and we should just crash.\n+    CHECK(!script_source.GetCachedData()->rejected);\n+    if (env->native_modules_with_cache()->Add(context, id).IsEmpty()) {\n+      return scope.Escape(Local<Value>());\n+    }\n+  } else {\n+    if (env->native_modules_without_cache()->Add(context, id).IsEmpty()) {\n+      return scope.Escape(Local<Value>());\n+    }\n+  }\n+\n+  if (produce_code_cache) {\n+    std::unique_ptr<ScriptCompiler::CachedData> cached_data(\n+        ScriptCompiler::CreateCodeCacheForFunction(fun));\n+    CHECK_NE(cached_data, nullptr);\n+    char* data =\n+        reinterpret_cast<char*>(const_cast<uint8_t*>(cached_data->data));\n+\n+    // Since we have no API to create a buffer from a new'ed pointer,\n+    // we will need to copy it - but this code path is only run by the\n+    // tooling that generates the code cache to be bundled in the binary\n+    // so it should be fine.\n+    Local<Object> buf =\n+        Buffer::Copy(env, data, cached_data->length).ToLocalChecked();\n+    return scope.Escape(buf);\n+  } else {\n+    return scope.Escape(fun);\n+  }\n+}\n+\n+void Initialize(Local<Object> target,\n+                Local<Value> unused,\n+                Local<Context> context) {\n+  Environment* env = Environment::GetCurrent(context);\n+\n+  target\n+      ->Set(context,\n+            FIXED_ONE_BYTE_STRING(env->isolate(), \"source\"),\n+            env->native_modules_source())\n+      .FromJust();\n+  target\n+      ->Set(context,\n+            FIXED_ONE_BYTE_STRING(env->isolate(), \"sourceHash\"),\n+            env->native_modules_source_hash())\n+      .FromJust();\n+  target\n+      ->Set(context,\n+            FIXED_ONE_BYTE_STRING(env->isolate(), \"codeCache\"),\n+            env->native_modules_code_cache())\n+      .FromJust();\n+  target\n+      ->Set(context,\n+            FIXED_ONE_BYTE_STRING(env->isolate(), \"codeCacheHash\"),\n+            env->native_modules_code_cache_hash())\n+      .FromJust();\n+  target\n+      ->Set(context,\n+            FIXED_ONE_BYTE_STRING(env->isolate(), \"compiledWithCache\"),\n+            env->native_modules_with_cache())\n+      .FromJust();\n+  target\n+      ->Set(context,\n+            FIXED_ONE_BYTE_STRING(env->isolate(), \"compiledWithoutCache\"),\n+            env->native_modules_without_cache())\n+      .FromJust();\n+\n+  env->SetMethod(target, \"compileFunction\", NativeModule::CompileFunction);\n+  env->SetMethod(target, \"compileCodeCache\", NativeModule::CompileCodeCache);\n+  // internalBinding('native_module') should be frozen\n+  target->SetIntegrityLevel(context, IntegrityLevel::kFrozen).FromJust();\n+}\n+\n+}  // namespace native_module\n+}  // namespace node\n+\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(native_module,\n+                                   node::native_module::Initialize)"
        },
        {
            "sha": "c4ffbfb0cdf94d82d799a8b01aacc73fde1ea220",
            "filename": "src/node_native_module.h",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode_native_module.h",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/src%2Fnode_native_module.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_native_module.h?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -0,0 +1,41 @@\n+#ifndef SRC_NODE_NATIVE_MODULE_H_\n+#define SRC_NODE_NATIVE_MODULE_H_\n+\n+#if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#include \"node_internals.h\"\n+\n+namespace node {\n+namespace native_module {\n+\n+// The native (C++) side of the native module compilation.\n+\n+class NativeModule {\n+ public:\n+  // For legacy process.binding('natives') which is mutable\n+  static void GetNatives(Environment* env, v8::Local<v8::Object> exports);\n+  // Loads the static JavaScript source code and the cache into Environment\n+  static void LoadBindings(Environment* env);\n+  // Compile code cache for a specific native module\n+  static void CompileCodeCache(const v8::FunctionCallbackInfo<v8::Value>& args);\n+  // Compile a specific native module as a function\n+  static void CompileFunction(const v8::FunctionCallbackInfo<v8::Value>& args);\n+\n+ private:\n+  static v8::Local<v8::Value> CompileAsModule(Environment* env,\n+                                              v8::Local<v8::String> id,\n+                                              bool produce_code_cache);\n+  // TODO(joyeecheung): make this public and reuse it to compile bootstrappers\n+  static v8::Local<v8::Value> Compile(Environment* env,\n+                                      v8::Local<v8::String> id,\n+                                      v8::Local<v8::String> parameters[],\n+                                      size_t parameters_count,\n+                                      bool produce_code_cache);\n+};\n+\n+}  // namespace native_module\n+}  // namespace node\n+\n+#endif  // defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n+\n+#endif  // SRC_NODE_NATIVE_MODULE_H_"
        },
        {
            "sha": "994facff1996c2588cd70c090d9f5778aedc4c7c",
            "filename": "test/code-cache/test-code-cache.js",
            "status": "modified",
            "additions": 30,
            "deletions": 25,
            "changes": 55,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/test%2Fcode-cache%2Ftest-code-cache.js",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/test%2Fcode-cache%2Ftest-code-cache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fcode-cache%2Ftest-code-cache.js?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -7,17 +7,28 @@\n \n require('../common');\n const assert = require('assert');\n-const {\n-  types: {\n-    isUint8Array\n-  }\n-} = require('util');\n const {\n   cachableBuiltins,\n-  codeCache,\n-  compiledWithCache,\n-  compiledWithoutCache\n+  cannotUseCache\n } = require('internal/bootstrap/cache');\n+const {\n+  isMainThread\n+} = require('worker_threads');\n+\n+const {\n+  internalBinding\n+} = require('internal/test/binding');\n+const {\n+  compiledWithoutCache,\n+  compiledWithCache\n+} = internalBinding('native_module');\n+\n+for (const key of cachableBuiltins) {\n+  if (!isMainThread && key === 'trace_events') {\n+    continue;  // Cannot load trace_events in workers\n+  }\n+  require(key);\n+}\n \n const loadedModules = process.moduleLoadList\n   .filter((m) => m.startsWith('NativeModule'))\n@@ -26,29 +37,23 @@ const loadedModules = process.moduleLoadList\n // The binary is not configured with code cache, verifies that the builtins\n // are all compiled without cache and we are doing the bookkeeping right.\n if (process.config.variables.node_code_cache_path === undefined) {\n-  assert.deepStrictEqual(compiledWithCache, []);\n-  assert.notStrictEqual(compiledWithoutCache.length, 0);\n-\n-  for (const key of loadedModules) {\n-    assert(compiledWithoutCache.includes(key),\n-           `\"${key}\" should not have been compiled with code cache`);\n-  }\n-\n+  console.log('The binary is not configured with code cache');\n+  assert.deepStrictEqual(compiledWithCache, new Set());\n+  assert.deepStrictEqual(compiledWithoutCache, new Set(loadedModules));\n } else {\n-  // The binary is configured with code cache.\n+  console.log('The binary is configured with code cache');\n   assert.strictEqual(\n     typeof process.config.variables.node_code_cache_path,\n     'string'\n   );\n-  assert.deepStrictEqual(compiledWithoutCache, []);\n \n   for (const key of loadedModules) {\n-    assert(compiledWithCache.includes(key),\n-           `\"${key}\" should've been compiled with code cache`);\n-  }\n-\n-  for (const key of cachableBuiltins) {\n-    assert(isUint8Array(codeCache[key]) && codeCache[key].length > 0,\n-           `Code cache for \"${key}\" should've been generated`);\n+    if (cannotUseCache.includes(key)) {\n+      assert(compiledWithoutCache.has(key),\n+             `\"${key}\" should've been compiled without code cache`);\n+    } else {\n+      assert(compiledWithCache.has(key),\n+             `\"${key}\" should've been compiled with code cache`);\n+    }\n   }\n }"
        },
        {
            "sha": "9609d77c2afca9c2087cf849d0bf4a0db264c4a5",
            "filename": "tools/generate_code_cache.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/bd765d61d7425d82e80bdf2f4f27c0424221837b/tools%2Fgenerate_code_cache.js",
            "raw_url": "https://github.com/nodejs/node/raw/bd765d61d7425d82e80bdf2f4f27c0424221837b/tools%2Fgenerate_code_cache.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fgenerate_code_cache.js?ref=bd765d61d7425d82e80bdf2f4f27c0424221837b",
            "patch": "@@ -8,8 +8,8 @@\n // of `configure`.\n \n const {\n-  getCodeCache,\n   getSource,\n+  getCodeCache,\n   cachableBuiltins\n } = require('internal/bootstrap/cache');\n \n@@ -118,6 +118,8 @@ namespace node {\n \n ${cacheDefinitions.join('\\n\\n')}\n \n+const bool native_module_has_code_cache = true;\n+\n // The target here will be returned as \\`internalBinding('code_cache')\\`\n void DefineCodeCache(Environment* env, v8::Local<v8::Object> target) {\n   v8::Isolate* isolate = env->isolate();"
        }
    ],
    "stats": {
        "total": 1044,
        "additions": 680,
        "deletions": 364
    }
}