{
    "author": "devsnek",
    "message": "lib: add internal check macros\n\nPR-URL: https://github.com/nodejs/node/pull/18852\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8",
    "files": [
        {
            "sha": "df59b59e2076c97f5c6c0c0606ef289b6b18ad76",
            "filename": "configure",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/configure",
            "raw_url": "https://github.com/nodejs/node/raw/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/configure",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/configure?ref=3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8",
            "patch": "@@ -434,6 +434,11 @@ intl_optgroup.add_option('--download-path',\n \n parser.add_option_group(intl_optgroup)\n \n+parser.add_option('--debug-lib',\n+    action='store_true',\n+    dest='node_debug_lib',\n+    help='build lib with DCHECK macros')\n+\n http2_optgroup.add_option('--debug-http2',\n     action='store_true',\n     dest='debug_http2',\n@@ -935,6 +940,8 @@ def configure_node(o):\n   if options.enable_static:\n     o['variables']['node_target_type'] = 'static_library'\n \n+  o['variables']['node_debug_lib'] = b(options.node_debug_lib)\n+\n   if options.debug_http2:\n     o['variables']['debug_http2'] = 1\n   else:"
        },
        {
            "sha": "6ec81a725d4736dceca7036d76d91123aad8676f",
            "filename": "lib/.eslintrc.yaml",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/nodejs/node/blob/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/lib%2F.eslintrc.yaml",
            "raw_url": "https://github.com/nodejs/node/raw/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/lib%2F.eslintrc.yaml",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F.eslintrc.yaml?ref=3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8",
            "patch": "@@ -5,3 +5,18 @@ rules:\n   node-core/no-let-in-for-declaration: error\n   node-core/lowercase-name-for-primitive: error\n   node-core/non-ascii-character: error\n+globals:\n+  CHECK: false\n+  CHECK_EQ: false\n+  CHECK_GE: false\n+  CHECK_GT: false\n+  CHECK_LE: false\n+  CHECK_LT: false\n+  CHECK_NE: false\n+  DCHECK: false\n+  DCHECK_EQ: false\n+  DCHECK_GE: false\n+  DCHECK_GT: false\n+  DCHECK_LE: false\n+  DCHECK_LT: false\n+  DCHECK_NE: false"
        },
        {
            "sha": "827c81692a67e4bb412f29d1f5cb38a926134aee",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8",
            "patch": "@@ -714,6 +714,7 @@\n           'inputs': [\n             '<@(library_files)',\n             './config.gypi',\n+            'tools/check_macros.py'\n           ],\n           'outputs': [\n             '<(SHARED_INTERMEDIATE_DIR)/node_javascript.cc',\n@@ -724,6 +725,12 @@\n             }],\n             [ 'node_use_perfctr==\"false\"', {\n               'inputs': [ 'src/noperfctr_macros.py' ]\n+            }],\n+            [ 'node_debug_lib==\"false\"', {\n+              'inputs': [ 'tools/nodcheck_macros.py' ]\n+            }],\n+            [ 'node_debug_lib==\"true\"', {\n+              'inputs': [ 'tools/dcheck_macros.py' ]\n             }]\n           ],\n           'action': ["
        },
        {
            "sha": "2baf0d7f419573f41ab9a402c2b9b9154f3a6915",
            "filename": "tools/check_macros.py",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/tools%2Fcheck_macros.py",
            "raw_url": "https://github.com/nodejs/node/raw/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/tools%2Fcheck_macros.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fcheck_macros.py?ref=3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8",
            "patch": "@@ -0,0 +1,7 @@\n+macro CHECK(x) = do { if (!(x)) (process._rawDebug(\"CHECK: x == true\"), process.abort()) } while (0);\n+macro CHECK_EQ(a, b) = CHECK((a) === (b));\n+macro CHECK_GE(a, b) = CHECK((a) >= (b));\n+macro CHECK_GT(a, b) = CHECK((a) > (b));\n+macro CHECK_LE(a, b) = CHECK((a) <= (b));\n+macro CHECK_LT(a, b) = CHECK((a) < (b));\n+macro CHECK_NE(a, b) = CHECK((a) !== (b));"
        },
        {
            "sha": "acc68fadb01abe3d8f5e9d98fc435e2ae84e88e5",
            "filename": "tools/dcheck_macros.py",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/tools%2Fdcheck_macros.py",
            "raw_url": "https://github.com/nodejs/node/raw/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/tools%2Fdcheck_macros.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fdcheck_macros.py?ref=3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8",
            "patch": "@@ -0,0 +1,7 @@\n+macro DCHECK(x) = do { if (!(x)) (process._rawDebug(\"DCHECK: x == true\"), process.abort()) } while (0);\n+macro DCHECK_EQ(a, b) = DCHECK((a) === (b));\n+macro DCHECK_GE(a, b) = DCHECK((a) >= (b));\n+macro DCHECK_GT(a, b) = DCHECK((a) > (b));\n+macro DCHECK_LE(a, b) = DCHECK((a) <= (b));\n+macro DCHECK_LT(a, b) = DCHECK((a) < (b));\n+macro DCHECK_NE(a, b) = DCHECK((a) !== (b));"
        },
        {
            "sha": "75c74f22cebe665c1dbed216ce5104e0b24a6c93",
            "filename": "tools/js2c.py",
            "status": "modified",
            "additions": 19,
            "deletions": 9,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/tools%2Fjs2c.py",
            "raw_url": "https://github.com/nodejs/node/raw/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/tools%2Fjs2c.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fjs2c.py?ref=3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8",
            "patch": "@@ -74,20 +74,27 @@ def ExpandConstants(lines, constants):\n \n \n def ExpandMacros(lines, macros):\n+  def expander(s):\n+    return ExpandMacros(s, macros)\n   for name, macro in macros.items():\n-    start = lines.find(name + '(', 0)\n-    while start != -1:\n+    name_pattern = re.compile(\"\\\\b%s\\\\(\" % name)\n+    pattern_match = name_pattern.search(lines, 0)\n+    while pattern_match is not None:\n       # Scan over the arguments\n-      assert lines[start + len(name)] == '('\n       height = 1\n-      end = start + len(name) + 1\n+      start = pattern_match.start()\n+      end = pattern_match.end()\n+      assert lines[end - 1] == '('\n       last_match = end\n-      arg_index = 0\n-      mapping = { }\n+      arg_index = [0]  # Wrap state into array, to work around Python \"scoping\"\n+      mapping = {}\n       def add_arg(str):\n         # Remember to expand recursively in the arguments\n-        replacement = ExpandMacros(str.strip(), macros)\n-        mapping[macro.args[arg_index]] = replacement\n+        if arg_index[0] >= len(macro.args):\n+          return\n+        replacement = expander(str.strip())\n+        mapping[macro.args[arg_index[0]]] = replacement\n+        arg_index[0] += 1\n       while end < len(lines) and height > 0:\n         # We don't count commas at higher nesting levels.\n         if lines[end] == ',' and height == 1:\n@@ -100,10 +107,13 @@ def add_arg(str):\n         end = end + 1\n       # Remember to add the last match.\n       add_arg(lines[last_match:end-1])\n+      if arg_index[0] < len(macro.args) -1:\n+        lineno = lines.count(os.linesep, 0, start) + 1\n+        raise Exception('line %s: Too few arguments for macro \"%s\"' % (lineno, name))\n       result = macro.expand(mapping)\n       # Replace the occurrence of the macro with the expansion\n       lines = lines[:start] + result + lines[end:]\n-      start = lines.find(name + '(', start)\n+      pattern_match = name_pattern.search(lines, start + len(result))\n   return lines\n \n "
        },
        {
            "sha": "7bd2f209f511fcf8e5d539b559cb9676bb6eae56",
            "filename": "tools/nodcheck_macros.py",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/tools%2Fnodcheck_macros.py",
            "raw_url": "https://github.com/nodejs/node/raw/3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8/tools%2Fnodcheck_macros.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/tools%2Fnodcheck_macros.py?ref=3ed363cb36a9fb686956c0b8b2953ff08a6f0ee8",
            "patch": "@@ -0,0 +1,7 @@\n+macro DCHECK(x) = void(x);\n+macro DCHECK_EQ(a, b) = void(a, b);\n+macro DCHECK_GE(a, b) = void(a, b);\n+macro DCHECK_GT(a, b) = void(a, b);\n+macro DCHECK_LE(a, b) = void(a, b);\n+macro DCHECK_LT(a, b) = void(a, b);\n+macro DCHECK_NE(a, b) = void(a, b);"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 69,
        "deletions": 9
    }
}