{
    "author": "sam-github",
    "message": "tls: get the local certificate after tls handshake\n\nAdd an API to get the local certificate chosen during TLS handshake from\nthe SSL context.\n\nFix: https://github.com/nodejs/node/issues/24095\n\nPR-URL: https://github.com/nodejs/node/pull/24261\nFixes: https://github.com/nodejs/node/issues/24095\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>",
    "sha": "db35fee1e1ca909f0f33940c0d9501a72baf2375",
    "files": [
        {
            "sha": "5bda2f26c0af33003959bac08efe83de5b4fce9b",
            "filename": "doc/api/tls.md",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/db35fee1e1ca909f0f33940c0d9501a72baf2375/doc%2Fapi%2Ftls.md",
            "raw_url": "https://github.com/nodejs/node/raw/db35fee1e1ca909f0f33940c0d9501a72baf2375/doc%2Fapi%2Ftls.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftls.md?ref=db35fee1e1ca909f0f33940c0d9501a72baf2375",
            "patch": "@@ -566,6 +566,22 @@ added: v0.11.4\n Always returns `true`. This may be used to distinguish TLS sockets from regular\n `net.Socket` instances.\n \n+### tlsSocket.getCertificate()\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+* Returns: {Object}\n+\n+Returns an object representing the local certificate. The returned object has\n+some properties corresponding to the fields of the certificate.\n+\n+See [`tls.TLSSocket.getPeerCertificate()`][] for an example of the certificate\n+structure.\n+\n+If there is no local certificate, an empty object will be returned. If the\n+socket has been destroyed, `null` will be returned.\n+\n ### tlsSocket.getCipher()\n <!-- YAML\n added: v0.11.4\n@@ -658,6 +674,7 @@ certificate.\n ```\n \n If the peer does not provide a certificate, an empty object will be returned.\n+If the socket has been destroyed, `null` will be returned.\n \n ### tlsSocket.getPeerFinished()\n <!-- YAML"
        },
        {
            "sha": "4028b02be28e17da8bb31f10e562297f00764703",
            "filename": "lib/_tls_common.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/db35fee1e1ca909f0f33940c0d9501a72baf2375/lib%2F_tls_common.js",
            "raw_url": "https://github.com/nodejs/node/raw/db35fee1e1ca909f0f33940c0d9501a72baf2375/lib%2F_tls_common.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_tls_common.js?ref=db35fee1e1ca909f0f33940c0d9501a72baf2375",
            "patch": "@@ -202,6 +202,9 @@ exports.createSecureContext = function createSecureContext(options) {\n   return c;\n };\n \n+// Translate some fields from the handle's C-friendly format into more idiomatic\n+// javascript object representations before passing them back to the user.  Can\n+// be used on any cert object, but changing the name would be semver-major.\n exports.translatePeerCertificate = function translatePeerCertificate(c) {\n   if (!c)\n     return null;"
        },
        {
            "sha": "2e32366028ef71ffcec0f3f2c3906913faff264e",
            "filename": "lib/_tls_wrap.js",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/db35fee1e1ca909f0f33940c0d9501a72baf2375/lib%2F_tls_wrap.js",
            "raw_url": "https://github.com/nodejs/node/raw/db35fee1e1ca909f0f33940c0d9501a72baf2375/lib%2F_tls_wrap.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_tls_wrap.js?ref=db35fee1e1ca909f0f33940c0d9501a72baf2375",
            "patch": "@@ -660,7 +660,17 @@ TLSSocket.prototype.setSession = function(session) {\n TLSSocket.prototype.getPeerCertificate = function(detailed) {\n   if (this._handle) {\n     return common.translatePeerCertificate(\n-      this._handle.getPeerCertificate(detailed));\n+      this._handle.getPeerCertificate(detailed)) || {};\n+  }\n+\n+  return null;\n+};\n+\n+TLSSocket.prototype.getCertificate = function() {\n+  if (this._handle) {\n+    // It's not a peer cert, but the formatting is identical.\n+    return common.translatePeerCertificate(\n+      this._handle.getCertificate()) || {};\n   }\n \n   return null;"
        },
        {
            "sha": "1842d03dcbb87dd3d95560ac9628382c7c8cd63c",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/nodejs/node/blob/db35fee1e1ca909f0f33940c0d9501a72baf2375/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/db35fee1e1ca909f0f33940c0d9501a72baf2375/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=db35fee1e1ca909f0f33940c0d9501a72baf2375",
            "patch": "@@ -1409,6 +1409,7 @@ void SSLWrap<Base>::AddMethods(Environment* env, Local<FunctionTemplate> t) {\n   HandleScope scope(env->isolate());\n \n   env->SetProtoMethodNoSideEffect(t, \"getPeerCertificate\", GetPeerCertificate);\n+  env->SetProtoMethodNoSideEffect(t, \"getCertificate\", GetCertificate);\n   env->SetProtoMethodNoSideEffect(t, \"getFinished\", GetFinished);\n   env->SetProtoMethodNoSideEffect(t, \"getPeerFinished\", GetPeerFinished);\n   env->SetProtoMethodNoSideEffect(t, \"getSession\", GetSession);\n@@ -1871,8 +1872,26 @@ void SSLWrap<Base>::GetPeerCertificate(\n   }\n \n  done:\n-  if (result.IsEmpty())\n-    result = Object::New(env->isolate());\n+  args.GetReturnValue().Set(result);\n+}\n+\n+\n+template <class Base>\n+void SSLWrap<Base>::GetCertificate(\n+    const FunctionCallbackInfo<Value>& args) {\n+  Base* w;\n+  ASSIGN_OR_RETURN_UNWRAP(&w, args.Holder());\n+  Environment* env = w->ssl_env();\n+\n+  ClearErrorOnReturn clear_error_on_return;\n+\n+  Local<Object> result;\n+\n+  X509Pointer cert(SSL_get_certificate(w->ssl_.get()));\n+\n+  if (cert)\n+    result = X509ToObject(env, cert.get());\n+\n   args.GetReturnValue().Set(result);\n }\n "
        },
        {
            "sha": "f85cdd320818959ec5a82ec14015f930843565cd",
            "filename": "src/node_crypto.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/db35fee1e1ca909f0f33940c0d9501a72baf2375/src%2Fnode_crypto.h",
            "raw_url": "https://github.com/nodejs/node/raw/db35fee1e1ca909f0f33940c0d9501a72baf2375/src%2Fnode_crypto.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.h?ref=db35fee1e1ca909f0f33940c0d9501a72baf2375",
            "patch": "@@ -272,6 +272,7 @@ class SSLWrap {\n \n   static void GetPeerCertificate(\n       const v8::FunctionCallbackInfo<v8::Value>& args);\n+  static void GetCertificate(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void GetFinished(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void GetPeerFinished(const v8::FunctionCallbackInfo<v8::Value>& args);\n   static void GetSession(const v8::FunctionCallbackInfo<v8::Value>& args);"
        },
        {
            "sha": "a2548d6bcffb9e5a6bf8ee8c58e01e92dee33e21",
            "filename": "test/parallel/test-tls-peer-certificate-multi-keys.js",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/db35fee1e1ca909f0f33940c0d9501a72baf2375/test%2Fparallel%2Ftest-tls-peer-certificate-multi-keys.js",
            "raw_url": "https://github.com/nodejs/node/raw/db35fee1e1ca909f0f33940c0d9501a72baf2375/test%2Fparallel%2Ftest-tls-peer-certificate-multi-keys.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-peer-certificate-multi-keys.js?ref=db35fee1e1ca909f0f33940c0d9501a72baf2375",
            "patch": "@@ -26,7 +26,6 @@ if (!common.hasCrypto)\n \n const assert = require('assert');\n const tls = require('tls');\n-const util = require('util');\n const fixtures = require('../common/fixtures');\n \n const options = {\n@@ -37,13 +36,22 @@ const options = {\n const server = tls.createServer(options, function(cleartext) {\n   cleartext.end('World');\n });\n+\n+server.once('secureConnection', common.mustCall(function(socket) {\n+  const cert = socket.getCertificate();\n+  // The server's local cert is the client's peer cert.\n+  assert.deepStrictEqual(\n+    cert.subject.OU,\n+    ['Information Technology', 'Engineering', 'Marketing']\n+  );\n+}));\n+\n server.listen(0, common.mustCall(function() {\n   const socket = tls.connect({\n     port: this.address().port,\n     rejectUnauthorized: false\n   }, common.mustCall(function() {\n     const peerCert = socket.getPeerCertificate();\n-    console.error(util.inspect(peerCert));\n     assert.deepStrictEqual(\n       peerCert.subject.OU,\n       ['Information Technology', 'Engineering', 'Marketing']"
        },
        {
            "sha": "5eac36628d658e55fdd9a82be6cbc9e6f4068cf8",
            "filename": "test/parallel/test-tls-peer-certificate.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/db35fee1e1ca909f0f33940c0d9501a72baf2375/test%2Fparallel%2Ftest-tls-peer-certificate.js",
            "raw_url": "https://github.com/nodejs/node/raw/db35fee1e1ca909f0f33940c0d9501a72baf2375/test%2Fparallel%2Ftest-tls-peer-certificate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-peer-certificate.js?ref=db35fee1e1ca909f0f33940c0d9501a72baf2375",
            "patch": "@@ -43,6 +43,8 @@ connect({\n }, function(err, pair, cleanup) {\n   assert.ifError(err);\n   const socket = pair.client.conn;\n+  const localCert = socket.getCertificate();\n+  assert.deepStrictEqual(localCert, {});\n   let peerCert = socket.getPeerCertificate();\n   assert.ok(!peerCert.issuerCertificate);\n "
        },
        {
            "sha": "a4ea97f104e564ad15ecd50c1d821d0f9e4581a5",
            "filename": "test/parallel/test-tls-pfx-authorizationerror.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/db35fee1e1ca909f0f33940c0d9501a72baf2375/test%2Fparallel%2Ftest-tls-pfx-authorizationerror.js",
            "raw_url": "https://github.com/nodejs/node/raw/db35fee1e1ca909f0f33940c0d9501a72baf2375/test%2Fparallel%2Ftest-tls-pfx-authorizationerror.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-pfx-authorizationerror.js?ref=db35fee1e1ca909f0f33940c0d9501a72baf2375",
            "patch": "@@ -22,6 +22,8 @@ const server = tls\n       rejectUnauthorized: false\n     },\n     common.mustCall(function(c) {\n+      assert.strictEqual(c.getPeerCertificate().serialNumber,\n+                         'FAD50CC6A07F516C');\n       assert.strictEqual(c.authorizationError, null);\n       c.end();\n     })\n@@ -35,6 +37,8 @@ const server = tls\n         rejectUnauthorized: false\n       },\n       function() {\n+        assert.strictEqual(client.getCertificate().serialNumber,\n+                           'FAD50CC6A07F516C');\n         client.end();\n         server.close();\n       }"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 69,
        "deletions": 5
    }
}