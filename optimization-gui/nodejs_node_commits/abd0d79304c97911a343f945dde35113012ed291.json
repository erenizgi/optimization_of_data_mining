{
    "author": "devsnek",
    "message": "loader: fix --inspect-brk\n\nPR-URL: https://github.com/nodejs/node/pull/18949\nFixes: https://github.com/nodejs/node/issues/18948\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: Guy Bedford <guybedford@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Eugene Ostroukhov <eostroukhov@google.com>\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "abd0d79304c97911a343f945dde35113012ed291",
    "files": [
        {
            "sha": "f79cc6cfe1d94ab5fdd305c50b0208a0cbf1f554",
            "filename": "lib/internal/loader/ModuleJob.js",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/nodejs/node/blob/abd0d79304c97911a343f945dde35113012ed291/lib%2Finternal%2Floader%2FModuleJob.js",
            "raw_url": "https://github.com/nodejs/node/raw/abd0d79304c97911a343f945dde35113012ed291/lib%2Finternal%2Floader%2FModuleJob.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Floader%2FModuleJob.js?ref=abd0d79304c97911a343f945dde35113012ed291",
            "patch": "@@ -15,6 +15,7 @@ class ModuleJob {\n     this.loader = loader;\n     this.error = null;\n     this.hadError = false;\n+    this.inspectBrk = inspectBrk;\n \n     // This is a Promise<{ module, reflect }>, whose fields will be copied\n     // onto `this` by `link()` below once it has been resolved.\n@@ -26,10 +27,6 @@ class ModuleJob {\n     const link = async () => {\n       ({ module: this.module,\n          reflect: this.reflect } = await this.modulePromise);\n-      if (inspectBrk) {\n-        const initWrapper = process.binding('inspector').callAndPauseOnStart;\n-        initWrapper(this.module.instantiate, this.module);\n-      }\n       assert(this.module instanceof ModuleWrap);\n \n       const dependencyJobs = [];\n@@ -83,7 +80,12 @@ class ModuleJob {\n       throw e;\n     }\n     try {\n-      this.module.instantiate();\n+      if (this.inspectBrk) {\n+        const initWrapper = process.binding('inspector').callAndPauseOnStart;\n+        initWrapper(this.module.instantiate, this.module);\n+      } else {\n+        this.module.instantiate();\n+      }\n     } catch (e) {\n       decorateErrorStack(e);\n       throw e;"
        },
        {
            "sha": "1b5cab10edc7bf8dbbb430f168c0f56bfbedce53",
            "filename": "test/fixtures/es-modules/loop.mjs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/abd0d79304c97911a343f945dde35113012ed291/test%2Ffixtures%2Fes-modules%2Floop.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/abd0d79304c97911a343f945dde35113012ed291/test%2Ffixtures%2Fes-modules%2Floop.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fes-modules%2Floop.mjs?ref=abd0d79304c97911a343f945dde35113012ed291",
            "patch": "@@ -1,6 +1,8 @@\n+import { message } from './message';\n+\n var t = 1;\n var k = 1;\n-console.log('A message', 5);\n+console.log(message, 5);\n while (t > 0) {\n   if (t++ === 1000) {\n     t = 0;"
        },
        {
            "sha": "d50f57b7b6a5f71134de1ff2656de41d2b9c0a86",
            "filename": "test/fixtures/es-modules/message.mjs",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/abd0d79304c97911a343f945dde35113012ed291/test%2Ffixtures%2Fes-modules%2Fmessage.mjs",
            "raw_url": "https://github.com/nodejs/node/raw/abd0d79304c97911a343f945dde35113012ed291/test%2Ffixtures%2Fes-modules%2Fmessage.mjs",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Ffixtures%2Fes-modules%2Fmessage.mjs?ref=abd0d79304c97911a343f945dde35113012ed291",
            "patch": "@@ -0,0 +1 @@\n+export const message = 'A message';"
        },
        {
            "sha": "3171da58cf7a4c1fc922e15307490d5517d4b7cd",
            "filename": "test/parallel/test-inspector-esm.js",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/abd0d79304c97911a343f945dde35113012ed291/test%2Fparallel%2Ftest-inspector-esm.js",
            "raw_url": "https://github.com/nodejs/node/raw/abd0d79304c97911a343f945dde35113012ed291/test%2Fparallel%2Ftest-inspector-esm.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-inspector-esm.js?ref=abd0d79304c97911a343f945dde35113012ed291",
            "patch": "@@ -5,6 +5,7 @@ const common = require('../common');\n common.skipIfInspectorDisabled();\n \n const assert = require('assert');\n+const { resolve: UrlResolve } = require('url');\n const fixtures = require('../common/fixtures');\n const { NodeInstance } = require('../common/inspector-helper.js');\n \n@@ -43,14 +44,15 @@ async function testBreakpointOnStart(session) {\n   ];\n \n   await session.send(commands);\n-  await session.waitForBreakOnLine(0, session.scriptURL());\n+  await session.waitForBreakOnLine(\n+    0, UrlResolve(session.scriptURL().toString(), 'message.mjs'));\n }\n \n async function testBreakpoint(session) {\n   console.log('[test]', 'Setting a breakpoint and verifying it is hit');\n   const commands = [\n     { 'method': 'Debugger.setBreakpointByUrl',\n-      'params': { 'lineNumber': 5,\n+      'params': { 'lineNumber': 7,\n                   'url': session.scriptURL(),\n                   'columnNumber': 0,\n                   'condition': ''\n@@ -66,7 +68,7 @@ async function testBreakpoint(session) {\n          `Script source is wrong: ${scriptSource}`);\n \n   await session.waitForConsoleOutput('log', ['A message', 5]);\n-  const paused = await session.waitForBreakOnLine(5, session.scriptURL());\n+  const paused = await session.waitForBreakOnLine(7, session.scriptURL());\n   const scopeId = paused.params.callFrames[0].scopeChain[0].object.objectId;\n \n   console.log('[test]', 'Verify we can read current application state');\n@@ -79,7 +81,7 @@ async function testBreakpoint(session) {\n       'generatePreview': true\n     }\n   });\n-  assertScopeValues(response, { t: 1001, k: 1 });\n+  assertScopeValues(response, { t: 1001, k: 1, message: 'A message' });\n \n   let { result } = await session.send({\n     'method': 'Debugger.evaluateOnCallFrame', 'params': {"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 17,
        "deletions": 10
    }
}