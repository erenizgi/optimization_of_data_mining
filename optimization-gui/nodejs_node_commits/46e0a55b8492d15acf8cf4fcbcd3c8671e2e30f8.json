{
    "author": "tniessen",
    "message": "stream: add type and range check for highWaterMark\n\nThe (h|readableH|writableH)ighWaterMark options should only permit\npositive numbers and zero.\n\nPR-URL: https://github.com/nodejs/node/pull/18098\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8",
    "files": [
        {
            "sha": "fb0fbbbdf4d83be261aa02bfc65e431957f6508c",
            "filename": "lib/_stream_readable.js",
            "status": "modified",
            "additions": 3,
            "deletions": 13,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/lib%2F_stream_readable.js",
            "raw_url": "https://github.com/nodejs/node/raw/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/lib%2F_stream_readable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_readable.js?ref=46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8",
            "patch": "@@ -31,6 +31,7 @@ const util = require('util');\n const debug = util.debuglog('stream');\n const BufferList = require('internal/streams/BufferList');\n const destroyImpl = require('internal/streams/destroy');\n+const { getHighWaterMark } = require('internal/streams/state');\n const errors = require('internal/errors');\n const ReadableAsyncIterator = require('internal/streams/async_iterator');\n const { emitExperimentalWarning } = require('internal/util');\n@@ -77,19 +78,8 @@ function ReadableState(options, stream) {\n \n   // the point at which it stops calling _read() to fill the buffer\n   // Note: 0 is a valid value, means \"don't call _read preemptively ever\"\n-  var hwm = options.highWaterMark;\n-  var readableHwm = options.readableHighWaterMark;\n-  var defaultHwm = this.objectMode ? 16 : 16 * 1024;\n-\n-  if (hwm || hwm === 0)\n-    this.highWaterMark = hwm;\n-  else if (isDuplex && (readableHwm || readableHwm === 0))\n-    this.highWaterMark = readableHwm;\n-  else\n-    this.highWaterMark = defaultHwm;\n-\n-  // cast to ints.\n-  this.highWaterMark = Math.floor(this.highWaterMark);\n+  this.highWaterMark = getHighWaterMark(this, options, 'readableHighWaterMark',\n+                                        isDuplex);\n \n   // A linked list is used to store data chunks instead of an array because the\n   // linked list can remove elements from the beginning faster than"
        },
        {
            "sha": "de96a902552fe7ef5ca8c4627065f5327b916c3b",
            "filename": "lib/_stream_writable.js",
            "status": "modified",
            "additions": 3,
            "deletions": 13,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/lib%2F_stream_writable.js",
            "raw_url": "https://github.com/nodejs/node/raw/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/lib%2F_stream_writable.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_stream_writable.js?ref=46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8",
            "patch": "@@ -33,6 +33,7 @@ const internalUtil = require('internal/util');\n const Stream = require('stream');\n const { Buffer } = require('buffer');\n const destroyImpl = require('internal/streams/destroy');\n+const { getHighWaterMark } = require('internal/streams/state');\n const errors = require('internal/errors');\n \n util.inherits(Writable, Stream);\n@@ -59,19 +60,8 @@ function WritableState(options, stream) {\n   // the point at which write() starts returning false\n   // Note: 0 is a valid value, means that we always return false if\n   // the entire buffer is not flushed immediately on write()\n-  var hwm = options.highWaterMark;\n-  var writableHwm = options.writableHighWaterMark;\n-  var defaultHwm = this.objectMode ? 16 : 16 * 1024;\n-\n-  if (hwm || hwm === 0)\n-    this.highWaterMark = hwm;\n-  else if (isDuplex && (writableHwm || writableHwm === 0))\n-    this.highWaterMark = writableHwm;\n-  else\n-    this.highWaterMark = defaultHwm;\n-\n-  // cast to ints.\n-  this.highWaterMark = Math.floor(this.highWaterMark);\n+  this.highWaterMark = getHighWaterMark(this, options, 'writableHighWaterMark',\n+                                        isDuplex);\n \n   // if _final has been called\n   this.finalCalled = false;"
        },
        {
            "sha": "cca79c93de49b5caf40ad7b2eff0858a5684e2b6",
            "filename": "lib/internal/streams/state.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/nodejs/node/blob/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/lib%2Finternal%2Fstreams%2Fstate.js",
            "raw_url": "https://github.com/nodejs/node/raw/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/lib%2Finternal%2Fstreams%2Fstate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fstreams%2Fstate.js?ref=46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8",
            "patch": "@@ -0,0 +1,26 @@\n+'use strict';\n+\n+const errors = require('internal/errors');\n+\n+function getHighWaterMark(state, options, duplexKey, isDuplex) {\n+  let hwm = options.highWaterMark;\n+  if (hwm != null) {\n+    if (typeof hwm !== 'number' || !(hwm >= 0))\n+      throw new errors.TypeError('ERR_INVALID_OPT_VALUE', 'highWaterMark', hwm);\n+    return Math.floor(hwm);\n+  } else if (isDuplex) {\n+    hwm = options[duplexKey];\n+    if (hwm != null) {\n+      if (typeof hwm !== 'number' || !(hwm >= 0))\n+        throw new errors.TypeError('ERR_INVALID_OPT_VALUE', duplexKey, hwm);\n+      return Math.floor(hwm);\n+    }\n+  }\n+\n+  // Default value\n+  return state.objectMode ? 16 : 16 * 1024;\n+}\n+\n+module.exports = {\n+  getHighWaterMark\n+};"
        },
        {
            "sha": "80418b3a8a6f703bef625b8927be1a46a67719a6",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8",
            "patch": "@@ -144,6 +144,7 @@\n       'lib/internal/streams/duplexpair.js',\n       'lib/internal/streams/legacy.js',\n       'lib/internal/streams/destroy.js',\n+      'lib/internal/streams/state.js',\n       'lib/internal/wrap_js_stream.js',\n       'deps/v8/tools/splaytree.js',\n       'deps/v8/tools/codemap.js',"
        },
        {
            "sha": "f931d4f6ceb928a893c561660ac07accd66cd2e9",
            "filename": "test/parallel/test-stream-transform-split-highwatermark.js",
            "status": "modified",
            "additions": 22,
            "deletions": 3,
            "changes": 25,
            "blob_url": "https://github.com/nodejs/node/blob/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/test%2Fparallel%2Ftest-stream-transform-split-highwatermark.js",
            "raw_url": "https://github.com/nodejs/node/raw/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/test%2Fparallel%2Ftest-stream-transform-split-highwatermark.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-stream-transform-split-highwatermark.js?ref=46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8",
            "patch": "@@ -1,5 +1,5 @@\n 'use strict';\n-require('../common');\n+const common = require('../common');\n const assert = require('assert');\n \n const { Transform, Readable, Writable } = require('stream');\n@@ -54,14 +54,33 @@ testTransform(0, 0, {\n   writableHighWaterMark: 777,\n });\n \n-// test undefined, null, NaN\n-[undefined, null, NaN].forEach((v) => {\n+// test undefined, null\n+[undefined, null].forEach((v) => {\n   testTransform(DEFAULT, DEFAULT, { readableHighWaterMark: v });\n   testTransform(DEFAULT, DEFAULT, { writableHighWaterMark: v });\n   testTransform(666, DEFAULT, { highWaterMark: v, readableHighWaterMark: 666 });\n   testTransform(DEFAULT, 777, { highWaterMark: v, writableHighWaterMark: 777 });\n });\n \n+// test NaN\n+{\n+  common.expectsError(() => {\n+    new Transform({ readableHighWaterMark: NaN });\n+  }, {\n+    type: TypeError,\n+    code: 'ERR_INVALID_OPT_VALUE',\n+    message: 'The value \"NaN\" is invalid for option \"readableHighWaterMark\"'\n+  });\n+\n+  common.expectsError(() => {\n+    new Transform({ writableHighWaterMark: NaN });\n+  }, {\n+    type: TypeError,\n+    code: 'ERR_INVALID_OPT_VALUE',\n+    message: 'The value \"NaN\" is invalid for option \"writableHighWaterMark\"'\n+  });\n+}\n+\n // test non Duplex streams ignore the options\n {\n   const r = new Readable({ readableHighWaterMark: 666 });"
        },
        {
            "sha": "377fe08e90d3f83542188dbfb1c6d3fd8983cfb3",
            "filename": "test/parallel/test-streams-highwatermark.js",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/test%2Fparallel%2Ftest-streams-highwatermark.js",
            "raw_url": "https://github.com/nodejs/node/raw/46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8/test%2Fparallel%2Ftest-streams-highwatermark.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-streams-highwatermark.js?ref=46e0a55b8492d15acf8cf4fcbcd3c8671e2e30f8",
            "patch": "@@ -1,8 +1,9 @@\n 'use strict';\n-require('../common');\n+const common = require('../common');\n \n // This test ensures that the stream implementation correctly handles values\n-// for highWaterMark which exceed the range of signed 32 bit integers.\n+// for highWaterMark which exceed the range of signed 32 bit integers and\n+// rejects invalid values.\n \n const assert = require('assert');\n const stream = require('stream');\n@@ -16,3 +17,15 @@ assert.strictEqual(readable._readableState.highWaterMark, ovfl);\n \n const writable = stream.Writable({ highWaterMark: ovfl });\n assert.strictEqual(writable._writableState.highWaterMark, ovfl);\n+\n+for (const invalidHwm of [true, false, '5', {}, -5, NaN]) {\n+  for (const type of [stream.Readable, stream.Writable]) {\n+    common.expectsError(() => {\n+      type({ highWaterMark: invalidHwm });\n+    }, {\n+      type: TypeError,\n+      code: 'ERR_INVALID_OPT_VALUE',\n+      message: `The value \"${invalidHwm}\" is invalid for option \"highWaterMark\"`\n+    });\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 70,
        "deletions": 31
    }
}