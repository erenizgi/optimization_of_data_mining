{
    "author": "santigimeno",
    "message": "cluster: fix inspector port assignment\n\nMake sure that inspector ports in cluster are inside the valid range:\n`[1024, 65535]`.\nFixes flaky `test-inspector-port-zero-cluster`.\n\nPR-URL: https://github.com/nodejs/node/pull/18696\nFixes: https://github.com/nodejs/node/issues/18303\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "45982de4184e66bb53577b9c07383189f3d83dde",
    "files": [
        {
            "sha": "3c6a398f1174339cde528632c0ce1b893f2f6274",
            "filename": "lib/internal/cluster/master.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/45982de4184e66bb53577b9c07383189f3d83dde/lib%2Finternal%2Fcluster%2Fmaster.js",
            "raw_url": "https://github.com/nodejs/node/raw/45982de4184e66bb53577b9c07383189f3d83dde/lib%2Finternal%2Fcluster%2Fmaster.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fcluster%2Fmaster.js?ref=45982de4184e66bb53577b9c07383189f3d83dde",
            "patch": "@@ -14,6 +14,7 @@ const intercom = new EventEmitter();\n const SCHED_NONE = 1;\n const SCHED_RR = 2;\n const { isLegalPort } = require('internal/net');\n+const [ minPort, maxPort ] = [ 1024, 65535 ];\n \n module.exports = cluster;\n \n@@ -119,6 +120,8 @@ function createWorkerProcess(id, env) {\n       }\n     } else {\n       inspectPort = process.debugPort + debugPortOffset;\n+      if (inspectPort > maxPort)\n+        inspectPort = inspectPort - maxPort + minPort - 1;\n       debugPortOffset++;\n     }\n "
        },
        {
            "sha": "87469aa7ff77c56526641dd846dad666d893e38e",
            "filename": "test/sequential/test-inspector-port-cluster.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/45982de4184e66bb53577b9c07383189f3d83dde/test%2Fsequential%2Ftest-inspector-port-cluster.js",
            "raw_url": "https://github.com/nodejs/node/raw/45982de4184e66bb53577b9c07383189f3d83dde/test%2Fsequential%2Ftest-inspector-port-cluster.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-port-cluster.js?ref=45982de4184e66bb53577b9c07383189f3d83dde",
            "patch": "@@ -24,6 +24,16 @@ function testRunnerMain() {\n     workers: [{ expectedPort: 9230 }]\n   });\n \n+  spawnMaster({\n+    execArgv: ['--inspect=65534'],\n+    workers: [\n+      { expectedPort: 65535 },\n+      { expectedPort: 1024 },\n+      { expectedPort: 1025 },\n+      { expectedPort: 1026 }\n+    ]\n+  });\n+\n   let port = debuggerPort + offset++ * 5;\n \n   spawnMaster({"
        },
        {
            "sha": "e522056571d1c2331fcf019415ad3c5ae54e46be",
            "filename": "test/sequential/test-inspector-port-zero-cluster.js",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/45982de4184e66bb53577b9c07383189f3d83dde/test%2Fsequential%2Ftest-inspector-port-zero-cluster.js",
            "raw_url": "https://github.com/nodejs/node/raw/45982de4184e66bb53577b9c07383189f3d83dde/test%2Fsequential%2Ftest-inspector-port-zero-cluster.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-inspector-port-zero-cluster.js?ref=45982de4184e66bb53577b9c07383189f3d83dde",
            "patch": "@@ -30,16 +30,14 @@ function serialFork() {\n if (cluster.isMaster) {\n   Promise.all([serialFork(), serialFork(), serialFork()])\n     .then(common.mustCall((ports) => {\n-      ports.push(process.debugPort);\n-      ports.sort();\n+      ports.splice(0, 0, process.debugPort);\n       // 4 = [master, worker1, worker2, worker3].length()\n       assert.strictEqual(ports.length, 4);\n       assert(ports.every((port) => port > 0));\n       assert(ports.every((port) => port < 65536));\n-      // Ports should be consecutive.\n-      assert.strictEqual(ports[0] + 1, ports[1]);\n-      assert.strictEqual(ports[1] + 1, ports[2]);\n-      assert.strictEqual(ports[2] + 1, ports[3]);\n+      assert.strictEqual(ports[0] === 65535 ? 1024 : ports[0] + 1, ports[1]);\n+      assert.strictEqual(ports[1] === 65535 ? 1024 : ports[1] + 1, ports[2]);\n+      assert.strictEqual(ports[2] === 65535 ? 1024 : ports[2] + 1, ports[3]);\n     }))\n     .catch(\n       (err) => {"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 17,
        "deletions": 6
    }
}