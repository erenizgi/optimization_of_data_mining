{
    "author": "bdistin",
    "message": "fs: ensure options.flag defaults to 'r' in readFile\n\nWhen passing {} or { encoding: 'utf8' } as options to readFile, the\nflag is not defaulted to 'r' unlike normal fs. This fix makes\nfs.promises.readFile() act consistent with fs.readFile().\n\nIt also fixes another issue with fs.promises.readfile() where it\nreturned a Buffer instead of an empty string when encoding is provided.\n\nPR-URL: https://github.com/nodejs/node/pull/20268\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ron Korving <ron@ronkorving.nl>\nReviewed-By: Trivikram Kamat <trivikr.dev@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "2cd3e61b2f222c1e9e396dce6310203fdd960143",
    "files": [
        {
            "sha": "8774f48e99ed22a8d7ea89561f27552aa12e5f50",
            "filename": "lib/internal/fs/promises.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/2cd3e61b2f222c1e9e396dce6310203fdd960143/lib%2Finternal%2Ffs%2Fpromises.js",
            "raw_url": "https://github.com/nodejs/node/raw/2cd3e61b2f222c1e9e396dce6310203fdd960143/lib%2Finternal%2Ffs%2Fpromises.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Ffs%2Fpromises.js?ref=2cd3e61b2f222c1e9e396dce6310203fdd960143",
            "patch": "@@ -138,7 +138,7 @@ async function readFileHandle(filehandle, options) {\n   }\n \n   if (size === 0)\n-    return Buffer.alloc(0);\n+    return options.encoding ? '' : Buffer.alloc(0);\n \n   if (size > kMaxLength)\n     throw new ERR_FS_FILE_TOO_LARGE(size);\n@@ -454,11 +454,12 @@ async function appendFile(path, data, options) {\n \n async function readFile(path, options) {\n   options = getOptions(options, { flag: 'r' });\n+  const flag = options.flag || 'r';\n \n   if (path instanceof FileHandle)\n     return readFileHandle(path, options);\n \n-  const fd = await open(path, options.flag, 0o666);\n+  const fd = await open(path, flag, 0o666);\n   return readFileHandle(fd, options).finally(fd.close.bind(fd));\n }\n "
        },
        {
            "sha": "24c17655c621351a7d88283ad270f11a58b64263",
            "filename": "test/parallel/test-fs-promises-readfile-empty.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/2cd3e61b2f222c1e9e396dce6310203fdd960143/test%2Fparallel%2Ftest-fs-promises-readfile-empty.js",
            "raw_url": "https://github.com/nodejs/node/raw/2cd3e61b2f222c1e9e396dce6310203fdd960143/test%2Fparallel%2Ftest-fs-promises-readfile-empty.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-promises-readfile-empty.js?ref=2cd3e61b2f222c1e9e396dce6310203fdd960143",
            "patch": "@@ -0,0 +1,19 @@\n+'use strict';\n+const common = require('../common');\n+\n+const assert = require('assert');\n+const { promises: fs } = require('fs');\n+const fixtures = require('../common/fixtures');\n+\n+const fn = fixtures.path('empty.txt');\n+\n+common.crashOnUnhandledRejection();\n+\n+fs.readFile(fn)\n+  .then(assert.ok);\n+\n+fs.readFile(fn, 'utf8')\n+  .then(assert.strictEqual.bind(this, ''));\n+\n+fs.readFile(fn, { encoding: 'utf8' })\n+  .then(assert.strictEqual.bind(this, ''));"
        },
        {
            "sha": "36eccfb116271366ca46a6c64dd6c4c7055610a4",
            "filename": "test/parallel/test-fs-readfile-empty.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/2cd3e61b2f222c1e9e396dce6310203fdd960143/test%2Fparallel%2Ftest-fs-readfile-empty.js",
            "raw_url": "https://github.com/nodejs/node/raw/2cd3e61b2f222c1e9e396dce6310203fdd960143/test%2Fparallel%2Ftest-fs-readfile-empty.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-readfile-empty.js?ref=2cd3e61b2f222c1e9e396dce6310203fdd960143",
            "patch": "@@ -38,5 +38,9 @@ fs.readFile(fn, 'utf8', function(err, data) {\n   assert.strictEqual('', data);\n });\n \n+fs.readFile(fn, { encoding: 'utf8' }, function(err, data) {\n+  assert.strictEqual('', data);\n+});\n+\n assert.ok(fs.readFileSync(fn));\n assert.strictEqual('', fs.readFileSync(fn, 'utf8'));"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 26,
        "deletions": 2
    }
}