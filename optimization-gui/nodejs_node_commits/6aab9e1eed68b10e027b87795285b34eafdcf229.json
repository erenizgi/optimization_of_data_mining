{
    "author": "Hannes-Magnusson-CK",
    "message": "crypto: add docs & tests for cert.pubkey & cert.fingerprint256\n\nInclude example on how to pin certificate and/or public key\n\nPR-URL: https://github.com/nodejs/node/pull/17690\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "6aab9e1eed68b10e027b87795285b34eafdcf229",
    "files": [
        {
            "sha": "da4dbb22abeedfacde4ba0a5e0c56e58d29dff98",
            "filename": "doc/api/https.md",
            "status": "modified",
            "additions": 92,
            "deletions": 0,
            "changes": 92,
            "blob_url": "https://github.com/nodejs/node/blob/6aab9e1eed68b10e027b87795285b34eafdcf229/doc%2Fapi%2Fhttps.md",
            "raw_url": "https://github.com/nodejs/node/raw/6aab9e1eed68b10e027b87795285b34eafdcf229/doc%2Fapi%2Fhttps.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttps.md?ref=6aab9e1eed68b10e027b87795285b34eafdcf229",
            "patch": "@@ -251,6 +251,98 @@ const req = https.request(options, (res) => {\n });\n ```\n \n+Example pinning on certificate fingerprint, or the public key (similar to `pin-sha256`):\n+\n+```js\n+const tls = require('tls');\n+const https = require('https');\n+const crypto = require('crypto');\n+\n+function sha256(s) {\n+  return crypto.createHash('sha256').update(s).digest('base64');\n+}\n+const options = {\n+  hostname: 'github.com',\n+  port: 443,\n+  path: '/',\n+  method: 'GET',\n+  checkServerIdentity: function(host, cert) {\n+    // Make sure the certificate is issued to the host we are connected to\n+    const err = tls.checkServerIdentity(host, cert);\n+    if (err) {\n+      return err;\n+    }\n+\n+    // Pin the public key, similar to HPKP pin-sha25 pinning\n+    const pubkey256 = 'pL1+qb9HTMRZJmuC/bB/ZI9d302BYrrqiVuRyW+DGrU=';\n+    if (sha256(cert.pubkey) !== pubkey256) {\n+      const msg = 'Certificate verification error: ' +\n+        `The public key of '${cert.subject.CN}' ` +\n+        'does not match our pinned fingerprint';\n+      return new Error(msg);\n+    }\n+\n+    // Pin the exact certificate, rather then the pub key\n+    const cert256 = '25:FE:39:32:D9:63:8C:8A:FC:A1:9A:29:87:' +\n+      'D8:3E:4C:1D:98:DB:71:E4:1A:48:03:98:EA:22:6A:BD:8B:93:16';\n+    if (cert.fingerprint256 !== cert256) {\n+      const msg = 'Certificate verification error: ' +\n+        `The certificate of '${cert.subject.CN}' ` +\n+        'does not match our pinned fingerprint';\n+      return new Error(msg);\n+    }\n+\n+    // This loop is informational only.\n+    // Print the certificate and public key fingerprints of all certs in the\n+    // chain. Its common to pin the public key of the issuer on the public\n+    // internet, while pinning the public key of the service in sensitive\n+    // environments.\n+    do {\n+      console.log('Subject Common Name:', cert.subject.CN);\n+      console.log('  Certificate SHA256 fingerprint:', cert.fingerprint256);\n+\n+      hash = crypto.createHash('sha256');\n+      console.log('  Public key ping-sha256:', sha256(cert.pubkey));\n+\n+      lastprint256 = cert.fingerprint256;\n+      cert = cert.issuerCertificate;\n+    } while (cert.fingerprint256 !== lastprint256);\n+\n+  },\n+};\n+\n+options.agent = new https.Agent(options);\n+const req = https.request(options, (res) => {\n+  console.log('All OK. Server matched our pinned cert or public key');\n+  console.log('statusCode:', res.statusCode);\n+  // Print the HPKP values\n+  console.log('headers:', res.headers['public-key-pins']);\n+\n+  res.on('data', (d) => {});\n+});\n+\n+req.on('error', (e) => {\n+  console.error(e.message);\n+});\n+req.end();\n+\n+```\n+ Outputs for example:\n+```text\n+Subject Common Name: github.com\n+  Certificate SHA256 fingerprint: 25:FE:39:32:D9:63:8C:8A:FC:A1:9A:29:87:D8:3E:4C:1D:98:DB:71:E4:1A:48:03:98:EA:22:6A:BD:8B:93:16\n+  Public key ping-sha256: pL1+qb9HTMRZJmuC/bB/ZI9d302BYrrqiVuRyW+DGrU=\n+Subject Common Name: DigiCert SHA2 Extended Validation Server CA\n+  Certificate SHA256 fingerprint: 40:3E:06:2A:26:53:05:91:13:28:5B:AF:80:A0:D4:AE:42:2C:84:8C:9F:78:FA:D0:1F:C9:4B:C5:B8:7F:EF:1A\n+  Public key ping-sha256: RRM1dGqnDFsCJXBTHky16vi1obOlCgFFn/yOhI/y+ho=\n+Subject Common Name: DigiCert High Assurance EV Root CA\n+  Certificate SHA256 fingerprint: 74:31:E5:F4:C3:C1:CE:46:90:77:4F:0B:61:E0:54:40:88:3B:A9:A0:1E:D0:0B:A6:AB:D7:80:6E:D3:B1:18:CF\n+  Public key ping-sha256: WoiWRyIOVNa9ihaBciRSC7XHjliYS9VwUGOIud4PB18=\n+All OK. Server matched our pinned cert or public key\n+statusCode: 200\n+headers: max-age=0; pin-sha256=\"WoiWRyIOVNa9ihaBciRSC7XHjliYS9VwUGOIud4PB18=\"; pin-sha256=\"RRM1dGqnDFsCJXBTHky16vi1obOlCgFFn/yOhI/y+ho=\"; pin-sha256=\"k2v657xBsOVe1PQRwOsHsw3bsGT2VzIqz5K+59sNQws=\"; pin-sha256=\"K87oWBWM9UZfyddvDfoxL+8lpNyoUB2ptGtn0fv6G2Q=\"; pin-sha256=\"IQBnNBEiFuhj+8x6X8XLgh01V9Ic5/V3IRQLNFFc7v4=\"; pin-sha256=\"iie1VXtL7HzAMF+/PVPR9xzT80kQxdZeJ+zduCB3uj0=\"; pin-sha256=\"LvRiGEjRqfzurezaWuj8Wie2gyHMrW5Q06LspMnox7A=\"; includeSubDomains\n+```\n+\n [`Agent`]: #https_class_https_agent\n [`URL`]: url.html#url_the_whatwg_url_api\n [`http.Agent`]: http.html#http_class_http_agent"
        },
        {
            "sha": "5cdab4cbd357cb2ba0c7f436a380bf030e5770ef",
            "filename": "doc/api/tls.md",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/6aab9e1eed68b10e027b87795285b34eafdcf229/doc%2Fapi%2Ftls.md",
            "raw_url": "https://github.com/nodejs/node/raw/6aab9e1eed68b10e027b87795285b34eafdcf229/doc%2Fapi%2Ftls.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Ftls.md?ref=6aab9e1eed68b10e027b87795285b34eafdcf229",
            "patch": "@@ -618,9 +618,11 @@ For example:\n   issuerCertificate:\n    { ... another certificate, possibly with a .issuerCertificate ... },\n   raw: < RAW DER buffer >,\n+  pubkey: < RAW DER buffer >,\n   valid_from: 'Nov 11 09:52:22 2009 GMT',\n   valid_to: 'Nov  6 09:52:22 2029 GMT',\n   fingerprint: '2A:7A:C2:DD:E5:F9:CC:53:72:35:99:7A:02:5A:71:38:52:EC:8A:DF',\n+  fingerprint256: '2A:7A:C2:DD:E5:F9:CC:53:72:35:99:7A:02:5A:71:38:52:EC:8A:DF:00:11:22:33:44:55:66:77:88:99:AA:BB',\n   serialNumber: 'B9B0D332A1AA5635' }\n ```\n \n@@ -786,12 +788,14 @@ similar to:\n      'OCSP - URI': [ 'http://ocsp.comodoca.com' ] },\n   modulus: 'B56CE45CB740B09A13F64AC543B712FF9EE8E4C284B542A1708A27E82A8D151CA178153E12E6DDA15BF70FFD96CB8A88618641BDFCCA03527E665B70D779C8A349A6F88FD4EF6557180BD4C98192872BCFE3AF56E863C09DDD8BC1EC58DF9D94F914F0369102B2870BECFA1348A0838C9C49BD1C20124B442477572347047506B1FCD658A80D0C44BCC16BC5C5496CFE6E4A8428EF654CD3D8972BF6E5BFAD59C93006830B5EB1056BBB38B53D1464FA6E02BFDF2FF66CD949486F0775EC43034EC2602AEFBF1703AD221DAA2A88353C3B6A688EFE8387811F645CEED7B3FE46E1F8B9F59FAD028F349B9BC14211D5830994D055EEA3D547911E07A0ADDEB8A82B9188E58720D95CD478EEC9AF1F17BE8141BE80906F1A339445A7EB5B285F68039B0F294598A7D1C0005FC22B5271B0752F58CCDEF8C8FD856FB7AE21C80B8A2CE983AE94046E53EDE4CB89F42502D31B5360771C01C80155918637490550E3F555E2EE75CC8C636DDE3633CFEDD62E91BF0F7688273694EEEBA20C2FC9F14A2A435517BC1D7373922463409AB603295CEB0BB53787A334C9CA3CA8B30005C5A62FC0715083462E00719A8FA3ED0A9828C3871360A73F8B04A4FC1E71302844E9BB9940B77E745C9D91F226D71AFCAD4B113AAF68D92B24DDB4A2136B55A1CD1ADF39605B63CB639038ED0F4C987689866743A68769CC55847E4A06D6E2E3F1',\n   exponent: '0x10001',\n+  pubkey: <Buffer ... >,\n   valid_from: 'Aug 14 00:00:00 2017 GMT',\n   valid_to: 'Nov 20 23:59:59 2019 GMT',\n   fingerprint: '01:02:59:D9:C3:D2:0D:08:F7:82:4E:44:A4:B4:53:C5:E2:3A:87:4D',\n+  fingerprint256: '69:AE:1A:6A:D4:3D:C6:C1:1B:EA:C6:23:DE:BA:2A:14:62:62:93:5C:7A:EA:06:41:9B:0B:BC:87:CE:48:4E:02',\n   ext_key_usage: [ '1.3.6.1.5.5.7.3.1', '1.3.6.1.5.5.7.3.2' ],\n   serialNumber: '66593D57F20CBC573E433381B5FEC280',\n-  raw: <Buffer ....> }\n+  raw: <Buffer ... > }\n ```\n \n ## tls.connect(options[, callback])"
        },
        {
            "sha": "e5de378675f29abffc54a034a044b4f8b5b9487e",
            "filename": "test/parallel/test-tls-peer-certificate.js",
            "status": "modified",
            "additions": 27,
            "deletions": 1,
            "changes": 28,
            "blob_url": "https://github.com/nodejs/node/blob/6aab9e1eed68b10e027b87795285b34eafdcf229/test%2Fparallel%2Ftest-tls-peer-certificate.js",
            "raw_url": "https://github.com/nodejs/node/raw/6aab9e1eed68b10e027b87795285b34eafdcf229/test%2Fparallel%2Ftest-tls-peer-certificate.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-peer-certificate.js?ref=6aab9e1eed68b10e027b87795285b34eafdcf229",
            "patch": "@@ -20,15 +20,23 @@\n // USE OR OTHER DEALINGS IN THE SOFTWARE.\n \n 'use strict';\n-require('../common');\n+const common = require('../common');\n const fixtures = require('../common/fixtures');\n+if (!common.hasCrypto) {\n+  common.skip('missing crypto');\n+}\n+const crypto = require('crypto');\n \n // Verify that detailed getPeerCertificate() return value has all certs.\n \n const {\n   assert, connect, debug, keys\n } = require(fixtures.path('tls-connect'));\n \n+function sha256(s) {\n+  return crypto.createHash('sha256').update(s);\n+}\n+\n connect({\n   client: { rejectUnauthorized: false },\n   server: keys.agent1,\n@@ -49,6 +57,24 @@ connect({\n     peerCert.fingerprint,\n     '8D:06:3A:B3:E5:8B:85:29:72:4F:7D:1B:54:CD:95:19:3C:EF:6F:AA'\n   );\n+  assert.strictEqual(\n+    peerCert.fingerprint256,\n+    'A1:DC:01:1A:EC:A3:7B:86:A8:C2:3E:26:9F:EB:EE:5C:A9:3B:BE:06' +\n+    ':4C:A4:00:53:93:A9:66:07:A7:BC:13:32'\n+  );\n+\n+  // SHA256 fingerprint of the public key\n+  assert.strictEqual(\n+    sha256(peerCert.pubkey).digest('hex'),\n+    'fa5152e4407bad1e7537ef5bfc3f19fa9a62ee04432fd75e109b1803704c31ba'\n+  );\n+\n+  // HPKP / RFC7469 \"pin-sha256\" of the public key\n+  assert.strictEqual(\n+    sha256(peerCert.pubkey).digest('base64'),\n+    '+lFS5EB7rR51N+9b/D8Z+ppi7gRDL9deEJsYA3BMMbo='\n+  );\n+\n   assert.deepStrictEqual(peerCert.infoAccess['OCSP - URI'],\n                          [ 'http://ocsp.nodejs.org/' ]);\n "
        }
    ],
    "stats": {
        "total": 126,
        "additions": 124,
        "deletions": 2
    }
}