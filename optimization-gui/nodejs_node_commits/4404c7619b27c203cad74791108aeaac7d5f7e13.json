{
    "author": "rvagg",
    "message": "http: process headers after setting up agent\n\nAdded tests to clarify the implicit behaviour of array header setting vs\nobject header setting\n\nPR-URL: https://github.com/nodejs/node/pull/16568\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "4404c7619b27c203cad74791108aeaac7d5f7e13",
    "files": [
        {
            "sha": "ebfd809e21e0a0c26834bfd49f1ae6531c795ee6",
            "filename": "lib/_http_client.js",
            "status": "modified",
            "additions": 48,
            "deletions": 43,
            "changes": 91,
            "blob_url": "https://github.com/nodejs/node/blob/4404c7619b27c203cad74791108aeaac7d5f7e13/lib%2F_http_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/4404c7619b27c203cad74791108aeaac7d5f7e13/lib%2F_http_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_client.js?ref=4404c7619b27c203cad74791108aeaac7d5f7e13",
            "patch": "@@ -132,6 +132,40 @@ function ClientRequest(options, cb) {\n     this.once('response', cb);\n   }\n \n+  if (method === 'GET' ||\n+      method === 'HEAD' ||\n+      method === 'DELETE' ||\n+      method === 'OPTIONS' ||\n+      method === 'CONNECT') {\n+    this.useChunkedEncodingByDefault = false;\n+  } else {\n+    this.useChunkedEncodingByDefault = true;\n+  }\n+\n+  this._ended = false;\n+  this.res = null;\n+  this.aborted = undefined;\n+  this.timeoutCb = null;\n+  this.upgradeOrConnect = false;\n+  this.parser = null;\n+  this.maxHeadersCount = null;\n+\n+  var called = false;\n+\n+  if (this.agent) {\n+    // If there is an agent we should default to Connection:keep-alive,\n+    // but only if the Agent will actually reuse the connection!\n+    // If it's not a keepAlive agent, and the maxSockets==Infinity, then\n+    // there's never a case where this socket will actually be reused\n+    if (!this.agent.keepAlive && !Number.isFinite(this.agent.maxSockets)) {\n+      this._last = true;\n+      this.shouldKeepAlive = false;\n+    } else {\n+      this._last = false;\n+      this.shouldKeepAlive = true;\n+    }\n+  }\n+\n   var headersArray = Array.isArray(options.headers);\n   if (!headersArray) {\n     if (options.headers) {\n@@ -141,6 +175,7 @@ function ClientRequest(options, cb) {\n         this.setHeader(key, options.headers[key]);\n       }\n     }\n+\n     if (host && !this.getHeader('host') && setHost) {\n       var hostHeader = host;\n \n@@ -159,45 +194,25 @@ function ClientRequest(options, cb) {\n       }\n       this.setHeader('Host', hostHeader);\n     }\n-  }\n \n-  if (options.auth && !this.getHeader('Authorization')) {\n-    this.setHeader('Authorization', 'Basic ' +\n-                   Buffer.from(options.auth).toString('base64'));\n-  }\n+    if (options.auth && !this.getHeader('Authorization')) {\n+      this.setHeader('Authorization', 'Basic ' +\n+                     Buffer.from(options.auth).toString('base64'));\n+    }\n \n-  if (method === 'GET' ||\n-      method === 'HEAD' ||\n-      method === 'DELETE' ||\n-      method === 'OPTIONS' ||\n-      method === 'CONNECT') {\n-    this.useChunkedEncodingByDefault = false;\n-  } else {\n-    this.useChunkedEncodingByDefault = true;\n-  }\n+    if (this.getHeader('expect')) {\n+      if (this._header) {\n+        throw new errors.Error('ERR_HTTP_HEADERS_SENT', 'render');\n+      }\n \n-  if (headersArray) {\n-    this._storeHeader(this.method + ' ' + this.path + ' HTTP/1.1\\r\\n',\n-                      options.headers);\n-  } else if (this.getHeader('expect')) {\n-    if (this._header) {\n-      throw new errors.Error('ERR_HTTP_HEADERS_SENT', 'render');\n+      this._storeHeader(this.method + ' ' + this.path + ' HTTP/1.1\\r\\n',\n+                        this[outHeadersKey]);\n     }\n-\n+  } else {\n     this._storeHeader(this.method + ' ' + this.path + ' HTTP/1.1\\r\\n',\n-                      this[outHeadersKey]);\n+                      options.headers);\n   }\n \n-  this._ended = false;\n-  this.res = null;\n-  this.aborted = undefined;\n-  this.timeoutCb = null;\n-  this.upgradeOrConnect = false;\n-  this.parser = null;\n-  this.maxHeadersCount = null;\n-\n-  var called = false;\n-\n   var oncreate = (err, socket) => {\n     if (called)\n       return;\n@@ -210,18 +225,8 @@ function ClientRequest(options, cb) {\n     this._deferToConnect(null, null, () => this._flush());\n   };\n \n+  // initiate connection\n   if (this.agent) {\n-    // If there is an agent we should default to Connection:keep-alive,\n-    // but only if the Agent will actually reuse the connection!\n-    // If it's not a keepAlive agent, and the maxSockets==Infinity, then\n-    // there's never a case where this socket will actually be reused\n-    if (!this.agent.keepAlive && !Number.isFinite(this.agent.maxSockets)) {\n-      this._last = true;\n-      this.shouldKeepAlive = false;\n-    } else {\n-      this._last = false;\n-      this.shouldKeepAlive = true;\n-    }\n     this.agent.addRequest(this, options);\n   } else {\n     // No agent, default to Connection:close."
        },
        {
            "sha": "dffe04bb1084018801c8d3b9dea04be98887a19c",
            "filename": "test/parallel/test-http-client-headers-array.js",
            "status": "added",
            "additions": 60,
            "deletions": 0,
            "changes": 60,
            "blob_url": "https://github.com/nodejs/node/blob/4404c7619b27c203cad74791108aeaac7d5f7e13/test%2Fparallel%2Ftest-http-client-headers-array.js",
            "raw_url": "https://github.com/nodejs/node/raw/4404c7619b27c203cad74791108aeaac7d5f7e13/test%2Fparallel%2Ftest-http-client-headers-array.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-client-headers-array.js?ref=4404c7619b27c203cad74791108aeaac7d5f7e13",
            "patch": "@@ -0,0 +1,60 @@\n+'use strict';\n+\n+require('../common');\n+\n+const assert = require('assert');\n+const http = require('http');\n+\n+function execute(options) {\n+  http.createServer(function(req, res) {\n+    const expectHeaders = {\n+      'x-foo': 'boom',\n+      cookie: 'a=1; b=2; c=3',\n+      connection: 'close'\n+    };\n+\n+    // no Host header when you set headers an array\n+    if (!Array.isArray(options.headers)) {\n+      expectHeaders.host = `localhost:${this.address().port}`;\n+    }\n+\n+    // no Authorization header when you set headers an array\n+    if (options.auth && !Array.isArray(options.headers)) {\n+      expectHeaders.authorization =\n+          `Basic ${Buffer.from(options.auth).toString('base64')}`;\n+    }\n+\n+    this.close();\n+\n+    assert.deepStrictEqual(req.headers, expectHeaders);\n+\n+    res.end();\n+  }).listen(0, function() {\n+    options = Object.assign(options, {\n+      port: this.address().port,\n+      path: '/'\n+    });\n+    const req = http.request(options);\n+    req.end();\n+  });\n+}\n+\n+// should be the same except for implicit Host header on the first two\n+execute({ headers: { 'x-foo': 'boom', 'cookie': 'a=1; b=2; c=3' } });\n+execute({ headers: { 'x-foo': 'boom', 'cookie': [ 'a=1', 'b=2', 'c=3' ] } });\n+execute({ headers: [[ 'x-foo', 'boom' ], [ 'cookie', 'a=1; b=2; c=3' ]] });\n+execute({ headers: [\n+  [ 'x-foo', 'boom' ], [ 'cookie', [ 'a=1', 'b=2', 'c=3' ]]\n+] });\n+execute({ headers: [\n+  [ 'x-foo', 'boom' ], [ 'cookie', 'a=1' ],\n+  [ 'cookie', 'b=2' ], [ 'cookie', 'c=3']\n+] });\n+\n+// Authorization and Host header both missing from the second\n+execute({ auth: 'foo:bar', headers:\n+  { 'x-foo': 'boom', 'cookie': 'a=1; b=2; c=3' } });\n+execute({ auth: 'foo:bar', headers: [\n+  [ 'x-foo', 'boom' ], [ 'cookie', 'a=1' ],\n+  [ 'cookie', 'b=2' ], [ 'cookie', 'c=3']\n+] });"
        }
    ],
    "stats": {
        "total": 151,
        "additions": 108,
        "deletions": 43
    }
}