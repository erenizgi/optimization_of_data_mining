{
    "author": "addaleax",
    "message": "src: protect global state with mutexes\n\nProtect environment variables and inherently per-process state with\nmutexes, to better accommodate Nodeâ€™s usage in\nmulti-threading environments.\n\nThanks to Stephen Belanger for reviewing this change in its original PR.\n\nRefs: https://github.com/ayojs/ayo/pull/82\nPR-URL: https://github.com/nodejs/node/pull/20542\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ben Noordhuis <info@bnoordhuis.nl>",
    "sha": "2c52f656bd95f1809ac1f75cfd55cf0563301279",
    "files": [
        {
            "sha": "d71303570b1a5664b68ba0c793a64f0b9527ed0d",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/nodejs/node/blob/2c52f656bd95f1809ac1f75cfd55cf0563301279/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2c52f656bd95f1809ac1f75cfd55cf0563301279/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=2c52f656bd95f1809ac1f75cfd55cf0563301279",
            "patch": "@@ -172,6 +172,9 @@ using v8::Value;\n \n using AsyncHooks = Environment::AsyncHooks;\n \n+static Mutex process_mutex;\n+static Mutex environ_mutex;\n+\n static bool print_eval = false;\n static bool force_repl = false;\n static bool syntax_check_only = false;\n@@ -699,9 +702,12 @@ bool SafeGetenv(const char* key, std::string* text) {\n     goto fail;\n #endif\n \n-  if (const char* value = getenv(key)) {\n-    *text = value;\n-    return true;\n+  {\n+    Mutex::ScopedLock lock(environ_mutex);\n+    if (const char* value = getenv(key)) {\n+      *text = value;\n+      return true;\n+    }\n   }\n \n fail:\n@@ -1359,6 +1365,7 @@ void AppendExceptionLine(Environment* env,\n   if (!can_set_arrow || (mode == FATAL_ERROR && !err_obj->IsNativeError())) {\n     if (env->printed_error())\n       return;\n+    Mutex::ScopedLock lock(process_mutex);\n     env->set_printed_error(true);\n \n     uv_tty_reset_mode();\n@@ -2610,7 +2617,6 @@ static void ProcessTitleSetter(Local<Name> property,\n                                Local<Value> value,\n                                const PropertyCallbackInfo<void>& info) {\n   node::Utf8Value title(info.GetIsolate(), value);\n-  // TODO(piscisaureus): protect with a lock\n   uv_set_process_title(*title);\n }\n \n@@ -2621,6 +2627,7 @@ static void EnvGetter(Local<Name> property,\n   if (property->IsSymbol()) {\n     return info.GetReturnValue().SetUndefined();\n   }\n+  Mutex::ScopedLock lock(environ_mutex);\n #ifdef __POSIX__\n   node::Utf8Value key(isolate, property);\n   const char* val = getenv(*key);\n@@ -2661,6 +2668,8 @@ static void EnvSetter(Local<Name> property,\n           \"DEP0104\").IsNothing())\n       return;\n   }\n+\n+  Mutex::ScopedLock lock(environ_mutex);\n #ifdef __POSIX__\n   node::Utf8Value key(info.GetIsolate(), property);\n   node::Utf8Value val(info.GetIsolate(), value);\n@@ -2681,6 +2690,7 @@ static void EnvSetter(Local<Name> property,\n \n static void EnvQuery(Local<Name> property,\n                      const PropertyCallbackInfo<Integer>& info) {\n+  Mutex::ScopedLock lock(environ_mutex);\n   int32_t rc = -1;  // Not found unless proven otherwise.\n   if (property->IsString()) {\n #ifdef __POSIX__\n@@ -2710,6 +2720,7 @@ static void EnvQuery(Local<Name> property,\n \n static void EnvDeleter(Local<Name> property,\n                        const PropertyCallbackInfo<Boolean>& info) {\n+  Mutex::ScopedLock lock(environ_mutex);\n   if (property->IsString()) {\n #ifdef __POSIX__\n     node::Utf8Value key(info.GetIsolate(), property);\n@@ -2735,6 +2746,7 @@ static void EnvEnumerator(const PropertyCallbackInfo<Array>& info) {\n   Local<Value> argv[NODE_PUSH_VAL_TO_ARRAY_MAX];\n   size_t idx = 0;\n \n+  Mutex::ScopedLock lock(environ_mutex);\n #ifdef __POSIX__\n   int size = 0;\n   while (environ[size])\n@@ -2850,6 +2862,7 @@ static Local<Object> GetFeatures(Environment* env) {\n \n static void DebugPortGetter(Local<Name> property,\n                             const PropertyCallbackInfo<Value>& info) {\n+  Mutex::ScopedLock lock(process_mutex);\n   int port = debug_options.port();\n #if HAVE_INSPECTOR\n   if (port == 0) {\n@@ -2865,6 +2878,7 @@ static void DebugPortGetter(Local<Name> property,\n static void DebugPortSetter(Local<Name> property,\n                             Local<Value> value,\n                             const PropertyCallbackInfo<void>& info) {\n+  Mutex::ScopedLock lock(process_mutex);\n   debug_options.set_port(value->Int32Value());\n }\n "
        },
        {
            "sha": "f611f81f16a819859cb6175856413fd92b28e0e4",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/2c52f656bd95f1809ac1f75cfd55cf0563301279/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/2c52f656bd95f1809ac1f75cfd55cf0563301279/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=2c52f656bd95f1809ac1f75cfd55cf0563301279",
            "patch": "@@ -721,6 +721,9 @@ void SecureContext::SetCert(const FunctionCallbackInfo<Value>& args) {\n \n static X509_STORE* NewRootCertStore() {\n   static std::vector<X509*> root_certs_vector;\n+  static Mutex root_certs_vector_mutex;\n+  Mutex::ScopedLock lock(root_certs_vector_mutex);\n+\n   if (root_certs_vector.empty()) {\n     for (size_t i = 0; i < arraysize(root_certs); i++) {\n       BIO* bp = NodeBIO::NewFixed(root_certs[i], strlen(root_certs[i]));"
        },
        {
            "sha": "e15df78ffdfee3067773bc18a0eff5e7352e6475",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/2c52f656bd95f1809ac1f75cfd55cf0563301279/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/2c52f656bd95f1809ac1f75cfd55cf0563301279/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=2c52f656bd95f1809ac1f75cfd55cf0563301279",
            "patch": "@@ -25,6 +25,7 @@\n #if defined(NODE_WANT_INTERNALS) && NODE_WANT_INTERNALS\n \n #include \"node.h\"\n+#include \"node_mutex.h\"\n #include \"node_persistent.h\"\n #include \"util-inl.h\"\n #include \"env-inl.h\""
        }
    ],
    "stats": {
        "total": 26,
        "additions": 22,
        "deletions": 4
    }
}