{
    "author": "joyeecheung",
    "message": "http2: remove pushValueToArray in Http2Session::HandleHeadersFrame\n\nInstead of calling into JS from C++ to push values into an array,\nuse the new Array::New API that takes a pointer and a length\ndirectly.\n\nPR-URL: https://github.com/nodejs/node/pull/24264\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>",
    "sha": "5b97e31f72d2af0bffd15463f365e9f526e173f0",
    "files": [
        {
            "sha": "e50cbfd939d6186fab74683e8b31b0ce4b33459d",
            "filename": "src/node_http2.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 29,
            "changes": 43,
            "blob_url": "https://github.com/nodejs/node/blob/5b97e31f72d2af0bffd15463f365e9f526e173f0/src%2Fnode_http2.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5b97e31f72d2af0bffd15463f365e9f526e173f0/src%2Fnode_http2.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http2.cc?ref=5b97e31f72d2af0bffd15463f365e9f526e173f0",
            "patch": "@@ -1292,45 +1292,30 @@ void Http2Session::HandleHeadersFrame(const nghttp2_frame* frame) {\n   Local<String> value_str;\n \n   Local<Array> holder = Array::New(isolate);\n-  Local<Function> fn = env()->push_values_to_array_function();\n-  Local<Value> argv[NODE_PUSH_VAL_TO_ARRAY_MAX * 2];\n-\n   // The headers are passed in above as a queue of nghttp2_header structs.\n   // The following converts that into a JS array with the structure:\n   // [name1, value1, name2, value2, name3, value3, name3, value4] and so on.\n   // That array is passed up to the JS layer and converted into an Object form\n   // like {name1: value1, name2: value2, name3: [value3, value4]}. We do it\n   // this way for performance reasons (it's faster to generate and pass an\n   // array than it is to generate and pass the object).\n-  size_t n = 0;\n-  while (n < headers.size()) {\n-    size_t j = 0;\n-    while (n < headers.size() && j < arraysize(argv) / 2) {\n-      nghttp2_header item = headers[n++];\n-      // The header name and value are passed as external one-byte strings\n-      name_str =\n-          ExternalHeader::New<true>(this, item.name).ToLocalChecked();\n-      value_str =\n-          ExternalHeader::New<false>(this, item.value).ToLocalChecked();\n-      argv[j * 2] = name_str;\n-      argv[j * 2 + 1] = value_str;\n-      j++;\n-    }\n-    // For performance, we pass name and value pairs to array.protototype.push\n-    // in batches of size NODE_PUSH_VAL_TO_ARRAY_MAX * 2 until there are no\n-    // more items to push.\n-    if (j > 0) {\n-      fn->Call(env()->context(), holder, j * 2, argv).ToLocalChecked();\n-    }\n+  size_t headers_size = headers.size();\n+  std::vector<Local<Value>> headers_v(headers_size * 2);\n+  for (size_t i = 0; i < headers_size; ++i) {\n+    const nghttp2_header& item = headers[i];\n+    // The header name and value are passed as external one-byte strings\n+    headers_v[i * 2] =\n+        ExternalHeader::New<true>(this, item.name).ToLocalChecked();\n+    headers_v[i * 2 + 1] =\n+        ExternalHeader::New<false>(this, item.value).ToLocalChecked();\n   }\n \n   Local<Value> args[5] = {\n-    stream->object(),\n-    Integer::New(isolate, id),\n-    Integer::New(isolate, stream->headers_category()),\n-    Integer::New(isolate, frame->hd.flags),\n-    holder\n-  };\n+      stream->object(),\n+      Integer::New(isolate, id),\n+      Integer::New(isolate, stream->headers_category()),\n+      Integer::New(isolate, frame->hd.flags),\n+      Array::New(isolate, headers_v.data(), headers_size * 2)};\n   MakeCallback(env()->onheaders_string(), arraysize(args), args);\n }\n "
        }
    ],
    "stats": {
        "total": 43,
        "additions": 14,
        "deletions": 29
    }
}