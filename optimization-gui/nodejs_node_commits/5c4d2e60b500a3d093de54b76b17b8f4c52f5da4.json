{
    "author": "addaleax",
    "message": "src: simplify handle closing\n\nRemove one extra closing state and use a smart pointer for\ndeleting `HandleWrap`s.\n\nPR-URL: https://github.com/nodejs/node/pull/20876\nReviewed-By: Gireesh Punathil <gpunathi@in.ibm.com>\nReviewed-By: Benjamin Gruenbaum <benjamingr@gmail.com>\nReviewed-By: Shingo Inoue <leko.noor@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Tiancheng \"Timothy\" Gu <timothygu99@gmail.com>\nReviewed-By: John-David Dalton <john.david.dalton@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>",
    "sha": "5c4d2e60b500a3d093de54b76b17b8f4c52f5da4",
    "files": [
        {
            "sha": "bbc124ff69dc89f8f6d2c2ffb970df9ab3894246",
            "filename": "src/handle_wrap.cc",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/5c4d2e60b500a3d093de54b76b17b8f4c52f5da4/src%2Fhandle_wrap.cc",
            "raw_url": "https://github.com/nodejs/node/raw/5c4d2e60b500a3d093de54b76b17b8f4c52f5da4/src%2Fhandle_wrap.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fhandle_wrap.cc?ref=5c4d2e60b500a3d093de54b76b17b8f4c52f5da4",
            "patch": "@@ -67,7 +67,7 @@ void HandleWrap::Close(const FunctionCallbackInfo<Value>& args) {\n   wrap->Close(args[0]);\n }\n \n-void HandleWrap::Close(v8::Local<v8::Value> close_callback) {\n+void HandleWrap::Close(Local<Value> close_callback) {\n   if (state_ != kInitialized)\n     return;\n \n@@ -77,8 +77,7 @@ void HandleWrap::Close(v8::Local<v8::Value> close_callback) {\n \n   if (!close_callback.IsEmpty() && close_callback->IsFunction()) {\n     object()->Set(env()->context(), env()->onclose_string(), close_callback)\n-        .FromJust();\n-    state_ = kClosingWithCallback;\n+        .FromMaybe(false);\n   }\n }\n \n@@ -109,24 +108,23 @@ HandleWrap::HandleWrap(Environment* env,\n \n \n void HandleWrap::OnClose(uv_handle_t* handle) {\n-  HandleWrap* wrap = static_cast<HandleWrap*>(handle->data);\n+  std::unique_ptr<HandleWrap> wrap { static_cast<HandleWrap*>(handle->data) };\n   Environment* env = wrap->env();\n   HandleScope scope(env->isolate());\n   Context::Scope context_scope(env->context());\n \n   // The wrap object should still be there.\n   CHECK_EQ(wrap->persistent().IsEmpty(), false);\n-  CHECK(wrap->state_ >= kClosing && wrap->state_ <= kClosingWithCallback);\n+  CHECK_EQ(wrap->state_, kClosing);\n \n-  const bool have_close_callback = (wrap->state_ == kClosingWithCallback);\n   wrap->state_ = kClosed;\n \n   wrap->OnClose();\n \n-  if (have_close_callback)\n+  if (wrap->object()->Has(env->context(), env->onclose_string())\n+      .FromMaybe(false)) {\n     wrap->MakeCallback(env->onclose_string(), 0, nullptr);\n-\n-  delete wrap;\n+  }\n }\n \n "
        },
        {
            "sha": "4e177d249f28b5c8aae988c615b956f5aee45935",
            "filename": "src/handle_wrap.h",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/5c4d2e60b500a3d093de54b76b17b8f4c52f5da4/src%2Fhandle_wrap.h",
            "raw_url": "https://github.com/nodejs/node/raw/5c4d2e60b500a3d093de54b76b17b8f4c52f5da4/src%2Fhandle_wrap.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fhandle_wrap.h?ref=5c4d2e60b500a3d093de54b76b17b8f4c52f5da4",
            "patch": "@@ -95,7 +95,7 @@ class HandleWrap : public AsyncWrap {\n   // refer to `doc/guides/node-postmortem-support.md`\n   friend int GenDebugSymbols();\n   ListNode<HandleWrap> handle_wrap_queue_;\n-  enum { kInitialized, kClosing, kClosingWithCallback, kClosed } state_;\n+  enum { kInitialized, kClosing, kClosed } state_;\n   uv_handle_t* const handle_;\n };\n "
        }
    ],
    "stats": {
        "total": 18,
        "additions": 8,
        "deletions": 10
    }
}