{
    "author": "devsnek",
    "message": "src: emit warnings from V8\n\nPR-URL: https://github.com/nodejs/node/pull/24365\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Refael Ackermann <refack@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>",
    "sha": "e1aa7301b4118a92a8f056d1bc02e6069886a913",
    "files": [
        {
            "sha": "f6ec033bbb190135bdeaa3686240392a64ebbcb9",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 30,
            "deletions": 7,
            "changes": 37,
            "blob_url": "https://github.com/nodejs/node/blob/e1aa7301b4118a92a8f056d1bc02e6069886a913/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e1aa7301b4118a92a8f056d1bc02e6069886a913/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=e1aa7301b4118a92a8f056d1bc02e6069886a913",
            "patch": "@@ -1078,12 +1078,6 @@ static void DLOpen(const FunctionCallbackInfo<Value>& args) {\n   // coverity[leaked_storage]\n }\n \n-static void OnMessage(Local<Message> message, Local<Value> error) {\n-  // The current version of V8 sends messages for errors only\n-  // (thus `error` is always set).\n-  FatalException(Isolate::GetCurrent(), error, message);\n-}\n-\n static Maybe<bool> ProcessEmitWarningGeneric(Environment* env,\n                                              const char* warning,\n                                              const char* type = nullptr,\n@@ -1160,6 +1154,33 @@ Maybe<bool> ProcessEmitDeprecationWarning(Environment* env,\n                                    deprecation_code);\n }\n \n+static void OnMessage(Local<Message> message, Local<Value> error) {\n+  Isolate* isolate = message->GetIsolate();\n+  switch (message->ErrorLevel()) {\n+    case Isolate::MessageErrorLevel::kMessageWarning: {\n+      Environment* env = Environment::GetCurrent(isolate);\n+      if (!env) {\n+        break;\n+      }\n+      Utf8Value filename(isolate,\n+          message->GetScriptOrigin().ResourceName());\n+      // (filename):(line) (message)\n+      std::stringstream warning;\n+      warning << *filename;\n+      warning << \":\";\n+      warning << message->GetLineNumber(env->context()).FromMaybe(-1);\n+      warning << \" \";\n+      v8::String::Utf8Value msg(isolate, message->Get());\n+      warning << *msg;\n+      USE(ProcessEmitWarningGeneric(env, warning.str().c_str(), \"V8\"));\n+      break;\n+    }\n+    case Isolate::MessageErrorLevel::kMessageError:\n+      FatalException(isolate, error, message);\n+      break;\n+  }\n+}\n+\n \n static Local<Object> InitModule(Environment* env,\n                                  node_module* mod,\n@@ -2583,7 +2604,9 @@ Isolate* NewIsolate(ArrayBufferAllocator* allocator, uv_loop_t* event_loop) {\n   v8_platform.Platform()->RegisterIsolate(isolate, event_loop);\n   Isolate::Initialize(isolate, params);\n \n-  isolate->AddMessageListener(OnMessage);\n+  isolate->AddMessageListenerWithErrorLevel(OnMessage,\n+      Isolate::MessageErrorLevel::kMessageError |\n+      Isolate::MessageErrorLevel::kMessageWarning);\n   isolate->SetAbortOnUncaughtExceptionCallback(ShouldAbortOnUncaughtException);\n   isolate->SetMicrotasksPolicy(MicrotasksPolicy::kExplicit);\n   isolate->SetFatalErrorHandler(OnFatalError);"
        },
        {
            "sha": "e3394cdd7094e87f9f7d390a1126ba86e0855a4f",
            "filename": "test/message/v8_warning.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/nodejs/node/blob/e1aa7301b4118a92a8f056d1bc02e6069886a913/test%2Fmessage%2Fv8_warning.js",
            "raw_url": "https://github.com/nodejs/node/raw/e1aa7301b4118a92a8f056d1bc02e6069886a913/test%2Fmessage%2Fv8_warning.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fv8_warning.js?ref=e1aa7301b4118a92a8f056d1bc02e6069886a913",
            "patch": "@@ -0,0 +1,19 @@\n+'use strict';\n+\n+require('../common');\n+\n+function AsmModule() {\n+  'use asm';\n+\n+  function add(a, b) {\n+    a = a | 0;\n+    b = b | 0;\n+\n+    // should be `return (a + b) | 0;`\n+    return a + b;\n+  }\n+\n+  return { add: add };\n+}\n+\n+AsmModule();"
        },
        {
            "sha": "7943d0e9d64dfe9c880a9855745c131eddfbcb4c",
            "filename": "test/message/v8_warning.out",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/e1aa7301b4118a92a8f056d1bc02e6069886a913/test%2Fmessage%2Fv8_warning.out",
            "raw_url": "https://github.com/nodejs/node/raw/e1aa7301b4118a92a8f056d1bc02e6069886a913/test%2Fmessage%2Fv8_warning.out",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fmessage%2Fv8_warning.out?ref=e1aa7301b4118a92a8f056d1bc02e6069886a913",
            "patch": "@@ -0,0 +1 @@\n+(node:*) V8: *v8_warning.js:* Invalid asm.js: Invalid return type"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 50,
        "deletions": 7
    }
}