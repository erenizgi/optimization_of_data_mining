{
    "author": "unknown",
    "message": "inspector: stop dragging platform pointer\n\nIt is now easily accessible from the Environment\n\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "8941fb71a6b82700620fb87c250f731b78cfc78c",
    "files": [
        {
            "sha": "2b03fd05b115a30c11ca8349b6bed698d9925bac",
            "filename": "src/inspector_agent.cc",
            "status": "modified",
            "additions": 9,
            "deletions": 18,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Finspector_agent.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Finspector_agent.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_agent.cc?ref=8941fb71a6b82700620fb87c250f731b78cfc78c",
            "patch": "@@ -328,8 +328,7 @@ class InspectorTimerHandle {\n \n class NodeInspectorClient : public V8InspectorClient {\n  public:\n-  NodeInspectorClient(node::Environment* env, node::NodePlatform* platform)\n-      : env_(env), platform_(platform) {\n+  explicit NodeInspectorClient(node::Environment* env) : env_(env) {\n     client_ = V8Inspector::create(env->isolate(), this);\n     // TODO(bnoordhuis) Make name configurable from src/node.cc.\n     ContextInfo info(GetHumanReadableProcessName());\n@@ -346,8 +345,9 @@ class NodeInspectorClient : public V8InspectorClient {\n       return;\n     terminated_ = false;\n     running_nested_loop_ = true;\n+    MultiIsolatePlatform* platform = env_->isolate_data()->platform();\n     while ((ignore_terminated || !terminated_) && waitForFrontendEvent()) {\n-      while (platform_->FlushForegroundTasks(env_->isolate())) {}\n+      while (platform->FlushForegroundTasks(env_->isolate())) {}\n     }\n     terminated_ = false;\n     running_nested_loop_ = false;\n@@ -514,7 +514,6 @@ class NodeInspectorClient : public V8InspectorClient {\n \n  private:\n   node::Environment* env_;\n-  node::NodePlatform* platform_;\n   bool terminated_ = false;\n   bool running_nested_loop_ = false;\n   std::unique_ptr<V8Inspector> client_;\n@@ -524,25 +523,17 @@ class NodeInspectorClient : public V8InspectorClient {\n   bool events_dispatched_ = false;\n };\n \n-Agent::Agent(Environment* env) : parent_env_(env),\n-                                 client_(nullptr),\n-                                 platform_(nullptr),\n-                                 pending_enable_async_hook_(false),\n-                                 pending_disable_async_hook_(false) {}\n+Agent::Agent(Environment* env) : parent_env_(env) {}\n \n // Destructor needs to be defined here in implementation file as the header\n // does not have full definition of some classes.\n Agent::~Agent() {\n }\n \n-bool Agent::Start(node::NodePlatform* platform, const char* path,\n-                  const DebugOptions& options) {\n+bool Agent::Start(const char* path, const DebugOptions& options) {\n   path_ = path == nullptr ? \"\" : path;\n   debug_options_ = options;\n-  client_ =\n-      std::shared_ptr<NodeInspectorClient>(\n-          new NodeInspectorClient(parent_env_, platform));\n-  platform_ = platform;\n+  client_ = std::make_shared<NodeInspectorClient>(parent_env_);\n   CHECK_EQ(0, uv_async_init(uv_default_loop(),\n                             &start_io_thread_async,\n                             StartIoThreadAsyncCallback));\n@@ -565,8 +556,7 @@ bool Agent::StartIoThread(bool wait_for_connect) {\n   CHECK_NOT_NULL(client_);\n \n   io_ = std::unique_ptr<InspectorIo>(\n-      new InspectorIo(parent_env_, platform_, path_, debug_options_,\n-                      wait_for_connect));\n+      new InspectorIo(parent_env_, path_, debug_options_, wait_for_connect));\n   if (!io_->Start()) {\n     client_.reset();\n     return false;\n@@ -716,7 +706,8 @@ void Agent::RequestIoThreadStart() {\n   // for IO events)\n   uv_async_send(&start_io_thread_async);\n   v8::Isolate* isolate = parent_env_->isolate();\n-  platform_->CallOnForegroundThread(isolate, new StartIoTask(this));\n+  v8::Platform* platform = parent_env_->isolate_data()->platform();\n+  platform->CallOnForegroundThread(isolate, new StartIoTask(this));\n   isolate->RequestInterrupt(StartIoInterrupt, this);\n   uv_async_send(&start_io_thread_async);\n }"
        },
        {
            "sha": "7295d048b64357bacb73d9b1d5f763078e667c75",
            "filename": "src/inspector_agent.h",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Finspector_agent.h",
            "raw_url": "https://github.com/nodejs/node/raw/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Finspector_agent.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_agent.h?ref=8941fb71a6b82700620fb87c250f731b78cfc78c",
            "patch": "@@ -50,8 +50,7 @@ class Agent {\n   ~Agent();\n \n   // Create client_, may create io_ if option enabled\n-  bool Start(node::NodePlatform* platform, const char* path,\n-             const DebugOptions& options);\n+  bool Start(const char* path, const DebugOptions& options);\n   // Stop and destroy io_\n   void Stop();\n \n@@ -108,12 +107,11 @@ class Agent {\n   node::Environment* parent_env_;\n   std::shared_ptr<NodeInspectorClient> client_;\n   std::unique_ptr<InspectorIo> io_;\n-  v8::Platform* platform_;\n   std::string path_;\n   DebugOptions debug_options_;\n \n-  bool pending_enable_async_hook_;\n-  bool pending_disable_async_hook_;\n+  bool pending_enable_async_hook_ = false;\n+  bool pending_disable_async_hook_ = false;\n   node::Persistent<v8::Function> enable_async_hook_function_;\n   node::Persistent<v8::Function> disable_async_hook_function_;\n };"
        },
        {
            "sha": "01d78d177de1a6037321688ae0829f3fc8e3e06f",
            "filename": "src/inspector_io.cc",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Finspector_io.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Finspector_io.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_io.cc?ref=8941fb71a6b82700620fb87c250f731b78cfc78c",
            "patch": "@@ -162,11 +162,11 @@ class DispatchMessagesTask : public v8::Task {\n   Agent* agent_;\n };\n \n-InspectorIo::InspectorIo(Environment* env, v8::Platform* platform,\n-                         const std::string& path, const DebugOptions& options,\n-                         bool wait_for_connect)\n+InspectorIo::InspectorIo(Environment* env, const std::string& path,\n+                         const DebugOptions& options, bool wait_for_connect)\n                          : options_(options), thread_(), state_(State::kNew),\n-                           parent_env_(env), thread_req_(), platform_(platform),\n+                           parent_env_(env), thread_req_(),\n+                           platform_(parent_env_->isolate_data()->platform()),\n                            dispatching_messages_(false), script_name_(path),\n                            wait_for_connect_(wait_for_connect), port_(-1),\n                            id_(GenerateID()) {"
        },
        {
            "sha": "c897a44a528ec203caac8820404bfc908b727876",
            "filename": "src/inspector_io.h",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Finspector_io.h",
            "raw_url": "https://github.com/nodejs/node/raw/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Finspector_io.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_io.h?ref=8941fb71a6b82700620fb87c250f731b78cfc78c",
            "patch": "@@ -53,9 +53,8 @@ enum class TransportAction {\n \n class InspectorIo {\n  public:\n-  InspectorIo(node::Environment* env, v8::Platform* platform,\n-              const std::string& path, const DebugOptions& options,\n-              bool wait_for_connect);\n+  InspectorIo(node::Environment* env, const std::string& path,\n+              const DebugOptions& options, bool wait_for_connect);\n \n   ~InspectorIo();\n   // Start the inspector agent thread, waiting for it to initialize,\n@@ -142,7 +141,8 @@ class InspectorIo {\n   // Note that this will live while the async is being closed - likely, past\n   // the parent object lifespan\n   std::pair<uv_async_t, Agent*>* main_thread_req_;\n-  v8::Platform* platform_;\n+  // Will be used to post tasks from another thread\n+  v8::Platform* const platform_;\n \n   // Message queues\n   ConditionVariable incoming_message_cond_;"
        },
        {
            "sha": "292307e9dae7886ac4e6d4415bf6a2f5a922ecc0",
            "filename": "src/node.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Fnode.cc",
            "raw_url": "https://github.com/nodejs/node/raw/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Fnode.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.cc?ref=8941fb71a6b82700620fb87c250f731b78cfc78c",
            "patch": "@@ -317,7 +317,7 @@ static struct {\n     // Inspector agent can't fail to start, but if it was configured to listen\n     // right away on the websocket port and fails to bind/etc, this will return\n     // false.\n-    return env->inspector_agent()->Start(platform_, script_path, options);\n+    return env->inspector_agent()->Start(script_path, options);\n   }\n \n   bool InspectorStarted(Environment* env) {"
        },
        {
            "sha": "90b2a8cbf690ce01a31a5c10f823e6198d2ad349",
            "filename": "src/node.h",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Fnode.h",
            "raw_url": "https://github.com/nodejs/node/raw/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Fnode.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode.h?ref=8941fb71a6b82700620fb87c250f731b78cfc78c",
            "patch": "@@ -225,6 +225,10 @@ class Environment;\n class MultiIsolatePlatform : public v8::Platform {\n  public:\n   virtual ~MultiIsolatePlatform() { }\n+  // Returns true if work was dispatched or executed. New tasks that are\n+  // posted during flushing of the queue are postponed until the next\n+  // flushing.\n+  virtual bool FlushForegroundTasks(v8::Isolate* isolate) = 0;\n   virtual void DrainBackgroundTasks(v8::Isolate* isolate) = 0;\n   virtual void CancelPendingDelayedTasks(v8::Isolate* isolate) = 0;\n "
        },
        {
            "sha": "77826e057771b0a8644856b8ce67e72a2ffc5ba7",
            "filename": "src/node_platform.h",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Fnode_platform.h",
            "raw_url": "https://github.com/nodejs/node/raw/8941fb71a6b82700620fb87c250f731b78cfc78c/src%2Fnode_platform.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_platform.h?ref=8941fb71a6b82700620fb87c250f731b78cfc78c",
            "patch": "@@ -133,11 +133,7 @@ class NodePlatform : public MultiIsolatePlatform {\n   double MonotonicallyIncreasingTime() override;\n   double CurrentClockTimeMillis() override;\n   v8::TracingController* GetTracingController() override;\n-\n-  // Returns true if work was dispatched or executed. New tasks that are\n-  // posted during flushing of the queue are postponed until the next\n-  // flushing.\n-  bool FlushForegroundTasks(v8::Isolate* isolate);\n+  bool FlushForegroundTasks(v8::Isolate* isolate) override;\n \n   void RegisterIsolate(IsolateData* isolate_data, uv_loop_t* loop) override;\n   void UnregisterIsolate(IsolateData* isolate_data) override;"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 26,
        "deletions": 37
    }
}