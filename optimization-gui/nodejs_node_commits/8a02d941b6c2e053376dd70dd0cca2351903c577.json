{
    "author": "mafintosh",
    "message": "zlib: do not leak on destroy\n\nPR-URL: https://github.com/nodejs/node/pull/23734\nReviewed-By: Anna Henningsen <anna@addaleax.net>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Luigi Pinca <luigipinca@gmail.com>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>",
    "sha": "8a02d941b6c2e053376dd70dd0cca2351903c577",
    "files": [
        {
            "sha": "c833afff14f4b9fff9d5e9b6d75a9abbf8b1f45a",
            "filename": "lib/zlib.js",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/8a02d941b6c2e053376dd70dd0cca2351903c577/lib%2Fzlib.js",
            "raw_url": "https://github.com/nodejs/node/raw/8a02d941b6c2e053376dd70dd0cca2351903c577/lib%2Fzlib.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Fzlib.js?ref=8a02d941b6c2e053376dd70dd0cca2351903c577",
            "patch": "@@ -430,6 +430,11 @@ Zlib.prototype.close = function close(callback) {\n   this.destroy();\n };\n \n+Zlib.prototype._destroy = function _destroy(err, callback) {\n+  _close(this);\n+  callback(err);\n+};\n+\n Zlib.prototype._transform = function _transform(chunk, encoding, cb) {\n   var flushFlag = this._defaultFlushFlag;\n   // We use a 'fake' zero-length chunk to carry information about flushes from\n@@ -592,6 +597,10 @@ function processCallback() {\n     assert(false, 'have should not go down');\n   }\n \n+  if (self.destroyed) {\n+    return;\n+  }\n+\n   // exhausted the output buffer, or used all the input create a new one.\n   if (availOutAfter === 0 || self._outOffset >= self._chunkSize) {\n     handle.availOutBefore = self._chunkSize;"
        },
        {
            "sha": "44d996311dca134d92cd7a20d9cc03423423303f",
            "filename": "test/parallel/test-zlib-close-in-ondata.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/8a02d941b6c2e053376dd70dd0cca2351903c577/test%2Fparallel%2Ftest-zlib-close-in-ondata.js",
            "raw_url": "https://github.com/nodejs/node/raw/8a02d941b6c2e053376dd70dd0cca2351903c577/test%2Fparallel%2Ftest-zlib-close-in-ondata.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-close-in-ondata.js?ref=8a02d941b6c2e053376dd70dd0cca2351903c577",
            "patch": "@@ -0,0 +1,10 @@\n+'use strict';\n+\n+const common = require('../common');\n+const zlib = require('zlib');\n+\n+const ts = zlib.createGzip();\n+const buf = Buffer.alloc(1024 * 1024 * 20);\n+\n+ts.on('data', common.mustCall(() => ts.close()));\n+ts.end(buf);"
        },
        {
            "sha": "d8eab42186a5fa61615d84e8de68a5eb22aefad1",
            "filename": "test/parallel/test-zlib-destroy.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/nodejs/node/blob/8a02d941b6c2e053376dd70dd0cca2351903c577/test%2Fparallel%2Ftest-zlib-destroy.js",
            "raw_url": "https://github.com/nodejs/node/raw/8a02d941b6c2e053376dd70dd0cca2351903c577/test%2Fparallel%2Ftest-zlib-destroy.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-zlib-destroy.js?ref=8a02d941b6c2e053376dd70dd0cca2351903c577",
            "patch": "@@ -0,0 +1,13 @@\n+'use strict';\n+\n+require('../common');\n+\n+const assert = require('assert');\n+const zlib = require('zlib');\n+\n+// verify that the zlib transform does clean up\n+// the handle when calling destroy.\n+\n+const ts = zlib.createGzip();\n+ts.destroy();\n+assert.strictEqual(ts._handle, null);"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 32,
        "deletions": 0
    }
}