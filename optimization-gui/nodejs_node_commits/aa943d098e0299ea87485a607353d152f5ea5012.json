{
    "author": "addaleax",
    "message": "http: make parser choice a runtime flag\n\nAdd a `--http-parser=llhttp` vs `--http-parser=traditional`\ncommand line switch, to make testing and comparing the new\nllhttp-based implementation easier.\n\nPR-URL: https://github.com/nodejs/node/pull/24739\nRefs: https://github.com/nodejs/node/issues/24730\nReviewed-By: Joyee Cheung <joyeec9h3@gmail.com>\nReviewed-By: Colin Ihrig <cjihrig@gmail.com>\nReviewed-By: Fedor Indutny <fedor.indutny@gmail.com>\nReviewed-By: Gus Caplan <me@gus.host>\nReviewed-By: Matheus Marchini <mat@mmarchini.me>\nReviewed-By: Matteo Collina <matteo.collina@gmail.com>\nReviewed-By: Ali Ijaz Sheikh <ofrobots@google.com>",
    "sha": "aa943d098e0299ea87485a607353d152f5ea5012",
    "files": [
        {
            "sha": "1bef01baef5fbcc9d64c47cd301b29052a070a6b",
            "filename": "configure.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/configure.py",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/configure.py",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/configure.py?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -187,7 +187,7 @@\n parser.add_option('--experimental-http-parser',\n     action='store_true',\n     dest='experimental_http_parser',\n-    help='use llhttp instead of http_parser')\n+    help='use llhttp instead of http_parser by default')\n \n shared_optgroup.add_option('--shared-http-parser',\n     action='store_true',"
        },
        {
            "sha": "aa4d28c9fe1d8ca23219c5db8b25df1791573547",
            "filename": "doc/api/cli.md",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/doc%2Fapi%2Fcli.md",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/doc%2Fapi%2Fcli.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fcli.md?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -119,6 +119,22 @@ added: v6.0.0\n Force FIPS-compliant crypto on startup. (Cannot be disabled from script code.)\n (Same requirements as `--enable-fips`.)\n \n+### `--http-parser=library`\n+<!-- YAML\n+added: REPLACEME\n+-->\n+\n+Chooses an HTTP parser library. Available values are:\n+\n+- `llhttp` for https://llhttp.org/\n+- `legacy` for https://github.com/nodejs/http-parser\n+\n+The default is `legacy`, unless otherwise specified when building Node.js.\n+\n+This flag exists to aid in experimentation with the internal implementation of\n+the Node.js http parser.\n+This flag is likely to become a no-op and removed at some point in the future.\n+\n ### `--icu-data-dir=file`\n <!-- YAML\n added: v0.11.15"
        },
        {
            "sha": "dbf1ff21e81f54d628a6b40ae3c5a3f7a4d50a4b",
            "filename": "doc/node.1",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/doc%2Fnode.1",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/doc%2Fnode.1",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fnode.1?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -97,6 +97,12 @@ Enable experimental ES module support in VM module.\n .It Fl -experimental-worker\n Enable experimental worker threads using worker_threads module.\n .\n+.It Fl -http-parser Ns = Ns Ar library\n+Chooses an HTTP parser library. Available values are\n+.Sy llhttp\n+or\n+.Sy legacy .\n+.\n .It Fl -force-fips\n Force FIPS-compliant crypto on startup\n (Cannot be disabled from script code)."
        },
        {
            "sha": "c90d9b9633e62fcdd5e1371db59825cdf9549610",
            "filename": "lib/_http_client.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/lib%2F_http_client.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/lib%2F_http_client.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_client.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -24,14 +24,14 @@\n const util = require('util');\n const net = require('net');\n const url = require('url');\n-const { HTTPParser } = internalBinding('http_parser');\n const assert = require('assert').ok;\n const {\n   _checkIsHttpToken: checkIsHttpToken,\n   debug,\n   freeParser,\n   httpSocketSetup,\n-  parsers\n+  parsers,\n+  HTTPParser,\n } = require('_http_common');\n const { OutgoingMessage } = require('_http_outgoing');\n const Agent = require('_http_agent');"
        },
        {
            "sha": "9188e9c7ca5e37057810664fc3e28d9078417a01",
            "filename": "lib/_http_common.js",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/lib%2F_http_common.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/lib%2F_http_common.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_common.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -21,7 +21,11 @@\n \n 'use strict';\n \n-const { methods, HTTPParser } = internalBinding('http_parser');\n+const { getOptionValue } = require('internal/options');\n+\n+const { methods, HTTPParser } =\n+  getOptionValue('--http-parser') === 'legacy' ?\n+    internalBinding('http_parser') : internalBinding('http_parser_llhttp');\n \n const { FreeList } = require('internal/freelist');\n const { ondrain } = require('internal/http');\n@@ -243,5 +247,6 @@ module.exports = {\n   httpSocketSetup,\n   methods,\n   parsers,\n-  kIncomingMessage\n+  kIncomingMessage,\n+  HTTPParser\n };"
        },
        {
            "sha": "22929ddc95502b86c81b08cfe5ddfc838826781d",
            "filename": "lib/_http_server.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/lib%2F_http_server.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/lib%2F_http_server.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2F_http_server.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -23,7 +23,6 @@\n \n const util = require('util');\n const net = require('net');\n-const { HTTPParser } = internalBinding('http_parser');\n const assert = require('assert').ok;\n const {\n   parsers,\n@@ -34,6 +33,7 @@ const {\n   chunkExpression,\n   httpSocketSetup,\n   kIncomingMessage,\n+  HTTPParser,\n   _checkInvalidHeaderChar: checkInvalidHeaderChar\n } = require('_http_common');\n const { OutgoingMessage } = require('_http_outgoing');"
        },
        {
            "sha": "a0f04ab34eb0b8c02a502eb3fed01acae2c2c051",
            "filename": "lib/internal/child_process.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/lib%2Finternal%2Fchild_process.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/lib%2Finternal%2Fchild_process.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fchild_process.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -127,7 +127,7 @@ const handleConversion = {\n         if (freeParser === undefined)\n           freeParser = require('_http_common').freeParser;\n         if (HTTPParser === undefined)\n-          HTTPParser = internalBinding('http_parser').HTTPParser;\n+          HTTPParser = require('_http_common').HTTPParser;\n \n         // In case of an HTTP connection socket, release the associated\n         // resources"
        },
        {
            "sha": "7e8867e971aec37b3f73a09e9dd549de2e627335",
            "filename": "node.gyp",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/node.gyp",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/node.gyp",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gyp?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -355,7 +355,8 @@\n         'src/node_encoding.cc',\n         'src/node_errors.cc',\n         'src/node_file.cc',\n-        'src/node_http_parser.cc',\n+        'src/node_http_parser_llhttp.cc',\n+        'src/node_http_parser_traditional.cc',\n         'src/node_http2.cc',\n         'src/node_i18n.cc',\n         'src/node_messaging.cc',\n@@ -426,6 +427,7 @@\n         'src/node_contextify.h',\n         'src/node_errors.h',\n         'src/node_file.h',\n+        'src/node_http_parser_impl.h',\n         'src/node_http2.h',\n         'src/node_http2_state.h',\n         'src/node_i18n.h',"
        },
        {
            "sha": "4bfaa01ff3e42251a2ccc7f9439d63bee61de7f8",
            "filename": "node.gypi",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/node.gypi",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/node.gypi",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/node.gypi?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -164,12 +164,14 @@\n     }],\n \n     [ 'node_experimental_http_parser==\"true\"', {\n-      'defines': [ 'NODE_EXPERIMENTAL_HTTP' ],\n-      'dependencies': [ 'deps/llhttp/llhttp.gyp:llhttp' ],\n-    }, {\n-      'conditions': [ [ 'node_shared_http_parser==\"false\"', {\n-        'dependencies': [ 'deps/http_parser/http_parser.gyp:http_parser' ],\n-      } ] ],\n+      'defines': [ 'NODE_EXPERIMENTAL_HTTP_DEFAULT' ],\n+    } ],\n+\n+    [ 'node_shared_http_parser==\"false\"', {\n+      'dependencies': [\n+        'deps/http_parser/http_parser.gyp:http_parser',\n+        'deps/llhttp/llhttp.gyp:llhttp'\n+      ],\n     } ],\n \n     [ 'node_shared_cares==\"false\"', {"
        },
        {
            "sha": "dcc42f25b4acb8ae4cb0237d5a33a74f82027377",
            "filename": "src/inspector_socket.cc",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/src%2Finspector_socket.cc",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/src%2Finspector_socket.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Finspector_socket.cc?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -1,6 +1,10 @@\n #include \"inspector_socket.h\"\n \n+#ifdef NODE_EXPERIMENTAL_HTTP_DEFAULT\n+#define NODE_EXPERIMENTAL_HTTP\n+#endif\n #include \"http_parser_adaptor.h\"\n+\n #include \"util-inl.h\"\n \n #define NODE_WANT_INTERNALS 1\n@@ -433,13 +437,13 @@ class HttpHandler : public ProtocolHandler {\n   explicit HttpHandler(InspectorSocket* inspector, TcpHolder::Pointer tcp)\n                        : ProtocolHandler(inspector, std::move(tcp)),\n                          parsing_value_(false) {\n-#ifdef NODE_EXPERIMENTAL_HTTP\n+#ifdef NODE_EXPERIMENTAL_HTTP_DEFAULT\n     llhttp_init(&parser_, HTTP_REQUEST, &parser_settings);\n     llhttp_settings_init(&parser_settings);\n-#else  /* !NODE_EXPERIMENTAL_HTTP */\n+#else  /* !NODE_EXPERIMENTAL_HTTP_DEFAULT */\n     http_parser_init(&parser_, HTTP_REQUEST);\n     http_parser_settings_init(&parser_settings);\n-#endif  /* NODE_EXPERIMENTAL_HTTP */\n+#endif  /* NODE_EXPERIMENTAL_HTTP_DEFAULT */\n     parser_settings.on_header_field = OnHeaderField;\n     parser_settings.on_header_value = OnHeaderValue;\n     parser_settings.on_message_complete = OnMessageComplete;\n@@ -484,17 +488,17 @@ class HttpHandler : public ProtocolHandler {\n \n   void OnData(std::vector<char>* data) override {\n     parser_errno_t err;\n-#ifdef NODE_EXPERIMENTAL_HTTP\n+#ifdef NODE_EXPERIMENTAL_HTTP_DEFAULT\n     err = llhttp_execute(&parser_, data->data(), data->size());\n \n     if (err == HPE_PAUSED_UPGRADE) {\n       err = HPE_OK;\n       llhttp_resume_after_upgrade(&parser_);\n     }\n-#else  /* !NODE_EXPERIMENTAL_HTTP */\n+#else  /* !NODE_EXPERIMENTAL_HTTP_DEFAULT */\n     http_parser_execute(&parser_, &parser_settings, data->data(), data->size());\n     err = HTTP_PARSER_ERRNO(&parser_);\n-#endif  /* NODE_EXPERIMENTAL_HTTP */\n+#endif  /* NODE_EXPERIMENTAL_HTTP_DEFAULT */\n     data->clear();\n     if (err != HPE_OK) {\n       CancelHandshake();"
        },
        {
            "sha": "6d70d0a501e335a415116357c2b154f82877bf69",
            "filename": "src/node_binding.cc",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_binding.cc",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_binding.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_binding.cc?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -36,6 +36,7 @@\n   V(heap_utils)                                                                \\\n   V(http2)                                                                     \\\n   V(http_parser)                                                               \\\n+  V(http_parser_llhttp)                                                        \\\n   V(inspector)                                                                 \\\n   V(js_stream)                                                                 \\\n   V(messaging)                                                                 \\"
        },
        {
            "sha": "4233ccbfcaae65ab5495d1619acc5f8e3b048c3d",
            "filename": "src/node_http_parser_impl.h",
            "status": "renamed",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_http_parser_impl.h",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_http_parser_impl.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser_impl.h?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -19,6 +19,12 @@\n // OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n // USE OR OTHER DEALINGS IN THE SOFTWARE.\n \n+// This file is included from 2 files, node_http_parser_traditional.cc\n+// and node_http_parser_llhttp.cc.\n+\n+#ifndef SRC_NODE_HTTP_PARSER_IMPL_H_\n+#define SRC_NODE_HTTP_PARSER_IMPL_H_\n+\n #include \"node.h\"\n #include \"node_buffer.h\"\n #include \"node_internals.h\"\n@@ -47,7 +53,7 @@\n \n \n namespace node {\n-namespace {\n+namespace {  // NOLINT(build/namespaces)\n \n using v8::Array;\n using v8::Boolean;\n@@ -910,10 +916,10 @@ const parser_settings_t Parser::settings = {\n };\n \n \n-void Initialize(Local<Object> target,\n-                Local<Value> unused,\n-                Local<Context> context,\n-                void* priv) {\n+void InitializeHttpParser(Local<Object> target,\n+                          Local<Value> unused,\n+                          Local<Context> context,\n+                          void* priv) {\n   Environment* env = Environment::GetCurrent(context);\n   Local<FunctionTemplate> t = env->NewFunctionTemplate(Parser::New);\n   t->InstanceTemplate()->SetInternalFieldCount(1);\n@@ -964,4 +970,4 @@ void Initialize(Local<Object> target,\n }  // anonymous namespace\n }  // namespace node\n \n-NODE_MODULE_CONTEXT_AWARE_INTERNAL(http_parser, node::Initialize)\n+#endif  // SRC_NODE_HTTP_PARSER_IMPL_H_",
            "previous_filename": "src/node_http_parser.cc"
        },
        {
            "sha": "7b9999d13c7cceefa6ff5b42249fbeef9a579c83",
            "filename": "src/node_http_parser_llhttp.cc",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_http_parser_llhttp.cc",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_http_parser_llhttp.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser_llhttp.cc?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -0,0 +1,17 @@\n+#define NODE_EXPERIMENTAL_HTTP 1\n+\n+#include \"node_http_parser_impl.h\"\n+\n+namespace node {\n+\n+const char* llhttp_version =\n+    NODE_STRINGIFY(LLHTTP_VERSION_MAJOR)\n+    \".\"\n+    NODE_STRINGIFY(LLHTTP_VERSION_MINOR)\n+    \".\"\n+    NODE_STRINGIFY(LLHTTP_VERSION_PATCH);\n+\n+}  // namespace node\n+\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(http_parser_llhttp,\n+                                   node::InitializeHttpParser)"
        },
        {
            "sha": "2bff20c165602018f87c7f4c494b40ac48b04e1e",
            "filename": "src/node_http_parser_traditional.cc",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_http_parser_traditional.cc",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_http_parser_traditional.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_http_parser_traditional.cc?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -0,0 +1,18 @@\n+#ifdef NODE_EXPERIMENTAL_HTTP\n+#undef NODE_EXPERIMENTAL_HTTP\n+#endif\n+\n+#include \"node_http_parser_impl.h\"\n+\n+namespace node {\n+\n+const char* http_parser_version =\n+  NODE_STRINGIFY(HTTP_PARSER_VERSION_MAJOR)\n+  \".\"\n+  NODE_STRINGIFY(HTTP_PARSER_VERSION_MINOR)\n+  \".\"\n+  NODE_STRINGIFY(HTTP_PARSER_VERSION_PATCH);\n+\n+}  // namespace node\n+\n+NODE_MODULE_CONTEXT_AWARE_INTERNAL(http_parser, node::InitializeHttpParser)"
        },
        {
            "sha": "1d43d4b1419b9c7c5763198a0209f8171c0fdb38",
            "filename": "src/node_internals.h",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_internals.h",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_internals.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_internals.h?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -697,6 +697,9 @@ static inline const char* errno_string(int errorno) {\n \n extern double prog_start_time;\n \n+extern const char* llhttp_version;\n+extern const char* http_parser_version;\n+\n void Abort(const v8::FunctionCallbackInfo<v8::Value>& args);\n void Chdir(const v8::FunctionCallbackInfo<v8::Value>& args);\n void CPUUsage(const v8::FunctionCallbackInfo<v8::Value>& args);"
        },
        {
            "sha": "fd37dbb97bf3037d61f0948d8231e69f515dbae0",
            "filename": "src/node_metadata.cc",
            "status": "modified",
            "additions": 2,
            "deletions": 14,
            "changes": 16,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_metadata.cc",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_metadata.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_metadata.cc?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -11,12 +11,6 @@\n #include \"node_crypto.h\"\n #endif\n \n-#ifdef NODE_EXPERIMENTAL_HTTP\n-#include \"llhttp.h\"\n-#else /* !NODE_EXPERIMENTAL_HTTP */\n-#include \"http_parser.h\"\n-#endif /* NODE_EXPERIMENTAL_HTTP */\n-\n namespace node {\n \n namespace per_process {\n@@ -32,14 +26,8 @@ Metadata::Versions::Versions() {\n   modules = NODE_STRINGIFY(NODE_MODULE_VERSION);\n   nghttp2 = NGHTTP2_VERSION;\n   napi = NODE_STRINGIFY(NAPI_VERSION);\n-\n-#ifdef NODE_EXPERIMENTAL_HTTP\n-  llhttp = NODE_STRINGIFY(LLHTTP_VERSION_MAJOR) \".\" NODE_STRINGIFY(\n-      LLHTTP_VERSION_MINOR) \".\" NODE_STRINGIFY(LLHTTP_VERSION_PATCH);\n-#else  /* !NODE_EXPERIMENTAL_HTTP */\n-  http_parser = NODE_STRINGIFY(HTTP_PARSER_VERSION_MAJOR) \".\" NODE_STRINGIFY(\n-      HTTP_PARSER_VERSION_MINOR) \".\" NODE_STRINGIFY(HTTP_PARSER_VERSION_PATCH);\n-#endif /* NODE_EXPERIMENTAL_HTTP */\n+  llhttp = llhttp_version;\n+  http_parser = http_parser_version;\n \n #if HAVE_OPENSSL\n   openssl = crypto::GetOpenSSLVersion();"
        },
        {
            "sha": "9f383be5f8bade223f2f15e41eeb9321e58e46e3",
            "filename": "src/node_metadata.h",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_metadata.h",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_metadata.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_metadata.h?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -15,13 +15,9 @@ namespace node {\n   V(ares)                                                                      \\\n   V(modules)                                                                   \\\n   V(nghttp2)                                                                   \\\n-  V(napi)\n-\n-#ifdef NODE_EXPERIMENTAL_HTTP\n-#define NODE_VERSIONS_KEY_HTTP(V) V(llhttp)\n-#else /* !NODE_EXPERIMENTAL_HTTP */\n-#define NODE_VERSIONS_KEY_HTTP(V) V(http_parser)\n-#endif /* NODE_EXPERIMENTAL_HTTP */\n+  V(napi)                                                                      \\\n+  V(llhttp)                                                                    \\\n+  V(http_parser)                                                               \\\n \n #if HAVE_OPENSSL\n #define NODE_VERSIONS_KEY_CRYPTO(V) V(openssl)\n@@ -31,7 +27,6 @@ namespace node {\n \n #define NODE_VERSIONS_KEYS(V)                                                  \\\n   NODE_VERSIONS_KEYS_BASE(V)                                                   \\\n-  NODE_VERSIONS_KEY_HTTP(V)                                                    \\\n   NODE_VERSIONS_KEY_CRYPTO(V)\n \n class Metadata {"
        },
        {
            "sha": "885501839c601232a7ed9a9b339dce9eff11af92",
            "filename": "src/node_options.cc",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_options.cc",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_options.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.cc?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -39,6 +39,11 @@ void EnvironmentOptions::CheckOptions(std::vector<std::string>* errors) {\n   if (syntax_check_only && has_eval_string) {\n     errors->push_back(\"either --check or --eval can be used, not both\");\n   }\n+\n+  if (http_parser != \"legacy\" && http_parser != \"llhttp\") {\n+    errors->push_back(\"invalid value for --http-parser\");\n+  }\n+\n   debug_options->CheckOptions(errors);\n }\n \n@@ -102,6 +107,15 @@ EnvironmentOptionsParser::EnvironmentOptionsParser() {\n             &EnvironmentOptions::experimental_worker,\n             kAllowedInEnvironment);\n   AddOption(\"--expose-internals\", \"\", &EnvironmentOptions::expose_internals);\n+  AddOption(\"--http-parser\",\n+            \"Select which HTTP parser to use; either 'legacy' or 'llhttp' \"\n+#ifdef NODE_EXPERIMENTAL_HTTP_DEFAULT\n+            \"(default: llhttp).\",\n+#else\n+            \"(default: legacy).\",\n+#endif\n+            &EnvironmentOptions::http_parser,\n+            kAllowedInEnvironment);\n   AddOption(\"--loader\",\n             \"(with --experimental-modules) use the specified file as a \"\n             \"custom loader\","
        },
        {
            "sha": "dfe7ff6c5e1e3c60808b1b994da9ba11e468c13d",
            "filename": "src/node_options.h",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_options.h",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/src%2Fnode_options.h",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_options.h?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -72,6 +72,12 @@ class EnvironmentOptions : public Options {\n   bool experimental_vm_modules = false;\n   bool experimental_worker = false;\n   bool expose_internals = false;\n+  std::string http_parser =\n+#ifdef NODE_EXPERIMENTAL_HTTP_DEFAULT\n+    \"llhttp\";\n+#else\n+    \"legacy\";\n+#endif\n   bool no_deprecation = false;\n   bool no_force_async_hooks_checks = false;\n   bool no_warnings = false;"
        },
        {
            "sha": "2e62e6eaa9842b4b222eb51cdaecd07d751d1f1c",
            "filename": "test/async-hooks/test-httpparser.request.js",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fasync-hooks%2Ftest-httpparser.request.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fasync-hooks%2Ftest-httpparser.request.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-httpparser.request.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -10,13 +10,7 @@ const { checkInvocations } = require('./hook-checks');\n const hooks = initHooks();\n hooks.enable();\n \n-// The hooks.enable() must come before require('internal/test/binding')\n-// because internal/test/binding schedules a process warning on nextTick.\n-// If this order is not preserved, the hooks check will fail because it\n-// will not be notified about the nextTick creation but will see the\n-// callback event.\n-const { internalBinding } = require('internal/test/binding');\n-const { HTTPParser } = internalBinding('http_parser');\n+const { HTTPParser } = require('_http_common');\n \n const REQUEST = HTTPParser.REQUEST;\n "
        },
        {
            "sha": "5933b61b79fd995d032381359eb5bb02e6cae4a9",
            "filename": "test/async-hooks/test-httpparser.response.js",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fasync-hooks%2Ftest-httpparser.response.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fasync-hooks%2Ftest-httpparser.response.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fasync-hooks%2Ftest-httpparser.response.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -11,13 +11,7 @@ const hooks = initHooks();\n \n hooks.enable();\n \n-// The hooks.enable() must come before require('internal/test/binding')\n-// because internal/test/binding schedules a process warning on nextTick.\n-// If this order is not preserved, the hooks check will fail because it\n-// will not be notified about the nextTick creation but will see the\n-// callback event.\n-const { internalBinding } = require('internal/test/binding');\n-const { HTTPParser } = internalBinding('http_parser');\n+const { HTTPParser } = require('_http_common');\n \n const RESPONSE = HTTPParser.RESPONSE;\n const kOnHeadersComplete = HTTPParser.kOnHeadersComplete | 0;"
        },
        {
            "sha": "0b132d69a2dc96cf58cced784c14c3ef5e878080",
            "filename": "test/parallel/test-http-parser-bad-ref.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fparallel%2Ftest-http-parser-bad-ref.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fparallel%2Ftest-http-parser-bad-ref.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-parser-bad-ref.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -2,12 +2,11 @@\n // Run this program with valgrind or efence with --expose_gc to expose the\n // problem.\n \n-// Flags: --expose_gc --expose-internals\n+// Flags: --expose_gc\n \n require('../common');\n const assert = require('assert');\n-const { internalBinding } = require('internal/test/binding');\n-const { HTTPParser } = internalBinding('http_parser');\n+const { HTTPParser } = require('_http_common');\n \n const kOnHeaders = HTTPParser.kOnHeaders | 0;\n const kOnHeadersComplete = HTTPParser.kOnHeadersComplete | 0;"
        },
        {
            "sha": "6d6b2ddd256bd4286eb01218d82e8e51798879ba",
            "filename": "test/parallel/test-http-parser-lazy-loaded.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fparallel%2Ftest-http-parser-lazy-loaded.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fparallel%2Ftest-http-parser-lazy-loaded.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-parser-lazy-loaded.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -3,6 +3,7 @@\n 'use strict';\n \n const { internalBinding } = require('internal/test/binding');\n+const { getOptionValue } = require('internal/options');\n \n // Monkey patch before requiring anything\n class DummyParser {\n@@ -11,7 +12,11 @@ class DummyParser {\n   }\n }\n DummyParser.REQUEST = Symbol();\n-internalBinding('http_parser').HTTPParser = DummyParser;\n+\n+const binding =\n+  getOptionValue('--http-parser') === 'legacy' ?\n+    internalBinding('http_parser') : internalBinding('http_parser_llhttp');\n+binding.HTTPParser = DummyParser;\n \n const common = require('../common');\n const assert = require('assert');"
        },
        {
            "sha": "5503b2284b85fd372b658e826e408c350b27082d",
            "filename": "test/parallel/test-http-parser.js",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fparallel%2Ftest-http-parser.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fparallel%2Ftest-http-parser.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http-parser.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -19,14 +19,11 @@\n // OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n // USE OR OTHER DEALINGS IN THE SOFTWARE.\n \n-// Flags: --expose-internals\n-\n 'use strict';\n const { mustCall, mustNotCall } = require('../common');\n const assert = require('assert');\n \n-const { internalBinding } = require('internal/test/binding');\n-const { methods, HTTPParser } = internalBinding('http_parser');\n+const { methods, HTTPParser } = require('_http_common');\n const { REQUEST, RESPONSE } = HTTPParser;\n \n const kOnHeaders = HTTPParser.kOnHeaders | 0;"
        },
        {
            "sha": "48560961f48b1a8473d1cf96a291cfe7568374fb",
            "filename": "test/parallel/test-process-versions.js",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fparallel%2Ftest-process-versions.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fparallel%2Ftest-process-versions.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-process-versions.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -3,7 +3,8 @@ const common = require('../common');\n const assert = require('assert');\n \n const expected_keys = ['ares', 'modules', 'node',\n-                       'uv', 'v8', 'zlib', 'nghttp2', 'napi'];\n+                       'uv', 'v8', 'zlib', 'nghttp2', 'napi',\n+                       'http_parser', 'llhttp'];\n \n if (common.hasCrypto) {\n   expected_keys.push('openssl');\n@@ -16,9 +17,6 @@ if (common.hasIntl) {\n   expected_keys.push('unicode');\n }\n \n-expected_keys.push(\n-  process.versions.llhttp === undefined ? 'http_parser' : 'llhttp');\n-\n expected_keys.sort();\n const actual_keys = Object.keys(process.versions).sort();\n \n@@ -27,8 +25,8 @@ assert.deepStrictEqual(actual_keys, expected_keys);\n const commonTemplate = /^\\d+\\.\\d+\\.\\d+(?:-.*)?$/;\n \n assert(commonTemplate.test(process.versions.ares));\n-assert(commonTemplate.test(process.versions.llhttp === undefined ?\n-  process.versions.http_parser : process.versions.llhttp));\n+assert(commonTemplate.test(process.versions.llhttp));\n+assert(commonTemplate.test(process.versions.http_parser));\n assert(commonTemplate.test(process.versions.node));\n assert(commonTemplate.test(process.versions.uv));\n assert(commonTemplate.test(process.versions.zlib));"
        },
        {
            "sha": "863b2175f6c8a0ac1d45616887c043c146bcd517",
            "filename": "test/parallel/test-trace-events-metadata.js",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fparallel%2Ftest-trace-events-metadata.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fparallel%2Ftest-trace-events-metadata.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-trace-events-metadata.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -36,9 +36,10 @@ proc.once('exit', common.mustCall(() => {\n \n     assert(traces.some((trace) =>\n       trace.name === 'node' &&\n-        (trace.args.process.versions.http_parser ===\n-           process.versions.http_parser ||\n-         trace.args.process.versions.llhttp === process.versions.llhttp) &&\n+        trace.args.process.versions.http_parser ===\n+          process.versions.http_parser &&\n+        trace.args.process.versions.llhttp ===\n+          process.versions.llhttp &&\n         trace.args.process.versions.node ===\n           process.versions.node &&\n         trace.args.process.versions.v8 ==="
        },
        {
            "sha": "2ad602e482df57dd3104e5a4c57d0c61d96c956a",
            "filename": "test/sequential/test-async-wrap-getasyncid.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fsequential%2Ftest-async-wrap-getasyncid.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-async-wrap-getasyncid.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -148,7 +148,7 @@ if (common.hasCrypto) { // eslint-disable-line node-core/crypto-check\n \n \n {\n-  const { HTTPParser } = internalBinding('http_parser');\n+  const { HTTPParser } = require('_http_common');\n   testInitialized(new HTTPParser(HTTPParser.REQUEST), 'HTTPParser');\n }\n "
        },
        {
            "sha": "1dece8beed2f6808f2a0c7d45ddfff9a33aea178",
            "filename": "test/sequential/test-http-max-http-headers.js",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fsequential%2Ftest-http-max-http-headers.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fsequential%2Ftest-http-max-http-headers.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http-max-http-headers.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -1,11 +1,13 @@\n+// Flags: --expose-internals\n 'use strict';\n-\n-const assert = require('assert');\n const common = require('../common');\n+const assert = require('assert');\n const http = require('http');\n const net = require('net');\n const MAX = 8 * 1024; // 8KB\n \n+const { getOptionValue } = require('internal/options');\n+\n // Verify that we cannot receive more than 8KB of headers.\n \n function once(cb) {\n@@ -27,7 +29,7 @@ function finished(client, callback) {\n function fillHeaders(headers, currentSize, valid = false) {\n   // llhttp counts actual header name/value sizes, excluding the whitespace and\n   // stripped chars.\n-  if (process.versions.hasOwnProperty('llhttp')) {\n+  if (getOptionValue('--http-parser') === 'llhttp') {\n     // OK, Content-Length, 0, X-CRASH, aaa...\n     headers += 'a'.repeat(MAX - currentSize);\n   } else {"
        },
        {
            "sha": "aa2e2bc9acb6aa9a10d7d4a6d07e80a5356ebb5e",
            "filename": "test/sequential/test-http-regr-gh-2928.js",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/nodejs/node/blob/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fsequential%2Ftest-http-regr-gh-2928.js",
            "raw_url": "https://github.com/nodejs/node/raw/aa943d098e0299ea87485a607353d152f5ea5012/test%2Fsequential%2Ftest-http-regr-gh-2928.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fsequential%2Ftest-http-regr-gh-2928.js?ref=aa943d098e0299ea87485a607353d152f5ea5012",
            "patch": "@@ -6,9 +6,8 @@\n const common = require('../common');\n const assert = require('assert');\n const httpCommon = require('_http_common');\n-const { internalBinding } = require('internal/test/binding');\n const is_reused_symbol = require('internal/freelist').symbols.is_reused_symbol;\n-const { HTTPParser } = internalBinding('http_parser');\n+const { HTTPParser } = require('_http_common');\n const net = require('net');\n \n const COUNT = httpCommon.parsers.max + 1;"
        }
    ],
    "stats": {
        "total": 242,
        "additions": 157,
        "deletions": 85
    }
}