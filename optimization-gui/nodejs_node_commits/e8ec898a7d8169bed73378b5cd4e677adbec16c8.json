{
    "author": "joyeecheung",
    "message": "fs: use SyncCall in OpenFileHandle\n\nPR-URL: https://github.com/nodejs/node/pull/18871\nRefs: https://github.com/nodejs/node/issues/18106\nReviewed-By: MichaÃ«l Zasso <targos@protonmail.com>\nReviewed-By: James M Snell <jasnell@gmail.com>\nReviewed-By: Ruben Bridgewater <ruben@bridgewater.de>",
    "sha": "e8ec898a7d8169bed73378b5cd4e677adbec16c8",
    "files": [
        {
            "sha": "5e8f9ee168b36e20abeddf6f3c25134212fdd33d",
            "filename": "src/node_file.cc",
            "status": "modified",
            "additions": 17,
            "deletions": 10,
            "changes": 27,
            "blob_url": "https://github.com/nodejs/node/blob/e8ec898a7d8169bed73378b5cd4e677adbec16c8/src%2Fnode_file.cc",
            "raw_url": "https://github.com/nodejs/node/raw/e8ec898a7d8169bed73378b5cd4e677adbec16c8/src%2Fnode_file.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_file.cc?ref=e8ec898a7d8169bed73378b5cd4e677adbec16c8",
            "patch": "@@ -1197,26 +1197,33 @@ static void Open(const FunctionCallbackInfo<Value>& args) {\n \n static void OpenFileHandle(const FunctionCallbackInfo<Value>& args) {\n   Environment* env = Environment::GetCurrent(args);\n-  Local<Context> context = env->context();\n \n-  CHECK_GE(args.Length(), 3);\n-  CHECK(args[1]->IsInt32());\n-  CHECK(args[2]->IsInt32());\n+  const int argc = args.Length();\n+  CHECK_GE(argc, 3);\n \n   BufferValue path(env->isolate(), args[0]);\n   CHECK_NE(*path, nullptr);\n \n-  int flags = args[1]->Int32Value(context).ToChecked();\n-  int mode = args[2]->Int32Value(context).ToChecked();\n+  CHECK(args[1]->IsInt32());\n+  const int flags = args[1].As<Int32>()->Value();\n+\n+  CHECK(args[2]->IsInt32());\n+  const int mode = args[2].As<Int32>()->Value();\n \n   FSReqBase* req_wrap = GetReqWrap(env, args[3]);\n-  if (req_wrap != nullptr) {\n+  if (req_wrap != nullptr) {  // openFileHandle(path, flags, mode, req)\n     AsyncCall(env, req_wrap, args, \"open\", UTF8, AfterOpenFileHandle,\n               uv_fs_open, *path, flags, mode);\n-  } else {\n-    SYNC_CALL(open, *path, *path, flags, mode)\n+  } else {  // openFileHandle(path, flags, mode, undefined, ctx)\n+    CHECK_EQ(argc, 5);\n+    fs_req_wrap req_wrap;\n+    int result = SyncCall(env, args[4], &req_wrap, \"open\",\n+                          uv_fs_open, *path, flags, mode);\n+    if (result < 0) {\n+      return;  // syscall failed, no need to continue, error info is in ctx\n+    }\n     HandleScope scope(env->isolate());\n-    FileHandle* fd = new FileHandle(env, SYNC_RESULT);\n+    FileHandle* fd = new FileHandle(env, result);\n     args.GetReturnValue().Set(fd->object());\n   }\n }"
        },
        {
            "sha": "761193b6d2993e208b4c2bc675709392c5ba82cf",
            "filename": "test/parallel/test-fs-filehandle.js",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/nodejs/node/blob/e8ec898a7d8169bed73378b5cd4e677adbec16c8/test%2Fparallel%2Ftest-fs-filehandle.js",
            "raw_url": "https://github.com/nodejs/node/raw/e8ec898a7d8169bed73378b5cd4e677adbec16c8/test%2Fparallel%2Ftest-fs-filehandle.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-fs-filehandle.js?ref=e8ec898a7d8169bed73378b5cd4e677adbec16c8",
            "patch": "@@ -2,6 +2,7 @@\n 'use strict';\n \n const common = require('../common');\n+const assert = require('assert');\n const path = require('path');\n const fs = process.binding('fs');\n const { stringToFlags } = require('internal/fs');\n@@ -11,8 +12,10 @@ const { stringToFlags } = require('internal/fs');\n \n let fdnum;\n {\n+  const ctx = {};\n   fdnum = fs.openFileHandle(path.toNamespacedPath(__filename),\n-                            stringToFlags('r'), 0o666).fd;\n+                            stringToFlags('r'), 0o666, undefined, ctx).fd;\n+  assert.strictEqual(ctx.errno, undefined);\n }\n \n common.expectWarning("
        }
    ],
    "stats": {
        "total": 32,
        "additions": 21,
        "deletions": 11
    }
}