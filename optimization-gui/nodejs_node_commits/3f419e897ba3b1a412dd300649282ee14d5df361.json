{
    "author": "sam-github",
    "message": "tls: make ossl 1.1.1 cipher list throw error\n\nMake OpenSSL 1.1.1 error during cipher list setting if it would have\nerrored with OpenSSL 1.1.0.\n\nCan be dropped after our OpenSSL fixes this upstream.\n\nSee: https://github.com/openssl/openssl/pull/7759\n\nPR-URL: https://github.com/nodejs/node/pull/25381\nReviewed-By: Daniel Bevenius <daniel.bevenius@gmail.com>\nReviewed-By: Shigeki Ohtsu <ohtsu@ohtsu.org>",
    "sha": "3f419e897ba3b1a412dd300649282ee14d5df361",
    "files": [
        {
            "sha": "01593914a1f5012c9d5d2e3367a1bbb5b5e8239e",
            "filename": "src/node_crypto.cc",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/nodejs/node/blob/3f419e897ba3b1a412dd300649282ee14d5df361/src%2Fnode_crypto.cc",
            "raw_url": "https://github.com/nodejs/node/raw/3f419e897ba3b1a412dd300649282ee14d5df361/src%2Fnode_crypto.cc",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/src%2Fnode_crypto.cc?ref=3f419e897ba3b1a412dd300649282ee14d5df361",
            "patch": "@@ -946,8 +946,26 @@ void SecureContext::SetCiphers(const FunctionCallbackInfo<Value>& args) {\n \n   THROW_AND_RETURN_IF_NOT_STRING(env, args[0], \"Ciphers\");\n \n+  // Note: set_ciphersuites() is for TLSv1.3 and was introduced in openssl\n+  // 1.1.1, set_cipher_list() is for TLSv1.2 and earlier.\n+  //\n+  // In openssl 1.1.0, set_cipher_list() would error if it resulted in no\n+  // TLSv1.2 (and earlier) cipher suites, and there is no TLSv1.3 support.\n+  //\n+  // In openssl 1.1.1, set_cipher_list() will not error if it results in no\n+  // TLSv1.2 cipher suites if there are any TLSv1.3 cipher suites, which there\n+  // are by default. There will be an error later, during the handshake, but\n+  // that results in an async error event, rather than a sync error thrown,\n+  // which is a semver-major change for the tls API.\n+  //\n+  // Since we don't currently support TLSv1.3, work around this by removing the\n+  // TLSv1.3 cipher suites, so we get backwards compatible synchronous errors.\n   const node::Utf8Value ciphers(args.GetIsolate(), args[0]);\n-  if (!SSL_CTX_set_cipher_list(sc->ctx_.get(), *ciphers)) {\n+  if (\n+#ifdef TLS1_3_VERSION\n+      !SSL_CTX_set_ciphersuites(sc->ctx_.get(), \"\") ||\n+#endif\n+      !SSL_CTX_set_cipher_list(sc->ctx_.get(), *ciphers)) {\n     unsigned long err = ERR_get_error();  // NOLINT(runtime/int)\n     if (!err) {\n       return env->ThrowError(\"Failed to set ciphers\");"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 19,
        "deletions": 1
    }
}