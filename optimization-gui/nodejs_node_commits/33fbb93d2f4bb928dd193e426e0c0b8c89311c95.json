{
    "author": "oyyd",
    "message": "http2: add Http2Stream.bufferSize\n\nThis commit adds `bufferSize` for `Http2Stream`.\n\nRefs: https://github.com/nodejs/node/issues/21631\n\nPR-URL: https://github.com/nodejs/node/pull/23711\nReviewed-By: James M Snell <jasnell@gmail.com>",
    "sha": "33fbb93d2f4bb928dd193e426e0c0b8c89311c95",
    "files": [
        {
            "sha": "2cd39437362326c5c8317234b6e92d97e45243c8",
            "filename": "doc/api/http2.md",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/nodejs/node/blob/33fbb93d2f4bb928dd193e426e0c0b8c89311c95/doc%2Fapi%2Fhttp2.md",
            "raw_url": "https://github.com/nodejs/node/raw/33fbb93d2f4bb928dd193e426e0c0b8c89311c95/doc%2Fapi%2Fhttp2.md",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/doc%2Fapi%2Fhttp2.md?ref=33fbb93d2f4bb928dd193e426e0c0b8c89311c95",
            "patch": "@@ -1012,6 +1012,15 @@ added: v8.4.0\n Set to `true` if the `Http2Stream` instance was aborted abnormally. When set,\n the `'aborted'` event will have been emitted.\n \n+#### http2stream.bufferSize\n+<!-- YAML\n+added: REPLACEME\n+-->\n+* {number}\n+\n+This property shows the number of characters currently buffered to be written.\n+See [`net.Socket.bufferSize`][] for details.\n+\n #### http2stream.close(code[, callback])\n <!-- YAML\n added: v8.4.0\n@@ -3415,6 +3424,7 @@ following additional properties:\n [`http2stream.pushStream()`]: #http2_http2stream_pushstream_headers_options_callback\n [`net.Server.close()`]: net.html#net_server_close_callback\n [`net.Socket`]: net.html#net_class_net_socket\n+[`net.Socket.bufferSize`]: net.html#net_socket_buffersize\n [`net.Socket.prototype.ref()`]: net.html#net_socket_ref\n [`net.Socket.prototype.unref()`]: net.html#net_socket_unref\n [`net.connect()`]: net.html#net_net_connect"
        },
        {
            "sha": "bb7e103f03c1280b9fe03c696f0d58021b0a08c0",
            "filename": "lib/internal/http2/core.js",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/nodejs/node/blob/33fbb93d2f4bb928dd193e426e0c0b8c89311c95/lib%2Finternal%2Fhttp2%2Fcore.js",
            "raw_url": "https://github.com/nodejs/node/raw/33fbb93d2f4bb928dd193e426e0c0b8c89311c95/lib%2Finternal%2Fhttp2%2Fcore.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/lib%2Finternal%2Fhttp2%2Fcore.js?ref=33fbb93d2f4bb928dd193e426e0c0b8c89311c95",
            "patch": "@@ -1689,6 +1689,12 @@ class Http2Stream extends Duplex {\n     return `Http2Stream ${util.format(obj)}`;\n   }\n \n+  get bufferSize() {\n+    // `bufferSize` properties of `net.Socket` are `undefined` when\n+    // their `_handle` are falsy. Here we avoid the behavior.\n+    return this[kState].writeQueueSize + this.writableLength;\n+  }\n+\n   get endAfterHeaders() {\n     return this[kState].endAfterHeaders;\n   }"
        },
        {
            "sha": "be56d8ce3d93444a5e56db546e81de09f6bc5ecc",
            "filename": "test/parallel/test-http2-buffersize.js",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/nodejs/node/blob/33fbb93d2f4bb928dd193e426e0c0b8c89311c95/test%2Fparallel%2Ftest-http2-buffersize.js",
            "raw_url": "https://github.com/nodejs/node/raw/33fbb93d2f4bb928dd193e426e0c0b8c89311c95/test%2Fparallel%2Ftest-http2-buffersize.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-http2-buffersize.js?ref=33fbb93d2f4bb928dd193e426e0c0b8c89311c95",
            "patch": "@@ -0,0 +1,51 @@\n+'use strict';\n+\n+const { mustCall, hasCrypto, skip } = require('../common');\n+if (!hasCrypto)\n+  skip('missing crypto');\n+const assert = require('assert');\n+const { createServer, connect } = require('http2');\n+const Countdown = require('../common/countdown');\n+\n+// This test ensures that `bufferSize` of Http2Session and Http2Stream work\n+// as expected.\n+{\n+  const SOCKETS = 2;\n+  const TIMES = 10;\n+  const BUFFER_SIZE = 30;\n+  const server = createServer();\n+\n+  // Other `bufferSize` tests for net module and tls module\n+  // don't assert `bufferSize` of server-side sockets.\n+  server.on('stream', mustCall((stream) => {\n+    stream.on('data', mustCall());\n+    stream.on('end', mustCall());\n+  }, SOCKETS));\n+\n+  server.listen(0, mustCall(() => {\n+    const authority = `http://localhost:${server.address().port}`;\n+    const client = connect(authority);\n+    const countdown = new Countdown(SOCKETS, () => {\n+      client.close();\n+      server.close();\n+    });\n+\n+    client.once('connect', mustCall());\n+\n+    for (let j = 0; j < SOCKETS; j += 1) {\n+      const stream = client.request({ ':method': 'POST' });\n+      stream.on('data', () => {});\n+      stream.on('close', mustCall(() => {\n+        countdown.dec();\n+      }));\n+\n+      for (let i = 0; i < TIMES; i += 1) {\n+        stream.write(Buffer.allocUnsafe(BUFFER_SIZE), mustCall());\n+        const expectedSocketBufferSize = BUFFER_SIZE * (i + 1);\n+        assert.strictEqual(stream.bufferSize, expectedSocketBufferSize);\n+      }\n+      stream.end();\n+      stream.close();\n+    }\n+  }));\n+}"
        },
        {
            "sha": "f65a3d6e76b9d80dab8d998f0697bf53d4707686",
            "filename": "test/parallel/test-tls-streamwrap-buffersize.js",
            "status": "added",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/nodejs/node/blob/33fbb93d2f4bb928dd193e426e0c0b8c89311c95/test%2Fparallel%2Ftest-tls-streamwrap-buffersize.js",
            "raw_url": "https://github.com/nodejs/node/raw/33fbb93d2f4bb928dd193e426e0c0b8c89311c95/test%2Fparallel%2Ftest-tls-streamwrap-buffersize.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Fparallel%2Ftest-tls-streamwrap-buffersize.js?ref=33fbb93d2f4bb928dd193e426e0c0b8c89311c95",
            "patch": "@@ -0,0 +1,72 @@\n+'use strict';\n+const common = require('../common');\n+if (!common.hasCrypto)\n+  common.skip('missing crypto');\n+const assert = require('assert');\n+const fixtures = require('../common/fixtures');\n+const makeDuplexPair = require('../common/duplexpair');\n+const tls = require('tls');\n+const net = require('net');\n+\n+// This test ensures that `bufferSize` also works for those tlsSockets\n+// created from `socket` of `Duplex`, with which, TLSSocket will wrap\n+// sockets in `StreamWrap`.\n+{\n+  const iter = 10;\n+\n+  function createDuplex(port) {\n+    const { clientSide, serverSide } = makeDuplexPair();\n+\n+    return new Promise((resolve, reject) => {\n+      const socket = net.connect({\n+        port,\n+      }, common.mustCall(() => {\n+        clientSide.pipe(socket);\n+        socket.pipe(clientSide);\n+        clientSide.on('close', common.mustCall(() => socket.destroy()));\n+        socket.on('close', common.mustCall(() => clientSide.destroy()));\n+\n+        resolve(serverSide);\n+      }));\n+    });\n+  }\n+\n+  const server = tls.createServer({\n+    key: fixtures.readKey('agent2-key.pem'),\n+    cert: fixtures.readKey('agent2-cert.pem')\n+  }, common.mustCall((socket) => {\n+    let str = '';\n+    socket.setEncoding('utf-8');\n+    socket.on('data', (chunk) => { str += chunk; });\n+\n+    socket.on('end', common.mustCall(() => {\n+      assert.strictEqual(str, 'a'.repeat(iter - 1));\n+      server.close();\n+    }));\n+  }));\n+\n+  server.listen(0, common.mustCall(() => {\n+    const { port } = server.address();\n+    createDuplex(port).then((socket) => {\n+      const client = tls.connect({\n+        socket,\n+        rejectUnauthorized: false,\n+      }, common.mustCall(() => {\n+        assert.strictEqual(client.bufferSize, 0);\n+\n+        for (let i = 1; i < iter; i++) {\n+          client.write('a');\n+          assert.strictEqual(client.bufferSize, i + 1);\n+        }\n+\n+        // It seems that tlsSockets created from sockets of `Duplex` emit no\n+        // \"finish\" events. We use \"end\" event instead.\n+        client.on('end', common.mustCall(() => {\n+          assert.strictEqual(client.bufferSize, undefined);\n+        }));\n+\n+        client.end();\n+      }));\n+    });\n+  }));\n+}"
        }
    ],
    "stats": {
        "total": 139,
        "additions": 139,
        "deletions": 0
    }
}