{
    "author": "gireeshpunathil",
    "message": "test: regression test for uv threadpool congestion\n\nValidate that massive dns lookups do not block filesytem I/O\n(or any fast I/O for that matter).\nPrior to https://github.com/libuv/libuv/pull/1845 few back-to-back dns\nlookup were sufficient to engage libuv threadpool workers in a blocking\nmanner, throttling other work items that need the pool. this test acts\nas a regression test for the same.\n\nStart slow and fast I/Os together, and make sure fast I/O can complete\nin at least in 1/100th of time for slow I/O.\n\nRefs: https://github.com/libuv/libuv/pull/1845\nRefs: https://github.com/nodejs/node/issues/8436\n\nPR-URL: https://github.com/nodejs/node/pull/23099\nReviewed-By: Sakthipriyan Vairamani <thechargingvolcano@gmail.com>\nReviewed-By: Anna Henningsen <anna@addaleax.net>",
    "sha": "54fa59c8bf441e4e8c187150f7ffe11680e9ccba",
    "files": [
        {
            "sha": "636364b30f892bac1caddf74ec51ddff85d86e1e",
            "filename": "test/internet/test-uv-threadpool-schedule.js",
            "status": "added",
            "additions": 65,
            "deletions": 0,
            "changes": 65,
            "blob_url": "https://github.com/nodejs/node/blob/54fa59c8bf441e4e8c187150f7ffe11680e9ccba/test%2Finternet%2Ftest-uv-threadpool-schedule.js",
            "raw_url": "https://github.com/nodejs/node/raw/54fa59c8bf441e4e8c187150f7ffe11680e9ccba/test%2Finternet%2Ftest-uv-threadpool-schedule.js",
            "contents_url": "https://api.github.com/repos/nodejs/node/contents/test%2Finternet%2Ftest-uv-threadpool-schedule.js?ref=54fa59c8bf441e4e8c187150f7ffe11680e9ccba",
            "patch": "@@ -0,0 +1,65 @@\n+'use strict';\n+\n+// Test to validate massive dns lookups do not block filesytem I/O\n+// (or any fast I/O). Prior to https://github.com/libuv/libuv/pull/1845\n+// few back-to-back dns lookups were sufficient to engage libuv\n+// threadpool workers in a blocking manner, throttling other work items\n+// that need pool resources. Start slow and fast I/Os together, make sure\n+// fast I/O can complete in at least in 1/100th of time for slow I/O.\n+// TEST TIME TO COMPLETION: ~5 seconds.\n+\n+const common = require('../common');\n+const dns = require('dns');\n+const fs = require('fs');\n+const assert = require('assert');\n+\n+const start = Date.now();\n+\n+const slowIOmax = 100;\n+let slowIOcount = 0;\n+let fastIOdone = false;\n+let slowIOend, fastIOend;\n+\n+function onResolve() {\n+  slowIOcount++;\n+  if (slowIOcount === slowIOmax) {\n+    slowIOend = Date.now();\n+\n+    // Conservative expectation: finish disc I/O\n+    // at least by when the net I/O completes.\n+    assert.ok(fastIOdone,\n+              'fast I/O was throttled due to threadpool congestion.');\n+\n+    // More realistic expectation: finish disc I/O at least within\n+    // a time duration that is 1/100th of net I/O.\n+    // Ideally the slow I/O should not affect the fast I/O as those\n+    // have two different thread-pool buckets. However, this could be\n+    // highly load / platform dependent, so don't be very greedy.\n+    const fastIOtime = fastIOend - start;\n+    const slowIOtime = slowIOend - start;\n+    const expectedMax = slowIOtime / 100;\n+    assert.ok(fastIOtime < expectedMax,\n+              'fast I/O took longer to complete, ' +\n+              `actual: ${fastIOtime}, expected: ${expectedMax}`);\n+  }\n+}\n+\n+\n+for (let i = 0; i < slowIOmax; i++) {\n+  // We need to refresh the domain string everytime,\n+  // otherwise the TCP stack that cache the previous lookup\n+  // returns result from memory, breaking all our Math.\n+  dns.lookup(`${randomDomain()}.com`, {}, common.mustCall(onResolve));\n+}\n+\n+fs.readFile(__filename, common.mustCall(() => {\n+  fastIOend = Date.now();\n+  fastIOdone = true;\n+}));\n+\n+function randomDomain() {\n+  const d = Buffer.alloc(10);\n+  for (let i = 0; i < 10; i++)\n+    d[i] = 97 + (Math.round(Math.random() * 13247)) % 26;\n+  return d.toString();\n+}"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 65,
        "deletions": 0
    }
}